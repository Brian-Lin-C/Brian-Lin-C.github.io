<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Linux 与 Shell（二）Shell 脚本编写</title>
    <url>/2026/02/24/Linux%20%E4%B8%8E%20Shell%EF%BC%88%E4%BA%8C%EF%BC%89Shell%20%E8%84%9A%E6%9C%AC%E7%BC%96%E5%86%99/</url>
    <content><![CDATA[<h1 id="Linux-与-Shell（二）Shell-脚本编写"><a href="#Linux-与-Shell（二）Shell-脚本编写" class="headerlink" title="Linux 与 Shell（二）Shell 脚本编写"></a>Linux 与 Shell（二）Shell 脚本编写</h1><p>Shell 脚本是自动化运维和批量处理的神器。本篇将介绍 Shell 脚本的基础语法、实用技巧和实战案例。</p>
<h2 id="一、Shell-脚本基础"><a href="#一、Shell-脚本基础" class="headerlink" title="一、Shell 脚本基础"></a>一、Shell 脚本基础</h2><h3 id="1-1-第一个脚本"><a href="#1-1-第一个脚本" class="headerlink" title="1.1 第一个脚本"></a>1.1 第一个脚本</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#  第一个 Shell 脚本</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Hello, World!&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;当前用户：<span class="subst">$(whoami)</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;当前目录：<span class="subst">$(pwd)</span>&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>运行脚本：</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  方式一：添加执行权限</span></span><br><span class="line"><span class="built_in">chmod</span> +x script.sh</span><br><span class="line">./script.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">#  方式二：用 bash 执行</span></span><br><span class="line">bash script.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">#  方式三：用 source 执行（在当前 shell 中）</span></span><br><span class="line"><span class="built_in">source</span> script.sh</span><br><span class="line">. script.sh</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>提醒自己</strong>：</p>
<ul>
<li><code>#!/bin/bash</code> 叫 shebang，指定解释器</li>
<li><code>#</code> 开头的行是注释</li>
<li>脚本文件通常用 <code>.sh</code> 扩展名</li>
</ul>
</blockquote>
<h3 id="1-2-变量"><a href="#1-2-变量" class="headerlink" title="1.2 变量"></a>1.2 变量</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  定义变量（等号两边不能有空格）</span></span><br><span class="line">name=<span class="string">&quot;张三&quot;</span></span><br><span class="line">age=25</span><br><span class="line"></span><br><span class="line"><span class="comment">#  使用变量</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;姓名：<span class="variable">$name</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;姓名：<span class="variable">$&#123;name&#125;</span>&quot;</span>  <span class="comment"># 推荐，更清晰</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  只读变量</span></span><br><span class="line"><span class="built_in">readonly</span> PI=3.14</span><br><span class="line"><span class="comment">#  PI=3.15  # 错误！不能修改</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  删除变量</span></span><br><span class="line">temp=<span class="string">&quot;临时变量&quot;</span></span><br><span class="line"><span class="built_in">unset</span> temp</span><br><span class="line"></span><br><span class="line"><span class="comment">#  特殊变量</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;脚本名：<span class="variable">$0</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;参数 1: <span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;参数 2: <span class="variable">$2</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;参数个数：<span class="variable">$#</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;所有参数：$*&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;所有参数：<span class="variable">$@</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;上一个命令的退出码：$?&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;当前进程 ID: $$&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  使用示例</span></span><br><span class="line"><span class="comment"># ./script.sh arg1 arg2</span></span><br></pre></td></tr></table></figure>

<h3 id="1-3-字符串"><a href="#1-3-字符串" class="headerlink" title="1.3 字符串"></a>1.3 字符串</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  单引号和双引号的区别</span></span><br><span class="line">name=<span class="string">&quot;张三&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;Hello, $name&#x27;</span>    <span class="comment"># Hello, $name（原样输出）</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Hello, <span class="variable">$name</span>&quot;</span>    <span class="comment"># Hello, 张三（变量替换）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  字符串拼接</span></span><br><span class="line">greeting=<span class="string">&quot;Hello&quot;</span></span><br><span class="line">name=<span class="string">&quot;张三&quot;</span></span><br><span class="line">message=<span class="string">&quot;<span class="variable">$&#123;greeting&#125;</span>, <span class="variable">$&#123;name&#125;</span>!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  字符串长度</span></span><br><span class="line">str=<span class="string">&quot;Hello&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;#str&#125;</span>           <span class="comment"># 5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  子字符串</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;str:1:3&#125;</span>        <span class="comment"># ell（从索引 1 开始，取 3 个字符）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  提醒自己：</span></span><br><span class="line"><span class="comment"># - 单引号内的内容原样输出</span></span><br><span class="line"><span class="comment"># - 双引号内会进行变量替换</span></span><br></pre></td></tr></table></figure>

<h3 id="1-4-数组"><a href="#1-4-数组" class="headerlink" title="1.4 数组"></a>1.4 数组</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  定义数组</span></span><br><span class="line">fruits=(<span class="string">&quot;苹果&quot;</span> <span class="string">&quot;香蕉&quot;</span> <span class="string">&quot;橙子&quot;</span>)</span><br><span class="line">colors=(red green blue)</span><br><span class="line"></span><br><span class="line"><span class="comment">#  访问元素</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;fruits[0]&#125;</span>      <span class="comment"># 苹果</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;fruits[1]&#125;</span>      <span class="comment"># 香蕉</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  访问所有元素</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;fruits[@]&#125;</span>      <span class="comment"># 苹果 香蕉 橙子</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;fruits[*]&#125;</span>      <span class="comment"># 同上</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  数组长度</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;#fruits[@]&#125;</span>     <span class="comment"># 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  修改元素</span></span><br><span class="line">fruits[0]=<span class="string">&quot;葡萄&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  添加元素</span></span><br><span class="line">fruits+=(<span class="string">&quot;西瓜&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#  删除元素</span></span><br><span class="line"><span class="built_in">unset</span> fruits[1]</span><br><span class="line"></span><br><span class="line"><span class="comment">#  遍历数组</span></span><br><span class="line"><span class="keyword">for</span> fruit <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;fruits[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$fruit</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h2 id="二、运算符"><a href="#二、运算符" class="headerlink" title="二、运算符"></a>二、运算符</h2><h3 id="2-1-算术运算符"><a href="#2-1-算术运算符" class="headerlink" title="2.1 算术运算符"></a>2.1 算术运算符</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">a=10</span><br><span class="line">b=3</span><br><span class="line"></span><br><span class="line"><span class="comment">#  方式一：$(( ))</span></span><br><span class="line"><span class="built_in">echo</span> $((a + b))    <span class="comment"># 13</span></span><br><span class="line"><span class="built_in">echo</span> $((a - b))    <span class="comment"># 7</span></span><br><span class="line"><span class="built_in">echo</span> $((a * b))    <span class="comment"># 30</span></span><br><span class="line"><span class="built_in">echo</span> $((a / b))    <span class="comment"># 3（整数除法）</span></span><br><span class="line"><span class="built_in">echo</span> $((a % b))    <span class="comment"># 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  方式二：expr</span></span><br><span class="line"><span class="built_in">echo</span> $(<span class="built_in">expr</span> <span class="variable">$a</span> + <span class="variable">$b</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#  方式三：let</span></span><br><span class="line"><span class="built_in">let</span> result=a+b</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$result</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  自增自减</span></span><br><span class="line">((a++))</span><br><span class="line">((b--))</span><br><span class="line"></span><br><span class="line"><span class="comment">#  提醒自己：</span></span><br><span class="line"><span class="comment"># - Shell 默认只支持整数运算</span></span><br><span class="line"><span class="comment"># - 浮点数需要用 bc</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-比较运算符"><a href="#2-2-比较运算符" class="headerlink" title="2.2 比较运算符"></a>2.2 比较运算符</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">a=10</span><br><span class="line">b=20</span><br><span class="line"></span><br><span class="line"><span class="comment">#  数值比较</span></span><br><span class="line">[ <span class="variable">$a</span> -eq <span class="variable">$b</span> ]     <span class="comment"># 等于 (equal)</span></span><br><span class="line">[ <span class="variable">$a</span> -ne <span class="variable">$b</span> ]     <span class="comment"># 不等于 (not equal)</span></span><br><span class="line">[ <span class="variable">$a</span> -gt <span class="variable">$b</span> ]     <span class="comment"># 大于 (greater than)</span></span><br><span class="line">[ <span class="variable">$a</span> -ge <span class="variable">$b</span> ]     <span class="comment"># 大于等于</span></span><br><span class="line">[ <span class="variable">$a</span> -lt <span class="variable">$b</span> ]     <span class="comment"># 小于 (less than)</span></span><br><span class="line">[ <span class="variable">$a</span> -le <span class="variable">$b</span> ]     <span class="comment"># 小于等于</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  字符串比较</span></span><br><span class="line">[ <span class="string">&quot;<span class="variable">$a</span>&quot;</span> = <span class="string">&quot;<span class="variable">$b</span>&quot;</span> ]   <span class="comment"># 等于</span></span><br><span class="line">[ <span class="string">&quot;<span class="variable">$a</span>&quot;</span> != <span class="string">&quot;<span class="variable">$b</span>&quot;</span> ]  <span class="comment"># 不等于</span></span><br><span class="line">[ -z <span class="string">&quot;<span class="variable">$a</span>&quot;</span> ]       <span class="comment"># 字符串为空</span></span><br><span class="line">[ -n <span class="string">&quot;<span class="variable">$a</span>&quot;</span> ]       <span class="comment"># 字符串不为空</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  文件测试</span></span><br><span class="line">[ -e file.txt ]   <span class="comment"># 文件存在</span></span><br><span class="line">[ -f file.txt ]   <span class="comment"># 是普通文件</span></span><br><span class="line">[ -d <span class="built_in">dir</span> ]        <span class="comment"># 是目录</span></span><br><span class="line">[ -x file.sh ]    <span class="comment"># 可执行</span></span><br><span class="line">[ -r file.txt ]   <span class="comment"># 可读</span></span><br><span class="line">[ -w file.txt ]   <span class="comment"># 可写</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  提醒自己：</span></span><br><span class="line"><span class="comment"># - [ ] 是 test 命令的简写</span></span><br><span class="line"><span class="comment"># - 比较运算符两边要有空格</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-逻辑运算符"><a href="#2-3-逻辑运算符" class="headerlink" title="2.3 逻辑运算符"></a>2.3 逻辑运算符</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">a=10</span><br><span class="line">b=20</span><br><span class="line"></span><br><span class="line"><span class="comment">#  逻辑与、或、非</span></span><br><span class="line">[ <span class="variable">$a</span> -gt 5 ] &amp;&amp; [ <span class="variable">$b</span> -gt 5 ]    <span class="comment"># and</span></span><br><span class="line">[ <span class="variable">$a</span> -gt 5 ] || [ <span class="variable">$b</span> -gt 5 ]    <span class="comment"># or</span></span><br><span class="line">! [ <span class="variable">$a</span> -gt <span class="variable">$b</span> ]                 <span class="comment"># not</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  简化写法</span></span><br><span class="line">[ <span class="variable">$a</span> -gt 5 ] &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;a 大于 5&quot;</span></span><br><span class="line">[ <span class="variable">$a</span> -gt 5 ] || <span class="built_in">echo</span> <span class="string">&quot;a 不大于 5&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  复合条件</span></span><br><span class="line">[[ <span class="variable">$a</span> -gt 5 &amp;&amp; <span class="variable">$b</span> -gt 5 ]]</span><br><span class="line">[[ <span class="variable">$a</span> -gt 5 || <span class="variable">$b</span> -gt 5 ]]</span><br></pre></td></tr></table></figure>

<h2 id="三、流程控制"><a href="#三、流程控制" class="headerlink" title="三、流程控制"></a>三、流程控制</h2><h3 id="3-1-if-条件语句"><a href="#3-1-if-条件语句" class="headerlink" title="3.1 if 条件语句"></a>3.1 if 条件语句</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  基本 if</span></span><br><span class="line">age=20</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$age</span> -ge 18 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;成年&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  if-else</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$age</span> -ge 18 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;成年&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;未成年&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  if-elif-else</span></span><br><span class="line">score=85</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$score</span> -ge 90 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;优秀&quot;</span></span><br><span class="line"><span class="keyword">elif</span> [ <span class="variable">$score</span> -ge 80 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;良好&quot;</span></span><br><span class="line"><span class="keyword">elif</span> [ <span class="variable">$score</span> -ge 60 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;及格&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;不及格&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  单行写法</span></span><br><span class="line">[ <span class="variable">$age</span> -ge 18 ] &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;成年&quot;</span> || <span class="built_in">echo</span> <span class="string">&quot;未成年&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-case-语句"><a href="#3-2-case-语句" class="headerlink" title="3.2 case 语句"></a>3.2 case 语句</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  基本 case</span></span><br><span class="line">os=<span class="string">&quot;linux&quot;</span></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$os</span> <span class="keyword">in</span></span><br><span class="line">    <span class="string">&quot;linux&quot;</span>)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Linux 系统&quot;</span></span><br><span class="line">        ;;</span><br><span class="line">    <span class="string">&quot;windows&quot;</span>)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Windows 系统&quot;</span></span><br><span class="line">        ;;</span><br><span class="line">    <span class="string">&quot;macos&quot;</span>)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;macOS 系统&quot;</span></span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;未知系统&quot;</span></span><br><span class="line">        ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  模式匹配</span></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">    start|begin)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;启动服务&quot;</span></span><br><span class="line">        ;;</span><br><span class="line">    stop|end)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;停止服务&quot;</span></span><br><span class="line">        ;;</span><br><span class="line">    restart)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;重启服务&quot;</span></span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;用法：<span class="variable">$0</span> &#123;start|stop|restart&#125;&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">        ;;</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure>

<h3 id="3-3-for-循环"><a href="#3-3-for-循环" class="headerlink" title="3.3 for 循环"></a>3.3 for 循环</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  遍历列表</span></span><br><span class="line"><span class="keyword">for</span> fruit <span class="keyword">in</span> 苹果 香蕉 橙子; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;水果：<span class="variable">$fruit</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  遍历数组</span></span><br><span class="line">fruits=(<span class="string">&quot;苹果&quot;</span> <span class="string">&quot;香蕉&quot;</span> <span class="string">&quot;橙子&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> fruit <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;fruits[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;水果：<span class="variable">$fruit</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  范围循环</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..5&#125;; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;数字：<span class="variable">$i</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  C 风格 for</span></span><br><span class="line"><span class="keyword">for</span> ((i=<span class="number">0</span>; i&lt;<span class="number">5</span>; i++)); <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;数字：<span class="variable">$i</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  遍历文件</span></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> *.txt; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;文件：<span class="variable">$file</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  遍历命令行参数</span></span><br><span class="line"><span class="keyword">for</span> arg <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;参数：<span class="variable">$arg</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="3-4-while-循环"><a href="#3-4-while-循环" class="headerlink" title="3.4 while 循环"></a>3.4 while 循环</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  基本 while</span></span><br><span class="line">count=1</span><br><span class="line"><span class="keyword">while</span> [ <span class="variable">$count</span> -le 5 ]; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;计数：<span class="variable">$count</span>&quot;</span></span><br><span class="line">    ((count++))</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  无限循环</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;持续运行...&quot;</span></span><br><span class="line">    <span class="built_in">sleep</span> 1</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  读取文件</span></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> -r line; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;行：<span class="variable">$line</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span> &lt; file.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#  带条件的 while</span></span><br><span class="line"><span class="keyword">while</span> [ -f /var/run/app.pid ]; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;应用正在运行&quot;</span></span><br><span class="line">    <span class="built_in">sleep</span> 5</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="3-5-循环控制"><a href="#3-5-循环控制" class="headerlink" title="3.5 循环控制"></a>3.5 循环控制</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  break - 跳出循环</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..10&#125;; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$i</span> -eq 5 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">break</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$i</span>  <span class="comment"># 1 2 3 4</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  continue - 跳过本次</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..10&#125;; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> [ $((i % <span class="number">2</span>)) -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">continue</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$i</span>  <span class="comment"># 1 3 5 7 9</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  select - 创建菜单</span></span><br><span class="line">PS3=<span class="string">&quot;请选择一个水果：&quot;</span></span><br><span class="line">fruits=(<span class="string">&quot;苹果&quot;</span> <span class="string">&quot;香蕉&quot;</span> <span class="string">&quot;橙子&quot;</span> <span class="string">&quot;退出&quot;</span>)</span><br><span class="line"><span class="keyword">select</span> fruit <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;fruits[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable">$fruit</span> <span class="keyword">in</span></span><br><span class="line">        <span class="string">&quot;退出&quot;</span>)</span><br><span class="line">            <span class="built_in">break</span></span><br><span class="line">            ;;</span><br><span class="line">        *)</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;你选择了：<span class="variable">$fruit</span>&quot;</span></span><br><span class="line">            ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h2 id="四、函数"><a href="#四、函数" class="headerlink" title="四、函数"></a>四、函数</h2><h3 id="4-1-函数定义"><a href="#4-1-函数定义" class="headerlink" title="4.1 函数定义"></a>4.1 函数定义</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  定义函数</span></span><br><span class="line"><span class="function"><span class="title">greet</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Hello, <span class="variable">$1</span>!&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#  调用函数</span></span><br><span class="line">greet <span class="string">&quot;张三&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  带返回值</span></span><br><span class="line"><span class="function"><span class="title">add</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> a=<span class="variable">$1</span></span><br><span class="line">    <span class="built_in">local</span> b=<span class="variable">$2</span></span><br><span class="line">    <span class="built_in">local</span> <span class="built_in">sum</span>=$((a + b))</span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$sum</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">result=$(add 3 5)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;结果：<span class="variable">$result</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  使用 return（返回状态码，0-255）</span></span><br><span class="line"><span class="function"><span class="title">check_age</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> age=<span class="variable">$1</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$age</span> -ge 18 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">return</span> 0  <span class="comment"># 成功</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">return</span> 1  <span class="comment"># 失败</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check_age 20</span><br><span class="line"><span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;成年&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  提醒自己：</span></span><br><span class="line"><span class="comment"># - local 定义局部变量</span></span><br><span class="line"><span class="comment"># - return 只能返回 0-255 的状态码</span></span><br><span class="line"><span class="comment"># - 返回值用 echo，调用时用$()捕获</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-函数库"><a href="#4-2-函数库" class="headerlink" title="4.2 函数库"></a>4.2 函数库</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#  utils.sh - 函数库</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">log_info</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;[INFO] <span class="subst">$(date &#x27;+%Y-%m-%d %H:%M:%S&#x27;)</span> - <span class="variable">$1</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">log_error</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;[ERROR] <span class="subst">$(date &#x27;+%Y-%m-%d %H:%M:%S&#x27;)</span> - <span class="variable">$1</span>&quot;</span> &gt;&amp;2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">check_root</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> [ $(<span class="built_in">id</span> -u) -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">        log_error <span class="string">&quot;需要 root 权限&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#  main.sh - 主脚本</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> utils.sh</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">. utils.sh</span><br><span class="line"></span><br><span class="line">log_info <span class="string">&quot;程序启动&quot;</span></span><br><span class="line">check_root</span><br></pre></td></tr></table></figure>

<h2 id="五、输入输出"><a href="#五、输入输出" class="headerlink" title="五、输入输出"></a>五、输入输出</h2><h3 id="5-1-读取输入"><a href="#5-1-读取输入" class="headerlink" title="5.1 读取输入"></a>5.1 读取输入</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  读取一行</span></span><br><span class="line"><span class="built_in">echo</span> -n <span class="string">&quot;请输入姓名：&quot;</span></span><br><span class="line"><span class="built_in">read</span> name</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;你好，<span class="variable">$name</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  读取多个值</span></span><br><span class="line"><span class="built_in">echo</span> -n <span class="string">&quot;请输入姓名和年龄：&quot;</span></span><br><span class="line"><span class="built_in">read</span> name age</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$name</span>, <span class="variable">$age</span> 岁&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  带提示</span></span><br><span class="line"><span class="built_in">read</span> -p <span class="string">&quot;请输入密码：&quot;</span> password</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;密码已输入&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  隐藏输入</span></span><br><span class="line"><span class="built_in">read</span> -s -p <span class="string">&quot;请输入密码：&quot;</span> password</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span>  <span class="comment"># 换行</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  限时读取</span></span><br><span class="line"><span class="built_in">read</span> -t 5 -p <span class="string">&quot;请在 5 秒内输入：&quot;</span> input</span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$input</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;超时&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  读取文件</span></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> -r line; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;行：<span class="variable">$line</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span> &lt; file.txt</span><br></pre></td></tr></table></figure>

<h3 id="5-2-重定向"><a href="#5-2-重定向" class="headerlink" title="5.2 重定向"></a>5.2 重定向</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  标准输出重定向</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;hello&quot;</span> &gt; output.txt      <span class="comment"># 覆盖</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;hello&quot;</span> &gt;&gt; output.txt     <span class="comment"># 追加</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  标准错误重定向</span></span><br><span class="line"><span class="built_in">command</span> 2&gt; error.log</span><br><span class="line"><span class="built_in">command</span> &gt; output.log 2&gt;&amp;1      <span class="comment"># 标准输出和错误都重定向</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  输入重定向</span></span><br><span class="line"><span class="built_in">wc</span> -l &lt; file.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#  Here 文档</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; file.txt</span></span><br><span class="line"><span class="string">这是第一行</span></span><br><span class="line"><span class="string">这是第二行</span></span><br><span class="line"><span class="string">变量：$name</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  Here 字符串</span></span><br><span class="line">grep <span class="string">&quot;pattern&quot;</span> &lt;&lt;&lt; <span class="string">&quot;search in this string&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="六、实战案例"><a href="#六、实战案例" class="headerlink" title="六、实战案例"></a>六、实战案例</h2><h3 id="6-1-系统信息收集脚本"><a href="#6-1-系统信息收集脚本" class="headerlink" title="6.1 系统信息收集脚本"></a>6.1 系统信息收集脚本</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#  system_info.sh - 收集系统信息</span></span><br><span class="line"></span><br><span class="line">OUTPUT_FILE=<span class="string">&quot;system_info_<span class="subst">$(date +%Y%m%d_%H%M%S)</span>.txt&quot;</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;========== 系统信息 ==========&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;时间：<span class="subst">$(date)</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;主机名：<span class="subst">$(hostname)</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;========== CPU 信息 ==========&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;核心数：<span class="subst">$(nproc)</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;========== 内存信息 ==========&quot;</span></span><br><span class="line">    free -h</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;========== 磁盘信息 ==========&quot;</span></span><br><span class="line">    <span class="built_in">df</span> -h</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;========== 网络信息 ==========&quot;</span></span><br><span class="line">    ip addr show</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;========== 监听端口 ==========&quot;</span></span><br><span class="line">    ss -tulpn</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;========== 最近登录 ==========&quot;</span></span><br><span class="line">    last -n 5</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">&#125; &gt; <span class="string">&quot;<span class="variable">$OUTPUT_FILE</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;系统信息已保存到：<span class="variable">$OUTPUT_FILE</span>&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-批量备份脚本"><a href="#6-2-批量备份脚本" class="headerlink" title="6.2 批量备份脚本"></a>6.2 批量备份脚本</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#  backup.sh - 批量备份脚本</span></span><br><span class="line"></span><br><span class="line">SOURCE_DIR=<span class="string">&quot;/data&quot;</span></span><br><span class="line">BACKUP_DIR=<span class="string">&quot;/backup&quot;</span></span><br><span class="line">DATE=$(<span class="built_in">date</span> +%Y%m%d_%H%M%S)</span><br><span class="line">KEEP_DAYS=7</span><br><span class="line"></span><br><span class="line"><span class="comment">#  创建备份目录</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$BACKUP_DIR</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  备份函数</span></span><br><span class="line"><span class="function"><span class="title">backup_dir</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> src=<span class="variable">$1</span></span><br><span class="line">    <span class="built_in">local</span> name=$(<span class="built_in">basename</span> <span class="string">&quot;<span class="variable">$src</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">local</span> tar_file=<span class="string">&quot;<span class="variable">$&#123;BACKUP_DIR&#125;</span>/<span class="variable">$&#123;name&#125;</span>_<span class="variable">$&#123;DATE&#125;</span>.tar.gz&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;正在备份：<span class="variable">$src</span>&quot;</span></span><br><span class="line">    tar -czf <span class="string">&quot;<span class="variable">$tar_file</span>&quot;</span> <span class="string">&quot;<span class="variable">$src</span>&quot;</span> 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;备份成功：<span class="variable">$tar_file</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;备份失败：<span class="variable">$src</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#  备份多个目录</span></span><br><span class="line">backup_dir <span class="string">&quot;/data/www&quot;</span></span><br><span class="line">backup_dir <span class="string">&quot;/data/database&quot;</span></span><br><span class="line">backup_dir <span class="string">&quot;/data/config&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  清理旧备份</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;清理 <span class="variable">$&#123;KEEP_DAYS&#125;</span> 天前的备份...&quot;</span></span><br><span class="line">find <span class="string">&quot;<span class="variable">$BACKUP_DIR</span>&quot;</span> -name <span class="string">&quot;*.tar.gz&quot;</span> -mtime +<span class="variable">$&#123;KEEP_DAYS&#125;</span> -delete</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;备份完成&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="6-3-日志分析脚本"><a href="#6-3-日志分析脚本" class="headerlink" title="6.3 日志分析脚本"></a>6.3 日志分析脚本</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#  log_analyzer.sh - 日志分析脚本</span></span><br><span class="line"></span><br><span class="line">LOG_FILE=<span class="string">&quot;<span class="variable">$&#123;1:-/var/log/nginx/access.log&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;错误：日志文件不存在：<span class="variable">$LOG_FILE</span>&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;========== 日志分析：<span class="variable">$LOG_FILE</span> ==========&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  PV（访问量）</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;总访问量 (PV):&quot;</span></span><br><span class="line"><span class="built_in">wc</span> -l &lt; <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  UV（独立访客）</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;独立访客 (UV):&quot;</span></span><br><span class="line">awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | <span class="built_in">sort</span> -u | <span class="built_in">wc</span> -l</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  Top 10 IP</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Top 10 IP:&quot;</span></span><br><span class="line">awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -rn | <span class="built_in">head</span> -10</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  状态码统计</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;状态码统计:&quot;</span></span><br><span class="line">awk <span class="string">&#x27;&#123;print $9&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -rn</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  错误请求（4xx, 5xx）</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;错误请求:&quot;</span></span><br><span class="line">grep -E <span class="string">&#x27;&quot; [45][0-9]&#123;2&#125; &#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | <span class="built_in">wc</span> -l</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  最近错误</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;最近 10 个错误请求:&quot;</span></span><br><span class="line">grep -E <span class="string">&#x27;&quot; [45][0-9]&#123;2&#125; &#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span> | <span class="built_in">tail</span> -10</span><br></pre></td></tr></table></figure>

<h3 id="6-4-服务监控脚本"><a href="#6-4-服务监控脚本" class="headerlink" title="6.4 服务监控脚本"></a>6.4 服务监控脚本</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#  monitor.sh - 服务监控脚本</span></span><br><span class="line"></span><br><span class="line">SERVICES=(<span class="string">&quot;nginx&quot;</span> <span class="string">&quot;mysql&quot;</span> <span class="string">&quot;redis&quot;</span>)</span><br><span class="line">LOG_FILE=<span class="string">&quot;/var/log/service_monitor.log&quot;</span></span><br><span class="line">ALERT_EMAIL=<span class="string">&quot;admin@example.com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">log</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;[<span class="subst">$(date &#x27;+%Y-%m-%d %H:%M:%S&#x27;)</span>] <span class="variable">$1</span>&quot;</span> | <span class="built_in">tee</span> -a <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">check_service</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> service=<span class="variable">$1</span></span><br><span class="line">    <span class="keyword">if</span> ! pgrep -x <span class="string">&quot;<span class="variable">$service</span>&quot;</span> &gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;警告：<span class="variable">$service</span> 服务未运行！&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#  尝试重启</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;尝试重启 <span class="variable">$service</span>...&quot;</span></span><br><span class="line">        systemctl restart <span class="string">&quot;<span class="variable">$service</span>&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">log</span> <span class="string">&quot;<span class="variable">$service</span> 服务已重启&quot;</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">log</span> <span class="string">&quot;错误：<span class="variable">$service</span> 服务重启失败！&quot;</span></span><br><span class="line">            <span class="comment">#  发送邮件告警（需要配置邮件）</span></span><br><span class="line">            <span class="comment"># echo &quot;$service 服务重启失败&quot; | mail -s &quot;服务告警&quot; &quot;$ALERT_EMAIL&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;<span class="variable">$service</span> 服务运行正常&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#  主循环</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">for</span> service <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;SERVICES[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">        check_service <span class="string">&quot;<span class="variable">$service</span>&quot;</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;---&quot;</span></span><br><span class="line">    <span class="built_in">sleep</span> 60  <span class="comment"># 每分钟检查一次</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="6-5-自动化部署脚本"><a href="#6-5-自动化部署脚本" class="headerlink" title="6.5 自动化部署脚本"></a>6.5 自动化部署脚本</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#  deploy.sh - 自动化部署脚本</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e  <span class="comment"># 遇到错误立即退出</span></span><br><span class="line"></span><br><span class="line">APP_NAME=<span class="string">&quot;myapp&quot;</span></span><br><span class="line">APP_DIR=<span class="string">&quot;/opt/<span class="variable">$APP_NAME</span>&quot;</span></span><br><span class="line">BACKUP_DIR=<span class="string">&quot;/backup/<span class="variable">$APP_NAME</span>&quot;</span></span><br><span class="line">GIT_REPO=<span class="string">&quot;git@github.com:user/myapp.git&quot;</span></span><br><span class="line">BRANCH=<span class="string">&quot;main&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">log</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;[<span class="subst">$(date &#x27;+%Y-%m-%d %H:%M:%S&#x27;)</span>] <span class="variable">$1</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;========== 开始部署 <span class="variable">$APP_NAME</span> ==========&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  1. 备份当前版本</span></span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;备份当前版本...&quot;</span></span><br><span class="line"><span class="keyword">if</span> [ -d <span class="string">&quot;<span class="variable">$APP_DIR</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$BACKUP_DIR</span>&quot;</span></span><br><span class="line">    tar -czf <span class="string">&quot;<span class="variable">$&#123;BACKUP_DIR&#125;</span>/backup_<span class="subst">$(date +%Y%m%d_%H%M%S)</span>.tar.gz&quot;</span> <span class="string">&quot;<span class="variable">$APP_DIR</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  2. 拉取最新代码</span></span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;拉取最新代码...&quot;</span></span><br><span class="line"><span class="keyword">if</span> [ -d <span class="string">&quot;<span class="variable">$APP_DIR</span>/.git&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$APP_DIR</span>&quot;</span></span><br><span class="line">    git pull origin <span class="string">&quot;<span class="variable">$BRANCH</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    git <span class="built_in">clone</span> -b <span class="string">&quot;<span class="variable">$BRANCH</span>&quot;</span> <span class="string">&quot;<span class="variable">$GIT_REPO</span>&quot;</span> <span class="string">&quot;<span class="variable">$APP_DIR</span>&quot;</span></span><br><span class="line">    <span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$APP_DIR</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  3. 安装依赖</span></span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;安装依赖...&quot;</span></span><br><span class="line">pip install -r requirements.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#  4. 构建（如果需要）</span></span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;构建项目...&quot;</span></span><br><span class="line"><span class="comment"># npm run build</span></span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line"><span class="comment"># go build</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  5. 数据库迁移（如果需要）</span></span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;数据库迁移...&quot;</span></span><br><span class="line"><span class="comment"># python manage.py migrate</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  6. 重启服务</span></span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;重启服务...&quot;</span></span><br><span class="line">systemctl restart <span class="string">&quot;<span class="variable">$APP_NAME</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  7. 检查服务状态</span></span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;检查服务状态...&quot;</span></span><br><span class="line"><span class="built_in">sleep</span> 2</span><br><span class="line"><span class="keyword">if</span> systemctl is-active --quiet <span class="string">&quot;<span class="variable">$APP_NAME</span>&quot;</span>; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">log</span> <span class="string">&quot;部署成功！&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">log</span> <span class="string">&quot;错误：服务启动失败！&quot;</span></span><br><span class="line">    <span class="built_in">log</span> <span class="string">&quot;回滚到之前的版本...&quot;</span></span><br><span class="line">    <span class="comment"># 回滚逻辑</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;========== 部署完成 ==========&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="七、调试技巧"><a href="#七、调试技巧" class="headerlink" title="七、调试技巧"></a>七、调试技巧</h2><h3 id="7-1-调试选项"><a href="#7-1-调试选项" class="headerlink" title="7.1 调试选项"></a>7.1 调试选项</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  -x：打印执行的命令</span></span><br><span class="line">bash -x script.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">#  -v：打印读取的行</span></span><br><span class="line">bash -v script.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">#  -n：检查语法（不执行）</span></span><br><span class="line">bash -n script.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">#  脚本内启用调试</span></span><br><span class="line"><span class="built_in">set</span> -x      <span class="comment"># 开启调试</span></span><br><span class="line"><span class="comment">#  代码...</span></span><br><span class="line"><span class="built_in">set</span> +x      <span class="comment"># 关闭调试</span></span><br></pre></td></tr></table></figure>

<h3 id="7-2-错误处理"><a href="#7-2-错误处理" class="headerlink" title="7.2 错误处理"></a>7.2 错误处理</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  set -e：遇到错误立即退出</span></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="comment">#  set -u：使用未定义变量时报错</span></span><br><span class="line"><span class="built_in">set</span> -u</span><br><span class="line"></span><br><span class="line"><span class="comment">#  set -o pipefail：管道中任何命令失败都返回失败</span></span><br><span class="line"><span class="built_in">set</span> -o pipefail</span><br><span class="line"></span><br><span class="line"><span class="comment">#  组合使用（推荐）</span></span><br><span class="line"><span class="built_in">set</span> -euo pipefail</span><br><span class="line"></span><br><span class="line"><span class="comment">#  trap：捕获信号</span></span><br><span class="line"><span class="built_in">trap</span> <span class="string">&#x27;echo &quot;错误：脚本在第 $LINENO 行失败&quot;&#x27;</span> ERR</span><br><span class="line"></span><br><span class="line"><span class="comment">#  清理函数</span></span><br><span class="line"><span class="function"><span class="title">cleanup</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;清理临时文件...&quot;</span></span><br><span class="line">    <span class="built_in">rm</span> -rf /tmp/myapp_*</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">trap</span> cleanup EXIT</span><br></pre></td></tr></table></figure>

<h2 id="八、最佳实践"><a href="#八、最佳实践" class="headerlink" title="八、最佳实践"></a>八、最佳实践</h2><blockquote>
<p><strong>提醒自己</strong>：</p>
<ol>
<li><strong>脚本开头加 shebang</strong>：<code>#!/bin/bash</code></li>
<li><strong>使用 set -euo pipefail</strong>：增强错误处理</li>
<li><strong>变量用双引号包裹</strong>：避免空格和通配符问题</li>
<li><strong>函数用 local 声明局部变量</strong>：避免污染全局作用域</li>
<li><strong>有意义的变量名</strong>：使用大写表示常量</li>
<li><strong>添加注释和文档</strong>：说明用途、参数、返回值</li>
<li><strong>日志输出加时间戳</strong>：便于追踪</li>
<li><strong>敏感信息用环境变量</strong>：不要硬编码密码</li>
</ol>
</blockquote>
<h2 id="九、练习"><a href="#九、练习" class="headerlink" title="九、练习"></a>九、练习</h2><ol>
<li>编写一个脚本，检查磁盘使用率，超过 80% 时告警</li>
<li>编写一个脚本，批量创建用户并设置密码</li>
<li>编写一个脚本，分析 Apache&#x2F;Nginx 日志，统计访问量和错误率</li>
<li>编写一个脚本，监控系统负载，超过阈值时发送邮件告警</li>
<li>编写一个自动化部署脚本，支持回滚功能</li>
</ol>
<hr>
<p><strong>上一篇</strong>：<a href="/2026/02/24/Linux-%E4%B8%8E-Shell%EF%BC%88%E4%B8%80%EF%BC%89Linux-%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/">Linux 与 Shell（一）：Linux 基础与常用命令</a></p>
<p><strong>下一篇</strong>：<a href="/2026/02/24/Git-%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6%E4%B8%8E%E5%9B%A2%E9%98%9F%E5%8D%8F%E4%BD%9C/">Git 版本控制与团队协作</a></p>
<p><strong>参考资源</strong>：</p>
<ul>
<li><a href="https://www.shellscript.sh/">Shell 脚本教程</a></li>
<li><a href="https://github.com/learnbyexample/cmdline_text_processing">Bash 指南</a></li>
<li><a href="https://www.gnu.org/software/bash/manual/">GNU Bash 手册</a></li>
</ul>
]]></content>
      <categories>
        <category>系统与工具</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Shell</tag>
        <tag>脚本编程</tag>
        <tag>自动化</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux 与 Shell（一）Linux 基础与常用命令</title>
    <url>/2026/02/24/Linux%20%E4%B8%8E%20Shell%EF%BC%88%E4%B8%80%EF%BC%89Linux%20%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
    <content><![CDATA[<h1 id="Linux-与-Shell（一）Linux-基础与常用命令"><a href="#Linux-与-Shell（一）Linux-基础与常用命令" class="headerlink" title="Linux 与 Shell（一）Linux 基础与常用命令"></a>Linux 与 Shell（一）Linux 基础与常用命令</h1><p>Linux 是服务器端最主流的操作系统。本篇将介绍 Linux 基础、常用命令、文件权限和进程管理，帮助你快速上手 Linux 系统操作。</p>
<h2 id="一、Linux-基础"><a href="#一、Linux-基础" class="headerlink" title="一、Linux 基础"></a>一、Linux 基础</h2><h3 id="1-1-Linux-简介"><a href="#1-1-Linux-简介" class="headerlink" title="1.1 Linux 简介"></a>1.1 Linux 简介</h3><p><strong>Linux</strong> 是一个开源、免费的操作系统内核，具有以下特点：</p>
<ul>
<li><strong>开源免费</strong>：源代码开放，可自由使用和修改</li>
<li><strong>多用户多任务</strong>：支持多个用户同时执行多个任务</li>
<li><strong>稳定可靠</strong>：服务器首选操作系统</li>
<li><strong>强大的命令行</strong>：Shell 提供强大的文本操作能力</li>
</ul>
<h3 id="1-2-常见-Linux-发行版"><a href="#1-2-常见-Linux-发行版" class="headerlink" title="1.2 常见 Linux 发行版"></a>1.2 常见 Linux 发行版</h3><table>
<thead>
<tr>
<th>发行版</th>
<th>特点</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td>Ubuntu</td>
<td>易用、社区活跃</td>
<td>桌面、服务器</td>
</tr>
<tr>
<td>CentOS&#x2F;RHEL</td>
<td>稳定、企业支持</td>
<td>企业服务器</td>
</tr>
<tr>
<td>Debian</td>
<td>稳定、软件丰富</td>
<td>服务器</td>
</tr>
<tr>
<td>Fedora</td>
<td>新技术先行</td>
<td>开发测试</td>
</tr>
<tr>
<td>Alpine</td>
<td>轻量、安全</td>
<td>容器、嵌入式</td>
</tr>
</tbody></table>
<h3 id="1-3-目录结构"><a href="#1-3-目录结构" class="headerlink" title="1.3 目录结构"></a>1.3 目录结构</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/</span><br><span class="line">├── bin/          # 常用命令</span><br><span class="line">├── boot/         # 启动文件</span><br><span class="line">├── dev/          # 设备文件</span><br><span class="line">├── etc/          # 配置文件</span><br><span class="line">├── home/         # 用户主目录</span><br><span class="line">├── lib/          # 库文件</span><br><span class="line">├── media/        # 可移动媒体</span><br><span class="line">├── mnt/          # 挂载点</span><br><span class="line">├── opt/          # 可选软件包</span><br><span class="line">├── proc/         # 进程信息（虚拟文件系统）</span><br><span class="line">├── root/         # root 用户主目录</span><br><span class="line">├── run/          # 运行时数据</span><br><span class="line">├── sbin/         # 系统管理命令</span><br><span class="line">├── srv/          # 服务数据</span><br><span class="line">├── sys/          # 系统信息</span><br><span class="line">├── tmp/          # 临时文件</span><br><span class="line">├── usr/          # 用户程序</span><br><span class="line">├── var/          # 可变数据（日志、邮件等）</span><br><span class="line">└── var/log/      # 日志文件</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>提醒自己</strong>：</p>
<ul>
<li><code>/etc</code> 存放配置文件</li>
<li><code>/var/log</code> 存放日志文件</li>
<li><code>/home</code> 是普通用户的主目录</li>
<li><code>/root</code> 是 root 用户的主目录</li>
</ul>
</blockquote>
<h2 id="二、常用命令"><a href="#二、常用命令" class="headerlink" title="二、常用命令"></a>二、常用命令</h2><h3 id="2-1-文件与目录操作"><a href="#2-1-文件与目录操作" class="headerlink" title="2.1 文件与目录操作"></a>2.1 文件与目录操作</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  pwd - 显示当前目录</span></span><br><span class="line"><span class="built_in">pwd</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  ls - 列出目录内容</span></span><br><span class="line"><span class="built_in">ls</span>                  <span class="comment"># 列出文件</span></span><br><span class="line"><span class="built_in">ls</span> -l               <span class="comment"># 详细信息</span></span><br><span class="line"><span class="built_in">ls</span> -la              <span class="comment"># 包括隐藏文件</span></span><br><span class="line"><span class="built_in">ls</span> -lh              <span class="comment"># 人类可读的文件大小</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  cd - 切换目录</span></span><br><span class="line"><span class="built_in">cd</span> /home            <span class="comment"># 切换到 /home</span></span><br><span class="line"><span class="built_in">cd</span> ..               <span class="comment"># 返回上级目录</span></span><br><span class="line"><span class="built_in">cd</span> ~                <span class="comment"># 回到主目录</span></span><br><span class="line"><span class="built_in">cd</span> -                <span class="comment"># 回到上一个目录</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  mkdir - 创建目录</span></span><br><span class="line"><span class="built_in">mkdir</span> mydir                     <span class="comment"># 创建单个目录</span></span><br><span class="line"><span class="built_in">mkdir</span> -p a/b/c                  <span class="comment"># 递归创建目录</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  touch - 创建空文件或更新时间戳</span></span><br><span class="line"><span class="built_in">touch</span> file.txt                  <span class="comment"># 创建空文件</span></span><br><span class="line"><span class="built_in">touch</span> file1 file2 file3         <span class="comment"># 创建多个文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  cp - 复制</span></span><br><span class="line"><span class="built_in">cp</span> source.txt dest.txt          <span class="comment"># 复制文件</span></span><br><span class="line"><span class="built_in">cp</span> -r dir1 dir2                 <span class="comment"># 递归复制目录</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  mv - 移动或重命名</span></span><br><span class="line"><span class="built_in">mv</span> old.txt new.txt              <span class="comment"># 重命名</span></span><br><span class="line"><span class="built_in">mv</span> file.txt /path/to/dir/       <span class="comment"># 移动文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  rm - 删除</span></span><br><span class="line"><span class="built_in">rm</span> file.txt                     <span class="comment"># 删除文件</span></span><br><span class="line"><span class="built_in">rm</span> -r <span class="built_in">dir</span>/                      <span class="comment"># 删除目录</span></span><br><span class="line"><span class="built_in">rm</span> -rf <span class="built_in">dir</span>/                     <span class="comment"># 强制删除（危险！）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  ln - 创建链接</span></span><br><span class="line"><span class="built_in">ln</span> -s /path/to/target <span class="built_in">link</span>      <span class="comment"># 创建软链接</span></span><br><span class="line"><span class="built_in">ln</span> target <span class="built_in">link</span>                  <span class="comment"># 创建硬链接</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  提醒自己：</span></span><br><span class="line"><span class="comment">#  - rm -rf 非常危险，使用前务必确认路径</span></span><br><span class="line"><span class="comment">#  - 软链接类似 Windows 快捷方式</span></span><br><span class="line"><span class="comment">#  - 硬链接是同一个 inode 的不同名字</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-文件查看"><a href="#2-2-文件查看" class="headerlink" title="2.2 文件查看"></a>2.2 文件查看</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  cat - 查看文件内容</span></span><br><span class="line"><span class="built_in">cat</span> file.txt                    <span class="comment"># 显示全部内容</span></span><br><span class="line"><span class="built_in">cat</span> -n file.txt                 <span class="comment"># 显示行号</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  less/more - 分页查看</span></span><br><span class="line">less large_file.log             <span class="comment"># 分页查看（可上下滚动）</span></span><br><span class="line"><span class="comment">#  操作：空格下翻，b 上翻，q 退出，/搜索</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  head/tail - 查看首尾</span></span><br><span class="line"><span class="built_in">head</span> file.txt                   <span class="comment"># 前 10 行</span></span><br><span class="line"><span class="built_in">head</span> -n 20 file.txt             <span class="comment"># 前 20 行</span></span><br><span class="line"><span class="built_in">tail</span> file.txt                   <span class="comment"># 后 10 行</span></span><br><span class="line"><span class="built_in">tail</span> -f file.log                <span class="comment"># 实时追踪日志（常用！）</span></span><br><span class="line"><span class="built_in">tail</span> -n 50 -f file.log          <span class="comment"># 追踪后 50 行</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  wc - 统计</span></span><br><span class="line"><span class="built_in">wc</span> file.txt                     <span class="comment"># 行数、单词数、字节数</span></span><br><span class="line"><span class="built_in">wc</span> -l file.txt                  <span class="comment"># 只统计行数</span></span><br><span class="line"><span class="built_in">wc</span> -w file.txt                  <span class="comment"># 只统计单词数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  提醒自己：</span></span><br><span class="line"><span class="comment">#  - tail -f 是查看日志的神器</span></span><br><span class="line"><span class="comment">#  - 大文件不要用 cat，用 less</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-查找与搜索"><a href="#2-3-查找与搜索" class="headerlink" title="2.3 查找与搜索"></a>2.3 查找与搜索</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  find - 查找文件</span></span><br><span class="line">find / -name <span class="string">&quot;filename&quot;</span>         <span class="comment"># 按名称查找</span></span><br><span class="line">find /home -name <span class="string">&quot;*.txt&quot;</span>        <span class="comment"># 按扩展名查找</span></span><br><span class="line">find . -<span class="built_in">type</span> f                  <span class="comment"># 查找所有文件</span></span><br><span class="line">find . -<span class="built_in">type</span> d                  <span class="comment"># 查找所有目录</span></span><br><span class="line">find . -size +100M              <span class="comment"># 大于 100M 的文件</span></span><br><span class="line">find . -mtime -7                <span class="comment"># 7 天内修改的文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  locate - 快速查找（使用数据库）</span></span><br><span class="line">locate filename                 <span class="comment"># 快速查找文件</span></span><br><span class="line">updatedb                        <span class="comment"># 更新数据库</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  grep - 文本搜索</span></span><br><span class="line">grep <span class="string">&quot;error&quot;</span> file.log           <span class="comment"># 搜索包含 error 的行</span></span><br><span class="line">grep -i <span class="string">&quot;error&quot;</span> file.log        <span class="comment"># 忽略大小写</span></span><br><span class="line">grep -r <span class="string">&quot;error&quot;</span> ./logs/         <span class="comment"># 递归搜索</span></span><br><span class="line">grep -n <span class="string">&quot;error&quot;</span> file.log        <span class="comment"># 显示行号</span></span><br><span class="line">grep -v <span class="string">&quot;info&quot;</span> file.log         <span class="comment"># 反向选择（不包含）</span></span><br><span class="line">grep -E <span class="string">&quot;err1|err2&quot;</span> file.log    <span class="comment"># 正则表达式</span></span><br><span class="line">grep -C 3 <span class="string">&quot;error&quot;</span> file.log      <span class="comment"># 显示匹配行及前后 3 行</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  提醒自己：</span></span><br><span class="line"><span class="comment">#  - find 实时搜索，locate 从数据库搜索（更快）</span></span><br><span class="line"><span class="comment">#  - grep 是日志分析的核心工具</span></span><br><span class="line"><span class="comment">#  - grep -C 可以查看上下文</span></span><br></pre></td></tr></table></figure>

<h3 id="2-4-压缩与解压"><a href="#2-4-压缩与解压" class="headerlink" title="2.4 压缩与解压"></a>2.4 压缩与解压</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  tar - 打包/解包</span></span><br><span class="line">tar -cvf archive.tar file1 file2    <span class="comment"># 打包</span></span><br><span class="line">tar -xvf archive.tar                <span class="comment"># 解包</span></span><br><span class="line">tar -tzf archive.tar.gz             <span class="comment"># 查看内容</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  gzip - 压缩</span></span><br><span class="line">gzip file.txt                       <span class="comment"># 压缩成 file.txt.gz</span></span><br><span class="line">gunzip file.txt.gz                  <span class="comment"># 解压</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  组合使用（常见格式）</span></span><br><span class="line">tar -czvf archive.tar.gz <span class="built_in">dir</span>/       <span class="comment"># 打包并用 gzip 压缩</span></span><br><span class="line">tar -xzvf archive.tar.gz            <span class="comment"># 解压 gzip 压缩包</span></span><br><span class="line">tar -cjvf archive.tar.bz2 <span class="built_in">dir</span>/      <span class="comment"># 打包并用 bzip2 压缩</span></span><br><span class="line">tar -xjvf archive.tar.bz2           <span class="comment"># 解压 bzip2 压缩包</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  zip/unzip</span></span><br><span class="line">zip -r archive.zip <span class="built_in">dir</span>/             <span class="comment"># 压缩</span></span><br><span class="line">unzip archive.zip                   <span class="comment"># 解压</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  提醒自己：</span></span><br><span class="line"><span class="comment">#  - .tar 只是打包，没有压缩</span></span><br><span class="line"><span class="comment">#  - .tar.gz 或.tgz是最常见的格式</span></span><br><span class="line"><span class="comment">#  - -c 创建，-x 解压，-z gzip，-j bzip2，-v 详细，-f 文件</span></span><br></pre></td></tr></table></figure>

<h3 id="2-5-系统信息"><a href="#2-5-系统信息" class="headerlink" title="2.5 系统信息"></a>2.5 系统信息</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  系统信息</span></span><br><span class="line"><span class="built_in">uname</span> -a                    <span class="comment"># 内核信息</span></span><br><span class="line">hostname                    <span class="comment"># 主机名</span></span><br><span class="line"><span class="built_in">uptime</span>                      <span class="comment"># 运行时间</span></span><br><span class="line"><span class="built_in">date</span>                        <span class="comment"># 当前时间</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  硬件信息</span></span><br><span class="line">free -h                     <span class="comment"># 内存使用</span></span><br><span class="line"><span class="built_in">df</span> -h                       <span class="comment"># 磁盘使用</span></span><br><span class="line"><span class="built_in">du</span> -sh */                   <span class="comment"># 目录大小</span></span><br><span class="line">top                         <span class="comment"># 实时进程</span></span><br><span class="line">htop                        <span class="comment"># 增强的 top（需安装）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  CPU 信息</span></span><br><span class="line"><span class="built_in">cat</span> /proc/cpuinfo           <span class="comment"># CPU 详情</span></span><br><span class="line"><span class="built_in">nproc</span>                       <span class="comment"># CPU 核心数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  提醒自己：</span></span><br><span class="line"><span class="comment">#  - free -h 查看内存最直观</span></span><br><span class="line"><span class="comment">#  - df -h 查看磁盘空间</span></span><br><span class="line"><span class="comment">#  - du -sh * 查看各目录占用</span></span><br></pre></td></tr></table></figure>

<h2 id="三、文件权限"><a href="#三、文件权限" class="headerlink" title="三、文件权限"></a>三、文件权限</h2><h3 id="3-1-权限基础"><a href="#3-1-权限基础" class="headerlink" title="3.1 权限基础"></a>3.1 权限基础</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  查看权限</span></span><br><span class="line"><span class="built_in">ls</span> -l file.txt</span><br><span class="line"><span class="comment">#  输出：-rwxr-xr-- 1 user group 1234 Jan 1 12:00 file.txt</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  权限解析：</span></span><br><span class="line"><span class="comment">#  -：文件类型（-文件，d 目录，l 链接）</span></span><br><span class="line"><span class="comment">#  rwx：所有者权限</span></span><br><span class="line"><span class="comment">#  r-x：组权限</span></span><br><span class="line"><span class="comment">#  r--：其他人权限</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  权限数值：</span></span><br><span class="line"><span class="comment">#  r = 4, w = 2, x = 1, - = 0</span></span><br><span class="line"><span class="comment">#  rwx = 7, r-x = 5, r-- = 4, --- = 0</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-修改权限"><a href="#3-2-修改权限" class="headerlink" title="3.2 修改权限"></a>3.2 修改权限</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  chmod - 修改权限</span></span><br><span class="line"><span class="built_in">chmod</span> 755 file.sh               <span class="comment"># rwxr-xr-x</span></span><br><span class="line"><span class="built_in">chmod</span> 644 file.txt              <span class="comment"># rw-r--r--</span></span><br><span class="line"><span class="built_in">chmod</span> +x script.sh              <span class="comment"># 添加执行权限</span></span><br><span class="line"><span class="built_in">chmod</span> -w file.txt               <span class="comment"># 移除写权限</span></span><br><span class="line"><span class="built_in">chmod</span> u+x,g+w,o-r file.txt      <span class="comment"># 分别设置</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  chown - 修改所有者</span></span><br><span class="line"><span class="built_in">chown</span> user file.txt             <span class="comment"># 修改所有者</span></span><br><span class="line"><span class="built_in">chown</span> user:group file.txt       <span class="comment"># 同时修改所有者和组</span></span><br><span class="line"><span class="built_in">chown</span> -R user:group <span class="built_in">dir</span>/        <span class="comment"># 递归修改</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  chgrp - 修改组</span></span><br><span class="line"><span class="built_in">chgrp</span> group file.txt            <span class="comment"># 修改所属组</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  提醒自己：</span></span><br><span class="line"><span class="comment">#  - 脚本文件通常需要 +x 执行权限</span></span><br><span class="line"><span class="comment">#  - 配置文件通常是 644</span></span><br><span class="line"><span class="comment">#  - 目录需要 x 权限才能进入</span></span><br></pre></td></tr></table></figure>

<h3 id="3-3-特殊权限"><a href="#3-3-特殊权限" class="headerlink" title="3.3 特殊权限"></a>3.3 特殊权限</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  SUID - 执行时以所有者身份运行</span></span><br><span class="line"><span class="built_in">chmod</span> u+s /usr/bin/passwd</span><br><span class="line"><span class="comment">#  显示为：-rwsr-xr-x</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  SGID - 目录中创建的文件继承组</span></span><br><span class="line"><span class="built_in">chmod</span> g+s /shared/dir</span><br><span class="line"></span><br><span class="line"><span class="comment">#  Sticky Bit - 目录中只有所有者能删除自己的文件</span></span><br><span class="line"><span class="built_in">chmod</span> +t /tmp</span><br><span class="line"><span class="comment">#  显示为：drwxrwxrwt</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  提醒自己：</span></span><br><span class="line"><span class="comment">#  - SUID 有安全风险，谨慎使用</span></span><br><span class="line"><span class="comment">#  - /tmp 目录必须有 Sticky Bit</span></span><br></pre></td></tr></table></figure>

<h2 id="四、进程管理"><a href="#四、进程管理" class="headerlink" title="四、进程管理"></a>四、进程管理</h2><h3 id="4-1-查看进程"><a href="#4-1-查看进程" class="headerlink" title="4.1 查看进程"></a>4.1 查看进程</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  ps - 进程快照</span></span><br><span class="line">ps aux                          <span class="comment"># 所有进程</span></span><br><span class="line">ps -ef | grep python            <span class="comment"># 查找 Python 进程</span></span><br><span class="line">ps aux --<span class="built_in">sort</span>=-%mem | <span class="built_in">head</span>      <span class="comment"># 内存占用前 10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  top/htop - 实时进程</span></span><br><span class="line">top                             <span class="comment"># 实时查看</span></span><br><span class="line">htop                            <span class="comment"># 更友好的界面</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  pgrep - 按名称查找进程</span></span><br><span class="line">pgrep nginx                     <span class="comment"># 查找 nginx 进程</span></span><br><span class="line">pgrep -l python                 <span class="comment"># 显示进程名</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  提醒自己：</span></span><br><span class="line"><span class="comment">#  - ps aux 第一行是标题行</span></span><br><span class="line"><span class="comment">#  - %CPU 和 %MEM 是重要指标</span></span><br><span class="line"><span class="comment">#  - PID 是进程 ID</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-控制进程"><a href="#4-2-控制进程" class="headerlink" title="4.2 控制进程"></a>4.2 控制进程</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  kill - 终止进程</span></span><br><span class="line"><span class="built_in">kill</span> 1234                       <span class="comment"># 发送 TERM 信号</span></span><br><span class="line"><span class="built_in">kill</span> -9 1234                    <span class="comment"># 强制终止（SIGKILL）</span></span><br><span class="line"><span class="built_in">kill</span> -15 1234                   <span class="comment"># 优雅终止（默认）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  killall - 按名称终止</span></span><br><span class="line">killall nginx                   <span class="comment"># 终止所有 nginx 进程</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  pkill - 按模式终止</span></span><br><span class="line">pkill -f <span class="string">&quot;python app.py&quot;</span>        <span class="comment"># 终止匹配的命令</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  提醒自己：</span></span><br><span class="line"><span class="comment">#  - 先用 kill -15，不行再用 kill -9</span></span><br><span class="line"><span class="comment">#  - kill -9 可能留下残留资源</span></span><br></pre></td></tr></table></figure>

<h3 id="4-3-后台运行"><a href="#4-3-后台运行" class="headerlink" title="4.3 后台运行"></a>4.3 后台运行</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  &amp; - 后台运行</span></span><br><span class="line"><span class="built_in">sleep</span> 100 &amp;                     <span class="comment"># 后台运行</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  jobs - 查看后台任务</span></span><br><span class="line"><span class="built_in">jobs</span></span><br><span class="line"><span class="built_in">jobs</span> -l                         <span class="comment"># 显示 PID</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  fg/bg - 切换前台/后台</span></span><br><span class="line"><span class="built_in">fg</span>                              <span class="comment"># 切换到前台</span></span><br><span class="line"><span class="built_in">fg</span> %1                           <span class="comment"># 切换到任务 1</span></span><br><span class="line">Ctrl+Z                          <span class="comment"># 挂起当前任务</span></span><br><span class="line"><span class="built_in">bg</span>                              <span class="comment"># 将挂起的任务放到后台</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  nohup - 不挂断运行</span></span><br><span class="line"><span class="built_in">nohup</span> python app.py &amp;           <span class="comment"># 退出终端后继续运行</span></span><br><span class="line"><span class="built_in">nohup</span> python app.py &gt; log.txt 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">#  提醒自己：</span></span><br><span class="line"><span class="comment">#  - 后台任务在终端关闭后会终止</span></span><br><span class="line"><span class="comment">#  - 长期运行的程序用 nohup 或 screen/tmux</span></span><br></pre></td></tr></table></figure>

<h3 id="4-4-计划任务"><a href="#4-4-计划任务" class="headerlink" title="4.4 计划任务"></a>4.4 计划任务</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  crontab - 定时任务</span></span><br><span class="line">crontab -e                      <span class="comment"># 编辑定时任务</span></span><br><span class="line">crontab -l                      <span class="comment"># 查看定时任务</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  格式：分 时 日 月 周 命令</span></span><br><span class="line"><span class="comment">#  * * * * * command</span></span><br><span class="line"><span class="comment">#  │ │ │ │ │</span></span><br><span class="line"><span class="comment">#  │ │ │ │ └─ 星期 (0-7, 0 和 7 都是周日)</span></span><br><span class="line"><span class="comment">#  │ │ │ └─── 月份 (1-12)</span></span><br><span class="line"><span class="comment">#  │ │ └───── 日期 (1-31)</span></span><br><span class="line"><span class="comment">#  │ └─────── 小时 (0-23)</span></span><br><span class="line"><span class="comment">#  └───────── 分钟 (0-59)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  示例：</span></span><br><span class="line">* * * * * /path/to/every_minute.sh      <span class="comment"># 每分钟</span></span><br><span class="line">0 * * * * /path/to/every_hour.sh        <span class="comment"># 每小时</span></span><br><span class="line">0 0 * * * /path/to/every_day.sh         <span class="comment"># 每天零点</span></span><br><span class="line">0 0 * * 0 /path/to/every_week.sh        <span class="comment"># 每周日</span></span><br><span class="line">0 0 1 * * /path/to/every_month.sh       <span class="comment"># 每月 1 号</span></span><br><span class="line">*/5 * * * * /path/to/every_5min.sh      <span class="comment"># 每 5 分钟</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  systemctl - 系统服务</span></span><br><span class="line">systemctl status nginx                  <span class="comment"># 查看状态</span></span><br><span class="line">systemctl start nginx                   <span class="comment"># 启动</span></span><br><span class="line">systemctl stop nginx                    <span class="comment"># 停止</span></span><br><span class="line">systemctl restart nginx                 <span class="comment"># 重启</span></span><br><span class="line">systemctl <span class="built_in">enable</span> nginx                  <span class="comment"># 开机自启</span></span><br><span class="line">systemctl <span class="built_in">disable</span> nginx                 <span class="comment"># 禁用开机自启</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  提醒自己：</span></span><br><span class="line"><span class="comment">#  - crontab 编辑后自动生效</span></span><br><span class="line"><span class="comment">#  - 系统服务用 systemctl 管理</span></span><br></pre></td></tr></table></figure>

<h2 id="五、用户与组管理"><a href="#五、用户与组管理" class="headerlink" title="五、用户与组管理"></a>五、用户与组管理</h2><h3 id="5-1-用户管理"><a href="#5-1-用户管理" class="headerlink" title="5.1 用户管理"></a>5.1 用户管理</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  添加用户</span></span><br><span class="line">useradd username                    <span class="comment"># 创建用户</span></span><br><span class="line">useradd -m username                 <span class="comment"># 创建并创建主目录</span></span><br><span class="line">passwd username                     <span class="comment"># 设置密码</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  修改用户</span></span><br><span class="line">usermod -aG groupname username      <span class="comment"># 添加到组</span></span><br><span class="line">usermod -s /bin/bash username       <span class="comment"># 修改 shell</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  删除用户</span></span><br><span class="line">userdel username                    <span class="comment"># 删除用户</span></span><br><span class="line">userdel -r username                 <span class="comment"># 删除用户和主目录</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  查看用户</span></span><br><span class="line"><span class="built_in">id</span> username                         <span class="comment"># 用户信息</span></span><br><span class="line"><span class="built_in">who</span>                                 <span class="comment"># 登录用户</span></span><br><span class="line">w                                   <span class="comment"># 登录用户及活动</span></span><br><span class="line">last                                <span class="comment"># 登录历史</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  提醒自己：</span></span><br><span class="line"><span class="comment">#  - usermod -aG 的-a很重要，否则用户会离开其他组</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-切换用户"><a href="#5-2-切换用户" class="headerlink" title="5.2 切换用户"></a>5.2 切换用户</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  su - 切换用户</span></span><br><span class="line">su - username                       <span class="comment"># 切换为用户（带环境）</span></span><br><span class="line">su username                         <span class="comment"># 切换用户（不带环境）</span></span><br><span class="line">su -                                <span class="comment"># 切换到 root</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  sudo - 以其他用户执行命令</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">command</span>                        <span class="comment"># 以 root 身份执行</span></span><br><span class="line"><span class="built_in">sudo</span> -u username <span class="built_in">command</span>            <span class="comment"># 以指定用户执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  配置 sudo 权限</span></span><br><span class="line">visudo                              <span class="comment"># 编辑 sudoers 文件</span></span><br><span class="line"><span class="comment">#  添加：username ALL=(ALL:ALL) ALL</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  提醒自己：</span></span><br><span class="line"><span class="comment">#  - su - 会加载目标用户的环境</span></span><br><span class="line"><span class="comment">#  - sudo 需要用户在 sudoers 中</span></span><br></pre></td></tr></table></figure>

<h2 id="六、网络命令"><a href="#六、网络命令" class="headerlink" title="六、网络命令"></a>六、网络命令</h2><h3 id="6-1-网络配置"><a href="#6-1-网络配置" class="headerlink" title="6.1 网络配置"></a>6.1 网络配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  IP 地址</span></span><br><span class="line">ip addr show                        <span class="comment"># 显示 IP 地址</span></span><br><span class="line">ifconfig                            <span class="comment"># 旧命令（可能需安装）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  路由</span></span><br><span class="line">ip route show                       <span class="comment"># 显示路由表</span></span><br><span class="line">route -n                            <span class="comment"># 旧命令</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  DNS</span></span><br><span class="line"><span class="built_in">cat</span> /etc/resolv.conf                <span class="comment"># 查看 DNS 配置</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  端口</span></span><br><span class="line">netstat -tulpn                      <span class="comment"># 监听端口</span></span><br><span class="line">ss -tulpn                           <span class="comment"># 新版替代命令</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  提醒自己：</span></span><br><span class="line"><span class="comment">#  - ss 比 netstat 更快</span></span><br><span class="line"><span class="comment">#  - -tulpn 显示 TCP/UDP 监听端口及进程</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-网络诊断"><a href="#6-2-网络诊断" class="headerlink" title="6.2 网络诊断"></a>6.2 网络诊断</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  ping - 测试连通性</span></span><br><span class="line">ping google.com                     <span class="comment"># 持续 ping</span></span><br><span class="line">ping -c 4 google.com                <span class="comment"># ping 4 次</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  traceroute - 路由追踪</span></span><br><span class="line">traceroute google.com               <span class="comment"># Linux</span></span><br><span class="line">tracert google.com                  <span class="comment"># Windows</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  curl - HTTP 请求</span></span><br><span class="line">curl http://example.com             <span class="comment"># 获取页面</span></span><br><span class="line">curl -I http://example.com          <span class="comment"># 只获取响应头</span></span><br><span class="line">curl -o file.zip URL                <span class="comment"># 下载文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  wget - 下载工具</span></span><br><span class="line">wget http://example.com/file.zip    <span class="comment"># 下载</span></span><br><span class="line">wget -c file.zip                    <span class="comment"># 断点续传</span></span><br><span class="line">wget -r URL                         <span class="comment"># 递归下载</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  提醒自己：</span></span><br><span class="line"><span class="comment">#  - curl 更适合 API 测试</span></span><br><span class="line"><span class="comment">#  - wget 更适合下载大文件</span></span><br></pre></td></tr></table></figure>

<h2 id="七、实践建议"><a href="#七、实践建议" class="headerlink" title="七、实践建议"></a>七、实践建议</h2><blockquote>
<p><strong>提醒自己</strong>：</p>
<ol>
<li><strong>熟练使用 grep 和 find</strong>：这是最常用的命令</li>
<li><strong>学会查看日志</strong>：<code>/var/log/</code> 下有很多重要日志</li>
<li><strong>谨慎使用 rm -rf</strong>：删除前再三确认</li>
<li><strong>使用 Tab 补全</strong>：提高效率，减少拼写错误</li>
<li><strong>学会用 help 和 man</strong>：<code>command --help</code> 或<code>man command</code></li>
<li><strong>使用别名</strong>：在 <code>~/.bashrc</code> 中添加常用命令别名</li>
</ol>
</blockquote>
<h3 id="常用别名示例"><a href="#常用别名示例" class="headerlink" title="常用别名示例"></a>常用别名示例</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  ~/.bashrc 或~/.bash_profile</span></span><br><span class="line"><span class="built_in">alias</span> ll=<span class="string">&#x27;ls -la&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> gs=<span class="string">&#x27;git status&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> gp=<span class="string">&#x27;git push&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> ..=<span class="string">&#x27;cd ..&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> ...=<span class="string">&#x27;cd ../..&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> h=<span class="string">&#x27;history&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="八、练习"><a href="#八、练习" class="headerlink" title="八、练习"></a>八、练习</h2><ol>
<li>创建目录结构：<code>project/{src,dist,docs}</code>，并在 src 下创建空文件</li>
<li>查找系统中所有大于 100MB 的文件</li>
<li>查看当前系统中内存占用最高的 5 个进程</li>
<li>设置一个定时任务，每天凌晨 2 点执行备份脚本</li>
<li>创建一个用户，并赋予 sudo 权限</li>
</ol>
<hr>
<p><strong>下一篇</strong>：<a href="/2026/02/24/Linux-%E4%B8%8E-Shell%EF%BC%88%E4%BA%8C%EF%BC%89Shell-%E8%84%9A%E6%9C%AC%E7%BC%96%E5%86%99/">Linux 与 Shell（二）：Shell 脚本编写</a></p>
<p><strong>参考资源</strong>：</p>
<ul>
<li><a href="https://linux-command.github.io/">Linux 命令行教程</a></li>
<li><a href="https://www.gnu.org/software/coreutils/manual/">GNU Coreutils 文档</a></li>
<li><a href="https://man7.org/linux/man-pages/">Linux  man 手册</a></li>
</ul>
]]></content>
      <categories>
        <category>系统与工具</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Shell</tag>
        <tag>系统管理</tag>
        <tag>运维</tag>
      </tags>
  </entry>
  <entry>
    <title>Git 版本控制与团队协作</title>
    <url>/2026/02/24/Git%20%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6%E4%B8%8E%E5%9B%A2%E9%98%9F%E5%8D%8F%E4%BD%9C/</url>
    <content><![CDATA[<h1 id="Git-版本控制与团队协作"><a href="#Git-版本控制与团队协作" class="headerlink" title="Git 版本控制与团队协作"></a>Git 版本控制与团队协作</h1><p>Git 是现代软件开发中不可或缺的工具。本篇将介绍 Git 的核心概念、常用命令、分支管理和团队协作流程。</p>
<h2 id="一、Git-基础"><a href="#一、Git-基础" class="headerlink" title="一、Git 基础"></a>一、Git 基础</h2><h3 id="1-1-版本控制简介"><a href="#1-1-版本控制简介" class="headerlink" title="1.1 版本控制简介"></a>1.1 版本控制简介</h3><p><strong>版本控制系统（VCS）</strong> 用于跟踪文件的变化历史，主要类型：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>特点</th>
<th>代表</th>
</tr>
</thead>
<tbody><tr>
<td>本地 VCS</td>
<td>单用户，单机器</td>
<td>RCS, SCCS</td>
</tr>
<tr>
<td>集中式 VCS</td>
<td>单服务器，多客户端</td>
<td>SVN, CVS</td>
</tr>
<tr>
<td>分布式 VCS</td>
<td>每人都有完整仓库</td>
<td>Git, Mercurial</td>
</tr>
</tbody></table>
<h3 id="1-2-Git-的特点"><a href="#1-2-Git-的特点" class="headerlink" title="1.2 Git 的特点"></a>1.2 Git 的特点</h3><ul>
<li><strong>分布式</strong>：每个人都是完整的仓库</li>
<li><strong>分支模型</strong>：轻量级分支，快速切换</li>
<li><strong>快照模式</strong>：存储快照而非差异</li>
<li><strong>数据校验</strong>：SHA-1 校验和保证数据完整性</li>
<li><strong>支持非线性开发</strong>：强大的合并能力</li>
</ul>
<h3 id="1-3-Git-的三个区域"><a href="#1-3-Git-的三个区域" class="headerlink" title="1.3 Git 的三个区域"></a>1.3 Git 的三个区域</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">工作目录 (Working Directory)</span><br><span class="line">    ↓ git add</span><br><span class="line">暂存区 (Staging Area / Index)</span><br><span class="line">    ↓ git commit</span><br><span class="line">仓库 (Repository / .git)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>工作目录</strong>：你看到和编辑的文件</li>
<li><strong>暂存区</strong>：准备提交的快照</li>
<li><strong>仓库</strong>：永久存储的提交历史</li>
</ul>
<h3 id="1-4-安装与配置"><a href="#1-4-安装与配置" class="headerlink" title="1.4 安装与配置"></a>1.4 安装与配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装 Git</span></span><br><span class="line"><span class="comment"># Ubuntu/Debian</span></span><br><span class="line"><span class="built_in">sudo</span> apt install git</span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS/RHEL</span></span><br><span class="line"><span class="built_in">sudo</span> yum install git</span><br><span class="line"></span><br><span class="line"><span class="comment"># macOS</span></span><br><span class="line">brew install git</span><br><span class="line"></span><br><span class="line"><span class="comment"># Windows</span></span><br><span class="line"><span class="comment"># 下载 https://git-scm.com/download/win</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置用户信息（重要！）</span></span><br><span class="line">git config --global user.name <span class="string">&quot;张三&quot;</span></span><br><span class="line">git config --global user.email <span class="string">&quot;zhangsan@example.com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看配置</span></span><br><span class="line">git config --list</span><br><span class="line">git config user.name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 常用配置</span></span><br><span class="line">git config --global core.editor <span class="string">&quot;vim&quot;</span>           <span class="comment"># 设置编辑器</span></span><br><span class="line">git config --global init.defaultBranch main     <span class="comment"># 默认分支名</span></span><br><span class="line">git config --global color.ui <span class="literal">true</span>               <span class="comment"># 启用颜色</span></span><br><span class="line">git config --global core.autocrlf input         <span class="comment"># 换行符处理（Mac/Linux）</span></span><br><span class="line">git config --global core.autocrlf <span class="literal">true</span>          <span class="comment"># 换行符处理（Windows）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - --global 表示全局配置（~/.gitconfig）</span></span><br><span class="line"><span class="comment"># - 去掉--global 表示仅当前仓库</span></span><br></pre></td></tr></table></figure>

<h2 id="二、基础操作"><a href="#二、基础操作" class="headerlink" title="二、基础操作"></a>二、基础操作</h2><h3 id="2-1-创建仓库"><a href="#2-1-创建仓库" class="headerlink" title="2.1 创建仓库"></a>2.1 创建仓库</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 初始化新仓库</span></span><br><span class="line"><span class="built_in">mkdir</span> myproject</span><br><span class="line"><span class="built_in">cd</span> myproject</span><br><span class="line">git init</span><br><span class="line"></span><br><span class="line"><span class="comment"># 克隆现有仓库</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/user/repo.git</span><br><span class="line">git <span class="built_in">clone</span> git@github.com:user/repo.git          <span class="comment"># SSH 方式</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/user/repo.git <span class="built_in">dir</span>  <span class="comment"># 指定目录</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 克隆特定分支</span></span><br><span class="line">git <span class="built_in">clone</span> -b dev https://github.com/user/repo.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - SSH 方式需要配置 SSH 密钥</span></span><br><span class="line"><span class="comment"># - HTTPS 方式每次可能需要输入密码</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-查看状态"><a href="#2-2-查看状态" class="headerlink" title="2.2 查看状态"></a>2.2 查看状态</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看仓库状态</span></span><br><span class="line">git status</span><br><span class="line">git status -s         <span class="comment"># 简洁模式</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 状态说明：</span></span><br><span class="line"><span class="comment"># ?? 未跟踪</span></span><br><span class="line"><span class="comment"># A  新增</span></span><br><span class="line"><span class="comment"># M  修改</span></span><br><span class="line"><span class="comment"># D  删除</span></span><br><span class="line"><span class="comment"># R  重命名</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-添加文件"><a href="#2-3-添加文件" class="headerlink" title="2.3 添加文件"></a>2.3 添加文件</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 添加到暂存区</span></span><br><span class="line">git add file.txt              <span class="comment"># 添加指定文件</span></span><br><span class="line">git add .                     <span class="comment"># 添加所有文件</span></span><br><span class="line">git add *.py                  <span class="comment"># 通配符</span></span><br><span class="line">git add -A                    <span class="comment"># 添加所有（包括删除）</span></span><br><span class="line">git add -p                    <span class="comment"># 交互式添加</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看暂存区内容</span></span><br><span class="line">git diff --staged             <span class="comment"># 已暂存的变更</span></span><br><span class="line">git diff --staged file.txt    <span class="comment"># 指定文件</span></span><br></pre></td></tr></table></figure>

<h3 id="2-4-提交"><a href="#2-4-提交" class="headerlink" title="2.4 提交"></a>2.4 提交</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 提交</span></span><br><span class="line">git commit -m <span class="string">&quot;提交信息&quot;</span></span><br><span class="line">git commit -m <span class="string">&quot;标题&quot;</span> -m <span class="string">&quot;详细描述&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交所有修改（跳过 add）</span></span><br><span class="line">git commit -am <span class="string">&quot;提交信息&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改最后一次提交</span></span><br><span class="line">git commit --amend -m <span class="string">&quot;新的提交信息&quot;</span></span><br><span class="line">git commit --amend --no-edit  <span class="comment"># 只添加遗漏的文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交时跳过 hooks</span></span><br><span class="line">git commit -m <span class="string">&quot;消息&quot;</span> --no-verify</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - 提交信息要简洁明了</span></span><br><span class="line"><span class="comment"># - 一次提交只做一件事</span></span><br></pre></td></tr></table></figure>

<h3 id="2-5-查看历史"><a href="#2-5-查看历史" class="headerlink" title="2.5 查看历史"></a>2.5 查看历史</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看提交历史</span></span><br><span class="line">git <span class="built_in">log</span></span><br><span class="line">git <span class="built_in">log</span> --oneline             <span class="comment"># 简洁模式</span></span><br><span class="line">git <span class="built_in">log</span> --graph               <span class="comment"># 图形化</span></span><br><span class="line">git <span class="built_in">log</span> --graph --oneline --all  <span class="comment"># 完整图形</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定数量</span></span><br><span class="line">git <span class="built_in">log</span> -n 5</span><br><span class="line">git <span class="built_in">log</span> -5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定文件</span></span><br><span class="line">git <span class="built_in">log</span> -- file.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定作者</span></span><br><span class="line">git <span class="built_in">log</span> --author=<span class="string">&quot;张三&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定时间</span></span><br><span class="line">git <span class="built_in">log</span> --since=<span class="string">&quot;2 weeks ago&quot;</span></span><br><span class="line">git <span class="built_in">log</span> --<span class="keyword">until</span>=<span class="string">&quot;2024-01-01&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 格式化输出</span></span><br><span class="line">git <span class="built_in">log</span> --pretty=format:<span class="string">&quot;%h - %an - %s&quot;</span></span><br><span class="line">git <span class="built_in">log</span> --pretty=format:<span class="string">&quot;%Cred%h%Creset - %an - %s&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 常用格式占位符：</span></span><br><span class="line"><span class="comment"># %H 完整哈希  %h 短哈希</span></span><br><span class="line"><span class="comment"># %an 作者名   %ae 作者邮箱</span></span><br><span class="line"><span class="comment"># %ad 日期     %s 提交信息</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看某次提交的详情</span></span><br><span class="line">git show commit_hash</span><br></pre></td></tr></table></figure>

<h2 id="三、分支管理"><a href="#三、分支管理" class="headerlink" title="三、分支管理"></a>三、分支管理</h2><h3 id="3-1-分支基础"><a href="#3-1-分支基础" class="headerlink" title="3.1 分支基础"></a>3.1 分支基础</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看分支</span></span><br><span class="line">git branch                    <span class="comment"># 本地分支</span></span><br><span class="line">git branch -a                 <span class="comment"># 所有分支</span></span><br><span class="line">git branch -r                 <span class="comment"># 远程分支</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建分支</span></span><br><span class="line">git branch feature-login      <span class="comment"># 创建分支</span></span><br><span class="line">git branch feature-login abc123  <span class="comment"># 从指定提交创建</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换分支</span></span><br><span class="line">git checkout feature-login</span><br><span class="line">git switch feature-login      <span class="comment"># Git 2.23+ 推荐</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建并切换</span></span><br><span class="line">git checkout -b feature-login</span><br><span class="line">git switch -c feature-login   <span class="comment"># Git 2.23+</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除分支</span></span><br><span class="line">git branch -d feature-login   <span class="comment"># 安全删除（已合并）</span></span><br><span class="line">git branch -D feature-login   <span class="comment"># 强制删除（未合并）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重命名分支</span></span><br><span class="line">git branch -m old-name new-name</span><br><span class="line">git branch -m new-name        <span class="comment"># 重命名当前分支</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看分支合并情况</span></span><br><span class="line">git branch --merged           <span class="comment"># 已合并的分支</span></span><br><span class="line">git branch --no-merged        <span class="comment"># 未合并的分支</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-分支模型"><a href="#3-2-分支模型" class="headerlink" title="3.2 分支模型"></a>3.2 分支模型</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">main/master</span><br><span class="line">  ├── develop</span><br><span class="line">  │   ├── feature/login</span><br><span class="line">  │   ├── feature/register</span><br><span class="line">  │   └── feature/profile</span><br><span class="line">  ├── release/v1.0</span><br><span class="line">  └── hotfix/bug-fix</span><br></pre></td></tr></table></figure>

<p><strong>常用分支命名规范：</strong></p>
<ul>
<li><code>main</code> &#x2F; <code>master</code> - 主分支（生产环境）</li>
<li><code>develop</code> - 开发分支</li>
<li><code>feature/xxx</code> - 功能分支</li>
<li><code>bugfix/xxx</code> - 修复分支</li>
<li><code>hotfix/xxx</code> - 紧急修复分支</li>
<li><code>release/x.y</code> - 发布分支</li>
</ul>
<h3 id="3-3-合并分支"><a href="#3-3-合并分支" class="headerlink" title="3.3 合并分支"></a>3.3 合并分支</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 合并分支</span></span><br><span class="line">git checkout main</span><br><span class="line">git merge feature-login</span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并类型：</span></span><br><span class="line"><span class="comment"># 1. Fast-forward（快进合并）- 没有分叉</span></span><br><span class="line"><span class="comment"># 2. Recursive（递归合并）- 有分叉，创建合并提交</span></span><br><span class="line"><span class="comment"># 3. Squash（压缩合并）- 多次提交合并为一次</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 压缩合并</span></span><br><span class="line">git merge --squash feature-login</span><br><span class="line">git commit -m <span class="string">&quot;添加登录功能&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 取消合并</span></span><br><span class="line">git merge --abort</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看合并冲突</span></span><br><span class="line">git status</span><br><span class="line">git diff</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解决冲突后</span></span><br><span class="line">git add conflicted_file.txt</span><br><span class="line">git commit</span><br></pre></td></tr></table></figure>

<h3 id="3-4-解决冲突"><a href="#3-4-解决冲突" class="headerlink" title="3.4 解决冲突"></a>3.4 解决冲突</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 当发生冲突时，文件内容如下：</span></span><br><span class="line">&lt;&lt;&lt;&lt;&lt;&lt;&lt; <span class="string">HEAD</span></span><br><span class="line"><span class="string">这是当前分支的内容</span></span><br><span class="line"><span class="string">=======</span></span><br><span class="line"><span class="string">这是要合并分支的内容</span></span><br><span class="line"><span class="string">&gt;&gt;&gt;&gt;&gt;&gt;&gt; feature-branch</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 解决步骤：</span></span><br><span class="line"><span class="string"># 1. 编辑文件，保留需要的内容</span></span><br><span class="line"><span class="string"># 2. 删除冲突标记（&lt;&lt;&lt;&lt;&lt;&lt;，======，&gt;&gt;&gt;&gt;&gt;&gt;&gt;）</span></span><br><span class="line"><span class="string"># 3. git add 解决冲突的文件</span></span><br><span class="line"><span class="string"># 4. git commit 完成合并</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 使用工具解决冲突</span></span><br><span class="line"><span class="string">git mergetool                   # 使用配置的合并工具</span></span><br><span class="line"><span class="string">git difftool                    # 查看差异</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 配置合并工具</span></span><br><span class="line"><span class="string">git config --global merge.tool vimdiff</span></span><br><span class="line"><span class="string">git config --global merge.conflictstyle diff3</span></span><br></pre></td></tr></table></figure>

<h3 id="3-5-变基（Rebase）"><a href="#3-5-变基（Rebase）" class="headerlink" title="3.5 变基（Rebase）"></a>3.5 变基（Rebase）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 变基操作</span></span><br><span class="line">git checkout feature</span><br><span class="line">git rebase main</span><br><span class="line"></span><br><span class="line"><span class="comment"># 交互式变基</span></span><br><span class="line">git rebase -i HEAD~5            <span class="comment"># 最近 5 次提交</span></span><br><span class="line">git rebase -i abc123            <span class="comment"># 从指定提交开始</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 交互式变基操作：</span></span><br><span class="line"><span class="comment"># pick   - 使用提交</span></span><br><span class="line"><span class="comment"># reword - 使用提交，修改信息</span></span><br><span class="line"><span class="comment"># edit   - 使用提交，暂停修改</span></span><br><span class="line"><span class="comment"># squash - 与前一个提交合并</span></span><br><span class="line"><span class="comment"># fixup  - 与前一个提交合并，丢弃信息</span></span><br><span class="line"><span class="comment"># drop   - 删除提交</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 继续/取消变基</span></span><br><span class="line">git rebase --<span class="built_in">continue</span></span><br><span class="line">git rebase --abort</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - 不要对已推送到远程的提交进行变基</span></span><br><span class="line"><span class="comment"># - 变基会修改历史，需要谨慎使用</span></span><br></pre></td></tr></table></figure>

<h2 id="四、远程协作"><a href="#四、远程协作" class="headerlink" title="四、远程协作"></a>四、远程协作</h2><h3 id="4-1-远程仓库"><a href="#4-1-远程仓库" class="headerlink" title="4.1 远程仓库"></a>4.1 远程仓库</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看远程仓库</span></span><br><span class="line">git remote</span><br><span class="line">git remote -v</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加远程仓库</span></span><br><span class="line">git remote add origin https://github.com/user/repo.git</span><br><span class="line">git remote add upstream https://github.com/original/repo.git  <span class="comment"># 上游仓库</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重命名远程仓库</span></span><br><span class="line">git remote rename origin upstream</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除远程仓库</span></span><br><span class="line">git remote remove origin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取远程信息</span></span><br><span class="line">git fetch origin              <span class="comment"># 获取所有分支</span></span><br><span class="line">git fetch origin main         <span class="comment"># 获取指定分支</span></span><br><span class="line">git fetch --all               <span class="comment"># 获取所有远程仓库</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 拉取并合并</span></span><br><span class="line">git pull origin main</span><br><span class="line">git pull --rebase origin main  <span class="comment"># 拉取并变基</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 推送</span></span><br><span class="line">git push origin main</span><br><span class="line">git push -u origin main       <span class="comment"># 推送并设置上游</span></span><br><span class="line">git push --force              <span class="comment"># 强制推送（危险！）</span></span><br><span class="line">git push --force-with-lease   <span class="comment"># 安全强制推送</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除远程分支</span></span><br><span class="line">git push origin --delete feature-login</span><br><span class="line">git push origin :feature-login  <span class="comment"># 旧语法</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - git fetch 只下载，不合并</span></span><br><span class="line"><span class="comment"># - git pull = git fetch + git merge</span></span><br><span class="line"><span class="comment"># - 强制推送前确保了解风险</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-SSH-密钥配置"><a href="#4-2-SSH-密钥配置" class="headerlink" title="4.2 SSH 密钥配置"></a>4.2 SSH 密钥配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 生成 SSH 密钥</span></span><br><span class="line">ssh-keygen -t ed25519 -C <span class="string">&quot;zhangsan@example.com&quot;</span></span><br><span class="line">ssh-keygen -t rsa -b 4096 -C <span class="string">&quot;zhangsan@example.com&quot;</span>  <span class="comment"># 旧算法</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看公钥</span></span><br><span class="line"><span class="built_in">cat</span> ~/.ssh/id_ed25519.pub</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加公钥到 GitHub/Gitee</span></span><br><span class="line"><span class="comment"># 复制公钥内容，添加到对应平台的 SSH Keys 设置</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试连接</span></span><br><span class="line">ssh -T git@github.com</span><br><span class="line">ssh -T git@gitee.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置多个 SSH 密钥</span></span><br><span class="line"><span class="comment"># ~/.ssh/config</span></span><br><span class="line">Host github.com</span><br><span class="line">    HostName github.com</span><br><span class="line">    User git</span><br><span class="line">    IdentityFile ~/.ssh/id_ed25519_github</span><br><span class="line"></span><br><span class="line">Host gitee.com</span><br><span class="line">    HostName gitee.com</span><br><span class="line">    User git</span><br><span class="line">    IdentityFile ~/.ssh/id_ed25519_gitee</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - 私钥不能泄露</span></span><br><span class="line"><span class="comment"># - 公钥可以随意分享</span></span><br></pre></td></tr></table></figure>

<h3 id="4-3-标签管理"><a href="#4-3-标签管理" class="headerlink" title="4.3 标签管理"></a>4.3 标签管理</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看标签</span></span><br><span class="line">git tag</span><br><span class="line">git tag -l <span class="string">&quot;v1.*&quot;</span>             <span class="comment"># 模糊匹配</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建标签</span></span><br><span class="line">git tag v1.0.0                <span class="comment"># 轻量标签</span></span><br><span class="line">git tag -a v1.0.0 -m <span class="string">&quot;版本 1.0.0&quot;</span>  <span class="comment"># 附注标签（推荐）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看标签详情</span></span><br><span class="line">git show v1.0.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 推送标签</span></span><br><span class="line">git push origin v1.0.0</span><br><span class="line">git push origin --tags        <span class="comment"># 推送所有标签</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除标签</span></span><br><span class="line">git tag -d v1.0.0</span><br><span class="line">git push origin --delete v1.0.0  <span class="comment"># 删除远程标签</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到标签</span></span><br><span class="line">git checkout v1.0.0</span><br></pre></td></tr></table></figure>

<h2 id="五、团队协作流程"><a href="#五、团队协作流程" class="headerlink" title="五、团队协作流程"></a>五、团队协作流程</h2><h3 id="5-1-Git-Flow-工作流"><a href="#5-1-Git-Flow-工作流" class="headerlink" title="5.1 Git Flow 工作流"></a>5.1 Git Flow 工作流</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">main/master (生产)</span><br><span class="line">  ↑</span><br><span class="line">  └── develop (开发)</span><br><span class="line">      ↑</span><br><span class="line">      ├── feature/login (功能)</span><br><span class="line">      ├── feature/register (功能)</span><br><span class="line">      │</span><br><span class="line">      └── release/v1.0 (发布)</span><br><span class="line">          ↑</span><br><span class="line">          └── hotfix/xxx (紧急修复)</span><br></pre></td></tr></table></figure>

<p><strong>Git Flow 流程：</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 创建功能分支</span></span><br><span class="line">git checkout develop</span><br><span class="line">git checkout -b feature/login</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 开发并提交</span></span><br><span class="line">git add .</span><br><span class="line">git commit -m <span class="string">&quot;添加登录功能&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 同步主分支</span></span><br><span class="line">git fetch origin</span><br><span class="line">git rebase origin/develop</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 完成功能，合并到 develop</span></span><br><span class="line">git checkout develop</span><br><span class="line">git merge --no-ff feature-login</span><br><span class="line">git branch -d feature-login</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 发布版本</span></span><br><span class="line">git checkout -b release/v1.0 develop</span><br><span class="line"><span class="comment"># 进行最后的调整和测试</span></span><br><span class="line">git checkout main</span><br><span class="line">git merge --no-ff release/v1.0</span><br><span class="line">git tag v1.0.0</span><br><span class="line">git checkout develop</span><br><span class="line">git merge --no-ff release/v1.0</span><br><span class="line">git branch -d release/v1.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 紧急修复</span></span><br><span class="line">git checkout -b hotfix/xxx main</span><br><span class="line"><span class="comment"># 修复 bug</span></span><br><span class="line">git checkout main</span><br><span class="line">git merge --no-ff hotfix/xxx</span><br><span class="line">git tag v1.0.1</span><br><span class="line">git checkout develop</span><br><span class="line">git merge --no-ff hotfix/xxx</span><br><span class="line">git branch -d hotfix/xxx</span><br></pre></td></tr></table></figure>

<h3 id="5-2-GitHub-Flow-工作流"><a href="#5-2-GitHub-Flow-工作流" class="headerlink" title="5.2 GitHub Flow 工作流"></a>5.2 GitHub Flow 工作流</h3><p>GitHub Flow 更简单，适合持续部署：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 从 main 创建分支</span></span><br><span class="line">git checkout main</span><br><span class="line">git checkout -b feature-login</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 开发并提交</span></span><br><span class="line">git add .</span><br><span class="line">git commit -m <span class="string">&quot;添加登录功能&quot;</span></span><br><span class="line">git push -u origin feature-login</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 创建 Pull Request</span></span><br><span class="line"><span class="comment"># 在 GitHub/Gitee 网页上创建 PR</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 代码审查</span></span><br><span class="line"><span class="comment"># 根据审查意见修改</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 合并到 main</span></span><br><span class="line"><span class="comment"># PR 批准后合并</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 部署</span></span><br><span class="line"><span class="comment"># 自动或手动部署</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-Pull-Request-Merge-Request-流程"><a href="#5-3-Pull-Request-Merge-Request-流程" class="headerlink" title="5.3 Pull Request &#x2F; Merge Request 流程"></a>5.3 Pull Request &#x2F; Merge Request 流程</h3><p><strong>创建 PR 的步骤：</strong></p>
<ol>
<li>Fork 仓库（如果是外部贡献）</li>
<li>克隆仓库：<code>git clone your-fork</code></li>
<li>创建功能分支：<code>git checkout -b feature-xxx</code></li>
<li>提交更改：<code>git commit -m &quot;描述&quot;</code></li>
<li>推送分支：<code>git push origin feature-xxx</code></li>
<li>在 GitHub&#x2F;Gitee 上创建 PR</li>
<li>等待审查，根据意见修改</li>
<li>PR 合并</li>
</ol>
<p><strong>PR 最佳实践：</strong></p>
<ul>
<li>标题简洁明了</li>
<li>描述说明更改内容和原因</li>
<li>一次 PR 只做一件事</li>
<li>确保 CI 测试通过</li>
<li>及时回复审查意见</li>
</ul>
<h3 id="5-4-提交信息规范"><a href="#5-4-提交信息规范" class="headerlink" title="5.4 提交信息规范"></a>5.4 提交信息规范</h3><p><strong>Conventional Commits 规范：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;type&gt;(&lt;scope&gt;): &lt;subject&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;footer&gt;</span><br></pre></td></tr></table></figure>

<p><strong>Type 类型：</strong></p>
<ul>
<li><code>feat</code> - 新功能</li>
<li><code>fix</code> - 修复 bug</li>
<li><code>docs</code> - 文档更新</li>
<li><code>style</code> - 代码格式（不影响功能）</li>
<li><code>refactor</code> - 重构</li>
<li><code>perf</code> - 性能优化</li>
<li><code>test</code> - 测试相关</li>
<li><code>chore</code> - 构建&#x2F;工具&#x2F;配置</li>
<li><code>ci</code> - CI 配置</li>
<li><code>revert</code> - 回滚</li>
</ul>
<p><strong>示例：</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">feat(auth): 添加用户登录功能</span><br><span class="line"></span><br><span class="line">- 实现登录页面</span><br><span class="line">- 添加 JWT 认证</span><br><span class="line">- 添加记住登录功能</span><br><span class="line"></span><br><span class="line">Closes <span class="comment">#123</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">fix(api): 修复用户 API 的空指针异常</span><br><span class="line"></span><br><span class="line">当用户不存在时返回 404 而不是 500</span><br><span class="line"></span><br><span class="line">Fixes <span class="comment">#456</span></span><br></pre></td></tr></table></figure>

<h2 id="六、高级技巧"><a href="#六、高级技巧" class="headerlink" title="六、高级技巧"></a>六、高级技巧</h2><h3 id="6-1-暂存（Stash）"><a href="#6-1-暂存（Stash）" class="headerlink" title="6.1 暂存（Stash）"></a>6.1 暂存（Stash）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 暂存当前更改</span></span><br><span class="line">git stash</span><br><span class="line">git stash save <span class="string">&quot;WIP: 登录功能&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看暂存列表</span></span><br><span class="line">git stash list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用暂存</span></span><br><span class="line">git stash apply              <span class="comment"># 应用但不删除</span></span><br><span class="line">git stash apply stash@&#123;1&#125;    <span class="comment"># 应用指定暂存</span></span><br><span class="line">git stash pop                <span class="comment"># 应用并删除</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除暂存</span></span><br><span class="line">git stash drop</span><br><span class="line">git stash drop stash@&#123;1&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清空所有暂存</span></span><br><span class="line">git stash clear</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从暂存创建分支</span></span><br><span class="line">git stash branch feature-login stash@&#123;0&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-撤销操作"><a href="#6-2-撤销操作" class="headerlink" title="6.2 撤销操作"></a>6.2 撤销操作</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 撤销工作区修改</span></span><br><span class="line">git checkout -- file.txt</span><br><span class="line">git restore file.txt         <span class="comment"># Git 2.23+</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 撤销暂存</span></span><br><span class="line">git reset HEAD file.txt</span><br><span class="line">git restore --staged file.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 撤销提交（保留更改）</span></span><br><span class="line">git reset --soft HEAD~1      <span class="comment"># 回退提交，保留暂存</span></span><br><span class="line">git reset --mixed HEAD~1     <span class="comment"># 回退提交，保留工作区（默认）</span></span><br><span class="line">git reset --hard HEAD~1      <span class="comment"># 完全回退（危险！）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 撤销已推送的提交</span></span><br><span class="line">git revert commit_hash       <span class="comment"># 创建新的提交撤销更改</span></span><br><span class="line">git revert HEAD~3..HEAD      <span class="comment"># 撤销多个提交</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - reset 会修改历史，revert 不会</span></span><br><span class="line"><span class="comment"># - 已推送的提交用 revert，不要用 reset</span></span><br></pre></td></tr></table></figure>

<h3 id="6-3-Cherry-pick"><a href="#6-3-Cherry-pick" class="headerlink" title="6.3 Cherry-pick"></a>6.3 Cherry-pick</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 拣选提交（将某提交应用到当前分支）</span></span><br><span class="line">git cherry-pick commit_hash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拣选多个提交</span></span><br><span class="line">git cherry-pick hash1 hash2 hash3</span><br><span class="line">git cherry-pick hash1..hash2   <span class="comment"># 范围</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 继续/跳过/中止</span></span><br><span class="line">git cherry-pick --<span class="built_in">continue</span></span><br><span class="line">git cherry-pick --skip</span><br><span class="line">git cherry-pick --abort</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - 用于将特定提交从一个分支移到另一个分支</span></span><br><span class="line"><span class="comment"># - 会创建新的提交（哈希值不同）</span></span><br></pre></td></tr></table></figure>

<h3 id="6-4-子模块（Submodule）"><a href="#6-4-子模块（Submodule）" class="headerlink" title="6.4 子模块（Submodule）"></a>6.4 子模块（Submodule）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 添加子模块</span></span><br><span class="line">git submodule add https://github.com/user/lib.git libs/mylib</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化子模块</span></span><br><span class="line">git submodule init</span><br><span class="line">git submodule update</span><br><span class="line"></span><br><span class="line"><span class="comment"># 克隆带子模块的仓库</span></span><br><span class="line">git <span class="built_in">clone</span> --recursive https://github.com/user/repo.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新子模块</span></span><br><span class="line">git submodule update --remote</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除子模块</span></span><br><span class="line">git submodule deinit libs/mylib</span><br><span class="line">git <span class="built_in">rm</span> libs/mylib</span><br><span class="line"><span class="built_in">rm</span> -rf .git/modules/libs/mylib</span><br></pre></td></tr></table></figure>

<h3 id="6-5-Git-Hooks"><a href="#6-5-Git-Hooks" class="headerlink" title="6.5 Git Hooks"></a>6.5 Git Hooks</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Git hooks 位置：.git/hooks/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 常用 hooks：</span></span><br><span class="line"><span class="comment"># pre-commit     - 提交前检查</span></span><br><span class="line"><span class="comment"># pre-push       - 推送前检查</span></span><br><span class="line"><span class="comment"># post-merge     - 合并后执行</span></span><br><span class="line"><span class="comment"># post-checkout  - 切换分支后执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例：pre-commit 检查代码风格</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment"># .git/hooks/pre-commit</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查是否有语法错误</span></span><br><span class="line">python -m py_compile $(git diff --cached --name-only --diff-filter=ACM | grep <span class="string">&#x27;\.py$&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Python 语法检查失败&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行 linter</span></span><br><span class="line">flake8 $(git diff --cached --name-only --diff-filter=ACM | grep <span class="string">&#x27;\.py$&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;代码风格检查失败&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h2 id="七、最佳实践"><a href="#七、最佳实践" class="headerlink" title="七、最佳实践"></a>七、最佳实践</h2><blockquote>
<p><strong>提醒自己</strong>：</p>
<ol>
<li><strong>提交要频繁</strong>：小步提交，便于回滚和审查</li>
<li><strong>提交信息要清晰</strong>：说明做了什么和为什么</li>
<li><strong>分支命名要规范</strong>：feature&#x2F;xxx, bugfix&#x2F;xxx</li>
<li><strong>及时同步主分支</strong>：避免大的合并冲突</li>
<li><strong>代码审查要认真</strong>：及时回复，互相学习</li>
<li><strong>不要推送修改的历史</strong>：避免给别人造成困扰</li>
<li><strong>定期清理分支</strong>：删除已合并的分支</li>
<li><strong>使用.gitignore</strong>：不提交不必要的文件</li>
</ol>
</blockquote>
<h3 id="gitignore-模板"><a href="#gitignore-模板" class="headerlink" title=".gitignore 模板"></a>.gitignore 模板</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 操作系统</span><br><span class="line">.DS_Store</span><br><span class="line">Thumbs.db</span><br><span class="line"></span><br><span class="line"># IDE</span><br><span class="line">.vscode/</span><br><span class="line">.idea/</span><br><span class="line">*.swp</span><br><span class="line">*.swo</span><br><span class="line"></span><br><span class="line"># 依赖</span><br><span class="line">node_modules/</span><br><span class="line">vendor/</span><br><span class="line">__pycache__/</span><br><span class="line">*.pyc</span><br><span class="line"></span><br><span class="line"># 构建输出</span><br><span class="line">dist/</span><br><span class="line">build/</span><br><span class="line">*.o</span><br><span class="line">*.so</span><br><span class="line"></span><br><span class="line"># 日志</span><br><span class="line">*.log</span><br><span class="line">logs/</span><br><span class="line"></span><br><span class="line"># 环境配置</span><br><span class="line">.env</span><br><span class="line">.env.local</span><br><span class="line">.env.*.local</span><br><span class="line"></span><br><span class="line"># 敏感信息</span><br><span class="line">*.pem</span><br><span class="line">*.key</span><br><span class="line">secrets/</span><br><span class="line"></span><br><span class="line"># 数据</span><br><span class="line">*.db</span><br><span class="line">*.sqlite</span><br><span class="line">data/</span><br><span class="line"></span><br><span class="line"># 提醒自己：</span><br><span class="line"># - .gitignore 对已跟踪的文件无效</span><br><span class="line"># - 可以用 git rm -r --cached 清除缓存</span><br></pre></td></tr></table></figure>

<h2 id="八、练习"><a href="#八、练习" class="headerlink" title="八、练习"></a>八、练习</h2><ol>
<li>初始化一个 Git 仓库，创建并提交多个文件</li>
<li>创建功能分支，开发后合并到主分支</li>
<li>模拟并解决合并冲突</li>
<li>配置 SSH 密钥，推送到 GitHub&#x2F;Gitee</li>
<li>实践 Git Flow 或 GitHub Flow 工作流</li>
<li>使用 git rebase -i 整理提交历史</li>
<li>创建一个规范的 Pull Request</li>
</ol>
<hr>
<p><strong>上一篇</strong>：<a href="/2026/02/24/Linux-%E4%B8%8E-Shell%EF%BC%88%E4%BA%8C%EF%BC%89Shell-%E8%84%9A%E6%9C%AC%E7%BC%96%E5%86%99/">Linux 与 Shell（二）：Shell 脚本编写</a></p>
<p><strong>下一篇</strong>：<a href="/2026/02/24/IDE-%E5%B7%A5%E5%85%B7%E9%85%8D%E7%BD%AE/">IDE 工具配置：VS Code + Jupyter + DataGrip</a></p>
<p><strong>参考资源</strong>：</p>
<ul>
<li><a href="https://git-scm.com/doc">Git 官方文档</a></li>
<li><a href="https://git-scm.com/book/zh/v2">Pro Git 电子书（中文）</a></li>
<li><a href="https://nvie.com/posts/a-successful-git-branching-model/">Git Flow 工作流</a></li>
<li><a href="https://www.conventionalcommits.org/">Conventional Commits</a></li>
</ul>
]]></content>
      <categories>
        <category>系统与工具</category>
      </categories>
      <tags>
        <tag>Git</tag>
        <tag>版本控制</tag>
        <tag>团队协作</tag>
        <tag>开发流程</tag>
      </tags>
  </entry>
  <entry>
    <title>IDE 工具配置：VS Code + Jupyter + DataGrip</title>
    <url>/2026/02/24/IDE%20%E5%B7%A5%E5%85%B7%E9%85%8D%E7%BD%AE%EF%BC%9AVS%20Code%20+%20Jupyter%20+%20DataGrip/</url>
    <content><![CDATA[<h1 id="IDE-工具配置：VS-Code-Jupyter-DataGrip"><a href="#IDE-工具配置：VS-Code-Jupyter-DataGrip" class="headerlink" title="IDE 工具配置：VS Code + Jupyter + DataGrip"></a>IDE 工具配置：VS Code + Jupyter + DataGrip</h1><p>工欲善其事，必先利其器。本篇将介绍三款常用的开发工具：VS Code（通用 IDE）、Jupyter Notebook（数据科学）和 DataGrip（数据库管理）。</p>
<h2 id="一、VS-Code"><a href="#一、VS-Code" class="headerlink" title="一、VS Code"></a>一、VS Code</h2><h3 id="1-1-简介与安装"><a href="#1-1-简介与安装" class="headerlink" title="1.1 简介与安装"></a>1.1 简介与安装</h3><p><strong>Visual Studio Code (VS Code)</strong> 是微软开发的免费开源代码编辑器，支持几乎所有主流编程语言。</p>
<p><strong>特点：</strong></p>
<ul>
<li>免费开源</li>
<li>跨平台（Windows、macOS、Linux）</li>
<li>丰富的插件生态</li>
<li>轻量快速</li>
<li>内置 Git 支持</li>
</ul>
<p><strong>下载安装：</strong></p>
<ul>
<li>官网：<a href="https://code.visualstudio.com/">https://code.visualstudio.com/</a></li>
<li>下载对应系统版本安装</li>
</ul>
<h3 id="1-2-基础配置"><a href="#1-2-基础配置" class="headerlink" title="1.2 基础配置"></a>1.2 基础配置</h3><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="comment">// settings.json (文件 -&gt; 首选项 -&gt; 设置 -&gt; 点击右上角打开 settings.json)</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// 编辑器设置</span></span><br><span class="line">    <span class="attr">&quot;editor.fontSize&quot;</span><span class="punctuation">:</span> <span class="number">14</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;editor.fontFamily&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#x27;JetBrains Mono&#x27;, &#x27;Fira Code&#x27;, Consolas, &#x27;Courier New&#x27;, monospace&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;editor.minimap.enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;editor.renderWhitespace&quot;</span><span class="punctuation">:</span> <span class="string">&quot;selection&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;editor.formatOnSave&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;editor.tabSize&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;editor.insertSpaces&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;editor.wordWrap&quot;</span><span class="punctuation">:</span> <span class="string">&quot;on&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 文件设置</span></span><br><span class="line">    <span class="attr">&quot;files.encoding&quot;</span><span class="punctuation">:</span> <span class="string">&quot;utf8&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;files.eol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\n&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;files.autoSave&quot;</span><span class="punctuation">:</span> <span class="string">&quot;afterDelay&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;files.autoSaveDelay&quot;</span><span class="punctuation">:</span> <span class="number">1000</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;files.exclude&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;**/.git&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;**/.svn&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;**/.hg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;**/node_modules&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;**/__pycache__&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;**/*.pyc&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 终端设置</span></span><br><span class="line">    <span class="attr">&quot;terminal.integrated.defaultProfile.windows&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Git Bash&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;terminal.integrated.fontSize&quot;</span><span class="punctuation">:</span> <span class="number">13</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 工作台设置</span></span><br><span class="line">    <span class="attr">&quot;workbench.colorTheme&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Default Dark+&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;workbench.iconTheme&quot;</span><span class="punctuation">:</span> <span class="string">&quot;material-icon-theme&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;workbench.statusBar.visible&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;workbench.activityBar.visible&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Python 设置</span></span><br><span class="line">    <span class="attr">&quot;python.defaultInterpreterPath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;python&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;python.linting.enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;python.linting.pylintEnabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;python.formatting.provider&quot;</span><span class="punctuation">:</span> <span class="string">&quot;black&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;python.formatting.blackPath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;black&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Git 设置</span></span><br><span class="line">    <span class="attr">&quot;git.autorefresh&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;git.enableSmartCommit&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;git.confirmSync&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;git.pruneOnFetch&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="1-3-必备插件"><a href="#1-3-必备插件" class="headerlink" title="1.3 必备插件"></a>1.3 必备插件</h3><p><strong>通用插件：</strong></p>
<table>
<thead>
<tr>
<th>插件名</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>Chinese (Simplified)</td>
<td>中文语言包</td>
</tr>
<tr>
<td>Material Icon Theme</td>
<td>文件图标美化</td>
</tr>
<tr>
<td>One Dark Pro &#x2F; Dracula</td>
<td>主题</td>
</tr>
<tr>
<td>Prettier - Code formatter</td>
<td>代码格式化</td>
</tr>
<tr>
<td>ESLint</td>
<td>JavaScript 语法检查</td>
</tr>
<tr>
<td>GitLens</td>
<td>Git 增强</td>
</tr>
<tr>
<td>Path Intellisense</td>
<td>路径自动补全</td>
</tr>
<tr>
<td>Bracket Pair Colorizer</td>
<td>括号颜色配对</td>
</tr>
<tr>
<td>Settings Sync</td>
<td>配置同步</td>
</tr>
</tbody></table>
<p><strong>Python 开发：</strong></p>
<table>
<thead>
<tr>
<th>插件名</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>Python (Microsoft)</td>
<td>Python 支持</td>
</tr>
<tr>
<td>Pylance</td>
<td>Python 语言服务器</td>
</tr>
<tr>
<td>Jupyter</td>
<td>Jupyter Notebook 支持</td>
</tr>
<tr>
<td>Python Indent</td>
<td>Python 缩进优化</td>
</tr>
<tr>
<td>autoDocstring</td>
<td>自动生成文档字符串</td>
</tr>
</tbody></table>
<p><strong>Web 开发：</strong></p>
<table>
<thead>
<tr>
<th>插件名</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>Live Server</td>
<td>本地服务器</td>
</tr>
<tr>
<td>Auto Rename Tag</td>
<td>自动重命名 HTML 标签</td>
</tr>
<tr>
<td>CSS Peek</td>
<td>CSS 定义跳转</td>
</tr>
<tr>
<td>JavaScript (ES6) code snippets</td>
<td>JS 代码片段</td>
</tr>
<tr>
<td>Vue Language Features</td>
<td>Vue 支持</td>
</tr>
<tr>
<td>Vetur</td>
<td>Vue 2 支持</td>
</tr>
</tbody></table>
<p><strong>其他语言：</strong></p>
<table>
<thead>
<tr>
<th>插件名</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>C&#x2F;C++ (Microsoft)</td>
<td>C&#x2F;C++ 支持</td>
</tr>
<tr>
<td>Go (Go Team at Google)</td>
<td>Go 支持</td>
</tr>
<tr>
<td>Rust Analyzer</td>
<td>Rust 支持</td>
</tr>
<tr>
<td>Java Extension Pack</td>
<td>Java 支持</td>
</tr>
</tbody></table>
<h3 id="1-4-快捷键"><a href="#1-4-快捷键" class="headerlink" title="1.4 快捷键"></a>1.4 快捷键</h3><p><strong>常用快捷键（Windows）：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Ctrl + P          快速打开文件</span><br><span class="line">Ctrl + Shift + P  命令面板</span><br><span class="line">Ctrl + `          打开终端</span><br><span class="line">Ctrl + S          保存</span><br><span class="line">Ctrl + Z          撤销</span><br><span class="line">Ctrl + Y          重做</span><br><span class="line">Ctrl + F          查找</span><br><span class="line">Ctrl + H          替换</span><br><span class="line">Ctrl + /          行注释</span><br><span class="line">Ctrl + Shift + /  块注释</span><br><span class="line">Alt + Up/Down     移动行</span><br><span class="line">Shift + Alt + Up/Down  复制行</span><br><span class="line">F12               跳转到定义</span><br><span class="line">Alt + F12         查看定义</span><br><span class="line">Shift + F12       查看引用</span><br><span class="line">Ctrl + D          选择下一个匹配项</span><br><span class="line">Ctrl + Shift + L  选择所有匹配项</span><br><span class="line">Ctrl + K, Ctrl + S  查看快捷键列表</span><br></pre></td></tr></table></figure>

<p><strong>自定义快捷键（keybindings.json）：</strong></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ctrl+s&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;workbench.action.files.save&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ctrl+/&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;editor.action.commentLine&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;when&quot;</span><span class="punctuation">:</span> <span class="string">&quot;editorTextFocus&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ctrl+`&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;workbench.action.terminal.toggleTerminal&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<h3 id="1-5-代码片段（Snippets）"><a href="#1-5-代码片段（Snippets）" class="headerlink" title="1.5 代码片段（Snippets）"></a>1.5 代码片段（Snippets）</h3><p><strong>创建自定义代码片段：</strong><br>文件 -&gt; 首选项 -&gt; 配置用户代码片段</p>
<p><strong>Python 代码片段示例：</strong></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Python Main&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;prefix&quot;</span><span class="punctuation">:</span> <span class="string">&quot;main&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;body&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;if __name__ == &#x27;__main__&#x27;:&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;    $&#123;0&#125;&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Python main 入口&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Python Class&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;prefix&quot;</span><span class="punctuation">:</span> <span class="string">&quot;class&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;body&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;class $&#123;1:ClassName&#125;:&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;    \&quot;\&quot;\&quot;$&#123;2:类描述&#125;\&quot;\&quot;\&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;    &quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;    def __init__(self, $&#123;3:args&#125;):&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;        self.$&#123;3&#125; = $&#123;3&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;    &quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;    def $&#123;4:method&#125;(self):&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;        $&#123;0&#125;&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Python 类模板&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Python Function&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;prefix&quot;</span><span class="punctuation">:</span> <span class="string">&quot;def&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;body&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;def $&#123;1:function_name&#125;($&#123;2:args&#125;):&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;    \&quot;\&quot;\&quot;$&#123;3:函数描述&#125;\&quot;\&quot;\&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;    $&#123;0&#125;&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Python 函数模板&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="1-6-调试配置"><a href="#1-6-调试配置" class="headerlink" title="1.6 调试配置"></a>1.6 调试配置</h3><p><strong>launch.json 示例：</strong></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Python: 当前文件&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;python&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;program&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;file&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;console&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integratedTerminal&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;justMyCode&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Python: 带参数&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;python&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;program&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;file&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;console&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integratedTerminal&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;--arg1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;value1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;--arg2&quot;</span><span class="punctuation">,</span> <span class="string">&quot;value2&quot;</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Python: Django&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;python&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;program&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;/manage.py&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;console&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integratedTerminal&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;runserver&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--noreload&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;django&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Python: Flask&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;python&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;module&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flask&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;FLASK_APP&quot;</span><span class="punctuation">:</span> <span class="string">&quot;app.py&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;FLASK_ENV&quot;</span><span class="punctuation">:</span> <span class="string">&quot;development&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;FLASK_DEBUG&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;run&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--no-debugger&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--no-reload&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;jinja&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="二、Jupyter-Notebook"><a href="#二、Jupyter-Notebook" class="headerlink" title="二、Jupyter Notebook"></a>二、Jupyter Notebook</h2><h3 id="2-1-简介与安装"><a href="#2-1-简介与安装" class="headerlink" title="2.1 简介与安装"></a>2.1 简介与安装</h3><p><strong>Jupyter Notebook</strong> 是一个开源的 Web 应用程序，支持创建和共享包含实时代码、公式、可视化和叙述性文本的文档。</p>
<p><strong>适用场景：</strong></p>
<ul>
<li>数据清洗和转换</li>
<li>数值模拟</li>
<li>统计建模</li>
<li>数据可视化</li>
<li>机器学习</li>
</ul>
<p><strong>安装方式：</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 方式一：pip 安装</span></span><br><span class="line">pip install jupyter</span><br><span class="line">pip install notebook</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式二：conda 安装（推荐）</span></span><br><span class="line">conda install jupyter notebook</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 Jupyter</span></span><br><span class="line">jupyter notebook</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定端口</span></span><br><span class="line">jupyter notebook --port 8889</span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许远程访问</span></span><br><span class="line">jupyter notebook --ip=0.0.0.0 --port=8888 --no-browser</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成配置文件</span></span><br><span class="line">jupyter notebook --generate-config</span><br></pre></td></tr></table></figure>

<h3 id="2-2-JupyterLab"><a href="#2-2-JupyterLab" class="headerlink" title="2.2 JupyterLab"></a>2.2 JupyterLab</h3><p><strong>JupyterLab</strong> 是新一代的 Jupyter 界面，更强大更灵活。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">pip install jupyterlab</span><br><span class="line">conda install jupyterlab</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">jupyter lab</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装插件</span></span><br><span class="line">jupyter labextension install @jupyterlab/git</span><br></pre></td></tr></table></figure>

<h3 id="2-3-基本使用"><a href="#2-3-基本使用" class="headerlink" title="2.3 基本使用"></a>2.3 基本使用</h3><p><strong>Notebook 界面元素：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">菜单栏：File, Edit, View, Insert, Cell, Kernel, Help</span><br><span class="line">工具栏：保存、添加单元格、剪切、复制、粘贴、移动、运行、停止</span><br><span class="line">单元格类型：Code（代码）、Markdown（文本）、Raw NBConvert（原始文本）</span><br></pre></td></tr></table></figure>

<p><strong>常用操作：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Esc          进入命令模式</span><br><span class="line">Enter        进入编辑模式</span><br><span class="line">A            在上方插入单元格</span><br><span class="line">B            在下方插入单元格</span><br><span class="line">M            转为 Markdown 单元格</span><br><span class="line">Y            转为 Code 单元格</span><br><span class="line">D, D         删除单元格</span><br><span class="line">Z            撤销删除</span><br><span class="line">C            复制单元格</span><br><span class="line">V            粘贴单元格</span><br><span class="line">X            剪切单元格</span><br><span class="line">Shift + V    粘贴到上方</span><br><span class="line">Shift + Enter 运行并跳到下一个</span><br><span class="line">Ctrl + Enter 运行当前单元格</span><br><span class="line">Alt + Enter  运行并在下方插入新单元格</span><br><span class="line">1, 2, 3...   设置为对应级别的标题</span><br></pre></td></tr></table></figure>

<h3 id="2-4-Markdown-单元格"><a href="#2-4-Markdown-单元格" class="headerlink" title="2.4 Markdown 单元格"></a>2.4 Markdown 单元格</h3><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="section"># 一级标题</span></span><br><span class="line"><span class="section">## 二级标题</span></span><br><span class="line"><span class="section">### 三级标题</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**粗体文本**</span></span><br><span class="line"><span class="emphasis">*斜体文本*</span></span><br><span class="line">~~删除线~~</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 无序列表项 1</span><br><span class="line"><span class="bullet">-</span> 无序列表项 2</span><br><span class="line"></span><br><span class="line"><span class="bullet">1.</span> 有序列表项 1</span><br><span class="line"><span class="bullet">2.</span> 有序列表项 2</span><br><span class="line"></span><br><span class="line">[<span class="string">链接文本</span>](<span class="link">https://example.com</span>)</span><br><span class="line"></span><br><span class="line">![<span class="string">图片描述</span>](<span class="link">image.png</span>)</span><br><span class="line"></span><br><span class="line"><span class="quote">&gt; 引用文本</span></span><br><span class="line"></span><br><span class="line"><span class="code">`行内代码`</span></span><br><span class="line"></span><br><span class="line"><span class="code">```python</span></span><br><span class="line"><span class="code"># 代码块</span></span><br><span class="line"><span class="code">def hello():</span></span><br><span class="line"><span class="code">    print(&quot;Hello, World!&quot;)</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>表头 1</th>
<th>表头 2</th>
<th>表头 3</th>
</tr>
</thead>
<tbody><tr>
<td>单元格</td>
<td>单元格</td>
<td>单元格</td>
</tr>
</tbody></table>
<p>$E &#x3D; mc^2$  # LaTeX 公式</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">### 2.5 常用魔法命令</span><br><span class="line"></span><br><span class="line">```python</span><br><span class="line"># 魔法命令（Magic Commands）</span><br><span class="line"></span><br><span class="line"># 时间相关</span><br><span class="line">%timeit result = sum(range(1000))      # 测量执行时间</span><br><span class="line">%time result = sum(range(1000000))     # 单次执行时间</span><br><span class="line"></span><br><span class="line"># 系统命令</span><br><span class="line">!ls -la                                # 执行 shell 命令</span><br><span class="line">!pip install package                   # 安装包</span><br><span class="line">!python script.py                      # 运行 Python 脚本</span><br><span class="line"></span><br><span class="line"># 工作目录</span><br><span class="line">%pwd                                   # 当前目录</span><br><span class="line">%ls                                    # 列出文件</span><br><span class="line">%cd /path/to/dir                       # 切换目录</span><br><span class="line"></span><br><span class="line"># 变量和状态</span><br><span class="line">%who                                   # 显示变量</span><br><span class="line">%whos                                  # 显示变量详情</span><br><span class="line">%env                                   # 显示环境变量</span><br><span class="line"></span><br><span class="line"># 代码执行</span><br><span class="line">%run script.py                         # 运行脚本</span><br><span class="line">%load script.py                        # 加载脚本到单元格</span><br><span class="line">%edit                                  # 打开编辑器</span><br><span class="line"></span><br><span class="line"># 调试</span><br><span class="line">%debug                                 # 进入调试模式</span><br><span class="line">%pdb                                   # 异常时自动调试</span><br><span class="line"></span><br><span class="line"># 其他</span><br><span class="line">%matplotlib inline                     # 内嵌显示 matplotlib 图表</span><br><span class="line">%config InlineBackend.figure_format = &#x27;retina&#x27;  # 高清图表</span><br></pre></td></tr></table></figure>

<h3 id="2-6-数据科学插件"><a href="#2-6-数据科学插件" class="headerlink" title="2.6 数据科学插件"></a>2.6 数据科学插件</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装常用数据科学库</span></span><br><span class="line">pip install numpy pandas matplotlib seaborn scikit-learn jupyter</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置中文字体</span></span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimHei&#x27;</span>, <span class="string">&#x27;Arial Unicode MS&#x27;</span>, <span class="string">&#x27;DejaVu Sans&#x27;</span>]</span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置图表样式</span></span><br><span class="line">sns.set_style(<span class="string">&quot;whitegrid&quot;</span>)</span><br><span class="line">plt.rcParams[<span class="string">&#x27;figure.figsize&#x27;</span>] = (<span class="number">12</span>, <span class="number">8</span>)</span><br></pre></td></tr></table></figure>

<h3 id="2-7-实用技巧"><a href="#2-7-实用技巧" class="headerlink" title="2.7 实用技巧"></a>2.7 实用技巧</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 使用帮助</span></span><br><span class="line">?pd.read_csv           <span class="comment"># 查看函数文档</span></span><br><span class="line">pd.read_csv?           <span class="comment"># 同上</span></span><br><span class="line">??pd.read_csv          <span class="comment"># 查看源码</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 自动补全</span></span><br><span class="line"><span class="comment"># 输入对象名后按 Tab 键</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 对象信息</span></span><br><span class="line"><span class="built_in">dir</span>(<span class="built_in">object</span>)            <span class="comment"># 列出所有属性和方法</span></span><br><span class="line"><span class="built_in">type</span>(<span class="built_in">object</span>)           <span class="comment"># 查看类型</span></span><br><span class="line"><span class="built_in">help</span>(<span class="built_in">object</span>)           <span class="comment"># 查看帮助</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 魔法命令自动补全</span></span><br><span class="line"><span class="comment"># 输入%后按 Tab</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 笔记本书签</span></span><br><span class="line"><span class="comment"># 在 URL 中添加 #cellid=xxx 可以跳转到指定单元格</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 导出为其他格式</span></span><br><span class="line"><span class="comment"># File -&gt; Download as -&gt; PDF/HTML/Python Script</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. 使用模板</span></span><br><span class="line"><span class="comment"># jupyter nbconvert --to slides notebook.ipynb</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 8. 隐藏代码/输出</span></span><br><span class="line"><span class="comment"># 在单元格开头添加：</span></span><br><span class="line"><span class="comment"># %hide_input</span></span><br><span class="line"><span class="comment"># %hide_output</span></span><br></pre></td></tr></table></figure>

<h3 id="2-8-扩展插件"><a href="#2-8-扩展插件" class="headerlink" title="2.8 扩展插件"></a>2.8 扩展插件</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装 Jupyter Notebook 扩展</span></span><br><span class="line">pip install jupyter_contrib_nbextensions</span><br><span class="line">jupyter contrib nbextension install --user</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 JupyterLab 扩展</span></span><br><span class="line">pip install jupyterlab-git</span><br><span class="line">pip install @jupyterlab/toc  <span class="comment"># 目录</span></span><br><span class="line">pip install @jupyterlab/celltags  <span class="comment"># 单元格标签</span></span><br><span class="line">pip install jupyterlab-code-formatter  <span class="comment"># 代码格式化</span></span><br></pre></td></tr></table></figure>

<p><strong>常用扩展：</strong></p>
<ul>
<li>Table of Contents (toc2) - 目录</li>
<li>Code Prettify - 代码格式化</li>
<li>Hide Input&#x2F;Output - 隐藏输入输出</li>
<li>ExecuteTime - 显示执行时间</li>
<li>Variable Inspector - 变量检查器</li>
<li>Spellchecker - 拼写检查</li>
</ul>
<h2 id="三、DataGrip"><a href="#三、DataGrip" class="headerlink" title="三、DataGrip"></a>三、DataGrip</h2><h3 id="3-1-简介与安装"><a href="#3-1-简介与安装" class="headerlink" title="3.1 简介与安装"></a>3.1 简介与安装</h3><p><strong>DataGrip</strong> 是 JetBrains 出品的专业数据库管理工具，支持多种数据库。</p>
<p><strong>支持的数据库：</strong></p>
<ul>
<li>MySQL &#x2F; MariaDB</li>
<li>PostgreSQL</li>
<li>Oracle</li>
<li>SQL Server</li>
<li>SQLite</li>
<li>MongoDB (通过插件)</li>
<li>Redis (通过插件)</li>
<li>以及更多…</li>
</ul>
<p><strong>下载安装：</strong></p>
<ul>
<li>官网：<a href="https://www.jetbrains.com/datagrip/">https://www.jetbrains.com/datagrip/</a></li>
<li>30 天试用，之后需要订阅</li>
<li>学生可免费使用（凭学生证）</li>
</ul>
<h3 id="3-2-创建数据源"><a href="#3-2-创建数据源" class="headerlink" title="3.2 创建数据源"></a>3.2 创建数据源</h3><p><strong>连接 MySQL：</strong></p>
<ol>
<li>打开 DataGrip，点击 <code>File</code> -&gt; <code>New</code> -&gt; <code>Data Source</code> -&gt; <code>MySQL</code></li>
<li>填写连接信息：<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Host: localhost</span><br><span class="line">Port: 3306</span><br><span class="line">User: root</span><br><span class="line">Password: ******</span><br><span class="line">Database: (可选，连接后选择)</span><br></pre></td></tr></table></figure></li>
<li>点击 <code>Test Connection</code> 测试</li>
<li>点击 <code>OK</code> 保存</li>
</ol>
<p><strong>连接 PostgreSQL：</strong></p>
<ol>
<li><code>File</code> -&gt; <code>New</code> -&gt; <code>Data Source</code> -&gt; <code>PostgreSQL</code></li>
<li>填写连接信息：<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Host: localhost</span><br><span class="line">Port: 5432</span><br><span class="line">User: postgres</span><br><span class="line">Password: ******</span><br><span class="line">Database: postgres</span><br></pre></td></tr></table></figure></li>
<li>测试并保存</li>
</ol>
<h3 id="3-3-界面介绍"><a href="#3-3-界面介绍" class="headerlink" title="3.3 界面介绍"></a>3.3 界面介绍</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">左侧：Database 面板（数据库结构树）</span><br><span class="line">中间：SQL 编辑器和结果面板</span><br><span class="line">右侧：工具窗口（Structure, Favorites 等）</span><br><span class="line">底部：Services 面板（数据源列表）</span><br></pre></td></tr></table></figure>

<h3 id="3-4-SQL-编写技巧"><a href="#3-4-SQL-编写技巧" class="headerlink" title="3.4 SQL 编写技巧"></a>3.4 SQL 编写技巧</h3><p><strong>代码补全：</strong></p>
<ul>
<li><code>Ctrl + Space</code> - 基本补全</li>
<li><code>Ctrl + Shift + Space</code> - 智能补全</li>
<li><code>Ctrl + Q</code> - 查看文档</li>
<li><code>Ctrl + B</code> - 跳转到定义</li>
<li><code>Ctrl + Alt + B</code> - 查看实现</li>
</ul>
<p><strong>代码格式化：</strong></p>
<ul>
<li><code>Ctrl + Alt + L</code> - 格式化代码</li>
<li><code>Code</code> -&gt; <code>Reformat Code</code></li>
</ul>
<p><strong>代码模板：</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 输入缩写后按 Tab 键</span></span><br><span class="line"></span><br><span class="line">sel<span class="operator">*</span>     <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span></span><br><span class="line">selt     <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span></span><br><span class="line">ins      <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">INSERT INTO</span></span><br><span class="line">upd      <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">UPDATE</span></span><br><span class="line">del      <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">DELETE</span> <span class="keyword">FROM</span></span><br><span class="line">cre      <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">CREATE TABLE</span></span><br><span class="line">joi      <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">JOIN</span></span><br><span class="line">wh       <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">WHERE</span></span><br><span class="line">gro      <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">ord      <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">hav      <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">HAVING</span></span><br></pre></td></tr></table></figure>

<h3 id="3-5-常用功能"><a href="#3-5-常用功能" class="headerlink" title="3.5 常用功能"></a>3.5 常用功能</h3><p><strong>执行 SQL：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Ctrl + Enter        执行当前语句</span><br><span class="line">Alt + X             执行当前文件</span><br><span class="line">Ctrl + Shift + F10  执行当前语句（带运行配置）</span><br></pre></td></tr></table></figure>

<p><strong>查看数据：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">双击表名          打开表结构</span><br><span class="line">Ctrl + N          在表中查找</span><br><span class="line">F4              查看数据</span><br><span class="line">Ctrl + Shift + F  查找数据</span><br></pre></td></tr></table></figure>

<p><strong>导出导入：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">右键表名 -&gt; Import/Export -&gt; Export Data</span><br><span class="line">支持格式：CSV, Excel, SQL, JSON, XML 等</span><br></pre></td></tr></table></figure>

<p><strong>生成 SQL：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">右键表名 -&gt; SQL Scripts -&gt; DDL</span><br><span class="line">可以选择生成 CREATE/INSERT/UPDATE/DELETE 语句</span><br></pre></td></tr></table></figure>

<h3 id="3-6-版本控制集成"><a href="#3-6-版本控制集成" class="headerlink" title="3.6 版本控制集成"></a>3.6 版本控制集成</h3><p>DataGrip 可以关联 SQL 文件到 Git：</p>
<ol>
<li>创建 <code>db/migrations</code> 目录</li>
<li>将 SQL 脚本放入该目录</li>
<li>DataGrip 会自动识别并关联到 Git</li>
<li>可以像普通代码一样进行版本控制</li>
</ol>
<h3 id="3-7-实用配置"><a href="#3-7-实用配置" class="headerlink" title="3.7 实用配置"></a>3.7 实用配置</h3><p><strong>设置中的推荐配置：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Settings -&gt; Editor -&gt; General -&gt; Appearance</span><br><span class="line">  ✓ Show line numbers          显示行号</span><br><span class="line">  ✓ Show whitespaces           显示空白字符</span><br><span class="line">  ✓ Show intention lightbulb   显示意图灯泡</span><br><span class="line"></span><br><span class="line">Settings -&gt; Editor -&gt; Font</span><br><span class="line">  设置喜欢的字体和大小</span><br><span class="line"></span><br><span class="line">Settings -&gt; Editor -&gt; Color Scheme</span><br><span class="line">  选择喜欢的主题</span><br><span class="line"></span><br><span class="line">Settings -&gt; Database -&gt; SQL Dialects</span><br><span class="line">  设置全局 SQL 方言</span><br><span class="line"></span><br><span class="line">Settings -&gt; Database -&gt; User Parameters</span><br><span class="line">  设置常用参数模板</span><br></pre></td></tr></table></figure>

<h3 id="3-8-快捷键"><a href="#3-8-快捷键" class="headerlink" title="3.8 快捷键"></a>3.8 快捷键</h3><p><strong>Windows&#x2F;Linux：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Ctrl + Space        代码补全</span><br><span class="line">Ctrl + Q          快速文档</span><br><span class="line">Ctrl + B            跳转到定义</span><br><span class="line">Ctrl + Alt + L      格式化代码</span><br><span class="line">Ctrl + /            行注释</span><br><span class="line">Ctrl + Shift + /    块注释</span><br><span class="line">Ctrl + F            查找</span><br><span class="line">Ctrl + R            替换</span><br><span class="line">Ctrl + G            跳转到行</span><br><span class="line">Ctrl + N            查找对象</span><br><span class="line">Ctrl + Shift + N    查找文件</span><br><span class="line">Alt + Enter         显示意图动作</span><br><span class="line">Ctrl + Alt + T      用结构包裹</span><br><span class="line">Ctrl + Shift + F10  运行</span><br><span class="line">Ctrl + Shift + F    查找用法</span><br></pre></td></tr></table></figure>

<p><strong>macOS：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Cmd + Space         代码补全</span><br><span class="line">F1                快速文档</span><br><span class="line">Cmd + B             跳转到定义</span><br><span class="line">Cmd + Alt + L       格式化代码</span><br><span class="line">Cmd + /             行注释</span><br><span class="line">Cmd + Shift + /     块注释</span><br><span class="line">Cmd + F             查找</span><br><span class="line">Cmd + R             替换</span><br><span class="line">Cmd + G             跳转到行</span><br></pre></td></tr></table></figure>

<h3 id="3-9-数据编辑器技巧"><a href="#3-9-数据编辑器技巧" class="headerlink" title="3.9 数据编辑器技巧"></a>3.9 数据编辑器技巧</h3><p><strong>单元格操作：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Enter             编辑单元格</span><br><span class="line">Escape            取消编辑</span><br><span class="line">Ctrl + Enter      提交编辑</span><br><span class="line">Ctrl + Alt + Enter  放弃编辑</span><br><span class="line">Delete            设置为 NULL</span><br><span class="line">Ctrl + D          复制行</span><br><span class="line">Ctrl + Y          删除行</span><br></pre></td></tr></table></figure>

<p><strong>筛选和排序：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">点击列头          排序</span><br><span class="line">右键列头 -&gt; Filter  添加筛选条件</span><br><span class="line">Ctrl + F          在结果中查找</span><br></pre></td></tr></table></figure>

<p><strong>数据导航：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Ctrl + G            跳转到行</span><br><span class="line">Ctrl + Alt + Left   上一页</span><br><span class="line">Ctrl + Alt + Right  下一页</span><br></pre></td></tr></table></figure>

<h2 id="四、工具整合"><a href="#四、工具整合" class="headerlink" title="四、工具整合"></a>四、工具整合</h2><h3 id="4-1-VS-Code-Jupyter"><a href="#4-1-VS-Code-Jupyter" class="headerlink" title="4.1 VS Code + Jupyter"></a>4.1 VS Code + Jupyter</h3><p>在 VS Code 中运行 Jupyter Notebook：</p>
<ol>
<li>安装 <code>Jupyter</code> 和 <code>Python</code> 插件</li>
<li>打开 <code>.ipynb</code> 文件</li>
<li>选择 Python 内核</li>
<li>运行单元格（<code>Shift + Enter</code>）</li>
</ol>
<p><strong>优势：</strong></p>
<ul>
<li>在 VS Code 中编辑 Notebook，享受 VS Code 的所有功能</li>
<li>支持变量查看器、数据查看器</li>
<li>支持交互式窗口</li>
</ul>
<h3 id="4-2-VS-Code-数据库"><a href="#4-2-VS-Code-数据库" class="headerlink" title="4.2 VS Code + 数据库"></a>4.2 VS Code + 数据库</h3><p>在 VS Code 中管理数据库：</p>
<p><strong>安装插件：</strong></p>
<ul>
<li><code>MySQL</code> (Jun Han)</li>
<li><code>PostgreSQL</code> (Microsoft)</li>
<li><code>SQLTools</code> (Matheus Teixeira)</li>
</ul>
<p><strong>使用 SQLTools：</strong></p>
<ol>
<li>安装插件</li>
<li>配置连接</li>
<li>在侧边栏查看数据库结构</li>
<li>执行 SQL 查询</li>
</ol>
<h3 id="4-3-工作流建议"><a href="#4-3-工作流建议" class="headerlink" title="4.3 工作流建议"></a>4.3 工作流建议</h3><p><strong>日常开发：</strong></p>
<ul>
<li><strong>代码编辑</strong>：VS Code</li>
<li><strong>数据分析</strong>：Jupyter Notebook</li>
<li><strong>数据库管理</strong>：DataGrip</li>
</ul>
<p><strong>数据科学项目：</strong></p>
<ol>
<li>用 DataGrip 探索和导出样本数据</li>
<li>用 Jupyter 进行数据探索和建模</li>
<li>用 VS Code 编写生产代码</li>
<li>用 Git 进行版本控制</li>
</ol>
<h2 id="五、最佳实践"><a href="#五、最佳实践" class="headerlink" title="五、最佳实践"></a>五、最佳实践</h2><blockquote>
<p><strong>提醒自己</strong>：</p>
<ol>
<li><strong>善用快捷键</strong>：提高效率，减少鼠标使用</li>
<li><strong>配置同步</strong>：使用 Settings Sync 同步配置</li>
<li><strong>插件适度</strong>：不要安装太多插件，影响性能</li>
<li><strong>定期备份</strong>：Notebook 定期导出备份</li>
<li><strong>代码格式化</strong>：保存时自动格式化</li>
<li><strong>版本控制</strong>：所有代码（包括 SQL）都纳入 Git</li>
<li><strong>敏感信息</strong>：数据库密码等不要硬编码</li>
</ol>
</blockquote>
<h2 id="六、练习"><a href="#六、练习" class="headerlink" title="六、练习"></a>六、练习</h2><ol>
<li>安装 VS Code，配置 Python 开发环境</li>
<li>安装 Jupyter，创建一个数据分析 Notebook</li>
<li>安装 DataGrip，连接本地或远程数据库</li>
<li>在 VS Code 中安装并配置常用插件</li>
<li>配置 Settings Sync，同步开发环境</li>
<li>学习并使用每个工具的快捷键</li>
<li>创建一个包含代码、文本、图表的完整 Notebook</li>
</ol>
<hr>
<p><strong>上一篇</strong>：<a href="/2026/02/24/Git-%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6%E4%B8%8E%E5%9B%A2%E9%98%9F%E5%8D%8F%E4%BD%9C/">Git 版本控制与团队协作</a></p>
<p><strong>系统与工具系列完成！</strong></p>
<p><strong>参考资源</strong>：</p>
<ul>
<li><a href="https://code.visualstudio.com/docs">VS Code 官方文档</a></li>
<li><a href="https://jupyter.org/documentation">Jupyter 官方文档</a></li>
<li><a href="https://www.jetbrains.com/help/datagrip/">DataGrip 官方文档</a></li>
<li><a href="https://code.visualstudio.com/docs/getstarted/keybindings">VS Code 快捷键</a></li>
</ul>
]]></content>
      <categories>
        <category>系统与工具</category>
      </categories>
      <tags>
        <tag>IDE</tag>
        <tag>VS Code</tag>
        <tag>Jupyter</tag>
        <tag>DataGrip</tag>
        <tag>开发工具</tag>
      </tags>
  </entry>
  <entry>
    <title>Markdown 语法教程——如何写博客</title>
    <url>/2026/02/24/Markdown%20%E8%AF%AD%E6%B3%95%E6%95%99%E7%A8%8B%E2%80%94%E2%80%94%E5%A6%82%E4%BD%95%E5%86%99%E5%8D%9A%E5%AE%A2/</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这篇教程是写给我自己的 Markdown 语法备忘录。记录常用的 Markdown 语法和博客配置，方便以后写博客时快速查阅。</p>
<blockquote>
<p><strong>提醒自己</strong>：写博客不是为了追求完美，而是为了记录和分享。不要等到什么都准备好了才开始，先写起来，在写作中不断完善。</p>
</blockquote>
<h2 id="一、Markdown-基础语法"><a href="#一、Markdown-基础语法" class="headerlink" title="一、Markdown 基础语法"></a>一、Markdown 基础语法</h2><h3 id="1-1-标题"><a href="#1-1-标题" class="headerlink" title="1.1 标题"></a>1.1 标题</h3><p>使用 <code>#</code> 符号来定义标题：</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="section"># 一级标题（文章标题，每篇文章只能有一个）</span></span><br><span class="line"><span class="section">## 二级标题（主要章节）</span></span><br><span class="line"><span class="section">### 三级标题（小节）</span></span><br><span class="line"><span class="section">#### 四级标题（细分内容）</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>提醒自己</strong>：</p>
<ul>
<li>文章标题用一级标题，正文中从二级标题开始</li>
<li>标题层级要清晰，不要跳级使用（比如不要从 ## 直接跳到 ####）</li>
<li>每个大章节用 ##，子内容用 ###</li>
</ul>
</blockquote>
<h3 id="1-2-段落与换行"><a href="#1-2-段落与换行" class="headerlink" title="1.2 段落与换行"></a>1.2 段落与换行</h3><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">这是第一段。段落之间要空一行。</span><br><span class="line"></span><br><span class="line">这是第二段。行尾加两个空格可以强制换行。</span><br><span class="line">这是换行后的内容。</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>提醒自己</strong>：</p>
<ul>
<li>段落不要太长，3-5 句一段比较合适</li>
<li>代码教程中，解释和代码示例之间要空行，方便阅读</li>
</ul>
</blockquote>
<h3 id="1-3-文本样式"><a href="#1-3-文本样式" class="headerlink" title="1.3 文本样式"></a>1.3 文本样式</h3><table>
<thead>
<tr>
<th>样式</th>
<th>语法</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>粗体</td>
<td><code>**文本**</code></td>
<td><strong>重要内容</strong></td>
</tr>
<tr>
<td>斜体</td>
<td><code>*文本*</code></td>
<td><em>强调一下</em></td>
</tr>
<tr>
<td>删除线</td>
<td><code>~~文本~~</code></td>
<td><del>过时的内容</del></td>
</tr>
</tbody></table>
<blockquote>
<p><strong>提醒自己</strong>：</p>
<ul>
<li>粗体用于强调<strong>关键概念</strong>和<strong>重要提示</strong></li>
<li>不要滥用粗体，满篇都是重点就没有重点了</li>
<li>斜体可以用来标注<em>英文术语</em>或<em>书名</em></li>
</ul>
</blockquote>
<h3 id="1-4-引用块"><a href="#1-4-引用块" class="headerlink" title="1.4 引用块"></a>1.4 引用块</h3><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="quote">&gt; 这是一级引用</span></span><br><span class="line"><span class="quote">&gt; &gt; 这是嵌套引用</span></span><br><span class="line"><span class="quote">&gt;</span></span><br><span class="line"><span class="quote">&gt; 这是引用的另一段</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>提醒自己</strong>：引用块适合用于：</p>
<ul>
<li>引用官方文档的原文</li>
<li>标注注意事项</li>
<li>记录他人的观点</li>
</ul>
</blockquote>
<h2 id="二、列表的使用"><a href="#二、列表的使用" class="headerlink" title="二、列表的使用"></a>二、列表的使用</h2><h3 id="2-1-无序列表"><a href="#2-1-无序列表" class="headerlink" title="2.1 无序列表"></a>2.1 无序列表</h3><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> 项目 1</span><br><span class="line"><span class="bullet">-</span> 项目 2</span><br><span class="line"><span class="bullet">  -</span> 子项目（前面加两个空格）</span><br><span class="line"><span class="bullet">  -</span> 子项目</span><br><span class="line"><span class="bullet">-</span> 项目 3</span><br></pre></td></tr></table></figure>

<h3 id="2-2-有序列表"><a href="#2-2-有序列表" class="headerlink" title="2.2 有序列表"></a>2.2 有序列表</h3><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="bullet">1.</span> 第一步</span><br><span class="line"><span class="bullet">2.</span> 第二步</span><br><span class="line"><span class="bullet">3.</span> 第三步</span><br></pre></td></tr></table></figure>

<h3 id="2-3-任务列表"><a href="#2-3-任务列表" class="headerlink" title="2.3 任务列表"></a>2.3 任务列表</h3><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> [x] 已完成</span><br><span class="line"><span class="bullet">-</span> [ ] 待完成</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>提醒自己</strong>：</p>
<ul>
<li>并列的内容用无序列表</li>
<li>有顺序的步骤用有序列表（比如教程的操作步骤）</li>
<li>任务列表可以用来做 TODO 清单</li>
</ul>
</blockquote>
<h2 id="三、代码展示"><a href="#三、代码展示" class="headerlink" title="三、代码展示"></a>三、代码展示</h2><h3 id="3-1-行内代码"><a href="#3-1-行内代码" class="headerlink" title="3.1 行内代码"></a>3.1 行内代码</h3><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">使用 <span class="code">`console.log()`</span> 输出，使用 <span class="code">`print()`</span> 打印。</span><br></pre></td></tr></table></figure>

<p>效果：使用 <code>console.log()</code> 输出，使用 <code>print()</code> 打印。</p>
<h3 id="3-2-代码块"><a href="#3-2-代码块" class="headerlink" title="3.2 代码块"></a>3.2 代码块</h3><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="code">```语言名称</span></span><br><span class="line"><span class="code">代码内容</span></span><br><span class="line"><span class="code">```</span></span><br></pre></td></tr></table></figure>

<p>支持的语言：<code>javascript</code>、<code>python</code>、<code>sql</code>、<code>java</code>、<code>cpp</code>、<code>html</code>、<code>css</code>、<code>json</code>、<code>yaml</code> 等。</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="code">```javascript</span></span><br><span class="line"><span class="code">// JavaScript 示例</span></span><br><span class="line"><span class="code">function sayHello() &#123;</span></span><br><span class="line"><span class="code">    console.log(&quot;Hello!&quot;);</span></span><br><span class="line"><span class="code">&#125;</span></span><br><span class="line"><span class="code">```</span></span><br><span class="line"></span><br><span class="line"><span class="code">```python</span></span><br><span class="line"><span class="code"># Python 示例</span></span><br><span class="line"><span class="code">def say_hello():</span></span><br><span class="line"><span class="code">    print(&quot;Hello!&quot;)</span></span><br><span class="line"><span class="code">```</span></span><br><span class="line"></span><br><span class="line"><span class="code">```sql</span></span><br><span class="line"><span class="code">-- SQL 示例</span></span><br><span class="line"><span class="code">SELECT * FROM users WHERE id = 1;</span></span><br><span class="line"><span class="code">```</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>提醒自己</strong>：</p>
<ul>
<li>代码块一定要标注语言，这样才有语法高亮</li>
<li>代码示例要简洁，只展示关键部分</li>
<li>复杂的代码要加注释说明</li>
<li>SQL 代码用 <code>sql</code>，不要用 <code>mysql</code>（可能不支持）</li>
</ul>
</blockquote>
<h2 id="四、链接与图片"><a href="#四、链接与图片" class="headerlink" title="四、链接与图片"></a>四、链接与图片</h2><h3 id="4-1-链接"><a href="#4-1-链接" class="headerlink" title="4.1 链接"></a>4.1 链接</h3><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">[<span class="string">显示文字</span>](<span class="link">https://www.example.com</span>)</span><br><span class="line">[<span class="string">带标题</span>](<span class="link">https://www.example.com &quot;鼠标悬停显示的标题&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="4-2-图片"><a href="#4-2-图片" class="headerlink" title="4.2 图片"></a>4.2 图片</h3><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">![<span class="string">替代文字</span>](<span class="link">图片路径</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>提醒自己</strong>：</p>
<ul>
<li>图片放在 <code>source/img/</code> 目录下</li>
<li>引用时使用 <code>/img/图片名.jpg</code></li>
<li>替代文字要描述图片内容，方便 SEO</li>
<li>图片不要太大，影响加载速度</li>
<li>教程中的截图要清晰，关键部分可以用红框标注</li>
</ul>
</blockquote>
<h2 id="五、表格"><a href="#五、表格" class="headerlink" title="五、表格"></a>五、表格</h2><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">| 表头 1 | 表头 2 | 表头 3 |</span><br><span class="line">|--------|--------|--------|</span><br><span class="line">| 内容 1 | 内容 2 | 内容 3 |</span><br></pre></td></tr></table></figure>

<p>效果：</p>
<table>
<thead>
<tr>
<th>表头 1</th>
<th>表头 2</th>
<th>表头 3</th>
</tr>
</thead>
<tbody><tr>
<td>内容 1</td>
<td>内容 2</td>
<td>内容 3</td>
</tr>
</tbody></table>
<h3 id="表格对齐"><a href="#表格对齐" class="headerlink" title="表格对齐"></a>表格对齐</h3><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">| 左对齐 | 居中 | 右对齐 |</span><br><span class="line">|:-------|:----:|-------:|</span><br><span class="line">| 内容 | 内容 | 内容 |</span><br></pre></td></tr></table></figure>

<p>效果：</p>
<table>
<thead>
<tr>
<th align="left">左对齐</th>
<th align="center">居中</th>
<th align="right">右对齐</th>
</tr>
</thead>
<tbody><tr>
<td align="left">内容</td>
<td align="center">内容</td>
<td align="right">内容</td>
</tr>
</tbody></table>
<blockquote>
<p><strong>提醒自己</strong>：</p>
<ul>
<li>表格适合对比多个项目的属性</li>
<li>教程中可以用表格总结知识点</li>
<li>表格不要太复杂，列数控制在 5 列以内</li>
</ul>
</blockquote>
<h2 id="六、Hexo-博客配置"><a href="#六、Hexo-博客配置" class="headerlink" title="六、Hexo 博客配置"></a>六、Hexo 博客配置</h2><h3 id="6-1-Front-Matter（文章头部配置）"><a href="#6-1-Front-Matter（文章头部配置）" class="headerlink" title="6.1 Front Matter（文章头部配置）"></a>6.1 Front Matter（文章头部配置）</h3><p>每篇文章开头必须有这个：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">title:</span> <span class="string">文章标题</span></span><br><span class="line"><span class="attr">date:</span> <span class="number">2026-02-24 10:00:00</span></span><br><span class="line"><span class="attr">categories:</span> <span class="string">分类名称</span></span><br><span class="line"><span class="attr">tags:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">标签</span> <span class="number">1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">标签</span> <span class="number">2</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-常用配置字段"><a href="#6-2-常用配置字段" class="headerlink" title="6.2 常用配置字段"></a>6.2 常用配置字段</h3><table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>title</code></td>
<td>文章标题</td>
<td><code>title: MySQL 教程</code></td>
</tr>
<tr>
<td><code>date</code></td>
<td>发布时间</td>
<td><code>date: 2026-02-24 10:00:00</code></td>
</tr>
<tr>
<td><code>categories</code></td>
<td>分类</td>
<td><code>categories: 技术教程</code></td>
</tr>
<tr>
<td><code>tags</code></td>
<td>标签（多个）</td>
<td><code>tags: [MySQL, 数据库]</code></td>
</tr>
<tr>
<td><code>top</code></td>
<td>置顶（数字越大越靠前）</td>
<td><code>top: 100</code></td>
</tr>
<tr>
<td><code>cover</code></td>
<td>封面图</td>
<td><code>cover: /img/cover.jpg</code></td>
</tr>
</tbody></table>
<blockquote>
<p><strong>提醒自己</strong>：</p>
<ul>
<li><code>categories</code> 用现有的分类，保持一致性</li>
<li><code>tags</code> 可以多个，用短横线开头</li>
<li>系列教程要统一分类名称</li>
<li>重要文章可以设置 <code>top</code> 置顶</li>
</ul>
</blockquote>
<h3 id="6-3-常用命令"><a href="#6-3-常用命令" class="headerlink" title="6.3 常用命令"></a>6.3 常用命令</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建新文章</span></span><br><span class="line">hexo new post <span class="string">&quot;文章标题&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动本地服务器预览</span></span><br><span class="line">hexo server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成静态文件</span></span><br><span class="line">hexo generate</span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署到 GitHub</span></span><br><span class="line">hexo deploy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者直接生成 + 部署</span></span><br><span class="line">hexo g -d</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>提醒自己</strong>：</p>
<ul>
<li>发布前一定要 <code>hexo server</code> 本地预览一下</li>
<li>检查有没有格式问题、图片是否能正常显示</li>
<li>部署命令是 <code>hexo g -d</code>（generate + deploy）</li>
</ul>
</blockquote>
<h2 id="七、写作流程提醒"><a href="#七、写作流程提醒" class="headerlink" title="七、写作流程提醒"></a>七、写作流程提醒</h2><h3 id="7-1-写作前"><a href="#7-1-写作前" class="headerlink" title="7.1 写作前"></a>7.1 写作前</h3><ul>
<li><input disabled="" type="checkbox"> 确定文章主题和分类</li>
<li><input disabled="" type="checkbox"> 想好文章结构（可以用大纲）</li>
<li><input disabled="" type="checkbox"> 准备好需要用到的图片素材</li>
</ul>
<h3 id="7-2-写作中"><a href="#7-2-写作中" class="headerlink" title="7.2 写作中"></a>7.2 写作中</h3><ul>
<li><input disabled="" type="checkbox"> 先写内容，不要纠结格式</li>
<li><input disabled="" type="checkbox"> 用标题划分章节</li>
<li><input disabled="" type="checkbox"> 代码示例要测试过再贴上去</li>
<li><input disabled="" type="checkbox"> 关键步骤要解释清楚</li>
</ul>
<h3 id="7-3-发布前检查清单"><a href="#7-3-发布前检查清单" class="headerlink" title="7.3 发布前检查清单"></a>7.3 发布前检查清单</h3><ul>
<li><input disabled="" type="checkbox"> 标题有没有错别字</li>
<li><input disabled="" type="checkbox"> Front Matter 配置是否正确（分类、标签）</li>
<li><input disabled="" type="checkbox"> 代码块有没有标注语言</li>
<li><input disabled="" type="checkbox"> 图片路径是否正确，能否正常显示</li>
<li><input disabled="" type="checkbox"> 本地预览效果是否正常</li>
<li><input disabled="" type="checkbox"> 有没有明显的错别字或语病</li>
</ul>
<blockquote>
<p><strong>提醒自己</strong>：</p>
<ul>
<li>不要追求完美，完成比完美重要</li>
<li>文章可以后续修改，先发布再说</li>
<li>读者的反馈会帮助你改进</li>
</ul>
</blockquote>
<h2 id="八、Butterfly-主题特有功能"><a href="#八、Butterfly-主题特有功能" class="headerlink" title="八、Butterfly 主题特有功能"></a>八、Butterfly 主题特有功能</h2><h3 id="8-1-笔记块（Notes）"><a href="#8-1-笔记块（Notes）" class="headerlink" title="8.1 笔记块（Notes）"></a>8.1 笔记块（Notes）</h3><p>Butterfly 主题支持笔记块：</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">&#123;% note [class] %&#125;</span><br><span class="line">笔记内容</span><br><span class="line">&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure>

<p>class 可以是：<code>default</code>、<code>primary</code>、<code>info</code>、<code>success</code>、<code>warning</code>、<code>danger</code></p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">&#123;% note warning %&#125;</span><br><span class="line">这是一个警告提示！</span><br><span class="line">&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>提醒自己</strong>：笔记块适合用于：</p>
<ul>
<li>标注注意事项</li>
<li>强调重要内容</li>
<li>添加补充说明</li>
</ul>
</blockquote>
<h3 id="8-2-标签页"><a href="#8-2-标签页" class="headerlink" title="8.2 标签页"></a>8.2 标签页</h3><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">&#123;% tabs UniqueID %&#125;</span><br><span class="line">&#123;% tab 标签名 1 %&#125;</span><br><span class="line">内容 1</span><br><span class="line">&#123;% endtab %&#125;</span><br><span class="line">&#123;% tab 标签名 2 %&#125;</span><br><span class="line">内容 2</span><br><span class="line">&#123;% endtab %&#125;</span><br><span class="line">&#123;% endtabs %&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>提醒自己</strong>：标签页适合展示同一内容的不同版本（比如不同语言的代码实现）</p>
</blockquote>
<h2 id="九、常见错误与解决方法"><a href="#九、常见错误与解决方法" class="headerlink" title="九、常见错误与解决方法"></a>九、常见错误与解决方法</h2><table>
<thead>
<tr>
<th>问题</th>
<th>可能原因</th>
<th>解决方法</th>
</tr>
</thead>
<tbody><tr>
<td>文章不显示</td>
<td>Front Matter 格式错误</td>
<td>检查 <code>---</code> 是否成对，YAML 格式是否正确</td>
</tr>
<tr>
<td>图片不显示</td>
<td>路径错误</td>
<td>图片放在 <code>source/img/</code>，引用用 <code>/img/xxx</code></td>
</tr>
<tr>
<td>代码没有高亮</td>
<td>没标注语言</td>
<td>在 ``` 后面加上语言名称</td>
</tr>
<tr>
<td>分类&#x2F;标签不显示</td>
<td>拼写不一致</td>
<td>保持分类&#x2F;标签名称一致，注意大小写</td>
</tr>
<tr>
<td>本地预览正常，部署后异常</td>
<td>缓存问题</td>
<td>执行 <code>hexo clean &amp;&amp; hexo g -d</code></td>
</tr>
</tbody></table>
<h2 id="十、总结"><a href="#十、总结" class="headerlink" title="十、总结"></a>十、总结</h2><h3 id="核心语法（必须掌握）"><a href="#核心语法（必须掌握）" class="headerlink" title="核心语法（必须掌握）"></a>核心语法（必须掌握）</h3><ul>
<li>标题 <code>#</code></li>
<li>段落（空行分隔）</li>
<li>粗体 <code>**</code></li>
<li>列表 <code>-</code> 和 <code>1.</code></li>
<li>代码块 ```</li>
<li>链接 <code>[]()</code></li>
<li>图片 <code>![]()</code></li>
</ul>
<h3 id="写给自己的话"><a href="#写给自己的话" class="headerlink" title="写给自己的话"></a>写给自己的话</h3><blockquote>
<p><strong>记住</strong>：</p>
<ol>
<li>写作是一个思考的过程，不要等想清楚了再写，写本身就是思考</li>
<li>第一篇总是最难写的，写下去就好了</li>
<li>文章不需要完美，只要能帮助到别人（包括未来的自己）就有价值</li>
<li>持续更新比单篇质量更重要</li>
<li>读者的反馈是改进的动力</li>
</ol>
</blockquote>
<hr>
<p><strong>参考资源</strong>：</p>
<ul>
<li><a href="https://daringfireball.net/projects/markdown/">Markdown 官方文档</a></li>
<li><a href="https://www.markdownguide.org/">Markdown Guide</a></li>
<li><a href="https://hexo.io/zh-cn/">Hexo 官方文档</a></li>
<li><a href="https://butterfly.js.org/">Butterfly 主题文档</a></li>
</ul>
]]></content>
      <categories>
        <category>技术教程</category>
      </categories>
      <tags>
        <tag>Markdown</tag>
        <tag>博客写作</tag>
        <tag>入门教程</tag>
        <tag>个人笔记</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 基础教程（一）数据库基础与环境搭建</title>
    <url>/2026/02/23/MySQL%20%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B%EF%BC%88%E4%B8%80%EF%BC%89%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80%E4%B8%8E%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/</url>
    <content><![CDATA[<h1 id="MySQL-基础教程（一）数据库基础与环境搭建"><a href="#MySQL-基础教程（一）数据库基础与环境搭建" class="headerlink" title="MySQL 基础教程（一）数据库基础与环境搭建"></a>MySQL 基础教程（一）数据库基础与环境搭建</h1><p>欢迎来到 MySQL 基础教程系列的第一篇！在本篇文章中，我们将从零开始了解数据库的基本概念，完成 MySQL 的安装配置，并了解数据模型和 SQL 的分类。</p>
<h2 id="一、数据库相关概念"><a href="#一、数据库相关概念" class="headerlink" title="一、数据库相关概念"></a>一、数据库相关概念</h2><h3 id="1-1-什么是数据库？"><a href="#1-1-什么是数据库？" class="headerlink" title="1.1 什么是数据库？"></a>1.1 什么是数据库？</h3><p><strong>数据库（Database）</strong> 是按照数据结构来组织、存储和管理数据的仓库。它可以持久化存储数据，并且支持高效的数据访问和管理。</p>
<p>简单来说，数据库就是一个<strong>电子化的文件柜</strong>，用于存储和管理数据。</p>
<h3 id="1-2-什么是-DBMS？"><a href="#1-2-什么是-DBMS？" class="headerlink" title="1.2 什么是 DBMS？"></a>1.2 什么是 DBMS？</h3><p><strong>DBMS（Database Management System，数据库管理系统）</strong> 是用于创建、管理和维护数据库的软件。</p>
<p>常见的 DBMS 有：</p>
<ul>
<li><strong>MySQL</strong>：开源、轻量、流行，适合中小型项目</li>
<li><strong>Oracle</strong>：功能强大、性能优异，适合大型企业</li>
<li><strong>SQL Server</strong>：微软出品，与 Windows 生态集成良好</li>
<li><strong>PostgreSQL</strong>：开源、功能丰富，支持复杂查询</li>
<li><strong>SQLite</strong>：嵌入式数据库，适合移动端和小型应用</li>
</ul>
<h3 id="1-3-数据库的优势"><a href="#1-3-数据库的优势" class="headerlink" title="1.3 数据库的优势"></a>1.3 数据库的优势</h3><table>
<thead>
<tr>
<th>对比项</th>
<th>文件系统</th>
<th>数据库系统</th>
</tr>
</thead>
<tbody><tr>
<td>数据结构</td>
<td>松散，由应用程序定义</td>
<td>结构化，由 DBMS 统一管理</td>
</tr>
<tr>
<td>数据共享</td>
<td>差，数据孤立</td>
<td>好，多用户共享</td>
</tr>
<tr>
<td>数据冗余</td>
<td>高，容易重复</td>
<td>低，减少冗余</td>
</tr>
<tr>
<td>数据一致性</td>
<td>难保证</td>
<td>容易保证</td>
</tr>
<tr>
<td>数据独立性</td>
<td>差，依赖程序</td>
<td>好，独立于程序</td>
</tr>
<tr>
<td>并发访问</td>
<td>难处理</td>
<td>支持良好</td>
</tr>
</tbody></table>
<h3 id="1-4-什么是-SQL？"><a href="#1-4-什么是-SQL？" class="headerlink" title="1.4 什么是 SQL？"></a>1.4 什么是 SQL？</h3><p><strong>SQL（Structured Query Language，结构化查询语言）</strong> 是用于访问和处理数据库的标准计算机语言。</p>
<p>SQL 的主要功能：</p>
<ul>
<li>查询数据</li>
<li>插入、更新、删除数据</li>
<li>创建、修改、删除数据库对象</li>
<li>设置访问权限</li>
</ul>
<h2 id="二、MySQL-简介"><a href="#二、MySQL-简介" class="headerlink" title="二、MySQL 简介"></a>二、MySQL 简介</h2><h3 id="2-1-MySQL-的特点"><a href="#2-1-MySQL-的特点" class="headerlink" title="2.1 MySQL 的特点"></a>2.1 MySQL 的特点</h3><ul>
<li><strong>开源免费</strong>：社区版完全免费</li>
<li><strong>跨平台</strong>：支持 Windows、Linux、macOS 等</li>
<li><strong>高性能</strong>：查询速度快，支持大量并发</li>
<li><strong>易用性</strong>：安装简单，学习成本低</li>
<li><strong>生态完善</strong>：有丰富的图形化工具和驱动支持</li>
</ul>
<h3 id="2-2-MySQL-版本选择"><a href="#2-2-MySQL-版本选择" class="headerlink" title="2.2 MySQL 版本选择"></a>2.2 MySQL 版本选择</h3><ul>
<li><strong>MySQL Community Server</strong>：社区版，免费，适合学习和个人项目</li>
<li><strong>MySQL Enterprise Server</strong>：企业版，收费，提供高级功能和技术支持</li>
<li><strong>MySQL Cluster</strong>：集群版，适合高可用场景</li>
</ul>
<p><strong>建议初学者使用 MySQL 8.0 社区版</strong>。</p>
<h2 id="三、MySQL-安装与配置（Windows）"><a href="#三、MySQL-安装与配置（Windows）" class="headerlink" title="三、MySQL 安装与配置（Windows）"></a>三、MySQL 安装与配置（Windows）</h2><h3 id="3-1-下载安装包"><a href="#3-1-下载安装包" class="headerlink" title="3.1 下载安装包"></a>3.1 下载安装包</h3><ol>
<li>访问 MySQL 官网：<a href="https://dev.mysql.com/downloads/mysql/">https://dev.mysql.com/downloads/mysql/</a></li>
<li>选择对应操作系统的版本</li>
<li>下载 MySQL Installer（推荐）或 Zip Archive</li>
</ol>
<h3 id="3-2-使用-Installer-安装（推荐）"><a href="#3-2-使用-Installer-安装（推荐）" class="headerlink" title="3.2 使用 Installer 安装（推荐）"></a>3.2 使用 Installer 安装（推荐）</h3><ol>
<li>运行 <code>mysql-installer-community-8.0.x.msi</code></li>
<li>选择安装类型：<ul>
<li><strong>Developer Default</strong>：开发默认（推荐）</li>
<li><strong>Server only</strong>：仅服务器</li>
<li><strong>Client only</strong>：仅客户端</li>
<li><strong>Full</strong>：完全安装</li>
</ul>
</li>
<li>设置 root 密码（<strong>重要！请务必记住</strong>）</li>
<li>配置 MySQL 服务：<ul>
<li>服务名：<code>MySQL80</code></li>
<li>端口：<code>3306</code>（默认）</li>
</ul>
</li>
<li>完成安装</li>
</ol>
<h3 id="3-3-使用-Zip-Archive-手动安装"><a href="#3-3-使用-Zip-Archive-手动安装" class="headerlink" title="3.3 使用 Zip Archive 手动安装"></a>3.3 使用 Zip Archive 手动安装</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 解压到指定目录，如 C:\mysql</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 创建配置文件 my.ini</span></span><br><span class="line">[mysqld]</span><br><span class="line">port=3306</span><br><span class="line">basedir=C:\mysql</span><br><span class="line">datadir=C:\mysql\data</span><br><span class="line">max_connections=200</span><br><span class="line">character-set-server=utf8mb4</span><br><span class="line">default-storage-engine=INNODB</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">default-character-set=utf8mb4</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line">port=3306</span><br><span class="line">default-character-set=utf8mb4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 初始化数据库（使用管理员权限运行 CMD）</span></span><br><span class="line"><span class="built_in">cd</span> C:\mysql\bin</span><br><span class="line">mysqld --initialize-insecure --console</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 安装服务</span></span><br><span class="line">mysqld --install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 启动服务</span></span><br><span class="line">net start mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 首次登录（无密码）</span></span><br><span class="line">mysql -u root -p</span><br><span class="line"><span class="comment"># 直接回车即可</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. 修改 root 密码</span></span><br><span class="line">ALTER USER <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED BY <span class="string">&#x27;你的密码&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-4-验证安装"><a href="#3-4-验证安装" class="headerlink" title="3.4 验证安装"></a>3.4 验证安装</h3><p>打开命令行，执行以下命令验证 MySQL 是否正常运行：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看 MySQL 服务状态</span></span><br><span class="line">net start | findstr MySQL</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录 MySQL</span></span><br><span class="line">mysql -u root -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看版本</span></span><br><span class="line">mysql --version</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 MySQL 中查看数据库</span></span><br><span class="line">SHOW DATABASES;</span><br></pre></td></tr></table></figure>

<h3 id="3-5-常用服务命令"><a href="#3-5-常用服务命令" class="headerlink" title="3.5 常用服务命令"></a>3.5 常用服务命令</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Windows 服务命令</span></span><br><span class="line">net start mysql80      <span class="comment"># 启动服务</span></span><br><span class="line">net stop mysql80       <span class="comment"># 停止服务</span></span><br><span class="line">net restart mysql80    <span class="comment"># 重启服务</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux 服务命令</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl start mysql</span><br><span class="line"><span class="built_in">sudo</span> systemctl stop mysql</span><br><span class="line"><span class="built_in">sudo</span> systemctl restart mysql</span><br><span class="line"><span class="built_in">sudo</span> systemctl status mysql</span><br></pre></td></tr></table></figure>

<h2 id="四、数据模型"><a href="#四、数据模型" class="headerlink" title="四、数据模型"></a>四、数据模型</h2><h3 id="4-1-什么是数据模型？"><a href="#4-1-什么是数据模型？" class="headerlink" title="4.1 什么是数据模型？"></a>4.1 什么是数据模型？</h3><p><strong>数据模型</strong> 是对现实世界数据的抽象描述，它定义了数据的结构、操作和约束。</p>
<h3 id="4-2-关系模型"><a href="#4-2-关系模型" class="headerlink" title="4.2 关系模型"></a>4.2 关系模型</h3><p>MySQL 使用的是<strong>关系模型</strong>，主要概念包括：</p>
<table>
<thead>
<tr>
<th>概念</th>
<th>说明</th>
<th>对应表结构</th>
</tr>
</thead>
<tbody><tr>
<td>表（Table）</td>
<td>数据的集合</td>
<td>一张二维表</td>
</tr>
<tr>
<td>行（Row）</td>
<td>一条记录</td>
<td>表中的一行数据</td>
</tr>
<tr>
<td>列（Column）</td>
<td>一个字段</td>
<td>表中的一列</td>
</tr>
<tr>
<td>主键（Primary Key）</td>
<td>唯一标识一条记录</td>
<td>不能重复，不能为空</td>
</tr>
<tr>
<td>外键（Foreign Key）</td>
<td>关联其他表的主键</td>
<td>建立表与表之间的关系</td>
</tr>
</tbody></table>
<h3 id="4-3-ER-图（实体-关系图）"><a href="#4-3-ER-图（实体-关系图）" class="headerlink" title="4.3 ER 图（实体 - 关系图）"></a>4.3 ER 图（实体 - 关系图）</h3><p>ER 图用于描述实体之间的关系，基本元素：</p>
<ul>
<li><strong>矩形</strong>：表示实体（如：学生、课程）</li>
<li><strong>椭圆</strong>：表示属性（如：姓名、学号）</li>
<li><strong>菱形</strong>：表示关系（如：选课）</li>
<li><strong>连线</strong>：连接各元素，标注关系类型</li>
</ul>
<h3 id="4-4-关系的类型"><a href="#4-4-关系的类型" class="headerlink" title="4.4 关系的类型"></a>4.4 关系的类型</h3><ol>
<li><strong>一对一（1:1）</strong>：一个学生对应一个身份证号码</li>
<li><strong>一对多（1:N）</strong>：一个部门有多名员工</li>
<li><strong>多对多（N:M）</strong>：学生可以选多门课，一门课可以被多个学生选</li>
</ol>
<h3 id="4-5-数据库范式"><a href="#4-5-数据库范式" class="headerlink" title="4.5 数据库范式"></a>4.5 数据库范式</h3><p>范式是设计数据库时遵循的规范，目的是减少数据冗余，提高数据一致性。</p>
<p><strong>第一范式（1NF）</strong>：每个列都不可再分</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">错误示例：</span><br><span class="line">| 姓名 | 联系方式          |</span><br><span class="line">|------|-------------------|</span><br><span class="line">| 张三 | 手机：138xxx; 固话：010xxx |</span><br><span class="line"></span><br><span class="line">正确示例：</span><br><span class="line">| 姓名 | 手机号  | 固话    |</span><br><span class="line">|------|--------|---------|</span><br><span class="line">| 张三 | 138xxx | 010xxx  |</span><br></pre></td></tr></table></figure>

<p><strong>第二范式（2NF）</strong>：在 1NF 基础上，非主键字段完全依赖于主键</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">错误示例（主键为学号 + 课程）：</span><br><span class="line">| 学号 | 课程 | 学生姓名 | 成绩 |</span><br><span class="line">|------|------|----------|------|</span><br><span class="line">| 001  | 数学 | 张三     | 90   |</span><br><span class="line"></span><br><span class="line">问题：学生姓名只依赖于学号，与课程无关</span><br><span class="line"></span><br><span class="line">正确示例（拆分为两张表）：</span><br><span class="line">学生表：| 学号 | 学生姓名 |</span><br><span class="line">成绩表：| 学号 | 课程 | 成绩 |</span><br></pre></td></tr></table></figure>

<p><strong>第三范式（3NF）</strong>：在 2NF 基础上，非主键字段之间不能相互依赖</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">错误示例：</span><br><span class="line">| 学号 | 姓名 | 系名 | 系主任 |</span><br><span class="line">|------|------|------|--------|</span><br><span class="line">| 001  | 张三 | 计算机系 | 李四 |</span><br><span class="line"></span><br><span class="line">问题：系主任依赖于系名，而不是学号</span><br><span class="line"></span><br><span class="line">正确示例（拆分）：</span><br><span class="line">学生表：| 学号 | 姓名 | 系名 |</span><br><span class="line">系表：  | 系名 | 系主任 |</span><br></pre></td></tr></table></figure>

<h2 id="五、SQL-语法及分类"><a href="#五、SQL-语法及分类" class="headerlink" title="五、SQL 语法及分类"></a>五、SQL 语法及分类</h2><h3 id="5-1-SQL-通用语法"><a href="#5-1-SQL-通用语法" class="headerlink" title="5.1 SQL 通用语法"></a>5.1 SQL 通用语法</h3><ol>
<li><strong>语句以分号结尾</strong></li>
</ol>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> students;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>不区分大小写</strong>（推荐关键字大写，表名、列名小写）</li>
</ol>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> students;  <span class="comment">-- 合法</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> students;  <span class="comment">-- 推荐</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li><strong>注释</strong></li>
</ol>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 单行注释</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 多行注释 */</span></span><br><span class="line"></span><br><span class="line"># MySQL 特有的单行注释</span><br></pre></td></tr></table></figure>

<ol start="4">
<li><strong>字符串使用单引号或双引号</strong></li>
</ol>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;Hello&#x27;</span>, &quot;World&quot;;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-SQL-的分类"><a href="#5-2-SQL-的分类" class="headerlink" title="5.2 SQL 的分类"></a>5.2 SQL 的分类</h3><p>SQL 语言分为四大类：</p>
<h4 id="1-DDL（Data-Definition-Language，数据定义语言）"><a href="#1-DDL（Data-Definition-Language，数据定义语言）" class="headerlink" title="1. DDL（Data Definition Language，数据定义语言）"></a>1. DDL（Data Definition Language，数据定义语言）</h4><p>用于定义和管理数据库对象（库、表、索引等）。</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>功能</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>CREATE</td>
<td>创建对象</td>
<td><code>CREATE DATABASE db_name;</code></td>
</tr>
<tr>
<td>ALTER</td>
<td>修改对象</td>
<td><code>ALTER TABLE tb_name ADD COLUMN ...;</code></td>
</tr>
<tr>
<td>DROP</td>
<td>删除对象</td>
<td><code>DROP TABLE tb_name;</code></td>
</tr>
<tr>
<td>TRUNCATE</td>
<td>清空表</td>
<td><code>TRUNCATE TABLE tb_name;</code></td>
</tr>
<tr>
<td>RENAME</td>
<td>重命名</td>
<td><code>RENAME TABLE old TO new;</code></td>
</tr>
</tbody></table>
<h4 id="2-DML（Data-Manipulation-Language，数据操作语言）"><a href="#2-DML（Data-Manipulation-Language，数据操作语言）" class="headerlink" title="2. DML（Data Manipulation Language，数据操作语言）"></a>2. DML（Data Manipulation Language，数据操作语言）</h4><p>用于对表中数据进行增删改操作。</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>功能</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>INSERT</td>
<td>插入数据</td>
<td><code>INSERT INTO tb VALUES (...);</code></td>
</tr>
<tr>
<td>UPDATE</td>
<td>更新数据</td>
<td><code>UPDATE tb SET col=val WHERE ...;</code></td>
</tr>
<tr>
<td>DELETE</td>
<td>删除数据</td>
<td><code>DELETE FROM tb WHERE ...;</code></td>
</tr>
</tbody></table>
<h4 id="3-DQL（Data-Query-Language，数据查询语言）"><a href="#3-DQL（Data-Query-Language，数据查询语言）" class="headerlink" title="3. DQL（Data Query Language，数据查询语言）"></a>3. DQL（Data Query Language，数据查询语言）</h4><p>用于查询数据。</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>功能</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>SELECT</td>
<td>查询数据</td>
<td><code>SELECT * FROM tb;</code></td>
</tr>
</tbody></table>
<p>DQL 是 SQL 中使用频率最高的部分，包含：</p>
<ul>
<li>基础查询</li>
<li>条件查询</li>
<li>聚合函数</li>
<li>分组查询</li>
<li>排序查询</li>
<li>分页查询</li>
<li>多表连接查询</li>
</ul>
<h4 id="4-DCL（Data-Control-Language，数据控制语言）"><a href="#4-DCL（Data-Control-Language，数据控制语言）" class="headerlink" title="4. DCL（Data Control Language，数据控制语言）"></a>4. DCL（Data Control Language，数据控制语言）</h4><p>用于管理数据库权限和事务控制。</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>功能</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>GRANT</td>
<td>授权</td>
<td><code>GRANT SELECT ON db.* TO user;</code></td>
</tr>
<tr>
<td>REVOKE</td>
<td>撤销权限</td>
<td><code>REVOKE SELECT ON db.* FROM user;</code></td>
</tr>
<tr>
<td>COMMIT</td>
<td>提交事务</td>
<td><code>COMMIT;</code></td>
</tr>
<tr>
<td>ROLLBACK</td>
<td>回滚事务</td>
<td><code>ROLLBACK;</code></td>
</tr>
</tbody></table>
<h3 id="5-3-SQL-执行顺序概览"><a href="#5-3-SQL-执行顺序概览" class="headerlink" title="5.3 SQL 执行顺序概览"></a>5.3 SQL 执行顺序概览</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">FROM → WHERE → GROUP BY → HAVING → SELECT → ORDER BY → LIMIT</span><br></pre></td></tr></table></figure>

<p>这个执行顺序将在 DQL 章节详细讲解。</p>
<h2 id="六、第一个-SQL-示例"><a href="#六、第一个-SQL-示例" class="headerlink" title="六、第一个 SQL 示例"></a>六、第一个 SQL 示例</h2><p>登录 MySQL 后，尝试以下命令：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看所有数据库</span></span><br><span class="line"><span class="keyword">SHOW</span> DATABASES;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建数据库</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE mydb;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用数据库</span></span><br><span class="line">USE mydb;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> students (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    age <span class="type">INT</span>,</span><br><span class="line">    gender <span class="type">VARCHAR</span>(<span class="number">10</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看表结构</span></span><br><span class="line"><span class="keyword">DESC</span> students;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> students (name, age, gender) <span class="keyword">VALUES</span> (<span class="string">&#x27;张三&#x27;</span>, <span class="number">18</span>, <span class="string">&#x27;男&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT INTO</span> students (name, age, gender) <span class="keyword">VALUES</span> (<span class="string">&#x27;李四&#x27;</span>, <span class="number">19</span>, <span class="string">&#x27;女&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询数据</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> students;</span><br></pre></td></tr></table></figure>

<h2 id="七、小结"><a href="#七、小结" class="headerlink" title="七、小结"></a>七、小结</h2><p>本文我们学习了：</p>
<ol>
<li><strong>数据库基础概念</strong>：数据库、DBMS、SQL 的定义和作用</li>
<li><strong>MySQL 简介</strong>：特点、版本选择</li>
<li><strong>MySQL 安装配置</strong>：Windows 下的安装步骤和服务管理</li>
<li><strong>数据模型</strong>：关系模型、ER 图、三大范式</li>
<li><strong>SQL 语法及分类</strong>：DDL、DML、DQL、DCL 四大类</li>
</ol>
<h2 id="八、练习与思考"><a href="#八、练习与思考" class="headerlink" title="八、练习与思考"></a>八、练习与思考</h2><ol>
<li>在本地成功安装 MySQL，并能够使用命令行登录</li>
<li>记住 root 用户的密码</li>
<li>了解 SQL 四大分类各自的作用和常用命令</li>
<li>思考：为什么数据库设计要遵循范式？</li>
</ol>
<hr>
<p><strong>下一篇</strong>：[MySQL 基础教程（二）：DDL 数据定义语言详解](&#x2F;2026&#x2F;02&#x2F;23&#x2F;MySQL 基础教程（二）DDL 数据定义语言详解&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 基础教程</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>数据库</tag>
        <tag>入门</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 基础教程（三）DML 数据操作语言详解</title>
    <url>/2026/02/23/MySQL%20%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B%EF%BC%88%E4%B8%89%EF%BC%89DML%20%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C%E8%AF%AD%E8%A8%80%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<h1 id="MySQL-基础教程（三）DML-数据操作语言详解"><a href="#MySQL-基础教程（三）DML-数据操作语言详解" class="headerlink" title="MySQL 基础教程（三）DML 数据操作语言详解"></a>MySQL 基础教程（三）DML 数据操作语言详解</h1><p>在上一篇文章中，我们学习了如何使用 DDL 创建和管理数据库表结构。本文我们将学习 <strong>DML（Data Manipulation Language）数据操作语言</strong>，掌握如何对表中的数据进行插入、更新和删除操作。</p>
<h2 id="一、DML-概述"><a href="#一、DML-概述" class="headerlink" title="一、DML 概述"></a>一、DML 概述</h2><p>DML 用于对数据库表中的数据进行操作，主要包括：</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>功能</th>
<th>特点</th>
</tr>
</thead>
<tbody><tr>
<td>INSERT</td>
<td>插入数据</td>
<td>添加新记录</td>
</tr>
<tr>
<td>UPDATE</td>
<td>更新数据</td>
<td>修改现有记录</td>
</tr>
<tr>
<td>DELETE</td>
<td>删除数据</td>
<td>删除符合条件的记录</td>
</tr>
<tr>
<td>TRUNCATE</td>
<td>清空表</td>
<td>删除全部记录并重置自增</td>
</tr>
</tbody></table>
<p><strong>DML 的特点</strong>：</p>
<ul>
<li>操作的是数据内容，不影响表结构</li>
<li>在事务中可回滚（需要关闭自动提交）</li>
<li>可以配合 WHERE 子句进行条件操作</li>
</ul>
<h2 id="二、插入数据（INSERT）"><a href="#二、插入数据（INSERT）" class="headerlink" title="二、插入数据（INSERT）"></a>二、插入数据（INSERT）</h2><h3 id="2-1-基础插入语法"><a href="#2-1-基础插入语法" class="headerlink" title="2.1 基础插入语法"></a>2.1 基础插入语法</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 语法</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> 表名 (列 <span class="number">1</span>, 列 <span class="number">2</span>, ..., 列 n)</span><br><span class="line"><span class="keyword">VALUES</span> (值 <span class="number">1</span>, 值 <span class="number">2</span>, ..., 值 n);</span><br></pre></td></tr></table></figure>

<h3 id="2-2-插入单条记录"><a href="#2-2-插入单条记录" class="headerlink" title="2.2 插入单条记录"></a>2.2 插入单条记录</h3><p>首先创建测试表：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建测试表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> employees (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    dept <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    salary <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),</span><br><span class="line">    hire_date <span class="type">DATE</span>,</span><br><span class="line">    status TINYINT <span class="keyword">DEFAULT</span> <span class="number">1</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 方式一：指定列名插入（推荐）</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> employees (name, dept, salary, hire_date)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;张三&#x27;</span>, <span class="string">&#x27;技术部&#x27;</span>, <span class="number">8000.00</span>, <span class="string">&#x27;2024-01-15&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方式二：不指定列名（必须为所有列提供值）</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> employees <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">2</span>, <span class="string">&#x27;李四&#x27;</span>, <span class="string">&#x27;市场部&#x27;</span>, <span class="number">7500.00</span>, <span class="string">&#x27;2024-02-01&#x27;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方式三：利用默认值</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> employees (name, dept, salary)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;王五&#x27;</span>, <span class="string">&#x27;人事部&#x27;</span>, <span class="number">6500.00</span>);</span><br><span class="line"><span class="comment">-- hire_date 为 NULL，status 为默认值 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方式四：设置 NULL 值</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> employees (name, dept, salary, hire_date, status)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;赵六&#x27;</span>, <span class="keyword">NULL</span>, <span class="number">5000.00</span>, <span class="keyword">NULL</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p><strong>注意事项</strong>：</p>
<ol>
<li>字符串和日期类型需要用引号包裹</li>
<li>插入的值必须与列的数据类型兼容</li>
<li>NOT NULL 约束的列必须提供值（除非有 DEFAULT）</li>
<li>主键列如果是自增，可以传入 NULL 或 DEFAULT 让系统自动生成</li>
</ol>
<h3 id="2-3-批量插入"><a href="#2-3-批量插入" class="headerlink" title="2.3 批量插入"></a>2.3 批量插入</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 一次插入多条记录（推荐，效率高）</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> employees (name, dept, salary, hire_date) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;孙七&#x27;</span>, <span class="string">&#x27;技术部&#x27;</span>, <span class="number">9000.00</span>, <span class="string">&#x27;2023-06-01&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;周八&#x27;</span>, <span class="string">&#x27;技术部&#x27;</span>, <span class="number">9500.00</span>, <span class="string">&#x27;2023-03-15&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;吴九&#x27;</span>, <span class="string">&#x27;市场部&#x27;</span>, <span class="number">7000.00</span>, <span class="string">&#x27;2024-01-10&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;郑十&#x27;</span>, <span class="string">&#x27;财务部&#x27;</span>, <span class="number">8500.00</span>, <span class="string">&#x27;2023-09-01&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;王十一&#x27;</span>, <span class="string">&#x27;市场部&#x27;</span>, <span class="number">7200.00</span>, <span class="string">&#x27;2023-12-01&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 验证插入结果</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-插入时处理重复"><a href="#2-4-插入时处理重复" class="headerlink" title="2.4 插入时处理重复"></a>2.4 插入时处理重复</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建带唯一约束的表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    username <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">UNIQUE</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    password <span class="type">VARCHAR</span>(<span class="number">255</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> users (username, email, password) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;user1&#x27;</span>, <span class="string">&#x27;user1@example.com&#x27;</span>, <span class="string">&#x27;pwd123&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;user2&#x27;</span>, <span class="string">&#x27;user2@example.com&#x27;</span>, <span class="string">&#x27;pwd456&#x27;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 方式一：INSERT IGNORE（忽略重复）</span></span><br><span class="line"><span class="keyword">INSERT</span> IGNORE <span class="keyword">INTO</span> users (username, email, password)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;user1&#x27;</span>, <span class="string">&#x27;new@example.com&#x27;</span>, <span class="string">&#x27;newpwd&#x27;</span>);</span><br><span class="line"><span class="comment">-- user1 已存在，该条语句被忽略，不会报错</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方式二：ON DUPLICATE KEY UPDATE（重复则更新）</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> users (username, email, password)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;user1&#x27;</span>, <span class="string">&#x27;updated@example.com&#x27;</span>, <span class="string">&#x27;newpwd123&#x27;</span>)</span><br><span class="line"><span class="keyword">ON</span> DUPLICATE KEY <span class="keyword">UPDATE</span></span><br><span class="line">    email <span class="operator">=</span> <span class="keyword">VALUES</span>(email),</span><br><span class="line">    password <span class="operator">=</span> <span class="keyword">VALUES</span>(password);</span><br><span class="line"><span class="comment">-- 如果 user1 存在，则更新 email 和 password</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方式三：REPLACE INTO（删除后重新插入）</span></span><br><span class="line">REPLACE <span class="keyword">INTO</span> users (username, email, password)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;user1&#x27;</span>, <span class="string">&#x27;replaced@example.com&#x27;</span>, <span class="string">&#x27;replacepwd&#x27;</span>);</span><br><span class="line"><span class="comment">-- 如果存在则先删除再插入，id 会变化</span></span><br></pre></td></tr></table></figure>

<h3 id="2-5-从其他表插入数据"><a href="#2-5-从其他表插入数据" class="headerlink" title="2.5 从其他表插入数据"></a>2.5 从其他表插入数据</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建员工备份表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> employees_backup <span class="keyword">LIKE</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方式一：INSERT ... SELECT</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> employees_backup (id, name, dept, salary, hire_date, status)</span><br><span class="line"><span class="keyword">SELECT</span> id, name, dept, salary, hire_date, status <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方式二：CREATE TABLE ... AS SELECT（创建并插入）</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> employees_copy <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> dept <span class="operator">=</span> <span class="string">&#x27;技术部&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="2-6-INSERT-性能优化技巧"><a href="#2-6-INSERT-性能优化技巧" class="headerlink" title="2.6 INSERT 性能优化技巧"></a>2.6 INSERT 性能优化技巧</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 技巧 1：使用批量插入（比单条插入快得多）</span></span><br><span class="line"><span class="comment">-- 慢：</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> employees (name, dept) <span class="keyword">VALUES</span> (<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;技术部&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT INTO</span> employees (name, dept) <span class="keyword">VALUES</span> (<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;技术部&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT INTO</span> employees (name, dept) <span class="keyword">VALUES</span> (<span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;技术部&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 快：</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> employees (name, dept) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;技术部&#x27;</span>), (<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;技术部&#x27;</span>), (<span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;技术部&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 技巧 2：对于大量数据，可以先禁用索引再插入</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> employees DISABLE KEYS;</span><br><span class="line"><span class="comment">-- 执行批量插入</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> employees ENABLE KEYS;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 技巧 3：使用事务包装（减少自动提交）</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="comment">-- 多条 INSERT 语句</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>

<h2 id="三、更新数据（UPDATE）"><a href="#三、更新数据（UPDATE）" class="headerlink" title="三、更新数据（UPDATE）"></a>三、更新数据（UPDATE）</h2><h3 id="3-1-基础更新语法"><a href="#3-1-基础更新语法" class="headerlink" title="3.1 基础更新语法"></a>3.1 基础更新语法</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 语法</span></span><br><span class="line"><span class="keyword">UPDATE</span> 表名</span><br><span class="line"><span class="keyword">SET</span> 列 <span class="number">1</span> <span class="operator">=</span> 值 <span class="number">1</span>, 列 <span class="number">2</span> <span class="operator">=</span> 值 <span class="number">2</span>, ...</span><br><span class="line">[<span class="keyword">WHERE</span> 条件];</span><br></pre></td></tr></table></figure>

<h3 id="3-2-更新指定记录"><a href="#3-2-更新指定记录" class="headerlink" title="3.2 更新指定记录"></a>3.2 更新指定记录</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 更新单条记录</span></span><br><span class="line"><span class="keyword">UPDATE</span> employees</span><br><span class="line"><span class="keyword">SET</span> salary <span class="operator">=</span> <span class="number">8500.00</span></span><br><span class="line"><span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 更新多列</span></span><br><span class="line"><span class="keyword">UPDATE</span> employees</span><br><span class="line"><span class="keyword">SET</span> salary <span class="operator">=</span> <span class="number">9000.00</span>, dept <span class="operator">=</span> <span class="string">&#x27;研发部&#x27;</span></span><br><span class="line"><span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 基于现有值更新</span></span><br><span class="line"><span class="keyword">UPDATE</span> employees</span><br><span class="line"><span class="keyword">SET</span> salary <span class="operator">=</span> salary <span class="operator">*</span> <span class="number">1.1</span>  <span class="comment">-- 加薪 10%</span></span><br><span class="line"><span class="keyword">WHERE</span> dept <span class="operator">=</span> <span class="string">&#x27;技术部&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 更新满足条件的多条记录</span></span><br><span class="line"><span class="keyword">UPDATE</span> employees</span><br><span class="line"><span class="keyword">SET</span> status <span class="operator">=</span> <span class="number">0</span>  <span class="comment">-- 设为离职状态</span></span><br><span class="line"><span class="keyword">WHERE</span> hire_date <span class="operator">&lt;</span> <span class="string">&#x27;2023-01-01&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>重要提醒</strong>：</p>
<blockquote>
<p>⚠️ <strong>UPDATE 语句一定要加 WHERE 子句！</strong> 否则整张表的所有记录都会被更新！</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 危险操作！会更新所有记录！</span></span><br><span class="line"><span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> <span class="number">5000</span>;  <span class="comment">-- 所有人的工资都变成 5000！</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 补救措施（如果开启了事务）</span></span><br><span class="line"><span class="keyword">ROLLBACK</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-更新时使用表达式"><a href="#3-3-更新时使用表达式" class="headerlink" title="3.3 更新时使用表达式"></a>3.3 更新时使用表达式</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 使用计算表达式</span></span><br><span class="line"><span class="keyword">UPDATE</span> employees</span><br><span class="line"><span class="keyword">SET</span> salary <span class="operator">=</span> salary <span class="operator">+</span> <span class="number">500</span>  <span class="comment">-- 每人加薪 500</span></span><br><span class="line"><span class="keyword">WHERE</span> status <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用函数</span></span><br><span class="line"><span class="keyword">UPDATE</span> employees</span><br><span class="line"><span class="keyword">SET</span> name <span class="operator">=</span> <span class="built_in">UPPER</span>(name)  <span class="comment">-- 姓名转大写</span></span><br><span class="line"><span class="keyword">WHERE</span> dept <span class="operator">=</span> <span class="string">&#x27;市场部&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用日期函数</span></span><br><span class="line"><span class="keyword">UPDATE</span> employees</span><br><span class="line"><span class="keyword">SET</span> hire_date <span class="operator">=</span> DATE_SUB(hire_date, <span class="type">INTERVAL</span> <span class="number">1</span> <span class="keyword">YEAR</span>)</span><br><span class="line"><span class="keyword">WHERE</span> id <span class="keyword">BETWEEN</span> <span class="number">1</span> <span class="keyword">AND</span> <span class="number">5</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-4-多表更新"><a href="#3-4-多表更新" class="headerlink" title="3.4 多表更新"></a>3.4 多表更新</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建部门表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> departments (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    dept_name <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    budget <span class="type">DECIMAL</span>(<span class="number">12</span>, <span class="number">2</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> departments (dept_name, budget) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;技术部&#x27;</span>, <span class="number">1000000</span>),</span><br><span class="line">(<span class="string">&#x27;市场部&#x27;</span>, <span class="number">500000</span>),</span><br><span class="line">(<span class="string">&#x27;财务部&#x27;</span>, <span class="number">300000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改 employees 表，添加 dept_id</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> employees <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> dept_id <span class="type">INT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 多表关联更新</span></span><br><span class="line"><span class="keyword">UPDATE</span> employees e</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> departments d <span class="keyword">ON</span> e.dept <span class="operator">=</span> d.dept_name</span><br><span class="line"><span class="keyword">SET</span> e.dept_id <span class="operator">=</span> d.id;</span><br></pre></td></tr></table></figure>

<h3 id="3-5-更新-LIMIT"><a href="#3-5-更新-LIMIT" class="headerlink" title="3.5 更新 LIMIT"></a>3.5 更新 LIMIT</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 只更新前 N 条记录</span></span><br><span class="line"><span class="keyword">UPDATE</span> employees</span><br><span class="line"><span class="keyword">SET</span> salary <span class="operator">=</span> salary <span class="operator">+</span> <span class="number">100</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">ASC</span></span><br><span class="line">LIMIT <span class="number">5</span>;  <span class="comment">-- 工资最低的 5 个人加薪 100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结合 WHERE 和 LIMIT</span></span><br><span class="line"><span class="keyword">UPDATE</span> employees</span><br><span class="line"><span class="keyword">SET</span> status <span class="operator">=</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">WHERE</span> dept <span class="operator">=</span> <span class="string">&#x27;市场部&#x27;</span></span><br><span class="line">LIMIT <span class="number">1</span>;  <span class="comment">-- 只更新 1 条市场部员工</span></span><br></pre></td></tr></table></figure>

<h2 id="四、删除数据（DELETE）"><a href="#四、删除数据（DELETE）" class="headerlink" title="四、删除数据（DELETE）"></a>四、删除数据（DELETE）</h2><h3 id="4-1-基础删除语法"><a href="#4-1-基础删除语法" class="headerlink" title="4.1 基础删除语法"></a>4.1 基础删除语法</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 语法</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> 表名 [<span class="keyword">WHERE</span> 条件];</span><br></pre></td></tr></table></figure>

<h3 id="4-2-删除指定记录"><a href="#4-2-删除指定记录" class="headerlink" title="4.2 删除指定记录"></a>4.2 删除指定记录</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 删除单条记录</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除多条记录</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> dept <span class="operator">=</span> <span class="string">&#x27;市场部&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用 IN 删除</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> id <span class="keyword">IN</span> (<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用条件删除</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="operator">&lt;</span> <span class="number">6000</span> <span class="keyword">AND</span> status <span class="operator">=</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<p><strong>重要提醒</strong>：</p>
<blockquote>
<p>⚠️ <strong>DELETE 语句一定要加 WHERE 子句！</strong> 否则会删除整张表的所有数据！</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 危险操作！会删除所有记录！</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> employees;  <span class="comment">-- 表清空！</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 如果误操作且开启了事务</span></span><br><span class="line"><span class="keyword">ROLLBACK</span>;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-删除-LIMIT"><a href="#4-3-删除-LIMIT" class="headerlink" title="4.3 删除 LIMIT"></a>4.3 删除 LIMIT</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 删除前 N 条符合条件的记录</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> status <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">LIMIT <span class="number">3</span>;  <span class="comment">-- 只删除 3 条离职员工</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 配合 ORDER BY</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> dept <span class="operator">=</span> <span class="string">&#x27;市场部&#x27;</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span></span><br><span class="line">LIMIT <span class="number">1</span>;  <span class="comment">-- 删除市场部工资最高的 1 人</span></span><br></pre></td></tr></table></figure>

<h3 id="4-4-多表删除"><a href="#4-4-多表删除" class="headerlink" title="4.4 多表删除"></a>4.4 多表删除</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 删除主表记录时级联删除子表</span></span><br><span class="line"><span class="keyword">DELETE</span> e <span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> departments d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.id</span><br><span class="line"><span class="keyword">WHERE</span> d.dept_name <span class="operator">=</span> <span class="string">&#x27;财务部&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除不存在的关联记录（左连接删除）</span></span><br><span class="line"><span class="keyword">DELETE</span> e <span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> departments d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.id</span><br><span class="line"><span class="keyword">WHERE</span> d.id <span class="keyword">IS</span> <span class="keyword">NULL</span>;  <span class="comment">-- 删除没有对应部门的员工</span></span><br></pre></td></tr></table></figure>

<h2 id="五、DELETE-vs-TRUNCATE-vs-DROP"><a href="#五、DELETE-vs-TRUNCATE-vs-DROP" class="headerlink" title="五、DELETE vs TRUNCATE vs DROP"></a>五、DELETE vs TRUNCATE vs DROP</h2><p>这三个命令都可以删除数据，但有本质区别：</p>
<table>
<thead>
<tr>
<th>对比项</th>
<th>DELETE</th>
<th>TRUNCATE</th>
<th>DROP</th>
</tr>
</thead>
<tbody><tr>
<td><strong>类型</strong></td>
<td>DML</td>
<td>DDL</td>
<td>DDL</td>
</tr>
<tr>
<td><strong>功能</strong></td>
<td>删除符合条件的行</td>
<td>清空整张表</td>
<td>删除整个表（结构和数据）</td>
</tr>
<tr>
<td><strong>WHERE 条件</strong></td>
<td>支持</td>
<td>不支持</td>
<td>不适用</td>
</tr>
<tr>
<td><strong>返回值</strong></td>
<td>删除的行数</td>
<td>无</td>
<td>无</td>
</tr>
<tr>
<td><strong>自增列重置</strong></td>
<td>否</td>
<td>是</td>
<td>不适用</td>
</tr>
<tr>
<td><strong>事务回滚</strong></td>
<td>支持</td>
<td>不支持</td>
<td>不支持</td>
</tr>
<tr>
<td><strong>触发器</strong></td>
<td>触发</td>
<td>不触发</td>
<td>不适用</td>
</tr>
<tr>
<td><strong>外键约束</strong></td>
<td>检查</td>
<td>检查</td>
<td>检查</td>
</tr>
<tr>
<td><strong>执行速度</strong></td>
<td>慢</td>
<td>快</td>
<td>快</td>
</tr>
<tr>
<td><strong>空间释放</strong></td>
<td>不释放</td>
<td>释放</td>
<td>释放</td>
</tr>
</tbody></table>
<h3 id="使用示例对比"><a href="#使用示例对比" class="headerlink" title="使用示例对比"></a>使用示例对比</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- DELETE：删除工资低于 7000 的员工</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> salary <span class="operator">&lt;</span> <span class="number">7000</span>;</span><br><span class="line"><span class="comment">-- 自增 id 不会重置，下一个 id 继续递增</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- TRUNCATE：清空所有员工</span></span><br><span class="line"><span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span> employees;</span><br><span class="line"><span class="comment">-- 自增 id 重置为 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- DROP：删除整个员工表（表结构也没了）</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> employees;</span><br><span class="line"><span class="comment">-- 再次查询会报错：Table doesn&#x27;t exist</span></span><br></pre></td></tr></table></figure>

<h2 id="六、DML-与事务"><a href="#六、DML-与事务" class="headerlink" title="六、DML 与事务"></a>六、DML 与事务</h2><h3 id="6-1-事务基础"><a href="#6-1-事务基础" class="headerlink" title="6.1 事务基础"></a>6.1 事务基础</h3><p>事务是一组原子性的 SQL 操作，要么全部成功，要么全部失败。</p>
<p><strong>事务的 ACID 特性</strong>：</p>
<ul>
<li><strong>原子性（Atomicity）</strong>：事务是不可分割的最小单位</li>
<li><strong>一致性（Consistency）</strong>：事务执行前后数据保持一致</li>
<li><strong>隔离性（Isolation）</strong>：并发事务互不干扰</li>
<li><strong>持久性（Durability）</strong>：事务提交后永久保存</li>
</ul>
<h3 id="6-2-事务操作"><a href="#6-2-事务操作" class="headerlink" title="6.2 事务操作"></a>6.2 事务操作</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看自动提交状态</span></span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@autocommit</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 关闭自动提交</span></span><br><span class="line"><span class="keyword">SET</span> autocommit <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 开始事务</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="comment">-- 或</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 执行 DML 操作</span></span><br><span class="line"><span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> salary <span class="operator">+</span> <span class="number">500</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> salary <span class="operator">-</span> <span class="number">500</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 提交事务（使更改永久生效）</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 回滚事务（撤销所有更改）</span></span><br><span class="line"><span class="keyword">ROLLBACK</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置保存点</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> <span class="number">8000</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">SAVEPOINT</span> sp1;</span><br><span class="line"><span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> <span class="number">9000</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="comment">-- 回滚到保存点</span></span><br><span class="line"><span class="keyword">ROLLBACK</span> <span class="keyword">TO</span> sp1;  <span class="comment">-- id=2 的更新被撤销，id=1 的更新保留</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-实战案例：转账操作"><a href="#6-3-实战案例：转账操作" class="headerlink" title="6.3 实战案例：转账操作"></a>6.3 实战案例：转账操作</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建账户表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> accounts (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    account_name <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    balance <span class="type">DECIMAL</span>(<span class="number">12</span>, <span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="number">0</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> accounts (account_name, balance) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;张三&#x27;</span>, <span class="number">10000</span>),</span><br><span class="line">(<span class="string">&#x27;李四&#x27;</span>, <span class="number">5000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 张三给李四转账 1000 元（使用事务保证原子性）</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 张三账户减 1000</span></span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">-</span> <span class="number">1000</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 李四账户加 1000</span></span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">+</span> <span class="number">1000</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查是否有异常（实际应用中的业务逻辑）</span></span><br><span class="line"><span class="comment">-- 这里可以添加余额检查等逻辑</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 提交事务</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 如果中间出现错误</span></span><br><span class="line"><span class="comment">-- ROLLBACK;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看结果</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> accounts;</span><br></pre></td></tr></table></figure>

<h2 id="七、DML-实战练习"><a href="#七、DML-实战练习" class="headerlink" title="七、DML 实战练习"></a>七、DML 实战练习</h2><h3 id="7-1-员工管理系统练习"><a href="#7-1-员工管理系统练习" class="headerlink" title="7.1 员工管理系统练习"></a>7.1 员工管理系统练习</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 1. 初始化数据</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> employees (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    dept <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    salary <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),</span><br><span class="line">    hire_date <span class="type">DATE</span>,</span><br><span class="line">    status TINYINT <span class="keyword">DEFAULT</span> <span class="number">1</span> COMMENT <span class="string">&#x27;1 在职 0 离职&#x27;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> employees (name, dept, salary, hire_date, status) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;张三&#x27;</span>, <span class="string">&#x27;技术部&#x27;</span>, <span class="number">8000</span>, <span class="string">&#x27;2023-01-15&#x27;</span>, <span class="number">1</span>),</span><br><span class="line">(<span class="string">&#x27;李四&#x27;</span>, <span class="string">&#x27;技术部&#x27;</span>, <span class="number">9000</span>, <span class="string">&#x27;2022-06-01&#x27;</span>, <span class="number">1</span>),</span><br><span class="line">(<span class="string">&#x27;王五&#x27;</span>, <span class="string">&#x27;市场部&#x27;</span>, <span class="number">7500</span>, <span class="string">&#x27;2023-03-20&#x27;</span>, <span class="number">1</span>),</span><br><span class="line">(<span class="string">&#x27;赵六&#x27;</span>, <span class="string">&#x27;市场部&#x27;</span>, <span class="number">7000</span>, <span class="string">&#x27;2023-06-10&#x27;</span>, <span class="number">1</span>),</span><br><span class="line">(<span class="string">&#x27;孙七&#x27;</span>, <span class="string">&#x27;财务部&#x27;</span>, <span class="number">8500</span>, <span class="string">&#x27;2022-09-01&#x27;</span>, <span class="number">1</span>),</span><br><span class="line">(<span class="string">&#x27;周八&#x27;</span>, <span class="string">&#x27;技术部&#x27;</span>, <span class="number">9500</span>, <span class="string">&#x27;2021-12-01&#x27;</span>, <span class="number">1</span>),</span><br><span class="line">(<span class="string">&#x27;吴九&#x27;</span>, <span class="string">&#x27;人事部&#x27;</span>, <span class="number">6500</span>, <span class="string">&#x27;2023-07-01&#x27;</span>, <span class="number">1</span>),</span><br><span class="line">(<span class="string">&#x27;郑十&#x27;</span>, <span class="string">&#x27;财务部&#x27;</span>, <span class="number">8000</span>, <span class="string">&#x27;2023-02-15&#x27;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 练习 1：技术部所有员工加薪 500 元</span></span><br><span class="line"><span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> salary <span class="operator">+</span> <span class="number">500</span> <span class="keyword">WHERE</span> dept <span class="operator">=</span> <span class="string">&#x27;技术部&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 练习 2：插入一批新员工</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> employees (name, dept, salary, hire_date) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;刘备&#x27;</span>, <span class="string">&#x27;市场部&#x27;</span>, <span class="number">12000</span>, <span class="string">&#x27;2024-01-02&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;关羽&#x27;</span>, <span class="string">&#x27;技术部&#x27;</span>, <span class="number">11000</span>, <span class="string">&#x27;2024-01-02&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;张飞&#x27;</span>, <span class="string">&#x27;技术部&#x27;</span>, <span class="number">10000</span>, <span class="string">&#x27;2024-01-02&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 练习 3：删除所有离职员工（status=0）</span></span><br><span class="line"><span class="comment">-- 先模拟一些离职员工</span></span><br><span class="line"><span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> status <span class="operator">=</span> <span class="number">0</span> <span class="keyword">WHERE</span> name <span class="keyword">IN</span> (<span class="string">&#x27;吴九&#x27;</span>, <span class="string">&#x27;郑十&#x27;</span>);</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> status <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 练习 4：将市场部和财务部的工资统一上调 8%</span></span><br><span class="line"><span class="keyword">UPDATE</span> employees</span><br><span class="line"><span class="keyword">SET</span> salary <span class="operator">=</span> salary <span class="operator">*</span> <span class="number">1.08</span></span><br><span class="line"><span class="keyword">WHERE</span> dept <span class="keyword">IN</span> (<span class="string">&#x27;市场部&#x27;</span>, <span class="string">&#x27;财务部&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 练习 5：查询最终结果</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">ORDER</span> <span class="keyword">BY</span> dept, salary <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h3 id="7-2-订单系统练习"><a href="#7-2-订单系统练习" class="headerlink" title="7.2 订单系统练习"></a>7.2 订单系统练习</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建订单表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    order_no <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">UNIQUE</span>,</span><br><span class="line">    customer_name <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    amount <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),</span><br><span class="line">    status <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;PENDING&#x27;</span>,</span><br><span class="line">    create_time DATETIME <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入订单数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (order_no, customer_name, amount, status) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;ORD001&#x27;</span>, <span class="string">&#x27;张三&#x27;</span>, <span class="number">199.00</span>, <span class="string">&#x27;PENDING&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;ORD002&#x27;</span>, <span class="string">&#x27;李四&#x27;</span>, <span class="number">299.00</span>, <span class="string">&#x27;PAID&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;ORD003&#x27;</span>, <span class="string">&#x27;王五&#x27;</span>, <span class="number">399.00</span>, <span class="string">&#x27;PENDING&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;ORD004&#x27;</span>, <span class="string">&#x27;赵六&#x27;</span>, <span class="number">499.00</span>, <span class="string">&#x27;SHIPPED&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;ORD005&#x27;</span>, <span class="string">&#x27;孙七&#x27;</span>, <span class="number">599.00</span>, <span class="string">&#x27;PENDING&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 练习 1：将所有 PENDING 状态的订单改为 PAID</span></span><br><span class="line"><span class="keyword">UPDATE</span> orders <span class="keyword">SET</span> status <span class="operator">=</span> <span class="string">&#x27;PAID&#x27;</span> <span class="keyword">WHERE</span> status <span class="operator">=</span> <span class="string">&#x27;PENDING&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 练习 2：删除金额低于 300 的订单</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> amount <span class="operator">&lt;</span> <span class="number">300</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 练习 3：批量插入新订单</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (order_no, customer_name, amount) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;ORD006&#x27;</span>, <span class="string">&#x27;周八&#x27;</span>, <span class="number">699.00</span>),</span><br><span class="line">(<span class="string">&#x27;ORD007&#x27;</span>, <span class="string">&#x27;吴九&#x27;</span>, <span class="number">799.00</span>),</span><br><span class="line">(<span class="string">&#x27;ORD008&#x27;</span>, <span class="string">&#x27;郑十&#x27;</span>, <span class="number">899.00</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 练习 4：给所有订单打 9 折促销</span></span><br><span class="line"><span class="keyword">UPDATE</span> orders <span class="keyword">SET</span> amount <span class="operator">=</span> amount <span class="operator">*</span> <span class="number">0.9</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看结果</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders;</span><br></pre></td></tr></table></figure>

<h2 id="八、DML-性能优化建议"><a href="#八、DML-性能优化建议" class="headerlink" title="八、DML 性能优化建议"></a>八、DML 性能优化建议</h2><h3 id="8-1-INSERT-优化"><a href="#8-1-INSERT-优化" class="headerlink" title="8.1 INSERT 优化"></a>8.1 INSERT 优化</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 1. 批量插入优于单条插入</span></span><br><span class="line"><span class="comment">-- 慢</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> employees (name, dept) <span class="keyword">VALUES</span> (<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;技术部&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT INTO</span> employees (name, dept) <span class="keyword">VALUES</span> (<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;技术部&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 快</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> employees (name, dept) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;技术部&#x27;</span>), (<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;技术部&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 对于大量数据，禁用索引后插入再重建</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> employees DISABLE KEYS;</span><br><span class="line"><span class="comment">-- 批量插入...</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> employees ENABLE KEYS;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3. 使用 LOAD DATA 导入文本文件（最快）</span></span><br><span class="line">LOAD DATA <span class="keyword">LOCAL</span> INFILE <span class="string">&#x27;/path/to/data.csv&#x27;</span></span><br><span class="line"><span class="keyword">INTO</span> <span class="keyword">TABLE</span> employees</span><br><span class="line">FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span></span><br><span class="line">LINES TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">(name, dept, salary);</span><br></pre></td></tr></table></figure>

<h3 id="8-2-UPDATE-优化"><a href="#8-2-UPDATE-优化" class="headerlink" title="8.2 UPDATE 优化"></a>8.2 UPDATE 优化</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 1. WHERE 条件使用索引列</span></span><br><span class="line"><span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> <span class="number">8000</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;  <span class="comment">-- id 是主键，有索引</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 避免更新不必要的列</span></span><br><span class="line"><span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> name <span class="operator">=</span> <span class="string">&#x27;新名字&#x27;</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;  <span class="comment">-- 只更新需要的列</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3. 分批更新大表</span></span><br><span class="line"><span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> status <span class="operator">=</span> <span class="number">0</span> <span class="keyword">WHERE</span> create_time <span class="operator">&lt;</span> <span class="string">&#x27;2023-01-01&#x27;</span> LIMIT <span class="number">1000</span>;</span><br><span class="line"><span class="comment">-- 多次执行直到影响行数为 0</span></span><br></pre></td></tr></table></figure>

<h3 id="8-3-DELETE-优化"><a href="#8-3-DELETE-优化" class="headerlink" title="8.3 DELETE 优化"></a>8.3 DELETE 优化</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 1. 分批删除大表</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> logs <span class="keyword">WHERE</span> create_time <span class="operator">&lt;</span> <span class="string">&#x27;2023-01-01&#x27;</span> LIMIT <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 对于清空表，使用 TRUNCATE 代替 DELETE</span></span><br><span class="line"><span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span> logs;  <span class="comment">-- 比 DELETE 快得多</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3. 删除前备份重要数据</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> employees_backup <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> status <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> status <span class="operator">=</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<h2 id="九、小结"><a href="#九、小结" class="headerlink" title="九、小结"></a>九、小结</h2><h3 id="知识点回顾"><a href="#知识点回顾" class="headerlink" title="知识点回顾"></a>知识点回顾</h3><ol>
<li><p><strong>INSERT 插入</strong></p>
<ul>
<li>单条插入、批量插入</li>
<li>INSERT IGNORE、ON DUPLICATE KEY UPDATE、REPLACE INTO</li>
<li>INSERT INTO … SELECT</li>
</ul>
</li>
<li><p><strong>UPDATE 更新</strong></p>
<ul>
<li>基础更新、表达式更新、多表更新</li>
<li>必须使用 WHERE 条件避免误更新</li>
</ul>
</li>
<li><p><strong>DELETE 删除</strong></p>
<ul>
<li>条件删除、LIMIT 删除、多表删除</li>
<li>DELETE vs TRUNCATE vs DROP 的区别</li>
</ul>
</li>
<li><p><strong>事务控制</strong></p>
<ul>
<li>START TRANSACTION、COMMIT、ROLLBACK</li>
<li>保存点 SAVEPOINT</li>
</ul>
</li>
</ol>
<h3 id="DML-命令速查表"><a href="#DML-命令速查表" class="headerlink" title="DML 命令速查表"></a>DML 命令速查表</h3><table>
<thead>
<tr>
<th>命令</th>
<th>语法</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>INSERT</td>
<td><code>INSERT INTO 表 (列) VALUES (值)</code></td>
<td>插入数据</td>
</tr>
<tr>
<td>UPDATE</td>
<td><code>UPDATE 表 SET 列=值 WHERE 条件</code></td>
<td>更新数据</td>
</tr>
<tr>
<td>DELETE</td>
<td><code>DELETE FROM 表 WHERE 条件</code></td>
<td>删除数据</td>
</tr>
<tr>
<td>TRUNCATE</td>
<td><code>TRUNCATE TABLE 表</code></td>
<td>清空表</td>
</tr>
</tbody></table>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><p>⚠️ <strong>执行 DML 操作前务必</strong>：</p>
<ol>
<li>开启事务或确保可以回滚</li>
<li>先用 SELECT 验证 WHERE 条件是否正确</li>
<li>对重要数据进行备份</li>
<li>谨慎执行不带 WHERE 的 UPDATE&#x2F;DELETE</li>
</ol>
<hr>
<p><strong>下一篇</strong>：[MySQL 基础教程（四）：DQL 数据查询语言详解](&#x2F;2026&#x2F;02&#x2F;23&#x2F;MySQL 基础教程（四）DQL 数据查询语言详解&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 基础教程（二）：DDL 数据定义语言详解](&#x2F;2026&#x2F;02&#x2F;23&#x2F;MySQL 基础教程（二）DDL 数据定义语言详解&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 基础教程</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>DML</tag>
        <tag>数据操作</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 基础教程（二）DDL 数据定义语言详解</title>
    <url>/2026/02/23/MySQL%20%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B%EF%BC%88%E4%BA%8C%EF%BC%89DDL%20%E6%95%B0%E6%8D%AE%E5%AE%9A%E4%B9%89%E8%AF%AD%E8%A8%80%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<h1 id="MySQL-基础教程（二）DDL-数据定义语言详解"><a href="#MySQL-基础教程（二）DDL-数据定义语言详解" class="headerlink" title="MySQL 基础教程（二）DDL 数据定义语言详解"></a>MySQL 基础教程（二）DDL 数据定义语言详解</h1><p>在上一篇中，我们完成了 MySQL 的安装并了解了 SQL 的分类。本文我们将深入学习 <strong>DDL（Data Definition Language）数据定义语言</strong>，掌握如何创建和管理数据库与表。</p>
<h2 id="一、DDL-概述"><a href="#一、DDL-概述" class="headerlink" title="一、DDL 概述"></a>一、DDL 概述</h2><p>DDL 用于定义和管理数据库对象，包括：</p>
<ul>
<li><strong>数据库操作</strong>：CREATE DATABASE、DROP DATABASE、ALTER DATABASE、USE</li>
<li><strong>表操作</strong>：CREATE TABLE、ALTER TABLE、DROP TABLE、TRUNCATE、RENAME</li>
<li><strong>索引操作</strong>：CREATE INDEX、DROP INDEX</li>
<li><strong>视图操作</strong>：CREATE VIEW、DROP VIEW</li>
</ul>
<p><strong>DDL 的特点</strong>：</p>
<ul>
<li>操作会自动提交，无法回滚</li>
<li>操作的是数据库结构，而非数据内容</li>
</ul>
<h2 id="二、数据库操作"><a href="#二、数据库操作" class="headerlink" title="二、数据库操作"></a>二、数据库操作</h2><h3 id="2-1-创建数据库"><a href="#2-1-创建数据库" class="headerlink" title="2.1 创建数据库"></a>2.1 创建数据库</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建数据库（如果不存在）</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> mydb;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建数据库并指定字符集</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> mydb</span><br><span class="line"><span class="keyword">CHARACTER SET</span> utf8mb4</span><br><span class="line"><span class="keyword">COLLATE</span> utf8mb4_unicode_ci;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看所有数据库</span></span><br><span class="line"><span class="keyword">SHOW</span> DATABASES;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看创建数据库的语句</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> DATABASE mydb;</span><br></pre></td></tr></table></figure>

<p><strong>参数说明</strong>：</p>
<ul>
<li><code>IF NOT EXISTS</code>：如果数据库已存在则不创建，避免报错</li>
<li><code>CHARACTER SET</code>：指定字符集，推荐 <code>utf8mb4</code>（支持 emoji 等特殊字符）</li>
<li><code>COLLATE</code>：指定排序规则</li>
</ul>
<p><strong>常用字符集</strong>：</p>
<table>
<thead>
<tr>
<th>字符集</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>utf8mb4</td>
<td>UTF-8 完整实现，支持 emoji（推荐）</td>
</tr>
<tr>
<td>utf8</td>
<td>MySQL 中的 utf8 是阉割版，最多 3 字节</td>
</tr>
<tr>
<td>gbk</td>
<td>中文字符集，2 字节</td>
</tr>
<tr>
<td>latin1</td>
<td>单字节字符集，西文字符</td>
</tr>
</tbody></table>
<h3 id="2-2-查看和选择数据库"><a href="#2-2-查看和选择数据库" class="headerlink" title="2.2 查看和选择数据库"></a>2.2 查看和选择数据库</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看当前使用的数据库</span></span><br><span class="line"><span class="keyword">SELECT</span> DATABASE();</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用/切换数据库</span></span><br><span class="line">USE mydb;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看当前数据库中的所有表</span></span><br><span class="line"><span class="keyword">SHOW</span> TABLES;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-修改数据库"><a href="#2-3-修改数据库" class="headerlink" title="2.3 修改数据库"></a>2.3 修改数据库</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 修改数据库字符集</span></span><br><span class="line"><span class="keyword">ALTER</span> DATABASE mydb</span><br><span class="line"><span class="keyword">CHARACTER SET</span> utf8mb4</span><br><span class="line"><span class="keyword">COLLATE</span> utf8mb4_general_ci;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看数据库定义</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> DATABASE mydb;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-删除数据库"><a href="#2-4-删除数据库" class="headerlink" title="2.4 删除数据库"></a>2.4 删除数据库</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 删除数据库（如果存在）</span></span><br><span class="line"><span class="keyword">DROP</span> DATABASE IF <span class="keyword">EXISTS</span> mydb;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除数据库（不存在则报错）</span></span><br><span class="line"><span class="keyword">DROP</span> DATABASE mydb;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：<code>DROP</code> 操作会永久删除数据库及其所有数据，请谨慎操作！</p>
<h2 id="三、表操作-创建与查询"><a href="#三、表操作-创建与查询" class="headerlink" title="三、表操作 - 创建与查询"></a>三、表操作 - 创建与查询</h2><h3 id="3-1-创建表的基本语法"><a href="#3-1-创建表的基本语法" class="headerlink" title="3.1 创建表的基本语法"></a>3.1 创建表的基本语法</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] 表名 (</span><br><span class="line">    列名 <span class="number">1</span> 数据类型 [约束条件],</span><br><span class="line">    列名 <span class="number">2</span> 数据类型 [约束条件],</span><br><span class="line">    ...</span><br><span class="line">    列名 n 数据类型 [约束条件]</span><br><span class="line">) [表选项];</span><br></pre></td></tr></table></figure>

<h3 id="3-2-创建表示例"><a href="#3-2-创建表示例" class="headerlink" title="3.2 创建表示例"></a>3.2 创建表示例</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建学生表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> students (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;学生 ID&#x27;</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">    age <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">18</span> COMMENT <span class="string">&#x27;年龄&#x27;</span>,</span><br><span class="line">    gender ENUM(<span class="string">&#x27;男&#x27;</span>, <span class="string">&#x27;女&#x27;</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;男&#x27;</span> COMMENT <span class="string">&#x27;性别&#x27;</span>,</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">100</span>) COMMENT <span class="string">&#x27;邮箱&#x27;</span>,</span><br><span class="line">    phone <span class="type">VARCHAR</span>(<span class="number">20</span>) COMMENT <span class="string">&#x27;电话&#x27;</span>,</span><br><span class="line">    create_time DATETIME <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 COMMENT<span class="operator">=</span><span class="string">&#x27;学生信息表&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-常用约束条件"><a href="#3-3-常用约束条件" class="headerlink" title="3.3 常用约束条件"></a>3.3 常用约束条件</h3><table>
<thead>
<tr>
<th>约束</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>PRIMARY KEY</td>
<td>主键，唯一且非空</td>
<td><code>id INT PRIMARY KEY</code></td>
</tr>
<tr>
<td>AUTO_INCREMENT</td>
<td>自增</td>
<td><code>id INT AUTO_INCREMENT</code></td>
</tr>
<tr>
<td>NOT NULL</td>
<td>非空</td>
<td><code>name VARCHAR(50) NOT NULL</code></td>
</tr>
<tr>
<td>UNIQUE</td>
<td>唯一</td>
<td><code>email VARCHAR(100) UNIQUE</code></td>
</tr>
<tr>
<td>DEFAULT</td>
<td>默认值</td>
<td><code>age INT DEFAULT 18</code></td>
</tr>
<tr>
<td>FOREIGN KEY</td>
<td>外键</td>
<td><code>FOREIGN KEY (dept_id) REFERENCES departments(id)</code></td>
</tr>
<tr>
<td>CHECK</td>
<td>检查条件（MySQL 8.0.16+ 支持）</td>
<td><code>age INT CHECK (age &gt;= 0)</code></td>
</tr>
</tbody></table>
<h3 id="3-4-表选项"><a href="#3-4-表选项" class="headerlink" title="3.4 表选项"></a>3.4 表选项</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 常用表选项</span></span><br><span class="line">ENGINE<span class="operator">=</span>InnoDB           <span class="comment">-- 存储引擎，默认 InnoDB</span></span><br><span class="line"><span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="comment">-- 字符集</span></span><br><span class="line">AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span>        <span class="comment">-- 自增起始值</span></span><br><span class="line">COMMENT<span class="operator">=</span><span class="string">&#x27;表注释&#x27;</span>         <span class="comment">-- 表注释</span></span><br></pre></td></tr></table></figure>

<h3 id="3-5-查询表信息"><a href="#3-5-查询表信息" class="headerlink" title="3.5 查询表信息"></a>3.5 查询表信息</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看当前数据库的所有表</span></span><br><span class="line"><span class="keyword">SHOW</span> TABLES;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看表结构</span></span><br><span class="line"><span class="keyword">DESC</span> students;</span><br><span class="line"><span class="keyword">DESCRIBE</span> students;  <span class="comment">-- 等价</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看详细表结构（包含更多信息）</span></span><br><span class="line"><span class="keyword">DESC</span> formatted students;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看创建表的语句</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE TABLE</span> students;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看表的状态信息</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">TABLE</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;students&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看表的索引信息</span></span><br><span class="line"><span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> students;</span><br></pre></td></tr></table></figure>

<h3 id="3-6-创建表实战案例"><a href="#3-6-创建表实战案例" class="headerlink" title="3.6 创建表实战案例"></a>3.6 创建表实战案例</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建部门表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> departments (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;部门 ID&#x27;</span>,</span><br><span class="line">    dept_name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span> <span class="keyword">UNIQUE</span> COMMENT <span class="string">&#x27;部门名称&#x27;</span>,</span><br><span class="line">    dept_location <span class="type">VARCHAR</span>(<span class="number">100</span>) COMMENT <span class="string">&#x27;部门位置&#x27;</span>,</span><br><span class="line">    create_time DATETIME <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 COMMENT<span class="operator">=</span><span class="string">&#x27;部门表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建员工表（带外键）</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> employees (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;员工 ID&#x27;</span>,</span><br><span class="line">    emp_name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">    emp_no <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span> <span class="keyword">UNIQUE</span> COMMENT <span class="string">&#x27;员工编号&#x27;</span>,</span><br><span class="line">    gender ENUM(<span class="string">&#x27;男&#x27;</span>, <span class="string">&#x27;女&#x27;</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;男&#x27;</span> COMMENT <span class="string">&#x27;性别&#x27;</span>,</span><br><span class="line">    salary <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;工资&#x27;</span>,</span><br><span class="line">    dept_id <span class="type">INT</span> COMMENT <span class="string">&#x27;部门 ID&#x27;</span>,</span><br><span class="line">    hire_date <span class="type">DATE</span> COMMENT <span class="string">&#x27;入职日期&#x27;</span>,</span><br><span class="line">    create_time DATETIME <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 外键约束</span></span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_emp_dept</span><br><span class="line">        <span class="keyword">FOREIGN KEY</span> (dept_id) <span class="keyword">REFERENCES</span> departments(id)</span><br><span class="line">        <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">SET</span> <span class="keyword">NULL</span></span><br><span class="line">        <span class="keyword">ON</span> <span class="keyword">UPDATE</span> CASCADE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 COMMENT<span class="operator">=</span><span class="string">&#x27;员工表&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>外键选项说明</strong>：</p>
<ul>
<li><code>ON DELETE SET NULL</code>：删除父表记录时，子表外键设为 NULL</li>
<li><code>ON DELETE CASCADE</code>：删除父表记录时，级联删除子表记录</li>
<li><code>ON UPDATE CASCADE</code>：更新父表主键时，级联更新子表外键</li>
</ul>
<h2 id="四、MySQL-数据类型"><a href="#四、MySQL-数据类型" class="headerlink" title="四、MySQL 数据类型"></a>四、MySQL 数据类型</h2><p>MySQL 的数据类型分为三大类：<strong>数值类型</strong>、<strong>字符串类型</strong>、<strong>日期时间类型</strong>。</p>
<h3 id="4-1-数值类型"><a href="#4-1-数值类型" class="headerlink" title="4.1 数值类型"></a>4.1 数值类型</h3><h4 id="整数类型"><a href="#整数类型" class="headerlink" title="整数类型"></a>整数类型</h4><table>
<thead>
<tr>
<th>类型</th>
<th>字节</th>
<th>有符号范围</th>
<th>无符号范围</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>TINYINT</td>
<td>1</td>
<td>-128 ~ 127</td>
<td>0 ~ 255</td>
<td>适合状态、布尔值</td>
</tr>
<tr>
<td>SMALLINT</td>
<td>2</td>
<td>-32768 ~ 32767</td>
<td>0 ~ 65535</td>
<td>小整数</td>
</tr>
<tr>
<td>MEDIUMINT</td>
<td>3</td>
<td>-8388608 ~ 8388607</td>
<td>0 ~ 16777215</td>
<td>中等整数</td>
</tr>
<tr>
<td>INT&#x2F;INTEGER</td>
<td>4</td>
<td>-2³¹ ~ 2³¹-1</td>
<td>0 ~ 2³²-1</td>
<td>常用整数</td>
</tr>
<tr>
<td>BIGINT</td>
<td>8</td>
<td>-2⁶³ ~ 2⁶³-1</td>
<td>0 ~ 2⁶⁴-1</td>
<td>大整数，如金额</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 整数示例</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> num_test (</span><br><span class="line">    tiny_int TINYINT COMMENT <span class="string">&#x27;微小整数&#x27;</span>,</span><br><span class="line">    small_int <span class="type">SMALLINT</span> COMMENT <span class="string">&#x27;小整数&#x27;</span>,</span><br><span class="line">    medium_int MEDIUMINT COMMENT <span class="string">&#x27;中等整数&#x27;</span>,</span><br><span class="line">    big_int <span class="type">BIGINT</span> COMMENT <span class="string">&#x27;大整数&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 无符号整数（不能为负数）</span></span><br><span class="line">    unsigned_int <span class="type">INT</span> UNSIGNED COMMENT <span class="string">&#x27;无符号整数&#x27;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入测试数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> num_test <span class="keyword">VALUES</span> (<span class="number">100</span>, <span class="number">30000</span>, <span class="number">5000000</span>, <span class="number">9000000000</span>, <span class="number">4000000000</span>);</span><br></pre></td></tr></table></figure>

<p><strong>Zerofill 属性</strong>（自动添加前导零）：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建 zerofill 列</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> zerofill_test (</span><br><span class="line">    id <span class="type">INT</span>(<span class="number">5</span>) ZEROFILL</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> zerofill_test <span class="keyword">VALUES</span> (<span class="number">1</span>), (<span class="number">23</span>), (<span class="number">456</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> zerofill_test;</span><br><span class="line"><span class="comment">-- 结果：00001, 00023, 00456</span></span><br></pre></td></tr></table></figure>

<h4 id="浮点类型"><a href="#浮点类型" class="headerlink" title="浮点类型"></a>浮点类型</h4><table>
<thead>
<tr>
<th>类型</th>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>FLOAT</td>
<td>4</td>
<td>单精度浮点数</td>
</tr>
<tr>
<td>DOUBLE</td>
<td>8</td>
<td>双精度浮点数</td>
</tr>
<tr>
<td>DECIMAL(M,D)</td>
<td>可变</td>
<td>精确小数，适合金额</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 浮点数示例</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> float_test (</span><br><span class="line">    f <span class="type">FLOAT</span>,</span><br><span class="line">    d <span class="keyword">DOUBLE</span>,</span><br><span class="line">    m <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>)  <span class="comment">-- 总共 10 位，小数 2 位</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- DECIMAL 更适合金额计算（精确）</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> float_test <span class="keyword">VALUES</span> (<span class="number">3.14</span>, <span class="number">3.1415926</span>, <span class="number">12345678.90</span>);</span><br></pre></td></tr></table></figure>

<p><strong>DECIMAL vs FLOAT&#x2F;DOUBLE</strong>：</p>
<ul>
<li><code>FLOAT/DOUBLE</code>：有精度损失，适合科学计算</li>
<li><code>DECIMAL</code>：精确无损失，<strong>适合金融、金额计算</strong></li>
</ul>
<h3 id="4-2-字符串类型"><a href="#4-2-字符串类型" class="headerlink" title="4.2 字符串类型"></a>4.2 字符串类型</h3><table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
<th>最大长度</th>
<th>特点</th>
</tr>
</thead>
<tbody><tr>
<td>CHAR(n)</td>
<td>固定长度</td>
<td>255 字符</td>
<td>不足补空格，查询快</td>
</tr>
<tr>
<td>VARCHAR(n)</td>
<td>可变长度</td>
<td>65535 字节</td>
<td>节省空间</td>
</tr>
<tr>
<td>TEXT</td>
<td>长文本</td>
<td>65535 字节</td>
<td>存储大文本</td>
</tr>
<tr>
<td>MEDIUMTEXT</td>
<td>大文本</td>
<td>16MB</td>
<td>更大文本</td>
</tr>
<tr>
<td>LONGTEXT</td>
<td>超长文本</td>
<td>4GB</td>
<td>极大文本</td>
</tr>
<tr>
<td>BLOB</td>
<td>二进制数据</td>
<td>65535 字节</td>
<td>图片、文件等</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 字符串类型示例</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> string_test (</span><br><span class="line">    char_col <span class="type">CHAR</span>(<span class="number">10</span>) COMMENT <span class="string">&#x27;固定长度&#x27;</span>,</span><br><span class="line">    varchar_col <span class="type">VARCHAR</span>(<span class="number">10</span>) COMMENT <span class="string">&#x27;可变长度&#x27;</span>,</span><br><span class="line">    text_col TEXT COMMENT <span class="string">&#x27;长文本&#x27;</span>,</span><br><span class="line">    blob_col <span class="type">BLOB</span> COMMENT <span class="string">&#x27;二进制数据&#x27;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入测试</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> string_test <span class="keyword">VALUES</span> (<span class="string">&#x27;abc&#x27;</span>, <span class="string">&#x27;abc&#x27;</span>, <span class="string">&#x27;这是一段较长的文本...&#x27;</span>, X<span class="string">&#x27;48454C4C4F&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- CHAR 会补足空格</span></span><br><span class="line"><span class="keyword">SELECT</span> char_col, LENGTH(char_col) <span class="keyword">FROM</span> string_test;  <span class="comment">-- &#x27;abc       &#x27;, 10</span></span><br></pre></td></tr></table></figure>

<p><strong>CHAR vs VARCHAR 选择</strong>：</p>
<ul>
<li><code>CHAR</code>：长度固定或差异小（如手机号、身份证号、MD5）</li>
<li><code>VARCHAR</code>：长度差异大（如姓名、地址）</li>
</ul>
<h3 id="4-3-日期时间类型"><a href="#4-3-日期时间类型" class="headerlink" title="4.3 日期时间类型"></a>4.3 日期时间类型</h3><table>
<thead>
<tr>
<th>类型</th>
<th>格式</th>
<th>范围</th>
<th>字节</th>
</tr>
</thead>
<tbody><tr>
<td>DATE</td>
<td>YYYY-MM-DD</td>
<td>1000-01-01 ~ 9999-12-31</td>
<td>3</td>
</tr>
<tr>
<td>TIME</td>
<td>HH:MM:SS</td>
<td>-838:59:59 ~ 838:59:59</td>
<td>3</td>
</tr>
<tr>
<td>DATETIME</td>
<td>YYYY-MM-DD HH:MM:SS</td>
<td>1000-01-01 00:00:00 ~ 9999-12-31 23:59:59</td>
<td>8</td>
</tr>
<tr>
<td>TIMESTAMP</td>
<td>YYYY-MM-DD HH:MM:SS</td>
<td>1970-01-01 00:00:00 ~ 2038-01-19 03:14:07</td>
<td>4</td>
</tr>
<tr>
<td>YEAR</td>
<td>YYYY</td>
<td>1901 ~ 2155</td>
<td>1</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 日期时间类型示例</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> date_test (</span><br><span class="line">    d <span class="type">DATE</span> COMMENT <span class="string">&#x27;日期&#x27;</span>,</span><br><span class="line">    t <span class="type">TIME</span> COMMENT <span class="string">&#x27;时间&#x27;</span>,</span><br><span class="line">    dt DATETIME COMMENT <span class="string">&#x27;日期时间&#x27;</span>,</span><br><span class="line">    ts <span class="type">TIMESTAMP</span> COMMENT <span class="string">&#x27;时间戳&#x27;</span>,</span><br><span class="line">    y <span class="keyword">YEAR</span> COMMENT <span class="string">&#x27;年份&#x27;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入当前时间</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> date_test <span class="keyword">VALUES</span> (</span><br><span class="line">    CURDATE(),      <span class="comment">-- 当前日期</span></span><br><span class="line">    CURTIME(),      <span class="comment">-- 当前时间</span></span><br><span class="line">    NOW(),          <span class="comment">-- 当前日期时间</span></span><br><span class="line">    <span class="built_in">CURRENT_TIMESTAMP</span>,  <span class="comment">-- 当前时间戳</span></span><br><span class="line">    <span class="keyword">YEAR</span>(NOW())     <span class="comment">-- 当前年份</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><strong>DATETIME vs TIMESTAMP</strong>：</p>
<table>
<thead>
<tr>
<th>对比项</th>
<th>DATETIME</th>
<th>TIMESTAMP</th>
</tr>
</thead>
<tbody><tr>
<td>时区</td>
<td>无关</td>
<td>与时区相关</td>
</tr>
<tr>
<td>范围</td>
<td>1000~9999 年</td>
<td>1970~2038 年</td>
</tr>
<tr>
<td>空间</td>
<td>8 字节</td>
<td>4 字节</td>
</tr>
<tr>
<td>自动更新</td>
<td>不支持</td>
<td>支持 <code>ON UPDATE CURRENT_TIMESTAMP</code></td>
</tr>
</tbody></table>
<h3 id="4-4-数据类型选择建议"><a href="#4-4-数据类型选择建议" class="headerlink" title="4.4 数据类型选择建议"></a>4.4 数据类型选择建议</h3><ol>
<li><strong>整数优先于浮点数</strong>：能用整数就不用浮点数</li>
<li><strong>金额用 DECIMAL</strong>：避免精度损失</li>
<li><strong>字符串根据长度选择</strong>：固定长度用 CHAR，可变用 VARCHAR</li>
<li><strong>日期时间根据需求</strong>：需要时区用 TIMESTAMP，否则用 DATETIME</li>
<li><strong>预留适当空间</strong>：但不要过度浪费</li>
</ol>
<h2 id="五、表操作-修改与删除"><a href="#五、表操作-修改与删除" class="headerlink" title="五、表操作 - 修改与删除"></a>五、表操作 - 修改与删除</h2><h3 id="5-1-修改表结构（ALTER-TABLE）"><a href="#5-1-修改表结构（ALTER-TABLE）" class="headerlink" title="5.1 修改表结构（ALTER TABLE）"></a>5.1 修改表结构（ALTER TABLE）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 添加列</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> students <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> address <span class="type">VARCHAR</span>(<span class="number">200</span>) COMMENT <span class="string">&#x27;地址&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 添加列到指定位置</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> students <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> birthday <span class="type">DATE</span> COMMENT <span class="string">&#x27;生日&#x27;</span> AFTER age;</span><br><span class="line"><span class="keyword">ALTER TABLE</span> students <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> remark <span class="type">VARCHAR</span>(<span class="number">500</span>) COMMENT <span class="string">&#x27;备注&#x27;</span> <span class="keyword">LAST</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改列类型</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> students MODIFY <span class="keyword">COLUMN</span> age TINYINT COMMENT <span class="string">&#x27;年龄&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改列名和类型</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> students CHANGE <span class="keyword">COLUMN</span> remark comments TEXT COMMENT <span class="string">&#x27;备注&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除列</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> students <span class="keyword">DROP</span> <span class="keyword">COLUMN</span> address;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 添加约束</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> students <span class="keyword">ADD</span> <span class="keyword">UNIQUE</span> (email);</span><br><span class="line"><span class="keyword">ALTER TABLE</span> students <span class="keyword">ADD</span> INDEX idx_name (name);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除约束</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> students <span class="keyword">DROP</span> INDEX email;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改表名</span></span><br><span class="line">RENAME <span class="keyword">TABLE</span> students <span class="keyword">TO</span> student_info;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改表选项</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> student_info ENGINE<span class="operator">=</span>MyISAM;</span><br><span class="line"><span class="keyword">ALTER TABLE</span> student_info CHARSET<span class="operator">=</span>gbk;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 添加外键</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> employees</span><br><span class="line"><span class="keyword">ADD CONSTRAINT</span> fk_emp_dept</span><br><span class="line"><span class="keyword">FOREIGN KEY</span> (dept_id) <span class="keyword">REFERENCES</span> departments(id);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除外键</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> employees <span class="keyword">DROP</span> <span class="keyword">FOREIGN KEY</span> fk_emp_dept;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-删除表"><a href="#5-2-删除表" class="headerlink" title="5.2 删除表"></a>5.2 删除表</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 删除表（如果存在）</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> students;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除多个表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> students, departments;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-清空表数据"><a href="#5-3-清空表数据" class="headerlink" title="5.3 清空表数据"></a>5.3 清空表数据</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- DELETE 方式（可回滚，可带 WHERE）</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> students;</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> students <span class="keyword">WHERE</span> age <span class="operator">&gt;</span> <span class="number">25</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- TRUNCATE 方式（不可回滚，清空全部）</span></span><br><span class="line"><span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span> students;</span><br></pre></td></tr></table></figure>

<p><strong>DELETE vs TRUNCATE</strong>：</p>
<table>
<thead>
<tr>
<th>对比项</th>
<th>DELETE</th>
<th>TRUNCATE</th>
</tr>
</thead>
<tbody><tr>
<td>类型</td>
<td>DML</td>
<td>DDL</td>
</tr>
<tr>
<td>WHERE 条件</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>返回值</td>
<td>删除行数</td>
<td>无</td>
</tr>
<tr>
<td>自增重置</td>
<td>否</td>
<td>是</td>
</tr>
<tr>
<td>事务回滚</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>速度</td>
<td>慢</td>
<td>快</td>
</tr>
<tr>
<td>触发器</td>
<td>触发</td>
<td>不触发</td>
</tr>
</tbody></table>
<h2 id="六、图形化工具-DataGrip"><a href="#六、图形化工具-DataGrip" class="headerlink" title="六、图形化工具 DataGrip"></a>六、图形化工具 DataGrip</h2><h3 id="6-1-DataGrip-简介"><a href="#6-1-DataGrip-简介" class="headerlink" title="6.1 DataGrip 简介"></a>6.1 DataGrip 简介</h3><p>DataGrip 是 JetBrains 出品的专业数据库管理工具，支持多种数据库：</p>
<ul>
<li>MySQL、PostgreSQL、Oracle</li>
<li>SQL Server、SQLite</li>
<li>Redis、MongoDB（部分支持）</li>
</ul>
<h3 id="6-2-DataGrip-安装"><a href="#6-2-DataGrip-安装" class="headerlink" title="6.2 DataGrip 安装"></a>6.2 DataGrip 安装</h3><ol>
<li>下载地址：<a href="https://www.jetbrains.com/datagrip/">https://www.jetbrains.com/datagrip/</a></li>
<li>选择操作系统版本下载</li>
<li>安装并启动（支持 30 天试用）</li>
<li>学生可使用教育许可免费使用</li>
</ol>
<h3 id="6-3-连接-MySQL-数据库"><a href="#6-3-连接-MySQL-数据库" class="headerlink" title="6.3 连接 MySQL 数据库"></a>6.3 连接 MySQL 数据库</h3><ol>
<li>点击 <strong>File → New → Data Source → MySQL</strong></li>
<li>填写连接信息：<ul>
<li>Host: <code>localhost</code></li>
<li>Port: <code>3306</code></li>
<li>User: <code>root</code></li>
<li>Password: 你的密码</li>
</ul>
</li>
<li>点击 <strong>Test Connection</strong> 测试</li>
<li>点击 <strong>OK</strong> 保存</li>
</ol>
<h3 id="6-4-DataGrip-主要功能"><a href="#6-4-DataGrip-主要功能" class="headerlink" title="6.4 DataGrip 主要功能"></a>6.4 DataGrip 主要功能</h3><h4 id="数据库浏览"><a href="#数据库浏览" class="headerlink" title="数据库浏览"></a>数据库浏览</h4><ul>
<li>左侧 Database 面板查看所有数据库、表、视图</li>
<li>双击表名查看数据</li>
<li>右键表名查看结构、索引、外键</li>
</ul>
<h4 id="SQL-编辑"><a href="#SQL-编辑" class="headerlink" title="SQL 编辑"></a>SQL 编辑</h4><ul>
<li>新建 SQL 文件：右键 → New → SQL File</li>
<li>智能代码补全（Ctrl+Space）</li>
<li>语法高亮和错误提示</li>
<li>格式化代码（Ctrl+Alt+L）</li>
</ul>
<h4 id="执行查询"><a href="#执行查询" class="headerlink" title="执行查询"></a>执行查询</h4><ul>
<li>执行 SQL：Ctrl+Enter 或点击绿色三角</li>
<li>查看执行计划：Ctrl+X</li>
<li>导出查询结果：右键 → Export Data</li>
</ul>
<h4 id="数据编辑"><a href="#数据编辑" class="headerlink" title="数据编辑"></a>数据编辑</h4><ul>
<li>直接在表格中增删改数据</li>
<li>点击 Commit 提交更改</li>
</ul>
<h4 id="版本控制"><a href="#版本控制" class="headerlink" title="版本控制"></a>版本控制</h4><ul>
<li>支持 Git 集成</li>
<li>SQL 文件可版本管理</li>
</ul>
<h3 id="6-5-DataGrip-实用技巧"><a href="#6-5-DataGrip-实用技巧" class="headerlink" title="6.5 DataGrip 实用技巧"></a>6.5 DataGrip 实用技巧</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-- 常用快捷键</span><br><span class="line">Ctrl+Space      代码补全</span><br><span class="line">Ctrl+Enter      执行 SQL</span><br><span class="line">Alt+Enter       快速修复</span><br><span class="line">Ctrl+/          单行注释</span><br><span class="line">Ctrl+Shift+/    块注释</span><br><span class="line">Ctrl+Alt+L      格式化代码</span><br><span class="line">双击 Shift      搜索任意内容</span><br><span class="line">Ctrl+N          搜索表/视图</span><br></pre></td></tr></table></figure>

<h2 id="七、DDL-综合案例"><a href="#七、DDL-综合案例" class="headerlink" title="七、DDL 综合案例"></a>七、DDL 综合案例</h2><h3 id="7-1-电商数据库设计"><a href="#7-1-电商数据库设计" class="headerlink" title="7.1 电商数据库设计"></a>7.1 电商数据库设计</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 1. 创建数据库</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> ecommerce</span><br><span class="line"><span class="keyword">CHARACTER SET</span> utf8mb4</span><br><span class="line"><span class="keyword">COLLATE</span> utf8mb4_unicode_ci;</span><br><span class="line"></span><br><span class="line">USE ecommerce;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 创建用户表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    username <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span> <span class="keyword">UNIQUE</span> COMMENT <span class="string">&#x27;用户名&#x27;</span>,</span><br><span class="line">    password <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;密码（加密存储）&#x27;</span>,</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">UNIQUE</span> COMMENT <span class="string">&#x27;邮箱&#x27;</span>,</span><br><span class="line">    phone <span class="type">VARCHAR</span>(<span class="number">20</span>) COMMENT <span class="string">&#x27;手机号&#x27;</span>,</span><br><span class="line">    avatar <span class="type">VARCHAR</span>(<span class="number">255</span>) COMMENT <span class="string">&#x27;头像 URL&#x27;</span>,</span><br><span class="line">    status TINYINT <span class="keyword">DEFAULT</span> <span class="number">1</span> COMMENT <span class="string">&#x27;状态：1 正常 0 禁用&#x27;</span>,</span><br><span class="line">    create_time DATETIME <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    update_time DATETIME <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 COMMENT<span class="operator">=</span><span class="string">&#x27;用户表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3. 创建商品分类表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> categories (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;分类名称&#x27;</span>,</span><br><span class="line">    parent_id <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;父分类 ID&#x27;</span>,</span><br><span class="line">    sort_order <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;排序&#x27;</span>,</span><br><span class="line">    create_time DATETIME <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    INDEX idx_parent (parent_id)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 COMMENT<span class="operator">=</span><span class="string">&#x27;商品分类表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 4. 创建商品表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> products (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;商品名称&#x27;</span>,</span><br><span class="line">    description TEXT COMMENT <span class="string">&#x27;商品描述&#x27;</span>,</span><br><span class="line">    category_id <span class="type">INT</span> COMMENT <span class="string">&#x27;分类 ID&#x27;</span>,</span><br><span class="line">    price <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;价格&#x27;</span>,</span><br><span class="line">    stock <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;库存&#x27;</span>,</span><br><span class="line">    status TINYINT <span class="keyword">DEFAULT</span> <span class="number">1</span> COMMENT <span class="string">&#x27;状态：1 上架 0 下架&#x27;</span>,</span><br><span class="line">    main_image <span class="type">VARCHAR</span>(<span class="number">255</span>) COMMENT <span class="string">&#x27;主图&#x27;</span>,</span><br><span class="line">    create_time DATETIME <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    update_time DATETIME <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">FOREIGN KEY</span> (category_id) <span class="keyword">REFERENCES</span> categories(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">SET</span> <span class="keyword">NULL</span>,</span><br><span class="line">    INDEX idx_category (category_id),</span><br><span class="line">    INDEX idx_status (status)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 COMMENT<span class="operator">=</span><span class="string">&#x27;商品表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 5. 创建订单表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    order_no <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span> <span class="keyword">UNIQUE</span> COMMENT <span class="string">&#x27;订单号&#x27;</span>,</span><br><span class="line">    user_id <span class="type">INT</span> <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;用户 ID&#x27;</span>,</span><br><span class="line">    total_amount <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;订单金额&#x27;</span>,</span><br><span class="line">    status TINYINT <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;状态：0 待支付 1 已支付 2 发货 3 完成 4 取消&#x27;</span>,</span><br><span class="line">    shipping_address TEXT COMMENT <span class="string">&#x27;收货地址&#x27;</span>,</span><br><span class="line">    create_time DATETIME <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    update_time DATETIME <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">FOREIGN KEY</span> (user_id) <span class="keyword">REFERENCES</span> users(id),</span><br><span class="line">    INDEX idx_user (user_id),</span><br><span class="line">    INDEX idx_status (status)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 COMMENT<span class="operator">=</span><span class="string">&#x27;订单表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 6. 创建订单明细表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> order_items (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    order_id <span class="type">INT</span> <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;订单 ID&#x27;</span>,</span><br><span class="line">    product_id <span class="type">INT</span> <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;商品 ID&#x27;</span>,</span><br><span class="line">    product_name <span class="type">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;商品名称（冗余）&#x27;</span>,</span><br><span class="line">    price <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;单价&#x27;</span>,</span><br><span class="line">    quantity <span class="type">INT</span> <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="number">1</span> COMMENT <span class="string">&#x27;数量&#x27;</span>,</span><br><span class="line">    subtotal <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;小计&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">FOREIGN KEY</span> (order_id) <span class="keyword">REFERENCES</span> orders(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE,</span><br><span class="line">    <span class="keyword">FOREIGN KEY</span> (product_id) <span class="keyword">REFERENCES</span> products(id),</span><br><span class="line">    INDEX idx_order (order_id)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 COMMENT<span class="operator">=</span><span class="string">&#x27;订单明细表&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="八、小结"><a href="#八、小结" class="headerlink" title="八、小结"></a>八、小结</h2><p>本文我们系统学习了 DDL 的各个方面：</p>
<h3 id="知识点回顾"><a href="#知识点回顾" class="headerlink" title="知识点回顾"></a>知识点回顾</h3><ol>
<li><p><strong>数据库操作</strong></p>
<ul>
<li>CREATE DATABASE &#x2F; DROP DATABASE &#x2F; ALTER DATABASE &#x2F; USE</li>
</ul>
</li>
<li><p><strong>表操作</strong></p>
<ul>
<li>CREATE TABLE &#x2F; ALTER TABLE &#x2F; DROP TABLE &#x2F; TRUNCATE &#x2F; RENAME</li>
</ul>
</li>
<li><p><strong>数据类型</strong></p>
<ul>
<li>数值类型：TINYINT、INT、BIGINT、DECIMAL、FLOAT、DOUBLE</li>
<li>字符串类型：CHAR、VARCHAR、TEXT、BLOB</li>
<li>日期时间类型：DATE、TIME、DATETIME、TIMESTAMP、YEAR</li>
</ul>
</li>
<li><p><strong>约束条件</strong></p>
<ul>
<li>PRIMARY KEY、AUTO_INCREMENT、NOT NULL、UNIQUE、DEFAULT、FOREIGN KEY</li>
</ul>
</li>
<li><p><strong>图形化工具</strong></p>
<ul>
<li>DataGrip 的安装、连接、主要功能和快捷键</li>
</ul>
</li>
</ol>
<h3 id="DDL-命令速查"><a href="#DDL-命令速查" class="headerlink" title="DDL 命令速查"></a>DDL 命令速查</h3><table>
<thead>
<tr>
<th>操作类型</th>
<th>命令</th>
</tr>
</thead>
<tbody><tr>
<td>数据库</td>
<td>CREATE DATABASE、DROP DATABASE、ALTER DATABASE、USE</td>
</tr>
<tr>
<td>表</td>
<td>CREATE TABLE、DROP TABLE、ALTER TABLE、RENAME TABLE、TRUNCATE TABLE</td>
</tr>
<tr>
<td>列</td>
<td>ADD COLUMN、MODIFY COLUMN、CHANGE COLUMN、DROP COLUMN</td>
</tr>
<tr>
<td>约束</td>
<td>ADD PRIMARY KEY、ADD UNIQUE、ADD FOREIGN KEY、DROP INDEX</td>
</tr>
</tbody></table>
<hr>
<p><strong>下一篇</strong>：[MySQL 基础教程（三）：DML 数据操作语言详解](&#x2F;2026&#x2F;02&#x2F;23&#x2F;MySQL 基础教程（三）DML 数据操作语言详解&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 基础教程（一）：数据库基础与环境搭建](&#x2F;2026&#x2F;02&#x2F;23&#x2F;MySQL 基础教程（一）数据库基础与环境搭建&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 基础教程</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>DDL</tag>
        <tag>数据库操作</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 基础教程（四）DQL 数据查询语言详解（下）</title>
    <url>/2026/02/23/MySQL%20%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B%EF%BC%88%E5%9B%9B%EF%BC%89DQL%20%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E8%A8%80%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%B8%8B%EF%BC%89/</url>
    <content><![CDATA[<h1 id="MySQL-基础教程（四）DQL-数据查询语言详解（下）"><a href="#MySQL-基础教程（四）DQL-数据查询语言详解（下）" class="headerlink" title="MySQL 基础教程（四）DQL 数据查询语言详解（下）"></a>MySQL 基础教程（四）DQL 数据查询语言详解（下）</h1><p>承接上文，本文继续讲解 DQL 的排序查询、分页查询、综合案例以及 SQL 执行顺序。</p>
<h2 id="七、排序查询（ORDER-BY）"><a href="#七、排序查询（ORDER-BY）" class="headerlink" title="七、排序查询（ORDER BY）"></a>七、排序查询（ORDER BY）</h2><p>ORDER BY 用于对查询结果进行排序。</p>
<h3 id="7-1-基础排序"><a href="#7-1-基础排序" class="headerlink" title="7.1 基础排序"></a>7.1 基础排序</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 升序排序（ASC，默认）</span></span><br><span class="line"><span class="keyword">SELECT</span> name, salary <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">ASC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 降序排序（DESC）</span></span><br><span class="line"><span class="keyword">SELECT</span> name, salary <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 按字符串排序</span></span><br><span class="line"><span class="keyword">SELECT</span> name <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> name <span class="keyword">ASC</span>;  <span class="comment">-- 按拼音排序</span></span><br></pre></td></tr></table></figure>

<h3 id="7-2-多列排序"><a href="#7-2-多列排序" class="headerlink" title="7.2 多列排序"></a>7.2 多列排序</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 先按部门排序，部门相同按工资降序</span></span><br><span class="line"><span class="keyword">SELECT</span> name, dept_id, salary</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> dept_id <span class="keyword">ASC</span>, salary <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 先按在职状态排序，再按工资降序</span></span><br><span class="line"><span class="keyword">SELECT</span> name, status, salary</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> status <span class="keyword">DESC</span>, salary <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h3 id="7-3-使用列别名排序"><a href="#7-3-使用列别名排序" class="headerlink" title="7.3 使用列别名排序"></a>7.3 使用列别名排序</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 使用别名排序</span></span><br><span class="line"><span class="keyword">SELECT</span> name, salary <span class="keyword">AS</span> monthly_salary</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> monthly_salary <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用列位置排序（不推荐，易出错）</span></span><br><span class="line"><span class="keyword">SELECT</span> name, salary <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="number">2</span> <span class="keyword">DESC</span>;  <span class="comment">-- 2 表示第 2 列</span></span><br></pre></td></tr></table></figure>

<h3 id="7-4-使用表达式排序"><a href="#7-4-使用表达式排序" class="headerlink" title="7.4 使用表达式排序"></a>7.4 使用表达式排序</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 按年薪排序</span></span><br><span class="line"><span class="keyword">SELECT</span> name, salary, salary <span class="operator">*</span> <span class="number">12</span> <span class="keyword">AS</span> annual_salary</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> annual_salary <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 按工龄排序（假设现在是 2026 年）</span></span><br><span class="line"><span class="keyword">SELECT</span> name, hire_date, <span class="number">2026</span> <span class="operator">-</span> <span class="keyword">YEAR</span>(hire_date) <span class="keyword">AS</span> work_years</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> work_years <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h3 id="7-5-NULL-值排序"><a href="#7-5-NULL-值排序" class="headerlink" title="7.5 NULL 值排序"></a>7.5 NULL 值排序</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- NULL 值默认排在最前（升序）或最后（降序）</span></span><br><span class="line"><span class="keyword">SELECT</span> name, dept_id <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> dept_id <span class="keyword">ASC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- MySQL 8.0.13+ 支持 NULLS FIRST/LAST</span></span><br><span class="line"><span class="keyword">SELECT</span> name, dept_id <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> dept_id <span class="keyword">ASC</span> <span class="keyword">NULLS LAST</span>;</span><br></pre></td></tr></table></figure>

<h3 id="7-6-自定义排序顺序"><a href="#7-6-自定义排序顺序" class="headerlink" title="7.6 自定义排序顺序"></a>7.6 自定义排序顺序</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 按指定顺序排序（FIELD 函数）</span></span><br><span class="line"><span class="keyword">SELECT</span> name, dept_id <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> FIELD(dept_id, <span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>);  <span class="comment">-- 按 2→1→3→4 的顺序</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 按特定顺序排序（CASE 表达式）</span></span><br><span class="line"><span class="keyword">SELECT</span> name, dept_id <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="keyword">CASE</span> dept_id</span><br><span class="line">        <span class="keyword">WHEN</span> <span class="number">2</span> <span class="keyword">THEN</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">WHEN</span> <span class="number">1</span> <span class="keyword">THEN</span> <span class="number">2</span></span><br><span class="line">        <span class="keyword">WHEN</span> <span class="number">3</span> <span class="keyword">THEN</span> <span class="number">3</span></span><br><span class="line">        <span class="keyword">ELSE</span> <span class="number">4</span></span><br><span class="line">    <span class="keyword">END</span>;</span><br></pre></td></tr></table></figure>

<h2 id="八、分页查询（LIMIT）"><a href="#八、分页查询（LIMIT）" class="headerlink" title="八、分页查询（LIMIT）"></a>八、分页查询（LIMIT）</h2><p>LIMIT 用于限制返回的记录数，常用于分页场景。</p>
<h3 id="8-1-基础分页"><a href="#8-1-基础分页" class="headerlink" title="8.1 基础分页"></a>8.1 基础分页</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 返回前 5 条记录</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees LIMIT <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 从第 3 条开始，返回 5 条记录</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees LIMIT <span class="number">2</span>, <span class="number">5</span>;  <span class="comment">-- 从偏移量 2 开始（第 3 条）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 等价写法：LIMIT offset, count</span></span><br><span class="line"><span class="comment">-- 偏移量从 0 开始</span></span><br></pre></td></tr></table></figure>

<h3 id="8-2-分页公式"><a href="#8-2-分页公式" class="headerlink" title="8.2 分页公式"></a>8.2 分页公式</h3><p>分页查询的通用公式：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">LIMIT (页码 <span class="operator">-</span> <span class="number">1</span>) <span class="operator">*</span> 每页条数，每页条数</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 第 1 页，每页 5 条</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees LIMIT <span class="number">0</span>, <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 第 2 页，每页 5 条</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees LIMIT <span class="number">5</span>, <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 第 3 页，每页 5 条</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees LIMIT <span class="number">10</span>, <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 第 n 页，每页 5 条</span></span><br><span class="line"><span class="comment">-- LIMIT (n-1)*5, 5</span></span><br></pre></td></tr></table></figure>

<h3 id="8-3-分页实战"><a href="#8-3-分页实战" class="headerlink" title="8.3 分页实战"></a>8.3 分页实战</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 按工资降序，分页显示员工</span></span><br><span class="line"><span class="comment">-- 第 1 页：工资最高的 5 人</span></span><br><span class="line"><span class="keyword">SELECT</span> name, salary <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span></span><br><span class="line">LIMIT <span class="number">0</span>, <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 第 2 页：工资第 6-10 的人</span></span><br><span class="line"><span class="keyword">SELECT</span> name, salary <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span></span><br><span class="line">LIMIT <span class="number">5</span>, <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 带条件的分页：查询技术部员工，分页显示</span></span><br><span class="line"><span class="keyword">SELECT</span> name, dept_id, salary <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span></span><br><span class="line">LIMIT <span class="number">0</span>, <span class="number">5</span>;</span><br></pre></td></tr></table></figure>

<h3 id="8-4-LIMIT-的另一种写法"><a href="#8-4-LIMIT-的另一种写法" class="headerlink" title="8.4 LIMIT 的另一种写法"></a>8.4 LIMIT 的另一种写法</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- LIMIT offset, count</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees LIMIT <span class="number">0</span>, <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 等价于 LIMIT count OFFSET offset</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees LIMIT <span class="number">5</span> <span class="keyword">OFFSET</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<h3 id="8-5-大数据量分页优化"><a href="#8-5-大数据量分页优化" class="headerlink" title="8.5 大数据量分页优化"></a>8.5 大数据量分页优化</h3><p>当数据量很大时，传统的 <code>LIMIT 1000000, 10</code> 会很慢，因为 MySQL 需要扫描前 1000000 条记录。</p>
<p><strong>优化方案 1：延迟关联</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 原始查询（慢）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> id</span><br><span class="line">LIMIT <span class="number">1000000</span>, <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 优化后（快）</span></span><br><span class="line"><span class="keyword">SELECT</span> e.<span class="operator">*</span> <span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> id <span class="keyword">FROM</span> employees <span class="keyword">ORDER</span> <span class="keyword">BY</span> id LIMIT <span class="number">1000000</span>, <span class="number">10</span></span><br><span class="line">) tmp <span class="keyword">ON</span> e.id <span class="operator">=</span> tmp.id;</span><br></pre></td></tr></table></figure>

<p><strong>优化方案 2：利用覆盖索引</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 如果只需查询 id 和 name</span></span><br><span class="line"><span class="keyword">SELECT</span> id, name <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> id <span class="operator">&gt;</span> <span class="number">1000000</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> id</span><br><span class="line">LIMIT <span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<p><strong>优化方案 3：记录上次查询的最大 ID</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 首次查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">ORDER</span> <span class="keyword">BY</span> id LIMIT <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 记录最后一条的 id = 10</span></span><br><span class="line"><span class="comment">-- 下次查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> id <span class="operator">&gt;</span> <span class="number">10</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> id LIMIT <span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<h2 id="九、多表连接查询"><a href="#九、多表连接查询" class="headerlink" title="九、多表连接查询"></a>九、多表连接查询</h2><h3 id="9-1-内连接（INNER-JOIN）"><a href="#9-1-内连接（INNER-JOIN）" class="headerlink" title="9.1 内连接（INNER JOIN）"></a>9.1 内连接（INNER JOIN）</h3><p>内连接返回两个表中匹配的行。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询员工及其所属部门</span></span><br><span class="line"><span class="keyword">SELECT</span> e.name, e.salary, d.dept_name</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> departments d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 等价写法（INNER 可以省略）</span></span><br><span class="line"><span class="keyword">SELECT</span> e.name, d.dept_name</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">JOIN</span> departments d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 多表连接</span></span><br><span class="line"><span class="keyword">SELECT</span> e.name, d.dept_name, d.dept_location</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">JOIN</span> departments d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.id</span><br><span class="line"><span class="keyword">WHERE</span> e.salary <span class="operator">&gt;</span> <span class="number">8000</span>;</span><br></pre></td></tr></table></figure>

<h3 id="9-2-左连接（LEFT-JOIN）"><a href="#9-2-左连接（LEFT-JOIN）" class="headerlink" title="9.2 左连接（LEFT JOIN）"></a>9.2 左连接（LEFT JOIN）</h3><p>左连接返回左表的所有行，右表没有匹配的填充 NULL。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询所有部门及其员工（包括没有员工的部门）</span></span><br><span class="line"><span class="keyword">SELECT</span> d.dept_name, e.name, e.salary</span><br><span class="line"><span class="keyword">FROM</span> departments d</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> employees e <span class="keyword">ON</span> d.id <span class="operator">=</span> e.dept_id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询没有员工的部门</span></span><br><span class="line"><span class="keyword">SELECT</span> d.dept_name</span><br><span class="line"><span class="keyword">FROM</span> departments d</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> employees e <span class="keyword">ON</span> d.id <span class="operator">=</span> e.dept_id</span><br><span class="line"><span class="keyword">WHERE</span> e.id <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure>

<h3 id="9-3-右连接（RIGHT-JOIN）"><a href="#9-3-右连接（RIGHT-JOIN）" class="headerlink" title="9.3 右连接（RIGHT JOIN）"></a>9.3 右连接（RIGHT JOIN）</h3><p>右连接返回右表的所有行，左表没有匹配的填充 NULL。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询所有员工及其部门（包括没有员工的部门）</span></span><br><span class="line"><span class="keyword">SELECT</span> e.name, d.dept_name</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">RIGHT</span> <span class="keyword">JOIN</span> departments d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 等价于</span></span><br><span class="line"><span class="keyword">SELECT</span> e.name, d.dept_name</span><br><span class="line"><span class="keyword">FROM</span> departments d</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> employees e <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.id;</span><br></pre></td></tr></table></figure>

<h3 id="9-4-交叉连接（CROSS-JOIN）"><a href="#9-4-交叉连接（CROSS-JOIN）" class="headerlink" title="9.4 交叉连接（CROSS JOIN）"></a>9.4 交叉连接（CROSS JOIN）</h3><p>交叉连接返回两个表的笛卡尔积。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 交叉连接</span></span><br><span class="line"><span class="keyword">SELECT</span> e.name, d.dept_name</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">CROSS</span> <span class="keyword">JOIN</span> departments d;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 等价于（不写条件）</span></span><br><span class="line"><span class="keyword">SELECT</span> e.name, d.dept_name</span><br><span class="line"><span class="keyword">FROM</span> employees e, departments d;</span><br></pre></td></tr></table></figure>

<h3 id="9-5-自连接（SELF-JOIN）"><a href="#9-5-自连接（SELF-JOIN）" class="headerlink" title="9.5 自连接（SELF JOIN）"></a>9.5 自连接（SELF JOIN）</h3><p>表自己连接自己，常用于层级数据。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建带上级领导的员工表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> employees_with_manager;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> employees_with_manager (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    manager_id <span class="type">INT</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> employees_with_manager <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">1</span>, <span class="string">&#x27;张三&#x27;</span>, <span class="keyword">NULL</span>),</span><br><span class="line">(<span class="number">2</span>, <span class="string">&#x27;李四&#x27;</span>, <span class="number">1</span>),</span><br><span class="line">(<span class="number">3</span>, <span class="string">&#x27;王五&#x27;</span>, <span class="number">1</span>),</span><br><span class="line">(<span class="number">4</span>, <span class="string">&#x27;赵六&#x27;</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询员工及其上级领导</span></span><br><span class="line"><span class="keyword">SELECT</span> e.name <span class="keyword">AS</span> 员工，m.name <span class="keyword">AS</span> 上级领导</span><br><span class="line"><span class="keyword">FROM</span> employees_with_manager e</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> employees_with_manager m <span class="keyword">ON</span> e.manager_id <span class="operator">=</span> m.id;</span><br></pre></td></tr></table></figure>

<h2 id="十、子查询"><a href="#十、子查询" class="headerlink" title="十、子查询"></a>十、子查询</h2><p>子查询是嵌套在其他 SQL 语句中的查询。</p>
<h3 id="10-1-WHERE-子句中的子查询"><a href="#10-1-WHERE-子句中的子查询" class="headerlink" title="10.1 WHERE 子句中的子查询"></a>10.1 WHERE 子句中的子查询</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询工资高于平均工资的员工</span></span><br><span class="line"><span class="keyword">SELECT</span> name, salary <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> (<span class="keyword">SELECT</span> <span class="built_in">AVG</span>(salary) <span class="keyword">FROM</span> employees);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询工资最高的员工</span></span><br><span class="line"><span class="keyword">SELECT</span> name, salary <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="operator">=</span> (<span class="keyword">SELECT</span> <span class="built_in">MAX</span>(salary) <span class="keyword">FROM</span> employees);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询不在职的员工</span></span><br><span class="line"><span class="keyword">SELECT</span> name <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> id <span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="keyword">SELECT</span> id <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> status <span class="operator">=</span> <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<h3 id="10-2-FROM-子句中的子查询"><a href="#10-2-FROM-子句中的子查询" class="headerlink" title="10.2 FROM 子句中的子查询"></a>10.2 FROM 子句中的子查询</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询各部门平均工资及高于平均工资的员工</span></span><br><span class="line"><span class="keyword">SELECT</span> e.name, e.salary, d.avg_salary</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">JOIN</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> dept_id, <span class="built_in">AVG</span>(salary) <span class="keyword">AS</span> avg_salary</span><br><span class="line">    <span class="keyword">FROM</span> employees</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> dept_id</span><br><span class="line">) d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.dept_id</span><br><span class="line"><span class="keyword">WHERE</span> e.salary <span class="operator">&gt;</span> d.avg_salary;</span><br></pre></td></tr></table></figure>

<h3 id="10-3-SELECT-子句中的子查询"><a href="#10-3-SELECT-子句中的子查询" class="headerlink" title="10.3 SELECT 子句中的子查询"></a>10.3 SELECT 子句中的子查询</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询员工信息及公司平均工资</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    name,</span><br><span class="line">    salary,</span><br><span class="line">    (<span class="keyword">SELECT</span> <span class="built_in">AVG</span>(salary) <span class="keyword">FROM</span> employees) <span class="keyword">AS</span> 公司平均工资,</span><br><span class="line">    salary <span class="operator">-</span> (<span class="keyword">SELECT</span> <span class="built_in">AVG</span>(salary) <span class="keyword">FROM</span> employees) <span class="keyword">AS</span> 差异</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<h3 id="10-4-EXISTS-子查询"><a href="#10-4-EXISTS-子查询" class="headerlink" title="10.4 EXISTS 子查询"></a>10.4 EXISTS 子查询</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询有员工的部门</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> departments d</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">EXISTS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> employees e <span class="keyword">WHERE</span> e.dept_id <span class="operator">=</span> d.id</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 等价于</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> departments d</span><br><span class="line"><span class="keyword">WHERE</span> d.id <span class="keyword">IN</span> (<span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> dept_id <span class="keyword">FROM</span> employees);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询没有员工的部门</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> departments d</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> employees e <span class="keyword">WHERE</span> e.dept_id <span class="operator">=</span> d.id</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h2 id="十一、综合案例练习"><a href="#十一、综合案例练习" class="headerlink" title="十一、综合案例练习"></a>十一、综合案例练习</h2><h3 id="11-1-准备数据"><a href="#11-1-准备数据" class="headerlink" title="11.1 准备数据"></a>11.1 准备数据</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 学生表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> students;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> students (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    gender ENUM(<span class="string">&#x27;男&#x27;</span>, <span class="string">&#x27;女&#x27;</span>),</span><br><span class="line">    class_id <span class="type">INT</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 课程表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> courses;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> courses (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    course_name <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    credit <span class="type">INT</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 成绩表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> scores;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> scores (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    student_id <span class="type">INT</span>,</span><br><span class="line">    course_id <span class="type">INT</span>,</span><br><span class="line">    score <span class="type">DECIMAL</span>(<span class="number">5</span>, <span class="number">2</span>),</span><br><span class="line">    <span class="keyword">FOREIGN KEY</span> (student_id) <span class="keyword">REFERENCES</span> students(id),</span><br><span class="line">    <span class="keyword">FOREIGN KEY</span> (course_id) <span class="keyword">REFERENCES</span> courses(id)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> students (name, gender, class_id) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;张三&#x27;</span>, <span class="string">&#x27;男&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;李四&#x27;</span>, <span class="string">&#x27;女&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;王五&#x27;</span>, <span class="string">&#x27;男&#x27;</span>, <span class="number">2</span>),</span><br><span class="line">(<span class="string">&#x27;赵六&#x27;</span>, <span class="string">&#x27;女&#x27;</span>, <span class="number">2</span>), (<span class="string">&#x27;孙七&#x27;</span>, <span class="string">&#x27;男&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;周八&#x27;</span>, <span class="string">&#x27;女&#x27;</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> courses (course_name, credit) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;MySQL 基础&#x27;</span>, <span class="number">3</span>), (<span class="string">&#x27;Java 编程&#x27;</span>, <span class="number">4</span>), (<span class="string">&#x27;数据结构&#x27;</span>, <span class="number">4</span>), (<span class="string">&#x27;操作系统&#x27;</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> scores (student_id, course_id, score) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">1</span>, <span class="number">1</span>, <span class="number">85</span>), (<span class="number">1</span>, <span class="number">2</span>, <span class="number">90</span>), (<span class="number">1</span>, <span class="number">3</span>, <span class="number">78</span>),</span><br><span class="line">(<span class="number">2</span>, <span class="number">1</span>, <span class="number">92</span>), (<span class="number">2</span>, <span class="number">2</span>, <span class="number">88</span>), (<span class="number">2</span>, <span class="number">4</span>, <span class="number">95</span>),</span><br><span class="line">(<span class="number">3</span>, <span class="number">1</span>, <span class="number">75</span>), (<span class="number">3</span>, <span class="number">3</span>, <span class="number">82</span>),</span><br><span class="line">(<span class="number">4</span>, <span class="number">2</span>, <span class="number">88</span>), (<span class="number">4</span>, <span class="number">4</span>, <span class="number">91</span>),</span><br><span class="line">(<span class="number">5</span>, <span class="number">1</span>, <span class="number">60</span>), (<span class="number">5</span>, <span class="number">2</span>, <span class="number">65</span>), (<span class="number">5</span>, <span class="number">3</span>, <span class="number">70</span>);</span><br></pre></td></tr></table></figure>

<h3 id="11-2-案例练习"><a href="#11-2-案例练习" class="headerlink" title="11.2 案例练习"></a>11.2 案例练习</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 练习 1：查询所有学生的姓名、性别、班级 ID</span></span><br><span class="line"><span class="keyword">SELECT</span> name, gender, class_id <span class="keyword">FROM</span> students;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 练习 2：查询女生名单</span></span><br><span class="line"><span class="keyword">SELECT</span> name <span class="keyword">FROM</span> students <span class="keyword">WHERE</span> gender <span class="operator">=</span> <span class="string">&#x27;女&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 练习 3：查询成绩大于 80 分的学生姓名和课程名</span></span><br><span class="line"><span class="keyword">SELECT</span> s.name, c.course_name, sc.score</span><br><span class="line"><span class="keyword">FROM</span> students s</span><br><span class="line"><span class="keyword">JOIN</span> scores sc <span class="keyword">ON</span> s.id <span class="operator">=</span> sc.student_id</span><br><span class="line"><span class="keyword">JOIN</span> courses c <span class="keyword">ON</span> sc.course_id <span class="operator">=</span> c.id</span><br><span class="line"><span class="keyword">WHERE</span> sc.score <span class="operator">&gt;</span> <span class="number">80</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 练习 4：查询每个学生的平均分</span></span><br><span class="line"><span class="keyword">SELECT</span> s.name, ROUND(<span class="built_in">AVG</span>(sc.score), <span class="number">2</span>) <span class="keyword">AS</span> 平均分</span><br><span class="line"><span class="keyword">FROM</span> students s</span><br><span class="line"><span class="keyword">JOIN</span> scores sc <span class="keyword">ON</span> s.id <span class="operator">=</span> sc.student_id</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> s.id, s.name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 练习 5：查询平均分大于 80 的学生</span></span><br><span class="line"><span class="keyword">SELECT</span> s.name, ROUND(<span class="built_in">AVG</span>(sc.score), <span class="number">2</span>) <span class="keyword">AS</span> 平均分</span><br><span class="line"><span class="keyword">FROM</span> students s</span><br><span class="line"><span class="keyword">JOIN</span> scores sc <span class="keyword">ON</span> s.id <span class="operator">=</span> sc.student_id</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> s.id, s.name</span><br><span class="line"><span class="keyword">HAVING</span> <span class="built_in">AVG</span>(sc.score) <span class="operator">&gt;</span> <span class="number">80</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 练习 6：查询每门课程的平均分</span></span><br><span class="line"><span class="keyword">SELECT</span> c.course_name, ROUND(<span class="built_in">AVG</span>(sc.score), <span class="number">2</span>) <span class="keyword">AS</span> 平均分</span><br><span class="line"><span class="keyword">FROM</span> courses c</span><br><span class="line"><span class="keyword">JOIN</span> scores sc <span class="keyword">ON</span> c.id <span class="operator">=</span> sc.course_id</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> c.id, c.course_name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 练习 7：查询成绩最高的学生姓名、课程名和分数</span></span><br><span class="line"><span class="keyword">SELECT</span> s.name, c.course_name, sc.score</span><br><span class="line"><span class="keyword">FROM</span> students s</span><br><span class="line"><span class="keyword">JOIN</span> scores sc <span class="keyword">ON</span> s.id <span class="operator">=</span> sc.student_id</span><br><span class="line"><span class="keyword">JOIN</span> courses c <span class="keyword">ON</span> sc.course_id <span class="operator">=</span> c.id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> sc.score <span class="keyword">DESC</span></span><br><span class="line">LIMIT <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 练习 8：查询至少选修了 2 门课程的学生</span></span><br><span class="line"><span class="keyword">SELECT</span> s.name, <span class="built_in">COUNT</span>(sc.course_id) <span class="keyword">AS</span> 选课数</span><br><span class="line"><span class="keyword">FROM</span> students s</span><br><span class="line"><span class="keyword">JOIN</span> scores sc <span class="keyword">ON</span> s.id <span class="operator">=</span> sc.student_id</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> s.id, s.name</span><br><span class="line"><span class="keyword">HAVING</span> <span class="built_in">COUNT</span>(sc.course_id) <span class="operator">&gt;=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 练习 9：查询没有选课的学生</span></span><br><span class="line"><span class="keyword">SELECT</span> name <span class="keyword">FROM</span> students</span><br><span class="line"><span class="keyword">WHERE</span> id <span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> student_id <span class="keyword">FROM</span> scores);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 练习 10：查询每个班级的学生人数</span></span><br><span class="line"><span class="keyword">SELECT</span> class_id, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> 人数</span><br><span class="line"><span class="keyword">FROM</span> students</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> class_id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 练习 11：查询班级平均成绩</span></span><br><span class="line"><span class="keyword">SELECT</span> s.class_id, ROUND(<span class="built_in">AVG</span>(sc.score), <span class="number">2</span>) <span class="keyword">AS</span> 班级平均分</span><br><span class="line"><span class="keyword">FROM</span> students s</span><br><span class="line"><span class="keyword">JOIN</span> scores sc <span class="keyword">ON</span> s.id <span class="operator">=</span> sc.student_id</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> s.class_id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 练习 12：综合查询（分页）</span></span><br><span class="line"><span class="keyword">SELECT</span> s.name, c.course_name, sc.score</span><br><span class="line"><span class="keyword">FROM</span> students s</span><br><span class="line"><span class="keyword">JOIN</span> scores sc <span class="keyword">ON</span> s.id <span class="operator">=</span> sc.student_id</span><br><span class="line"><span class="keyword">JOIN</span> courses c <span class="keyword">ON</span> sc.course_id <span class="operator">=</span> c.id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> sc.score <span class="keyword">DESC</span></span><br><span class="line">LIMIT <span class="number">0</span>, <span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<h2 id="十二、DQL-执行顺序"><a href="#十二、DQL-执行顺序" class="headerlink" title="十二、DQL 执行顺序"></a>十二、DQL 执行顺序</h2><p>理解 SQL 的执行顺序对于编写高效查询至关重要。</p>
<h3 id="12-1-完整执行顺序"><a href="#12-1-完整执行顺序" class="headerlink" title="12.1 完整执行顺序"></a>12.1 完整执行顺序</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">FROM → JOIN → WHERE → GROUP BY → HAVING → SELECT → DISTINCT → ORDER BY → LIMIT</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">(1) FROM 表名</span><br><span class="line">(2) [JOIN 表名 ON 连接条件]</span><br><span class="line">(3) WHERE 条件</span><br><span class="line">(4) GROUP BY 分组列</span><br><span class="line">(5) HAVING 分组过滤</span><br><span class="line">(6) SELECT 列名</span><br><span class="line">(7) DISTINCT 去重</span><br><span class="line">(8) ORDER BY 排序</span><br><span class="line">(9) LIMIT 分页</span><br></pre></td></tr></table></figure>

<h3 id="12-2-执行顺序详解"><a href="#12-2-执行顺序详解" class="headerlink" title="12.2 执行顺序详解"></a>12.2 执行顺序详解</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 示例 SQL</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    d.dept_name,</span><br><span class="line">    <span class="built_in">COUNT</span>(e.id) <span class="keyword">AS</span> emp_count,</span><br><span class="line">    <span class="built_in">AVG</span>(e.salary) <span class="keyword">AS</span> avg_salary</span><br><span class="line"><span class="keyword">FROM</span> departments d</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> employees e <span class="keyword">ON</span> d.id <span class="operator">=</span> e.dept_id</span><br><span class="line"><span class="keyword">WHERE</span> e.status <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> d.id, d.dept_name</span><br><span class="line"><span class="keyword">HAVING</span> <span class="built_in">COUNT</span>(e.id) <span class="operator">&gt;</span> <span class="number">2</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> avg_salary <span class="keyword">DESC</span></span><br><span class="line">LIMIT <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 执行步骤：</span></span><br><span class="line"><span class="comment">-- 1. FROM departments: 读取部门表</span></span><br><span class="line"><span class="comment">-- 2. LEFT JOIN employees: 连接员工表</span></span><br><span class="line"><span class="comment">-- 3. WHERE e.status = 1: 过滤在职员工</span></span><br><span class="line"><span class="comment">-- 4. GROUP BY d.id, d.dept_name: 按部门分组</span></span><br><span class="line"><span class="comment">-- 5. HAVING COUNT(e.id) &gt; 2: 过滤人数大于 2 的部门</span></span><br><span class="line"><span class="comment">-- 6. SELECT: 计算 dept_name, emp_count, avg_salary</span></span><br><span class="line"><span class="comment">-- 7. ORDER BY avg_salary DESC: 按平均工资降序排序</span></span><br><span class="line"><span class="comment">-- 8. LIMIT 5: 只返回前 5 条</span></span><br></pre></td></tr></table></figure>

<h3 id="12-3-常见错误"><a href="#12-3-常见错误" class="headerlink" title="12.3 常见错误"></a>12.3 常见错误</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 错误 1：WHERE 中使用列别名</span></span><br><span class="line"><span class="keyword">SELECT</span> salary <span class="keyword">AS</span> monthly_salary <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> monthly_salary <span class="operator">&gt;</span> <span class="number">8000</span>;  <span class="comment">-- 错误！WHERE 在 SELECT 之前执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 正确写法</span></span><br><span class="line"><span class="keyword">SELECT</span> salary <span class="keyword">AS</span> monthly_salary <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> <span class="number">8000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 错误 2：HAVING 中使用列位置</span></span><br><span class="line"><span class="keyword">SELECT</span> dept_id, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> dept_id</span><br><span class="line"><span class="keyword">HAVING</span> <span class="number">2</span> <span class="operator">&gt;</span> <span class="number">2</span>;  <span class="comment">-- 某些数据库支持，但不推荐</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 正确写法</span></span><br><span class="line"><span class="keyword">SELECT</span> dept_id, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> dept_id</span><br><span class="line"><span class="keyword">HAVING</span> cnt <span class="operator">&gt;</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 错误 3：WHERE 中使用聚合函数</span></span><br><span class="line"><span class="keyword">SELECT</span> dept_id <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="operator">&gt;</span> <span class="number">2</span>  <span class="comment">-- 错误！</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> dept_id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 正确写法</span></span><br><span class="line"><span class="keyword">SELECT</span> dept_id <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> dept_id</span><br><span class="line"><span class="keyword">HAVING</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="operator">&gt;</span> <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<h3 id="12-4-性能优化建议"><a href="#12-4-性能优化建议" class="headerlink" title="12.4 性能优化建议"></a>12.4 性能优化建议</h3><p>基于执行顺序的优化：</p>
<ol>
<li><strong>WHERE 条件尽可能早地过滤数据</strong></li>
</ol>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 好：先过滤再连接</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">JOIN</span> departments d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.id</span><br><span class="line"><span class="keyword">WHERE</span> e.salary <span class="operator">&gt;</span> <span class="number">8000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 差：连接后再过滤（某些情况下）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> e.<span class="operator">*</span>, d.dept_name <span class="keyword">FROM</span> employees e</span><br><span class="line">    <span class="keyword">JOIN</span> departments d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.id</span><br><span class="line">) temp</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> <span class="number">8000</span>;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>使用索引列进行连接和过滤</strong></li>
</ol>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 确保连接列和 WHERE 列有索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_dept_id <span class="keyword">ON</span> employees(dept_id);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_salary <span class="keyword">ON</span> employees(salary);</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>**避免 SELECT ***</li>
</ol>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 只选择需要的列</span></span><br><span class="line"><span class="keyword">SELECT</span> name, salary <span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<h2 id="十三、小结（下）"><a href="#十三、小结（下）" class="headerlink" title="十三、小结（下）"></a>十三、小结（下）</h2><h3 id="知识点回顾"><a href="#知识点回顾" class="headerlink" title="知识点回顾"></a>知识点回顾</h3><ol>
<li><p><strong>排序查询（ORDER BY）</strong></p>
<ul>
<li>ASC&#x2F;DESC 升序降序</li>
<li>多列排序</li>
<li>自定义排序顺序</li>
</ul>
</li>
<li><p><strong>分页查询（LIMIT）</strong></p>
<ul>
<li>LIMIT offset, count</li>
<li>分页公式：(页码 -1) * 每页条数</li>
<li>大数据量分页优化</li>
</ul>
</li>
<li><p><strong>连接查询</strong></p>
<ul>
<li>INNER JOIN 内连接</li>
<li>LEFT JOIN 左连接</li>
<li>RIGHT JOIN 右连接</li>
<li>CROSS JOIN 交叉连接</li>
<li>自连接</li>
</ul>
</li>
<li><p><strong>子查询</strong></p>
<ul>
<li>WHERE 子查询</li>
<li>FROM 子查询</li>
<li>SELECT 子查询</li>
<li>EXISTS 子查询</li>
</ul>
</li>
<li><p><strong>执行顺序</strong></p>
<ul>
<li>FROM → JOIN → WHERE → GROUP BY → HAVING → SELECT → ORDER BY → LIMIT</li>
</ul>
</li>
</ol>
<h3 id="DQL-完整语法结构"><a href="#DQL-完整语法结构" class="headerlink" title="DQL 完整语法结构"></a>DQL 完整语法结构</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> [<span class="keyword">DISTINCT</span>] 列名 [<span class="keyword">AS</span> 别名], ...</span><br><span class="line"><span class="keyword">FROM</span> 表名 [<span class="keyword">AS</span> 别名]</span><br><span class="line">[<span class="keyword">INNER</span> <span class="operator">|</span> <span class="keyword">LEFT</span> <span class="operator">|</span> <span class="keyword">RIGHT</span> <span class="operator">|</span> <span class="keyword">FULL</span>] <span class="keyword">JOIN</span> 表名 <span class="keyword">ON</span> 连接条件</span><br><span class="line">[<span class="keyword">WHERE</span> 条件]</span><br><span class="line">[<span class="keyword">GROUP</span> <span class="keyword">BY</span> 分组列 [<span class="keyword">HAVING</span> 分组过滤条件]]</span><br><span class="line">[<span class="keyword">ORDER</span> <span class="keyword">BY</span> 排序列 [<span class="keyword">ASC</span> <span class="operator">|</span> <span class="keyword">DESC</span>]]</span><br><span class="line">[LIMIT [<span class="keyword">offset</span>,] count];</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>下一篇</strong>：[MySQL 基础教程（五）：DCL 数据控制语言详解](&#x2F;2026&#x2F;02&#x2F;23&#x2F;MySQL 基础教程（五）DCL 数据控制语言详解&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 基础教程（四）DQL 数据查询语言详解（上）](&#x2F;2026&#x2F;02&#x2F;23&#x2F;MySQL 基础教程（四）DQL 数据查询语言详解（上）&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 基础教程</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>DQL</tag>
        <tag>数据查询</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 基础教程（五）DCL 数据控制语言详解</title>
    <url>/2026/02/23/MySQL%20%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B%EF%BC%88%E4%BA%94%EF%BC%89DCL%20%E6%95%B0%E6%8D%AE%E6%8E%A7%E5%88%B6%E8%AF%AD%E8%A8%80%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<h1 id="MySQL-基础教程（五）DCL-数据控制语言详解"><a href="#MySQL-基础教程（五）DCL-数据控制语言详解" class="headerlink" title="MySQL 基础教程（五）DCL 数据控制语言详解"></a>MySQL 基础教程（五）DCL 数据控制语言详解</h1><p>DCL（Data Control Language，数据控制语言）用于管理数据库权限和事务控制。本文我们将学习如何创建用户、管理权限，以及事务控制的相关知识。</p>
<h2 id="一、DCL-概述"><a href="#一、DCL-概述" class="headerlink" title="一、DCL 概述"></a>一、DCL 概述</h2><p>DCL 主要包含两类操作：</p>
<ol>
<li><strong>权限管理</strong>：GRANT（授权）、REVOKE（撤销权限）</li>
<li><strong>事务控制</strong>：COMMIT（提交）、ROLLBACK（回滚）、SAVEPOINT（保存点）</li>
</ol>
<table>
<thead>
<tr>
<th>命令</th>
<th>功能</th>
<th>分类</th>
</tr>
</thead>
<tbody><tr>
<td>GRANT</td>
<td>授予用户权限</td>
<td>权限管理</td>
</tr>
<tr>
<td>REVOKE</td>
<td>撤销用户权限</td>
<td>权限管理</td>
</tr>
<tr>
<td>COMMIT</td>
<td>提交事务</td>
<td>事务控制</td>
</tr>
<tr>
<td>ROLLBACK</td>
<td>回滚事务</td>
<td>事务控制</td>
</tr>
<tr>
<td>SAVEPOINT</td>
<td>设置保存点</td>
<td>事务控制</td>
</tr>
</tbody></table>
<h2 id="二、用户管理"><a href="#二、用户管理" class="headerlink" title="二、用户管理"></a>二、用户管理</h2><h3 id="2-1-用户表结构"><a href="#2-1-用户表结构" class="headerlink" title="2.1 用户表结构"></a>2.1 用户表结构</h3><p>MySQL 的用户信息存储在 <code>mysql.user</code> 表中：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看所有用户</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">user</span>, host <span class="keyword">FROM</span> mysql.user;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看用户详细信息</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">user</span>, host, authentication_string, plugin <span class="keyword">FROM</span> mysql.user;</span><br></pre></td></tr></table></figure>

<p><strong>用户名的组成</strong>：<code>&#39;username&#39;@&#39;host&#39;</code></p>
<ul>
<li><code>username</code>：用户名</li>
<li><code>host</code>：允许连接的主机<ul>
<li><code>localhost</code>：仅本地连接</li>
<li><code>%</code>：允许任何主机连接</li>
<li><code>192.168.1.%</code>：允许特定网段连接</li>
</ul>
</li>
</ul>
<h3 id="2-2-创建用户（CREATE-USER）"><a href="#2-2-创建用户（CREATE-USER）" class="headerlink" title="2.2 创建用户（CREATE USER）"></a>2.2 创建用户（CREATE USER）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 基础语法</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;用户名&#x27;</span>@<span class="string">&#x27;主机&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;密码&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建仅本地登录的用户</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;local_user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;password123&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建可远程登录的用户（任何主机）</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;remote_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;password123&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建允许特定网段登录的用户</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;app_user&#x27;</span>@<span class="string">&#x27;192.168.1.%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;password123&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建用户时不设置密码（不推荐）</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;nopass_user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建用户并指定密码过期策略</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;temp_user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span></span><br><span class="line">IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;password123&#x27;</span></span><br><span class="line">PASSWORD EXPIRE <span class="type">INTERVAL</span> <span class="number">90</span> <span class="keyword">DAY</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建用户并限制连接数</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;limited_user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span></span><br><span class="line">IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;password123&#x27;</span></span><br><span class="line"><span class="keyword">WITH</span> MAX_USER_CONNECTIONS <span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-修改用户（ALTER-USER）"><a href="#2-3-修改用户（ALTER-USER）" class="headerlink" title="2.3 修改用户（ALTER USER）"></a>2.3 修改用户（ALTER USER）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 修改用户密码（MySQL 5.7.6+）</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">USER</span> <span class="string">&#x27;local_user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;new_password&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改用户密码（MySQL 5.7.6 之前）</span></span><br><span class="line"><span class="keyword">SET</span> PASSWORD <span class="keyword">FOR</span> <span class="string">&#x27;local_user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> <span class="operator">=</span> PASSWORD(<span class="string">&#x27;new_password&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 解锁用户</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">USER</span> <span class="string">&#x27;local_user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> ACCOUNT UNLOCK;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 锁定用户</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">USER</span> <span class="string">&#x27;local_user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> ACCOUNT LOCK;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置密码过期</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">USER</span> <span class="string">&#x27;local_user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> PASSWORD EXPIRE;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置密码永不过期</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">USER</span> <span class="string">&#x27;local_user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> PASSWORD EXPIRE NEVER;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改主机权限（先删除再创建）</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">USER</span> <span class="string">&#x27;local_user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;local_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;password123&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-删除用户（DROP-USER）"><a href="#2-4-删除用户（DROP-USER）" class="headerlink" title="2.4 删除用户（DROP USER）"></a>2.4 删除用户（DROP USER）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 删除用户</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">USER</span> <span class="string">&#x27;local_user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除多个用户</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">USER</span> <span class="string">&#x27;user1&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>, <span class="string">&#x27;user2&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除不存在的用户（MySQL 8.0+ 支持 IF EXISTS）</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">USER</span> IF <span class="keyword">EXISTS</span> <span class="string">&#x27;nonexistent&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="2-5-查看用户权限"><a href="#2-5-查看用户权限" class="headerlink" title="2.5 查看用户权限"></a>2.5 查看用户权限</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看当前用户</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">USER</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看当前登录用户的所有权限</span></span><br><span class="line"><span class="keyword">SHOW</span> GRANTS;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看指定用户的权限</span></span><br><span class="line"><span class="keyword">SHOW</span> GRANTS <span class="keyword">FOR</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看用户表</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">user</span>, host, Select_priv, Insert_priv, Update_priv, Delete_priv</span><br><span class="line"><span class="keyword">FROM</span> mysql.user;</span><br></pre></td></tr></table></figure>

<h2 id="三、权限管理"><a href="#三、权限管理" class="headerlink" title="三、权限管理"></a>三、权限管理</h2><h3 id="3-1-权限类型"><a href="#3-1-权限类型" class="headerlink" title="3.1 权限类型"></a>3.1 权限类型</h3><p>MySQL 支持多种权限类型，按作用范围分为：</p>
<table>
<thead>
<tr>
<th>权限级别</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>全局权限</td>
<td>作用于所有数据库</td>
<td><code>GRANT SELECT ON *.*</code></td>
</tr>
<tr>
<td>数据库权限</td>
<td>作用于特定数据库</td>
<td><code>GRANT SELECT ON db.*</code></td>
</tr>
<tr>
<td>表权限</td>
<td>作用于特定表</td>
<td><code>GRANT SELECT ON db.table</code></td>
</tr>
<tr>
<td>列权限</td>
<td>作用于特定列</td>
<td><code>GRANT SELECT(id, name) ON db.table</code></td>
</tr>
<tr>
<td>存储过程权限</td>
<td>作用于存储过程</td>
<td><code>GRANT EXECUTE ON PROCEDURE db.proc</code></td>
</tr>
</tbody></table>
<p><strong>常用权限</strong>：</p>
<table>
<thead>
<tr>
<th>权限</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>SELECT</td>
<td>查询权限</td>
</tr>
<tr>
<td>INSERT</td>
<td>插入权限</td>
</tr>
<tr>
<td>UPDATE</td>
<td>更新权限</td>
</tr>
<tr>
<td>DELETE</td>
<td>删除权限</td>
</tr>
<tr>
<td>CREATE</td>
<td>创建数据库&#x2F;表权限</td>
</tr>
<tr>
<td>DROP</td>
<td>删除数据库&#x2F;表权限</td>
</tr>
<tr>
<td>ALTER</td>
<td>修改表结构权限</td>
</tr>
<tr>
<td>INDEX</td>
<td>创建&#x2F;删除索引权限</td>
</tr>
<tr>
<td>CREATE VIEW</td>
<td>创建视图权限</td>
</tr>
<tr>
<td>EXECUTE</td>
<td>执行存储过程权限</td>
</tr>
<tr>
<td>TRIGGER</td>
<td>触发器权限</td>
</tr>
<tr>
<td>ALL PRIVILEGES</td>
<td>所有权限</td>
</tr>
<tr>
<td>GRANT OPTION</td>
<td>授权权限</td>
</tr>
</tbody></table>
<h3 id="3-2-授予权限（GRANT）"><a href="#3-2-授予权限（GRANT）" class="headerlink" title="3.2 授予权限（GRANT）"></a>3.2 授予权限（GRANT）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 基础语法</span></span><br><span class="line"><span class="keyword">GRANT</span> 权限列表 <span class="keyword">ON</span> 数据库。表 <span class="keyword">TO</span> <span class="string">&#x27;用户名&#x27;</span>@<span class="string">&#x27;主机&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 授予所有权限（慎用！）</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;admin&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 授予全局查询权限</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;reader&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 授予特定数据库的所有权限</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> mydb.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;dbuser&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 授予特定表的部分权限</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span>, <span class="keyword">INSERT</span>, <span class="keyword">UPDATE</span> <span class="keyword">ON</span> mydb.employees <span class="keyword">TO</span> <span class="string">&#x27;hr&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 授予特定列的权限</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span>(id, name, salary) <span class="keyword">ON</span> mydb.employees <span class="keyword">TO</span> <span class="string">&#x27;manager&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 授予存储过程执行权限</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">EXECUTE</span> <span class="keyword">ON</span> <span class="keyword">PROCEDURE</span> mydb.get_employee <span class="keyword">TO</span> <span class="string">&#x27;app&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 授予创建数据库权限</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">CREATE</span> <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;developer&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 授予授权权限（允许该用户再授权给其他人）</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> mydb.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;reader&#x27;</span>@<span class="string">&#x27;%&#x27;</span> <span class="keyword">WITH</span> <span class="keyword">GRANT</span> OPTION;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 授予文件权限（可读写服务器文件，危险！）</span></span><br><span class="line"><span class="keyword">GRANT</span> FILE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;data_importer&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>权限范围语法</strong>：</p>
<ul>
<li><code>*.*</code>：所有数据库的所有表</li>
<li><code>db.*</code>：特定数据库的所有表</li>
<li><code>db.table</code>：特定数据库的特定表</li>
</ul>
<h3 id="3-3-撤销权限（REVOKE）"><a href="#3-3-撤销权限（REVOKE）" class="headerlink" title="3.3 撤销权限（REVOKE）"></a>3.3 撤销权限（REVOKE）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 基础语法</span></span><br><span class="line"><span class="keyword">REVOKE</span> 权限列表 <span class="keyword">ON</span> 数据库。表 <span class="keyword">FROM</span> <span class="string">&#x27;用户名&#x27;</span>@<span class="string">&#x27;主机&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 撤销所有权限</span></span><br><span class="line"><span class="keyword">REVOKE</span> <span class="keyword">ALL</span> PRIVILEGES, <span class="keyword">GRANT</span> OPTION <span class="keyword">FROM</span> <span class="string">&#x27;user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 撤销特定权限</span></span><br><span class="line"><span class="keyword">REVOKE</span> <span class="keyword">DELETE</span>, <span class="keyword">UPDATE</span> <span class="keyword">ON</span> mydb.employees <span class="keyword">FROM</span> <span class="string">&#x27;hr&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 撤销全局权限</span></span><br><span class="line"><span class="keyword">REVOKE</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">FROM</span> <span class="string">&#x27;reader&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 撤销授权权限</span></span><br><span class="line"><span class="keyword">REVOKE</span> <span class="keyword">GRANT</span> OPTION <span class="keyword">ON</span> mydb.<span class="operator">*</span> <span class="keyword">FROM</span> <span class="string">&#x27;manager&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-4-权限刷新"><a href="#3-4-权限刷新" class="headerlink" title="3.4 权限刷新"></a>3.4 权限刷新</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 刷新权限（修改权限表后生效）</span></span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：使用 GRANT 和 REVOKE 修改权限后会自动生效，不需要 FLUSH PRIVILEGES。只有直接修改 <code>mysql.user</code> 表后才需要刷新。</p>
<h3 id="3-5-权限查看与继承"><a href="#3-5-权限查看与继承" class="headerlink" title="3.5 权限查看与继承"></a>3.5 权限查看与继承</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看当前用户权限</span></span><br><span class="line"><span class="keyword">SHOW</span> GRANTS;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看其他用户权限</span></span><br><span class="line"><span class="keyword">SHOW</span> GRANTS <span class="keyword">FOR</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看具有全局 SELECT 权限的用户</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">user</span>, host <span class="keyword">FROM</span> mysql.user <span class="keyword">WHERE</span> Select_priv <span class="operator">=</span> <span class="string">&#x27;Y&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>权限继承规则</strong>：</p>
<ul>
<li>全局权限 &gt; 数据库权限 &gt; 表权限 &gt; 列权限</li>
<li>用户拥有多个权限时，取并集</li>
</ul>
<h2 id="四、角色管理（MySQL-8-0-）"><a href="#四、角色管理（MySQL-8-0-）" class="headerlink" title="四、角色管理（MySQL 8.0+）"></a>四、角色管理（MySQL 8.0+）</h2><p>角色是一组权限的集合，可以分配给用户。</p>
<h3 id="4-1-创建角色"><a href="#4-1-创建角色" class="headerlink" title="4.1 创建角色"></a>4.1 创建角色</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建角色</span></span><br><span class="line"><span class="keyword">CREATE</span> ROLE <span class="string">&#x27;read_only&#x27;</span>;</span><br><span class="line"><span class="keyword">CREATE</span> ROLE <span class="string">&#x27;app_read&#x27;</span>, <span class="string">&#x27;app_write&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看角色</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> mysql.default_roles;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-给角色授权"><a href="#4-2-给角色授权" class="headerlink" title="4.2 给角色授权"></a>4.2 给角色授权</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 给角色授予权限</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> mydb.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;read_only&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span>, <span class="keyword">INSERT</span> <span class="keyword">ON</span> mydb.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;app_read&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">INSERT</span>, <span class="keyword">UPDATE</span>, <span class="keyword">DELETE</span> <span class="keyword">ON</span> mydb.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;app_write&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-给用户分配角色"><a href="#4-3-给用户分配角色" class="headerlink" title="4.3 给用户分配角色"></a>4.3 给用户分配角色</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 给用户分配角色</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="string">&#x27;read_only&#x27;</span> <span class="keyword">TO</span> <span class="string">&#x27;user1&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="string">&#x27;app_read&#x27;</span>, <span class="string">&#x27;app_write&#x27;</span> <span class="keyword">TO</span> <span class="string">&#x27;app_user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置默认角色</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">DEFAULT</span> ROLE <span class="string">&#x27;read_only&#x27;</span> <span class="keyword">TO</span> <span class="string">&#x27;user1&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看用户的角色</span></span><br><span class="line"><span class="keyword">SHOW</span> GRANTS <span class="keyword">FOR</span> <span class="string">&#x27;user1&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="4-4-激活角色"><a href="#4-4-激活角色" class="headerlink" title="4.4 激活角色"></a>4.4 激活角色</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 激活所有角色</span></span><br><span class="line"><span class="keyword">SET</span> ROLE <span class="keyword">ALL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 激活特定角色</span></span><br><span class="line"><span class="keyword">SET</span> ROLE <span class="string">&#x27;read_only&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 激活所有默认角色</span></span><br><span class="line"><span class="keyword">SET</span> ROLE <span class="keyword">DEFAULT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看当前激活的角色</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">CURRENT_ROLE</span>();</span><br></pre></td></tr></table></figure>

<h3 id="4-5-撤销角色"><a href="#4-5-撤销角色" class="headerlink" title="4.5 撤销角色"></a>4.5 撤销角色</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 撤销用户的角色</span></span><br><span class="line"><span class="keyword">REVOKE</span> <span class="string">&#x27;read_only&#x27;</span> <span class="keyword">FROM</span> <span class="string">&#x27;user1&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除角色</span></span><br><span class="line"><span class="keyword">DROP</span> ROLE <span class="string">&#x27;read_only&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="五、事务控制"><a href="#五、事务控制" class="headerlink" title="五、事务控制"></a>五、事务控制</h2><h3 id="5-1-事务基础"><a href="#5-1-事务基础" class="headerlink" title="5.1 事务基础"></a>5.1 事务基础</h3><p>事务是一组原子性的 SQL 操作，要么全部成功，要么全部失败。</p>
<p><strong>事务的 ACID 特性</strong>：</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>原子性（Atomicity）</td>
<td>事务是不可分割的最小单位</td>
</tr>
<tr>
<td>一致性（Consistency）</td>
<td>事务执行前后数据保持一致</td>
</tr>
<tr>
<td>隔离性（Isolation）</td>
<td>并发事务互不干扰</td>
</tr>
<tr>
<td>持久性（Durability）</td>
<td>事务提交后永久保存</td>
</tr>
</tbody></table>
<h3 id="5-2-事务操作"><a href="#5-2-事务操作" class="headerlink" title="5.2 事务操作"></a>5.2 事务操作</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看自动提交状态</span></span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@autocommit</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 关闭自动提交</span></span><br><span class="line"><span class="keyword">SET</span> autocommit <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 开启事务</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="comment">-- 或</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 执行 DML 操作</span></span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">-</span> <span class="number">100</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">+</span> <span class="number">100</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 提交事务</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 回滚事务</span></span><br><span class="line"><span class="keyword">ROLLBACK</span>;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-保存点（SAVEPOINT）"><a href="#5-3-保存点（SAVEPOINT）" class="headerlink" title="5.3 保存点（SAVEPOINT）"></a>5.3 保存点（SAVEPOINT）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 开始事务</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 第一条操作</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (order_no, amount) <span class="keyword">VALUES</span> (<span class="string">&#x27;ORD001&#x27;</span>, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置保存点</span></span><br><span class="line"><span class="keyword">SAVEPOINT</span> sp1;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 第二条操作</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (order_no, amount) <span class="keyword">VALUES</span> (<span class="string">&#x27;ORD002&#x27;</span>, <span class="number">200</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置保存点</span></span><br><span class="line"><span class="keyword">SAVEPOINT</span> sp2;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 第三条操作（假设出错了）</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (order_no, amount) <span class="keyword">VALUES</span> (<span class="string">&#x27;ORD003&#x27;</span>, <span class="number">300</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 回滚到保存点 sp2</span></span><br><span class="line"><span class="keyword">ROLLBACK</span> <span class="keyword">TO</span> sp2;  <span class="comment">-- ORD003 被撤销</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 提交事务（ORD001 和 ORD002 保留）</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 释放保存点</span></span><br><span class="line"><span class="keyword">RELEASE</span> <span class="keyword">SAVEPOINT</span> sp1;</span><br></pre></td></tr></table></figure>

<h3 id="5-4-事务隔离级别"><a href="#5-4-事务隔离级别" class="headerlink" title="5.4 事务隔离级别"></a>5.4 事务隔离级别</h3><p>MySQL 支持四种事务隔离级别：</p>
<table>
<thead>
<tr>
<th>隔离级别</th>
<th>脏读</th>
<th>不可重复读</th>
<th>幻读</th>
</tr>
</thead>
<tbody><tr>
<td>READ UNCOMMITTED</td>
<td>可能</td>
<td>可能</td>
<td>可能</td>
</tr>
<tr>
<td>READ COMMITTED</td>
<td>否</td>
<td>可能</td>
<td>可能</td>
</tr>
<tr>
<td>REPEATABLE READ（默认）</td>
<td>否</td>
<td>否</td>
<td>可能</td>
</tr>
<tr>
<td>SERIALIZABLE</td>
<td>否</td>
<td>否</td>
<td>否</td>
</tr>
</tbody></table>
<p><strong>并发读问题</strong>：</p>
<ul>
<li><strong>脏读</strong>：读到其他事务未提交的数据</li>
<li><strong>不可重复读</strong>：同一事务中多次读取结果不一致</li>
<li><strong>幻读</strong>：同一事务中多次查询，记录数不一致</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看当前隔离级别</span></span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@transaction_isolation</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置隔离级别（会话级）</span></span><br><span class="line"><span class="keyword">SET</span> SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置隔离级别（全局级）</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> TRANSACTION ISOLATION LEVEL READ COMMITTED;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置隔离级别（在事务开始前）</span></span><br><span class="line"><span class="keyword">SET</span> TRANSACTION ISOLATION LEVEL SERIALIZABLE;</span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br></pre></td></tr></table></figure>

<p><strong>MySQL InnoDB 的隔离级别特点</strong>：</p>
<ul>
<li>默认使用 <code>REPEATABLE READ</code></li>
<li>通过 MVCC（多版本并发控制）避免了幻读</li>
<li><code>READ COMMITTED</code> 下会使用不同的锁定策略</li>
</ul>
<h3 id="5-5-锁机制"><a href="#5-5-锁机制" class="headerlink" title="5.5 锁机制"></a>5.5 锁机制</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看锁信息</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.innodb_locks;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.innodb_lock_waits;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看正在执行的事务</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.innodb_trx;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 表锁</span></span><br><span class="line">LOCK TABLES employees READ;   <span class="comment">-- 读锁</span></span><br><span class="line">LOCK TABLES employees WRITE;  <span class="comment">-- 写锁</span></span><br><span class="line">UNLOCK TABLES;                <span class="comment">-- 解锁</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 行锁（InnoDB 自动加锁，无需手动）</span></span><br><span class="line"><span class="comment">-- 在 SELECT 时加锁</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;  <span class="comment">-- 排他锁</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span> LOCK <span class="keyword">IN</span> SHARE MODE;  <span class="comment">-- 共享锁（8.0 语法已变更）</span></span><br></pre></td></tr></table></figure>

<p><strong>MySQL 8.0 新的锁语法</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 共享锁</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">FOR</span> SHARE;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 排他锁</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 跳过锁定的行</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span> <span class="keyword">SKIP</span> LOCKED;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 等待锁超时</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span> NOWAIT;</span><br></pre></td></tr></table></figure>

<h2 id="六、实战案例"><a href="#六、实战案例" class="headerlink" title="六、实战案例"></a>六、实战案例</h2><h3 id="6-1-创建应用数据库和用户"><a href="#6-1-创建应用数据库和用户" class="headerlink" title="6.1 创建应用数据库和用户"></a>6.1 创建应用数据库和用户</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 1. 创建数据库</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> webapp</span><br><span class="line"><span class="keyword">CHARACTER SET</span> utf8mb4</span><br><span class="line"><span class="keyword">COLLATE</span> utf8mb4_unicode_ci;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 创建只读用户（用于报表查询）</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;readonly&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;readonly_pwd&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> webapp.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;readonly&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3. 创建应用用户（用于日常操作）</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;appuser&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;app_pwd&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span>, <span class="keyword">INSERT</span>, <span class="keyword">UPDATE</span>, <span class="keyword">DELETE</span> <span class="keyword">ON</span> webapp.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;appuser&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 4. 创建管理员用户（拥有所有权限）</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;admin&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;admin_pwd&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> webapp.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;admin&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> <span class="keyword">WITH</span> <span class="keyword">GRANT</span> OPTION;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 5. 刷新权限</span></span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 6. 验证权限</span></span><br><span class="line"><span class="keyword">SHOW</span> GRANTS <span class="keyword">FOR</span> <span class="string">&#x27;readonly&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"><span class="keyword">SHOW</span> GRANTS <span class="keyword">FOR</span> <span class="string">&#x27;appuser&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"><span class="keyword">SHOW</span> GRANTS <span class="keyword">FOR</span> <span class="string">&#x27;admin&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-银行转账事务"><a href="#6-2-银行转账事务" class="headerlink" title="6.2 银行转账事务"></a>6.2 银行转账事务</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建账户表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> accounts (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    account_no <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">UNIQUE</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    balance <span class="type">DECIMAL</span>(<span class="number">12</span>, <span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    version <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>  <span class="comment">-- 乐观锁版本号</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> accounts (account_no, balance) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;ACC001&#x27;</span>, <span class="number">10000</span>),</span><br><span class="line">(<span class="string">&#x27;ACC002&#x27;</span>, <span class="number">5000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 转账存储过程（带事务）</span></span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> transfer_money(</span><br><span class="line">    <span class="keyword">IN</span> from_acc <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    <span class="keyword">IN</span> to_acc <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    <span class="keyword">IN</span> amount <span class="type">DECIMAL</span>(<span class="number">12</span>, <span class="number">2</span>)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> EXIT HANDLER <span class="keyword">FOR</span> <span class="keyword">SQLEXCEPTION</span></span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">        <span class="keyword">ROLLBACK</span>;  <span class="comment">-- 出错回滚</span></span><br><span class="line">        <span class="keyword">SELECT</span> <span class="string">&#x27;Transfer failed&#x27;</span> <span class="keyword">AS</span> <span class="keyword">result</span>;</span><br><span class="line">    <span class="keyword">END</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">START</span> TRANSACTION;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 检查余额</span></span><br><span class="line">    IF (<span class="keyword">SELECT</span> balance <span class="keyword">FROM</span> accounts <span class="keyword">WHERE</span> account_no <span class="operator">=</span> from_acc) <span class="operator">&gt;=</span> amount <span class="keyword">THEN</span></span><br><span class="line">        <span class="comment">-- 扣款</span></span><br><span class="line">        <span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">-</span> amount</span><br><span class="line">        <span class="keyword">WHERE</span> account_no <span class="operator">=</span> from_acc;</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- 收款</span></span><br><span class="line">        <span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">+</span> amount</span><br><span class="line">        <span class="keyword">WHERE</span> account_no <span class="operator">=</span> to_acc;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">COMMIT</span>;</span><br><span class="line">        <span class="keyword">SELECT</span> <span class="string">&#x27;Transfer success&#x27;</span> <span class="keyword">AS</span> <span class="keyword">result</span>;</span><br><span class="line">    <span class="keyword">ELSE</span></span><br><span class="line">        <span class="keyword">ROLLBACK</span>;</span><br><span class="line">        <span class="keyword">SELECT</span> <span class="string">&#x27;Insufficient balance&#x27;</span> <span class="keyword">AS</span> <span class="keyword">result</span>;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 调用转账</span></span><br><span class="line"><span class="keyword">CALL</span> transfer_money(<span class="string">&#x27;ACC001&#x27;</span>, <span class="string">&#x27;ACC002&#x27;</span>, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看结果</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> accounts;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-使用乐观锁"><a href="#6-3-使用乐观锁" class="headerlink" title="6.3 使用乐观锁"></a>6.3 使用乐观锁</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 使用版本号实现乐观锁</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 读取当前版本</span></span><br><span class="line"><span class="keyword">SELECT</span> balance, version <span class="keyword">FROM</span> accounts <span class="keyword">WHERE</span> account_no <span class="operator">=</span> <span class="string">&#x27;ACC001&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 更新时检查版本号</span></span><br><span class="line"><span class="keyword">UPDATE</span> accounts</span><br><span class="line"><span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">-</span> <span class="number">1000</span>, version <span class="operator">=</span> version <span class="operator">+</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">WHERE</span> account_no <span class="operator">=</span> <span class="string">&#x27;ACC001&#x27;</span> <span class="keyword">AND</span> version <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查影响行数，如果为 0 说明被其他事务修改过</span></span><br><span class="line"><span class="comment">-- 需要回滚重试</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>

<h2 id="七、安全管理最佳实践"><a href="#七、安全管理最佳实践" class="headerlink" title="七、安全管理最佳实践"></a>七、安全管理最佳实践</h2><h3 id="7-1-密码安全"><a href="#7-1-密码安全" class="headerlink" title="7.1 密码安全"></a>7.1 密码安全</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 设置密码复杂度验证插件</span></span><br><span class="line">INSTALL PLUGIN validate_password SONAME <span class="string">&#x27;validate_password.so&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看密码策略</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;validate_password%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置密码策略级别</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> validate_password.policy <span class="operator">=</span> MEDIUM;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> validate_password.length <span class="operator">=</span> <span class="number">8</span>;</span><br></pre></td></tr></table></figure>

<h3 id="7-2-最小权限原则"><a href="#7-2-最小权限原则" class="headerlink" title="7.2 最小权限原则"></a>7.2 最小权限原则</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 错误：给应用用户授予过多权限</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;app&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 正确：只授予必要权限</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span>, <span class="keyword">INSERT</span>, <span class="keyword">UPDATE</span>, <span class="keyword">DELETE</span> <span class="keyword">ON</span> mydb.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;app&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="7-3-限制主机访问"><a href="#7-3-限制主机访问" class="headerlink" title="7.3 限制主机访问"></a>7.3 限制主机访问</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 错误：允许任何主机连接</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;app&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;pwd&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 正确：限制特定主机或网段</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;app&#x27;</span>@<span class="string">&#x27;192.168.1.%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;pwd&#x27;</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;app&#x27;</span>@<span class="string">&#x27;10.0.0.100&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;pwd&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="7-4-定期清理无用用户"><a href="#7-4-定期清理无用用户" class="headerlink" title="7.4 定期清理无用用户"></a>7.4 定期清理无用用户</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看长期未登录的用户</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">user</span>, host, password_last_changed</span><br><span class="line"><span class="keyword">FROM</span> mysql.user</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> password_last_changed;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除无用用户</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">USER</span> <span class="string">&#x27;old_user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="7-5-审计和监控"><a href="#7-5-审计和监控" class="headerlink" title="7.5 审计和监控"></a>7.5 审计和监控</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 开启通用查询日志（生产环境慎用）</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> general_log <span class="operator">=</span> <span class="string">&#x27;ON&#x27;</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> general_log_file <span class="operator">=</span> <span class="string">&#x27;/var/log/mysql/general.log&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看当前连接</span></span><br><span class="line"><span class="keyword">SHOW</span> PROCESSLIST;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看慢查询日志</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> slow_query_log <span class="operator">=</span> <span class="string">&#x27;ON&#x27;</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> long_query_time <span class="operator">=</span> <span class="number">2</span>;  <span class="comment">-- 超过 2 秒的查询记入日志</span></span><br></pre></td></tr></table></figure>

<h2 id="八、小结"><a href="#八、小结" class="headerlink" title="八、小结"></a>八、小结</h2><h3 id="知识点回顾"><a href="#知识点回顾" class="headerlink" title="知识点回顾"></a>知识点回顾</h3><ol>
<li><p><strong>用户管理</strong></p>
<ul>
<li>CREATE USER、ALTER USER、DROP USER</li>
<li>用户名格式：‘user‘@’host’</li>
</ul>
</li>
<li><p><strong>权限管理</strong></p>
<ul>
<li>GRANT 授权、REVOKE 撤销</li>
<li>权限级别：全局、数据库、表、列</li>
<li>常用权限：SELECT、INSERT、UPDATE、DELETE、ALL PRIVILEGES</li>
</ul>
</li>
<li><p><strong>角色管理（MySQL 8.0+）</strong></p>
<ul>
<li>CREATE ROLE 创建角色</li>
<li>角色是一组权限的集合</li>
</ul>
</li>
<li><p><strong>事务控制</strong></p>
<ul>
<li>START TRANSACTION、COMMIT、ROLLBACK</li>
<li>SAVEPOINT 保存点</li>
<li>隔离级别：READ UNCOMMITTED、READ COMMITTED、REPEATABLE READ、SERIALIZABLE</li>
</ul>
</li>
</ol>
<h3 id="DCL-命令速查表"><a href="#DCL-命令速查表" class="headerlink" title="DCL 命令速查表"></a>DCL 命令速查表</h3><table>
<thead>
<tr>
<th>命令</th>
<th>语法</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>CREATE USER</td>
<td><code>CREATE USER &#39;u&#39;@&#39;h&#39; IDENTIFIED BY &#39;pwd&#39;</code></td>
<td>创建用户</td>
</tr>
<tr>
<td>DROP USER</td>
<td><code>DROP USER &#39;u&#39;@&#39;h&#39;</code></td>
<td>删除用户</td>
</tr>
<tr>
<td>GRANT</td>
<td><code>GRANT 权限 ON 库。表 TO &#39;u&#39;@&#39;h&#39;</code></td>
<td>授权</td>
</tr>
<tr>
<td>REVOKE</td>
<td><code>REVOKE 权限 ON 库。表 FROM &#39;u&#39;@&#39;h&#39;</code></td>
<td>撤销权限</td>
</tr>
<tr>
<td>SHOW GRANTS</td>
<td><code>SHOW GRANTS FOR &#39;u&#39;@&#39;h&#39;</code></td>
<td>查看权限</td>
</tr>
<tr>
<td>START TRANSACTION</td>
<td><code>START TRANSACTION</code></td>
<td>开启事务</td>
</tr>
<tr>
<td>COMMIT</td>
<td><code>COMMIT</code></td>
<td>提交事务</td>
</tr>
<tr>
<td>ROLLBACK</td>
<td><code>ROLLBACK</code></td>
<td>回滚事务</td>
</tr>
<tr>
<td>SAVEPOINT</td>
<td><code>SAVEPOINT sp_name</code></td>
<td>设置保存点</td>
</tr>
</tbody></table>
<h3 id="安全建议"><a href="#安全建议" class="headerlink" title="安全建议"></a>安全建议</h3><ol>
<li><strong>最小权限原则</strong>：只授予必要的权限</li>
<li><strong>限制主机</strong>：避免使用 <code>&#39;user&#39;@&#39;%&#39;</code></li>
<li><strong>强密码策略</strong>：使用密码复杂度验证</li>
<li><strong>定期审计</strong>：清理无用用户，检查权限分配</li>
<li><strong>生产环境</strong>：避免使用 root 用户连接应用</li>
</ol>
<hr>
<p><strong>上一篇</strong>：[MySQL 基础教程（四）DQL 数据查询语言详解（下）](&#x2F;2026&#x2F;02&#x2F;23&#x2F;MySQL 基础教程（四）DQL 数据查询语言详解（下）&#x2F;)</p>
<h2 id="MySQL-基础教程系列总结"><a href="#MySQL-基础教程系列总结" class="headerlink" title="MySQL 基础教程系列总结"></a>MySQL 基础教程系列总结</h2><p>至此，MySQL 基础教程系列全部完成！让我们回顾一下整个系列的内容：</p>
<h3 id="系列文章回顾"><a href="#系列文章回顾" class="headerlink" title="系列文章回顾"></a>系列文章回顾</h3><ol>
<li><p><strong>（一）数据库基础与环境搭建</strong></p>
<ul>
<li>数据库概念、MySQL 安装、数据模型、SQL 分类</li>
</ul>
</li>
<li><p><strong>（二）DDL 数据定义语言详解</strong></p>
<ul>
<li>数据库操作、表操作、数据类型、DataGrip 工具</li>
</ul>
</li>
<li><p><strong>（三）DML 数据操作语言详解</strong></p>
<ul>
<li>INSERT 插入、UPDATE 更新、DELETE 删除、事务基础</li>
</ul>
</li>
<li><p><strong>（四）DQL 数据查询语言详解</strong></p>
<ul>
<li>基础查询、条件查询、聚合函数、分组、排序、分页、连接查询、子查询</li>
</ul>
</li>
<li><p><strong>（五）DCL 数据控制语言详解</strong></p>
<ul>
<li>用户管理、权限控制、事务控制、安全管理</li>
</ul>
</li>
</ol>
<h3 id="学习建议"><a href="#学习建议" class="headerlink" title="学习建议"></a>学习建议</h3><ol>
<li><strong>多动手实践</strong>：SQL 是一门实践性很强的语言，建议边学边练</li>
<li><strong>理解原理</strong>：不仅要会写 SQL，还要理解执行顺序和原理</li>
<li><strong>注意性能</strong>：养成写高效 SQL 的习惯，避免全表扫描</li>
<li><strong>善用工具</strong>：使用 DataGrip 等工具提高开发效率</li>
<li><strong>持续学习</strong>：数据库知识博大精深，保持学习的热情</li>
</ol>
<p>希望本系列教程能帮助你系统地掌握 MySQL 基础！如有问题，欢迎留言讨论。</p>
]]></content>
      <categories>
        <category>MySQL 基础教程</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>DCL</tag>
        <tag>权限管理</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 基础教程（四）DQL 数据查询语言详解（上）</title>
    <url>/2026/02/23/MySQL%20%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B%EF%BC%88%E5%9B%9B%EF%BC%89DQL%20%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E8%AF%AD%E8%A8%80%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%B8%8A%EF%BC%89/</url>
    <content><![CDATA[<h1 id="MySQL-基础教程（四）DQL-数据查询语言详解（上）"><a href="#MySQL-基础教程（四）DQL-数据查询语言详解（上）" class="headerlink" title="MySQL 基础教程（四）DQL 数据查询语言详解（上）"></a>MySQL 基础教程（四）DQL 数据查询语言详解（上）</h1><p>DQL（Data Query Language，数据查询语言）是 SQL 中使用频率最高的部分。本文将系统讲解 DQL 的各种查询技巧，由于内容较多，分为上下两部分。</p>
<p><strong>上半部分</strong>：基础查询、条件查询、聚合函数、分组查询<br><strong>下半部分</strong>：排序查询、分页查询、综合案例、执行顺序</p>
<h2 id="一、DQL-概述"><a href="#一、DQL-概述" class="headerlink" title="一、DQL 概述"></a>一、DQL 概述</h2><p>DQL 主要用于从数据库中查询数据，核心命令是 <code>SELECT</code>。</p>
<p>完整的 SELECT 语法结构：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> [<span class="keyword">DISTINCT</span>] 列名 <span class="number">1</span> [<span class="keyword">AS</span> 别名 <span class="number">1</span>], 列名 <span class="number">2</span> [<span class="keyword">AS</span> 别名 <span class="number">2</span>], ...</span><br><span class="line"><span class="keyword">FROM</span> 表名 <span class="number">1</span> [<span class="keyword">AS</span> 别名 <span class="number">1</span>]</span><br><span class="line">[<span class="keyword">INNER</span> <span class="operator">|</span> <span class="keyword">LEFT</span> <span class="operator">|</span> <span class="keyword">RIGHT</span> <span class="operator">|</span> <span class="keyword">FULL</span>] <span class="keyword">JOIN</span> 表名 <span class="number">2</span> <span class="keyword">ON</span> 连接条件</span><br><span class="line">[<span class="keyword">WHERE</span> 条件]</span><br><span class="line">[<span class="keyword">GROUP</span> <span class="keyword">BY</span> 分组列 [<span class="keyword">HAVING</span> 分组过滤]]</span><br><span class="line">[<span class="keyword">ORDER</span> <span class="keyword">BY</span> 排序列 [<span class="keyword">ASC</span> <span class="operator">|</span> <span class="keyword">DESC</span>]]</span><br><span class="line">[LIMIT 起始位置，返回条数];</span><br></pre></td></tr></table></figure>

<h2 id="二、基础查询"><a href="#二、基础查询" class="headerlink" title="二、基础查询"></a>二、基础查询</h2><h3 id="2-1-准备测试数据"><a href="#2-1-准备测试数据" class="headerlink" title="2.1 准备测试数据"></a>2.1 准备测试数据</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建数据库</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> sql_learning;</span><br><span class="line">USE sql_learning;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建员工表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> employees;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> employees (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;员工 ID&#x27;</span>,</span><br><span class="line">    emp_no <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span> <span class="keyword">UNIQUE</span> COMMENT <span class="string">&#x27;员工编号&#x27;</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">    gender ENUM(<span class="string">&#x27;男&#x27;</span>, <span class="string">&#x27;女&#x27;</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;男&#x27;</span> COMMENT <span class="string">&#x27;性别&#x27;</span>,</span><br><span class="line">    age TINYINT COMMENT <span class="string">&#x27;年龄&#x27;</span>,</span><br><span class="line">    dept_id <span class="type">INT</span> COMMENT <span class="string">&#x27;部门 ID&#x27;</span>,</span><br><span class="line">    salary <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) COMMENT <span class="string">&#x27;工资&#x27;</span>,</span><br><span class="line">    hire_date <span class="type">DATE</span> COMMENT <span class="string">&#x27;入职日期&#x27;</span>,</span><br><span class="line">    status TINYINT <span class="keyword">DEFAULT</span> <span class="number">1</span> COMMENT <span class="string">&#x27;状态：1 在职 0 离职&#x27;</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 COMMENT<span class="operator">=</span><span class="string">&#x27;员工表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建部门表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> departments;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> departments (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;部门 ID&#x27;</span>,</span><br><span class="line">    dept_name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;部门名称&#x27;</span>,</span><br><span class="line">    dept_location <span class="type">VARCHAR</span>(<span class="number">100</span>) COMMENT <span class="string">&#x27;部门位置&#x27;</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 COMMENT<span class="operator">=</span><span class="string">&#x27;部门表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入部门数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> departments (dept_name, dept_location) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;技术部&#x27;</span>, <span class="string">&#x27;北京&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;市场部&#x27;</span>, <span class="string">&#x27;上海&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;财务部&#x27;</span>, <span class="string">&#x27;北京&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;人事部&#x27;</span>, <span class="string">&#x27;广州&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入员工数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> employees (emp_no, name, gender, age, dept_id, salary, hire_date, status) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;E001&#x27;</span>, <span class="string">&#x27;张三&#x27;</span>, <span class="string">&#x27;男&#x27;</span>, <span class="number">28</span>, <span class="number">1</span>, <span class="number">8000.00</span>, <span class="string">&#x27;2022-03-15&#x27;</span>, <span class="number">1</span>),</span><br><span class="line">(<span class="string">&#x27;E002&#x27;</span>, <span class="string">&#x27;李四&#x27;</span>, <span class="string">&#x27;女&#x27;</span>, <span class="number">32</span>, <span class="number">1</span>, <span class="number">9500.00</span>, <span class="string">&#x27;2021-06-01&#x27;</span>, <span class="number">1</span>),</span><br><span class="line">(<span class="string">&#x27;E003&#x27;</span>, <span class="string">&#x27;王五&#x27;</span>, <span class="string">&#x27;男&#x27;</span>, <span class="number">25</span>, <span class="number">1</span>, <span class="number">7000.00</span>, <span class="string">&#x27;2023-01-10&#x27;</span>, <span class="number">1</span>),</span><br><span class="line">(<span class="string">&#x27;E004&#x27;</span>, <span class="string">&#x27;赵六&#x27;</span>, <span class="string">&#x27;女&#x27;</span>, <span class="number">29</span>, <span class="number">2</span>, <span class="number">8500.00</span>, <span class="string">&#x27;2022-08-20&#x27;</span>, <span class="number">1</span>),</span><br><span class="line">(<span class="string">&#x27;E005&#x27;</span>, <span class="string">&#x27;孙七&#x27;</span>, <span class="string">&#x27;男&#x27;</span>, <span class="number">35</span>, <span class="number">2</span>, <span class="number">10000.00</span>, <span class="string">&#x27;2020-05-15&#x27;</span>, <span class="number">1</span>),</span><br><span class="line">(<span class="string">&#x27;E006&#x27;</span>, <span class="string">&#x27;周八&#x27;</span>, <span class="string">&#x27;女&#x27;</span>, <span class="number">27</span>, <span class="number">3</span>, <span class="number">7500.00</span>, <span class="string">&#x27;2022-11-01&#x27;</span>, <span class="number">1</span>),</span><br><span class="line">(<span class="string">&#x27;E007&#x27;</span>, <span class="string">&#x27;吴九&#x27;</span>, <span class="string">&#x27;男&#x27;</span>, <span class="number">31</span>, <span class="number">3</span>, <span class="number">9000.00</span>, <span class="string">&#x27;2021-09-10&#x27;</span>, <span class="number">1</span>),</span><br><span class="line">(<span class="string">&#x27;E008&#x27;</span>, <span class="string">&#x27;郑十&#x27;</span>, <span class="string">&#x27;女&#x27;</span>, <span class="number">24</span>, <span class="number">4</span>, <span class="number">6000.00</span>, <span class="string">&#x27;2023-06-01&#x27;</span>, <span class="number">1</span>),</span><br><span class="line">(<span class="string">&#x27;E009&#x27;</span>, <span class="string">&#x27;刘十一&#x27;</span>, <span class="string">&#x27;男&#x27;</span>, <span class="number">30</span>, <span class="number">1</span>, <span class="number">8800.00</span>, <span class="string">&#x27;2022-01-15&#x27;</span>, <span class="number">1</span>),</span><br><span class="line">(<span class="string">&#x27;E010&#x27;</span>, <span class="string">&#x27;陈十二&#x27;</span>, <span class="string">&#x27;女&#x27;</span>, <span class="number">26</span>, <span class="number">2</span>, <span class="number">7200.00</span>, <span class="string">&#x27;2023-03-20&#x27;</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<h3 id="2-2-查询所有列"><a href="#2-2-查询所有列" class="headerlink" title="2.2 查询所有列"></a>2.2 查询所有列</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询所有列（不推荐在生产环境使用 *）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 推荐：明确指定需要的列</span></span><br><span class="line"><span class="keyword">SELECT</span> id, emp_no, name, salary <span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-查询指定列"><a href="#2-3-查询指定列" class="headerlink" title="2.3 查询指定列"></a>2.3 查询指定列</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询部分列</span></span><br><span class="line"><span class="keyword">SELECT</span> name, salary, dept_id <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询单列</span></span><br><span class="line"><span class="keyword">SELECT</span> name <span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-去除重复（DISTINCT）"><a href="#2-4-去除重复（DISTINCT）" class="headerlink" title="2.4 去除重复（DISTINCT）"></a>2.4 去除重复（DISTINCT）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询有哪些部门（去重）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> dept_id <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 多列去重（多列组合必须完全相同才算重复）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> dept_id, gender <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- DISTINCT 必须放在所有列之前</span></span><br><span class="line"><span class="comment">-- 错误写法：SELECT dept_id, DISTINCT salary FROM employees;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-5-列别名（AS）"><a href="#2-5-列别名（AS）" class="headerlink" title="2.5 列别名（AS）"></a>2.5 列别名（AS）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 使用 AS 指定别名</span></span><br><span class="line"><span class="keyword">SELECT</span> name <span class="keyword">AS</span> 姓名，salary <span class="keyword">AS</span> 工资，hire_date <span class="keyword">AS</span> 入职日期</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- AS 可以省略</span></span><br><span class="line"><span class="keyword">SELECT</span> name 姓名，salary 工资 <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 别名可以包含空格（用引号包裹）</span></span><br><span class="line"><span class="keyword">SELECT</span> salary <span class="keyword">AS</span> <span class="string">&#x27;月工资 (元)&#x27;</span> <span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<h3 id="2-6-表别名"><a href="#2-6-表别名" class="headerlink" title="2.6 表别名"></a>2.6 表别名</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 给表指定别名</span></span><br><span class="line"><span class="keyword">SELECT</span> e.name, e.salary, d.dept_name</span><br><span class="line"><span class="keyword">FROM</span> employees <span class="keyword">AS</span> e</span><br><span class="line"><span class="keyword">JOIN</span> departments <span class="keyword">AS</span> d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- AS 可以省略</span></span><br><span class="line"><span class="keyword">SELECT</span> e.name, d.dept_name</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">JOIN</span> departments d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.id;</span><br></pre></td></tr></table></figure>

<h3 id="2-7-表达式查询"><a href="#2-7-表达式查询" class="headerlink" title="2.7 表达式查询"></a>2.7 表达式查询</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 算术表达式</span></span><br><span class="line"><span class="keyword">SELECT</span> name, salary, salary <span class="operator">*</span> <span class="number">12</span> <span class="keyword">AS</span> 年薪 <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 字符串拼接</span></span><br><span class="line"><span class="keyword">SELECT</span> CONCAT(name, <span class="string">&#x27; - &#x27;</span>, emp_no) <span class="keyword">AS</span> 员工信息 <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 函数计算</span></span><br><span class="line"><span class="keyword">SELECT</span> name, <span class="built_in">UPPER</span>(name) <span class="keyword">AS</span> 大写姓名，LENGTH(name) <span class="keyword">AS</span> 名字长度</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<h3 id="2-8-NULL-值处理"><a href="#2-8-NULL-值处理" class="headerlink" title="2.8 NULL 值处理"></a>2.8 NULL 值处理</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- IFNULL 函数：如果为 NULL 则返回指定值</span></span><br><span class="line"><span class="keyword">SELECT</span> name, IFNULL(salary, <span class="number">0</span>) <span class="keyword">AS</span> 工资 <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- IF 函数：条件判断</span></span><br><span class="line"><span class="keyword">SELECT</span> name, salary, IF(salary <span class="operator">&gt;</span> <span class="number">8000</span>, <span class="string">&#x27;高薪&#x27;</span>, <span class="string">&#x27;普通&#x27;</span>) <span class="keyword">AS</span> 薪资水平</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- CASE 表达式</span></span><br><span class="line"><span class="keyword">SELECT</span> name, salary,</span><br><span class="line">    <span class="keyword">CASE</span></span><br><span class="line">        <span class="keyword">WHEN</span> salary <span class="operator">&gt;=</span> <span class="number">10000</span> <span class="keyword">THEN</span> <span class="string">&#x27;高收入&#x27;</span></span><br><span class="line">        <span class="keyword">WHEN</span> salary <span class="operator">&gt;=</span> <span class="number">8000</span> <span class="keyword">THEN</span> <span class="string">&#x27;中等收入&#x27;</span></span><br><span class="line">        <span class="keyword">ELSE</span> <span class="string">&#x27;低收入&#x27;</span></span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">AS</span> 收入等级</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<h2 id="三、条件查询（WHERE）"><a href="#三、条件查询（WHERE）" class="headerlink" title="三、条件查询（WHERE）"></a>三、条件查询（WHERE）</h2><p>WHERE 子句用于过滤记录，只返回满足条件的行。</p>
<h3 id="3-1-比较运算符"><a href="#3-1-比较运算符" class="headerlink" title="3.1 比较运算符"></a>3.1 比较运算符</h3><table>
<thead>
<tr>
<th>运算符</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>&#x3D;</td>
<td>等于</td>
<td><code>salary = 8000</code></td>
</tr>
<tr>
<td>!&#x3D; 或 &lt;&gt;</td>
<td>不等于</td>
<td><code>dept_id != 1</code></td>
</tr>
<tr>
<td>&gt;</td>
<td>大于</td>
<td><code>age &gt; 30</code></td>
</tr>
<tr>
<td>&lt;</td>
<td>小于</td>
<td><code>age &lt; 30</code></td>
</tr>
<tr>
<td>&gt;&#x3D;</td>
<td>大于等于</td>
<td><code>salary &gt;= 8000</code></td>
</tr>
<tr>
<td>&lt;&#x3D;</td>
<td>小于等于</td>
<td><code>salary &lt;= 10000</code></td>
</tr>
<tr>
<td>&lt;&#x3D;&gt;</td>
<td>安全等于（可比较 NULL）</td>
<td><code>dept_id &lt;=&gt; NULL</code></td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 等于</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> salary <span class="operator">=</span> <span class="number">8000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 不等于</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> dept_id <span class="operator">!=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 大于/小于</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> age <span class="operator">&gt;</span> <span class="number">30</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> salary <span class="operator">&lt;</span> <span class="number">8000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 大于等于/小于等于</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> salary <span class="operator">&gt;=</span> <span class="number">9000</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> salary <span class="operator">&lt;=</span> <span class="number">7000</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-逻辑运算符"><a href="#3-2-逻辑运算符" class="headerlink" title="3.2 逻辑运算符"></a>3.2 逻辑运算符</h3><table>
<thead>
<tr>
<th>运算符</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>AND 或 &amp;&amp;</td>
<td>与</td>
<td><code>age &gt; 25 AND salary &gt; 8000</code></td>
</tr>
<tr>
<td>OR 或 ||</td>
<td>或</td>
<td><code>dept_id = 1 OR dept_id = 2</code></td>
</tr>
<tr>
<td>NOT 或 !</td>
<td>非</td>
<td><code>NOT gender = &#39;男&#39;</code></td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- AND：同时满足多个条件</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">AND</span> salary <span class="operator">&gt;</span> <span class="number">8000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- OR：满足任一条件</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">OR</span> dept_id <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- NOT：取反</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">NOT</span> gender <span class="operator">=</span> <span class="string">&#x27;男&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 混合使用（注意优先级：NOT &gt; AND &gt; OR）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> (dept_id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">OR</span> dept_id <span class="operator">=</span> <span class="number">2</span>) <span class="keyword">AND</span> salary <span class="operator">&gt;</span> <span class="number">8000</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-范围查询"><a href="#3-3-范围查询" class="headerlink" title="3.3 范围查询"></a>3.3 范围查询</h3><h4 id="BETWEEN…AND"><a href="#BETWEEN…AND" class="headerlink" title="BETWEEN…AND"></a>BETWEEN…AND</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询工资在 7000 到 9000 之间的员工（包含边界）</span></span><br><span class="line"><span class="keyword">SELECT</span> name, salary <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="keyword">BETWEEN</span> <span class="number">7000</span> <span class="keyword">AND</span> <span class="number">9000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 等价于</span></span><br><span class="line"><span class="keyword">SELECT</span> name, salary <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="operator">&gt;=</span> <span class="number">7000</span> <span class="keyword">AND</span> salary <span class="operator">&lt;=</span> <span class="number">9000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- NOT BETWEEN：不在范围内</span></span><br><span class="line"><span class="keyword">SELECT</span> name, salary <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="keyword">NOT</span> <span class="keyword">BETWEEN</span> <span class="number">7000</span> <span class="keyword">AND</span> <span class="number">9000</span>;</span><br></pre></td></tr></table></figure>

<h4 id="IN-NOT-IN"><a href="#IN-NOT-IN" class="headerlink" title="IN &#x2F; NOT IN"></a>IN &#x2F; NOT IN</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询部门 ID 为 1、2、3 的员工</span></span><br><span class="line"><span class="keyword">SELECT</span> name, dept_id <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> dept_id <span class="keyword">IN</span> (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 等价于</span></span><br><span class="line"><span class="keyword">SELECT</span> name, dept_id <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">OR</span> dept_id <span class="operator">=</span> <span class="number">2</span> <span class="keyword">OR</span> dept_id <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- NOT IN：不在指定集合中</span></span><br><span class="line"><span class="keyword">SELECT</span> name, dept_id <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> dept_id <span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="number">1</span>, <span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<h3 id="3-4-模糊查询（LIKE）"><a href="#3-4-模糊查询（LIKE）" class="headerlink" title="3.4 模糊查询（LIKE）"></a>3.4 模糊查询（LIKE）</h3><p>LIKE 用于字符串匹配，支持通配符：</p>
<ul>
<li><code>%</code>：匹配任意数量的字符（包括 0 个）</li>
<li><code>_</code>：匹配单个字符</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 以&#x27;张&#x27;开头的名字</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="keyword">LIKE</span> <span class="string">&#x27;张%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 以&#x27;四&#x27;结尾的名字</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="keyword">LIKE</span> <span class="string">&#x27;%四&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 包含&#x27;十&#x27;的名字</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="keyword">LIKE</span> <span class="string">&#x27;%十%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 第二个字是&#x27;十&#x27;的名字（_匹配一个字符）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="keyword">LIKE</span> <span class="string">&#x27;_十%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 正好两个字的姓</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="keyword">LIKE</span> <span class="string">&#x27;__&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 不以&#x27;张&#x27;开头的名字</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="keyword">NOT</span> <span class="keyword">LIKE</span> <span class="string">&#x27;张%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 匹配特殊字符（使用转义）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="keyword">LIKE</span> <span class="string">&#x27;张\_%&#x27;</span>;  <span class="comment">-- 匹配&#x27;张_&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-5-NULL-值查询"><a href="#3-5-NULL-值查询" class="headerlink" title="3.5 NULL 值查询"></a>3.5 NULL 值查询</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询 dept_id 为 NULL 的员工</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> dept_id <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询 dept_id 不为 NULL 的员工</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> dept_id <span class="keyword">IS</span> <span class="keyword">NOT NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 错误写法：不能用 = 判断 NULL</span></span><br><span class="line"><span class="comment">-- SELECT * FROM employees WHERE dept_id = NULL;  -- 不会返回任何结果</span></span><br></pre></td></tr></table></figure>

<h3 id="3-6-正则表达式（REGEXP）"><a href="#3-6-正则表达式（REGEXP）" class="headerlink" title="3.6 正则表达式（REGEXP）"></a>3.6 正则表达式（REGEXP）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 以张或李开头</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name REGEXP <span class="string">&#x27;^张 | ^李&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 包含数字</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> emp_no REGEXP <span class="string">&#x27;[0-9]&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 三个字的姓名</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name REGEXP <span class="string">&#x27;^.&#123;3&#125;$&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="四、聚合函数"><a href="#四、聚合函数" class="headerlink" title="四、聚合函数"></a>四、聚合函数</h2><p>聚合函数对一组数据进行计算，返回单个值。</p>
<h3 id="4-1-常用聚合函数"><a href="#4-1-常用聚合函数" class="headerlink" title="4.1 常用聚合函数"></a>4.1 常用聚合函数</h3><table>
<thead>
<tr>
<th>函数</th>
<th>功能</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>COUNT()</td>
<td>计数</td>
<td>统计行数</td>
</tr>
<tr>
<td>SUM()</td>
<td>求和</td>
<td>计算总和</td>
</tr>
<tr>
<td>AVG()</td>
<td>平均值</td>
<td>计算平均数</td>
</tr>
<tr>
<td>MAX()</td>
<td>最大值</td>
<td>找出最大值</td>
</tr>
<tr>
<td>MIN()</td>
<td>最小值</td>
<td>找出最小值</td>
</tr>
</tbody></table>
<h3 id="4-2-COUNT-计数"><a href="#4-2-COUNT-计数" class="headerlink" title="4.2 COUNT 计数"></a>4.2 COUNT 计数</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 统计员工总数</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 统计在职员工数</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> status <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- COUNT(列名) 忽略 NULL 值</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(salary) <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- COUNT(*) 包含 NULL 值</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 统计不同部门数量</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> dept_id) <span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<p><strong>COUNT(*) vs COUNT(列) vs COUNT(1)</strong>：</p>
<ul>
<li><code>COUNT(*)</code>：统计所有行（包括 NULL），推荐用于计数</li>
<li><code>COUNT(列)</code>：统计该列非 NULL 的行数</li>
<li><code>COUNT(1)</code>：效果同 COUNT(*)，但某些场景略慢</li>
</ul>
<h3 id="4-3-SUM-求和"><a href="#4-3-SUM-求和" class="headerlink" title="4.3 SUM 求和"></a>4.3 SUM 求和</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 计算工资总和</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">SUM</span>(salary) <span class="keyword">AS</span> 工资总额 <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 计算在职员工工资总和</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">SUM</span>(salary) <span class="keyword">AS</span> 在职员工工资总额</span><br><span class="line"><span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> status <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 计算各部门工资总和（配合 GROUP BY）</span></span><br><span class="line"><span class="keyword">SELECT</span> dept_id, <span class="built_in">SUM</span>(salary) <span class="keyword">AS</span> 部门工资总额</span><br><span class="line"><span class="keyword">FROM</span> employees <span class="keyword">GROUP</span> <span class="keyword">BY</span> dept_id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- SUM 忽略 NULL 值</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">SUM</span>(salary) <span class="keyword">FROM</span> employees;  <span class="comment">-- NULL 值不参与计算</span></span><br></pre></td></tr></table></figure>

<h3 id="4-4-AVG-平均值"><a href="#4-4-AVG-平均值" class="headerlink" title="4.4 AVG 平均值"></a>4.4 AVG 平均值</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 计算平均工资</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">AVG</span>(salary) <span class="keyword">AS</span> 平均工资 <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 保留 2 位小数</span></span><br><span class="line"><span class="keyword">SELECT</span> ROUND(<span class="built_in">AVG</span>(salary), <span class="number">2</span>) <span class="keyword">AS</span> 平均工资 <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 计算在职员工平均工资</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">AVG</span>(salary) <span class="keyword">AS</span> 在职平均工资</span><br><span class="line"><span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> status <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- AVG 忽略 NULL 值</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">AVG</span>(salary) <span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<h3 id="4-5-MAX-MIN-最值"><a href="#4-5-MAX-MIN-最值" class="headerlink" title="4.5 MAX&#x2F;MIN 最值"></a>4.5 MAX&#x2F;MIN 最值</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 最高工资</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">MAX</span>(salary) <span class="keyword">AS</span> 最高工资 <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 最低工资</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">MIN</span>(salary) <span class="keyword">AS</span> 最低工资 <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 最大/最小年龄</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">MAX</span>(age) <span class="keyword">AS</span> 最大年龄，<span class="built_in">MIN</span>(age) <span class="keyword">AS</span> 最小年龄 <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 最早/最晚入职日期</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">MIN</span>(hire_date) <span class="keyword">AS</span> 最早入职，<span class="built_in">MAX</span>(hire_date) <span class="keyword">AS</span> 最晚入职</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 获取最高工资的员工信息（子查询）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="operator">=</span> (<span class="keyword">SELECT</span> <span class="built_in">MAX</span>(salary) <span class="keyword">FROM</span> employees);</span><br></pre></td></tr></table></figure>

<h3 id="4-6-聚合函数组合使用"><a href="#4-6-聚合函数组合使用" class="headerlink" title="4.6 聚合函数组合使用"></a>4.6 聚合函数组合使用</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 同时查询多个聚合值</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> 员工总数，</span><br><span class="line">    <span class="built_in">SUM</span>(salary) <span class="keyword">AS</span> 工资总额，</span><br><span class="line">    ROUND(<span class="built_in">AVG</span>(salary), <span class="number">2</span>) <span class="keyword">AS</span> 平均工资，</span><br><span class="line">    <span class="built_in">MAX</span>(salary) <span class="keyword">AS</span> 最高工资，</span><br><span class="line">    <span class="built_in">MIN</span>(salary) <span class="keyword">AS</span> 最低工资</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<h2 id="五、分组查询（GROUP-BY）"><a href="#五、分组查询（GROUP-BY）" class="headerlink" title="五、分组查询（GROUP BY）"></a>五、分组查询（GROUP BY）</h2><p>GROUP BY 将数据按指定列分组，通常与聚合函数配合使用。</p>
<h3 id="5-1-基础分组"><a href="#5-1-基础分组" class="headerlink" title="5.1 基础分组"></a>5.1 基础分组</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 按部门分组，统计每组人数</span></span><br><span class="line"><span class="keyword">SELECT</span> dept_id, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> 人数</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> dept_id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 按部门分组，统计工资总和</span></span><br><span class="line"><span class="keyword">SELECT</span> dept_id, <span class="built_in">SUM</span>(salary) <span class="keyword">AS</span> 工资总额</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> dept_id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 按性别分组</span></span><br><span class="line"><span class="keyword">SELECT</span> gender, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> 人数，<span class="built_in">AVG</span>(salary) <span class="keyword">AS</span> 平均工资</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> gender;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-多列分组"><a href="#5-2-多列分组" class="headerlink" title="5.2 多列分组"></a>5.2 多列分组</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 按部门和性别分组</span></span><br><span class="line"><span class="keyword">SELECT</span> dept_id, gender, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> 人数，<span class="built_in">AVG</span>(salary) <span class="keyword">AS</span> 平均工资</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> dept_id, gender</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> dept_id, gender;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-分组与连接查询"><a href="#5-3-分组与连接查询" class="headerlink" title="5.3 分组与连接查询"></a>5.3 分组与连接查询</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 显示部门名称的分组统计</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    d.dept_name,</span><br><span class="line">    <span class="built_in">COUNT</span>(e.id) <span class="keyword">AS</span> 人数，</span><br><span class="line">    <span class="built_in">SUM</span>(e.salary) <span class="keyword">AS</span> 工资总额，</span><br><span class="line">    ROUND(<span class="built_in">AVG</span>(e.salary), <span class="number">2</span>) <span class="keyword">AS</span> 平均工资</span><br><span class="line"><span class="keyword">FROM</span> departments d</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> employees e <span class="keyword">ON</span> d.id <span class="operator">=</span> e.dept_id</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> d.id, d.dept_name;</span><br></pre></td></tr></table></figure>

<h3 id="5-4-HAVING-子句"><a href="#5-4-HAVING-子句" class="headerlink" title="5.4 HAVING 子句"></a>5.4 HAVING 子句</h3><p>HAVING 用于过滤分组后的结果，WHERE 过滤分组前的数据。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询人数大于 2 的部门</span></span><br><span class="line"><span class="keyword">SELECT</span> dept_id, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> 人数</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> dept_id</span><br><span class="line"><span class="keyword">HAVING</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="operator">&gt;</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询平均工资大于 8000 的部门</span></span><br><span class="line"><span class="keyword">SELECT</span> dept_id, <span class="built_in">AVG</span>(salary) <span class="keyword">AS</span> 平均工资</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> dept_id</span><br><span class="line"><span class="keyword">HAVING</span> <span class="built_in">AVG</span>(salary) <span class="operator">&gt;</span> <span class="number">8000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- WHERE 与 HAVING 的区别</span></span><br><span class="line"><span class="keyword">SELECT</span> dept_id, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> 人数</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> status <span class="operator">=</span> <span class="number">1</span>              <span class="comment">-- 过滤原始数据</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> dept_id</span><br><span class="line"><span class="keyword">HAVING</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="operator">&gt;</span> <span class="number">1</span>;          <span class="comment">-- 过滤分组结果</span></span><br></pre></td></tr></table></figure>

<p><strong>WHERE vs HAVING 对比</strong>：</p>
<table>
<thead>
<tr>
<th>对比项</th>
<th>WHERE</th>
<th>HAVING</th>
</tr>
</thead>
<tbody><tr>
<td>作用时机</td>
<td>分组前</td>
<td>分组后</td>
</tr>
<tr>
<td>可用位置</td>
<td>所有查询</td>
<td>GROUP BY 后</td>
</tr>
<tr>
<td>聚合函数</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>执行顺序</td>
<td>先执行</td>
<td>后执行</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 错误：WHERE 中不能使用聚合函数</span></span><br><span class="line"><span class="comment">-- SELECT dept_id FROM employees WHERE COUNT(*) &gt; 2 GROUP BY dept_id;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 正确：使用 HAVING</span></span><br><span class="line"><span class="keyword">SELECT</span> dept_id <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> dept_id</span><br><span class="line"><span class="keyword">HAVING</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="operator">&gt;</span> <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<h3 id="5-5-综合分组练习"><a href="#5-5-综合分组练习" class="headerlink" title="5.5 综合分组练习"></a>5.5 综合分组练习</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 练习 1：统计各部门在职员工的人数、平均工资</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    d.dept_name,</span><br><span class="line">    <span class="built_in">COUNT</span>(e.id) <span class="keyword">AS</span> 在职人数，</span><br><span class="line">    ROUND(<span class="built_in">AVG</span>(e.salary), <span class="number">2</span>) <span class="keyword">AS</span> 平均工资</span><br><span class="line"><span class="keyword">FROM</span> departments d</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> employees e <span class="keyword">ON</span> d.id <span class="operator">=</span> e.dept_id <span class="keyword">AND</span> e.status <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> d.id, d.dept_name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 练习 2：统计各部门工资最高的员工</span></span><br><span class="line"><span class="keyword">SELECT</span> e.dept_id, e.name, e.salary</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> dept_id, <span class="built_in">MAX</span>(salary) <span class="keyword">AS</span> max_salary</span><br><span class="line">    <span class="keyword">FROM</span> employees</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> dept_id</span><br><span class="line">) m <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> m.dept_id <span class="keyword">AND</span> e.salary <span class="operator">=</span> m.max_salary;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 练习 3：统计员工入职年份及人数</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">YEAR</span>(hire_date) <span class="keyword">AS</span> 入职年份，</span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> 人数</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">YEAR</span>(hire_date)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> 入职年份;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 练习 4：统计不同年龄段的员工数</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">CASE</span></span><br><span class="line">        <span class="keyword">WHEN</span> age <span class="operator">&lt;</span> <span class="number">25</span> <span class="keyword">THEN</span> <span class="string">&#x27;25 岁以下&#x27;</span></span><br><span class="line">        <span class="keyword">WHEN</span> age <span class="keyword">BETWEEN</span> <span class="number">25</span> <span class="keyword">AND</span> <span class="number">30</span> <span class="keyword">THEN</span> <span class="string">&#x27;25-30 岁&#x27;</span></span><br><span class="line">        <span class="keyword">WHEN</span> age <span class="keyword">BETWEEN</span> <span class="number">31</span> <span class="keyword">AND</span> <span class="number">35</span> <span class="keyword">THEN</span> <span class="string">&#x27;31-35 岁&#x27;</span></span><br><span class="line">        <span class="keyword">ELSE</span> <span class="string">&#x27;35 岁以上&#x27;</span></span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">AS</span> 年龄段，</span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> 人数</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> 年龄段</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> 年龄段;</span><br></pre></td></tr></table></figure>

<h2 id="六、小结（上）"><a href="#六、小结（上）" class="headerlink" title="六、小结（上）"></a>六、小结（上）</h2><p>本文上半部分讲解了：</p>
<ol>
<li><strong>基础查询</strong>：SELECT *、指定列、DISTINCT、别名、表达式</li>
<li><strong>条件查询</strong>：比较运算符、逻辑运算符、BETWEEN、IN、LIKE、NULL 判断</li>
<li><strong>聚合函数</strong>：COUNT、SUM、AVG、MAX、MIN</li>
<li><strong>分组查询</strong>：GROUP BY、HAVING</li>
</ol>
<p>下半部分将继续讲解：</p>
<ul>
<li>排序查询（ORDER BY）</li>
<li>分页查询（LIMIT）</li>
<li>综合案例练习</li>
<li>SQL 执行顺序</li>
</ul>
<hr>
<p><strong>下一篇</strong>：[MySQL 基础教程（四）DQL 数据查询语言详解（下）](&#x2F;2026&#x2F;02&#x2F;23&#x2F;MySQL 基础教程（四）DQL 数据查询语言详解（下）&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 基础教程（三）：DML 数据操作语言详解](&#x2F;2026&#x2F;02&#x2F;23&#x2F;MySQL 基础教程（三）DML 数据操作语言详解&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 基础教程</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>DQL</tag>
        <tag>数据查询</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 运维篇 01-01 日志详解课程介绍</title>
    <url>/2026/02/24/MySQL%20%E8%BF%90%E7%BB%B4%E7%AF%87%2001-01%20%E6%97%A5%E5%BF%97%E8%AF%A6%E8%A7%A3%E8%AF%BE%E7%A8%8B%E4%BB%8B%E7%BB%8D/</url>
    <content><![CDATA[<h1 id="MySQL-运维篇-01-01-日志详解课程介绍"><a href="#MySQL-运维篇-01-01-日志详解课程介绍" class="headerlink" title="MySQL 运维篇 01-01 日志详解课程介绍"></a>MySQL 运维篇 01-01 日志详解课程介绍</h1><p>日志是 MySQL 数据库运维的核心工具，用于记录数据库运行过程中的各种事件。本篇将详细介绍 MySQL 的四大日志系统：错误日志、二进制日志、查询日志和慢查询日志。</p>
<h2 id="一、日志系统概述"><a href="#一、日志系统概述" class="headerlink" title="一、日志系统概述"></a>一、日志系统概述</h2><h3 id="1-1-为什么需要日志？"><a href="#1-1-为什么需要日志？" class="headerlink" title="1.1 为什么需要日志？"></a>1.1 为什么需要日志？</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">日志的作用：</span><br><span class="line">├── 故障排查：记录错误信息，定位问题根源</span><br><span class="line">├── 数据恢复：通过 binlog 恢复误删数据</span><br><span class="line">├── 性能分析：慢查询日志帮助优化 SQL</span><br><span class="line">├── 审计追踪：记录用户操作历史</span><br><span class="line">└── 主从复制：binlog 是复制的基础</span><br></pre></td></tr></table></figure>

<h3 id="1-2-MySQL-四大日志"><a href="#1-2-MySQL-四大日志" class="headerlink" title="1.2 MySQL 四大日志"></a>1.2 MySQL 四大日志</h3><table>
<thead>
<tr>
<th>日志类型</th>
<th>记录内容</th>
<th>默认开启</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>错误日志（Error Log）</td>
<td>系统运行时的错误、警告</td>
<td>是</td>
<td>故障诊断</td>
</tr>
<tr>
<td>二进制日志（Binlog）</td>
<td>所有修改数据的操作</td>
<td>否</td>
<td>恢复、复制、审计</td>
</tr>
<tr>
<td>查询日志（General Log）</td>
<td>所有客户端请求</td>
<td>否</td>
<td>调试、审计</td>
</tr>
<tr>
<td>慢查询日志（Slow Query Log）</td>
<td>执行超过阈值的 SQL</td>
<td>否</td>
<td>性能优化</td>
</tr>
</tbody></table>
<h3 id="1-3-日志选择建议"><a href="#1-3-日志选择建议" class="headerlink" title="1.3 日志选择建议"></a>1.3 日志选择建议</h3><table>
<thead>
<tr>
<th>场景</th>
<th>推荐日志</th>
<th>生产环境建议</th>
</tr>
</thead>
<tbody><tr>
<td>日常监控</td>
<td>错误日志</td>
<td>始终开启</td>
</tr>
<tr>
<td>数据恢复</td>
<td>二进制日志</td>
<td>建议开启</td>
</tr>
<tr>
<td>主从复制</td>
<td>二进制日志</td>
<td>必须开启</td>
</tr>
<tr>
<td>性能优化</td>
<td>慢查询日志</td>
<td>定期开启分析</td>
</tr>
<tr>
<td>问题调试</td>
<td>查询日志</td>
<td>临时开启</td>
</tr>
</tbody></table>
<h2 id="二、各日志详细介绍"><a href="#二、各日志详细介绍" class="headerlink" title="二、各日志详细介绍"></a>二、各日志详细介绍</h2><h3 id="2-1-错误日志"><a href="#2-1-错误日志" class="headerlink" title="2.1 错误日志"></a>2.1 错误日志</h3><p><strong>记录内容</strong>：</p>
<ul>
<li>MySQL 启动&#x2F;停止信息</li>
<li>运行时的错误、警告</li>
<li>InnoDB 错误</li>
<li>复制错误</li>
</ul>
<p><strong>配置参数</strong>：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">log_error</span> = /var/log/mysql/error.log</span><br><span class="line"><span class="attr">log_error_verbosity</span> = <span class="number">2</span>  <span class="comment"># 1=错误，2=错误 + 警告，3=错误 + 警告 + 提示</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-二进制日志"><a href="#2-2-二进制日志" class="headerlink" title="2.2 二进制日志"></a>2.2 二进制日志</h3><p><strong>记录内容</strong>：</p>
<ul>
<li>所有修改数据的 DDL 和 DML</li>
<li>不记录 SELECT、SHOW 等查询</li>
</ul>
<p><strong>配置参数</strong>：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">log_bin</span> = /var/log/mysql/mysql-bin.log</span><br><span class="line"><span class="attr">expire_logs_days</span> = <span class="number">7</span>      <span class="comment"># 保留 7 天</span></span><br><span class="line"><span class="attr">max_binlog_size</span> = <span class="number">100</span>M    <span class="comment"># 单个文件最大 100M</span></span><br><span class="line"><span class="attr">binlog_format</span> = ROW       <span class="comment"># 记录格式</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-查询日志"><a href="#2-3-查询日志" class="headerlink" title="2.3 查询日志"></a>2.3 查询日志</h3><p><strong>记录内容</strong>：</p>
<ul>
<li>所有客户端连接&#x2F;断开</li>
<li>所有 SQL 请求（包括 SELECT）</li>
</ul>
<p><strong>配置参数</strong>：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">general_log</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">general_log_file</span> = /var/log/mysql/general.log</span><br></pre></td></tr></table></figure>

<h3 id="2-4-慢查询日志"><a href="#2-4-慢查询日志" class="headerlink" title="2.4 慢查询日志"></a>2.4 慢查询日志</h3><p><strong>记录内容</strong>：</p>
<ul>
<li>执行时间超过阈值的 SQL</li>
<li>未使用索引的查询（可选）</li>
</ul>
<p><strong>配置参数</strong>：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">slow_query_log</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">slow_query_log_file</span> = /var/log/mysql/slow.log</span><br><span class="line"><span class="attr">long_query_time</span> = <span class="number">2</span>       <span class="comment"># 超过 2 秒</span></span><br><span class="line"><span class="attr">log_queries_not_using_indexes</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h2 id="三、日志管理命令"><a href="#三、日志管理命令" class="headerlink" title="三、日志管理命令"></a>三、日志管理命令</h2><h3 id="3-1-查看日志配置"><a href="#3-1-查看日志配置" class="headerlink" title="3.1 查看日志配置"></a>3.1 查看日志配置</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看所有日志配置</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%log%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看错误日志配置</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;log_error%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看 binlog 配置</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;log_bin%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看慢查询配置</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;slow_query%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-动态开启-关闭"><a href="#3-2-动态开启-关闭" class="headerlink" title="3.2 动态开启&#x2F;关闭"></a>3.2 动态开启&#x2F;关闭</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 开启/关闭通用查询日志</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> general_log <span class="operator">=</span> <span class="string">&#x27;ON&#x27;</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> general_log <span class="operator">=</span> <span class="string">&#x27;OFF&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 开启/关闭慢查询日志</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> slow_query_log <span class="operator">=</span> <span class="string">&#x27;ON&#x27;</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> slow_query_log <span class="operator">=</span> <span class="string">&#x27;OFF&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看 binlog 状态</span></span><br><span class="line"><span class="keyword">SHOW</span> MASTER STATUS;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-刷新日志"><a href="#3-3-刷新日志" class="headerlink" title="3.3 刷新日志"></a>3.3 刷新日志</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 刷新所有日志</span></span><br><span class="line">FLUSH LOGS;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 刷新 binlog（开始新文件）</span></span><br><span class="line">FLUSH <span class="type">BINARY</span> LOGS;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 刷新错误日志（MySQL 8.0.19+）</span></span><br><span class="line"><span class="keyword">CALL</span> mysql.system_command(<span class="string">&#x27;REFRESH ERROR LOG&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="四、日志分析工具"><a href="#四、日志分析工具" class="headerlink" title="四、日志分析工具"></a>四、日志分析工具</h2><h3 id="4-1-错误日志分析"><a href="#4-1-错误日志分析" class="headerlink" title="4.1 错误日志分析"></a>4.1 错误日志分析</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看最新错误</span></span><br><span class="line"><span class="built_in">tail</span> -100 /var/log/mysql/error.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索 ERROR 级别日志</span></span><br><span class="line">grep -i <span class="string">&quot;error&quot;</span> /var/log/mysql/error.log | <span class="built_in">tail</span> -50</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按时间筛选</span></span><br><span class="line">awk <span class="string">&#x27;/2024-02-24/,/2024-02-25/&#x27;</span> /var/log/mysql/error.log</span><br></pre></td></tr></table></figure>

<h3 id="4-2-Binlog-分析工具"><a href="#4-2-Binlog-分析工具" class="headerlink" title="4.2 Binlog 分析工具"></a>4.2 Binlog 分析工具</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看 binlog 内容</span></span><br><span class="line">mysqlbinlog /var/log/mysql/mysql-bin.000001</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定数据库</span></span><br><span class="line">mysqlbinlog -d your_database /var/log/mysql/mysql-bin.000001</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按时间筛选</span></span><br><span class="line">mysqlbinlog --start-datetime=<span class="string">&quot;2024-02-24 00:00:00&quot;</span> \</span><br><span class="line">            --stop-datetime=<span class="string">&quot;2024-02-24 23:59:59&quot;</span> \</span><br><span class="line">            /var/log/mysql/mysql-bin.000001</span><br></pre></td></tr></table></figure>

<h3 id="4-3-慢查询分析"><a href="#4-3-慢查询分析" class="headerlink" title="4.3 慢查询分析"></a>4.3 慢查询分析</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看慢查询日志</span></span><br><span class="line"><span class="built_in">tail</span> -100 /var/log/mysql/slow.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># mysqldumpslow 分析</span></span><br><span class="line">mysqldumpslow -s t -t 10 /var/log/mysql/slow.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># pt-query-digest 分析（推荐）</span></span><br><span class="line">pt-query-digest /var/log/mysql/slow.log</span><br></pre></td></tr></table></figure>

<h2 id="五、生产环境日志策略"><a href="#五、生产环境日志策略" class="headerlink" title="五、生产环境日志策略"></a>五、生产环境日志策略</h2><h3 id="5-1-推荐配置"><a href="#5-1-推荐配置" class="headerlink" title="5.1 推荐配置"></a>5.1 推荐配置</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># 错误日志 - 始终开启</span></span><br><span class="line"><span class="attr">log_error</span> = /var/log/mysql/error.log</span><br><span class="line"><span class="attr">log_error_verbosity</span> = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 二进制日志 - 生产环境开启</span></span><br><span class="line"><span class="attr">log_bin</span> = /var/log/mysql/mysql-bin</span><br><span class="line"><span class="attr">expire_logs_days</span> = <span class="number">7</span></span><br><span class="line"><span class="attr">binlog_format</span> = ROW</span><br><span class="line"><span class="attr">sync_binlog</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 慢查询日志 - 根据需求开启</span></span><br><span class="line"><span class="attr">slow_query_log</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">slow_query_log_file</span> = /var/log/mysql/slow.log</span><br><span class="line"><span class="attr">long_query_time</span> = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通用查询日志 - 默认关闭（需要时开启）</span></span><br><span class="line"><span class="comment"># general_log = 0</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-日志轮转"><a href="#5-2-日志轮转" class="headerlink" title="5.2 日志轮转"></a>5.2 日志轮转</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># logrotate 配置 /etc/logrotate.d/mysql</span></span><br><span class="line">/var/log/mysql/*.<span class="built_in">log</span> &#123;</span><br><span class="line">    daily</span><br><span class="line">    rotate 7</span><br><span class="line">    compress</span><br><span class="line">    delaycompress</span><br><span class="line">    missingok</span><br><span class="line">    notifempty</span><br><span class="line">    create 640 mysql mysql</span><br><span class="line">    postrotate</span><br><span class="line">        /usr/bin/mysqladmin flush-logs</span><br><span class="line">    endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-磁盘空间管理"><a href="#5-3-磁盘空间管理" class="headerlink" title="5.3 磁盘空间管理"></a>5.3 磁盘空间管理</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看 binlog 占用</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="type">BINARY</span> LOGS;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 清理过期 binlog（自动）</span></span><br><span class="line"><span class="comment">-- 通过 expire_logs_days 参数控制</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 手动清理 binlog</span></span><br><span class="line">PURGE <span class="type">BINARY</span> LOGS <span class="keyword">TO</span> <span class="string">&#x27;mysql-bin.000010&#x27;</span>;</span><br><span class="line">PURGE <span class="type">BINARY</span> LOGS BEFORE <span class="string">&#x27;2024-02-20 00:00:00&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="六、课程安排"><a href="#六、课程安排" class="headerlink" title="六、课程安排"></a>六、课程安排</h2><h3 id="6-1-本章内容"><a href="#6-1-本章内容" class="headerlink" title="6.1 本章内容"></a>6.1 本章内容</h3><table>
<thead>
<tr>
<th>节号</th>
<th>主题</th>
<th>内容</th>
</tr>
</thead>
<tbody><tr>
<td>01-01</td>
<td>课程介绍</td>
<td>日志系统概述</td>
</tr>
<tr>
<td>01-02</td>
<td>错误日志</td>
<td>配置、查看、分析</td>
</tr>
<tr>
<td>01-03</td>
<td>二进制日志</td>
<td>格式、配置、恢复</td>
</tr>
<tr>
<td>01-04</td>
<td>查询日志</td>
<td>配置、使用场景</td>
</tr>
<tr>
<td>01-05</td>
<td>慢查询日志</td>
<td>配置、分析工具、实战</td>
</tr>
</tbody></table>
<h3 id="6-2-学习目标"><a href="#6-2-学习目标" class="headerlink" title="6.2 学习目标"></a>6.2 学习目标</h3><ol>
<li><strong>理解日志作用</strong>：掌握各类日志的用途和适用场景</li>
<li><strong>掌握配置方法</strong>：能够正确配置各类日志</li>
<li><strong>学会分析工具</strong>：能够使用工具分析日志</li>
<li><strong>制定运维策略</strong>：能够制定生产环境日志策略</li>
</ol>
<h2 id="七、小结"><a href="#七、小结" class="headerlink" title="七、小结"></a>七、小结</h2><h3 id="日志系统总结"><a href="#日志系统总结" class="headerlink" title="日志系统总结"></a>日志系统总结</h3><table>
<thead>
<tr>
<th>日志</th>
<th>重要性</th>
<th>性能影响</th>
<th>生产建议</th>
</tr>
</thead>
<tbody><tr>
<td>错误日志</td>
<td>⭐⭐⭐⭐⭐</td>
<td>无</td>
<td>始终开启</td>
</tr>
<tr>
<td>二进制日志</td>
<td>⭐⭐⭐⭐⭐</td>
<td>低</td>
<td>建议开启</td>
</tr>
<tr>
<td>慢查询日志</td>
<td>⭐⭐⭐⭐</td>
<td>低</td>
<td>定期开启</td>
</tr>
<tr>
<td>查询日志</td>
<td>⭐⭐</td>
<td>高</td>
<td>临时开启</td>
</tr>
</tbody></table>
<h3 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h3><ol>
<li><strong>错误日志</strong>：始终开启，定期查看</li>
<li><strong>二进制日志</strong>：生产环境开启，合理设置保留期</li>
<li><strong>慢查询日志</strong>：定期开启分析，分析后关闭</li>
<li><strong>查询日志</strong>：仅在调试时临时开启</li>
</ol>
<hr>
<p><strong>下一篇</strong>：[MySQL 运维篇 01-02 错误日志](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 01-02 错误日志&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 进阶教程 15-05 进阶篇总结](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 15-05 进阶篇总结&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 运维篇</category>
      </categories>
      <tags>
        <tag>运维</tag>
        <tag>MySQL</tag>
        <tag>日志</tag>
        <tag>课程介绍</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 运维篇 01-02 错误日志</title>
    <url>/2026/02/24/MySQL%20%E8%BF%90%E7%BB%B4%E7%AF%87%2001-02%20%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97/</url>
    <content><![CDATA[<h1 id="MySQL-运维篇-01-02-错误日志"><a href="#MySQL-运维篇-01-02-错误日志" class="headerlink" title="MySQL 运维篇 01-02 错误日志"></a>MySQL 运维篇 01-02 错误日志</h1><p>错误日志（Error Log）是 MySQL 最重要的日志，记录了数据库启动、运行和停止过程中的错误、警告和提示信息。它是故障排查的首选工具。</p>
<h2 id="一、错误日志介绍"><a href="#一、错误日志介绍" class="headerlink" title="一、错误日志介绍"></a>一、错误日志介绍</h2><h3 id="1-1-什么是错误日志？"><a href="#1-1-什么是错误日志？" class="headerlink" title="1.1 什么是错误日志？"></a>1.1 什么是错误日志？</h3><p><strong>错误日志</strong>记录 MySQL 服务器运行过程中遇到的各种错误和异常情况：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">错误日志记录内容：</span><br><span class="line">├── 服务器启动/停止信息</span><br><span class="line">├── 严重错误（如表损坏、磁盘满）</span><br><span class="line">├── 警告信息（如配置问题）</span><br><span class="line">├── 连接错误（如认证失败）</span><br><span class="line">├── 复制错误</span><br><span class="line">└── InnoDB 引擎错误</span><br></pre></td></tr></table></figure>

<h3 id="1-2-错误级别"><a href="#1-2-错误级别" class="headerlink" title="1.2 错误级别"></a>1.2 错误级别</h3><table>
<thead>
<tr>
<th>级别</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>ERROR</td>
<td>严重错误，需要立即处理</td>
<td>磁盘满、表损坏</td>
</tr>
<tr>
<td>WARNING</td>
<td>警告，可能影响运行</td>
<td>配置参数不推荐</td>
</tr>
<tr>
<td>NOTE</td>
<td>提示信息，一般无需处理</td>
<td>正常启动信息</td>
</tr>
</tbody></table>
<h3 id="1-3-错误日志格式"><a href="#1-3-错误日志格式" class="headerlink" title="1.3 错误日志格式"></a>1.3 错误日志格式</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># MySQL 5.7 格式</span><br><span class="line">2024-02-24T10:30:45.123456Z 0 [ERROR] InnoDB: Unable to lock ./ibdata1 error: 11</span><br><span class="line"></span><br><span class="line"># MySQL 8.0 格式（组件化）</span><br><span class="line">2024-02-24T10:30:45.123456Z 0 [ERROR] [MY-010095] [Server] Unknown option &#x27;--old-option&#x27;</span><br><span class="line"></span><br><span class="line"># 字段说明</span><br><span class="line">日期时间 | 线程 ID | 级别 | 组件 | 错误码 | 消息</span><br></pre></td></tr></table></figure>

<h2 id="二、错误日志配置"><a href="#二、错误日志配置" class="headerlink" title="二、错误日志配置"></a>二、错误日志配置</h2><h3 id="2-1-配置文件位置"><a href="#2-1-配置文件位置" class="headerlink" title="2.1 配置文件位置"></a>2.1 配置文件位置</h3><p><strong>Windows</strong>：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line">C:\ProgramData\MySQL\MySQL Server 8.0\my.ini</span><br></pre></td></tr></table></figure>

<p><strong>Linux</strong>：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line">/etc/my.cnf 或 /etc/mysql/my.cnf</span><br></pre></td></tr></table></figure>

<h3 id="2-2-基本配置参数"><a href="#2-2-基本配置参数" class="headerlink" title="2.2 基本配置参数"></a>2.2 基本配置参数</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># 错误日志文件路径</span></span><br><span class="line"><span class="attr">log_error</span> = /var/log/mysql/error.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 错误日志详细程度（MySQL 5.7+）</span></span><br><span class="line"><span class="comment"># 1 = 只记录错误</span></span><br><span class="line"><span class="comment"># 2 = 错误 + 警告（默认）</span></span><br><span class="line"><span class="comment"># 3 = 错误 + 警告 + 提示</span></span><br><span class="line"><span class="attr">log_error_verbosity</span> = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 是否记录时间戳（MySQL 5.7）</span></span><br><span class="line"><span class="attr">log_timestamps</span> = SYSTEM  <span class="comment"># 或 UTC</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-MySQL-8-0-组件化日志"><a href="#2-3-MySQL-8-0-组件化日志" class="headerlink" title="2.3 MySQL 8.0 组件化日志"></a>2.3 MySQL 8.0 组件化日志</h3><p>MySQL 8.0 引入了组件化日志系统：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># 使用传统文件日志（默认）</span></span><br><span class="line"><span class="attr">log_error_services</span> = log_sink_files</span><br><span class="line"></span><br><span class="line"><span class="comment"># 同时使用文件和控制台</span></span><br><span class="line"><span class="attr">log_error_services</span> = log_sink_files<span class="comment">;log_sink_syslog</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志组件过滤级别</span></span><br><span class="line"><span class="attr">log_error_filter_syslog</span> = <span class="string">&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-4-配置示例"><a href="#2-4-配置示例" class="headerlink" title="2.4 配置示例"></a>2.4 配置示例</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># Linux 生产环境推荐配置</span></span><br><span class="line"><span class="attr">log_error</span> = /var/log/mysql/error.log</span><br><span class="line"><span class="attr">log_error_verbosity</span> = <span class="number">2</span></span><br><span class="line"><span class="attr">log_timestamps</span> = SYSTEM</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果使用了 systemd</span></span><br><span class="line"><span class="attr">log_error_services</span> = log_sink_files<span class="comment">;log_sink_syslog</span></span><br></pre></td></tr></table></figure>

<h2 id="三、查看错误日志"><a href="#三、查看错误日志" class="headerlink" title="三、查看错误日志"></a>三、查看错误日志</h2><h3 id="3-1-查看配置位置"><a href="#3-1-查看配置位置" class="headerlink" title="3.1 查看配置位置"></a>3.1 查看配置位置</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看错误日志路径</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;log_error&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看详细程度</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;log_error_verbosity&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看日志服务</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;log_error_services&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-命令行查看"><a href="#3-2-命令行查看" class="headerlink" title="3.2 命令行查看"></a>3.2 命令行查看</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看最新 100 行</span></span><br><span class="line"><span class="built_in">tail</span> -100 /var/log/mysql/error.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实时跟踪日志</span></span><br><span class="line"><span class="built_in">tail</span> -f /var/log/mysql/error.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看最新错误</span></span><br><span class="line">grep -i <span class="string">&quot;error&quot;</span> /var/log/mysql/error.log | <span class="built_in">tail</span> -50</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看警告</span></span><br><span class="line">grep -i <span class="string">&quot;warning&quot;</span> /var/log/mysql/error.log | <span class="built_in">tail</span> -50</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按日期筛选</span></span><br><span class="line">awk <span class="string">&#x27;/2024-02-24/&#x27;</span> /var/log/mysql/error.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看特定错误</span></span><br><span class="line">grep -i <span class="string">&quot;InnoDB&quot;</span> /var/log/mysql/error.log | <span class="built_in">tail</span> -20</span><br></pre></td></tr></table></figure>

<h3 id="3-3-使用-MySQL-命令"><a href="#3-3-使用-MySQL-命令" class="headerlink" title="3.3 使用 MySQL 命令"></a>3.3 使用 MySQL 命令</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- MySQL 8.0+ 查看错误日志</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> performance_schema.error_log</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="type">TIMESTAMP</span> <span class="keyword">DESC</span></span><br><span class="line">LIMIT <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看特定级别的错误</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> performance_schema.error_log</span><br><span class="line"><span class="keyword">WHERE</span> LEVEL <span class="operator">=</span> <span class="string">&#x27;ERROR&#x27;</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="type">TIMESTAMP</span> <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h2 id="四、常见错误分析"><a href="#四、常见错误分析" class="headerlink" title="四、常见错误分析"></a>四、常见错误分析</h2><h3 id="4-1-启动失败错误"><a href="#4-1-启动失败错误" class="headerlink" title="4.1 启动失败错误"></a>4.1 启动失败错误</h3><p><strong>错误 1：端口被占用</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[ERROR] Can&#x27;t start server: bind on TCP/IP port: Address already in use</span><br></pre></td></tr></table></figure>

<p><strong>解决方案</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看端口占用</span></span><br><span class="line">netstat -tlnp | grep 3306</span><br><span class="line">lsof -i :3306</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改端口或停止占用进程</span></span><br></pre></td></tr></table></figure>

<p><strong>错误 2：数据目录权限问题</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[ERROR] Can&#x27;t create directory &#x27;/var/lib/mysql&#x27; - Permission denied</span><br></pre></td></tr></table></figure>

<p><strong>解决方案</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 修改权限</span></span><br><span class="line"><span class="built_in">chown</span> -R mysql:mysql /var/lib/mysql</span><br><span class="line"><span class="built_in">chmod</span> 750 /var/lib/mysql</span><br></pre></td></tr></table></figure>

<h3 id="4-2-磁盘空间错误"><a href="#4-2-磁盘空间错误" class="headerlink" title="4.2 磁盘空间错误"></a>4.2 磁盘空间错误</h3><p><strong>错误</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[ERROR] Disk full (/var/lib/mysql/#sql_...); waiting for someone to free some space...</span><br></pre></td></tr></table></figure>

<p><strong>解决方案</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看磁盘空间</span></span><br><span class="line"><span class="built_in">df</span> -h</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理 binlog</span></span><br><span class="line">PURGE BINARY LOGS BEFORE <span class="string">&#x27;2024-02-01&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理日志</span></span><br><span class="line"><span class="built_in">rm</span> /var/log/mysql/*.log.1</span><br></pre></td></tr></table></figure>

<h3 id="4-3-InnoDB-错误"><a href="#4-3-InnoDB-错误" class="headerlink" title="4.3 InnoDB 错误"></a>4.3 InnoDB 错误</h3><p><strong>错误 1：表空间损坏</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[ERROR] InnoDB: Database page corruption on disk or a failed file read of page</span><br></pre></td></tr></table></figure>

<p><strong>解决方案</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 跳过损坏的行继续启动</span></span><br><span class="line"><span class="comment">-- 在配置文件中添加</span></span><br><span class="line">innodb_force_recovery <span class="operator">=</span> <span class="number">1</span>  # <span class="number">1</span><span class="number">-6</span>，数字越大恢复程度越高</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 导出数据，重建表</span></span><br></pre></td></tr></table></figure>

<p><strong>错误 2：表空间不足</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[ERROR] InnoDB: Cannot allocate memory for the buffer pool</span><br></pre></td></tr></table></figure>

<p><strong>解决方案</strong>：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 减少缓冲池大小</span></span><br><span class="line"><span class="attr">innodb_buffer_pool_size</span> = <span class="number">1</span>G</span><br></pre></td></tr></table></figure>

<h3 id="4-4-连接错误"><a href="#4-4-连接错误" class="headerlink" title="4.4 连接错误"></a>4.4 连接错误</h3><p><strong>错误</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[Warning] Access denied for user &#x27;root&#x27;@&#x27;localhost&#x27; (using password: YES)</span><br></pre></td></tr></table></figure>

<p><strong>解决方案</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 重置 root 密码</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">USER</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;new_password&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 或检查密码是否正确</span></span><br></pre></td></tr></table></figure>

<h3 id="4-5-复制错误"><a href="#4-5-复制错误" class="headerlink" title="4.5 复制错误"></a>4.5 复制错误</h3><p><strong>错误</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[ERROR] Slave SQL for channel &#x27;&#x27;: Relay log read failure: Could not parse relay log event entry</span><br></pre></td></tr></table></figure>

<p><strong>解决方案</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 跳过错误（谨慎使用）</span></span><br><span class="line">STOP SLAVE;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> sql_slave_skip_counter <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">START</span> SLAVE;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 或重新配置从库</span></span><br></pre></td></tr></table></figure>

<h2 id="五、错误日志分析实战"><a href="#五、错误日志分析实战" class="headerlink" title="五、错误日志分析实战"></a>五、错误日志分析实战</h2><h3 id="5-1-错误频率统计"><a href="#5-1-错误频率统计" class="headerlink" title="5.1 错误频率统计"></a>5.1 错误频率统计</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 统计各类错误数量</span></span><br><span class="line">grep -o <span class="string">&#x27;\[ERROR\]&#x27;</span> /var/log/mysql/error.log | <span class="built_in">wc</span> -l</span><br><span class="line">grep -o <span class="string">&#x27;\[Warning\]&#x27;</span> /var/log/mysql/error.log | <span class="built_in">wc</span> -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按错误码统计</span></span><br><span class="line">grep -o <span class="string">&#x27;\[MY-[0-9-]*\]&#x27;</span> /var/log/mysql/error.log | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -rn</span><br></pre></td></tr></table></figure>

<h3 id="5-2-错误时间分析"><a href="#5-2-错误时间分析" class="headerlink" title="5.2 错误时间分析"></a>5.2 错误时间分析</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看错误高发时段</span></span><br><span class="line">awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> /var/log/mysql/error.log | <span class="built_in">cut</span> -d<span class="string">&#x27;T&#x27;</span> -f1 | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看每小时错误分布</span></span><br><span class="line">awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> /var/log/mysql/error.log | <span class="built_in">cut</span> -d<span class="string">&#x27;T&#x27;</span> -f2 | <span class="built_in">cut</span> -d<span class="string">&#x27;:&#x27;</span> -f1 | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c</span><br></pre></td></tr></table></figure>

<h3 id="5-3-自动化监控脚本"><a href="#5-3-自动化监控脚本" class="headerlink" title="5.3 自动化监控脚本"></a>5.3 自动化监控脚本</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># check_mysql_errors.sh</span></span><br><span class="line"></span><br><span class="line">LOG_FILE=<span class="string">&quot;/var/log/mysql/error.log&quot;</span></span><br><span class="line">ALERT_EMAIL=<span class="string">&quot;admin@example.com&quot;</span></span><br><span class="line">ERROR_COUNT=$(grep -c <span class="string">&#x27;\[ERROR\]&#x27;</span> <span class="string">&quot;<span class="variable">$LOG_FILE</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$ERROR_COUNT</span> -gt 10 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;MySQL 错误数量：<span class="variable">$ERROR_COUNT</span>&quot;</span> | mail -s <span class="string">&quot;MySQL 告警&quot;</span> <span class="variable">$ALERT_EMAIL</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h2 id="六、日志轮转和管理"><a href="#六、日志轮转和管理" class="headerlink" title="六、日志轮转和管理"></a>六、日志轮转和管理</h2><h3 id="6-1-logrotate-配置"><a href="#6-1-logrotate-配置" class="headerlink" title="6.1 logrotate 配置"></a>6.1 logrotate 配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /etc/logrotate.d/mysql-server</span></span><br><span class="line">/var/log/mysql/error.log &#123;</span><br><span class="line">    daily</span><br><span class="line">    rotate 7</span><br><span class="line">    compress</span><br><span class="line">    delaycompress</span><br><span class="line">    missingok</span><br><span class="line">    notifempty</span><br><span class="line">    create 640 mysql mysql</span><br><span class="line">    postrotate</span><br><span class="line">        /usr/bin/mysqladmin flush-logs &gt; /dev/null 2&gt;&amp;1 || <span class="literal">true</span></span><br><span class="line">    endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-手动刷新日志"><a href="#6-2-手动刷新日志" class="headerlink" title="6.2 手动刷新日志"></a>6.2 手动刷新日志</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 刷新错误日志（MySQL 8.0.19+）</span></span><br><span class="line"><span class="keyword">CALL</span> mysql.system_command(<span class="string">&#x27;REFRESH ERROR LOG&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 刷新所有日志</span></span><br><span class="line">FLUSH LOGS;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-日志文件大小控制"><a href="#6-3-日志文件大小控制" class="headerlink" title="6.3 日志文件大小控制"></a>6.3 日志文件大小控制</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># MySQL 8.0+ 可以配置日志文件大小限制</span></span><br><span class="line"><span class="attr">log_error_max_size</span> = <span class="number">100</span>M  <span class="comment"># 单个文件最大 100MB</span></span><br></pre></td></tr></table></figure>

<h2 id="七、最佳实践"><a href="#七、最佳实践" class="headerlink" title="七、最佳实践"></a>七、最佳实践</h2><h3 id="7-1-配置建议"><a href="#7-1-配置建议" class="headerlink" title="7.1 配置建议"></a>7.1 配置建议</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># 生产环境推荐配置</span></span><br><span class="line"><span class="attr">log_error</span> = /var/log/mysql/error.log</span><br><span class="line"><span class="attr">log_error_verbosity</span> = <span class="number">2</span></span><br><span class="line"><span class="attr">log_timestamps</span> = SYSTEM</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果使用 systemd</span></span><br><span class="line"><span class="attr">log_error_services</span> = log_sink_files<span class="comment">;log_sink_syslog</span></span><br></pre></td></tr></table></figure>

<h3 id="7-2-运维建议"><a href="#7-2-运维建议" class="headerlink" title="7.2 运维建议"></a>7.2 运维建议</h3><table>
<thead>
<tr>
<th>项目</th>
<th>建议</th>
</tr>
</thead>
<tbody><tr>
<td>日志位置</td>
<td>独立磁盘分区，避免占满系统盘</td>
</tr>
<tr>
<td>日志轮转</td>
<td>每日轮转，保留 7 天</td>
</tr>
<tr>
<td>监控告警</td>
<td>错误数量超过阈值时告警</td>
</tr>
<tr>
<td>定期检查</td>
<td>每天查看最新错误</td>
</tr>
</tbody></table>
<h3 id="7-3-排查流程"><a href="#7-3-排查流程" class="headerlink" title="7.3 排查流程"></a>7.3 排查流程</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 查看最新错误：tail -100 error.log</span><br><span class="line">2. 搜索关键错误：grep -i &quot;error&quot; error.log</span><br><span class="line">3. 分析错误时间：确定发生时间</span><br><span class="line">4. 关联其他日志：binlog、慢查询日志</span><br><span class="line">5. 查找解决方案：根据错误码搜索</span><br></pre></td></tr></table></figure>

<h2 id="八、小结"><a href="#八、小结" class="headerlink" title="八、小结"></a>八、小结</h2><h3 id="核心知识点"><a href="#核心知识点" class="headerlink" title="核心知识点"></a>核心知识点</h3><ol>
<li><strong>错误日志作用</strong>：记录系统错误，故障排查首选</li>
<li><strong>配置参数</strong>：log_error、log_error_verbosity</li>
<li><strong>查看方法</strong>：命令行 tail&#x2F;grep、MySQL 命令</li>
<li><strong>常见错误</strong>：启动失败、磁盘满、InnoDB 错误</li>
</ol>
<h3 id="常用命令速查"><a href="#常用命令速查" class="headerlink" title="常用命令速查"></a>常用命令速查</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看最新错误</span></span><br><span class="line"><span class="built_in">tail</span> -100 /var/log/mysql/error.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实时跟踪</span></span><br><span class="line"><span class="built_in">tail</span> -f /var/log/mysql/error.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索错误</span></span><br><span class="line">grep -i <span class="string">&quot;error&quot;</span> /var/log/mysql/error.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 刷新日志</span></span><br><span class="line">FLUSH LOGS;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>下一篇</strong>：[MySQL 运维篇 01-03 二进制日志](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 01-03 二进制日志&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 运维篇 01-01 日志详解课程介绍](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 01-01 日志详解课程介绍&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 运维篇</category>
      </categories>
      <tags>
        <tag>运维</tag>
        <tag>MySQL</tag>
        <tag>错误日志</tag>
        <tag>故障排查</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 运维篇 01-04 查询日志</title>
    <url>/2026/02/24/MySQL%20%E8%BF%90%E7%BB%B4%E7%AF%87%2001-04%20%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97/</url>
    <content><![CDATA[<h1 id="MySQL-运维篇-01-04-查询日志"><a href="#MySQL-运维篇-01-04-查询日志" class="headerlink" title="MySQL 运维篇 01-04 查询日志"></a>MySQL 运维篇 01-04 查询日志</h1><p>查询日志（General Query Log，简称 general log）记录 MySQL 服务器接收到的所有客户端请求。虽然性能开销较大，但在特定场景下非常有用。</p>
<h2 id="一、查询日志介绍"><a href="#一、查询日志介绍" class="headerlink" title="一、查询日志介绍"></a>一、查询日志介绍</h2><h3 id="1-1-什么是查询日志？"><a href="#1-1-什么是查询日志？" class="headerlink" title="1.1 什么是查询日志？"></a>1.1 什么是查询日志？</h3><p><strong>查询日志</strong>记录所有客户端连接和执行的 SQL 语句：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">查询日志记录内容：</span><br><span class="line">├── 客户端连接/断开</span><br><span class="line">├── 所有 SQL 请求（SELECT、INSERT、UPDATE、DELETE 等）</span><br><span class="line">├── 存储过程调用</span><br><span class="line">└── 管理员命令（SET、SHOW 等）</span><br></pre></td></tr></table></figure>

<h3 id="1-2-查询日志-vs-其他日志"><a href="#1-2-查询日志-vs-其他日志" class="headerlink" title="1.2 查询日志 vs 其他日志"></a>1.2 查询日志 vs 其他日志</h3><table>
<thead>
<tr>
<th>特性</th>
<th>查询日志</th>
<th>慢查询日志</th>
<th>二进制日志</th>
</tr>
</thead>
<tbody><tr>
<td>记录内容</td>
<td>所有查询</td>
<td>慢查询</td>
<td>数据变更</td>
</tr>
<tr>
<td>记录时机</td>
<td>查询开始时</td>
<td>查询结束后</td>
<td>事务提交时</td>
</tr>
<tr>
<td>性能影响</td>
<td>高</td>
<td>低</td>
<td>中</td>
</tr>
<tr>
<td>使用场景</td>
<td>调试、审计</td>
<td>性能优化</td>
<td>恢复、复制</td>
</tr>
</tbody></table>
<h3 id="1-3-使用场景"><a href="#1-3-使用场景" class="headerlink" title="1.3 使用场景"></a>1.3 使用场景</h3><table>
<thead>
<tr>
<th>场景</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>问题调试</td>
<td>追踪应用执行的 SQL</td>
</tr>
<tr>
<td>安全审计</td>
<td>记录用户操作历史</td>
</tr>
<tr>
<td>性能分析</td>
<td>分析查询频率和模式</td>
</tr>
<tr>
<td>故障排查</td>
<td>定位问题 SQL</td>
</tr>
</tbody></table>
<h2 id="二、查询日志配置"><a href="#二、查询日志配置" class="headerlink" title="二、查询日志配置"></a>二、查询日志配置</h2><h3 id="2-1-基本配置参数"><a href="#2-1-基本配置参数" class="headerlink" title="2.1 基本配置参数"></a>2.1 基本配置参数</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># 开启查询日志</span></span><br><span class="line"><span class="attr">general_log</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志文件路径</span></span><br><span class="line"><span class="attr">general_log_file</span> = /var/log/mysql/general.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志输出方式（MySQL 5.6+）</span></span><br><span class="line"><span class="comment"># FILE = 文件输出</span></span><br><span class="line"><span class="comment"># TABLE = 输出到 mysql.general_log 表</span></span><br><span class="line"><span class="attr">log_output</span> = FILE</span><br></pre></td></tr></table></figure>

<h3 id="2-2-配置参数详解"><a href="#2-2-配置参数详解" class="headerlink" title="2.2 配置参数详解"></a>2.2 配置参数详解</h3><p><strong>general_log</strong>：</p>
<ul>
<li><code>0</code> &#x3D; 关闭（默认）</li>
<li><code>1</code> &#x3D; 开启</li>
</ul>
<p><strong>general_log_file</strong>：</p>
<ul>
<li>指定日志文件路径</li>
<li>默认位置因操作系统而异</li>
</ul>
<p><strong>log_output</strong>：</p>
<ul>
<li><code>FILE</code>：输出到文件（推荐）</li>
<li><code>TABLE</code>：输出到系统表</li>
<li><code>FILE,TABLE</code>：同时输出</li>
</ul>
<h3 id="2-3-动态配置"><a href="#2-3-动态配置" class="headerlink" title="2.3 动态配置"></a>2.3 动态配置</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 临时开启查询日志（重启失效）</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> general_log <span class="operator">=</span> <span class="string">&#x27;ON&#x27;</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> general_log_file <span class="operator">=</span> <span class="string">&#x27;/var/log/mysql/general.log&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看配置</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;general_log%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 临时关闭</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> general_log <span class="operator">=</span> <span class="string">&#x27;OFF&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-输出到表配置"><a href="#2-4-输出到表配置" class="headerlink" title="2.4 输出到表配置"></a>2.4 输出到表配置</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 输出到表</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> log_output <span class="operator">=</span> <span class="string">&#x27;TABLE&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 开启日志</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> general_log <span class="operator">=</span> <span class="string">&#x27;ON&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看日志</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> mysql.general_log <span class="keyword">ORDER</span> <span class="keyword">BY</span> event_time <span class="keyword">DESC</span> LIMIT <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 清空日志</span></span><br><span class="line"><span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span> mysql.general_log;</span><br></pre></td></tr></table></figure>

<h2 id="三、查看查询日志"><a href="#三、查看查询日志" class="headerlink" title="三、查看查询日志"></a>三、查看查询日志</h2><h3 id="3-1-查看配置"><a href="#3-1-查看配置" class="headerlink" title="3.1 查看配置"></a>3.1 查看配置</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看是否开启</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;general_log&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看日志路径</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;general_log_file&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看输出方式</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;log_output&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-文件方式查看"><a href="#3-2-文件方式查看" class="headerlink" title="3.2 文件方式查看"></a>3.2 文件方式查看</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看最新日志</span></span><br><span class="line"><span class="built_in">tail</span> -100 /var/log/mysql/general.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实时跟踪</span></span><br><span class="line"><span class="built_in">tail</span> -f /var/log/mysql/general.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索特定 SQL</span></span><br><span class="line">grep -i <span class="string">&quot;SELECT&quot;</span> /var/log/mysql/general.log | <span class="built_in">tail</span> -50</span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索特定用户</span></span><br><span class="line">grep <span class="string">&quot;root&quot;</span> /var/log/mysql/general.log | <span class="built_in">tail</span> -50</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按时间筛选</span></span><br><span class="line">awk <span class="string">&#x27;/2024-02-24/&#x27;</span> /var/log/mysql/general.log</span><br></pre></td></tr></table></figure>

<h3 id="3-3-表方式查看"><a href="#3-3-表方式查看" class="headerlink" title="3.3 表方式查看"></a>3.3 表方式查看</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看最新 100 条</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> mysql.general_log</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> event_time <span class="keyword">DESC</span></span><br><span class="line">LIMIT <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看特定用户的操作</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> mysql.general_log</span><br><span class="line"><span class="keyword">WHERE</span> user_host <span class="keyword">LIKE</span> <span class="string">&#x27;%root%&#x27;</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> event_time <span class="keyword">DESC</span></span><br><span class="line">LIMIT <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看特定类型的 SQL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> mysql.general_log</span><br><span class="line"><span class="keyword">WHERE</span> argument <span class="keyword">LIKE</span> <span class="string">&#x27;SELECT%&#x27;</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> event_time <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 统计各类 SQL 数量</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">LEFT</span>(argument, LOCATE(<span class="string">&#x27; &#x27;</span>, argument)) <span class="keyword">AS</span> sql_type,</span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt</span><br><span class="line"><span class="keyword">FROM</span> mysql.general_log</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> sql_type;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看执行时间</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    event_time,</span><br><span class="line">    user_host,</span><br><span class="line">    argument</span><br><span class="line"><span class="keyword">FROM</span> mysql.general_log</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> event_time <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-4-查询日志格式"><a href="#3-4-查询日志格式" class="headerlink" title="3.4 查询日志格式"></a>3.4 查询日志格式</h3><p><strong>文件格式</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">2024-02-24T10:30:45.123456Z	    1 Query	root[root] @ localhost [] 12345	0	SELECT * FROM users WHERE id = 1</span><br><span class="line">2024-02-24T10:30:46.123456Z	    1 Query	root[root] @ localhost [] 0	0	UPDATE users SET name = &#x27;张三&#x27; WHERE id = 1</span><br></pre></td></tr></table></figure>

<p><strong>字段说明</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">时间戳 | 线程 ID | 命令类型 | 用户信息 | 连接 ID | 执行时间 | SQL 语句</span><br></pre></td></tr></table></figure>

<p><strong>表格式</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">DESC</span> mysql.general_log;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------+------+-----+-------------------+</span></span><br><span class="line"><span class="operator">|</span> Field       <span class="operator">|</span> Type         <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------+------+-----+-------------------+</span></span><br><span class="line"><span class="operator">|</span> event_time  <span class="operator">|</span> <span class="type">timestamp</span>    <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> user_host   <span class="operator">|</span> mediumtext   <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> thread_id   <span class="operator">|</span> <span class="type">bigint</span>(<span class="number">21</span>)   <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> server_id   <span class="operator">|</span> <span class="type">int</span>(<span class="number">10</span>)      <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="number">0</span>                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> command_type<span class="operator">|</span> <span class="type">varchar</span>(<span class="number">64</span>)  <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> argument    <span class="operator">|</span> mediumtext   <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------+------+-----+-------------------+</span></span><br></pre></td></tr></table></figure>

<h2 id="四、使用场景"><a href="#四、使用场景" class="headerlink" title="四、使用场景"></a>四、使用场景</h2><h3 id="4-1-应用调试"><a href="#4-1-应用调试" class="headerlink" title="4.1 应用调试"></a>4.1 应用调试</h3><p><strong>场景</strong>：应用行为异常，需要查看实际执行的 SQL</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 1. 开启查询日志</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> general_log <span class="operator">=</span> <span class="string">&#x27;ON&#x27;</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> log_output <span class="operator">=</span> <span class="string">&#x27;TABLE&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 复现问题</span></span><br><span class="line"><span class="comment">-- 在应用中执行操作</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3. 查看日志</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> mysql.general_log</span><br><span class="line"><span class="keyword">WHERE</span> event_time <span class="operator">&gt;</span> NOW() <span class="operator">-</span> <span class="type">INTERVAL</span> <span class="number">10</span> <span class="keyword">MINUTE</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> event_time <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 4. 关闭日志</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> general_log <span class="operator">=</span> <span class="string">&#x27;OFF&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-SQL-审计"><a href="#4-2-SQL-审计" class="headerlink" title="4.2 SQL 审计"></a>4.2 SQL 审计</h3><p><strong>场景</strong>：记录敏感数据访问</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建审计表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> audit_log (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    event_time <span class="type">TIMESTAMP</span>,</span><br><span class="line">    user_name <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    sql_text TEXT</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 定期归档查询日志</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> audit_log (event_time, user_name, sql_text)</span><br><span class="line"><span class="keyword">SELECT</span> event_time,</span><br><span class="line">       SUBSTRING_INDEX(user_host, <span class="string">&#x27;[&#x27;</span>, <span class="number">1</span>) <span class="keyword">AS</span> user_name,</span><br><span class="line">       argument <span class="keyword">AS</span> sql_text</span><br><span class="line"><span class="keyword">FROM</span> mysql.general_log</span><br><span class="line"><span class="keyword">WHERE</span> argument <span class="keyword">LIKE</span> <span class="string">&#x27;%users%&#x27;</span>  <span class="comment">-- 敏感表</span></span><br><span class="line">  <span class="keyword">AND</span> event_time <span class="operator">&gt;</span> NOW() <span class="operator">-</span> <span class="type">INTERVAL</span> <span class="number">1</span> <span class="keyword">DAY</span>;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-性能分析"><a href="#4-3-性能分析" class="headerlink" title="4.3 性能分析"></a>4.3 性能分析</h3><p><strong>场景</strong>：分析查询模式和频率</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 统计最频繁执行的 SQL</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    argument,</span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> exec_count</span><br><span class="line"><span class="keyword">FROM</span> mysql.general_log</span><br><span class="line"><span class="keyword">WHERE</span> command_type <span class="operator">=</span> <span class="string">&#x27;Query&#x27;</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> argument</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> exec_count <span class="keyword">DESC</span></span><br><span class="line">LIMIT <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 统计各类型 SQL 占比</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    command_type,</span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt,</span><br><span class="line">    ROUND(<span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="operator">*</span> <span class="number">100.0</span> <span class="operator">/</span> (<span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> mysql.general_log), <span class="number">2</span>) <span class="keyword">AS</span> percentage</span><br><span class="line"><span class="keyword">FROM</span> mysql.general_log</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> command_type;</span><br></pre></td></tr></table></figure>

<h3 id="4-4-安全监控"><a href="#4-4-安全监控" class="headerlink" title="4.4 安全监控"></a>4.4 安全监控</h3><p><strong>场景</strong>：监控异常访问</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看非本地连接</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> mysql.general_log</span><br><span class="line"><span class="keyword">WHERE</span> user_host <span class="keyword">NOT</span> <span class="keyword">LIKE</span> <span class="string">&#x27;%localhost%&#x27;</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> event_time <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看失败登录（需要配合其他日志）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> mysql.general_log</span><br><span class="line"><span class="keyword">WHERE</span> argument <span class="keyword">LIKE</span> <span class="string">&#x27;%Access denied%&#x27;</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> event_time <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看 DROP/DELETE 等危险操作</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> mysql.general_log</span><br><span class="line"><span class="keyword">WHERE</span> argument <span class="keyword">LIKE</span> <span class="string">&#x27;%DROP%&#x27;</span></span><br><span class="line">   <span class="keyword">OR</span> argument <span class="keyword">LIKE</span> <span class="string">&#x27;%DELETE%&#x27;</span></span><br><span class="line">   <span class="keyword">OR</span> argument <span class="keyword">LIKE</span> <span class="string">&#x27;%TRUNCATE%&#x27;</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> event_time <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h2 id="五、性能影响和优化"><a href="#五、性能影响和优化" class="headerlink" title="五、性能影响和优化"></a>五、性能影响和优化</h2><h3 id="5-1-性能影响"><a href="#5-1-性能影响" class="headerlink" title="5.1 性能影响"></a>5.1 性能影响</h3><table>
<thead>
<tr>
<th>配置</th>
<th>性能影响</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>关闭</td>
<td>无</td>
<td>默认状态</td>
</tr>
<tr>
<td>FILE 输出</td>
<td>中等</td>
<td>约 10-25% 性能下降</td>
</tr>
<tr>
<td>TABLE 输出</td>
<td>高</td>
<td>约 25-40% 性能下降</td>
</tr>
</tbody></table>
<h3 id="5-2-优化建议"><a href="#5-2-优化建议" class="headerlink" title="5.2 优化建议"></a>5.2 优化建议</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># 生产环境不建议长期开启</span></span><br><span class="line"><span class="comment"># 仅在需要时临时开启</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果必须开启，使用 FILE 输出</span></span><br><span class="line"><span class="attr">log_output</span> = FILE</span><br><span class="line"><span class="attr">general_log_file</span> = /var/log/mysql/general.log</span><br></pre></td></tr></table></figure>

<h3 id="5-3-使用建议"><a href="#5-3-使用建议" class="headerlink" title="5.3 使用建议"></a>5.3 使用建议</h3><table>
<thead>
<tr>
<th>场景</th>
<th>建议</th>
</tr>
</thead>
<tbody><tr>
<td>生产环境</td>
<td>默认关闭，需要时开启</td>
</tr>
<tr>
<td>开发环境</td>
<td>可以开启用于调试</td>
</tr>
<tr>
<td>测试环境</td>
<td>可以开启用于分析</td>
</tr>
<tr>
<td>审计需求</td>
<td>开启并定期归档</td>
</tr>
</tbody></table>
<h2 id="六、日志管理"><a href="#六、日志管理" class="headerlink" title="六、日志管理"></a>六、日志管理</h2><h3 id="6-1-日志轮转"><a href="#6-1-日志轮转" class="headerlink" title="6.1 日志轮转"></a>6.1 日志轮转</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /etc/logrotate.d/mysql-general</span></span><br><span class="line">/var/log/mysql/general.log &#123;</span><br><span class="line">    hourly</span><br><span class="line">    rotate 24</span><br><span class="line">    compress</span><br><span class="line">    delaycompress</span><br><span class="line">    missingok</span><br><span class="line">    notifempty</span><br><span class="line">    create 640 mysql mysql</span><br><span class="line">    postrotate</span><br><span class="line">        /usr/bin/mysqladmin flush-logs &gt; /dev/null 2&gt;&amp;1 || <span class="literal">true</span></span><br><span class="line">    endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-清理日志"><a href="#6-2-清理日志" class="headerlink" title="6.2 清理日志"></a>6.2 清理日志</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 文件方式：刷新日志</span></span><br><span class="line">FLUSH LOGS;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 表方式：清空日志</span></span><br><span class="line"><span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span> mysql.general_log;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除旧日志文件</span></span><br><span class="line">rm <span class="operator">/</span>var<span class="operator">/</span>log<span class="operator">/</span>mysql<span class="operator">/</span>general.log.<span class="operator">*</span></span><br></pre></td></tr></table></figure>

<h3 id="6-3-自动化脚本"><a href="#6-3-自动化脚本" class="headerlink" title="6.3 自动化脚本"></a>6.3 自动化脚本</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># manage_general_log.sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查是否开启</span></span><br><span class="line">STATUS=$(mysql -e <span class="string">&quot;SHOW VARIABLES LIKE &#x27;general_log&#x27;;&quot;</span> | grep -c <span class="string">&quot;ON&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$STATUS</span> -eq 1 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;查询日志已开启，注意性能影响&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 检查日志文件大小</span></span><br><span class="line">    SIZE=$(<span class="built_in">ls</span> -lh /var/log/mysql/general.log | awk <span class="string">&#x27;&#123;print $5&#125;&#x27;</span>)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;当前日志大小：<span class="variable">$SIZE</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果超过 1GB，提醒清理</span></span><br><span class="line">    SIZE_BYTES=$(<span class="built_in">ls</span> -l /var/log/mysql/general.log | awk <span class="string">&#x27;&#123;print $5&#125;&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$SIZE_BYTES</span> -gt 1073741824 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;警告：日志文件超过 1GB&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h2 id="七、最佳实践"><a href="#七、最佳实践" class="headerlink" title="七、最佳实践"></a>七、最佳实践</h2><h3 id="7-1-配置建议"><a href="#7-1-配置建议" class="headerlink" title="7.1 配置建议"></a>7.1 配置建议</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># 生产环境 - 默认关闭</span></span><br><span class="line"><span class="attr">general_log</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开发/调试环境 - 开启</span></span><br><span class="line"><span class="comment"># general_log = 1</span></span><br><span class="line"><span class="comment"># general_log_file = /var/log/mysql/general.log</span></span><br><span class="line"><span class="comment"># log_output = FILE</span></span><br></pre></td></tr></table></figure>

<h3 id="7-2-使用流程"><a href="#7-2-使用流程" class="headerlink" title="7.2 使用流程"></a>7.2 使用流程</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 需要时开启：SET GLOBAL general_log = &#x27;ON&#x27;</span><br><span class="line">2. 执行操作：在应用中复现问题</span><br><span class="line">3. 分析日志：SELECT * FROM mysql.general_log</span><br><span class="line">4. 关闭日志：SET GLOBAL general_log = &#x27;OFF&#x27;</span><br><span class="line">5. 清理日志：TRUNCATE TABLE mysql.general_log</span><br></pre></td></tr></table></figure>

<h3 id="7-3-注意事项"><a href="#7-3-注意事项" class="headerlink" title="7.3 注意事项"></a>7.3 注意事项</h3><table>
<thead>
<tr>
<th>注意项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>性能影响</td>
<td>生产环境谨慎开启</td>
</tr>
<tr>
<td>磁盘空间</td>
<td>日志增长快，注意监控</td>
</tr>
<tr>
<td>安全性</td>
<td>日志包含敏感信息</td>
</tr>
<tr>
<td>隐私合规</td>
<td>注意数据保护法规</td>
</tr>
</tbody></table>
<h2 id="八、小结"><a href="#八、小结" class="headerlink" title="八、小结"></a>八、小结</h2><h3 id="核心知识点"><a href="#核心知识点" class="headerlink" title="核心知识点"></a>核心知识点</h3><ol>
<li><strong>查询日志作用</strong>：记录所有客户端请求</li>
<li><strong>输出方式</strong>：FILE（文件）或 TABLE（系统表）</li>
<li><strong>性能影响</strong>：较高，生产环境谨慎开启</li>
<li><strong>使用场景</strong>：调试、审计、分析</li>
</ol>
<h3 id="常用命令速查"><a href="#常用命令速查" class="headerlink" title="常用命令速查"></a>常用命令速查</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 开启/关闭</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> general_log <span class="operator">=</span> <span class="string">&#x27;ON&#x27;</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> general_log <span class="operator">=</span> <span class="string">&#x27;OFF&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看配置</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;general_log%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看日志（表方式）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> mysql.general_log <span class="keyword">ORDER</span> <span class="keyword">BY</span> event_time <span class="keyword">DESC</span> LIMIT <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 刷新日志</span></span><br><span class="line">FLUSH LOGS;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看日志文件</span></span><br><span class="line"><span class="built_in">tail</span> -f /var/log/mysql/general.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索 SQL</span></span><br><span class="line">grep -i <span class="string">&quot;SELECT&quot;</span> /var/log/mysql/general.log</span><br></pre></td></tr></table></figure>

<h3 id="与其他日志对比"><a href="#与其他日志对比" class="headerlink" title="与其他日志对比"></a>与其他日志对比</h3><table>
<thead>
<tr>
<th>日志</th>
<th>记录内容</th>
<th>性能影响</th>
<th>生产建议</th>
</tr>
</thead>
<tbody><tr>
<td>查询日志</td>
<td>所有查询</td>
<td>高</td>
<td>临时开启</td>
</tr>
<tr>
<td>慢查询日志</td>
<td>慢查询</td>
<td>低</td>
<td>定期开启</td>
</tr>
<tr>
<td>错误日志</td>
<td>错误信息</td>
<td>无</td>
<td>始终开启</td>
</tr>
<tr>
<td>二进制日志</td>
<td>数据变更</td>
<td>中</td>
<td>建议开启</td>
</tr>
</tbody></table>
<hr>
<p><strong>下一篇</strong>：[MySQL 运维篇 01-05 慢查询日志](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 01-05 慢查询日志&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 运维篇 01-03 二进制日志](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 01-03 二进制日志&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 运维篇</category>
      </categories>
      <tags>
        <tag>运维</tag>
        <tag>MySQL</tag>
        <tag>查询日志</tag>
        <tag>general log</tag>
        <tag>审计</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 运维篇 01-05 慢查询日志</title>
    <url>/2026/02/24/MySQL%20%E8%BF%90%E7%BB%B4%E7%AF%87%2001-05%20%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97/</url>
    <content><![CDATA[<h1 id="MySQL-运维篇-01-05-慢查询日志"><a href="#MySQL-运维篇-01-05-慢查询日志" class="headerlink" title="MySQL 运维篇 01-05 慢查询日志"></a>MySQL 运维篇 01-05 慢查询日志</h1><p>慢查询日志（Slow Query Log）是 MySQL 性能优化的重要工具，用于记录执行时间超过指定阈值的 SQL 语句。通过分析慢查询日志，可以发现和优化性能瓶颈。</p>
<h2 id="一、慢查询日志介绍"><a href="#一、慢查询日志介绍" class="headerlink" title="一、慢查询日志介绍"></a>一、慢查询日志介绍</h2><h3 id="1-1-什么是慢查询日志？"><a href="#1-1-什么是慢查询日志？" class="headerlink" title="1.1 什么是慢查询日志？"></a>1.1 什么是慢查询日志？</h3><p><strong>慢查询日志</strong>记录执行时间超过指定阈值的 SQL 语句：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">慢查询日志记录内容：</span><br><span class="line">├── 执行时间超过 long_query_time 的 SQL</span><br><span class="line">├── 未使用索引的查询（可选）</span><br><span class="line">├── 不使用索引的 JOIN（可选）</span><br><span class="line">└── 包含：执行时间、锁定时间、发送行数、扫描行数</span><br></pre></td></tr></table></figure>

<h3 id="1-2-慢查询的作用"><a href="#1-2-慢查询的作用" class="headerlink" title="1.2 慢查询的作用"></a>1.2 慢查询的作用</h3><table>
<thead>
<tr>
<th>作用</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>性能瓶颈定位</td>
<td>找到执行慢的 SQL</td>
</tr>
<tr>
<td>索引优化依据</td>
<td>发现需要索引的字段</td>
</tr>
<tr>
<td>SQL 优化参考</td>
<td>分析低效的 SQL 写法</td>
</tr>
<tr>
<td>性能监控</td>
<td>定期分析性能趋势</td>
</tr>
</tbody></table>
<h3 id="1-3-与进阶篇的区别"><a href="#1-3-与进阶篇的区别" class="headerlink" title="1.3 与进阶篇的区别"></a>1.3 与进阶篇的区别</h3><table>
<thead>
<tr>
<th>内容</th>
<th>进阶篇（09-08）</th>
<th>运维篇（01-05）</th>
</tr>
</thead>
<tbody><tr>
<td>重点</td>
<td>基础使用和案例</td>
<td>深入配置和分析</td>
</tr>
<tr>
<td>开启方法</td>
<td>基础命令</td>
<td>详细参数配置</td>
</tr>
<tr>
<td>分析工具</td>
<td>简单介绍</td>
<td>详细使用</td>
</tr>
<tr>
<td>实战案例</td>
<td>单个案例</td>
<td>多种场景</td>
</tr>
</tbody></table>
<h2 id="二、慢查询日志配置"><a href="#二、慢查询日志配置" class="headerlink" title="二、慢查询日志配置"></a>二、慢查询日志配置</h2><h3 id="2-1-基本配置参数"><a href="#2-1-基本配置参数" class="headerlink" title="2.1 基本配置参数"></a>2.1 基本配置参数</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># 开启慢查询日志</span></span><br><span class="line"><span class="attr">slow_query_log</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志文件路径</span></span><br><span class="line"><span class="attr">slow_query_log_file</span> = /var/log/mysql/slow.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 慢查询阈值（秒）</span></span><br><span class="line"><span class="attr">long_query_time</span> = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 记录未使用索引的查询</span></span><br><span class="line"><span class="attr">log_queries_not_using_indexes</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 记录未使用索引的 JOIN</span></span><br><span class="line"><span class="attr">log_queries_not_using_indexes</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 管理员执行的 SQL 也记录（MySQL 5.6+）</span></span><br><span class="line"><span class="attr">log_slow_admin_statements</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 记录慢查询到系统表（可选）</span></span><br><span class="line"><span class="attr">log_output</span> = FILE,TABLE</span><br></pre></td></tr></table></figure>

<h3 id="2-2-配置参数详解"><a href="#2-2-配置参数详解" class="headerlink" title="2.2 配置参数详解"></a>2.2 配置参数详解</h3><p><strong>slow_query_log</strong>：</p>
<ul>
<li><code>0</code> &#x3D; 关闭（默认）</li>
<li><code>1</code> &#x3D; 开启</li>
</ul>
<p><strong>slow_query_log_file</strong>：</p>
<ul>
<li>指定日志文件路径</li>
<li>默认路径因操作系统而异</li>
</ul>
<p><strong>long_query_time</strong>：</p>
<ul>
<li>慢查询阈值（秒）</li>
<li>默认 10 秒</li>
<li>建议生产环境设为 1-2 秒</li>
<li>可以设置为小数，如 0.1</li>
</ul>
<p><strong>log_queries_not_using_indexes</strong>：</p>
<ul>
<li><code>0</code> &#x3D; 不记录（默认）</li>
<li><code>1</code> &#x3D; 记录未使用索引的查询</li>
</ul>
<p><strong>log_slow_admin_statements</strong>：</p>
<ul>
<li><code>0</code> &#x3D; 不记录（默认）</li>
<li><code>1</code> &#x3D; 记录管理员执行的慢 SQL</li>
</ul>
<p><strong>log_output</strong>：</p>
<ul>
<li><code>FILE</code>：输出到文件</li>
<li><code>TABLE</code>：输出到 mysql.slow_log 表</li>
<li><code>FILE,TABLE</code>：同时输出</li>
</ul>
<h3 id="2-3-动态配置"><a href="#2-3-动态配置" class="headerlink" title="2.3 动态配置"></a>2.3 动态配置</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 临时开启慢查询日志</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> slow_query_log <span class="operator">=</span> <span class="string">&#x27;ON&#x27;</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> long_query_time <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> slow_query_log_file <span class="operator">=</span> <span class="string">&#x27;/var/log/mysql/slow.log&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看配置</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;slow_query%&#x27;</span>;</span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;long_query_time&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 临时关闭</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> slow_query_log <span class="operator">=</span> <span class="string">&#x27;OFF&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-MySQL-5-7-新增参数"><a href="#2-4-MySQL-5-7-新增参数" class="headerlink" title="2.4 MySQL 5.7+ 新增参数"></a>2.4 MySQL 5.7+ 新增参数</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># 记录执行时间（MySQL 5.7+）</span></span><br><span class="line"><span class="attr">log_slow_slave_statements</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 最小检查行数（MySQL 5.7+）</span></span><br><span class="line"><span class="comment"># 只有扫描行数超过此值才记录</span></span><br><span class="line"><span class="attr">min_examined_row_limit</span> = <span class="number">1000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 跳过管理命令（MySQL 5.6+）</span></span><br><span class="line"><span class="comment"># log_slow_admin_statements = 0</span></span><br></pre></td></tr></table></figure>

<h3 id="2-5-完整配置示例"><a href="#2-5-完整配置示例" class="headerlink" title="2.5 完整配置示例"></a>2.5 完整配置示例</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># 生产环境推荐配置</span></span><br><span class="line"><span class="attr">slow_query_log</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">slow_query_log_file</span> = /var/log/mysql/slow.log</span><br><span class="line"><span class="attr">long_query_time</span> = <span class="number">2</span></span><br><span class="line"><span class="attr">log_queries_not_using_indexes</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">log_slow_admin_statements</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">min_examined_row_limit</span> = <span class="number">1000</span></span><br><span class="line"><span class="attr">log_output</span> = FILE</span><br></pre></td></tr></table></figure>

<h2 id="三、查看慢查询日志"><a href="#三、查看慢查询日志" class="headerlink" title="三、查看慢查询日志"></a>三、查看慢查询日志</h2><h3 id="3-1-查看配置"><a href="#3-1-查看配置" class="headerlink" title="3.1 查看配置"></a>3.1 查看配置</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看慢查询配置</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;slow_query%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看阈值</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;long_query_time&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看是否记录无索引查询</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;log_queries_not_using_indexes&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-慢查询日志格式"><a href="#3-2-慢查询日志格式" class="headerlink" title="3.2 慢查询日志格式"></a>3.2 慢查询日志格式</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># Time: 2024-02-24T10:30:45.123456Z</span><br><span class="line"># User@Host: root[root] @ localhost []  Id:    12345</span><br><span class="line"># Query_time: 2.345678  Lock_time: 0.000123  Rows_sent: 1000  Rows_examined: 100000</span><br><span class="line"># Threads: 1</span><br><span class="line">SET timestamp=1708772445;</span><br><span class="line">SELECT * FROM employees WHERE dept_id = 1;</span><br></pre></td></tr></table></figure>

<p><strong>字段说明</strong>：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Time</td>
<td>执行时间</td>
</tr>
<tr>
<td>User@Host</td>
<td>用户和主机</td>
</tr>
<tr>
<td>Query_time</td>
<td>查询执行时间（秒）</td>
</tr>
<tr>
<td>Lock_time</td>
<td>等待锁的时间（秒）</td>
</tr>
<tr>
<td>Rows_sent</td>
<td>发送的行数</td>
</tr>
<tr>
<td>Rows_examined</td>
<td>扫描的行数</td>
</tr>
<tr>
<td>Threads</td>
<td>使用的线程数</td>
</tr>
</tbody></table>
<h3 id="3-3-命令行查看"><a href="#3-3-命令行查看" class="headerlink" title="3.3 命令行查看"></a>3.3 命令行查看</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看最新慢查询</span></span><br><span class="line"><span class="built_in">tail</span> -100 /var/log/mysql/slow.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实时跟踪</span></span><br><span class="line"><span class="built_in">tail</span> -f /var/log/mysql/slow.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看慢查询数量</span></span><br><span class="line">grep -c <span class="string">&quot;Query_time&quot;</span> /var/log/mysql/slow.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看最慢的查询</span></span><br><span class="line">grep <span class="string">&quot;Query_time&quot;</span> /var/log/mysql/slow.log | <span class="built_in">sort</span> -rn | <span class="built_in">head</span> -20</span><br></pre></td></tr></table></figure>

<h3 id="3-4-表方式查看"><a href="#3-4-表方式查看" class="headerlink" title="3.4 表方式查看"></a>3.4 表方式查看</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 输出到表配置</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> log_output <span class="operator">=</span> <span class="string">&#x27;TABLE&#x27;</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> slow_query_log <span class="operator">=</span> <span class="string">&#x27;ON&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看慢查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> mysql.slow_log</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> start_time <span class="keyword">DESC</span></span><br><span class="line">LIMIT <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看最慢的 SQL</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    start_time,</span><br><span class="line">    user_host,</span><br><span class="line">    query_time,</span><br><span class="line">    lock_time,</span><br><span class="line">    rows_sent,</span><br><span class="line">    rows_examined,</span><br><span class="line">    sql_text</span><br><span class="line"><span class="keyword">FROM</span> mysql.slow_log</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> query_time <span class="keyword">DESC</span></span><br><span class="line">LIMIT <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 清空慢查询日志</span></span><br><span class="line"><span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span> mysql.slow_log;</span><br></pre></td></tr></table></figure>

<h2 id="四、分析工具"><a href="#四、分析工具" class="headerlink" title="四、分析工具"></a>四、分析工具</h2><h3 id="4-1-mysqldumpslow"><a href="#4-1-mysqldumpslow" class="headerlink" title="4.1 mysqldumpslow"></a>4.1 mysqldumpslow</h3><p>MySQL 自带的慢查询分析工具。</p>
<p><strong>基本用法</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 按执行时间排序，显示前 10 条</span></span><br><span class="line">mysqldumpslow -s t -t 10 /var/log/mysql/slow.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按锁定时间排序</span></span><br><span class="line">mysqldumpslow -s l -t 10 /var/log/mysql/slow.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按扫描行数排序</span></span><br><span class="line">mysqldumpslow -s r -t 10 /var/log/mysql/slow.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按返回记录数排序</span></span><br><span class="line">mysqldumpslow -s c -t 10 /var/log/mysql/slow.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只显示 SELECT 语句</span></span><br><span class="line">mysqldumpslow -s t -t 10 -g <span class="string">&quot;SELECT&quot;</span> /var/log/mysql/slow.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 忽略数字差异（将数字替换为 N）</span></span><br><span class="line">mysqldumpslow -s t -t 10 -a /var/log/mysql/slow.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 详细模式</span></span><br><span class="line">mysqldumpslow -s t -t 10 -v /var/log/mysql/slow.log</span><br></pre></td></tr></table></figure>

<p><strong>常用参数</strong>：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>-s</td>
<td>排序方式（t&#x3D;时间，l&#x3D;锁定，r&#x3D;行数，c&#x3D;计数）</td>
</tr>
<tr>
<td>-t</td>
<td>显示前 N 条</td>
</tr>
<tr>
<td>-g</td>
<td>正则匹配 SQL</td>
</tr>
<tr>
<td>-a</td>
<td>不将数字简化为 N</td>
</tr>
<tr>
<td>-v</td>
<td>详细模式</td>
</tr>
<tr>
<td>-r</td>
<td>反转排序</td>
</tr>
<tr>
<td>-d</td>
<td>调试模式</td>
</tr>
</tbody></table>
<h3 id="4-2-pt-query-digest"><a href="#4-2-pt-query-digest" class="headerlink" title="4.2 pt-query-digest"></a>4.2 pt-query-digest</h3><p>Percona Toolkit 中的强大分析工具（推荐）。</p>
<p><strong>安装</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Ubuntu/Debian</span></span><br><span class="line">apt-get install percona-toolkit</span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS/RHEL</span></span><br><span class="line">yum install percona-toolkit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或下载独立脚本</span></span><br><span class="line">wget https://raw.githubusercontent.com/percona/percona-toolkit/main/bin/pt-query-digest</span><br><span class="line"><span class="built_in">chmod</span> +x pt-query-digest</span><br></pre></td></tr></table></figure>

<p><strong>基本用法</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 分析慢查询日志</span></span><br><span class="line">pt-query-digest /var/log/mysql/slow.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分析最近 1 小时的日志</span></span><br><span class="line">pt-query-digest --since=1h /var/log/mysql/slow.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分析特定时间的日志</span></span><br><span class="line">pt-query-digest --since=<span class="string">&quot;2024-02-24 10:00:00&quot;</span> \</span><br><span class="line">                --<span class="keyword">until</span>=<span class="string">&quot;2024-02-24 12:00:00&quot;</span> \</span><br><span class="line">                /var/log/mysql/slow.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只分析 SELECT 语句</span></span><br><span class="line">pt-query-digest --filter=<span class="string">&#x27;m-&gt;&#123;Sql&#125; =~ m/^SELECT/&#x27;</span> /var/log/mysql/slow.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按用户分组</span></span><br><span class="line">pt-query-digest --group-by username /var/log/mysql/slow.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出到文件</span></span><br><span class="line">pt-query-digest /var/log/mysql/slow.log &gt; /tmp/slow_analysis.txt</span><br></pre></td></tr></table></figure>

<p><strong>输出示例</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># Query 1: 15% of total (0.5s)</span><br><span class="line"># Rank: 1  Count: 100  Time: 0.05s  Lock: 0.001s  Rows: 1000  1000</span><br><span class="line"># User: root, Host: localhost</span><br><span class="line"># Database: your_database</span><br><span class="line"># Tables: employees</span><br><span class="line">SELECT * FROM employees WHERE dept_id = 1;</span><br><span class="line"></span><br><span class="line"># Query 2: 10% of total (0.3s)</span><br><span class="line"># Rank: 2  Count: 50  Time: 0.06s  Lock: 0.002s  Rows: 500  5000</span><br><span class="line"># User: root, Host: localhost</span><br><span class="line"># Database: your_database</span><br><span class="line"># Tables: orders</span><br><span class="line">SELECT * FROM orders WHERE user_id = 123;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-自定义分析脚本"><a href="#4-3-自定义分析脚本" class="headerlink" title="4.3 自定义分析脚本"></a>4.3 自定义分析脚本</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># analyze_slow_log.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_slow_log</span>(<span class="params">filename</span>):</span><br><span class="line">    queries = defaultdict(<span class="built_in">list</span>)</span><br><span class="line">    current_query = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            <span class="keyword">if</span> line.startswith(<span class="string">&#x27;# Time:&#x27;</span>):</span><br><span class="line">                current_query[<span class="string">&#x27;time&#x27;</span>] = line.split(<span class="string">&#x27;: &#x27;</span>, <span class="number">1</span>)[<span class="number">1</span>].strip()</span><br><span class="line">            <span class="keyword">elif</span> line.startswith(<span class="string">&#x27;# Query_time:&#x27;</span>):</span><br><span class="line">                <span class="keyword">match</span> = re.search(<span class="string">r&#x27;Query_time: ([\d.]+)&#x27;</span>, line)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">                    current_query[<span class="string">&#x27;query_time&#x27;</span>] = <span class="built_in">float</span>(<span class="keyword">match</span>.group(<span class="number">1</span>))</span><br><span class="line">            <span class="keyword">elif</span> line.startswith(<span class="string">&#x27;SELECT&#x27;</span>) <span class="keyword">or</span> line.startswith(<span class="string">&#x27;UPDATE&#x27;</span>) <span class="keyword">or</span> line.startswith(<span class="string">&#x27;INSERT&#x27;</span>) <span class="keyword">or</span> line.startswith(<span class="string">&#x27;DELETE&#x27;</span>):</span><br><span class="line">                current_query[<span class="string">&#x27;sql&#x27;</span>] = line.strip()</span><br><span class="line">                queries[line.strip()].append(current_query.get(<span class="string">&#x27;query_time&#x27;</span>, <span class="number">0</span>))</span><br><span class="line">                current_query = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> queries</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">analyze</span>(<span class="params">filename</span>):</span><br><span class="line">    queries = parse_slow_log(filename)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 按平均执行时间排序</span></span><br><span class="line">    avg_times = []</span><br><span class="line">    <span class="keyword">for</span> sql, times <span class="keyword">in</span> queries.items():</span><br><span class="line">        avg_time = <span class="built_in">sum</span>(times) / <span class="built_in">len</span>(times)</span><br><span class="line">        avg_times.append((sql, avg_time, <span class="built_in">len</span>(times)))</span><br><span class="line"></span><br><span class="line">    avg_times.sort(key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;慢查询分析（按平均执行时间排序）:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">80</span>)</span><br><span class="line">    <span class="keyword">for</span> sql, avg_time, count <span class="keyword">in</span> avg_times[:<span class="number">20</span>]:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;平均时间：<span class="subst">&#123;avg_time:<span class="number">.4</span>f&#125;</span>s  执行次数：<span class="subst">&#123;count&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;SQL: <span class="subst">&#123;sql[:<span class="number">100</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">80</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">import</span> sys</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">        analyze(sys.argv[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Usage: python analyze_slow_log.py &lt;slow_log_file&gt;&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="五、慢查询优化实战"><a href="#五、慢查询优化实战" class="headerlink" title="五、慢查询优化实战"></a>五、慢查询优化实战</h2><h3 id="5-1-全表扫描优化"><a href="#5-1-全表扫描优化" class="headerlink" title="5.1 全表扫描优化"></a>5.1 全表扫描优化</h3><p><strong>慢查询</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># Query_time: <span class="number">5.234567</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> user_id <span class="operator">=</span> <span class="number">12345</span> <span class="keyword">AND</span> status <span class="operator">=</span> <span class="string">&#x27;PAID&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>分析</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用 EXPLAIN 分析</span></span><br><span class="line">EXPLAIN SELECT * FROM orders WHERE user_id = 12345 AND status = <span class="string">&#x27;PAID&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>优化</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建联合索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_user_status <span class="keyword">ON</span> orders(user_id, status);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 优化后</span></span><br><span class="line"># Query_time: <span class="number">0.012345</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-LIKE-搜索优化"><a href="#5-2-LIKE-搜索优化" class="headerlink" title="5.2 LIKE 搜索优化"></a>5.2 LIKE 搜索优化</h3><p><strong>慢查询</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># Query_time: <span class="number">3.456789</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> products <span class="keyword">WHERE</span> product_name <span class="keyword">LIKE</span> <span class="string">&#x27;%手机%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>优化方案 1：前缀匹配</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 改为前缀匹配（可以使用索引）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> products <span class="keyword">WHERE</span> product_name <span class="keyword">LIKE</span> <span class="string">&#x27;手机%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>优化方案 2：全文索引</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 添加全文索引</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> products <span class="keyword">ADD</span> FULLTEXT INDEX ft_name (product_name);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用全文搜索</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> products <span class="keyword">WHERE</span> <span class="keyword">MATCH</span>(product_name) AGAINST(<span class="string">&#x27;手机&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="5-3-ORDER-BY-优化"><a href="#5-3-ORDER-BY-优化" class="headerlink" title="5.3 ORDER BY 优化"></a>5.3 ORDER BY 优化</h3><p><strong>慢查询</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># Query_time: <span class="number">4.567890</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">ORDER</span> <span class="keyword">BY</span> hire_date <span class="keyword">DESC</span> LIMIT <span class="number">10000</span>, <span class="number">20</span>;</span><br></pre></td></tr></table></figure>

<p><strong>优化</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 添加索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_hire_date <span class="keyword">ON</span> employees(hire_date <span class="keyword">DESC</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 或使用延迟关联</span></span><br><span class="line"><span class="keyword">SELECT</span> e.<span class="operator">*</span> <span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> id <span class="keyword">FROM</span> employees <span class="keyword">ORDER</span> <span class="keyword">BY</span> hire_date <span class="keyword">DESC</span> LIMIT <span class="number">10000</span>, <span class="number">20</span></span><br><span class="line">) t <span class="keyword">ON</span> e.id <span class="operator">=</span> t.id;</span><br></pre></td></tr></table></figure>

<h3 id="5-4-JOIN-优化"><a href="#5-4-JOIN-优化" class="headerlink" title="5.4 JOIN 优化"></a>5.4 JOIN 优化</h3><p><strong>慢查询</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># Query_time: <span class="number">8.123456</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders o</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> users u <span class="keyword">ON</span> o.user_id <span class="operator">=</span> u.id</span><br><span class="line"><span class="keyword">WHERE</span> o.create_time <span class="operator">&gt;</span> <span class="string">&#x27;2024-01-01&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>优化</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 确保 JOIN 字段有索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_user_id <span class="keyword">ON</span> orders(user_id);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_id <span class="keyword">ON</span> users(id);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_create_time <span class="keyword">ON</span> orders(create_time);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 优化 JOIN 顺序</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users u</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> orders o <span class="keyword">ON</span> u.id <span class="operator">=</span> o.user_id</span><br><span class="line"><span class="keyword">WHERE</span> o.create_time <span class="operator">&gt;</span> <span class="string">&#x27;2024-01-01&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="5-5-GROUP-BY-优化"><a href="#5-5-GROUP-BY-优化" class="headerlink" title="5.5 GROUP BY 优化"></a>5.5 GROUP BY 优化</h3><p><strong>慢查询</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># Query_time: <span class="number">6.789012</span></span><br><span class="line"><span class="keyword">SELECT</span> dept_id, <span class="built_in">AVG</span>(salary) <span class="keyword">FROM</span> employees <span class="keyword">GROUP</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="built_in">AVG</span>(salary);</span><br></pre></td></tr></table></figure>

<p><strong>优化</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 添加索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_dept <span class="keyword">ON</span> employees(dept_id);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 或使用子查询</span></span><br><span class="line"><span class="keyword">SELECT</span> dept_id, avg_salary <span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> dept_id, <span class="built_in">AVG</span>(salary) <span class="keyword">AS</span> avg_salary</span><br><span class="line">    <span class="keyword">FROM</span> employees</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> dept_id</span><br><span class="line">) t <span class="keyword">ORDER</span> <span class="keyword">BY</span> avg_salary;</span><br></pre></td></tr></table></figure>

<h2 id="六、自动化监控"><a href="#六、自动化监控" class="headerlink" title="六、自动化监控"></a>六、自动化监控</h2><h3 id="6-1-定时分析脚本"><a href="#6-1-定时分析脚本" class="headerlink" title="6.1 定时分析脚本"></a>6.1 定时分析脚本</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># daily_slow_log_analysis.sh</span></span><br><span class="line"></span><br><span class="line">LOG_FILE=<span class="string">&quot;/var/log/mysql/slow.log&quot;</span></span><br><span class="line">REPORT_FILE=<span class="string">&quot;/var/log/mysql/slow_report_<span class="subst">$(date +%Y%m%d)</span>.txt&quot;</span></span><br><span class="line">ARCHIVE_DIR=<span class="string">&quot;/var/log/mysql/archive&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建归档目录</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$ARCHIVE_DIR</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 分析慢查询</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;慢查询日志分析报告&quot;</span> &gt; <span class="variable">$REPORT_FILE</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;日期：<span class="subst">$(date)</span>&quot;</span> &gt;&gt; <span class="variable">$REPORT_FILE</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;================================&quot;</span> &gt;&gt; <span class="variable">$REPORT_FILE</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span> &gt;&gt; <span class="variable">$REPORT_FILE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 pt-query-digest 分析</span></span><br><span class="line">pt-query-digest --<span class="built_in">limit</span> 20 <span class="variable">$LOG_FILE</span> &gt;&gt; <span class="variable">$REPORT_FILE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 归档旧日志</span></span><br><span class="line"><span class="built_in">mv</span> <span class="variable">$LOG_FILE</span> <span class="variable">$ARCHIVE_DIR</span>/slow_$(<span class="built_in">date</span> +%Y%m%d_%H%M%S).<span class="built_in">log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 刷新慢查询日志</span></span><br><span class="line">mysql -e <span class="string">&quot;FLUSH LOGS;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送报告（需要配置邮件）</span></span><br><span class="line"><span class="comment"># mail -s &quot;慢查询日志分析报告&quot; admin@example.com &lt; $REPORT_FILE</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;分析报告已生成：<span class="variable">$REPORT_FILE</span>&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-Cron-定时任务"><a href="#6-2-Cron-定时任务" class="headerlink" title="6.2 Cron 定时任务"></a>6.2 Cron 定时任务</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 每天凌晨 2 点执行分析</span></span><br><span class="line">0 2 * * * /path/to/daily_slow_log_analysis.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 每周生成汇总报告</span></span><br><span class="line">0 3 * * 0 /path/to/weekly_slow_log_summary.sh</span><br></pre></td></tr></table></figure>

<h3 id="6-3-监控告警"><a href="#6-3-监控告警" class="headerlink" title="6.3 监控告警"></a>6.3 监控告警</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># slow_log_alert.sh</span></span><br><span class="line"></span><br><span class="line">LOG_FILE=<span class="string">&quot;/var/log/mysql/slow.log&quot;</span></span><br><span class="line">THRESHOLD=100  <span class="comment"># 慢查询数量阈值</span></span><br><span class="line">EMAIL=<span class="string">&quot;admin@example.com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 统计最近 1 小时的慢查询数量</span></span><br><span class="line">COUNT=$(grep -c <span class="string">&quot;Query_time&quot;</span> <span class="variable">$LOG_FILE</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$COUNT</span> -gt <span class="variable">$THRESHOLD</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;警告：过去 1 小时内发现 <span class="variable">$COUNT</span> 个慢查询&quot;</span> | mail -s <span class="string">&quot;MySQL 慢查询告警&quot;</span> <span class="variable">$EMAIL</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 输出最慢的 10 条</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;最慢的 10 条查询:&quot;</span> | mail -s <span class="string">&quot;MySQL 慢查询告警&quot;</span> <span class="variable">$EMAIL</span></span><br><span class="line">    grep <span class="string">&quot;Query_time&quot;</span> <span class="variable">$LOG_FILE</span> | <span class="built_in">sort</span> -rn | <span class="built_in">head</span> -10 | mail -s <span class="string">&quot;MySQL 慢查询告警&quot;</span> <span class="variable">$EMAIL</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h2 id="七、最佳实践"><a href="#七、最佳实践" class="headerlink" title="七、最佳实践"></a>七、最佳实践</h2><h3 id="7-1-配置建议"><a href="#7-1-配置建议" class="headerlink" title="7.1 配置建议"></a>7.1 配置建议</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># 生产环境推荐配置</span></span><br><span class="line"><span class="attr">slow_query_log</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">slow_query_log_file</span> = /var/log/mysql/slow.log</span><br><span class="line"><span class="attr">long_query_time</span> = <span class="number">2</span></span><br><span class="line"><span class="attr">log_queries_not_using_indexes</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">log_output</span> = FILE</span><br><span class="line"><span class="attr">min_examined_row_limit</span> = <span class="number">1000</span></span><br></pre></td></tr></table></figure>

<h3 id="7-2-运维建议"><a href="#7-2-运维建议" class="headerlink" title="7.2 运维建议"></a>7.2 运维建议</h3><table>
<thead>
<tr>
<th>项目</th>
<th>建议</th>
</tr>
</thead>
<tbody><tr>
<td>阈值设置</td>
<td>生产环境 1-2 秒，开发环境 0.5 秒</td>
</tr>
<tr>
<td>日志轮转</td>
<td>每日轮转，保留 7 天</td>
</tr>
<tr>
<td>分析频率</td>
<td>每天分析，每周汇总</td>
</tr>
<tr>
<td>告警阈值</td>
<td>慢查询数量超过 100 条&#x2F;小时</td>
</tr>
</tbody></table>
<h3 id="7-3-优化流程"><a href="#7-3-优化流程" class="headerlink" title="7.3 优化流程"></a>7.3 优化流程</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 开启慢查询日志</span><br><span class="line">2. 收集慢查询（24 小时以上）</span><br><span class="line">3. 使用 pt-query-digest 分析</span><br><span class="line">4. 找出 Top 10 慢查询</span><br><span class="line">5. 使用 EXPLAIN 分析</span><br><span class="line">6. 制定优化方案</span><br><span class="line">7. 测试优化效果</span><br><span class="line">8. 关闭不必要的慢查询记录</span><br></pre></td></tr></table></figure>

<h2 id="八、小结"><a href="#八、小结" class="headerlink" title="八、小结"></a>八、小结</h2><h3 id="核心知识点"><a href="#核心知识点" class="headerlink" title="核心知识点"></a>核心知识点</h3><ol>
<li><strong>慢查询作用</strong>：发现性能瓶颈，指导 SQL 优化</li>
<li><strong>关键参数</strong>：long_query_time、log_queries_not_using_indexes</li>
<li><strong>分析工具</strong>：mysqldumpslow、pt-query-digest</li>
<li><strong>优化方法</strong>：索引优化、SQL 改写</li>
</ol>
<h3 id="常用命令速查"><a href="#常用命令速查" class="headerlink" title="常用命令速查"></a>常用命令速查</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 开启慢查询日志</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> slow_query_log <span class="operator">=</span> <span class="string">&#x27;ON&#x27;</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> long_query_time <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看配置</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;slow_query%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用 mysqldumpslow 分析</span></span><br><span class="line">mysqldumpslow -s t -t 10 /var/log/mysql/slow.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 pt-query-digest 分析</span></span><br><span class="line">pt-query-digest /var/log/mysql/slow.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实时跟踪</span></span><br><span class="line"><span class="built_in">tail</span> -f /var/log/mysql/slow.log</span><br></pre></td></tr></table></figure>

<h3 id="日志篇完结"><a href="#日志篇完结" class="headerlink" title="日志篇完结"></a>日志篇完结</h3><p>至此，日志详解篇的 5 篇文章全部完成！</p>
<table>
<thead>
<tr>
<th>节号</th>
<th>主题</th>
<th>核心内容</th>
</tr>
</thead>
<tbody><tr>
<td>01-01</td>
<td>课程介绍</td>
<td>日志系统概述</td>
</tr>
<tr>
<td>01-02</td>
<td>错误日志</td>
<td>故障诊断</td>
</tr>
<tr>
<td>01-03</td>
<td>二进制日志</td>
<td>数据恢复、主从复制</td>
</tr>
<tr>
<td>01-04</td>
<td>查询日志</td>
<td>调试、审计</td>
</tr>
<tr>
<td>01-05</td>
<td>慢查询日志</td>
<td>性能优化</td>
</tr>
</tbody></table>
<hr>
<p><strong>下一篇</strong>：[MySQL 运维篇 02-01 主从复制概述](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 02-01 主从复制概述&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 运维篇 01-01 日志详解课程介绍](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 01-01 日志详解课程介绍&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 运维篇</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>慢查询日志</tag>
        <tag>性能优化</tag>
        <tag>SQL 分析</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 运维篇 01-03 二进制日志</title>
    <url>/2026/02/24/MySQL%20%E8%BF%90%E7%BB%B4%E7%AF%87%2001-03%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%97%A5%E5%BF%97/</url>
    <content><![CDATA[<h1 id="MySQL-运维篇-01-03-二进制日志"><a href="#MySQL-运维篇-01-03-二进制日志" class="headerlink" title="MySQL 运维篇 01-03 二进制日志"></a>MySQL 运维篇 01-03 二进制日志</h1><p>二进制日志（Binary Log，简称 binlog）是 MySQL 最重要的日志之一，记录了所有修改数据库结构或数据的操作。它是数据恢复和主从复制的基础。</p>
<h2 id="一、二进制日志介绍"><a href="#一、二进制日志介绍" class="headerlink" title="一、二进制日志介绍"></a>一、二进制日志介绍</h2><h3 id="1-1-什么是二进制日志？"><a href="#1-1-什么是二进制日志？" class="headerlink" title="1.1 什么是二进制日志？"></a>1.1 什么是二进制日志？</h3><p><strong>二进制日志</strong>是 MySQL 服务器层记录的日志，包含以下信息：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">binlog 记录内容：</span><br><span class="line">├── DDL 操作：CREATE、ALTER、DROP 等</span><br><span class="line">├── DML 操作：INSERT、UPDATE、DELETE 等</span><br><span class="line">├── 事务控制：BEGIN、COMMIT、ROLLBACK</span><br><span class="line">└── 不记录：SELECT、SHOW 等查询操作</span><br></pre></td></tr></table></figure>

<h3 id="1-2-binlog-的作用"><a href="#1-2-binlog-的作用" class="headerlink" title="1.2 binlog 的作用"></a>1.2 binlog 的作用</h3><table>
<thead>
<tr>
<th>作用</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>数据恢复</td>
<td>误删数据时，通过 binlog 恢复</td>
</tr>
<tr>
<td>主从复制</td>
<td>从库读取主库 binlog 并重放</td>
</tr>
<tr>
<td>审计追踪</td>
<td>记录所有数据变更历史</td>
</tr>
<tr>
<td>增量备份</td>
<td>配合全量备份实现增量恢复</td>
</tr>
</tbody></table>
<h3 id="1-3-binlog-格式"><a href="#1-3-binlog-格式" class="headerlink" title="1.3 binlog 格式"></a>1.3 binlog 格式</h3><p>MySQL 支持三种 binlog 格式：</p>
<table>
<thead>
<tr>
<th>格式</th>
<th>说明</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td>STATEMENT</td>
<td>记录原始 SQL</td>
<td>日志量小</td>
<td>某些函数无法复制</td>
</tr>
<tr>
<td>ROW</td>
<td>记录行变更</td>
<td>数据精确</td>
<td>日志量大</td>
</tr>
<tr>
<td>MIXED</td>
<td>混合模式</td>
<td>兼顾两者</td>
<td>复杂</td>
</tr>
</tbody></table>
<h2 id="二、binlog-配置"><a href="#二、binlog-配置" class="headerlink" title="二、binlog 配置"></a>二、binlog 配置</h2><h3 id="2-1-基本配置参数"><a href="#2-1-基本配置参数" class="headerlink" title="2.1 基本配置参数"></a>2.1 基本配置参数</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># 开启 binlog（目录会自动创建）</span></span><br><span class="line"><span class="attr">log_bin</span> = /var/log/mysql/mysql-bin.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># binlog 过期时间（天）</span></span><br><span class="line"><span class="attr">expire_logs_days</span> = <span class="number">7</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># binlog 文件大小（字节）</span></span><br><span class="line"><span class="attr">max_binlog_size</span> = <span class="number">100</span>M</span><br><span class="line"></span><br><span class="line"><span class="comment"># binlog 格式</span></span><br><span class="line"><span class="attr">binlog_format</span> = ROW</span><br><span class="line"></span><br><span class="line"><span class="comment"># 同步策略（最安全）</span></span><br><span class="line"><span class="attr">sync_binlog</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-配置参数详解"><a href="#2-2-配置参数详解" class="headerlink" title="2.2 配置参数详解"></a>2.2 配置参数详解</h3><p><strong>log_bin</strong>：</p>
<ul>
<li>指定 binlog 文件的基础路径</li>
<li>实际文件名会自动添加序号，如 <code>mysql-bin.000001</code></li>
</ul>
<p><strong>expire_logs_days</strong>：</p>
<ul>
<li>自动删除过期的 binlog</li>
<li>MySQL 8.0+ 推荐使用 <code>binlog_expire_logs_seconds</code></li>
</ul>
<p><strong>max_binlog_size</strong>：</p>
<ul>
<li>单个 binlog 文件的最大大小</li>
<li>超过后自动切换到新文件</li>
</ul>
<p><strong>binlog_format</strong>：</p>
<ul>
<li><code>STATEMENT</code>：记录 SQL 语句</li>
<li><code>ROW</code>：记录行数据变更</li>
<li><code>MIXED</code>：默认 ROW，特殊情况下用 STATEMENT</li>
</ul>
<p><strong>sync_binlog</strong>：</p>
<ul>
<li><code>0</code>：不同步，性能最好，风险最大</li>
<li><code>1</code>：每次事务都同步（默认，最安全）</li>
<li><code>N</code>：每 N 次事务同步一次</li>
</ul>
<h3 id="2-3-MySQL-8-0-新参数"><a href="#2-3-MySQL-8-0-新参数" class="headerlink" title="2.3 MySQL 8.0 新参数"></a>2.3 MySQL 8.0 新参数</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># MySQL 8.0+ 使用秒数控制过期</span></span><br><span class="line"><span class="attr">binlog_expire_logs_seconds</span> = <span class="number">604800</span>  <span class="comment"># 7 天</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># binlog 写入方式</span></span><br><span class="line"><span class="attr">binlog_transaction_dependency_tracking</span> = WRITESET</span><br></pre></td></tr></table></figure>

<h3 id="2-4-完整配置示例"><a href="#2-4-完整配置示例" class="headerlink" title="2.4 完整配置示例"></a>2.4 完整配置示例</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># 生产环境推荐配置</span></span><br><span class="line"><span class="attr">log_bin</span> = /var/log/mysql/mysql-bin</span><br><span class="line"><span class="attr">binlog_format</span> = ROW</span><br><span class="line"><span class="attr">sync_binlog</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">binlog_expire_logs_seconds</span> = <span class="number">604800</span></span><br><span class="line"><span class="attr">max_binlog_size</span> = <span class="number">100</span>M</span><br><span class="line"><span class="attr">binlog_checksum</span> = CRC32</span><br><span class="line"><span class="attr">master_verify_checksum</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h2 id="三、binlog-操作"><a href="#三、binlog-操作" class="headerlink" title="三、binlog 操作"></a>三、binlog 操作</h2><h3 id="3-1-查看-binlog-配置"><a href="#3-1-查看-binlog-配置" class="headerlink" title="3.1 查看 binlog 配置"></a>3.1 查看 binlog 配置</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看是否开启 binlog</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;log_bin&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看 binlog 格式</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;binlog_format&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看 binlog 文件列表</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="type">BINARY</span> LOGS;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看当前写入的 binlog</span></span><br><span class="line"><span class="keyword">SHOW</span> MASTER STATUS;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-查看-binlog-内容"><a href="#3-2-查看-binlog-内容" class="headerlink" title="3.2 查看 binlog 内容"></a>3.2 查看 binlog 内容</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看 binlog 内容</span></span><br><span class="line">mysqlbinlog /var/log/mysql/mysql-bin.000001</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定数据库</span></span><br><span class="line">mysqlbinlog -d your_database /var/log/mysql/mysql-bin.000001</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按时间筛选</span></span><br><span class="line">mysqlbinlog --start-datetime=<span class="string">&quot;2024-02-24 00:00:00&quot;</span> \</span><br><span class="line">            --stop-datetime=<span class="string">&quot;2024-02-24 23:59:59&quot;</span> \</span><br><span class="line">            /var/log/mysql/mysql-bin.000001</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按位置筛选</span></span><br><span class="line">mysqlbinlog --start-position=1000 \</span><br><span class="line">            --stop-position=2000 \</span><br><span class="line">            /var/log/mysql/mysql-bin.000001</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出为可读格式</span></span><br><span class="line">mysqlbinlog --base64-output=DECODE-ROWS \</span><br><span class="line">            -v /var/log/mysql/mysql-bin.000001</span><br></pre></td></tr></table></figure>

<h3 id="3-3-binlog-内容示例"><a href="#3-3-binlog-内容示例" class="headerlink" title="3.3 binlog 内容示例"></a>3.3 binlog 内容示例</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># STATEMENT 格式</span><br><span class="line">#240224 10:30:45 server id 1  end_log_pos 234 	Start: binlog v 4, server v 8.0.32 created 240224 10:30:45</span><br><span class="line">#240224 10:30:50 server id 1  end_log_pos 356 	Query	thread_id=1	exec_time=0	error_code=0</span><br><span class="line">SET TIMESTAMP=1708772450/*!*/;</span><br><span class="line">BEGIN</span><br><span class="line">/*!*/;</span><br><span class="line">#240224 10:30:50 server id 1  end_log_pos 456 	Query	thread_id=1	exec_time=0	error_code=0</span><br><span class="line">SET TIMESTAMP=1708772450/*!*/;</span><br><span class="line">INSERT INTO users (id, name) VALUES (1, &#x27;张三&#x27;)</span><br><span class="line">/*!*/;</span><br><span class="line">#240224 10:30:50 server id 1  end_log_pos 556 	Xid = 10</span><br><span class="line">COMMIT/*!*/;</span><br><span class="line"></span><br><span class="line"># ROW 格式（带 -v 参数解析后）</span><br><span class="line">### INSERT INTO your_database.users</span><br><span class="line">### SET</span><br><span class="line">###   @1=1</span><br><span class="line">###   @2=&#x27;张三&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="3-4-删除-binlog"><a href="#3-4-删除-binlog" class="headerlink" title="3.4 删除 binlog"></a>3.4 删除 binlog</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 删除所有 binlog（谨慎！）</span></span><br><span class="line">RESET MASTER;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除指定文件之前的 binlog</span></span><br><span class="line">PURGE <span class="type">BINARY</span> LOGS <span class="keyword">TO</span> <span class="string">&#x27;mysql-bin.000010&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除指定日期之前的 binlog</span></span><br><span class="line">PURGE <span class="type">BINARY</span> LOGS BEFORE <span class="string">&#x27;2024-02-20 00:00:00&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除指定时间之前的 binlog（MySQL 8.0+）</span></span><br><span class="line">PURGE <span class="type">BINARY</span> LOGS BEFORE <span class="type">TIMESTAMP</span> <span class="string">&#x27;1708387200&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-5-刷新-binlog"><a href="#3-5-刷新-binlog" class="headerlink" title="3.5 刷新 binlog"></a>3.5 刷新 binlog</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 开始新的 binlog 文件</span></span><br><span class="line">FLUSH LOGS;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 或</span></span><br><span class="line">FLUSH <span class="type">BINARY</span> LOGS;</span><br></pre></td></tr></table></figure>

<h2 id="四、binlog-格式详解"><a href="#四、binlog-格式详解" class="headerlink" title="四、binlog 格式详解"></a>四、binlog 格式详解</h2><h3 id="4-1-STATEMENT-格式"><a href="#4-1-STATEMENT-格式" class="headerlink" title="4.1 STATEMENT 格式"></a>4.1 STATEMENT 格式</h3><p><strong>特点</strong>：记录原始 SQL 语句</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 原始 SQL</span></span><br><span class="line"><span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> salary <span class="operator">*</span> <span class="number">1.1</span> <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- binlog 记录</span></span><br><span class="line"><span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> salary <span class="operator">*</span> <span class="number">1.1</span> <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><strong>优点</strong>：</p>
<ul>
<li>日志量小</li>
<li>便于阅读和分析</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>某些函数无法正确复制（如 NOW()、UUID()）</li>
<li>依赖确定性的 SQL</li>
</ul>
<h3 id="4-2-ROW-格式"><a href="#4-2-ROW-格式" class="headerlink" title="4.2 ROW 格式"></a>4.2 ROW 格式</h3><p><strong>特点</strong>：记录每行数据的变更</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 原始 SQL</span></span><br><span class="line"><span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> <span class="number">5000</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- binlog 记录</span></span><br><span class="line">### <span class="keyword">UPDATE</span> employees</span><br><span class="line">### <span class="keyword">WHERE</span></span><br><span class="line">###   <span class="variable">@1</span><span class="operator">=</span><span class="number">1</span></span><br><span class="line">###   <span class="variable">@2</span><span class="operator">=</span><span class="string">&#x27;张三&#x27;</span></span><br><span class="line">###   <span class="variable">@3</span><span class="operator">=</span><span class="number">3000</span></span><br><span class="line">### <span class="keyword">SET</span></span><br><span class="line">###   <span class="variable">@1</span><span class="operator">=</span><span class="number">1</span></span><br><span class="line">###   <span class="variable">@2</span><span class="operator">=</span><span class="string">&#x27;张三&#x27;</span></span><br><span class="line">###   <span class="variable">@3</span><span class="operator">=</span><span class="number">5000</span></span><br></pre></td></tr></table></figure>

<p><strong>优点</strong>：</p>
<ul>
<li>精确记录数据变更</li>
<li>不受函数和存储过程影响</li>
<li>可以记录 DDL 以外的变更</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>日志量大</li>
<li>不易直接阅读</li>
</ul>
<h3 id="4-3-MIXED-格式"><a href="#4-3-MIXED-格式" class="headerlink" title="4.3 MIXED 格式"></a>4.3 MIXED 格式</h3><p><strong>特点</strong>：默认使用 ROW，特殊情况下用 STATEMENT</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MIXED 模式决策：</span><br><span class="line">├── 默认使用 ROW 格式</span><br><span class="line">├── 遇到确定性 SQL 时使用 STATEMENT</span><br><span class="line">├── 遇到以下情况使用 ROW：</span><br><span class="line">│   ├── 包含 UUID()、USER() 等函数</span><br><span class="line">│   ├── 包含 NOW() 等时间函数</span><br><span class="line">│   ├── 包含存储过程</span><br><span class="line">│   └── 临时表</span><br></pre></td></tr></table></figure>

<h3 id="4-4-格式选择建议"><a href="#4-4-格式选择建议" class="headerlink" title="4.4 格式选择建议"></a>4.4 格式选择建议</h3><table>
<thead>
<tr>
<th>场景</th>
<th>推荐格式</th>
</tr>
</thead>
<tbody><tr>
<td>主从复制</td>
<td>ROW</td>
</tr>
<tr>
<td>数据恢复</td>
<td>ROW</td>
</tr>
<tr>
<td>日志量敏感</td>
<td>STATEMENT</td>
</tr>
<tr>
<td>默认推荐</td>
<td>ROW</td>
</tr>
</tbody></table>
<h2 id="五、binlog-恢复实战"><a href="#五、binlog-恢复实战" class="headerlink" title="五、binlog 恢复实战"></a>五、binlog 恢复实战</h2><h3 id="5-1-误删数据恢复场景"><a href="#5-1-误删数据恢复场景" class="headerlink" title="5.1 误删数据恢复场景"></a>5.1 误删数据恢复场景</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 场景：误删了重要数据</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">12345</span>;</span><br><span class="line"><span class="comment">-- 发现删除错误，需要恢复</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-恢复步骤"><a href="#5-2-恢复步骤" class="headerlink" title="5.2 恢复步骤"></a>5.2 恢复步骤</h3><p><strong>步骤 1：找到对应的 binlog 文件</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="type">BINARY</span> LOGS;</span><br><span class="line"><span class="keyword">SHOW</span> MASTER STATUS;</span><br></pre></td></tr></table></figure>

<p><strong>步骤 2：导出 binlog 内容</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 导出所有 SQL</span></span><br><span class="line">mysqlbinlog /var/log/mysql/mysql-bin.000005 &gt; /tmp/recover.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按时间范围导出</span></span><br><span class="line">mysqlbinlog --start-datetime=<span class="string">&quot;2024-02-24 10:00:00&quot;</span> \</span><br><span class="line">            --stop-datetime=<span class="string">&quot;2024-02-24 12:00:00&quot;</span> \</span><br><span class="line">            /var/log/mysql/mysql-bin.000005 &gt; /tmp/recover.sql</span><br></pre></td></tr></table></figure>

<p><strong>步骤 3：找到 DELETE 语句位置</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">grep -n <span class="string">&quot;DELETE FROM orders WHERE id = 12345&quot;</span> /tmp/recover.sql</span><br></pre></td></tr></table></figure>

<p><strong>步骤 4：恢复数据</strong></p>
<p>方法一：使用 INSERT 恢复（ROW 格式）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 找到被删除的数据，生成 INSERT 语句</span></span><br><span class="line">mysqlbinlog --base64-output=DECODE-ROWS -v \</span><br><span class="line">            --start-datetime=<span class="string">&quot;2024-02-24 10:00:00&quot;</span> \</span><br><span class="line">            --stop-datetime=<span class="string">&quot;2024-02-24 12:00:00&quot;</span> \</span><br><span class="line">            /var/log/mysql/mysql-bin.000005 | grep -A 10 <span class="string">&quot;DELETE FROM orders&quot;</span></span><br></pre></td></tr></table></figure>

<p>方法二：反向执行 DELETE（生成 INSERT）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用 mysqlbinlog 解析后手动构建 INSERT</span></span><br><span class="line">mysqlbinlog /var/log/mysql/mysql-bin.000005 | grep -A 20 <span class="string">&quot;DELETE FROM orders&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-完整恢复示例"><a href="#5-3-完整恢复示例" class="headerlink" title="5.3 完整恢复示例"></a>5.3 完整恢复示例</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 找到误操作时间点的 binlog</span></span><br><span class="line">mysqlbinlog --start-datetime=<span class="string">&quot;2024-02-24 09:00:00&quot;</span> \</span><br><span class="line">            --stop-datetime=<span class="string">&quot;2024-02-24 18:00:00&quot;</span> \</span><br><span class="line">            /var/log/mysql/mysql-bin.000005 &gt; /tmp/binlog.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 找到误操作位置</span></span><br><span class="line">grep -n <span class="string">&quot;DELETE&quot;</span> /tmp/binlog.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 提取误操作前的所有 SQL</span></span><br><span class="line"><span class="built_in">head</span> -n 1000 /tmp/binlog.sql &gt; /tmp/before_delete.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 恢复到误操作前</span></span><br><span class="line">mysql -u root -p &lt; /tmp/before_delete.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 或者提取 DELETE 之前的数据，生成 INSERT</span></span><br><span class="line"><span class="comment"># （需要手动或使用工具解析 ROW 格式）</span></span><br></pre></td></tr></table></figure>

<h3 id="5-4-使用工具恢复"><a href="#5-4-使用工具恢复" class="headerlink" title="5.4 使用工具恢复"></a>5.4 使用工具恢复</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用 mysqlbinlog 恢复指定位置</span></span><br><span class="line">mysqlbinlog --start-position=1000 \</span><br><span class="line">            --stop-position=2000 \</span><br><span class="line">            /var/log/mysql/mysql-bin.000005 | mysql -u root -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 恢复整个文件</span></span><br><span class="line">mysqlbinlog /var/log/mysql/mysql-bin.000005 | mysql -u root -p</span><br></pre></td></tr></table></figure>

<h2 id="六、binlog-性能优化"><a href="#六、binlog-性能优化" class="headerlink" title="六、binlog 性能优化"></a>六、binlog 性能优化</h2><h3 id="6-1-性能影响因素"><a href="#6-1-性能影响因素" class="headerlink" title="6.1 性能影响因素"></a>6.1 性能影响因素</h3><table>
<thead>
<tr>
<th>因素</th>
<th>影响</th>
<th>优化建议</th>
</tr>
</thead>
<tbody><tr>
<td>sync_binlog</td>
<td>越大性能越好，风险越高</td>
<td>生产环境设为 1</td>
</tr>
<tr>
<td>binlog_format</td>
<td>ROW 日志量大</td>
<td>根据需求选择</td>
</tr>
<tr>
<td>磁盘 IO</td>
<td>同步写入影响性能</td>
<td>使用 SSD</td>
</tr>
</tbody></table>
<h3 id="6-2-优化配置"><a href="#6-2-优化配置" class="headerlink" title="6.2 优化配置"></a>6.2 优化配置</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># 性能优化配置</span></span><br><span class="line"><span class="attr">sync_binlog</span> = <span class="number">1</span>           <span class="comment"># 安全优先</span></span><br><span class="line"><span class="attr">binlog_cache_size</span> = <span class="number">32</span>M   <span class="comment"># 事务缓存</span></span><br><span class="line"><span class="attr">max_binlog_cache_size</span> = <span class="number">1</span>G</span><br><span class="line"><span class="attr">binlog_stmt_cache_size</span> = <span class="number">32</span>M</span><br></pre></td></tr></table></figure>

<h3 id="6-3-监控-binlog"><a href="#6-3-监控-binlog" class="headerlink" title="6.3 监控 binlog"></a>6.3 监控 binlog</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看 binlog 写入量</span></span><br><span class="line"><span class="keyword">SHOW</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;Binlog_cache_disk_use&#x27;</span>;</span><br><span class="line"><span class="keyword">SHOW</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;Binlog_cache_use&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看 binlog 空间使用</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="type">BINARY</span> LOGS;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看当前写入的 binlog 文件</span></span><br><span class="line"><span class="keyword">SHOW</span> MASTER STATUS;</span><br></pre></td></tr></table></figure>

<h2 id="七、最佳实践"><a href="#七、最佳实践" class="headerlink" title="七、最佳实践"></a>七、最佳实践</h2><h3 id="7-1-配置建议"><a href="#7-1-配置建议" class="headerlink" title="7.1 配置建议"></a>7.1 配置建议</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># 生产环境推荐</span></span><br><span class="line"><span class="attr">log_bin</span> = /var/log/mysql/mysql-bin</span><br><span class="line"><span class="attr">binlog_format</span> = ROW</span><br><span class="line"><span class="attr">sync_binlog</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">binlog_expire_logs_seconds</span> = <span class="number">604800</span></span><br><span class="line"><span class="attr">max_binlog_size</span> = <span class="number">100</span>M</span><br><span class="line"><span class="attr">binlog_checksum</span> = CRC32</span><br></pre></td></tr></table></figure>

<h3 id="7-2-运维建议"><a href="#7-2-运维建议" class="headerlink" title="7.2 运维建议"></a>7.2 运维建议</h3><table>
<thead>
<tr>
<th>项目</th>
<th>建议</th>
</tr>
</thead>
<tbody><tr>
<td>开启 binlog</td>
<td>生产环境必须开启</td>
</tr>
<tr>
<td>保留期限</td>
<td>至少 7 天</td>
</tr>
<tr>
<td>存储位置</td>
<td>独立磁盘分区</td>
</tr>
<tr>
<td>监控告警</td>
<td>空间使用超过 80% 告警</td>
</tr>
</tbody></table>
<h3 id="7-3-恢复策略"><a href="#7-3-恢复策略" class="headerlink" title="7.3 恢复策略"></a>7.3 恢复策略</h3><ol>
<li><strong>定期全量备份</strong>：每周一次</li>
<li><strong>binlog 实时备份</strong>：每天备份</li>
<li><strong>恢复演练</strong>：定期测试恢复流程</li>
</ol>
<h2 id="八、小结"><a href="#八、小结" class="headerlink" title="八、小结"></a>八、小结</h2><h3 id="核心知识点"><a href="#核心知识点" class="headerlink" title="核心知识点"></a>核心知识点</h3><ol>
<li><strong>binlog 作用</strong>：数据恢复、主从复制、审计追踪</li>
<li><strong>三种格式</strong>：STATEMENT、ROW、MIXED</li>
<li><strong>关键参数</strong>：sync_binlog、binlog_format、expire_logs_days</li>
<li><strong>恢复方法</strong>：mysqlbinlog 工具</li>
</ol>
<h3 id="常用命令速查"><a href="#常用命令速查" class="headerlink" title="常用命令速查"></a>常用命令速查</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看 binlog 配置</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;log_bin&#x27;</span>;</span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;binlog_format&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看 binlog 文件列表</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="type">BINARY</span> LOGS;</span><br><span class="line"><span class="keyword">SHOW</span> MASTER STATUS;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除 binlog</span></span><br><span class="line">PURGE <span class="type">BINARY</span> LOGS <span class="keyword">TO</span> <span class="string">&#x27;mysql-bin.000010&#x27;</span>;</span><br><span class="line">PURGE <span class="type">BINARY</span> LOGS BEFORE <span class="string">&#x27;2024-02-20&#x27;</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看 binlog 内容</span></span><br><span class="line">mysqlbinlog /var/log/mysql/mysql-bin.000001</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按时间筛选</span></span><br><span class="line">mysqlbinlog --start-datetime=<span class="string">&quot;2024-02-24&quot;</span> --stop-datetime=<span class="string">&quot;2024-02-25&quot;</span> mysql-bin.000001</span><br><span class="line"></span><br><span class="line"><span class="comment"># 恢复数据</span></span><br><span class="line">mysqlbinlog mysql-bin.000001 | mysql -u root -p</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>下一篇</strong>：[MySQL 运维篇 01-04 查询日志](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 01-04 查询日志&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 运维篇 01-02 错误日志](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 01-02 错误日志&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 运维篇</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>二进制日志</tag>
        <tag>binlog</tag>
        <tag>数据恢复</tag>
        <tag>主从复制</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 运维篇 02-01 主从复制概述</title>
    <url>/2026/02/24/MySQL%20%E8%BF%90%E7%BB%B4%E7%AF%87%2002-01%20%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E6%A6%82%E8%BF%B0/</url>
    <content><![CDATA[<h1 id="MySQL-运维篇-02-01-主从复制概述"><a href="#MySQL-运维篇-02-01-主从复制概述" class="headerlink" title="MySQL 运维篇 02-01 主从复制概述"></a>MySQL 运维篇 02-01 主从复制概述</h1><p>主从复制（Replication）是 MySQL 高可用架构的基础。本篇将介绍主从复制的概念、原理、应用场景和配置方法。</p>
<h2 id="一、主从复制介绍"><a href="#一、主从复制介绍" class="headerlink" title="一、主从复制介绍"></a>一、主从复制介绍</h2><h3 id="1-1-什么是主从复制？"><a href="#1-1-什么是主从复制？" class="headerlink" title="1.1 什么是主从复制？"></a>1.1 什么是主从复制？</h3><p><strong>主从复制</strong>是将一台 MySQL 服务器（主库）的数据同步到一台或多台 MySQL 服务器（从库）的技术。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">主从复制架构：</span><br><span class="line"></span><br><span class="line">       主库（Master）</span><br><span class="line">      /      |      \</span><br><span class="line">   从库 1   从库 2   从库 3</span><br><span class="line">  (Slave)  (Slave)  (Slave)</span><br></pre></td></tr></table></figure>

<h3 id="1-2-复制术语"><a href="#1-2-复制术语" class="headerlink" title="1.2 复制术语"></a>1.2 复制术语</h3><table>
<thead>
<tr>
<th>术语</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>主库（Master）</td>
<td>提供数据的 MySQL 服务器，处理写操作</td>
</tr>
<tr>
<td>从库（Slave）</td>
<td>复制数据的 MySQL 服务器，处理读操作</td>
</tr>
<tr>
<td>主库 binlog</td>
<td>主库记录的变更日志</td>
</tr>
<tr>
<td>中继日志（Relay Log）</td>
<td>从库存储的主库 binlog 副本</td>
</tr>
<tr>
<td>I&#x2F;O 线程</td>
<td>从库上负责连接主库并获取 binlog 的线程</td>
</tr>
<tr>
<td>SQL 线程</td>
<td>从库上负责重放 relay log 的线程</td>
</tr>
</tbody></table>
<h3 id="1-3-复制特点"><a href="#1-3-复制特点" class="headerlink" title="1.3 复制特点"></a>1.3 复制特点</h3><table>
<thead>
<tr>
<th>特点</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>异步复制</td>
<td>主库不等待从库确认（默认）</td>
</tr>
<tr>
<td>半同步复制</td>
<td>主库等待至少一个从库确认</td>
</tr>
<tr>
<td>并行复制</td>
<td>从库并行应用事务（MySQL 5.7+）</td>
</tr>
<tr>
<td>单向复制</td>
<td>数据从主库流向从库</td>
</tr>
</tbody></table>
<h2 id="二、复制原理"><a href="#二、复制原理" class="headerlink" title="二、复制原理"></a>二、复制原理</h2><h3 id="2-1-复制基本流程"><a href="#2-1-复制基本流程" class="headerlink" title="2.1 复制基本流程"></a>2.1 复制基本流程</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 主库将数据变更写入 binlog</span><br><span class="line">2. 从库 I/O 线程连接主库，请求 binlog</span><br><span class="line">3. 主库 dump 线程发送 binlog 给从库</span><br><span class="line">4. 从库 I/O 线程将 binlog 写入 relay log</span><br><span class="line">5. 从库 SQL 线程读取 relay log 并重放</span><br></pre></td></tr></table></figure>

<p><strong>流程图</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">主库                            从库</span><br><span class="line"> |                               |</span><br><span class="line"> |--- 1. 写入 binlog -----------&gt;|</span><br><span class="line"> |                               |</span><br><span class="line"> |&lt;-- 2. I/O 线程请求 binlog ----|</span><br><span class="line"> |                               |</span><br><span class="line"> |--- 3. 发送 binlog -----------&gt;|</span><br><span class="line"> |                               |</span><br><span class="line"> |                    4. 写入 relay log</span><br><span class="line"> |                               |</span><br><span class="line"> |                    5. SQL 线程重放</span><br><span class="line"> |                               |</span><br></pre></td></tr></table></figure>

<h3 id="2-2-复制线程"><a href="#2-2-复制线程" class="headerlink" title="2.2 复制线程"></a>2.2 复制线程</h3><p><strong>主库线程</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Dump Thread: 为每个从库创建一个，负责发送 binlog</span><br></pre></td></tr></table></figure>

<p><strong>从库线程</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">I/O Thread: 连接主库，获取 binlog 并写入 relay log</span><br><span class="line">SQL Thread: 读取 relay log，重放 SQL 操作</span><br></pre></td></tr></table></figure>

<h3 id="2-3-复制元数据"><a href="#2-3-复制元数据" class="headerlink" title="2.3 复制元数据"></a>2.3 复制元数据</h3><p><strong>从库元数据文件</strong>：</p>
<table>
<thead>
<tr>
<th>文件</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>master.info</td>
<td>存储主库连接信息（MySQL 8.0+ 移至表）</td>
</tr>
<tr>
<td>relay-log.info</td>
<td>存储 relay log 位置信息（MySQL 8.0+ 移至表）</td>
</tr>
</tbody></table>
<p><strong>MySQL 8.0+</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 元数据存储到系统表</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> mysql.slave_master_info;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> mysql.slave_relay_log_info;</span><br></pre></td></tr></table></figure>

<h2 id="三、复制场景"><a href="#三、复制场景" class="headerlink" title="三、复制场景"></a>三、复制场景</h2><h3 id="3-1-一主一从"><a href="#3-1-一主一从" class="headerlink" title="3.1 一主一从"></a>3.1 一主一从</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">最简单的主从架构：</span><br><span class="line"></span><br><span class="line">  Master → Slave</span><br></pre></td></tr></table></figure>

<p><strong>适用场景</strong>：</p>
<ul>
<li>数据备份</li>
<li>读写分离</li>
<li>故障切换</li>
</ul>
<h3 id="3-2-一主多从"><a href="#3-2-一主多从" class="headerlink" title="3.2 一主多从"></a>3.2 一主多从</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">一个主库，多个从库：</span><br><span class="line"></span><br><span class="line">        Master</span><br><span class="line">       /   |   \</span><br><span class="line">  Slave1 Slave2 Slave3</span><br></pre></td></tr></table></figure>

<p><strong>适用场景</strong>：</p>
<ul>
<li>多个业务系统读取</li>
<li>不同从库承担不同任务（备份、分析、报表）</li>
<li>提高读取并发能力</li>
</ul>
<h3 id="3-3-主主复制（双主）"><a href="#3-3-主主复制（双主）" class="headerlink" title="3.3 主主复制（双主）"></a>3.3 主主复制（双主）</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">两个主库互相复制：</span><br><span class="line"></span><br><span class="line">  Master1 ←→ Master2</span><br></pre></td></tr></table></figure>

<p><strong>适用场景</strong>：</p>
<ul>
<li>高可用</li>
<li>双向数据同步</li>
<li>注意：需要避免循环复制</li>
</ul>
<h3 id="3-4-级联复制"><a href="#3-4-级联复制" class="headerlink" title="3.4 级联复制"></a>3.4 级联复制</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">多级复制架构：</span><br><span class="line"></span><br><span class="line">    Master1</span><br><span class="line">       |</span><br><span class="line">    Master2 (作为 Master1 的从库)</span><br><span class="line">     /    \</span><br><span class="line">  Slave1 Slave2</span><br></pre></td></tr></table></figure>

<p><strong>适用场景</strong>：</p>
<ul>
<li>大型分布式系统</li>
<li>减少主库压力</li>
<li>分层数据分发</li>
</ul>
<h3 id="3-5-半同步复制"><a href="#3-5-半同步复制" class="headerlink" title="3.5 半同步复制"></a>3.5 半同步复制</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">增强的复制模式：</span><br><span class="line"></span><br><span class="line">  Master ←→ Slave (确认收到)</span><br></pre></td></tr></table></figure>

<p><strong>特点</strong>：</p>
<ul>
<li>主库等待至少一个从库确认收到 binlog</li>
<li>提高数据安全性</li>
<li>略微增加延迟</li>
</ul>
<h2 id="四、复制模式"><a href="#四、复制模式" class="headerlink" title="四、复制模式"></a>四、复制模式</h2><h3 id="4-1-异步复制（默认）"><a href="#4-1-异步复制（默认）" class="headerlink" title="4.1 异步复制（默认）"></a>4.1 异步复制（默认）</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">主库写入 binlog 后立即返回，不等待从库</span><br><span class="line"></span><br><span class="line">优点：性能最好</span><br><span class="line">缺点：可能丢失数据</span><br></pre></td></tr></table></figure>

<h3 id="4-2-半同步复制"><a href="#4-2-半同步复制" class="headerlink" title="4.2 半同步复制"></a>4.2 半同步复制</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">主库等待至少一个从库确认收到 binlog</span><br><span class="line"></span><br><span class="line">优点：数据更安全</span><br><span class="line">缺点：性能略有下降</span><br></pre></td></tr></table></figure>

<p><strong>配置</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 主库</span></span><br><span class="line">INSTALL PLUGIN rpl_semi_sync_master SONAME <span class="string">&#x27;semisync_master.so&#x27;</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> rpl_semi_sync_master_enabled <span class="operator">=</span> <span class="keyword">ON</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 从库</span></span><br><span class="line">INSTALL PLUGIN rpl_semi_sync_slave SONAME <span class="string">&#x27;semisync_slave.so&#x27;</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> rpl_semi_sync_slave_enabled <span class="operator">=</span> <span class="keyword">ON</span>;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-全同步复制（MySQL-8-0-）"><a href="#4-3-全同步复制（MySQL-8-0-）" class="headerlink" title="4.3 全同步复制（MySQL 8.0+）"></a>4.3 全同步复制（MySQL 8.0+）</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">主库等待所有从库确认</span><br><span class="line"></span><br><span class="line">优点：数据最安全</span><br><span class="line">缺点：性能影响较大</span><br></pre></td></tr></table></figure>

<h2 id="五、复制配置准备"><a href="#五、复制配置准备" class="headerlink" title="五、复制配置准备"></a>五、复制配置准备</h2><h3 id="5-1-主库配置"><a href="#5-1-主库配置" class="headerlink" title="5.1 主库配置"></a>5.1 主库配置</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># 开启 binlog</span></span><br><span class="line"><span class="attr">log_bin</span> = /var/log/mysql/mysql-bin.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 server_id（必须唯一）</span></span><br><span class="line"><span class="attr">server_id</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># binlog 格式（推荐 ROW）</span></span><br><span class="line"><span class="attr">binlog_format</span> = ROW</span><br><span class="line"></span><br><span class="line"><span class="comment"># 半同步复制（可选）</span></span><br><span class="line"><span class="comment"># rpl_semi_sync_master_enabled = ON</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-从库配置"><a href="#5-2-从库配置" class="headerlink" title="5.2 从库配置"></a>5.2 从库配置</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># 开启 relay log</span></span><br><span class="line"><span class="attr">relay_log</span> = /var/log/mysql/mysql-relay-bin.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 server_id（必须唯一）</span></span><br><span class="line"><span class="attr">server_id</span> = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 只读（推荐）</span></span><br><span class="line"><span class="attr">read_only</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 记录中继日志</span></span><br><span class="line"><span class="attr">log_slave_updates</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-复制用户创建"><a href="#5-3-复制用户创建" class="headerlink" title="5.3 复制用户创建"></a>5.3 复制用户创建</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 在主库创建复制用户</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;repl_password&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> REPLICATION SLAVE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 验证用户</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">User</span>, Host <span class="keyword">FROM</span> mysql.user <span class="keyword">WHERE</span> <span class="keyword">User</span> <span class="operator">=</span> <span class="string">&#x27;repl&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="六、复制状态监控"><a href="#六、复制状态监控" class="headerlink" title="六、复制状态监控"></a>六、复制状态监控</h2><h3 id="6-1-查看复制状态"><a href="#6-1-查看复制状态" class="headerlink" title="6.1 查看复制状态"></a>6.1 查看复制状态</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看从库状态</span></span><br><span class="line"><span class="keyword">SHOW</span> SLAVE STATUS\G</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 关键字段</span></span><br><span class="line"><span class="comment">-- Slave_IO_Running: Yes</span></span><br><span class="line"><span class="comment">-- Slave_SQL_Running: Yes</span></span><br><span class="line"><span class="comment">-- Seconds_Behind_Master: 0</span></span><br><span class="line"><span class="comment">-- Master_Host: 192.168.1.100</span></span><br><span class="line"><span class="comment">-- Master_Port: 3306</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-复制状态字段详解"><a href="#6-2-复制状态字段详解" class="headerlink" title="6.2 复制状态字段详解"></a>6.2 复制状态字段详解</h3><table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Slave_IO_Running</td>
<td>I&#x2F;O 线程状态</td>
</tr>
<tr>
<td>Slave_SQL_Running</td>
<td>SQL 线程状态</td>
</tr>
<tr>
<td>Seconds_Behind_Master</td>
<td>延迟时间（秒）</td>
</tr>
<tr>
<td>Master_Host</td>
<td>主库地址</td>
</tr>
<tr>
<td>Master_Port</td>
<td>主库端口</td>
</tr>
<tr>
<td>Master_Log_File</td>
<td>主库 binlog 文件名</td>
</tr>
<tr>
<td>Read_Master_Log_Pos</td>
<td>已读取的主库 binlog 位置</td>
</tr>
<tr>
<td>Relay_Master_Log_File</td>
<td>当前执行的 relay log 文件</td>
</tr>
<tr>
<td>Exec_Master_Log_Pos</td>
<td>当前执行的 binlog 位置</td>
</tr>
<tr>
<td>Last_Error</td>
<td>最后的错误信息</td>
</tr>
</tbody></table>
<h3 id="6-3-复制延迟检查"><a href="#6-3-复制延迟检查" class="headerlink" title="6.3 复制延迟检查"></a>6.3 复制延迟检查</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 检查延迟</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    Slave_IO_Running,</span><br><span class="line">    Slave_SQL_Running,</span><br><span class="line">    Seconds_Behind_Master,</span><br><span class="line">    Master_Log_File,</span><br><span class="line">    Exec_Master_Log_Pos</span><br><span class="line"><span class="keyword">FROM</span> information_schema.PROCESSLIST</span><br><span class="line"><span class="keyword">WHERE</span> COMMAND <span class="operator">=</span> <span class="string">&#x27;Binlog Dump&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="七、常见复制问题"><a href="#七、常见复制问题" class="headerlink" title="七、常见复制问题"></a>七、常见复制问题</h2><h3 id="7-1-复制错误"><a href="#7-1-复制错误" class="headerlink" title="7.1 复制错误"></a>7.1 复制错误</h3><table>
<thead>
<tr>
<th>错误</th>
<th>原因</th>
<th>解决方案</th>
</tr>
</thead>
<tbody><tr>
<td>1045</td>
<td>认证失败</td>
<td>检查用户名密码</td>
</tr>
<tr>
<td>1236</td>
<td>binlog 不存在</td>
<td>重新初始化</td>
</tr>
<tr>
<td>1062</td>
<td>主键冲突</td>
<td>跳过或修复数据</td>
</tr>
<tr>
<td>1032</td>
<td>记录不存在</td>
<td>跳过或修复数据</td>
</tr>
</tbody></table>
<h3 id="7-2-延迟问题"><a href="#7-2-延迟问题" class="headerlink" title="7.2 延迟问题"></a>7.2 延迟问题</h3><p><strong>原因</strong>：</p>
<ul>
<li>从库硬件性能不足</li>
<li>大事务</li>
<li>网络延迟</li>
<li>单线程复制</li>
</ul>
<p><strong>解决方案</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 开启并行复制（MySQL 5.7+）</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> slave_parallel_workers <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> slave_parallel_type <span class="operator">=</span> <span class="string">&#x27;LOGICAL_CLOCK&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="7-3-复制中断处理"><a href="#7-3-复制中断处理" class="headerlink" title="7.3 复制中断处理"></a>7.3 复制中断处理</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 1. 查看错误</span></span><br><span class="line"><span class="keyword">SHOW</span> SLAVE STATUS\G</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 跳过错误（谨慎使用）</span></span><br><span class="line">STOP SLAVE;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> sql_slave_skip_counter <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">START</span> SLAVE;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3. 重新配置</span></span><br><span class="line">STOP SLAVE;</span><br><span class="line">RESET SLAVE;</span><br><span class="line">CHANGE MASTER <span class="keyword">TO</span> ...;</span><br><span class="line"><span class="keyword">START</span> SLAVE;</span><br></pre></td></tr></table></figure>

<h2 id="八、最佳实践"><a href="#八、最佳实践" class="headerlink" title="八、最佳实践"></a>八、最佳实践</h2><h3 id="8-1-配置建议"><a href="#8-1-配置建议" class="headerlink" title="8.1 配置建议"></a>8.1 配置建议</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 主库</span></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">server_id</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">log_bin</span> = /var/log/mysql/mysql-bin.log</span><br><span class="line"><span class="attr">binlog_format</span> = ROW</span><br><span class="line"><span class="attr">sync_binlog</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从库</span></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">server_id</span> = <span class="number">2</span></span><br><span class="line"><span class="attr">relay_log</span> = /var/log/mysql/mysql-relay-bin.log</span><br><span class="line"><span class="attr">read_only</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">log_slave_updates</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="8-2-运维建议"><a href="#8-2-运维建议" class="headerlink" title="8.2 运维建议"></a>8.2 运维建议</h3><table>
<thead>
<tr>
<th>项目</th>
<th>建议</th>
</tr>
</thead>
<tbody><tr>
<td>server_id</td>
<td>确保全局唯一</td>
</tr>
<tr>
<td>监控告警</td>
<td>延迟超过阈值告警</td>
</tr>
<tr>
<td>定期演练</td>
<td>测试故障切换</td>
</tr>
<tr>
<td>备份策略</td>
<td>从库承担备份任务</td>
</tr>
</tbody></table>
<h3 id="8-3-监控指标"><a href="#8-3-监控指标" class="headerlink" title="8.3 监控指标"></a>8.3 监控指标</h3><table>
<thead>
<tr>
<th>指标</th>
<th>阈值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Seconds_Behind_Master</td>
<td>&gt; 60s</td>
<td>复制延迟</td>
</tr>
<tr>
<td>Slave_IO_Running</td>
<td>No</td>
<td>I&#x2F;O 线程停止</td>
</tr>
<tr>
<td>Slave_SQL_Running</td>
<td>No</td>
<td>SQL 线程停止</td>
</tr>
<tr>
<td>Relay_Log_Space</td>
<td>持续增长</td>
<td>复制积压</td>
</tr>
</tbody></table>
<h2 id="九、小结"><a href="#九、小结" class="headerlink" title="九、小结"></a>九、小结</h2><h3 id="核心知识点"><a href="#核心知识点" class="headerlink" title="核心知识点"></a>核心知识点</h3><ol>
<li><strong>复制原理</strong>：binlog → relay log → 重放</li>
<li><strong>复制线程</strong>：I&#x2F;O 线程获取日志，SQL 线程重放</li>
<li><strong>复制模式</strong>：异步、半同步、全同步</li>
<li><strong>监控方法</strong>：SHOW SLAVE STATUS</li>
</ol>
<h3 id="复制架构对比"><a href="#复制架构对比" class="headerlink" title="复制架构对比"></a>复制架构对比</h3><table>
<thead>
<tr>
<th>架构</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td>一主一从</td>
<td>简单可靠</td>
<td>单点故障</td>
</tr>
<tr>
<td>一主多从</td>
<td>读取并发高</td>
<td>主库压力大</td>
</tr>
<tr>
<td>主主复制</td>
<td>高可用</td>
<td>可能循环复制</td>
</tr>
<tr>
<td>级联复制</td>
<td>分层扩展</td>
<td>链路长</td>
</tr>
</tbody></table>
<h3 id="下一篇预告"><a href="#下一篇预告" class="headerlink" title="下一篇预告"></a>下一篇预告</h3><p>接下来的文章将详细介绍主从复制的配置：</p>
<ul>
<li>02-03：主库配置</li>
<li>02-04：从库配置</li>
<li>02-05：复制测试</li>
</ul>
<hr>
<p><strong>下一篇</strong>：[MySQL 运维篇 02-02 主从复制原理](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 02-02 主从复制原理&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 运维篇 01-05 慢查询日志](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 01-05 慢查询日志&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 运维篇</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>主从复制</tag>
        <tag>复制</tag>
        <tag>高可用</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 运维篇 02-02 主从复制原理</title>
    <url>/2026/02/24/MySQL%20%E8%BF%90%E7%BB%B4%E7%AF%87%2002-02%20%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<h1 id="MySQL-运维篇-02-02-主从复制原理"><a href="#MySQL-运维篇-02-02-主从复制原理" class="headerlink" title="MySQL 运维篇 02-02 主从复制原理"></a>MySQL 运维篇 02-02 主从复制原理</h1><p>深入理解主从复制的工作原理对于配置、监控和故障排查至关重要。本文将详细讲解复制的底层机制。</p>
<h2 id="一、复制整体架构"><a href="#一、复制整体架构" class="headerlink" title="一、复制整体架构"></a>一、复制整体架构</h2><h3 id="1-1-复制组件"><a href="#1-1-复制组件" class="headerlink" title="1.1 复制组件"></a>1.1 复制组件</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">主从复制核心组件：</span><br><span class="line"></span><br><span class="line">主库端：</span><br><span class="line">├── Binlog Dump Thread（为每个从库创建一个）</span><br><span class="line">└── Binlog（二进制日志）</span><br><span class="line"></span><br><span class="line">从库端：</span><br><span class="line">├── I/O Thread（一个）</span><br><span class="line">├── SQL Thread（一个）</span><br><span class="line">├── Relay Log（中继日志）</span><br><span class="line">└── Relay Log Info / Master Info（元数据）</span><br></pre></td></tr></table></figure>

<h3 id="1-2-数据流向"><a href="#1-2-数据流向" class="headerlink" title="1.2 数据流向"></a>1.2 数据流向</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">应用写入 → 主库 → binlog → I/O 线程 → relay log → SQL 线程 → 从库数据</span><br></pre></td></tr></table></figure>

<h2 id="二、主库复制机制"><a href="#二、主库复制机制" class="headerlink" title="二、主库复制机制"></a>二、主库复制机制</h2><h3 id="2-1-Binlog-Dump-线程"><a href="#2-1-Binlog-Dump-线程" class="headerlink" title="2.1 Binlog Dump 线程"></a>2.1 Binlog Dump 线程</h3><p><strong>创建时机</strong>：</p>
<ul>
<li>从库连接主库时创建</li>
<li>每个从库对应一个线程</li>
</ul>
<p><strong>主要职责</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 接收从库 I/O 线程的 binlog 请求</span><br><span class="line">2. 读取 binlog 指定位置的内容</span><br><span class="line">3. 将 binlog 事件发送给从库</span><br><span class="line">4. 等待新 binlog 事件产生</span><br></pre></td></tr></table></figure>

<p><strong>线程状态</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 在主库查看 dump 线程</span></span><br><span class="line"><span class="keyword">SHOW</span> PROCESSLIST;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 输出示例：</span></span><br><span class="line"><span class="comment">-- Id: 10, Command: Binlog Dump, State: Has sent all binlog to slave</span></span><br><span class="line"><span class="comment">-- Id: 11, Command: Binlog Dump, State: Waiting for update</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-binlog-传输"><a href="#2-2-binlog-传输" class="headerlink" title="2.2 binlog 传输"></a>2.2 binlog 传输</h3><p><strong>传输过程</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 从库 I/O 线程发送请求：</span><br><span class="line">   - 当前已接收的 binlog 文件名</span><br><span class="line">   - 当前已接收的位置</span><br><span class="line"></span><br><span class="line">2. 主库 Binlog Dump 线程响应：</span><br><span class="line">   - 从指定位置读取 binlog</span><br><span class="line">   - 将事件打包发送</span><br><span class="line">   - 如果没有新事件，进入等待</span><br></pre></td></tr></table></figure>

<p><strong>binlog 事件格式</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+-------------------+------------------+</span><br><span class="line">| Event Header      | Event Data       |</span><br><span class="line">+-------------------+------------------+</span><br><span class="line">| timestamp         | specific data... |</span><br><span class="line">| type_code         |                  |</span><br><span class="line">| server_id         |                  |</span><br><span class="line">| event size        |                  |</span><br><span class="line">| log_pos           |                  |</span><br><span class="line">| flags             |                  |</span><br><span class="line">+-------------------+------------------+</span><br></pre></td></tr></table></figure>

<h2 id="三、从库复制机制"><a href="#三、从库复制机制" class="headerlink" title="三、从库复制机制"></a>三、从库复制机制</h2><h3 id="3-1-I-O-线程"><a href="#3-1-I-O-线程" class="headerlink" title="3.1 I&#x2F;O 线程"></a>3.1 I&#x2F;O 线程</h3><p><strong>主要职责</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 连接主库</span><br><span class="line">2. 请求 binlog 事件</span><br><span class="line">3. 接收 binlog 事件</span><br><span class="line">4. 写入 relay log</span><br><span class="line">5. 更新 master.info</span><br></pre></td></tr></table></figure>

<p><strong>工作流程</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">START SLAVE → 连接主库 → 请求 binlog → 接收事件 → 写入 relay log</span><br><span class="line">      ↑                                              |</span><br><span class="line">      └──────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="3-2-SQL-线程"><a href="#3-2-SQL-线程" class="headerlink" title="3.2 SQL 线程"></a>3.2 SQL 线程</h3><p><strong>主要职责</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 读取 relay log</span><br><span class="line">2. 解析事件内容</span><br><span class="line">3. 执行 SQL 操作</span><br><span class="line">4. 更新 relay-log.info</span><br></pre></td></tr></table></figure>

<p><strong>执行方式</strong>：</p>
<ul>
<li>单线程（默认）：按顺序执行</li>
<li>多线程（并行复制）：并发执行</li>
</ul>
<h3 id="3-3-Relay-Log"><a href="#3-3-Relay-Log" class="headerlink" title="3.3 Relay Log"></a>3.3 Relay Log</h3><p><strong>什么是 Relay Log</strong>：</p>
<ul>
<li>从库存储主库 binlog 的副本</li>
<li>格式与 binlog 相同</li>
<li>由 I&#x2F;O 线程写入，SQL 线程读取</li>
</ul>
<p><strong>Relay Log 文件</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql-relay-bin.000001</span><br><span class="line">mysql-relay-bin.000002</span><br><span class="line">mysql-relay-bin.000003</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>相关文件</strong>：</p>
<table>
<thead>
<tr>
<th>文件</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>mysql-relay-bin.NNNNNN</td>
<td>relay log 文件</td>
</tr>
<tr>
<td>mysql-relay-bin.index</td>
<td>relay log 索引文件</td>
</tr>
<tr>
<td>relay-log.info</td>
<td>relay log 元数据（MySQL 8.0+ 为表）</td>
</tr>
</tbody></table>
<h2 id="四、复制元数据"><a href="#四、复制元数据" class="headerlink" title="四、复制元数据"></a>四、复制元数据</h2><h3 id="4-1-Master-Info"><a href="#4-1-Master-Info" class="headerlink" title="4.1 Master Info"></a>4.1 Master Info</h3><p><strong>存储内容</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">- 主库连接信息（host, port, user, password）</span><br><span class="line">- 已读取的 binlog 文件名和位置</span><br></pre></td></tr></table></figure>

<p><strong>存储方式</strong>：</p>
<ul>
<li>MySQL 5.6 及之前：master.info 文件</li>
<li>MySQL 8.0+：mysql.slave_master_info 表</li>
</ul>
<p><strong>查看命令</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- MySQL 8.0+</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> mysql.slave_master_info;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 通用命令</span></span><br><span class="line"><span class="keyword">SHOW</span> SLAVE STATUS\G</span><br></pre></td></tr></table></figure>

<h3 id="4-2-Relay-Log-Info"><a href="#4-2-Relay-Log-Info" class="headerlink" title="4.2 Relay Log Info"></a>4.2 Relay Log Info</h3><p><strong>存储内容</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">- 当前 relay log 文件名</span><br><span class="line">- 当前 relay log 位置</span><br><span class="line">- 已执行的 master binlog 位置</span><br></pre></td></tr></table></figure>

<p><strong>存储方式</strong>：</p>
<ul>
<li>MySQL 5.6 及之前：relay-log.info 文件</li>
<li>MySQL 8.0+：mysql.slave_relay_log_info 表</li>
</ul>
<p><strong>查看命令</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- MySQL 8.0+</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> mysql.slave_relay_log_info;</span><br></pre></td></tr></table></figure>

<h2 id="五、复制事件处理"><a href="#五、复制事件处理" class="headerlink" title="五、复制事件处理"></a>五、复制事件处理</h2><h3 id="5-1-Binlog-事件类型"><a href="#5-1-Binlog-事件类型" class="headerlink" title="5.1 Binlog 事件类型"></a>5.1 Binlog 事件类型</h3><table>
<thead>
<tr>
<th>事件类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Query_event</td>
<td>DDL&#x2F;DML 语句</td>
</tr>
<tr>
<td>Table_map_event</td>
<td>表结构映射</td>
</tr>
<tr>
<td>Write_rows_event</td>
<td>插入行数据</td>
</tr>
<tr>
<td>Update_rows_event</td>
<td>更新行数据</td>
</tr>
<tr>
<td>Delete_rows_event</td>
<td>删除行数据</td>
</tr>
<tr>
<td>Xid_event</td>
<td>事务提交</td>
</tr>
<tr>
<td>Rotate_event</td>
<td>binlog 切换</td>
</tr>
<tr>
<td>Format_description_event</td>
<td>binlog 描述</td>
</tr>
</tbody></table>
<h3 id="5-2-事件处理流程"><a href="#5-2-事件处理流程" class="headerlink" title="5.2 事件处理流程"></a>5.2 事件处理流程</h3><p><strong>INSERT 操作</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">主库执行：</span><br><span class="line">INSERT INTO users (id, name) VALUES (1, &#x27;张三&#x27;);</span><br><span class="line"></span><br><span class="line">Binlog 事件序列：</span><br><span class="line">1. Query_event: BEGIN</span><br><span class="line">2. Table_map_event: users 表信息</span><br><span class="line">3. Write_rows_event: 行数据 (1, &#x27;张三&#x27;)</span><br><span class="line">4. Xid_event: COMMIT</span><br><span class="line"></span><br><span class="line">从库重放：</span><br><span class="line">SQL 线程按顺序执行相同事件</span><br></pre></td></tr></table></figure>

<h3 id="5-3-事务复制"><a href="#5-3-事务复制" class="headerlink" title="5.3 事务复制"></a>5.3 事务复制</h3><p><strong>事务边界</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">主库：</span><br><span class="line">BEGIN;</span><br><span class="line">UPDATE accounts SET balance = balance - 100 WHERE id = 1;</span><br><span class="line">UPDATE accounts SET balance = balance + 100 WHERE id = 2;</span><br><span class="line">COMMIT;</span><br><span class="line"></span><br><span class="line">Binlog：</span><br><span class="line">[Query_event: BEGIN]</span><br><span class="line">[Table_map_event]</span><br><span class="line">[Update_rows_event]</span><br><span class="line">[Table_map_event]</span><br><span class="line">[Update_rows_event]</span><br><span class="line">[Xid_event: COMMIT]</span><br><span class="line"></span><br><span class="line">从库：</span><br><span class="line">作为一个整体事务执行</span><br></pre></td></tr></table></figure>

<h2 id="六、复制延迟分析"><a href="#六、复制延迟分析" class="headerlink" title="六、复制延迟分析"></a>六、复制延迟分析</h2><h3 id="6-1-延迟定义"><a href="#6-1-延迟定义" class="headerlink" title="6.1 延迟定义"></a>6.1 延迟定义</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">复制延迟 = 当前时间 - 从库执行完最后一个事务的时间</span><br></pre></td></tr></table></figure>

<p><strong>计算公式</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Seconds_Behind_Master =</span><br><span class="line">    SQL 线程执行时刻 - 主库执行该事务的时刻</span><br></pre></td></tr></table></figure>

<h3 id="6-2-延迟产生原因"><a href="#6-2-延迟产生原因" class="headerlink" title="6.2 延迟产生原因"></a>6.2 延迟产生原因</h3><p><strong>I&#x2F;O 延迟</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">- 网络延迟</span><br><span class="line">- 主库负载高，dump 线程响应慢</span><br><span class="line">- 从库 I/O 线程处理慢</span><br></pre></td></tr></table></figure>

<p><strong>SQL 延迟</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">- 从库单线程执行</span><br><span class="line">- 大事务执行时间长</span><br><span class="line">- 从库负载高，SQL 线程等待</span><br><span class="line">- 锁等待</span><br></pre></td></tr></table></figure>

<h3 id="6-3-延迟计算过程"><a href="#6-3-延迟计算过程" class="headerlink" title="6.3 延迟计算过程"></a>6.3 延迟计算过程</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">时间线：</span><br><span class="line">主库 T1: 执行事务 A</span><br><span class="line">主库 T2: binlog 发送完成</span><br><span class="line">从库 T3: relay log 写入完成</span><br><span class="line">从库 T4: 事务 A 执行完成</span><br><span class="line"></span><br><span class="line">Seconds_Behind_Master = T4 - T1</span><br></pre></td></tr></table></figure>

<h2 id="七、GTID-复制"><a href="#七、GTID-复制" class="headerlink" title="七、GTID 复制"></a>七、GTID 复制</h2><h3 id="7-1-什么是-GTID"><a href="#7-1-什么是-GTID" class="headerlink" title="7.1 什么是 GTID"></a>7.1 什么是 GTID</h3><p><strong>GTID（Global Transaction Identifier）</strong>：</p>
<ul>
<li>全局唯一的事务标识符</li>
<li>格式：<code>source_id:transaction_id</code></li>
<li>示例：<code>3E11FA47-71CA-11E1-9E33-C80AA9429562:23</code></li>
</ul>
<h3 id="7-2-GTID-优势"><a href="#7-2-GTID-优势" class="headerlink" title="7.2 GTID 优势"></a>7.2 GTID 优势</h3><table>
<thead>
<tr>
<th>传统复制</th>
<th>GTID 复制</th>
</tr>
</thead>
<tbody><tr>
<td>基于 binlog 位置</td>
<td>基于 GTID</td>
</tr>
<tr>
<td>切换复杂</td>
<td>切换简单</td>
</tr>
<tr>
<td>难以保证一致性</td>
<td>自动保证一致性</td>
</tr>
</tbody></table>
<h3 id="7-3-GTID-配置"><a href="#7-3-GTID-配置" class="headerlink" title="7.3 GTID 配置"></a>7.3 GTID 配置</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># 主库和从库都需要配置</span></span><br><span class="line"><span class="attr">gtid_mode</span> = <span class="literal">ON</span></span><br><span class="line"><span class="attr">enforce_gtid_consistency</span> = <span class="literal">ON</span></span><br><span class="line"><span class="attr">log_slave_updates</span> = <span class="literal">ON</span></span><br></pre></td></tr></table></figure>

<p><strong>GTID 复制命令</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 基于 GTID 启动复制</span></span><br><span class="line">CHANGE MASTER <span class="keyword">TO</span></span><br><span class="line">    MASTER_AUTO_POSITION <span class="operator">=</span> <span class="number">1</span>,</span><br><span class="line">    MASTER_HOST <span class="operator">=</span> <span class="string">&#x27;master_host&#x27;</span>,</span><br><span class="line">    MASTER_USER <span class="operator">=</span> <span class="string">&#x27;repl&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">START</span> SLAVE;</span><br></pre></td></tr></table></figure>

<h2 id="八、并行复制"><a href="#八、并行复制" class="headerlink" title="八、并行复制"></a>八、并行复制</h2><h3 id="8-1-并行复制原理"><a href="#8-1-并行复制原理" class="headerlink" title="8.1 并行复制原理"></a>8.1 并行复制原理</h3><p><strong>传统复制（单线程）</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL Thread → 事务 1 → 事务 2 → 事务 3 → ...</span><br></pre></td></tr></table></figure>

<p><strong>并行复制（多线程）</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL Thread (coordinator)</span><br><span class="line">    ↓</span><br><span class="line">Worker 1 → 事务 1</span><br><span class="line">Worker 2 → 事务 2</span><br><span class="line">Worker 3 → 事务 3</span><br></pre></td></tr></table></figure>

<h3 id="8-2-并行复制类型"><a href="#8-2-并行复制类型" class="headerlink" title="8.2 并行复制类型"></a>8.2 并行复制类型</h3><p><strong>MySQL 5.6</strong>：</p>
<ul>
<li>按库并行：不同库的事务可以并行</li>
<li>限制：同一库的事务串行</li>
</ul>
<p><strong>MySQL 5.7+</strong>：</p>
<ul>
<li>LOGICAL_CLOCK：基于组的提交</li>
<li>同一组的事务可以并行</li>
</ul>
<p><strong>MySQL 8.0+</strong>：</p>
<ul>
<li>WRITESET：基于写集依赖</li>
<li>更精确的依赖判断</li>
</ul>
<h3 id="8-3-并行复制配置"><a href="#8-3-并行复制配置" class="headerlink" title="8.3 并行复制配置"></a>8.3 并行复制配置</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看当前配置</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;slave_parallel%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 配置并行复制</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> slave_parallel_workers <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> slave_parallel_type <span class="operator">=</span> <span class="string">&#x27;LOGICAL_CLOCK&#x27;</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> slave_preserve_commit_order <span class="operator">=</span> <span class="keyword">ON</span>;</span><br></pre></td></tr></table></figure>

<h2 id="九、复制状态监控"><a href="#九、复制状态监控" class="headerlink" title="九、复制状态监控"></a>九、复制状态监控</h2><h3 id="9-1-SHOW-SLAVE-STATUS"><a href="#9-1-SHOW-SLAVE-STATUS" class="headerlink" title="9.1 SHOW SLAVE STATUS"></a>9.1 SHOW SLAVE STATUS</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> SLAVE STATUS\G</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 关键字段：</span></span><br><span class="line">Slave_IO_State: Waiting <span class="keyword">for</span> master <span class="keyword">to</span> send event</span><br><span class="line">Master_Host: <span class="number">192.168</span><span class="number">.1</span><span class="number">.100</span></span><br><span class="line">Master_User: repl</span><br><span class="line">Master_Port: <span class="number">3306</span></span><br><span class="line">Connect_Retry: <span class="number">60</span></span><br><span class="line">Master_Log_File: mysql<span class="operator">-</span>bin<span class="number">.000001</span></span><br><span class="line">Read_Master_Log_Pos: <span class="number">154</span></span><br><span class="line">Relay_Log_File: mysql<span class="operator">-</span>relay<span class="operator">-</span>bin<span class="number">.000002</span></span><br><span class="line">Relay_Log_Pos: <span class="number">320</span></span><br><span class="line">Relay_Master_Log_File: mysql<span class="operator">-</span>bin<span class="number">.000001</span></span><br><span class="line">Slave_IO_Running: Yes</span><br><span class="line">Slave_SQL_Running: Yes</span><br><span class="line">Replicate_Do_DB:</span><br><span class="line">Replicate_Ignore_DB:</span><br><span class="line">Replicate_Do_Table:</span><br><span class="line">Replicate_Ignore_Table:</span><br><span class="line">Seconds_Behind_Master: <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h3 id="9-2-performance-schema-表"><a href="#9-2-performance-schema-表" class="headerlink" title="9.2 performance_schema 表"></a>9.2 performance_schema 表</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- MySQL 5.7+</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> performance_schema.replication_connection_status;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> performance_schema.replication_applier_status;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> performance_schema.replication_applier_status_by_worker;</span><br></pre></td></tr></table></figure>

<h2 id="十、小结"><a href="#十、小结" class="headerlink" title="十、小结"></a>十、小结</h2><h3 id="复制流程总结"><a href="#复制流程总结" class="headerlink" title="复制流程总结"></a>复制流程总结</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 应用写入主库</span><br><span class="line">2. 主库写入 binlog</span><br><span class="line">3. 从库 I/O 线程获取 binlog</span><br><span class="line">4. I/O 线程写入 relay log</span><br><span class="line">5. SQL 线程读取 relay log</span><br><span class="line">6. SQL 线程重放操作</span><br></pre></td></tr></table></figure>

<h3 id="核心组件"><a href="#核心组件" class="headerlink" title="核心组件"></a>核心组件</h3><table>
<thead>
<tr>
<th>组件</th>
<th>位置</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>Binlog Dump Thread</td>
<td>主库</td>
<td>发送 binlog</td>
</tr>
<tr>
<td>I&#x2F;O Thread</td>
<td>从库</td>
<td>获取 binlog</td>
</tr>
<tr>
<td>SQL Thread</td>
<td>从库</td>
<td>重放操作</td>
</tr>
<tr>
<td>Relay Log</td>
<td>从库</td>
<td>存储 binlog 副本</td>
</tr>
</tbody></table>
<h3 id="关键概念"><a href="#关键概念" class="headerlink" title="关键概念"></a>关键概念</h3><ol>
<li><strong>异步复制</strong>：主库不等待从库</li>
<li><strong>延迟原因</strong>：单线程、大事务、网络</li>
<li><strong>GTID</strong>：全局事务标识符</li>
<li><strong>并行复制</strong>：多线程重放</li>
</ol>
<hr>
<p><strong>下一篇</strong>：[MySQL 运维篇 02-03 主从复制主库配置](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 02-03 主从复制主库配置&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 运维篇 02-01 主从复制概述](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 02-01 主从复制概述&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 运维篇</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>binlog</tag>
        <tag>主从复制</tag>
        <tag>复制原理</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 运维篇 02-05 主从复制测试</title>
    <url>/2026/02/24/MySQL%20%E8%BF%90%E7%BB%B4%E7%AF%87%2002-05%20%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E6%B5%8B%E8%AF%95/</url>
    <content><![CDATA[<h1 id="MySQL-运维篇-02-05-主从复制测试"><a href="#MySQL-运维篇-02-05-主从复制测试" class="headerlink" title="MySQL 运维篇 02-05 主从复制测试"></a>MySQL 运维篇 02-05 主从复制测试</h1><p>完成主从配置后，需要进行全面的测试以验证复制功能正常。本文将介绍各种测试场景和验证方法。</p>
<h2 id="一、复制状态检查"><a href="#一、复制状态检查" class="headerlink" title="一、复制状态检查"></a>一、复制状态检查</h2><h3 id="1-1-基础状态检查"><a href="#1-1-基础状态检查" class="headerlink" title="1.1 基础状态检查"></a>1.1 基础状态检查</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 在从库执行</span></span><br><span class="line"><span class="keyword">SHOW</span> SLAVE STATUS\G</span><br></pre></td></tr></table></figure>

<p><strong>关键指标</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Slave_IO_Running: Yes        ✓ I/O 线程运行正常</span><br><span class="line">Slave_SQL_Running: Yes       ✓ SQL 线程运行正常</span><br><span class="line">Seconds_Behind_Master: 0     ✓ 无延迟</span><br><span class="line">Master_Host: 192.168.1.100   ✓ 主库连接正确</span><br><span class="line">Master_Port: 3306            ✓ 端口正确</span><br><span class="line">Last_Error:                  ✓ 无错误</span><br><span class="line">Last_IO_Error:               ✓ 无错误</span><br><span class="line">Last_SQL_Error:              ✓ 无错误</span><br></pre></td></tr></table></figure>

<h3 id="1-2-详细状态检查"><a href="#1-2-详细状态检查" class="headerlink" title="1.2 详细状态检查"></a>1.2 详细状态检查</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 检查复制配置</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    Master_Host,</span><br><span class="line">    Master_Port,</span><br><span class="line">    Master_User,</span><br><span class="line">    Master_Log_File,</span><br><span class="line">    Read_Master_Log_Pos,</span><br><span class="line">    Relay_Master_Log_File,</span><br><span class="line">    Exec_Master_Log_Pos,</span><br><span class="line">    Seconds_Behind_Master</span><br><span class="line"><span class="keyword">FROM</span> mysql.slave_master_info;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查线程状态</span></span><br><span class="line"><span class="keyword">SHOW</span> PROCESSLIST;</span><br><span class="line"><span class="comment">-- 应该看到 IO Thread 和 SQL Thread</span></span><br></pre></td></tr></table></figure>

<h3 id="1-3-性能指标检查"><a href="#1-3-性能指标检查" class="headerlink" title="1.3 性能指标检查"></a>1.3 性能指标检查</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看复制延迟趋势</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    NOW() <span class="keyword">AS</span> check_time,</span><br><span class="line">    Seconds_Behind_Master,</span><br><span class="line">    Relay_Log_Space,</span><br><span class="line">    Exec_Master_Log_Pos</span><br><span class="line"><span class="keyword">FROM</span> information_schema.PROCESSLIST</span><br><span class="line"><span class="keyword">WHERE</span> COMMAND <span class="operator">=</span> <span class="string">&#x27;Connect&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="二、数据同步测试"><a href="#二、数据同步测试" class="headerlink" title="二、数据同步测试"></a>二、数据同步测试</h2><h3 id="2-1-DDL-操作测试"><a href="#2-1-DDL-操作测试" class="headerlink" title="2.1 DDL 操作测试"></a>2.1 DDL 操作测试</h3><p><strong>在主库执行</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建测试数据库</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE test_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建测试表</span></span><br><span class="line">USE test_db;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> test_table (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    age <span class="type">INT</span>,</span><br><span class="line">    created_at DATETIME <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_name <span class="keyword">ON</span> test_table(name);</span><br></pre></td></tr></table></figure>

<p><strong>在从库验证</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 检查数据库是否存在</span></span><br><span class="line"><span class="keyword">SHOW</span> DATABASES <span class="keyword">LIKE</span> <span class="string">&#x27;test_db&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查表结构</span></span><br><span class="line">USE test_db;</span><br><span class="line"><span class="keyword">SHOW</span> TABLES;</span><br><span class="line"><span class="keyword">DESC</span> test_table;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查索引</span></span><br><span class="line"><span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> test_table;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-INSERT-操作测试"><a href="#2-2-INSERT-操作测试" class="headerlink" title="2.2 INSERT 操作测试"></a>2.2 INSERT 操作测试</h3><p><strong>在主库执行</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">USE test_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入单条记录</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> test_table (name, age) <span class="keyword">VALUES</span> (<span class="string">&#x27;张三&#x27;</span>, <span class="number">25</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入多条记录</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> test_table (name, age) <span class="keyword">VALUES</span></span><br><span class="line">    (<span class="string">&#x27;李四&#x27;</span>, <span class="number">30</span>),</span><br><span class="line">    (<span class="string">&#x27;王五&#x27;</span>, <span class="number">28</span>),</span><br><span class="line">    (<span class="string">&#x27;赵六&#x27;</span>, <span class="number">35</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看插入的数据</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> test_table;</span><br></pre></td></tr></table></figure>

<p><strong>在从库验证</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">USE test_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查数据是否同步</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> test_table;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查记录数</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> test_table;</span><br><span class="line"><span class="comment">-- 应该返回 4</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-UPDATE-操作测试"><a href="#2-3-UPDATE-操作测试" class="headerlink" title="2.3 UPDATE 操作测试"></a>2.3 UPDATE 操作测试</h3><p><strong>在主库执行</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">USE test_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 更新数据</span></span><br><span class="line"><span class="keyword">UPDATE</span> test_table <span class="keyword">SET</span> age <span class="operator">=</span> <span class="number">26</span> <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 批量更新</span></span><br><span class="line"><span class="keyword">UPDATE</span> test_table <span class="keyword">SET</span> age <span class="operator">=</span> age <span class="operator">+</span> <span class="number">1</span> <span class="keyword">WHERE</span> age <span class="operator">&lt;</span> <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看更新结果</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> test_table;</span><br></pre></td></tr></table></figure>

<p><strong>在从库验证</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">USE test_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查更新是否同步</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> test_table <span class="keyword">ORDER</span> <span class="keyword">BY</span> name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 验证数据一致性</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    name,</span><br><span class="line">    age,</span><br><span class="line">    <span class="keyword">CASE</span></span><br><span class="line">        <span class="keyword">WHEN</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span> <span class="keyword">AND</span> age <span class="operator">=</span> <span class="number">26</span> <span class="keyword">THEN</span> <span class="string">&#x27;OK&#x27;</span></span><br><span class="line">        <span class="keyword">WHEN</span> name <span class="operator">=</span> <span class="string">&#x27;李四&#x27;</span> <span class="keyword">AND</span> age <span class="operator">=</span> <span class="number">31</span> <span class="keyword">THEN</span> <span class="string">&#x27;OK&#x27;</span></span><br><span class="line">        <span class="keyword">WHEN</span> name <span class="operator">=</span> <span class="string">&#x27;王五&#x27;</span> <span class="keyword">AND</span> age <span class="operator">=</span> <span class="number">29</span> <span class="keyword">THEN</span> <span class="string">&#x27;OK&#x27;</span></span><br><span class="line">        <span class="keyword">WHEN</span> name <span class="operator">=</span> <span class="string">&#x27;赵六&#x27;</span> <span class="keyword">AND</span> age <span class="operator">=</span> <span class="number">35</span> <span class="keyword">THEN</span> <span class="string">&#x27;OK&#x27;</span></span><br><span class="line">        <span class="keyword">ELSE</span> <span class="string">&#x27;ERROR&#x27;</span></span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">AS</span> status</span><br><span class="line"><span class="keyword">FROM</span> test_table;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-DELETE-操作测试"><a href="#2-4-DELETE-操作测试" class="headerlink" title="2.4 DELETE 操作测试"></a>2.4 DELETE 操作测试</h3><p><strong>在主库执行</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">USE test_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除数据</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> test_table <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;赵六&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看删除结果</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> test_table;</span><br></pre></td></tr></table></figure>

<p><strong>在从库验证</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">USE test_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查删除是否同步</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> test_table;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查记录数</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> test_table;</span><br><span class="line"><span class="comment">-- 应该返回 3</span></span><br></pre></td></tr></table></figure>

<h3 id="2-5-事务测试"><a href="#2-5-事务测试" class="headerlink" title="2.5 事务测试"></a>2.5 事务测试</h3><p><strong>在主库执行</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">USE test_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 开始事务</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 执行多条 SQL</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> test_table (name, age) <span class="keyword">VALUES</span> (<span class="string">&#x27;事务 1&#x27;</span>, <span class="number">20</span>);</span><br><span class="line"><span class="keyword">INSERT INTO</span> test_table (name, age) <span class="keyword">VALUES</span> (<span class="string">&#x27;事务 2&#x27;</span>, <span class="number">21</span>);</span><br><span class="line"><span class="keyword">UPDATE</span> test_table <span class="keyword">SET</span> age <span class="operator">=</span> <span class="number">22</span> <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;事务 1&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 提交事务</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看结果</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> test_table <span class="keyword">WHERE</span> name <span class="keyword">LIKE</span> <span class="string">&#x27;事务%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>在从库验证</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">USE test_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查事务是否完整同步</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> test_table <span class="keyword">WHERE</span> name <span class="keyword">LIKE</span> <span class="string">&#x27;事务%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 验证事务原子性</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> test_table <span class="keyword">WHERE</span> name <span class="keyword">LIKE</span> <span class="string">&#x27;事务%&#x27;</span>;</span><br><span class="line"><span class="comment">-- 应该返回 2</span></span><br></pre></td></tr></table></figure>

<h2 id="三、特殊场景测试"><a href="#三、特殊场景测试" class="headerlink" title="三、特殊场景测试"></a>三、特殊场景测试</h2><h3 id="3-1-大批量数据测试"><a href="#3-1-大批量数据测试" class="headerlink" title="3.1 大批量数据测试"></a>3.1 大批量数据测试</h3><p><strong>在主库执行</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">USE test_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建大表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> large_table (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    data <span class="type">VARCHAR</span>(<span class="number">255</span>)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入大量数据</span></span><br><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> insert_large_data()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>;</span><br><span class="line">    WHILE i <span class="operator">&lt;=</span> <span class="number">10000</span> DO</span><br><span class="line">        <span class="keyword">INSERT INTO</span> large_table (data) <span class="keyword">VALUES</span> (CONCAT(<span class="string">&#x27;data_&#x27;</span>, i));</span><br><span class="line">        <span class="keyword">SET</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">END</span> WHILE;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 调用存储过程</span></span><br><span class="line"><span class="keyword">CALL</span> insert_large_data();</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看数据量</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> large_table;</span><br></pre></td></tr></table></figure>

<p><strong>在从库验证</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">USE test_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查数据量</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> large_table;</span><br><span class="line"><span class="comment">-- 应该返回 10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查复制延迟</span></span><br><span class="line"><span class="keyword">SHOW</span> SLAVE STATUS\G</span><br><span class="line"><span class="comment">-- 查看 Seconds_Behind_Master</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-DDL-变更测试"><a href="#3-2-DDL-变更测试" class="headerlink" title="3.2 DDL 变更测试"></a>3.2 DDL 变更测试</h3><p><strong>在主库执行</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">USE test_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 添加列</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> test_table <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> email <span class="type">VARCHAR</span>(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改列</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> test_table MODIFY <span class="keyword">COLUMN</span> name <span class="type">VARCHAR</span>(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 添加索引</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> test_table <span class="keyword">ADD</span> INDEX idx_email(email);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看表结构</span></span><br><span class="line"><span class="keyword">DESC</span> test_table;</span><br></pre></td></tr></table></figure>

<p><strong>在从库验证</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">USE test_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查表结构变更</span></span><br><span class="line"><span class="keyword">DESC</span> test_table;</span><br><span class="line"><span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> test_table;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-临时表测试"><a href="#3-3-临时表测试" class="headerlink" title="3.3 临时表测试"></a>3.3 临时表测试</h3><p><strong>在主库执行</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">USE test_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建临时表</span></span><br><span class="line"><span class="keyword">CREATE</span> TEMPORARY <span class="keyword">TABLE</span> temp_table (</span><br><span class="line">    id <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">value</span> <span class="type">VARCHAR</span>(<span class="number">50</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> temp_table <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;test&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 临时表只在当前会话可见</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> temp_table;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话结束后临时表自动删除</span></span><br></pre></td></tr></table></figure>

<p><strong>在从库验证</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 临时表不会复制到从库</span></span><br><span class="line"><span class="comment">-- 这是预期行为</span></span><br></pre></td></tr></table></figure>

<h3 id="3-4-系统变量测试"><a href="#3-4-系统变量测试" class="headerlink" title="3.4 系统变量测试"></a>3.4 系统变量测试</h3><p><strong>在主库执行</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 会话级变量不影响复制</span></span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@my_var</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 某些系统变量变更不会复制</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> max_connections <span class="operator">=</span> <span class="number">200</span>;</span><br></pre></td></tr></table></figure>

<p><strong>在从库验证</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 系统变量需要单独配置</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;max_connections&#x27;</span>;</span><br><span class="line"><span class="comment">-- 可能与主库不同</span></span><br></pre></td></tr></table></figure>

<h2 id="四、复制延迟测试"><a href="#四、复制延迟测试" class="headerlink" title="四、复制延迟测试"></a>四、复制延迟测试</h2><h3 id="4-1-延迟测量"><a href="#4-1-延迟测量" class="headerlink" title="4.1 延迟测量"></a>4.1 延迟测量</h3><p><strong>在主库执行</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">USE test_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 记录时间戳</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> test_table (name, age) <span class="keyword">VALUES</span> (<span class="string">&#x27;延迟测试&#x27;</span>, NOW());</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 记录 binlog 位置</span></span><br><span class="line"><span class="keyword">SHOW</span> MASTER STATUS;</span><br></pre></td></tr></table></figure>

<p><strong>在从库执行</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">USE test_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 等待同步</span></span><br><span class="line"><span class="keyword">SELECT</span> SLEEP(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查数据</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> test_table <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;延迟测试&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 计算延迟</span></span><br><span class="line"><span class="keyword">SHOW</span> SLAVE STATUS\G</span><br><span class="line"><span class="comment">-- 查看 Seconds_Behind_Master</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-延迟模拟测试"><a href="#4-2-延迟模拟测试" class="headerlink" title="4.2 延迟模拟测试"></a>4.2 延迟模拟测试</h3><p><strong>在从库执行</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 模拟慢查询导致延迟</span></span><br><span class="line">USE test_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 停止 SQL 线程</span></span><br><span class="line">STOP SLAVE SQL_THREAD;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在主库插入数据</span></span><br><span class="line"><span class="comment">-- （在另一个会话执行）</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> test_table (name) <span class="keyword">VALUES</span> (<span class="string">&#x27;等待同步的数据&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在从库查看状态</span></span><br><span class="line"><span class="keyword">SHOW</span> SLAVE STATUS\G</span><br><span class="line"><span class="comment">-- Relay_Log_Space 会增加</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 启动 SQL 线程</span></span><br><span class="line"><span class="keyword">START</span> SLAVE SQL_THREAD;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 观察延迟消失</span></span><br></pre></td></tr></table></figure>

<h2 id="五、故障恢复测试"><a href="#五、故障恢复测试" class="headerlink" title="五、故障恢复测试"></a>五、故障恢复测试</h2><h3 id="5-1-主库重启测试"><a href="#5-1-主库重启测试" class="headerlink" title="5.1 主库重启测试"></a>5.1 主库重启测试</h3><p><strong>操作步骤</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 在主库重启 MySQL</span></span><br><span class="line">systemctl restart mysqld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 在从库查看状态</span></span><br><span class="line">SHOW SLAVE STATUS\G</span><br><span class="line"><span class="comment"># Slave_IO_Running 可能暂时变为 Connecting</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 等待主库启动完成</span></span><br><span class="line"><span class="comment"># 从库会自动重连</span></span><br></pre></td></tr></table></figure>

<p><strong>预期结果</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Slave_IO_Running: Yes  -- 自动恢复</span><br><span class="line">Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure>

<h3 id="5-2-从库重启测试"><a href="#5-2-从库重启测试" class="headerlink" title="5.2 从库重启测试"></a>5.2 从库重启测试</h3><p><strong>操作步骤</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 在从库重启 MySQL</span></span><br><span class="line">systemctl restart mysqld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 检查复制状态</span></span><br><span class="line">SHOW SLAVE STATUS\G</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 如果需要，重新启动复制</span></span><br><span class="line">START SLAVE;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-网络中断测试"><a href="#5-3-网络中断测试" class="headerlink" title="5.3 网络中断测试"></a>5.3 网络中断测试</h3><p><strong>操作步骤</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 在从库断开网络（模拟）</span></span><br><span class="line">iptables -A OUTPUT -d 192.168.1.100 -j DROP</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 等待一段时间后恢复</span></span><br><span class="line">iptables -D OUTPUT -d 192.168.1.100 -j DROP</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 检查从库状态</span></span><br><span class="line">SHOW SLAVE STATUS\G</span><br><span class="line"><span class="comment"># 应该自动恢复</span></span><br></pre></td></tr></table></figure>

<h3 id="5-4-复制错误处理"><a href="#5-4-复制错误处理" class="headerlink" title="5.4 复制错误处理"></a>5.4 复制错误处理</h3><p><strong>模拟主键冲突</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 在从库手动插入数据</span></span><br><span class="line">USE test_db;</span><br><span class="line"><span class="keyword">INSERT INTO</span> test_table (id, name, age) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;手动插入&#x27;</span>, <span class="number">99</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在主库更新相同 ID 的数据</span></span><br><span class="line"><span class="keyword">UPDATE</span> test_table <span class="keyword">SET</span> age <span class="operator">=</span> <span class="number">100</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在从库查看状态</span></span><br><span class="line"><span class="keyword">SHOW</span> SLAVE STATUS\G</span><br><span class="line"><span class="comment">-- Last_SQL_Error 会显示冲突</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 解决方案 1：跳过错误</span></span><br><span class="line">STOP SLAVE;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> sql_slave_skip_counter <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">START</span> SLAVE;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 解决方案 2：修复数据</span></span><br><span class="line">STOP SLAVE;</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> test_table <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">START</span> SLAVE;</span><br></pre></td></tr></table></figure>

<h2 id="六、性能测试"><a href="#六、性能测试" class="headerlink" title="六、性能测试"></a>六、性能测试</h2><h3 id="6-1-写入性能对比"><a href="#6-1-写入性能对比" class="headerlink" title="6.1 写入性能对比"></a>6.1 写入性能对比</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用 sysbench 测试主库写入性能</span></span><br><span class="line">sysbench oltp_write_only \</span><br><span class="line">    --mysql-host=192.168.1.100 \</span><br><span class="line">    --mysql-user=root \</span><br><span class="line">    --mysql-password=password \</span><br><span class="line">    --mysql-db=test_db \</span><br><span class="line">    --tables=1 \</span><br><span class="line">    --table-size=10000 \</span><br><span class="line">    run</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对比从库只读性能</span></span><br><span class="line">sysbench oltp_read_only \</span><br><span class="line">    --mysql-host=192.168.1.101 \</span><br><span class="line">    --mysql-user=root \</span><br><span class="line">    --mysql-password=password \</span><br><span class="line">    --mysql-db=test_db \</span><br><span class="line">    --tables=1 \</span><br><span class="line">    --table-size=10000 \</span><br><span class="line">    run</span><br></pre></td></tr></table></figure>

<h3 id="6-2-延迟监控"><a href="#6-2-延迟监控" class="headerlink" title="6.2 延迟监控"></a>6.2 延迟监控</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建监控表</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> monitoring;</span><br><span class="line">USE monitoring;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE TABLE</span> replication_delay (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    check_time DATETIME,</span><br><span class="line">    seconds_behind <span class="type">INT</span>,</span><br><span class="line">    relay_log_space <span class="type">BIGINT</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 定期插入监控数据（使用事件或外部脚本）</span></span><br><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> EVENT IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> check_replication_delay</span><br><span class="line"><span class="keyword">ON</span> SCHEDULE <span class="keyword">EVERY</span> <span class="number">1</span> <span class="keyword">MINUTE</span></span><br><span class="line">DO</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">INSERT INTO</span> replication_delay (check_time, seconds_behind, relay_log_space)</span><br><span class="line">    <span class="keyword">SELECT</span> NOW(), Seconds_Behind_Master, Relay_Log_Space</span><br><span class="line">    <span class="keyword">FROM</span> information_schema.PROCESSLIST</span><br><span class="line">    <span class="keyword">WHERE</span> COMMAND <span class="operator">=</span> <span class="string">&#x27;Connect&#x27;</span></span><br><span class="line">    LIMIT <span class="number">1</span>;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<h2 id="七、测试检查清单"><a href="#七、测试检查清单" class="headerlink" title="七、测试检查清单"></a>七、测试检查清单</h2><h3 id="7-1-功能测试清单"><a href="#7-1-功能测试清单" class="headerlink" title="7.1 功能测试清单"></a>7.1 功能测试清单</h3><ul>
<li><input disabled="" type="checkbox"> DDL 操作同步（CREATE、ALTER、DROP）</li>
<li><input disabled="" type="checkbox"> DML 操作同步（INSERT、UPDATE、DELETE）</li>
<li><input disabled="" type="checkbox"> 事务同步</li>
<li><input disabled="" type="checkbox"> 大批量数据同步</li>
<li><input disabled="" type="checkbox"> 临时表行为（不复制）</li>
<li><input disabled="" type="checkbox"> 系统变量（不复制）</li>
</ul>
<h3 id="7-2-高可用测试清单"><a href="#7-2-高可用测试清单" class="headerlink" title="7.2 高可用测试清单"></a>7.2 高可用测试清单</h3><ul>
<li><input disabled="" type="checkbox"> 主库重启恢复</li>
<li><input disabled="" type="checkbox"> 从库重启恢复</li>
<li><input disabled="" type="checkbox"> 网络中断恢复</li>
<li><input disabled="" type="checkbox"> 复制错误处理</li>
</ul>
<h3 id="7-3-性能测试清单"><a href="#7-3-性能测试清单" class="headerlink" title="7.3 性能测试清单"></a>7.3 性能测试清单</h3><ul>
<li><input disabled="" type="checkbox"> 复制延迟测量</li>
<li><input disabled="" type="checkbox"> 写入性能影响</li>
<li><input disabled="" type="checkbox"> 读取性能提升</li>
<li><input disabled="" type="checkbox"> 长时间运行稳定性</li>
</ul>
<h2 id="八、小结"><a href="#八、小结" class="headerlink" title="八、小结"></a>八、小结</h2><h3 id="测试总结"><a href="#测试总结" class="headerlink" title="测试总结"></a>测试总结</h3><p>通过上述测试，验证了主从复制的以下方面：</p>
<ol>
<li><strong>数据同步</strong>：DDL、DML、事务都能正确同步</li>
<li><strong>复制状态</strong>：IO 线程和 SQL 线程正常运行</li>
<li><strong>故障恢复</strong>：主从重启、网络中断后能自动恢复</li>
<li><strong>性能影响</strong>：复制延迟在可接受范围内</li>
</ol>
<h3 id="常用验证命令"><a href="#常用验证命令" class="headerlink" title="常用验证命令"></a>常用验证命令</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 检查复制状态</span></span><br><span class="line"><span class="keyword">SHOW</span> SLAVE STATUS\G</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查数据一致性</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> table_name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查延迟</span></span><br><span class="line"><span class="keyword">SELECT</span> Seconds_Behind_Master <span class="keyword">FROM</span> information_schema.PROCESSLIST;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查线程</span></span><br><span class="line"><span class="keyword">SHOW</span> PROCESSLIST;</span><br></pre></td></tr></table></figure>

<h3 id="主从复制篇完结"><a href="#主从复制篇完结" class="headerlink" title="主从复制篇完结"></a>主从复制篇完结</h3><p>至此，主从复制篇的 5 篇文章全部完成！</p>
<table>
<thead>
<tr>
<th>节号</th>
<th>主题</th>
<th>核心内容</th>
</tr>
</thead>
<tbody><tr>
<td>02-01</td>
<td>主从复制概述</td>
<td>概念、架构、场景</td>
</tr>
<tr>
<td>02-02</td>
<td>主从复制原理</td>
<td>组件、流程、GTID</td>
</tr>
<tr>
<td>02-03</td>
<td>主库配置</td>
<td>配置文件、用户创建</td>
</tr>
<tr>
<td>02-04</td>
<td>从库配置</td>
<td>配置、数据同步、连接</td>
</tr>
<tr>
<td>02-05</td>
<td>复制测试</td>
<td>验证、故障处理</td>
</tr>
</tbody></table>
<hr>
<p><strong>下一篇</strong>：[MySQL 运维篇 03-01 分库分表介绍](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 03-01 分库分表介绍&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 运维篇 02-01 主从复制概述](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 02-01 主从复制概述&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 运维篇</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>主从复制</tag>
        <tag>复制测试</tag>
        <tag>实战</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 运维篇 02-04 主从复制从库配置</title>
    <url>/2026/02/24/MySQL%20%E8%BF%90%E7%BB%B4%E7%AF%87%2002-04%20%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E4%BB%8E%E5%BA%93%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<h1 id="MySQL-运维篇-02-04-主从复制从库配置"><a href="#MySQL-运维篇-02-04-主从复制从库配置" class="headerlink" title="MySQL 运维篇 02-04 主从复制从库配置"></a>MySQL 运维篇 02-04 主从复制从库配置</h1><p>本文将详细讲解主从复制中从库的配置步骤，包括配置文件修改、数据恢复、复制连接等。</p>
<h2 id="一、配置前准备"><a href="#一、配置前准备" class="headerlink" title="一、配置前准备"></a>一、配置前准备</h2><h3 id="1-1-环境信息"><a href="#1-1-环境信息" class="headerlink" title="1.1 环境信息"></a>1.1 环境信息</h3><table>
<thead>
<tr>
<th>服务器</th>
<th>IP 地址</th>
<th>角色</th>
<th>server_id</th>
</tr>
</thead>
<tbody><tr>
<td>master</td>
<td>192.168.1.100</td>
<td>主库</td>
<td>1</td>
</tr>
<tr>
<td>slave1</td>
<td>192.168.1.101</td>
<td>从库</td>
<td>2</td>
</tr>
</tbody></table>
<h3 id="1-2-主库配置完成确认"><a href="#1-2-主库配置完成确认" class="headerlink" title="1.2 主库配置完成确认"></a>1.2 主库配置完成确认</h3><p>在配置从库前，确保主库已完成：</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> binlog 已开启</li>
<li><input checked="" disabled="" type="checkbox"> server_id 已设置</li>
<li><input checked="" disabled="" type="checkbox"> 复制用户已创建</li>
<li><input checked="" disabled="" type="checkbox"> 防火墙已配置</li>
<li><input checked="" disabled="" type="checkbox"> 已记录 binlog 位置（File 和 Position）</li>
</ul>
<h2 id="二、从库配置文件修改"><a href="#二、从库配置文件修改" class="headerlink" title="二、从库配置文件修改"></a>二、从库配置文件修改</h2><h3 id="2-1-必需配置项"><a href="#2-1-必需配置项" class="headerlink" title="2.1 必需配置项"></a>2.1 必需配置项</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># ===== 复制必需配置 =====</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. server_id（必须唯一，不能与主库和其他从库重复）</span></span><br><span class="line"><span class="attr">server_id</span> = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. relay log 配置</span></span><br><span class="line"><span class="attr">relay_log</span> = /var/log/mysql/mysql-relay-bin.log</span><br><span class="line"><span class="attr">relay_log_index</span> = /var/log/mysql/mysql-relay-bin.index</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 推荐配置 =====</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 只读模式（防止误写入）</span></span><br><span class="line"><span class="attr">read_only</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 记录从库的 binlog（级联复制需要）</span></span><br><span class="line"><span class="attr">log_slave_updates</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 超级用户只读限制</span></span><br><span class="line"><span class="attr">super_read_only</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-可选配置项"><a href="#2-2-可选配置项" class="headerlink" title="2.2 可选配置项"></a>2.2 可选配置项</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># GTID 模式（与主库保持一致）</span></span><br><span class="line"><span class="attr">gtid_mode</span> = <span class="literal">ON</span></span><br><span class="line"><span class="attr">enforce_gtid_consistency</span> = <span class="literal">ON</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 并行复制（MySQL 5.7+）</span></span><br><span class="line"><span class="attr">slave_parallel_workers</span> = <span class="number">4</span></span><br><span class="line"><span class="attr">slave_parallel_type</span> = <span class="string">&#x27;LOGICAL_CLOCK&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制过滤</span></span><br><span class="line"><span class="attr">replicate_do_db</span> = db1</span><br><span class="line"><span class="attr">replicate_ignore_db</span> = test</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制表过滤</span></span><br><span class="line"><span class="attr">replicate_do_table</span> = db1.table1</span><br><span class="line"><span class="attr">replicate_ignore_table</span> = db1.table2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 跳过特定错误</span></span><br><span class="line"><span class="comment"># slave_skip_errors = 1062,1032</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-完整配置示例"><a href="#2-3-完整配置示例" class="headerlink" title="2.3 完整配置示例"></a>2.3 完整配置示例</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># 基本配置</span></span><br><span class="line"><span class="attr">port</span> = <span class="number">3306</span></span><br><span class="line"><span class="attr">basedir</span> = /usr/local/mysql</span><br><span class="line"><span class="attr">datadir</span> = /var/lib/mysql</span><br><span class="line"><span class="attr">socket</span> = /var/lib/mysql/mysql.sock</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制配置</span></span><br><span class="line"><span class="attr">server_id</span> = <span class="number">2</span></span><br><span class="line"><span class="attr">relay_log</span> = /var/log/mysql/mysql-relay-bin.log</span><br><span class="line"><span class="attr">relay_log_index</span> = /var/log/mysql/mysql-relay-bin.index</span><br><span class="line"><span class="attr">read_only</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">super_read_only</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">log_slave_updates</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># GTID 配置（与主库一致）</span></span><br><span class="line"><span class="attr">gtid_mode</span> = <span class="literal">ON</span></span><br><span class="line"><span class="attr">enforce_gtid_consistency</span> = <span class="literal">ON</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 并行复制</span></span><br><span class="line"><span class="attr">slave_parallel_workers</span> = <span class="number">4</span></span><br><span class="line"><span class="attr">slave_parallel_type</span> = <span class="string">&#x27;LOGICAL_CLOCK&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 性能优化</span></span><br><span class="line"><span class="attr">innodb_buffer_pool_size</span> = <span class="number">1</span>G</span><br><span class="line"><span class="attr">innodb_flush_log_at_trx_commit</span> = <span class="number">2</span></span><br></pre></td></tr></table></figure>

<h3 id="2-4-重启-MySQL"><a href="#2-4-重启-MySQL" class="headerlink" title="2.4 重启 MySQL"></a>2.4 重启 MySQL</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Linux (systemd)</span></span><br><span class="line">systemctl restart mysqld</span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux (init.d)</span></span><br><span class="line">service mysql restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># Windows</span></span><br><span class="line">net stop MySQL80</span><br><span class="line">net start MySQL80</span><br></pre></td></tr></table></figure>

<h3 id="2-5-验证配置"><a href="#2-5-验证配置" class="headerlink" title="2.5 验证配置"></a>2.5 验证配置</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 检查 server_id</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;server_id&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查 relay log</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;relay_log&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查只读状态</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;read_only&#x27;</span>;</span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;super_read_only&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查 GTID 模式</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;gtid_mode&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="三、数据同步"><a href="#三、数据同步" class="headerlink" title="三、数据同步"></a>三、数据同步</h2><h3 id="3-1-方法一：mysqldump-恢复"><a href="#3-1-方法一：mysqldump-恢复" class="headerlink" title="3.1 方法一：mysqldump 恢复"></a>3.1 方法一：mysqldump 恢复</h3><p><strong>步骤 1：从主库备份</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在主库执行</span></span><br><span class="line">mysqldump -u root -p \</span><br><span class="line">    --single-transaction \</span><br><span class="line">    --master-data=2 \</span><br><span class="line">    --all-databases \</span><br><span class="line">    &gt; /backup/full_backup.sql</span><br></pre></td></tr></table></figure>

<p><strong>步骤 2：传输备份文件到从库</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用 scp 传输</span></span><br><span class="line">scp /backup/full_backup.sql root@192.168.1.101:/backup/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或使用 rsync</span></span><br><span class="line">rsync -avz /backup/full_backup.sql root@192.168.1.101:/backup/</span><br></pre></td></tr></table></figure>

<p><strong>步骤 3：在从库恢复数据</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在从库执行</span></span><br><span class="line">mysql -u root -p &lt; /backup/full_backup.sql</span><br></pre></td></tr></table></figure>

<h3 id="3-2-方法二：XtraBackup-热备"><a href="#3-2-方法二：XtraBackup-热备" class="headerlink" title="3.2 方法二：XtraBackup 热备"></a>3.2 方法二：XtraBackup 热备</h3><p><strong>步骤 1：在主库备份</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">xtrabackup --backup \</span><br><span class="line">    --target-dir=/backup/full_backup \</span><br><span class="line">    --user=root \</span><br><span class="line">    --password=RootPass</span><br></pre></td></tr></table></figure>

<p><strong>步骤 2：准备备份</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">xtrabackup --prepare \</span><br><span class="line">    --target-dir=/backup/full_backup</span><br></pre></td></tr></table></figure>

<p><strong>步骤 3：传输到从库</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 打包备份</span></span><br><span class="line">tar -czf backup.tar.gz -C /backup full_backup</span><br><span class="line"></span><br><span class="line"><span class="comment"># 传输</span></span><br><span class="line">scp backup.tar.gz root@192.168.1.101:/backup/</span><br></pre></td></tr></table></figure>

<p><strong>步骤 4：在从库恢复</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 解压</span></span><br><span class="line">tar -xzf backup.tar.gz -C /backup/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止 MySQL</span></span><br><span class="line">systemctl stop mysqld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清空数据目录</span></span><br><span class="line"><span class="built_in">rm</span> -rf /var/lib/mysql/*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 恢复数据</span></span><br><span class="line">xtrabackup --copy-back \</span><br><span class="line">    --target-dir=/backup/full_backup</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改权限</span></span><br><span class="line"><span class="built_in">chown</span> -R mysql:mysql /var/lib/mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 MySQL</span></span><br><span class="line">systemctl start mysqld</span><br></pre></td></tr></table></figure>

<h3 id="3-3-方法三：GTID-自动定位（MySQL-5-7-）"><a href="#3-3-方法三：GTID-自动定位（MySQL-5-7-）" class="headerlink" title="3.3 方法三：GTID 自动定位（MySQL 5.7+）"></a>3.3 方法三：GTID 自动定位（MySQL 5.7+）</h3><p>如果主从都启用了 GTID，可以自动定位：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 在从库执行</span></span><br><span class="line">CHANGE MASTER <span class="keyword">TO</span></span><br><span class="line">    MASTER_HOST <span class="operator">=</span> <span class="string">&#x27;192.168.1.100&#x27;</span>,</span><br><span class="line">    MASTER_USER <span class="operator">=</span> <span class="string">&#x27;repl&#x27;</span>,</span><br><span class="line">    MASTER_PASSWORD <span class="operator">=</span> <span class="string">&#x27;Repl@2024Pass&#x27;</span>,</span><br><span class="line">    MASTER_AUTO_POSITION <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">START</span> SLAVE;</span><br></pre></td></tr></table></figure>

<h2 id="四、配置复制连接"><a href="#四、配置复制连接" class="headerlink" title="四、配置复制连接"></a>四、配置复制连接</h2><h3 id="4-1-获取主库-binlog-位置"><a href="#4-1-获取主库-binlog-位置" class="headerlink" title="4.1 获取主库 binlog 位置"></a>4.1 获取主库 binlog 位置</h3><p><strong>在主库执行</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> MASTER STATUS;</span><br></pre></td></tr></table></figure>

<p><strong>记录以下信息</strong>：</p>
<ul>
<li>File: <code>mysql-bin.000001</code></li>
<li>Position: <code>154</code></li>
<li>Executed_Gtid_Set: <code>abc123:1-10</code>（如果使用 GTID）</li>
</ul>
<h3 id="4-2-配置-CHANGE-MASTER-TO"><a href="#4-2-配置-CHANGE-MASTER-TO" class="headerlink" title="4.2 配置 CHANGE MASTER TO"></a>4.2 配置 CHANGE MASTER TO</h3><p><strong>传统方式（基于位置）</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 在从库执行</span></span><br><span class="line">CHANGE MASTER <span class="keyword">TO</span></span><br><span class="line">    MASTER_HOST <span class="operator">=</span> <span class="string">&#x27;192.168.1.100&#x27;</span>,</span><br><span class="line">    MASTER_PORT <span class="operator">=</span> <span class="number">3306</span>,</span><br><span class="line">    MASTER_USER <span class="operator">=</span> <span class="string">&#x27;repl&#x27;</span>,</span><br><span class="line">    MASTER_PASSWORD <span class="operator">=</span> <span class="string">&#x27;Repl@2024Pass&#x27;</span>,</span><br><span class="line">    MASTER_LOG_FILE <span class="operator">=</span> <span class="string">&#x27;mysql-bin.000001&#x27;</span>,</span><br><span class="line">    MASTER_LOG_POS <span class="operator">=</span> <span class="number">154</span>;</span><br></pre></td></tr></table></figure>

<p><strong>GTID 方式（推荐）</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 在从库执行</span></span><br><span class="line">CHANGE MASTER <span class="keyword">TO</span></span><br><span class="line">    MASTER_HOST <span class="operator">=</span> <span class="string">&#x27;192.168.1.100&#x27;</span>,</span><br><span class="line">    MASTER_PORT <span class="operator">=</span> <span class="number">3306</span>,</span><br><span class="line">    MASTER_USER <span class="operator">=</span> <span class="string">&#x27;repl&#x27;</span>,</span><br><span class="line">    MASTER_PASSWORD <span class="operator">=</span> <span class="string">&#x27;Repl@2024Pass&#x27;</span>,</span><br><span class="line">    MASTER_AUTO_POSITION <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-完整参数说明"><a href="#4-3-完整参数说明" class="headerlink" title="4.3 完整参数说明"></a>4.3 完整参数说明</h3><table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>必填</th>
</tr>
</thead>
<tbody><tr>
<td>MASTER_HOST</td>
<td>主库 IP 地址</td>
<td>是</td>
</tr>
<tr>
<td>MASTER_PORT</td>
<td>主库端口</td>
<td>否 (默认 3306)</td>
</tr>
<tr>
<td>MASTER_USER</td>
<td>复制用户名</td>
<td>是</td>
</tr>
<tr>
<td>MASTER_PASSWORD</td>
<td>复制用户密码</td>
<td>是</td>
</tr>
<tr>
<td>MASTER_LOG_FILE</td>
<td>主库 binlog 文件名</td>
<td>否 (GTID 模式不需要)</td>
</tr>
<tr>
<td>MASTER_LOG_POS</td>
<td>主库 binlog 位置</td>
<td>否 (GTID 模式不需要)</td>
</tr>
<tr>
<td>MASTER_AUTO_POSITION</td>
<td>GTID 自动定位</td>
<td>否 (GTID 模式设为 1)</td>
</tr>
<tr>
<td>MASTER_CONNECT_RETRY</td>
<td>连接重试间隔</td>
<td>否 (默认 60 秒)</td>
</tr>
<tr>
<td>MASTER_RETRY_COUNT</td>
<td>重试次数</td>
<td>否 (默认 86400)</td>
</tr>
</tbody></table>
<h3 id="4-4-验证配置"><a href="#4-4-验证配置" class="headerlink" title="4.4 验证配置"></a>4.4 验证配置</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看复制配置</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> mysql.slave_master_info\G</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 或</span></span><br><span class="line"><span class="keyword">SHOW</span> SLAVE STATUS\G</span><br></pre></td></tr></table></figure>

<h2 id="五、启动复制"><a href="#五、启动复制" class="headerlink" title="五、启动复制"></a>五、启动复制</h2><h3 id="5-1-启动复制"><a href="#5-1-启动复制" class="headerlink" title="5.1 启动复制"></a>5.1 启动复制</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 启动复制</span></span><br><span class="line"><span class="keyword">START</span> SLAVE;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 或（MySQL 8.0+）</span></span><br><span class="line"><span class="keyword">START</span> REPLICA;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-检查复制状态"><a href="#5-2-检查复制状态" class="headerlink" title="5.2 检查复制状态"></a>5.2 检查复制状态</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> SLAVE STATUS\G</span><br></pre></td></tr></table></figure>

<p><strong>关键字段检查</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Slave_IO_Running: Yes        -- I/O 线程必须运行</span><br><span class="line">Slave_SQL_Running: Yes       -- SQL 线程必须运行</span><br><span class="line">Seconds_Behind_Master: 0     -- 延迟时间（越小越好）</span><br><span class="line">Last_Error:                  -- 应该为空</span><br><span class="line">Last_IO_Error:               -- 应该为空</span><br><span class="line">Last_SQL_Error:              -- 应该为空</span><br></pre></td></tr></table></figure>

<h3 id="5-3-复制状态详解"><a href="#5-3-复制状态详解" class="headerlink" title="5.3 复制状态详解"></a>5.3 复制状态详解</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> SLAVE STATUS\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master <span class="keyword">to</span> send event</span><br><span class="line">                  Master_Host: <span class="number">192.168</span><span class="number">.1</span><span class="number">.100</span></span><br><span class="line">                  Master_User: repl</span><br><span class="line">                  Master_Port: <span class="number">3306</span></span><br><span class="line">                Connect_Retry: <span class="number">60</span></span><br><span class="line">              Master_Log_File: mysql<span class="operator">-</span>bin<span class="number">.000001</span></span><br><span class="line">          Read_Master_Log_Pos: <span class="number">154</span></span><br><span class="line">               Relay_Log_File: mysql<span class="operator">-</span>relay<span class="operator">-</span>bin<span class="number">.000002</span></span><br><span class="line">                Relay_Log_Pos: <span class="number">320</span></span><br><span class="line">        Relay_Master_Log_File: mysql<span class="operator">-</span>bin<span class="number">.000001</span></span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">             Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: <span class="number">0</span></span><br><span class="line">                   Last_Error:</span><br><span class="line">                 Skip_Counter: <span class="number">0</span></span><br><span class="line">          Exec_Master_Log_Pos: <span class="number">154</span></span><br><span class="line">              Relay_Log_Space: <span class="number">533</span></span><br><span class="line">              Until_Condition: <span class="keyword">None</span></span><br><span class="line">               Until_Log_File:</span><br><span class="line">                Until_Log_Pos: <span class="number">0</span></span><br><span class="line">           Master_SSL_Allowed: <span class="keyword">No</span></span><br><span class="line">           Master_SSL_CA_File:</span><br><span class="line">           Master_SSL_CA_Path:</span><br><span class="line">              Master_SSL_Cert:</span><br><span class="line">            Master_SSL_Cipher:</span><br><span class="line">               Master_SSL_Key:</span><br><span class="line">        Seconds_Behind_Master: <span class="number">0</span></span><br><span class="line">Master_SSL_Verify_Server_Cert: <span class="keyword">No</span></span><br><span class="line">                Last_IO_Errno: <span class="number">0</span></span><br><span class="line">                Last_IO_Error:</span><br><span class="line">               Last_SQL_Errno: <span class="number">0</span></span><br><span class="line">               Last_SQL_Error:</span><br></pre></td></tr></table></figure>

<h2 id="六、复制测试"><a href="#六、复制测试" class="headerlink" title="六、复制测试"></a>六、复制测试</h2><h3 id="6-1-测试数据同步"><a href="#6-1-测试数据同步" class="headerlink" title="6.1 测试数据同步"></a>6.1 测试数据同步</h3><p><strong>在主库执行</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建测试数据库</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE test_replication;</span><br><span class="line">USE test_replication;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建测试表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入测试数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> users (name) <span class="keyword">VALUES</span> (<span class="string">&#x27;张三&#x27;</span>), (<span class="string">&#x27;李四&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看 binlog 位置</span></span><br><span class="line"><span class="keyword">SHOW</span> MASTER STATUS;</span><br></pre></td></tr></table></figure>

<p><strong>在从库验证</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看数据库</span></span><br><span class="line"><span class="keyword">SHOW</span> DATABASES;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看表</span></span><br><span class="line">USE test_replication;</span><br><span class="line"><span class="keyword">SHOW</span> TABLES;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看数据</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查复制状态</span></span><br><span class="line"><span class="keyword">SHOW</span> SLAVE STATUS\G</span><br></pre></td></tr></table></figure>

<h3 id="6-2-测试写操作限制"><a href="#6-2-测试写操作限制" class="headerlink" title="6.2 测试写操作限制"></a>6.2 测试写操作限制</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 在从库尝试写入（应该失败）</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> users (name) <span class="keyword">VALUES</span> (<span class="string">&#x27;王五&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 错误：The MySQL server is running with the --read-only option</span></span><br></pre></td></tr></table></figure>

<h3 id="6-3-测试延迟"><a href="#6-3-测试延迟" class="headerlink" title="6.3 测试延迟"></a>6.3 测试延迟</h3><p><strong>在主库执行</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 记录时间</span></span><br><span class="line"><span class="keyword">SELECT</span> NOW();</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> users (name) <span class="keyword">VALUES</span> (<span class="string">&#x27;测试时间&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>在从库检查</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看数据是否同步</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">ORDER</span> <span class="keyword">BY</span> id <span class="keyword">DESC</span> LIMIT <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看延迟</span></span><br><span class="line"><span class="keyword">SHOW</span> SLAVE STATUS\G</span><br><span class="line"><span class="comment">-- 检查 Seconds_Behind_Master</span></span><br></pre></td></tr></table></figure>

<h2 id="七、故障排查"><a href="#七、故障排查" class="headerlink" title="七、故障排查"></a>七、故障排查</h2><h3 id="7-1-I-O-线程无法启动"><a href="#7-1-I-O-线程无法启动" class="headerlink" title="7.1 I&#x2F;O 线程无法启动"></a>7.1 I&#x2F;O 线程无法启动</h3><p><strong>错误</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Slave_IO_Running: No</span><br><span class="line">Last_IO_Error: error connecting to master</span><br></pre></td></tr></table></figure>

<p><strong>排查步骤</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 检查网络连通性</span></span><br><span class="line">ping 192.168.1.100</span><br><span class="line">telnet 192.168.1.100 3306</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 检查防火墙</span></span><br><span class="line"><span class="comment"># 在主库检查 3306 端口是否开放</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 检查复制用户</span></span><br><span class="line"><span class="comment"># 在主库验证用户权限</span></span><br><span class="line">SHOW GRANTS FOR <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>解决</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 重新配置连接信息</span></span><br><span class="line">STOP SLAVE;</span><br><span class="line">CHANGE MASTER <span class="keyword">TO</span></span><br><span class="line">    MASTER_HOST <span class="operator">=</span> <span class="string">&#x27;192.168.1.100&#x27;</span>,</span><br><span class="line">    MASTER_USER <span class="operator">=</span> <span class="string">&#x27;repl&#x27;</span>,</span><br><span class="line">    MASTER_PASSWORD <span class="operator">=</span> <span class="string">&#x27;Repl@2024Pass&#x27;</span>,</span><br><span class="line">    MASTER_AUTO_POSITION <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">START</span> SLAVE;</span><br></pre></td></tr></table></figure>

<h3 id="7-2-SQL-线程无法启动"><a href="#7-2-SQL-线程无法启动" class="headerlink" title="7.2 SQL 线程无法启动"></a>7.2 SQL 线程无法启动</h3><p><strong>错误</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Slave_SQL_Running: No</span><br><span class="line">Last_SQL_Error: Duplicate entry &#x27;1&#x27; for key &#x27;PRIMARY&#x27;</span><br></pre></td></tr></table></figure>

<p><strong>解决 1：跳过错误（谨慎使用）</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">STOP SLAVE;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> sql_slave_skip_counter <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">START</span> SLAVE;</span><br></pre></td></tr></table></figure>

<p><strong>解决 2：重新同步数据</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 停止复制</span></span><br><span class="line">STOP SLAVE;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 重置复制信息</span></span><br><span class="line">RESET SLAVE;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 重新配置（需要先恢复数据）</span></span><br><span class="line">CHANGE MASTER <span class="keyword">TO</span> ...;</span><br><span class="line"><span class="keyword">START</span> SLAVE;</span><br></pre></td></tr></table></figure>

<h3 id="7-3-复制延迟"><a href="#7-3-复制延迟" class="headerlink" title="7.3 复制延迟"></a>7.3 复制延迟</h3><p><strong>检查</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> SLAVE STATUS\G</span><br><span class="line"><span class="comment">-- 查看 Seconds_Behind_Master</span></span><br></pre></td></tr></table></figure>

<p><strong>解决</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 开启并行复制</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> slave_parallel_workers <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查是否有大事务</span></span><br><span class="line"><span class="keyword">SHOW</span> PROCESSLIST;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 优化从库性能</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> innodb_flush_log_at_trx_commit <span class="operator">=</span> <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<h2 id="八、小结"><a href="#八、小结" class="headerlink" title="八、小结"></a>八、小结</h2><h3 id="从库配置步骤总结"><a href="#从库配置步骤总结" class="headerlink" title="从库配置步骤总结"></a>从库配置步骤总结</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 修改配置文件</span><br><span class="line">   - server_id = 2</span><br><span class="line">   - relay_log = /path/to/relay-bin.log</span><br><span class="line">   - read_only = 1</span><br><span class="line"></span><br><span class="line">2. 重启 MySQL</span><br><span class="line"></span><br><span class="line">3. 恢复主库数据</span><br><span class="line">   - mysqldump 或 XtraBackup</span><br><span class="line"></span><br><span class="line">4. 配置复制连接</span><br><span class="line">   - CHANGE MASTER TO ...</span><br><span class="line"></span><br><span class="line">5. 启动复制</span><br><span class="line">   - START SLAVE</span><br><span class="line"></span><br><span class="line">6. 验证复制状态</span><br><span class="line">   - SHOW SLAVE STATUS</span><br></pre></td></tr></table></figure>

<h3 id="配置验证命令"><a href="#配置验证命令" class="headerlink" title="配置验证命令"></a>配置验证命令</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 检查配置</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;server_id&#x27;</span>;</span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;read_only&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查复制状态</span></span><br><span class="line"><span class="keyword">SHOW</span> SLAVE STATUS\G</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 关键指标</span></span><br><span class="line"><span class="comment">-- Slave_IO_Running: Yes</span></span><br><span class="line"><span class="comment">-- Slave_SQL_Running: Yes</span></span><br><span class="line"><span class="comment">-- Seconds_Behind_Master: 0</span></span><br></pre></td></tr></table></figure>

<h3 id="下一步"><a href="#下一步" class="headerlink" title="下一步"></a>下一步</h3><p>完成从库配置后，进行复制测试：</p>
<ul>
<li>02-05：复制测试</li>
</ul>
<hr>
<p><strong>下一篇</strong>：[MySQL 运维篇 02-05 主从复制测试](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 02-05 主从复制测试&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 运维篇 02-03 主从复制主库配置](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 02-03 主从复制主库配置&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 运维篇</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>主从复制</tag>
        <tag>实战</tag>
        <tag>从库配置</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 运维篇 02-03 主从复制主库配置</title>
    <url>/2026/02/24/MySQL%20%E8%BF%90%E7%BB%B4%E7%AF%87%2002-03%20%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E4%B8%BB%E5%BA%93%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<h1 id="MySQL-运维篇-02-03-主从复制主库配置"><a href="#MySQL-运维篇-02-03-主从复制主库配置" class="headerlink" title="MySQL 运维篇 02-03 主从复制主库配置"></a>MySQL 运维篇 02-03 主从复制主库配置</h1><p>本文将详细讲解主从复制中主库的配置步骤，包括配置文件修改、复制用户创建、权限设置等。</p>
<h2 id="一、配置前准备"><a href="#一、配置前准备" class="headerlink" title="一、配置前准备"></a>一、配置前准备</h2><h3 id="1-1-环境信息"><a href="#1-1-环境信息" class="headerlink" title="1.1 环境信息"></a>1.1 环境信息</h3><table>
<thead>
<tr>
<th>服务器</th>
<th>IP 地址</th>
<th>角色</th>
<th>server_id</th>
</tr>
</thead>
<tbody><tr>
<td>master</td>
<td>192.168.1.100</td>
<td>主库</td>
<td>1</td>
</tr>
<tr>
<td>slave1</td>
<td>192.168.1.101</td>
<td>从库</td>
<td>2</td>
</tr>
<tr>
<td>slave2</td>
<td>192.168.1.102</td>
<td>从库</td>
<td>3</td>
</tr>
</tbody></table>
<h3 id="1-2-MySQL-版本"><a href="#1-2-MySQL-版本" class="headerlink" title="1.2 MySQL 版本"></a>1.2 MySQL 版本</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 检查 MySQL 版本</span></span><br><span class="line">mysql --version</span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例输出</span></span><br><span class="line">mysql  Ver 8.0.32 <span class="keyword">for</span> Linux on x86_64 (MySQL Community Server - GPL)</span><br></pre></td></tr></table></figure>

<h3 id="1-3-配置检查清单"><a href="#1-3-配置检查清单" class="headerlink" title="1.3 配置检查清单"></a>1.3 配置检查清单</h3><ul>
<li><input disabled="" type="checkbox"> 确保主从网络互通</li>
<li><input disabled="" type="checkbox"> 确保 3306 端口开放</li>
<li><input disabled="" type="checkbox"> 准备 replication 用户密码</li>
<li><input disabled="" type="checkbox"> 记录当前数据状态</li>
</ul>
<h2 id="二、主库配置文件修改"><a href="#二、主库配置文件修改" class="headerlink" title="二、主库配置文件修改"></a>二、主库配置文件修改</h2><h3 id="2-1-找到配置文件"><a href="#2-1-找到配置文件" class="headerlink" title="2.1 找到配置文件"></a>2.1 找到配置文件</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Linux</span></span><br><span class="line">/etc/my.cnf</span><br><span class="line">/etc/mysql/my.cnf</span><br><span class="line">/etc/mysql/mysql.conf.d/mysqld.cnf</span><br><span class="line"></span><br><span class="line"><span class="comment"># Windows</span></span><br><span class="line">C:\ProgramData\MySQL\MySQL Server 8.0\my.ini</span><br></pre></td></tr></table></figure>

<h3 id="2-2-必需配置项"><a href="#2-2-必需配置项" class="headerlink" title="2.2 必需配置项"></a>2.2 必需配置项</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># ===== 复制必需配置 =====</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. server_id（必须唯一）</span></span><br><span class="line"><span class="attr">server_id</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 开启 binlog</span></span><br><span class="line"><span class="attr">log_bin</span> = /var/log/mysql/mysql-bin.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. binlog 格式（推荐 ROW）</span></span><br><span class="line"><span class="attr">binlog_format</span> = ROW</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. binlog 校验和</span></span><br><span class="line"><span class="attr">binlog_checksum</span> = CRC32</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 推荐配置 =====</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. binlog 过期时间</span></span><br><span class="line"><span class="attr">binlog_expire_logs_seconds</span> = <span class="number">604800</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. binlog 文件大小</span></span><br><span class="line"><span class="attr">max_binlog_size</span> = <span class="number">100</span>M</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. 同步策略（最安全）</span></span><br><span class="line"><span class="attr">sync_binlog</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 8. binlog 目录</span></span><br><span class="line"><span class="attr">log_bin_basename</span> = /var/log/mysql/mysql-bin</span><br><span class="line"><span class="attr">log_bin_index</span> = /var/log/mysql/mysql-bin.index</span><br></pre></td></tr></table></figure>

<h3 id="2-3-可选配置项"><a href="#2-3-可选配置项" class="headerlink" title="2.3 可选配置项"></a>2.3 可选配置项</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># GTID 模式（MySQL 5.7+ 推荐）</span></span><br><span class="line"><span class="attr">gtid_mode</span> = <span class="literal">ON</span></span><br><span class="line"><span class="attr">enforce_gtid_consistency</span> = <span class="literal">ON</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 半同步复制（MySQL 5.5+）</span></span><br><span class="line"><span class="comment"># rpl_semi_sync_master_enabled = ON</span></span><br><span class="line"><span class="comment"># rpl_semi_sync_master_timeout = 10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制过滤（可选）</span></span><br><span class="line"><span class="comment"># binlog_do_db = db1</span></span><br><span class="line"><span class="comment"># binlog_ignore_db = test</span></span><br></pre></td></tr></table></figure>

<h3 id="2-4-完整配置示例"><a href="#2-4-完整配置示例" class="headerlink" title="2.4 完整配置示例"></a>2.4 完整配置示例</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># 基本配置</span></span><br><span class="line"><span class="attr">port</span> = <span class="number">3306</span></span><br><span class="line"><span class="attr">basedir</span> = /usr/local/mysql</span><br><span class="line"><span class="attr">datadir</span> = /var/lib/mysql</span><br><span class="line"><span class="attr">socket</span> = /var/lib/mysql/mysql.sock</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制配置</span></span><br><span class="line"><span class="attr">server_id</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">log_bin</span> = /var/log/mysql/mysql-bin.log</span><br><span class="line"><span class="attr">binlog_format</span> = ROW</span><br><span class="line"><span class="attr">binlog_checksum</span> = CRC32</span><br><span class="line"><span class="attr">sync_binlog</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">binlog_expire_logs_seconds</span> = <span class="number">604800</span></span><br><span class="line"><span class="attr">max_binlog_size</span> = <span class="number">100</span>M</span><br><span class="line"></span><br><span class="line"><span class="comment"># GTID 配置（推荐）</span></span><br><span class="line"><span class="attr">gtid_mode</span> = <span class="literal">ON</span></span><br><span class="line"><span class="attr">enforce_gtid_consistency</span> = <span class="literal">ON</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 性能优化</span></span><br><span class="line"><span class="attr">innodb_flush_log_at_trx_commit</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">innodb_buffer_pool_size</span> = <span class="number">1</span>G</span><br></pre></td></tr></table></figure>

<h3 id="2-5-重启-MySQL"><a href="#2-5-重启-MySQL" class="headerlink" title="2.5 重启 MySQL"></a>2.5 重启 MySQL</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Linux (systemd)</span></span><br><span class="line">systemctl restart mysqld</span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux (init.d)</span></span><br><span class="line">service mysql restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># Windows</span></span><br><span class="line">net stop MySQL80</span><br><span class="line">net start MySQL80</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或使用</span></span><br><span class="line">mysql.server restart</span><br></pre></td></tr></table></figure>

<h3 id="2-6-验证配置"><a href="#2-6-验证配置" class="headerlink" title="2.6 验证配置"></a>2.6 验证配置</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 检查 server_id</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;server_id&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查 binlog 状态</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;log_bin&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查 binlog 格式</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;binlog_format&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查 GTID 模式</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;gtid_mode&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看 binlog 文件列表</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="type">BINARY</span> LOGS;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看主库状态</span></span><br><span class="line"><span class="keyword">SHOW</span> MASTER STATUS;</span><br></pre></td></tr></table></figure>

<p><strong>输出示例</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> MASTER STATUS;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>      <span class="number">154</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span> abc123:<span class="number">1</span><span class="number">-10</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br></pre></td></tr></table></figure>

<h2 id="三、创建复制用户"><a href="#三、创建复制用户" class="headerlink" title="三、创建复制用户"></a>三、创建复制用户</h2><h3 id="3-1-创建-REPLICATION-用户"><a href="#3-1-创建-REPLICATION-用户" class="headerlink" title="3.1 创建 REPLICATION 用户"></a>3.1 创建 REPLICATION 用户</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- MySQL 8.0+</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;Repl@2024Pass&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 授予复制权限</span></span><br><span class="line"><span class="keyword">GRANT</span> REPLICATION SLAVE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 刷新权限</span></span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>

<p><strong>权限说明</strong>：</p>
<ul>
<li><code>REPLICATION SLAVE</code>：从库连接主库获取 binlog 所需权限</li>
<li><code>REPLICATION CLIENT</code>：查看主从状态所需权限（可选）</li>
</ul>
<h3 id="3-2-添加额外权限（可选）"><a href="#3-2-添加额外权限（可选）" class="headerlink" title="3.2 添加额外权限（可选）"></a>3.2 添加额外权限（可选）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 如果从库需要查看主库状态</span></span><br><span class="line"><span class="keyword">GRANT</span> REPLICATION CLIENT <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 如果需要在从库查看主库 binlog</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> mysql.binlog <span class="keyword">ON</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-验证用户"><a href="#3-3-验证用户" class="headerlink" title="3.3 验证用户"></a>3.3 验证用户</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看用户</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">User</span>, Host <span class="keyword">FROM</span> mysql.user <span class="keyword">WHERE</span> <span class="keyword">User</span> <span class="operator">=</span> <span class="string">&#x27;repl&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看权限</span></span><br><span class="line"><span class="keyword">SHOW</span> GRANTS <span class="keyword">FOR</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>输出示例</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> GRANTS <span class="keyword">FOR</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Grants <span class="keyword">for</span> repl@<span class="operator">%</span>                                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">GRANT</span> USAGE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> `repl`@`<span class="operator">%</span>`                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">GRANT</span> REPLICATION SLAVE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> `repl`@`<span class="operator">%</span>`        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------------------------------+</span></span><br></pre></td></tr></table></figure>

<h3 id="3-4-限制复制用户（安全加固）"><a href="#3-4-限制复制用户（安全加固）" class="headerlink" title="3.4 限制复制用户（安全加固）"></a>3.4 限制复制用户（安全加固）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 删除旧用户</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">USER</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建限定 IP 的用户</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;192.168.1.%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;Repl@2024Pass&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> REPLICATION SLAVE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;192.168.1.%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 或者只允许特定从库 IP</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;192.168.1.101&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;Repl@2024Pass&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> REPLICATION SLAVE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;192.168.1.101&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="四、网络配置"><a href="#四、网络配置" class="headerlink" title="四、网络配置"></a>四、网络配置</h2><h3 id="4-1-防火墙配置"><a href="#4-1-防火墙配置" class="headerlink" title="4.1 防火墙配置"></a>4.1 防火墙配置</h3><p><strong>Linux (firewalld)</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 开放 MySQL 端口</span></span><br><span class="line">firewall-cmd --permanent --add-port=3306/tcp</span><br><span class="line">firewall-cmd --reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证</span></span><br><span class="line">firewall-cmd --list-ports</span><br></pre></td></tr></table></figure>

<p><strong>Linux (ufw)</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 开放端口</span></span><br><span class="line">ufw allow 3306/tcp</span><br><span class="line">ufw reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证</span></span><br><span class="line">ufw status</span><br></pre></td></tr></table></figure>

<p><strong>Linux (iptables)</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 添加规则</span></span><br><span class="line">iptables -A INPUT -p tcp --dport 3306 -j ACCEPT</span><br><span class="line">service iptables save</span><br></pre></td></tr></table></figure>

<p><strong>Windows 防火墙</strong>：</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># PowerShell 开放端口</span></span><br><span class="line"><span class="built_in">New-NetFirewallRule</span> <span class="literal">-DisplayName</span> <span class="string">&quot;MySQL&quot;</span> <span class="literal">-Direction</span> Inbound <span class="literal">-Protocol</span> TCP <span class="literal">-LocalPort</span> <span class="number">3306</span> <span class="literal">-Action</span> Allow</span><br></pre></td></tr></table></figure>

<h3 id="4-2-网络连通性测试"><a href="#4-2-网络连通性测试" class="headerlink" title="4.2 网络连通性测试"></a>4.2 网络连通性测试</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 从从库测试 ping</span></span><br><span class="line">ping 192.168.1.100</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试端口连通性</span></span><br><span class="line">telnet 192.168.1.100 3306</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或使用 nc</span></span><br><span class="line">nc -zv 192.168.1.100 3306</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或使用 mysql 命令</span></span><br><span class="line">mysql -h 192.168.1.100 -u repl -p</span><br></pre></td></tr></table></figure>

<h2 id="五、数据同步准备"><a href="#五、数据同步准备" class="headerlink" title="五、数据同步准备"></a>五、数据同步准备</h2><h3 id="5-1-全量备份主库"><a href="#5-1-全量备份主库" class="headerlink" title="5.1 全量备份主库"></a>5.1 全量备份主库</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用 mysqldump 备份（推荐）</span></span><br><span class="line">mysqldump -u root -p \</span><br><span class="line">    --single-transaction \</span><br><span class="line">    --master-data=2 \</span><br><span class="line">    --all-databases \</span><br><span class="line">    &gt; /backup/full_backup.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># --master-data=2 会在备份文件中记录 binlog 位置（注释形式）</span></span><br><span class="line"><span class="comment"># --master-data=1 会以 CHANGE MASTER 命令形式记录</span></span><br></pre></td></tr></table></figure>

<p><strong>备份文件示例</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- Position: 154</span></span><br><span class="line"><span class="comment">-- CHANGE MASTER TO MASTER_LOG_FILE=&#x27;mysql-bin.000001&#x27;, MASTER_LOG_POS=154;</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-记录-binlog-位置"><a href="#5-2-记录-binlog-位置" class="headerlink" title="5.2 记录 binlog 位置"></a>5.2 记录 binlog 位置</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 方法 1：SHOW MASTER STATUS</span></span><br><span class="line"><span class="keyword">SHOW</span> MASTER STATUS;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 记录 File 和 Position 字段</span></span><br><span class="line"><span class="comment">-- File: mysql-bin.000001</span></span><br><span class="line"><span class="comment">-- Position: 154</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-使用-XtraBackup-热备（可选）"><a href="#5-3-使用-XtraBackup-热备（可选）" class="headerlink" title="5.3 使用 XtraBackup 热备（可选）"></a>5.3 使用 XtraBackup 热备（可选）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装 Percona XtraBackup</span></span><br><span class="line"><span class="comment"># Ubuntu/Debian</span></span><br><span class="line">apt-get install percona-xtrabackup-80</span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS/RHEL</span></span><br><span class="line">yum install percona-xtrabackup-80</span><br><span class="line"></span><br><span class="line"><span class="comment"># 全量备份</span></span><br><span class="line">xtrabackup --backup \</span><br><span class="line">    --target-dir=/backup/full_backup \</span><br><span class="line">    --user=root \</span><br><span class="line">    --password=RootPass</span><br><span class="line"></span><br><span class="line"><span class="comment"># 准备备份</span></span><br><span class="line">xtrabackup --prepare \</span><br><span class="line">    --target-dir=/backup/full_backup</span><br></pre></td></tr></table></figure>

<h2 id="六、配置验证"><a href="#六、配置验证" class="headerlink" title="六、配置验证"></a>六、配置验证</h2><h3 id="6-1-配置文件验证"><a href="#6-1-配置文件验证" class="headerlink" title="6.1 配置文件验证"></a>6.1 配置文件验证</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 检查配置是否生效</span></span><br><span class="line">mysqld --verbose --<span class="built_in">help</span> | grep -E <span class="string">&quot;server_id|log_bin|binlog_format&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 或查看运行配置</span></span><br><span class="line">mysql -u root -p -e <span class="string">&quot;SHOW VARIABLES LIKE &#x27;server_id&#x27;;&quot;</span></span><br><span class="line">mysql -u root -p -e <span class="string">&quot;SHOW VARIABLES LIKE &#x27;log_bin&#x27;;&quot;</span></span><br><span class="line">mysql -u root -p -e <span class="string">&quot;SHOW VARIABLES LIKE &#x27;binlog_format&#x27;;&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-复制用户验证"><a href="#6-2-复制用户验证" class="headerlink" title="6.2 复制用户验证"></a>6.2 复制用户验证</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 从从库测试连接</span></span><br><span class="line">mysql -h 192.168.1.100 -u repl -pRepl@2024Pass -e <span class="string">&quot;SHOW MASTER STATUS;&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="6-3-主库状态检查清单"><a href="#6-3-主库状态检查清单" class="headerlink" title="6.3 主库状态检查清单"></a>6.3 主库状态检查清单</h3><ul>
<li><input disabled="" type="checkbox"> server_id 已设置且唯一</li>
<li><input disabled="" type="checkbox"> binlog 已开启</li>
<li><input disabled="" type="checkbox"> binlog_format &#x3D; ROW</li>
<li><input disabled="" type="checkbox"> 复制用户已创建</li>
<li><input disabled="" type="checkbox"> 防火墙已配置</li>
<li><input disabled="" type="checkbox"> 网络连通</li>
<li><input disabled="" type="checkbox"> 已记录 binlog 位置</li>
</ul>
<h2 id="七、故障排查"><a href="#七、故障排查" class="headerlink" title="七、故障排查"></a>七、故障排查</h2><h3 id="7-1-binlog-未开启"><a href="#7-1-binlog-未开启" class="headerlink" title="7.1 binlog 未开启"></a>7.1 binlog 未开启</h3><p><strong>问题</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;log_bin&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> log_bin       <span class="operator">|</span> OFF   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br></pre></td></tr></table></figure>

<p><strong>解决</strong>：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 检查配置文件</span></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">log_bin</span> = /var/log/mysql/mysql-bin.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查目录权限</span></span><br><span class="line">chown mysql:mysql /var/log/mysql/</span><br><span class="line">chmod 750 /var/log/mysql/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启 MySQL</span></span><br><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure>

<h3 id="7-2-server-id-冲突"><a href="#7-2-server-id-冲突" class="headerlink" title="7.2 server_id 冲突"></a>7.2 server_id 冲突</h3><p><strong>问题</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">错误：多个 MySQL 实例使用相同的 server_id</span><br></pre></td></tr></table></figure>

<p><strong>解决</strong>：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 确保每个实例 server_id 唯一</span></span><br><span class="line"><span class="comment"># 主库：server_id = 1</span></span><br><span class="line"><span class="comment"># 从库 1: server_id = 2</span></span><br><span class="line"><span class="comment"># 从库 2: server_id = 3</span></span><br></pre></td></tr></table></figure>

<h3 id="7-3-复制用户无法连接"><a href="#7-3-复制用户无法连接" class="headerlink" title="7.3 复制用户无法连接"></a>7.3 复制用户无法连接</h3><p><strong>问题</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ERROR 1045 (28000): Access denied for user &#x27;repl&#x27;@&#x27;192.168.1.101&#x27;</span><br></pre></td></tr></table></figure>

<p><strong>解决</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 检查用户是否存在</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">User</span>, Host <span class="keyword">FROM</span> mysql.user <span class="keyword">WHERE</span> <span class="keyword">User</span> <span class="operator">=</span> <span class="string">&#x27;repl&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查权限</span></span><br><span class="line"><span class="keyword">SHOW</span> GRANTS <span class="keyword">FOR</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 重新创建用户</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">USER</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;Repl@2024Pass&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> REPLICATION SLAVE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>

<h2 id="八、小结"><a href="#八、小结" class="headerlink" title="八、小结"></a>八、小结</h2><h3 id="主库配置步骤总结"><a href="#主库配置步骤总结" class="headerlink" title="主库配置步骤总结"></a>主库配置步骤总结</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 修改配置文件</span><br><span class="line">   - server_id = 1</span><br><span class="line">   - log_bin = /path/to/mysql-bin.log</span><br><span class="line">   - binlog_format = ROW</span><br><span class="line"></span><br><span class="line">2. 重启 MySQL</span><br><span class="line"></span><br><span class="line">3. 创建复制用户</span><br><span class="line">   - CREATE USER &#x27;repl&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;password&#x27;</span><br><span class="line">   - GRANT REPLICATION SLAVE ON *.*</span><br><span class="line"></span><br><span class="line">4. 配置防火墙</span><br><span class="line">   - 开放 3306 端口</span><br><span class="line"></span><br><span class="line">5. 记录 binlog 位置</span><br><span class="line">   - SHOW MASTER STATUS</span><br></pre></td></tr></table></figure>

<h3 id="配置验证命令"><a href="#配置验证命令" class="headerlink" title="配置验证命令"></a>配置验证命令</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 检查 server_id</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;server_id&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查 binlog</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;log_bin&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看主库状态</span></span><br><span class="line"><span class="keyword">SHOW</span> MASTER STATUS;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看复制用户</span></span><br><span class="line"><span class="keyword">SHOW</span> GRANTS <span class="keyword">FOR</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="下一步"><a href="#下一步" class="headerlink" title="下一步"></a>下一步</h3><p>完成主库配置后，继续配置从库：</p>
<ul>
<li>02-04：从库配置</li>
<li>02-05：复制测试</li>
</ul>
<hr>
<p><strong>下一篇</strong>：[MySQL 运维篇 02-04 主从复制从库配置](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 02-04 主从复制从库配置&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 运维篇 02-02 主从复制原理](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 02-02 主从复制原理&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 运维篇</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>主从复制</tag>
        <tag>实战</tag>
        <tag>主库配置</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 运维篇 03-01 分库分表介绍</title>
    <url>/2026/02/24/MySQL%20%E8%BF%90%E7%BB%B4%E7%AF%87%2003-01%20%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E4%BB%8B%E7%BB%8D/</url>
    <content><![CDATA[<h1 id="MySQL-运维篇-03-01-分库分表介绍"><a href="#MySQL-运维篇-03-01-分库分表介绍" class="headerlink" title="MySQL 运维篇 03-01 分库分表介绍"></a>MySQL 运维篇 03-01 分库分表介绍</h1><p>当单表数据量过大时，数据库性能会显著下降。分库分表是解决大数据量存储和查询的有效方案。本文将介绍分库分表的概念、场景和常见方案。</p>
<h2 id="一、为什么需要分库分表"><a href="#一、为什么需要分库分表" class="headerlink" title="一、为什么需要分库分表"></a>一、为什么需要分库分表</h2><h3 id="1-1-单表数据量限制"><a href="#1-1-单表数据量限制" class="headerlink" title="1.1 单表数据量限制"></a>1.1 单表数据量限制</h3><p><strong>经验法则</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">单表数据量建议：</span><br><span class="line">├── 100 万以内：性能良好</span><br><span class="line">├── 100 万 -500 万：需要优化</span><br><span class="line">├── 500 万 -1000 万：需要考虑分表</span><br><span class="line">└── 1000 万以上：必须分表</span><br></pre></td></tr></table></figure>

<p><strong>性能瓶颈</strong>：</p>
<table>
<thead>
<tr>
<th>数据量</th>
<th>查询性能</th>
<th>索引大小</th>
<th>维护成本</th>
</tr>
</thead>
<tbody><tr>
<td>100 万</td>
<td>&lt; 100ms</td>
<td>较小</td>
<td>低</td>
</tr>
<tr>
<td>500 万</td>
<td>100-500ms</td>
<td>中等</td>
<td>中</td>
</tr>
<tr>
<td>1000 万</td>
<td>&gt; 500ms</td>
<td>较大</td>
<td>高</td>
</tr>
<tr>
<td>1 亿+</td>
<td>&gt; 1s</td>
<td>很大</td>
<td>很高</td>
</tr>
</tbody></table>
<h3 id="1-2-常见问题"><a href="#1-2-常见问题" class="headerlink" title="1.2 常见问题"></a>1.2 常见问题</h3><p><strong>存储问题</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">- 单表数据占用过多磁盘空间</span><br><span class="line">- 索引文件过大</span><br><span class="line">- binlog 增长过快</span><br></pre></td></tr></table></figure>

<p><strong>性能问题</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">- 查询响应时间变长</span><br><span class="line">- 索引效率下降</span><br><span class="line">- 锁竞争加剧</span><br><span class="line">- 缓冲池命中率降低</span><br></pre></td></tr></table></figure>

<p><strong>维护问题</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">- DDL 操作耗时过长</span><br><span class="line">- 备份恢复困难</span><br><span class="line">- 数据清理影响性能</span><br></pre></td></tr></table></figure>

<h2 id="二、分库分表概念"><a href="#二、分库分表概念" class="headerlink" title="二、分库分表概念"></a>二、分库分表概念</h2><h3 id="2-1-基本概念"><a href="#2-1-基本概念" class="headerlink" title="2.1 基本概念"></a>2.1 基本概念</h3><p><strong>分库分表（Sharding）</strong>：<br>将一个大表的数据分散到多个数据库或多个表中，以降低单表数据量，提高查询性能。</p>
<h3 id="2-2-分库-vs-分表"><a href="#2-2-分库-vs-分表" class="headerlink" title="2.2 分库 vs 分表"></a>2.2 分库 vs 分表</h3><table>
<thead>
<tr>
<th>方式</th>
<th>说明</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td>分表</td>
<td>同一数据库内拆分表</td>
<td>单表数据量大</td>
</tr>
<tr>
<td>分库</td>
<td>不同数据库实例拆分</td>
<td>单库容量&#x2F;性能不足</td>
</tr>
<tr>
<td>分库分表</td>
<td>同时使用两种方式</td>
<td>超大规模数据</td>
</tr>
</tbody></table>
<h3 id="2-3-拆分示意图"><a href="#2-3-拆分示意图" class="headerlink" title="2.3 拆分示意图"></a>2.3 拆分示意图</h3><p><strong>分表</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">原始表：</span><br><span class="line">orders (1 亿条数据)</span><br><span class="line"></span><br><span class="line">分表后：</span><br><span class="line">orders_0000 (100 万条)</span><br><span class="line">orders_0001 (100 万条)</span><br><span class="line">...</span><br><span class="line">orders_0099 (100 万条)</span><br></pre></td></tr></table></figure>

<p><strong>分库</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">原始库：</span><br><span class="line">DB_Master (100 个表，1 亿条数据)</span><br><span class="line"></span><br><span class="line">分库后：</span><br><span class="line">DB_0 (10 个表，1000 万条)</span><br><span class="line">DB_1 (10 个表，1000 万条)</span><br><span class="line">...</span><br><span class="line">DB_9 (10 个表，1000 万条)</span><br></pre></td></tr></table></figure>

<h2 id="三、拆分方式"><a href="#三、拆分方式" class="headerlink" title="三、拆分方式"></a>三、拆分方式</h2><h3 id="3-1-垂直拆分"><a href="#3-1-垂直拆分" class="headerlink" title="3.1 垂直拆分"></a>3.1 垂直拆分</h3><p><strong>定义</strong>：按列拆分，将大字段或访问频率低的字段拆分到独立表中。</p>
<p><strong>示意图</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">原始表：</span><br><span class="line">user (id, name, email, phone, address, description, created_at)</span><br><span class="line"></span><br><span class="line">垂直拆分后：</span><br><span class="line">user_base (id, name, email, phone, created_at)     -- 常用字段</span><br><span class="line">user_detail (id, address, description)              -- 大字段</span><br></pre></td></tr></table></figure>

<p><strong>优点</strong>：</p>
<ul>
<li>减少主表数据量</li>
<li>提高缓存命中率</li>
<li>减少 IO 消耗</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>需要 JOIN 查询</li>
<li>增加复杂度</li>
</ul>
<p><strong>适用场景</strong>：</p>
<ul>
<li>表中有 TEXT、BLOB 等大字段</li>
<li>字段访问频率差异大</li>
</ul>
<h3 id="3-2-水平拆分"><a href="#3-2-水平拆分" class="headerlink" title="3.2 水平拆分"></a>3.2 水平拆分</h3><p><strong>定义</strong>：按行拆分，根据某个字段的值将数据分布到不同表中。</p>
<p><strong>示意图</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">原始表：</span><br><span class="line">orders (1 亿条数据)</span><br><span class="line"></span><br><span class="line">水平拆分后（按 user_id 取模）：</span><br><span class="line">orders_0000 (user_id % 100 = 0)</span><br><span class="line">orders_0001 (user_id % 100 = 1)</span><br><span class="line">...</span><br><span class="line">orders_0099 (user_id % 100 = 99)</span><br></pre></td></tr></table></figure>

<p><strong>优点</strong>：</p>
<ul>
<li>单表数据量小</li>
<li>查询效率高</li>
<li>扩展性好</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>跨分片查询复杂</li>
<li>数据分布可能不均</li>
</ul>
<p><strong>适用场景</strong>：</p>
<ul>
<li>单表数据量过大</li>
<li>有明显的分片键</li>
</ul>
<h2 id="四、分片策略"><a href="#四、分片策略" class="headerlink" title="四、分片策略"></a>四、分片策略</h2><h3 id="4-1-取模分片"><a href="#4-1-取模分片" class="headerlink" title="4.1 取模分片"></a>4.1 取模分片</h3><p><strong>公式</strong>：<code>table_index = sharding_key % table_count</code></p>
<p><strong>示例</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 按 user_id 分 100 个表</span></span><br><span class="line">user_id <span class="operator">=</span> <span class="number">12345</span></span><br><span class="line">table_index <span class="operator">=</span> <span class="number">12345</span> <span class="operator">%</span> <span class="number">100</span> <span class="operator">=</span> <span class="number">45</span></span><br><span class="line"><span class="comment">-- 数据存储在 orders_0045</span></span><br></pre></td></tr></table></figure>

<p><strong>优点</strong>：</p>
<ul>
<li>数据分布均匀</li>
<li>算法简单</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>扩容困难（需要 rehash）</li>
<li>范围查询效率低</li>
</ul>
<h3 id="4-2-范围分片"><a href="#4-2-范围分片" class="headerlink" title="4.2 范围分片"></a>4.2 范围分片</h3><p><strong>公式</strong>：<code>根据 sharding_key 的范围划分</code></p>
<p><strong>示例</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 按日期范围分表</span></span><br><span class="line">orders_202401 (<span class="number">2024</span> 年 <span class="number">1</span> 月数据)</span><br><span class="line">orders_202402 (<span class="number">2024</span> 年 <span class="number">2</span> 月数据)</span><br><span class="line">...</span><br><span class="line">orders_202412 (<span class="number">2024</span> 年 <span class="number">12</span> 月数据)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 或按 ID 范围</span></span><br><span class="line">orders_0000 (id: <span class="number">1</span><span class="number">-1000000</span>)</span><br><span class="line">orders_0001 (id: <span class="number">1000001</span><span class="number">-2000000</span>)</span><br></pre></td></tr></table></figure>

<p><strong>优点</strong>：</p>
<ul>
<li>扩容相对容易</li>
<li>范围查询效率高</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>数据可能分布不均</li>
<li>热点数据集中</li>
</ul>
<h3 id="4-3-哈希分片"><a href="#4-3-哈希分片" class="headerlink" title="4.3 哈希分片"></a>4.3 哈希分片</h3><p><strong>公式</strong>：<code>table_index = hash(sharding_key) % table_count</code></p>
<p><strong>示例</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 使用 MD5 哈希</span></span><br><span class="line">user_id <span class="operator">=</span> <span class="string">&#x27;abc123&#x27;</span></span><br><span class="line">hash_value <span class="operator">=</span> MD5(user_id)</span><br><span class="line">table_index <span class="operator">=</span> hash_value <span class="operator">%</span> <span class="number">100</span></span><br></pre></td></tr></table></figure>

<p><strong>优点</strong>：</p>
<ul>
<li>数据分布更均匀</li>
<li>减少热点</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>扩容需要 rehash</li>
<li>范围查询无效</li>
</ul>
<h3 id="4-4-地理分片"><a href="#4-4-地理分片" class="headerlink" title="4.4 地理分片"></a>4.4 地理分片</h3><p><strong>公式</strong>：<code>按地理位置/区域划分</code></p>
<p><strong>示例</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 按省份分库</span></span><br><span class="line">orders_beijing (北京用户)</span><br><span class="line">orders_shanghai (上海用户)</span><br><span class="line">orders_guangdong (广东用户)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 或按国家分库</span></span><br><span class="line">orders_us (美国用户)</span><br><span class="line">orders_cn (中国用户)</span><br><span class="line">orders_eu (欧洲用户)</span><br></pre></td></tr></table></figure>

<p><strong>优点</strong>：</p>
<ul>
<li>就近访问</li>
<li>符合数据合规要求</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>跨区域查询复杂</li>
<li>数据分布可能不均</li>
</ul>
<h3 id="4-5-一致性哈希"><a href="#4-5-一致性哈希" class="headerlink" title="4.5 一致性哈希"></a>4.5 一致性哈希</h3><p><strong>原理</strong>：将数据和节点映射到哈希环上，减少扩容时的数据迁移。</p>
<p><strong>优点</strong>：</p>
<ul>
<li>扩容时数据迁移少</li>
<li>节点增减影响小</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>实现复杂</li>
<li>可能有数据倾斜</li>
</ul>
<h2 id="五、分片键选择"><a href="#五、分片键选择" class="headerlink" title="五、分片键选择"></a>五、分片键选择</h2><h3 id="5-1-常见分片键"><a href="#5-1-常见分片键" class="headerlink" title="5.1 常见分片键"></a>5.1 常见分片键</h3><table>
<thead>
<tr>
<th>分片键</th>
<th>适用场景</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td>user_id</td>
<td>用户订单</td>
<td>查询集中</td>
<td>热点用户</td>
</tr>
<tr>
<td>order_id</td>
<td>订单查询</td>
<td>分布均匀</td>
<td>范围查询少</td>
</tr>
<tr>
<td>日期</td>
<td>日志数据</td>
<td>自然过期</td>
<td>热点问题</td>
</tr>
<tr>
<td>地区</td>
<td>本地化服务</td>
<td>就近访问</td>
<td>分布不均</td>
</tr>
</tbody></table>
<h3 id="5-2-选择原则"><a href="#5-2-选择原则" class="headerlink" title="5.2 选择原则"></a>5.2 选择原则</h3><ol>
<li><strong>高频查询字段</strong>：WHERE 条件常用字段</li>
<li><strong>数据分布均匀</strong>：避免数据倾斜</li>
<li><strong>业务相关性</strong>：同一业务数据在同一分片</li>
<li><strong>扩展性</strong>：便于未来扩容</li>
</ol>
<h3 id="5-3-避免的分片键"><a href="#5-3-避免的分片键" class="headerlink" title="5.3 避免的分片键"></a>5.3 避免的分片键</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">❌ 自增 ID：导致写入热点</span><br><span class="line">❌ 状态字段：数据分布极不均匀</span><br><span class="line">❌ 时间字段（单独使用）：导致写入集中</span><br></pre></td></tr></table></figure>

<h2 id="六、分库分表带来的问题"><a href="#六、分库分表带来的问题" class="headerlink" title="六、分库分表带来的问题"></a>六、分库分表带来的问题</h2><h3 id="6-1-事务问题"><a href="#6-1-事务问题" class="headerlink" title="6.1 事务问题"></a>6.1 事务问题</h3><p><strong>问题</strong>：跨分片事务难以保证 ACID 特性。</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>避免跨分片事务</li>
<li>使用分布式事务方案（XA、TCC、Saga）</li>
<li>最终一致性</li>
</ul>
<h3 id="6-2-JOIN-问题"><a href="#6-2-JOIN-问题" class="headerlink" title="6.2 JOIN 问题"></a>6.2 JOIN 问题</h3><p><strong>问题</strong>：跨分片 JOIN 性能极差。</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>应用层组装</li>
<li>数据冗余</li>
<li>绑定表（同一分片规则）</li>
<li>全局表（小表广播）</li>
</ul>
<h3 id="6-3-排序分页问题"><a href="#6-3-排序分页问题" class="headerlink" title="6.3 排序分页问题"></a>6.3 排序分页问题</h3><p><strong>问题</strong>：跨分片 ORDER BY 和 LIMIT 复杂。</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>各分片排序后合并</li>
<li>限制最大页码</li>
<li>使用游标式分页</li>
</ul>
<h3 id="6-4-分布式-ID-问题"><a href="#6-4-分布式-ID-问题" class="headerlink" title="6.4 分布式 ID 问题"></a>6.4 分布式 ID 问题</h3><p><strong>问题</strong>：需要全局唯一 ID。</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>Snowflake 算法</li>
<li>UUID（不推荐作为主键）</li>
<li>号段模式</li>
<li>Redis 生成</li>
</ul>
<h3 id="6-5-数据迁移问题"><a href="#6-5-数据迁移问题" class="headerlink" title="6.5 数据迁移问题"></a>6.5 数据迁移问题</h3><p><strong>问题</strong>：扩容时需要迁移数据。</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>双写迁移</li>
<li>增量同步</li>
<li>灰度切换</li>
</ul>
<h2 id="七、中间件方案"><a href="#七、中间件方案" class="headerlink" title="七、中间件方案"></a>七、中间件方案</h2><h3 id="7-1-MyCat"><a href="#7-1-MyCat" class="headerlink" title="7.1 MyCat"></a>7.1 MyCat</h3><p><strong>特点</strong>：</p>
<ul>
<li>开源数据库中间件</li>
<li>基于 MySQL 协议</li>
<li>支持多种分片规则</li>
</ul>
<p><strong>架构</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">应用 → MyCat → MySQL 集群</span><br></pre></td></tr></table></figure>

<h3 id="7-2-ShardingSphere"><a href="#7-2-ShardingSphere" class="headerlink" title="7.2 ShardingSphere"></a>7.2 ShardingSphere</h3><p><strong>特点</strong>：</p>
<ul>
<li>Apache 顶级项目</li>
<li>支持客户端和代理模式</li>
<li>功能丰富</li>
</ul>
<p><strong>组件</strong>：</p>
<ul>
<li>Sharding-JDBC（客户端）</li>
<li>Sharding-Proxy（代理）</li>
<li>Sharding-Sidecar（云原生）</li>
</ul>
<h3 id="7-3-其他方案"><a href="#7-3-其他方案" class="headerlink" title="7.3 其他方案"></a>7.3 其他方案</h3><table>
<thead>
<tr>
<th>中间件</th>
<th>特点</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td>MyCat</td>
<td>轻量级</td>
<td>中小规模</td>
</tr>
<tr>
<td>ShardingSphere</td>
<td>功能全面</td>
<td>大规模</td>
</tr>
<tr>
<td>Vitess</td>
<td>YouTube 开源</td>
<td>超大规模</td>
</tr>
<tr>
<td>TiDB</td>
<td>原生分布式</td>
<td>新系统</td>
</tr>
</tbody></table>
<h2 id="八、最佳实践"><a href="#八、最佳实践" class="headerlink" title="八、最佳实践"></a>八、最佳实践</h2><h3 id="8-1-设计原则"><a href="#8-1-设计原则" class="headerlink" title="8.1 设计原则"></a>8.1 设计原则</h3><ol>
<li><strong>能不拆分就不拆分</strong>：优先优化 SQL 和索引</li>
<li><strong>先垂直后水平</strong>：先垂直拆分，再考虑水平拆分</li>
<li><strong>合理选择分片键</strong>：根据业务场景选择</li>
<li><strong>预留扩展空间</strong>：分片数量适当超前</li>
</ol>
<h3 id="8-2-实施步骤"><a href="#8-2-实施步骤" class="headerlink" title="8.2 实施步骤"></a>8.2 实施步骤</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 评估是否需要分库分表</span><br><span class="line">2. 选择合适的分片策略</span><br><span class="line">3. 设计分片键和分片规则</span><br><span class="line">4. 选择中间件方案</span><br><span class="line">5. 开发和测试</span><br><span class="line">6. 数据迁移</span><br><span class="line">7. 灰度上线</span><br><span class="line">8. 监控运维</span><br></pre></td></tr></table></figure>

<h3 id="8-3-监控指标"><a href="#8-3-监控指标" class="headerlink" title="8.3 监控指标"></a>8.3 监控指标</h3><table>
<thead>
<tr>
<th>指标</th>
<th>说明</th>
<th>告警阈值</th>
</tr>
</thead>
<tbody><tr>
<td>分片数据量</td>
<td>各分片数据分布</td>
<td>差异&gt;50%</td>
</tr>
<tr>
<td>查询延迟</td>
<td>跨分片查询时间</td>
<td>&gt; 1s</td>
</tr>
<tr>
<td>事务失败率</td>
<td>分布式事务失败比例</td>
<td>&gt; 1%</td>
</tr>
<tr>
<td>数据一致性</td>
<td>主从数据差异</td>
<td>存在差异</td>
</tr>
</tbody></table>
<h2 id="九、小结"><a href="#九、小结" class="headerlink" title="九、小结"></a>九、小结</h2><h3 id="核心知识点"><a href="#核心知识点" class="headerlink" title="核心知识点"></a>核心知识点</h3><ol>
<li><strong>分库分表目的</strong>：解决单表数据量过大的性能问题</li>
<li><strong>拆分方式</strong>：垂直拆分、水平拆分</li>
<li><strong>分片策略</strong>：取模、范围、哈希、地理、一致性哈希</li>
<li><strong>分片键选择</strong>：高频查询、分布均匀、业务相关</li>
</ol>
<h3 id="分库分表决策树"><a href="#分库分表决策树" class="headerlink" title="分库分表决策树"></a>分库分表决策树</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">单表数据量大？</span><br><span class="line">├── 否 → 优化 SQL 和索引</span><br><span class="line">└── 是 → 需要拆分</span><br><span class="line">    ├── 字段访问频率差异大？</span><br><span class="line">    │   ├── 是 → 垂直拆分</span><br><span class="line">    │   └── 否 → 水平拆分</span><br><span class="line">    │</span><br><span class="line">    └── 水平拆分 → 选择分片策略</span><br><span class="line">        ├── 均匀分布 → 取模/哈希</span><br><span class="line">        ├── 范围查询多 → 范围分片</span><br><span class="line">        └── 地理相关 → 地理分片</span><br></pre></td></tr></table></figure>

<h3 id="下一篇预告"><a href="#下一篇预告" class="headerlink" title="下一篇预告"></a>下一篇预告</h3><p>接下来的文章将详细介绍 MyCat 分库分表：</p>
<ul>
<li>03-02：拆分方式详解</li>
<li>03-03：MyCat 概述</li>
<li>03-04：MyCat 安装</li>
</ul>
<hr>
<p><strong>下一篇</strong>：[MySQL 运维篇 03-02 拆分方式详解](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 03-02 拆分方式详解&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 运维篇 02-05 主从复制测试](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 02-05 主从复制测试&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 运维篇</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>分库分表</tag>
        <tag>数据库架构</tag>
        <tag>scalability</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 运维篇 03-02 拆分方式详解</title>
    <url>/2026/02/24/MySQL%20%E8%BF%90%E7%BB%B4%E7%AF%87%2003-02%20%E6%8B%86%E5%88%86%E6%96%B9%E5%BC%8F%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<h1 id="MySQL-运维篇-03-02-拆分方式详解"><a href="#MySQL-运维篇-03-02-拆分方式详解" class="headerlink" title="MySQL 运维篇 03-02 拆分方式详解"></a>MySQL 运维篇 03-02 拆分方式详解</h1><p>本文将详细讲解各种分库分表的拆分方式，包括垂直拆分、水平拆分的实战案例和代码示例。</p>
<h2 id="一、垂直拆分实战"><a href="#一、垂直拆分实战" class="headerlink" title="一、垂直拆分实战"></a>一、垂直拆分实战</h2><h3 id="1-1-场景描述"><a href="#1-1-场景描述" class="headerlink" title="1.1 场景描述"></a>1.1 场景描述</h3><p><strong>原始表结构</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> products (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    description TEXT,        <span class="comment">-- 大字段</span></span><br><span class="line">    detail TEXT,             <span class="comment">-- 大字段</span></span><br><span class="line">    price <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),</span><br><span class="line">    stock <span class="type">INT</span>,</span><br><span class="line">    images <span class="type">BLOB</span>,             <span class="comment">-- 图片数据</span></span><br><span class="line">    created_at DATETIME,</span><br><span class="line">    updated_at DATETIME</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><strong>问题</strong>：</p>
<ul>
<li>单表 1000 万数据</li>
<li>description、detail、images 占用大量空间</li>
<li>查询商品列表时不需要大字段</li>
</ul>
<h3 id="1-2-垂直拆分方案"><a href="#1-2-垂直拆分方案" class="headerlink" title="1.2 垂直拆分方案"></a>1.2 垂直拆分方案</h3><p><strong>拆分后表结构</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 商品主表（常用字段）</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> products_main (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    price <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),</span><br><span class="line">    stock <span class="type">INT</span>,</span><br><span class="line">    created_at DATETIME,</span><br><span class="line">    updated_at DATETIME,</span><br><span class="line">    INDEX idx_price (price),</span><br><span class="line">    INDEX idx_stock (stock)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 商品详情表（大字段）</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> products_detail (</span><br><span class="line">    product_id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    description TEXT,</span><br><span class="line">    detail TEXT,</span><br><span class="line">    images <span class="type">BLOB</span>,</span><br><span class="line">    <span class="keyword">FOREIGN KEY</span> (product_id) <span class="keyword">REFERENCES</span> products_main(id)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-数据迁移"><a href="#1-3-数据迁移" class="headerlink" title="1.3 数据迁移"></a>1.3 数据迁移</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 迁移数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> products_main (id, name, price, stock, created_at, updated_at)</span><br><span class="line"><span class="keyword">SELECT</span> id, name, price, stock, created_at, updated_at <span class="keyword">FROM</span> products;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> products_detail (product_id, description, detail, images)</span><br><span class="line"><span class="keyword">SELECT</span> id, description, detail, images <span class="keyword">FROM</span> products;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 验证数据</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> products_main;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> products_detail;</span><br></pre></td></tr></table></figure>

<h3 id="1-4-查询优化"><a href="#1-4-查询优化" class="headerlink" title="1.4 查询优化"></a>1.4 查询优化</h3><p><strong>拆分前</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询商品列表（扫描大量不必要数据）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> products <span class="keyword">WHERE</span> price <span class="keyword">BETWEEN</span> <span class="number">100</span> <span class="keyword">AND</span> <span class="number">500</span>;</span><br></pre></td></tr></table></figure>

<p><strong>拆分后</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询商品列表（只查主表）</span></span><br><span class="line"><span class="keyword">SELECT</span> id, name, price, stock <span class="keyword">FROM</span> products_main</span><br><span class="line"><span class="keyword">WHERE</span> price <span class="keyword">BETWEEN</span> <span class="number">100</span> <span class="keyword">AND</span> <span class="number">500</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询商品详情（需要时再 JOIN）</span></span><br><span class="line"><span class="keyword">SELECT</span> p.<span class="operator">*</span>, d.description, d.detail</span><br><span class="line"><span class="keyword">FROM</span> products_main p</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> products_detail d <span class="keyword">ON</span> p.id <span class="operator">=</span> d.product_id</span><br><span class="line"><span class="keyword">WHERE</span> p.id <span class="operator">=</span> <span class="number">12345</span>;</span><br></pre></td></tr></table></figure>

<h2 id="二、水平拆分实战"><a href="#二、水平拆分实战" class="headerlink" title="二、水平拆分实战"></a>二、水平拆分实战</h2><h3 id="2-1-场景描述"><a href="#2-1-场景描述" class="headerlink" title="2.1 场景描述"></a>2.1 场景描述</h3><p><strong>订单表</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> orders (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    order_no <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    user_id <span class="type">BIGINT</span>,</span><br><span class="line">    amount <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),</span><br><span class="line">    status TINYINT,</span><br><span class="line">    created_at DATETIME,</span><br><span class="line">    updated_at DATETIME,</span><br><span class="line">    INDEX idx_user (user_id),</span><br><span class="line">    INDEX idx_created (created_at)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br></pre></td></tr></table></figure>

<p><strong>问题</strong>：</p>
<ul>
<li>单表 1 亿数据</li>
<li>按 user_id 查询占 90%</li>
<li>按日期查询占 10%</li>
</ul>
<h3 id="2-2-按-user-id-取模拆分"><a href="#2-2-按-user-id-取模拆分" class="headerlink" title="2.2 按 user_id 取模拆分"></a>2.2 按 user_id 取模拆分</h3><p><strong>分表规则</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">table_name = &#x27;orders_&#x27; + LPAD(user_id % 4, 2, &#x27;0&#x27;)</span><br></pre></td></tr></table></figure>

<p><strong>拆分后表</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建 4 个分表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders_00 <span class="keyword">LIKE</span> orders;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders_01 <span class="keyword">LIKE</span> orders;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders_02 <span class="keyword">LIKE</span> orders;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders_03 <span class="keyword">LIKE</span> orders;</span><br></pre></td></tr></table></figure>

<p><strong>分片计算</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- user_id = 100 → orders_00 (100 % 4 = 0)</span></span><br><span class="line"><span class="comment">-- user_id = 101 → orders_01 (101 % 4 = 1)</span></span><br><span class="line"><span class="comment">-- user_id = 102 → orders_02 (102 % 4 = 2)</span></span><br><span class="line"><span class="comment">-- user_id = 103 → orders_03 (103 % 4 = 3)</span></span><br><span class="line"><span class="comment">-- user_id = 104 → orders_00 (104 % 4 = 0)</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-数据迁移脚本"><a href="#2-3-数据迁移脚本" class="headerlink" title="2.3 数据迁移脚本"></a>2.3 数据迁移脚本</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> migrate_orders()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> done <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="literal">FALSE</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_id <span class="type">BIGINT</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_order_no <span class="type">VARCHAR</span>(<span class="number">50</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> v_user_id <span class="type">BIGINT</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_amount <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> v_status TINYINT;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_created_at DATETIME;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_updated_at DATETIME;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_table_suffix <span class="type">INT</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">DECLARE</span> cur <span class="keyword">CURSOR</span> <span class="keyword">FOR</span></span><br><span class="line">        <span class="keyword">SELECT</span> id, order_no, user_id, amount, status, created_at, updated_at</span><br><span class="line">        <span class="keyword">FROM</span> orders;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">DECLARE</span> CONTINUE HANDLER <span class="keyword">FOR</span> <span class="keyword">NOT</span> FOUND <span class="keyword">SET</span> done <span class="operator">=</span> <span class="literal">TRUE</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">OPEN</span> cur;</span><br><span class="line"></span><br><span class="line">    read_loop: LOOP</span><br><span class="line">        <span class="keyword">FETCH</span> cur <span class="keyword">INTO</span> v_id, v_order_no, v_user_id, v_amount, v_status, v_created_at, v_updated_at;</span><br><span class="line">        IF done <span class="keyword">THEN</span></span><br><span class="line">            LEAVE read_loop;</span><br><span class="line">        <span class="keyword">END</span> IF;</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- 计算分表后缀</span></span><br><span class="line">        <span class="keyword">SET</span> v_table_suffix <span class="operator">=</span> v_user_id <span class="operator">%</span> <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- 插入到对应分表</span></span><br><span class="line">        <span class="keyword">CASE</span> v_table_suffix</span><br><span class="line">            <span class="keyword">WHEN</span> <span class="number">0</span> <span class="keyword">THEN</span></span><br><span class="line">                <span class="keyword">INSERT INTO</span> orders_00 <span class="keyword">VALUES</span> (v_id, v_order_no, v_user_id, v_amount, v_status, v_created_at, v_updated_at);</span><br><span class="line">            <span class="keyword">WHEN</span> <span class="number">1</span> <span class="keyword">THEN</span></span><br><span class="line">                <span class="keyword">INSERT INTO</span> orders_01 <span class="keyword">VALUES</span> (v_id, v_order_no, v_user_id, v_amount, v_status, v_created_at, v_updated_at);</span><br><span class="line">            <span class="keyword">WHEN</span> <span class="number">2</span> <span class="keyword">THEN</span></span><br><span class="line">                <span class="keyword">INSERT INTO</span> orders_02 <span class="keyword">VALUES</span> (v_id, v_order_no, v_user_id, v_amount, v_status, v_created_at, v_updated_at);</span><br><span class="line">            <span class="keyword">WHEN</span> <span class="number">3</span> <span class="keyword">THEN</span></span><br><span class="line">                <span class="keyword">INSERT INTO</span> orders_03 <span class="keyword">VALUES</span> (v_id, v_order_no, v_user_id, v_amount, v_status, v_created_at, v_updated_at);</span><br><span class="line">        <span class="keyword">END</span> <span class="keyword">CASE</span>;</span><br><span class="line">    <span class="keyword">END</span> LOOP;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">CLOSE</span> cur;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 执行迁移</span></span><br><span class="line"><span class="keyword">CALL</span> migrate_orders();</span><br></pre></td></tr></table></figure>

<h3 id="2-4-查询示例"><a href="#2-4-查询示例" class="headerlink" title="2.4 查询示例"></a>2.4 查询示例</h3><p><strong>按 user_id 查询</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- user_id = 100 → orders_00</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders_00 <span class="keyword">WHERE</span> user_id <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- user_id = 101 → orders_01</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders_01 <span class="keyword">WHERE</span> user_id <span class="operator">=</span> <span class="number">101</span>;</span><br></pre></td></tr></table></figure>

<p><strong>统计查询</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 需要 union 所有分表</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">SUM</span>(amount) <span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="built_in">SUM</span>(amount) <span class="keyword">AS</span> amount <span class="keyword">FROM</span> orders_00</span><br><span class="line">    <span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">    <span class="keyword">SELECT</span> <span class="built_in">SUM</span>(amount) <span class="keyword">FROM</span> orders_01</span><br><span class="line">    <span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">    <span class="keyword">SELECT</span> <span class="built_in">SUM</span>(amount) <span class="keyword">FROM</span> orders_02</span><br><span class="line">    <span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">    <span class="keyword">SELECT</span> <span class="built_in">SUM</span>(amount) <span class="keyword">FROM</span> orders_03</span><br><span class="line">) t;</span><br></pre></td></tr></table></figure>

<h2 id="三、按日期范围拆分"><a href="#三、按日期范围拆分" class="headerlink" title="三、按日期范围拆分"></a>三、按日期范围拆分</h2><h3 id="3-1-场景描述"><a href="#3-1-场景描述" class="headerlink" title="3.1 场景描述"></a>3.1 场景描述</h3><p><strong>日志表</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> operation_log (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    user_id <span class="type">BIGINT</span>,</span><br><span class="line">    operation <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    created_at DATETIME,</span><br><span class="line">    INDEX idx_user_time (user_id, created_at)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br></pre></td></tr></table></figure>

<p><strong>特点</strong>：</p>
<ul>
<li>每天新增 100 万数据</li>
<li>主要查询最近 3 个月</li>
<li>历史数据很少访问</li>
</ul>
<h3 id="3-2-按月分表"><a href="#3-2-按月分表" class="headerlink" title="3.2 按月分表"></a>3.2 按月分表</h3><p><strong>分表规则</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">table_name = &#x27;operation_log_&#x27; + DATE_FORMAT(created_at, &#x27;%Y%m&#x27;)</span><br></pre></td></tr></table></figure>

<p><strong>创建分表</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 预创建 12 个月的表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> operation_log_202401 <span class="keyword">LIKE</span> operation_log;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> operation_log_202402 <span class="keyword">LIKE</span> operation_log;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">CREATE TABLE</span> operation_log_202412 <span class="keyword">LIKE</span> operation_log;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-自动创建表存储过程"><a href="#3-3-自动创建表存储过程" class="headerlink" title="3.3 自动创建表存储过程"></a>3.3 自动创建表存储过程</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> create_monthly_table(p_year_month <span class="type">VARCHAR</span>(<span class="number">6</span>))</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> table_name <span class="type">VARCHAR</span>(<span class="number">50</span>);</span><br><span class="line">    <span class="keyword">SET</span> table_name <span class="operator">=</span> CONCAT(<span class="string">&#x27;operation_log_&#x27;</span>, p_year_month);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">SET</span> <span class="variable">@sql</span> <span class="operator">=</span> CONCAT(<span class="string">&#x27;CREATE TABLE IF NOT EXISTS &#x27;</span>, table_name, <span class="string">&#x27; (</span></span><br><span class="line"><span class="string">        id BIGINT PRIMARY KEY AUTO_INCREMENT,</span></span><br><span class="line"><span class="string">        user_id BIGINT,</span></span><br><span class="line"><span class="string">        operation VARCHAR(100),</span></span><br><span class="line"><span class="string">        created_at DATETIME,</span></span><br><span class="line"><span class="string">        INDEX idx_user_time (user_id, created_at)</span></span><br><span class="line"><span class="string">    ) ENGINE=InnoDB&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">PREPARE</span> stmt <span class="keyword">FROM</span> <span class="variable">@sql</span>;</span><br><span class="line">    <span class="keyword">EXECUTE</span> stmt;</span><br><span class="line">    <span class="keyword">DEALLOCATE</span> <span class="keyword">PREPARE</span> stmt;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建下个月的表</span></span><br><span class="line"><span class="keyword">CALL</span> create_monthly_table(<span class="string">&#x27;202403&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="3-4-查询示例"><a href="#3-4-查询示例" class="headerlink" title="3.4 查询示例"></a>3.4 查询示例</h3><p><strong>查询当月数据</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> operation_log_202402</span><br><span class="line"><span class="keyword">WHERE</span> created_at <span class="operator">&gt;=</span> <span class="string">&#x27;2024-02-01&#x27;</span> <span class="keyword">AND</span> created_at <span class="operator">&lt;</span> <span class="string">&#x27;2024-03-01&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>查询多个月份</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> operation_log_202401 <span class="keyword">WHERE</span> created_at <span class="operator">&gt;=</span> <span class="string">&#x27;2024-01-15&#x27;</span></span><br><span class="line">    <span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">    <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> operation_log_202402 <span class="keyword">WHERE</span> created_at <span class="operator">&lt;</span> <span class="string">&#x27;2024-02-15&#x27;</span></span><br><span class="line">) t <span class="keyword">ORDER</span> <span class="keyword">BY</span> created_at <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-5-历史数据清理"><a href="#3-5-历史数据清理" class="headerlink" title="3.5 历史数据清理"></a>3.5 历史数据清理</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 删除 1 年前的数据（直接 DROP 表，速度快）</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> operation_log_202301;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 或者删除特定数据</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> operation_log_202302</span><br><span class="line"><span class="keyword">WHERE</span> created_at <span class="operator">&lt;</span> <span class="string">&#x27;2023-02-01&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="四、按地区拆分"><a href="#四、按地区拆分" class="headerlink" title="四、按地区拆分"></a>四、按地区拆分</h2><h3 id="4-1-场景描述"><a href="#4-1-场景描述" class="headerlink" title="4.1 场景描述"></a>4.1 场景描述</h3><p><strong>用户表</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> users (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    province <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    city <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    phone <span class="type">VARCHAR</span>(<span class="number">20</span>),</span><br><span class="line">    created_at DATETIME</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br></pre></td></tr></table></figure>

<p><strong>特点</strong>：</p>
<ul>
<li>用户遍布全国</li>
<li>本地化服务需求</li>
<li>需要符合数据合规要求</li>
</ul>
<h3 id="4-2-按省份分库"><a href="#4-2-按省份分库" class="headerlink" title="4.2 按省份分库"></a>4.2 按省份分库</h3><p><strong>分库规则</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">database_name = &#x27;users_&#x27; + province_code</span><br></pre></td></tr></table></figure>

<p><strong>分库示例</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 北京用户库</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE users_beijing;</span><br><span class="line"><span class="comment">-- 上海用户库</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE users_shanghai;</span><br><span class="line"><span class="comment">-- 广东用户库</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE users_guangdong;</span><br></pre></td></tr></table></figure>

<p><strong>表结构</strong>（每个库相同）：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">USE users_beijing;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    province <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    city <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    phone <span class="type">VARCHAR</span>(<span class="number">20</span>),</span><br><span class="line">    created_at DATETIME,</span><br><span class="line">    INDEX idx_city (city)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-路由规则"><a href="#4-3-路由规则" class="headerlink" title="4.3 路由规则"></a>4.3 路由规则</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 根据省份确定数据库</span></span><br><span class="line"><span class="comment">-- province = &#x27;beijing&#x27; → users_beijing 库</span></span><br><span class="line"><span class="comment">-- province = &#x27;shanghai&#x27; → users_shanghai 库</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询北京用户</span></span><br><span class="line">USE users_beijing;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> city <span class="operator">=</span> <span class="string">&#x27;北京&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询上海用户</span></span><br><span class="line">USE users_shanghai;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> city <span class="operator">=</span> <span class="string">&#x27;上海&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="五、组合拆分策略"><a href="#五、组合拆分策略" class="headerlink" title="五、组合拆分策略"></a>五、组合拆分策略</h2><h3 id="5-1-场景描述"><a href="#5-1-场景描述" class="headerlink" title="5.1 场景描述"></a>5.1 场景描述</h3><p><strong>电商订单系统</strong>：</p>
<ul>
<li>日订单量 100 万</li>
<li>需要支持按用户查询</li>
<li>需要支持按商家查询</li>
<li>需要支持按日期统计</li>
</ul>
<h3 id="5-2-组合方案"><a href="#5-2-组合方案" class="headerlink" title="5.2 组合方案"></a>5.2 组合方案</h3><p><strong>一级分片：按商家分库</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">database = &#x27;orders_&#x27; + (merchant_id % 10)</span><br></pre></td></tr></table></figure>

<p><strong>二级分片：按用户分表</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">table = &#x27;orders_&#x27; + (user_id % 100)</span><br></pre></td></tr></table></figure>

<p><strong>最终路由</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">orders_05.orders_42  (merchant_id % 10 = 5, user_id % 100 = 42)</span><br></pre></td></tr></table></figure>

<h3 id="5-3-表结构"><a href="#5-3-表结构" class="headerlink" title="5.3 表结构"></a>5.3 表结构</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建 10 个库</span></span><br><span class="line"><span class="comment">-- orders_db_0 到 orders_db_9</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 每个库创建 100 个表</span></span><br><span class="line">USE orders_db_0;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders_00 <span class="keyword">LIKE</span> orders_template;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders_01 <span class="keyword">LIKE</span> orders_template;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders_99 <span class="keyword">LIKE</span> orders_template;</span><br></pre></td></tr></table></figure>

<h2 id="六、拆分方案对比"><a href="#六、拆分方案对比" class="headerlink" title="六、拆分方案对比"></a>六、拆分方案对比</h2><h3 id="6-1-方案对比表"><a href="#6-1-方案对比表" class="headerlink" title="6.1 方案对比表"></a>6.1 方案对比表</h3><table>
<thead>
<tr>
<th>方案</th>
<th>优点</th>
<th>缺点</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td>取模</td>
<td>分布均匀</td>
<td>扩容困难</td>
<td>用户订单</td>
</tr>
<tr>
<td>范围</td>
<td>扩容容易</td>
<td>可能不均</td>
<td>日期数据</td>
</tr>
<tr>
<td>哈希</td>
<td>分布均匀</td>
<td>范围查询无效</td>
<td>随机查询</td>
</tr>
<tr>
<td>地理</td>
<td>就近访问</td>
<td>分布不均</td>
<td>本地化服务</td>
</tr>
<tr>
<td>组合</td>
<td>灵活</td>
<td>复杂度高</td>
<td>多维度查询</td>
</tr>
</tbody></table>
<h3 id="6-2-选择建议"><a href="#6-2-选择建议" class="headerlink" title="6.2 选择建议"></a>6.2 选择建议</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 优先选择取模分片</span><br><span class="line">   - 数据分布最均匀</span><br><span class="line">   - 查询效率最高</span><br><span class="line"></span><br><span class="line">2. 日期数据选择范围分片</span><br><span class="line">   - 便于历史数据归档</span><br><span class="line">   - 便于按时间统计</span><br><span class="line"></span><br><span class="line">3. 国际化业务选择地理分片</span><br><span class="line">   - 符合数据合规</span><br><span class="line">   - 降低访问延迟</span><br><span class="line"></span><br><span class="line">4. 复杂场景选择组合分片</span><br><span class="line">   - 先按业务分库</span><br><span class="line">   - 再按用户分表</span><br></pre></td></tr></table></figure>

<h2 id="七、小结"><a href="#七、小结" class="headerlink" title="七、小结"></a>七、小结</h2><h3 id="核心知识点"><a href="#核心知识点" class="headerlink" title="核心知识点"></a>核心知识点</h3><ol>
<li><strong>垂直拆分</strong>：按列拆分，分离大字段</li>
<li><strong>水平拆分</strong>：按行拆分，降低单表数据量</li>
<li><strong>取模分片</strong>：分布均匀，扩容困难</li>
<li><strong>范围分片</strong>：便于归档，可能不均</li>
</ol>
<h3 id="拆分决策流程"><a href="#拆分决策流程" class="headerlink" title="拆分决策流程"></a>拆分决策流程</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 分析业务场景</span><br><span class="line">   ├── 查询模式</span><br><span class="line">   ├── 数据量增长</span><br><span class="line">   └── 访问频率</span><br><span class="line"></span><br><span class="line">2. 选择拆分方式</span><br><span class="line">   ├── 垂直拆分 → 大字段、低频字段</span><br><span class="line">   └── 水平拆分 → 数据量大</span><br><span class="line"></span><br><span class="line">3. 选择分片策略</span><br><span class="line">   ├── 取模 → 均匀分布</span><br><span class="line">   ├── 范围 → 时间序列</span><br><span class="line">   ├── 哈希 → 随机分布</span><br><span class="line">   └── 地理 → 区域化</span><br><span class="line"></span><br><span class="line">4. 验证方案</span><br><span class="line">   ├── 数据分布</span><br><span class="line">   ├── 查询性能</span><br><span class="line">   └── 扩展性</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>下一篇</strong>：[MySQL 运维篇 03-03 分库分表 MyCat 概述](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 03-03 分库分表 MyCat 概述&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 运维篇 03-01 分库分表介绍](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 03-01 分库分表介绍&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 运维篇</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>实战</tag>
        <tag>分库分表</tag>
        <tag>拆分方式</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 运维篇 03-03 分库分表 MyCat 概述</title>
    <url>/2026/02/24/MySQL%20%E8%BF%90%E7%BB%B4%E7%AF%87%2003-03%20%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%20MyCat%20%E6%A6%82%E8%BF%B0/</url>
    <content><![CDATA[<h1 id="MySQL-运维篇-03-03-分库分表-MyCat-概述"><a href="#MySQL-运维篇-03-03-分库分表-MyCat-概述" class="headerlink" title="MySQL 运维篇 03-03 分库分表 MyCat 概述"></a>MySQL 运维篇 03-03 分库分表 MyCat 概述</h1><p>MyCat 是一个开源的数据库中间件，位于应用程序和数据库之间，负责 SQL 解析、路由和结果合并。本文将介绍 MyCat 的基本概念、架构和核心功能。</p>
<h2 id="一、MyCat-介绍"><a href="#一、MyCat-介绍" class="headerlink" title="一、MyCat 介绍"></a>一、MyCat 介绍</h2><h3 id="1-1-什么是-MyCat？"><a href="#1-1-什么是-MyCat？" class="headerlink" title="1.1 什么是 MyCat？"></a>1.1 什么是 MyCat？</h3><p><strong>MyCat</strong> 是一个基于 Java 开发的数据库中间件，前身是阿里巴巴的 Cobar 项目。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">应用程序 → MyCat → MySQL 集群</span><br><span class="line">         (数据库中间件)</span><br></pre></td></tr></table></figure>

<p><strong>核心功能</strong>：</p>
<ul>
<li>SQL 解析和路由</li>
<li>分库分表</li>
<li>读写分离</li>
<li>连接池管理</li>
<li>负载均衡</li>
</ul>
<h3 id="1-2-MyCat-特点"><a href="#1-2-MyCat-特点" class="headerlink" title="1.2 MyCat 特点"></a>1.2 MyCat 特点</h3><table>
<thead>
<tr>
<th>特点</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>协议兼容</td>
<td>完全兼容 MySQL 协议</td>
</tr>
<tr>
<td>透明分片</td>
<td>应用无需修改代码</td>
</tr>
<tr>
<td>多种分片</td>
<td>支持 10+ 种分片规则</td>
</tr>
<tr>
<td>读写分离</td>
<td>自动路由读写请求</td>
</tr>
<tr>
<td>高可用</td>
<td>支持主从切换</td>
</tr>
</tbody></table>
<h3 id="1-3-适用场景"><a href="#1-3-适用场景" class="headerlink" title="1.3 适用场景"></a>1.3 适用场景</h3><table>
<thead>
<tr>
<th>场景</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>分库分表</td>
<td>单表数据量过大</td>
</tr>
<tr>
<td>读写分离</td>
<td>读多写少场景</td>
</tr>
<tr>
<td>数据库迁移</td>
<td>平滑迁移数据</td>
</tr>
<tr>
<td>多租户</td>
<td>SaaS 应用数据隔离</td>
</tr>
</tbody></table>
<h2 id="二、MyCat-架构"><a href="#二、MyCat-架构" class="headerlink" title="二、MyCat 架构"></a>二、MyCat 架构</h2><h3 id="2-1-整体架构"><a href="#2-1-整体架构" class="headerlink" title="2.1 整体架构"></a>2.1 整体架构</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">应用程序 → MyCat → MySQL 集群</span><br></pre></td></tr></table></figure>

<p><strong>核心组件</strong>：</p>
<ul>
<li>SQL 解析器</li>
<li>SQL 路由引擎</li>
<li>结果集合并</li>
<li>连接池管理</li>
<li>会话管理</li>
</ul>
<h3 id="2-2-架构图"><a href="#2-2-架构图" class="headerlink" title="2.2 架构图"></a>2.2 架构图</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">┌─────────────┐</span><br><span class="line">│   应用程序    │</span><br><span class="line">│  (JDBC 等)   │</span><br><span class="line">└──────┬──────┘</span><br><span class="line">       │ MySQL 协议</span><br><span class="line">┌──────▼──────────────────────────────┐</span><br><span class="line">│              MyCat                   │</span><br><span class="line">│  ┌────────────────────────────────┐ │</span><br><span class="line">│  │   连接管理 | 会话管理 | 事务    │ │</span><br><span class="line">│  ├────────────────────────────────┤ │</span><br><span class="line">│  │          SQL 解析器             │ │</span><br><span class="line">│  ├────────────────────────────────┤ │</span><br><span class="line">│  │          SQL 路由引擎           │ │</span><br><span class="line">│  ├────────────────────────────────┤ │</span><br><span class="line">│  │          结果集合并             │ │</span><br><span class="line">│  └────────────────────────────────┘ │</span><br><span class="line">└──────┬──────────────┬──────────────┘</span><br><span class="line">       │              │</span><br><span class="line">  ┌────▼────┐    ┌────▼────┐</span><br><span class="line">  │ Master  │    │ Slave   │</span><br><span class="line">  │ (写)    │    │ (读)    │</span><br><span class="line">  └─────────┘    └─────────┘</span><br></pre></td></tr></table></figure>

<h2 id="三、MyCat-核心概念"><a href="#三、MyCat-核心概念" class="headerlink" title="三、MyCat 核心概念"></a>三、MyCat 核心概念</h2><h3 id="3-1-逻辑表"><a href="#3-1-逻辑表" class="headerlink" title="3.1 逻辑表"></a>3.1 逻辑表</h3><p><strong>定义</strong>：应用程序看到的表，实际可能分布在多个物理表中。</p>
<p><strong>示例</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">逻辑表：orders</span><br><span class="line">物理表：orders_0000, orders_0001, ..., orders_9999</span><br></pre></td></tr></table></figure>

<h3 id="3-2-数据节点（DataNode）"><a href="#3-2-数据节点（DataNode）" class="headerlink" title="3.2 数据节点（DataNode）"></a>3.2 数据节点（DataNode）</h3><p><strong>定义</strong>：物理数据库实例上的数据库。</p>
<p><strong>配置示例</strong>：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;host1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;db1&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn2&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;host2&quot;</span> <span class="attr">database</span>=<span class="string">&quot;db2&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-3-数据主机（DataHost）"><a href="#3-3-数据主机（DataHost）" class="headerlink" title="3.3 数据主机（DataHost）"></a>3.3 数据主机（DataHost）</h3><p><strong>定义</strong>：物理 MySQL 服务器配置。</p>
<p><strong>配置示例</strong>：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;host1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span> <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;master1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.1.100:3306&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">user</span>=<span class="string">&quot;mycat&quot;</span> <span class="attr">password</span>=<span class="string">&quot;password&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-4-分片规则（Rule）"><a href="#3-4-分片规则（Rule）" class="headerlink" title="3.4 分片规则（Rule）"></a>3.4 分片规则（Rule）</h3><p><strong>定义</strong>：数据如何分布到不同节点的规则。</p>
<p><strong>配置示例</strong>：</p>
<pre><code class="language-xml">&lt;tableRule name=&quot;mod-long&quot;&gt;
    &lt;rule&gt;
        &lt;columns&gt;id&lt;/columns&gt;
        &lt;algorithm&gt;mod-long&lt;/algorithm&gt;
    &lt;/rule&gt;
&lt;/tableRule&gt;

&lt;function name=&quot;mod-long&quot; class=&quot;io.mycat.route.function.PartitionByMod&quot;&gt;
    &lt;property name=&quot;count&quot;&gt;100&lt;/property&gt;
</code></pre>
]]></content>
      <categories>
        <category>MySQL 运维篇</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>分库分表</tag>
        <tag>MyCat</tag>
        <tag>中间件</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 运维篇 04-01 MyCat 入门</title>
    <url>/2026/02/24/MySQL%20%E8%BF%90%E7%BB%B4%E7%AF%87%2004-01%20MyCat%20%E5%85%A5%E9%97%A8/</url>
    <content><![CDATA[<h1 id="MySQL-运维篇-04-01-MyCat-入门"><a href="#MySQL-运维篇-04-01-MyCat-入门" class="headerlink" title="MySQL 运维篇 04-01 MyCat 入门"></a>MySQL 运维篇 04-01 MyCat 入门</h1><p>本文是 MyCat 分库分表的入门教程，将介绍如何使用 MyCat 实现简单的分库分表功能。</p>
<h2 id="一、MyCat-简介"><a href="#一、MyCat-简介" class="headerlink" title="一、MyCat 简介"></a>一、MyCat 简介</h2><h3 id="1-1-什么是-MyCat"><a href="#1-1-什么是-MyCat" class="headerlink" title="1.1 什么是 MyCat"></a>1.1 什么是 MyCat</h3><p>MyCat 是一个数据库中间件层，位于应用程序和 MySQL 数据库之间，提供分库分表、读写分离等功能。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">应用程序 → MyCat (中间件) → MySQL 集群</span><br></pre></td></tr></table></figure>

<h3 id="1-2-MyCat-功能"><a href="#1-2-MyCat-功能" class="headerlink" title="1.2 MyCat 功能"></a>1.2 MyCat 功能</h3><table>
<thead>
<tr>
<th>功能</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>分库分表</td>
<td>将数据分布到多个库&#x2F;表中</td>
</tr>
<tr>
<td>读写分离</td>
<td>自动将读请求路由到从库</td>
</tr>
<tr>
<td>SQL 路由</td>
<td>根据规则路由 SQL 到对应节点</td>
</tr>
<tr>
<td>结果合并</td>
<td>合并多个分片的查询结果</td>
</tr>
<tr>
<td>连接池</td>
<td>管理数据库连接</td>
</tr>
</tbody></table>
<h3 id="1-3-MyCat-版本"><a href="#1-3-MyCat-版本" class="headerlink" title="1.3 MyCat 版本"></a>1.3 MyCat 版本</h3><ul>
<li>MyCat 1.x：经典版本，稳定</li>
<li>MyCat 2.x：重构版本，性能更好</li>
</ul>
<h2 id="二、快速开始"><a href="#二、快速开始" class="headerlink" title="二、快速开始"></a>二、快速开始</h2><h3 id="2-1-环境准备"><a href="#2-1-环境准备" class="headerlink" title="2.1 环境准备"></a>2.1 环境准备</h3><p><strong>软件版本</strong>：</p>
<ul>
<li>MyCat 2.0</li>
<li>MySQL 8.0</li>
<li>JDK 1.8+</li>
</ul>
<p><strong>服务器</strong>：</p>
<table>
<thead>
<tr>
<th>服务器</th>
<th>IP</th>
<th>角色</th>
</tr>
</thead>
<tbody><tr>
<td>server1</td>
<td>192.168.1.100</td>
<td>MyCat + MySQL</td>
</tr>
</tbody></table>
<h3 id="2-2-目录结构"><a href="#2-2-目录结构" class="headerlink" title="2.2 目录结构"></a>2.2 目录结构</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/opt/mycat/</span><br><span class="line">├── bin/           # 启动脚本</span><br><span class="line">├── conf/          # 配置文件</span><br><span class="line">│   ├── server.yml</span><br><span class="line">│   ├── schema.yml</span><br><span class="line">│   ├── datasource.yml</span><br><span class="line">│   └── rule.yml</span><br><span class="line">├── logs/          # 日志目录</span><br><span class="line">└── lib/           # 依赖库</span><br></pre></td></tr></table></figure>

<h3 id="2-3-配置文件"><a href="#2-3-配置文件" class="headerlink" title="2.3 配置文件"></a>2.3 配置文件</h3><p><strong>server.yml - 用户配置</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">system:</span></span><br><span class="line">  <span class="attr">schemaChecksum:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">users:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">schemas:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">testdb</span></span><br></pre></td></tr></table></figure>

<p><strong>schema.yml - Schema 配置</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">schemas:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">testdb</span></span><br><span class="line">    <span class="attr">tables:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">orders</span></span><br><span class="line">        <span class="attr">dataNodes:</span> <span class="string">dn1,dn2</span></span><br><span class="line">        <span class="attr">rule:</span> <span class="string">mod-long</span></span><br><span class="line">        <span class="attr">primaryKey:</span> <span class="string">id</span></span><br></pre></td></tr></table></figure>

<p><strong>datasource.yml - 数据源配置</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">dataNodes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn1</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">db1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn2</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">db2</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dataHosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">heartbeat:</span></span><br><span class="line">      <span class="attr">statement:</span> <span class="string">select</span> <span class="string">user()</span></span><br><span class="line">    <span class="attr">writeHosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">master</span></span><br><span class="line">        <span class="attr">url:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.100</span><span class="string">:3306</span></span><br><span class="line">        <span class="attr">user:</span> <span class="string">mycat</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">MyCat@123</span></span><br></pre></td></tr></table></figure>

<p><strong>rule.yml - 分片规则</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tableRules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mod-long</span></span><br><span class="line">    <span class="attr">function:</span> <span class="string">mod-long</span></span><br><span class="line">    <span class="attr">columns:</span> <span class="string">id</span></span><br><span class="line"></span><br><span class="line"><span class="attr">functions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mod-long</span></span><br><span class="line">    <span class="attr">className:</span> <span class="string">io.mycat.router.function.PartitionByFunction</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">count:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>

<h2 id="三、MySQL-端配置"><a href="#三、MySQL-端配置" class="headerlink" title="三、MySQL 端配置"></a>三、MySQL 端配置</h2><h3 id="3-1-创建用户"><a href="#3-1-创建用户" class="headerlink" title="3.1 创建用户"></a>3.1 创建用户</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建 MyCat 用户</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;mycat&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;MyCat@123&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 授予权限</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;mycat&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-创建数据库"><a href="#3-2-创建数据库" class="headerlink" title="3.2 创建数据库"></a>3.2 创建数据库</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建两个数据库用于分片</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE db1 <span class="keyword">DEFAULT</span> <span class="keyword">CHARACTER SET</span> utf8mb4;</span><br><span class="line"><span class="keyword">CREATE</span> DATABASE db2 <span class="keyword">DEFAULT</span> <span class="keyword">CHARACTER SET</span> utf8mb4;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-创建表"><a href="#3-3-创建表" class="headerlink" title="3.3 创建表"></a>3.3 创建表</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 在 db1 和 db2 中创建相同的表结构</span></span><br><span class="line">USE db1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    order_no <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    user_id <span class="type">BIGINT</span>,</span><br><span class="line">    amount <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),</span><br><span class="line">    status TINYINT,</span><br><span class="line">    created_at DATETIME <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- db2 同样创建</span></span><br></pre></td></tr></table></figure>

<h2 id="四、启动-MyCat"><a href="#四、启动-MyCat" class="headerlink" title="四、启动 MyCat"></a>四、启动 MyCat</h2><h3 id="4-1-启动"><a href="#4-1-启动" class="headerlink" title="4.1 启动"></a>4.1 启动</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/mycat</span><br><span class="line">bin/mycat start</span><br></pre></td></tr></table></figure>

<h3 id="4-2-查看状态"><a href="#4-2-查看状态" class="headerlink" title="4.2 查看状态"></a>4.2 查看状态</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bin/mycat status</span><br><span class="line"><span class="built_in">tail</span> -f logs/mycat.log</span><br></pre></td></tr></table></figure>

<h3 id="4-3-连接-MyCat"><a href="#4-3-连接-MyCat" class="headerlink" title="4.3 连接 MyCat"></a>4.3 连接 MyCat</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql -h 127.0.0.1 -P 8066 -u root -p</span><br></pre></td></tr></table></figure>

<h2 id="五、分片测试"><a href="#五、分片测试" class="headerlink" title="五、分片测试"></a>五、分片测试</h2><h3 id="5-1-插入数据"><a href="#5-1-插入数据" class="headerlink" title="5.1 插入数据"></a>5.1 插入数据</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">USE testdb;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入 4 条数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (id, order_no, user_id, amount) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">1</span>, <span class="string">&#x27;ORD001&#x27;</span>, <span class="number">100</span>, <span class="number">199.99</span>),</span><br><span class="line">(<span class="number">2</span>, <span class="string">&#x27;ORD002&#x27;</span>, <span class="number">101</span>, <span class="number">299.99</span>),</span><br><span class="line">(<span class="number">3</span>, <span class="string">&#x27;ORD003&#x27;</span>, <span class="number">102</span>, <span class="number">399.99</span>),</span><br><span class="line">(<span class="number">4</span>, <span class="string">&#x27;ORD004&#x27;</span>, <span class="number">103</span>, <span class="number">499.99</span>);</span><br></pre></td></tr></table></figure>

<h3 id="5-2-查询数据"><a href="#5-2-查询数据" class="headerlink" title="5.2 查询数据"></a>5.2 查询数据</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询全部数据（MyCat 自动合并）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 根据分片键查询（直接路由到对应分片）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-验证数据分布"><a href="#5-3-验证数据分布" class="headerlink" title="5.3 验证数据分布"></a>5.3 验证数据分布</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 在物理库查看</span></span><br><span class="line"><span class="comment">-- db1: id = 1, 3 (1%2=1, 3%2=1)</span></span><br><span class="line"><span class="comment">-- db2: id = 2, 0 (2%2=0, 4%2=0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 登录 MySQL 验证</span></span><br><span class="line">mysql <span class="operator">-</span>u mycat <span class="operator">-</span>p</span><br><span class="line">USE db1;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders;</span><br><span class="line"></span><br><span class="line">USE db2;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders;</span><br></pre></td></tr></table></figure>

<h2 id="六、MyCat-管理命令"><a href="#六、MyCat-管理命令" class="headerlink" title="六、MyCat 管理命令"></a>六、MyCat 管理命令</h2><h3 id="6-1-查看状态"><a href="#6-1-查看状态" class="headerlink" title="6.1 查看状态"></a>6.1 查看状态</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看服务器状态</span></span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@SERVER</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看数据源状态</span></span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@DATASOURCE</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看连接池</span></span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@CONNECTIONPOOL</span>;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-查看-SQL-统计"><a href="#6-2-查看-SQL-统计" class="headerlink" title="6.2 查看 SQL 统计"></a>6.2 查看 SQL 统计</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看 SQL 执行统计</span></span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@SQL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看慢查询</span></span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@SLOW</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看事务</span></span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@TRANSACTION</span>;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-管理操作"><a href="#6-3-管理操作" class="headerlink" title="6.3 管理操作"></a>6.3 管理操作</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 切换数据源</span></span><br><span class="line">USE dn1;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 杀死连接</span></span><br><span class="line">KILL @<span class="variable">@CONNECTION</span> <span class="number">12345</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 停止数据源</span></span><br><span class="line">STOP @<span class="variable">@DATASOURCE</span> dn1;</span><br></pre></td></tr></table></figure>

<h2 id="七、常见问题"><a href="#七、常见问题" class="headerlink" title="七、常见问题"></a>七、常见问题</h2><h3 id="7-1-分片规则不生效"><a href="#7-1-分片规则不生效" class="headerlink" title="7.1 分片规则不生效"></a>7.1 分片规则不生效</h3><p><strong>检查</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看 rule.yml 配置</span></span><br><span class="line"><span class="built_in">cat</span> conf/rule.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查函数类名是否正确</span></span><br><span class="line"><span class="comment"># 检查分片数量是否正确</span></span><br></pre></td></tr></table></figure>

<h3 id="7-2-SQL-路由错误"><a href="#7-2-SQL-路由错误" class="headerlink" title="7.2 SQL 路由错误"></a>7.2 SQL 路由错误</h3><p><strong>检查</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看 SQL 路由结果</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h3 id="7-3-连接失败"><a href="#7-3-连接失败" class="headerlink" title="7.3 连接失败"></a>7.3 连接失败</h3><p><strong>检查</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 检查 MyCat 是否启动</span></span><br><span class="line">bin/mycat status</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查端口</span></span><br><span class="line">netstat -tlnp | grep 8066</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查日志</span></span><br><span class="line"><span class="built_in">tail</span> -f logs/mycat.log</span><br></pre></td></tr></table></figure>

<h2 id="八、小结"><a href="#八、小结" class="headerlink" title="八、小结"></a>八、小结</h2><h3 id="MyCat-入门要点"><a href="#MyCat-入门要点" class="headerlink" title="MyCat 入门要点"></a>MyCat 入门要点</h3><ol>
<li><strong>配置文件</strong>：server.yml、schema.yml、datasource.yml、rule.yml</li>
<li><strong>分片规则</strong>：mod-long 取模分片</li>
<li><strong>管理命令</strong>：SHOW @@SERVER、SHOW @@DATASOURCE</li>
</ol>
<h3 id="下一步"><a href="#下一步" class="headerlink" title="下一步"></a>下一步</h3><ul>
<li>04-02：MyCat 测试</li>
<li>04-03：MyCat 配置详解</li>
<li>04-04：MyCat 高级配置</li>
</ul>
<hr>
<p><strong>下一篇</strong>：[MySQL 运维篇 04-02 MyCat 测试](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 04-02 MyCat 测试&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 运维篇 03-04 MyCat 安装与配置](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 03-04 MyCat 安装与配置&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 运维篇</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>入门</tag>
        <tag>分库分表</tag>
        <tag>MyCat</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 运维篇 03-04 MyCat 安装与配置</title>
    <url>/2026/02/24/MySQL%20%E8%BF%90%E7%BB%B4%E7%AF%87%2003-04%20MyCat%20%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<h1 id="MySQL-运维篇-03-04-MyCat-安装与配置"><a href="#MySQL-运维篇-03-04-MyCat-安装与配置" class="headerlink" title="MySQL 运维篇 03-04 MyCat 安装与配置"></a>MySQL 运维篇 03-04 MyCat 安装与配置</h1><p>本文将详细讲解 MyCat 的下载、安装、配置和启动过程，帮助你快速搭建 MyCat 环境。</p>
<h2 id="一、环境准备"><a href="#一、环境准备" class="headerlink" title="一、环境准备"></a>一、环境准备</h2><h3 id="1-1-系统要求"><a href="#1-1-系统要求" class="headerlink" title="1.1 系统要求"></a>1.1 系统要求</h3><table>
<thead>
<tr>
<th>组件</th>
<th>要求</th>
</tr>
</thead>
<tbody><tr>
<td>Java</td>
<td>JDK 1.8+</td>
</tr>
<tr>
<td>内存</td>
<td>最少 2GB，推荐 4GB+</td>
</tr>
<tr>
<td>磁盘</td>
<td>最少 10GB 可用空间</td>
</tr>
<tr>
<td>MySQL</td>
<td>5.6+</td>
</tr>
</tbody></table>
<h3 id="1-2-环境信息"><a href="#1-2-环境信息" class="headerlink" title="1.2 环境信息"></a>1.2 环境信息</h3><table>
<thead>
<tr>
<th>服务器</th>
<th>IP 地址</th>
<th>角色</th>
<th>软件</th>
</tr>
</thead>
<tbody><tr>
<td>server1</td>
<td>192.168.1.100</td>
<td>MyCat + Master</td>
<td>MyCat, MySQL</td>
</tr>
<tr>
<td>server2</td>
<td>192.168.1.101</td>
<td>Slave</td>
<td>MySQL</td>
</tr>
</tbody></table>
<h3 id="1-3-安装-Java"><a href="#1-3-安装-Java" class="headerlink" title="1.3 安装 Java"></a>1.3 安装 Java</h3><p><strong>Linux (CentOS&#x2F;RHEL)</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装 OpenJDK 8</span></span><br><span class="line">yum install -y java-1.8.0-openjdk java-1.8.0-openjdk-devel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证安装</span></span><br><span class="line">java -version</span><br></pre></td></tr></table></figure>

<p><strong>Linux (Ubuntu&#x2F;Debian)</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装 OpenJDK 8</span></span><br><span class="line">apt-get update</span><br><span class="line">apt-get install -y openjdk-8-jdk</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证安装</span></span><br><span class="line">java -version</span><br></pre></td></tr></table></figure>

<p><strong>Windows</strong>：</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 下载 JDK：https://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html</span></span><br><span class="line"><span class="comment"># 安装后配置 JAVA_HOME</span></span><br><span class="line"><span class="built_in">set</span> JAVA_HOME=C:\Program Files\Java\jdk1.<span class="number">8.0</span>_xxx</span><br><span class="line"><span class="built_in">set</span> PATH=%JAVA_HOME%\bin;%PATH%</span><br></pre></td></tr></table></figure>

<h2 id="二、MyCat-下载与安装"><a href="#二、MyCat-下载与安装" class="headerlink" title="二、MyCat 下载与安装"></a>二、MyCat 下载与安装</h2><h3 id="2-1-下载-MyCat"><a href="#2-1-下载-MyCat" class="headerlink" title="2.1 下载 MyCat"></a>2.1 下载 MyCat</h3><p><strong>官方下载地址</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://dl.mycat.org.cn/</span><br></pre></td></tr></table></figure>

<p><strong>Linux 下载</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 下载最新版 MyCat 2.0</span></span><br><span class="line"><span class="built_in">cd</span> /opt</span><br><span class="line">wget http://dl.mycat.org.cn/2.0.0-alpha/Mycat-server-2.0.0-alpha-linux.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或使用国内镜像</span></span><br><span class="line">wget https://repo.mycat.org.cn/2.0.0-alpha/Mycat-server-2.0.0-alpha-linux.tar.gz</span><br></pre></td></tr></table></figure>

<p><strong>Windows 下载</strong>：</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用浏览器下载或使用 PowerShell</span></span><br><span class="line"><span class="built_in">Invoke-WebRequest</span> <span class="literal">-Uri</span> <span class="string">&quot;http://dl.mycat.org.cn/2.0.0-alpha/Mycat-server-2.0.0-alpha-win.tar.gz&quot;</span> <span class="literal">-OutFile</span> <span class="string">&quot;Mycat-server.tar.gz&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-解压安装"><a href="#2-2-解压安装" class="headerlink" title="2.2 解压安装"></a>2.2 解压安装</h3><p><strong>Linux</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 解压</span></span><br><span class="line">tar -zxvf Mycat-server-2.0.0-alpha-linux.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 移动到我 cat 目录</span></span><br><span class="line"><span class="built_in">mv</span> mycat /usr/local/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置权限</span></span><br><span class="line"><span class="built_in">chmod</span> +x /usr/local/mycat/bin/*</span><br></pre></td></tr></table></figure>

<p><strong>Windows</strong>：</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 解压到 C:\Program Files</span></span><br><span class="line"><span class="built_in">Expand-Archive</span> <span class="literal">-Path</span> Mycat<span class="literal">-server</span>.tar.gz <span class="literal">-DestinationPath</span> <span class="string">&quot;C:\Program Files&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 或使用 7-Zip 解压</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-目录结构"><a href="#2-3-目录结构" class="headerlink" title="2.3 目录结构"></a>2.3 目录结构</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mycat/</span><br><span class="line">├── bin/                    # 可执行脚本</span><br><span class="line">│   ├── mycat              # Linux 启动脚本</span><br><span class="line">│   ├── mycat.bat          # Windows 启动脚本</span><br><span class="line">│   └── ...</span><br><span class="line">├── conf/                   # 配置文件</span><br><span class="line">│   ├── server.yml         # 主配置文件</span><br><span class="line">│   ├── schema.yml         # 数据库 schema 配置</span><br><span class="line">│   ├── datasource.yml     # 数据源配置</span><br><span class="line">│   └── ...</span><br><span class="line">├── logs/                   # 日志目录</span><br><span class="line">│   ├── mycat.log          # 主日志</span><br><span class="line">│   └── ...</span><br><span class="line">├── lib/                    # 依赖库</span><br><span class="line">└── logs/                   # 运行日志</span><br></pre></td></tr></table></figure>

<h2 id="三、配置文件详解"><a href="#三、配置文件详解" class="headerlink" title="三、配置文件详解"></a>三、配置文件详解</h2><h3 id="3-1-主配置文件-server-yml"><a href="#3-1-主配置文件-server-yml" class="headerlink" title="3.1 主配置文件 server.yml"></a>3.1 主配置文件 server.yml</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># MyCat 服务器配置</span></span><br><span class="line"><span class="attr">system:</span></span><br><span class="line">  <span class="comment"># 系统参数</span></span><br><span class="line">  <span class="attr">schemaChecksum:</span> <span class="literal">false</span>      <span class="comment"># 是否检查 schema 配置 checksum</span></span><br><span class="line">  <span class="attr">checkTableType:</span> <span class="number">0</span>          <span class="comment"># 检查表类型</span></span><br><span class="line">  <span class="attr">noneBlockHeartbeat:</span> <span class="number">0</span>      <span class="comment"># 非阻塞心跳</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户配置</span></span><br><span class="line"><span class="attr">users:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">root</span>               <span class="comment"># 用户名</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span>         <span class="comment"># 密码</span></span><br><span class="line">    <span class="attr">schemas:</span>                 <span class="comment"># 可访问的 schema</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">testdb</span></span><br><span class="line">    <span class="attr">readOnly:</span> <span class="literal">false</span>          <span class="comment"># 是否只读</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 防火墙配置</span></span><br><span class="line"><span class="attr">firewall:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># 白名单</span></span><br><span class="line">  <span class="comment"># whitelist: 192.168.1.*</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-Schema-配置-schema-yml"><a href="#3-2-Schema-配置-schema-yml" class="headerlink" title="3.2 Schema 配置 schema.yml"></a>3.2 Schema 配置 schema.yml</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">schemas:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">testdb</span>             <span class="comment"># 逻辑库名</span></span><br><span class="line">    <span class="attr">tables:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">orders</span>         <span class="comment"># 逻辑表</span></span><br><span class="line">        <span class="attr">dataNodes:</span> <span class="string">dn1,dn2,dn3,dn4</span></span><br><span class="line">        <span class="attr">rule:</span> <span class="string">mod-long</span></span><br><span class="line">        <span class="attr">primaryKey:</span> <span class="string">id</span></span><br></pre></td></tr></table></figure>

<h3 id="3-3-数据源配置-datasource-yml"><a href="#3-3-数据源配置-datasource-yml" class="headerlink" title="3.3 数据源配置 datasource.yml"></a>3.3 数据源配置 datasource.yml</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">dataNodes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn1</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">db1</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn2</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">db2</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn3</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host2</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">db1</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn4</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host2</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">db2</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dataHosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">heartbeat:</span></span><br><span class="line">      <span class="attr">statement:</span> <span class="string">select</span> <span class="string">user()</span></span><br><span class="line">    <span class="attr">writeHosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">master1</span></span><br><span class="line">        <span class="attr">url:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.100</span><span class="string">:3306</span></span><br><span class="line">        <span class="attr">user:</span> <span class="string">mycat</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">MyCat@123</span></span><br><span class="line">    <span class="attr">readHosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">slave1</span></span><br><span class="line">        <span class="attr">url:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.101</span><span class="string">:3306</span></span><br><span class="line">        <span class="attr">user:</span> <span class="string">mycat</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">MyCat@123</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">host2</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">heartbeat:</span></span><br><span class="line">      <span class="attr">statement:</span> <span class="string">select</span> <span class="string">user()</span></span><br><span class="line">    <span class="attr">writeHosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">master2</span></span><br><span class="line">        <span class="attr">url:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.102</span><span class="string">:3306</span></span><br><span class="line">        <span class="attr">user:</span> <span class="string">mycat</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">MyCat@123</span></span><br></pre></td></tr></table></figure>

<h3 id="3-4-分片规则配置-rule-yml"><a href="#3-4-分片规则配置-rule-yml" class="headerlink" title="3.4 分片规则配置 rule.yml"></a>3.4 分片规则配置 rule.yml</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tableRules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mod-long</span></span><br><span class="line">    <span class="attr">function:</span> <span class="string">mod-long</span></span><br><span class="line">    <span class="attr">columns:</span> <span class="string">id</span></span><br><span class="line"></span><br><span class="line"><span class="attr">functions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mod-long</span></span><br><span class="line">    <span class="attr">className:</span> <span class="string">io.mycat.router.function.PartitionByFunction</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">count:</span> <span class="number">4</span>    <span class="comment"># 分片数量</span></span><br></pre></td></tr></table></figure>

<h2 id="四、MySQL-端配置"><a href="#四、MySQL-端配置" class="headerlink" title="四、MySQL 端配置"></a>四、MySQL 端配置</h2><h3 id="4-1-创建-MyCat-用户"><a href="#4-1-创建-MyCat-用户" class="headerlink" title="4.1 创建 MyCat 用户"></a>4.1 创建 MyCat 用户</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 在主库和从库执行</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;mycat&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;MyCat@123&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 授予权限</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span>, <span class="keyword">INSERT</span>, <span class="keyword">UPDATE</span>, <span class="keyword">DELETE</span>, <span class="keyword">CREATE</span>, <span class="keyword">DROP</span>, <span class="keyword">ALTER</span> <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;mycat&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 刷新权限</span></span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-创建物理数据库"><a href="#4-2-创建物理数据库" class="headerlink" title="4.2 创建物理数据库"></a>4.2 创建物理数据库</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 在 host1 (192.168.1.100) 创建</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE db1 <span class="keyword">DEFAULT</span> <span class="keyword">CHARACTER SET</span> utf8mb4;</span><br><span class="line"><span class="keyword">CREATE</span> DATABASE db2 <span class="keyword">DEFAULT</span> <span class="keyword">CHARACTER SET</span> utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在 host2 (192.168.1.102) 创建</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE db1 <span class="keyword">DEFAULT</span> <span class="keyword">CHARACTER SET</span> utf8mb4;</span><br><span class="line"><span class="keyword">CREATE</span> DATABASE db2 <span class="keyword">DEFAULT</span> <span class="keyword">CHARACTER SET</span> utf8mb4;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-创建物理表"><a href="#4-3-创建物理表" class="headerlink" title="4.3 创建物理表"></a>4.3 创建物理表</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 在每个数据库创建表</span></span><br><span class="line">USE db1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    order_no <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    user_id <span class="type">BIGINT</span>,</span><br><span class="line">    amount <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),</span><br><span class="line">    status TINYINT,</span><br><span class="line">    created_at DATETIME,</span><br><span class="line">    updated_at DATETIME</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br></pre></td></tr></table></figure>

<h2 id="五、启动-MyCat"><a href="#五、启动-MyCat" class="headerlink" title="五、启动 MyCat"></a>五、启动 MyCat</h2><h3 id="5-1-Linux-启动"><a href="#5-1-Linux-启动" class="headerlink" title="5.1 Linux 启动"></a>5.1 Linux 启动</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 进入 mycat 目录</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local/mycat</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">bin/mycat start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">bin/mycat status</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止</span></span><br><span class="line">bin/mycat stop</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启</span></span><br><span class="line">bin/mycat restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看日志</span></span><br><span class="line"><span class="built_in">tail</span> -f logs/mycat.log</span><br></pre></td></tr></table></figure>

<h3 id="5-2-Windows-启动"><a href="#5-2-Windows-启动" class="headerlink" title="5.2 Windows 启动"></a>5.2 Windows 启动</h3><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 进入 mycat 目录</span></span><br><span class="line"><span class="built_in">cd</span> <span class="string">&quot;C:\Program Files\mycat&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">bin\mycat.bat <span class="built_in">start</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 控制台模式启动（调试用）</span></span><br><span class="line">bin\mycat.bat console</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止</span></span><br><span class="line">bin\mycat.bat stop</span><br></pre></td></tr></table></figure>

<h3 id="5-3-验证启动"><a href="#5-3-验证启动" class="headerlink" title="5.3 验证启动"></a>5.3 验证启动</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看端口（默认 8066）</span></span><br><span class="line">netstat -tlnp | grep 8066</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看进程</span></span><br><span class="line">ps aux | grep mycat</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看日志</span></span><br><span class="line"><span class="built_in">tail</span> -f logs/mycat.log</span><br></pre></td></tr></table></figure>

<h2 id="六、连接测试"><a href="#六、连接测试" class="headerlink" title="六、连接测试"></a>六、连接测试</h2><h3 id="6-1-使用-MySQL-客户端连接"><a href="#6-1-使用-MySQL-客户端连接" class="headerlink" title="6.1 使用 MySQL 客户端连接"></a>6.1 使用 MySQL 客户端连接</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 连接 MyCat</span></span><br><span class="line">mysql -h 192.168.1.100 -P 8066 -u root -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输入密码：123456</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-查看-MyCat-状态"><a href="#6-2-查看-MyCat-状态" class="headerlink" title="6.2 查看 MyCat 状态"></a>6.2 查看 MyCat 状态</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看数据库</span></span><br><span class="line"><span class="keyword">SHOW</span> DATABASES;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看表</span></span><br><span class="line">USE testdb;</span><br><span class="line"><span class="keyword">SHOW</span> TABLES;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看 MyCat 状态</span></span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@SERVER</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看数据源状态</span></span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@DATASOURCE</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看连接池状态</span></span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@CONNECTIONPOOL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看慢查询</span></span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@SLOW</span>;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-数据操作测试"><a href="#6-3-数据操作测试" class="headerlink" title="6.3 数据操作测试"></a>6.3 数据操作测试</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">USE testdb;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (id, order_no, user_id, amount, status, created_at)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;ORD001&#x27;</span>, <span class="number">100</span>, <span class="number">199.99</span>, <span class="number">1</span>, NOW());</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (id, order_no, user_id, amount, status, created_at)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;ORD002&#x27;</span>, <span class="number">101</span>, <span class="number">299.99</span>, <span class="number">1</span>, NOW());</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (id, order_no, user_id, amount, status, created_at)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;ORD003&#x27;</span>, <span class="number">102</span>, <span class="number">399.99</span>, <span class="number">1</span>, NOW());</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (id, order_no, user_id, amount, status, created_at)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="string">&#x27;ORD004&#x27;</span>, <span class="number">103</span>, <span class="number">499.99</span>, <span class="number">1</span>, NOW());</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询数据</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看数据分布</span></span><br><span class="line"><span class="keyword">SELECT</span> id, order_no, user_id <span class="keyword">FROM</span> orders;</span><br></pre></td></tr></table></figure>

<h3 id="6-4-验证分片"><a href="#6-4-验证分片" class="headerlink" title="6.4 验证分片"></a>6.4 验证分片</h3><p><strong>在物理库查看</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 登录 db1</span></span><br><span class="line">USE db1;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 登录 db2</span></span><br><span class="line">USE db2;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders;</span><br></pre></td></tr></table></figure>

<p><strong>预期结果</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">db1: id = 1, 3 的数据</span><br><span class="line">db2: id = 2, 4 的数据</span><br><span class="line">(根据 mod 分片规则)</span><br></pre></td></tr></table></figure>

<h2 id="七、故障排查"><a href="#七、故障排查" class="headerlink" title="七、故障排查"></a>七、故障排查</h2><h3 id="7-1-启动失败"><a href="#7-1-启动失败" class="headerlink" title="7.1 启动失败"></a>7.1 启动失败</h3><p><strong>错误</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Failed to start MyCat server</span><br></pre></td></tr></table></figure>

<p><strong>排查</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 检查 Java 环境</span></span><br><span class="line">java -version</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查端口占用</span></span><br><span class="line">netstat -tlnp | grep 8066</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查日志</span></span><br><span class="line"><span class="built_in">cat</span> logs/mycat.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查配置文件语法</span></span><br><span class="line"><span class="built_in">cat</span> conf/server.yml</span><br></pre></td></tr></table></figure>

<h3 id="7-2-无法连接"><a href="#7-2-无法连接" class="headerlink" title="7.2 无法连接"></a>7.2 无法连接</h3><p><strong>错误</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ERROR 2003 (HY000): Can&#x27;t connect to MySQL server</span><br></pre></td></tr></table></figure>

<p><strong>排查</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 检查 MyCat 是否运行</span></span><br><span class="line">bin/mycat status</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查防火墙</span></span><br><span class="line">firewall-cmd --list-ports</span><br><span class="line">telnet 192.168.1.100 8066</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查用户配置</span></span><br><span class="line"><span class="built_in">cat</span> conf/server.yml</span><br></pre></td></tr></table></figure>

<h3 id="7-3-SQL-执行错误"><a href="#7-3-SQL-执行错误" class="headerlink" title="7.3 SQL 执行错误"></a>7.3 SQL 执行错误</h3><p><strong>错误</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Table &#x27;orders&#x27; doesn&#x27;t exist</span><br></pre></td></tr></table></figure>

<p><strong>排查</strong>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 检查 schema 配置</span></span><br><span class="line"><span class="built_in">cat</span> conf/schema.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查物理表是否存在</span></span><br><span class="line">mysql -h 192.168.1.100 -e <span class="string">&quot;SHOW TABLES FROM db1&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="八、小结"><a href="#八、小结" class="headerlink" title="八、小结"></a>八、小结</h2><h3 id="安装步骤总结"><a href="#安装步骤总结" class="headerlink" title="安装步骤总结"></a>安装步骤总结</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 安装 JDK 1.8+</span><br><span class="line">2. 下载 MyCat</span><br><span class="line">3. 解压到安装目录</span><br><span class="line">4. 配置 server.yml、schema.yml、datasource.yml</span><br><span class="line">5. MySQL 创建用户和数据库</span><br><span class="line">6. 启动 MyCat</span><br><span class="line">7. 连接测试</span><br></pre></td></tr></table></figure>

<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><table>
<thead>
<tr>
<th>文件</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>server.yml</td>
<td>用户和系统配置</td>
</tr>
<tr>
<td>schema.yml</td>
<td>逻辑库表配置</td>
</tr>
<tr>
<td>datasource.yml</td>
<td>数据源配置</td>
</tr>
<tr>
<td>rule.yml</td>
<td>分片规则配置</td>
</tr>
</tbody></table>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动/停止/重启</span></span><br><span class="line">bin/mycat start</span><br><span class="line">bin/mycat stop</span><br><span class="line">bin/mycat restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">bin/mycat status</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看日志</span></span><br><span class="line"><span class="built_in">tail</span> -f logs/mycat.log</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>下一篇</strong>：[MySQL 运维篇 04-01 MyCat 入门](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 04-01 MyCat 入门&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 运维篇 03-02 拆分方式详解](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 03-02 拆分方式详解&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 运维篇</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>实战</tag>
        <tag>MyCat</tag>
        <tag>安装配置</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 运维篇 04-02 MyCat 测试</title>
    <url>/2026/02/24/MySQL%20%E8%BF%90%E7%BB%B4%E7%AF%87%2004-02%20MyCat%20%E6%B5%8B%E8%AF%95/</url>
    <content><![CDATA[<h1 id="MySQL-运维篇-04-02-MyCat-测试"><a href="#MySQL-运维篇-04-02-MyCat-测试" class="headerlink" title="MySQL 运维篇 04-02 MyCat 测试"></a>MySQL 运维篇 04-02 MyCat 测试</h1><p>完成 MyCat 配置后，需要进行全面的测试以验证分库分表功能是否正常。本文将介绍各种测试场景。</p>
<h2 id="一、连接测试"><a href="#一、连接测试" class="headerlink" title="一、连接测试"></a>一、连接测试</h2><h3 id="1-1-基本连接"><a href="#1-1-基本连接" class="headerlink" title="1.1 基本连接"></a>1.1 基本连接</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用 MySQL 客户端连接 MyCat</span></span><br><span class="line">mysql -h 127.0.0.1 -P 8066 -u root -p123456</span><br></pre></td></tr></table></figure>

<h3 id="1-2-查看数据库"><a href="#1-2-查看数据库" class="headerlink" title="1.2 查看数据库"></a>1.2 查看数据库</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看逻辑数据库</span></span><br><span class="line"><span class="keyword">SHOW</span> DATABASES;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 输出应该包含 testdb</span></span><br></pre></td></tr></table></figure>

<h3 id="1-3-查看表"><a href="#1-3-查看表" class="headerlink" title="1.3 查看表"></a>1.3 查看表</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">USE testdb;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看逻辑表</span></span><br><span class="line"><span class="keyword">SHOW</span> TABLES;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 输出应该包含 orders</span></span><br></pre></td></tr></table></figure>

<h2 id="二、CRUD-测试"><a href="#二、CRUD-测试" class="headerlink" title="二、CRUD 测试"></a>二、CRUD 测试</h2><h3 id="2-1-插入测试"><a href="#2-1-插入测试" class="headerlink" title="2.1 插入测试"></a>2.1 插入测试</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">USE testdb;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入单条记录</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (id, order_no, user_id, amount, status)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;ORD001&#x27;</span>, <span class="number">100</span>, <span class="number">199.99</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入多条记录</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (id, order_no, user_id, amount, status) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">2</span>, <span class="string">&#x27;ORD002&#x27;</span>, <span class="number">101</span>, <span class="number">299.99</span>, <span class="number">1</span>),</span><br><span class="line">(<span class="number">3</span>, <span class="string">&#x27;ORD003&#x27;</span>, <span class="number">102</span>, <span class="number">399.99</span>, <span class="number">1</span>),</span><br><span class="line">(<span class="number">4</span>, <span class="string">&#x27;ORD004&#x27;</span>, <span class="number">103</span>, <span class="number">499.99</span>, <span class="number">1</span>),</span><br><span class="line">(<span class="number">5</span>, <span class="string">&#x27;ORD005&#x27;</span>, <span class="number">104</span>, <span class="number">599.99</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<h3 id="2-2-查询测试"><a href="#2-2-查询测试" class="headerlink" title="2.2 查询测试"></a>2.2 查询测试</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询全部数据</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 根据分片键查询（单分片）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 根据非分片键查询（全分片扫描）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> user_id <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 聚合查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> orders;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">SUM</span>(amount) <span class="keyword">FROM</span> orders;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-更新测试"><a href="#2-3-更新测试" class="headerlink" title="2.3 更新测试"></a>2.3 更新测试</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 更新单条记录</span></span><br><span class="line"><span class="keyword">UPDATE</span> orders <span class="keyword">SET</span> status <span class="operator">=</span> <span class="number">2</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 更新多条记录</span></span><br><span class="line"><span class="keyword">UPDATE</span> orders <span class="keyword">SET</span> status <span class="operator">=</span> <span class="number">3</span> <span class="keyword">WHERE</span> user_id <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 验证更新结果</span></span><br><span class="line"><span class="keyword">SELECT</span> id, status <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-删除测试"><a href="#2-4-删除测试" class="headerlink" title="2.4 删除测试"></a>2.4 删除测试</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 删除单条记录</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 验证删除结果</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> orders;</span><br></pre></td></tr></table></figure>

<h2 id="三、分片路由测试"><a href="#三、分片路由测试" class="headerlink" title="三、分片路由测试"></a>三、分片路由测试</h2><h3 id="3-1-查看执行计划"><a href="#3-1-查看执行计划" class="headerlink" title="3.1 查看执行计划"></a>3.1 查看执行计划</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看 SQL 路由</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看 SQL 执行路径</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-单分片查询"><a href="#3-2-单分片查询" class="headerlink" title="3.2 单分片查询"></a>3.2 单分片查询</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 只路由到 dn1 (假设 id=1 在 dn1)</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 只路由到 dn2 (假设 id=2 在 dn2)</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-全分片查询"><a href="#3-3-全分片查询" class="headerlink" title="3.3 全分片查询"></a>3.3 全分片查询</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 需要扫描所有分片</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> user_id <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 全分片聚合</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> orders;</span><br></pre></td></tr></table></figure>

<h2 id="四、数据分布验证"><a href="#四、数据分布验证" class="headerlink" title="四、数据分布验证"></a>四、数据分布验证</h2><h3 id="4-1-查看物理数据"><a href="#4-1-查看物理数据" class="headerlink" title="4.1 查看物理数据"></a>4.1 查看物理数据</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 登录 MySQL 查看 db1</span></span><br><span class="line">mysql <span class="operator">-</span>u mycat <span class="operator">-</span>pMyCat<span class="variable">@123</span> <span class="operator">-</span>h <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="operator">-</span>P <span class="number">3306</span></span><br><span class="line"></span><br><span class="line">USE db1;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 登录 MySQL 查看 db2</span></span><br><span class="line">USE db2;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-数据分布统计"><a href="#4-2-数据分布统计" class="headerlink" title="4.2 数据分布统计"></a>4.2 数据分布统计</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- db1 应该包含：id % 2 = 1 的数据 (1, 3, 5)</span></span><br><span class="line"><span class="comment">-- db2 应该包含：id % 2 = 0 的数据 (2, 4)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在 MyCat 验证</span></span><br><span class="line"><span class="keyword">SELECT</span> id, <span class="built_in">FLOOR</span>(id <span class="operator">%</span> <span class="number">2</span>) <span class="keyword">AS</span> shard <span class="keyword">FROM</span> orders <span class="keyword">ORDER</span> <span class="keyword">BY</span> id;</span><br></pre></td></tr></table></figure>

<h2 id="五、事务测试"><a href="#五、事务测试" class="headerlink" title="五、事务测试"></a>五、事务测试</h2><h3 id="5-1-本地事务"><a href="#5-1-本地事务" class="headerlink" title="5.1 本地事务"></a>5.1 本地事务</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 开启事务</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 执行多条 SQL</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (id, order_no, user_id, amount) <span class="keyword">VALUES</span> (<span class="number">10</span>, <span class="string">&#x27;ORD010&#x27;</span>, <span class="number">110</span>, <span class="number">100.00</span>);</span><br><span class="line"><span class="keyword">UPDATE</span> orders <span class="keyword">SET</span> status <span class="operator">=</span> <span class="number">2</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 提交事务</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 验证</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> id <span class="keyword">IN</span> (<span class="number">2</span>, <span class="number">10</span>);</span><br></pre></td></tr></table></figure>

<h3 id="5-2-事务回滚"><a href="#5-2-事务回滚" class="headerlink" title="5.2 事务回滚"></a>5.2 事务回滚</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (id, order_no, user_id, amount) <span class="keyword">VALUES</span> (<span class="number">11</span>, <span class="string">&#x27;ORD011&#x27;</span>, <span class="number">111</span>, <span class="number">110.00</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 回滚</span></span><br><span class="line"><span class="keyword">ROLLBACK</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 验证 id=11 的数据不存在</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">11</span>;</span><br></pre></td></tr></table></figure>

<h2 id="六、性能测试"><a href="#六、性能测试" class="headerlink" title="六、性能测试"></a>六、性能测试</h2><h3 id="6-1-批量插入测试"><a href="#6-1-批量插入测试" class="headerlink" title="6.1 批量插入测试"></a>6.1 批量插入测试</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 使用存储过程批量插入</span></span><br><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> batch_insert(<span class="keyword">IN</span> count <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>;</span><br><span class="line">    WHILE i <span class="operator">&lt;=</span> count DO</span><br><span class="line">        <span class="keyword">INSERT INTO</span> orders (id, order_no, user_id, amount, status)</span><br><span class="line">        <span class="keyword">VALUES</span> (i <span class="operator">+</span> <span class="number">100</span>, CONCAT(<span class="string">&#x27;ORD&#x27;</span>, LPAD(i <span class="operator">+</span> <span class="number">100</span>, <span class="number">6</span>, <span class="string">&#x27;0&#x27;</span>)), <span class="built_in">FLOOR</span>(RAND() <span class="operator">*</span> <span class="number">1000</span>), RAND() <span class="operator">*</span> <span class="number">1000</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">SET</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">END</span> WHILE;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 调用存储过程插入 1000 条数据</span></span><br><span class="line"><span class="keyword">CALL</span> batch_insert(<span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<h3 id="6-2-查询性能对比"><a href="#6-2-查询性能对比" class="headerlink" title="6.2 查询性能对比"></a>6.2 查询性能对比</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 单分片查询（快）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">101</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 全分片查询（慢）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> user_id <span class="operator">=</span> <span class="number">500</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 带 LIMIT 查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders LIMIT <span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-聚合性能"><a href="#6-3-聚合性能" class="headerlink" title="6.3 聚合性能"></a>6.3 聚合性能</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 统计各分片数据量</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> orders;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 分组统计</span></span><br><span class="line"><span class="keyword">SELECT</span> status, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> orders <span class="keyword">GROUP</span> <span class="keyword">BY</span> status;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 排序查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">ORDER</span> <span class="keyword">BY</span> created_at <span class="keyword">DESC</span> LIMIT <span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<h2 id="七、MyCat-监控测试"><a href="#七、MyCat-监控测试" class="headerlink" title="七、MyCat 监控测试"></a>七、MyCat 监控测试</h2><h3 id="7-1-查看服务器状态"><a href="#7-1-查看服务器状态" class="headerlink" title="7.1 查看服务器状态"></a>7.1 查看服务器状态</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@SERVER</span>;</span><br></pre></td></tr></table></figure>

<p><strong>输出字段</strong>：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>VERSION</td>
<td>MyCat 版本</td>
</tr>
<tr>
<td>UPTIME</td>
<td>运行时间</td>
</tr>
<tr>
<td>USED_HEAP</td>
<td>使用的堆内存</td>
</tr>
</tbody></table>
<h3 id="7-2-查看数据源状态"><a href="#7-2-查看数据源状态" class="headerlink" title="7.2 查看数据源状态"></a>7.2 查看数据源状态</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@DATASOURCE</span>;</span><br></pre></td></tr></table></figure>

<p><strong>输出字段</strong>：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>DATA_HOST</td>
<td>数据主机名</td>
</tr>
<tr>
<td>ACTIVE</td>
<td>活跃连接数</td>
</tr>
<tr>
<td>IDLE</td>
<td>空闲连接数</td>
</tr>
</tbody></table>
<h3 id="7-3-查看-SQL-统计"><a href="#7-3-查看-SQL-统计" class="headerlink" title="7.3 查看 SQL 统计"></a>7.3 查看 SQL 统计</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@SQL</span>;</span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@SQL</span>.SLOW;</span><br></pre></td></tr></table></figure>

<h3 id="7-4-查看连接池状态"><a href="#7-4-查看连接池状态" class="headerlink" title="7.4 查看连接池状态"></a>7.4 查看连接池状态</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@CONNECTIONPOOL</span>;</span><br></pre></td></tr></table></figure>

<h2 id="八、故障测试"><a href="#八、故障测试" class="headerlink" title="八、故障测试"></a>八、故障测试</h2><h3 id="8-1-数据库宕机测试"><a href="#8-1-数据库宕机测试" class="headerlink" title="8.1 数据库宕机测试"></a>8.1 数据库宕机测试</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 停止 MySQL</span></span><br><span class="line">systemctl stop mysqld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 MyCat 查看状态</span></span><br><span class="line">SHOW @@DATASOURCE;</span><br><span class="line"><span class="comment"># 应该显示连接失败</span></span><br></pre></td></tr></table></figure>

<h3 id="8-2-网络中断测试"><a href="#8-2-网络中断测试" class="headerlink" title="8.2 网络中断测试"></a>8.2 网络中断测试</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 模拟网络中断</span></span><br><span class="line">iptables -A OUTPUT -d 127.0.0.1 -p tcp --dport 3306 -j DROP</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试查询</span></span><br><span class="line">SELECT * FROM orders;</span><br><span class="line"><span class="comment"># 应该超时或失败</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 恢复网络</span></span><br><span class="line">iptables -D OUTPUT -d 127.0.0.1 -p tcp --dport 3306 -j DROP</span><br></pre></td></tr></table></figure>

<h3 id="8-3-恢复测试"><a href="#8-3-恢复测试" class="headerlink" title="8.3 恢复测试"></a>8.3 恢复测试</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 重启 MySQL</span></span><br><span class="line">systemctl start mysqld</span><br><span class="line"></span><br><span class="line"><span class="comment"># MyCat 应该自动重连</span></span><br><span class="line">SHOW @@DATASOURCE;</span><br></pre></td></tr></table></figure>

<h2 id="九、测试检查清单"><a href="#九、测试检查清单" class="headerlink" title="九、测试检查清单"></a>九、测试检查清单</h2><h3 id="9-1-功能测试"><a href="#9-1-功能测试" class="headerlink" title="9.1 功能测试"></a>9.1 功能测试</h3><ul>
<li><input disabled="" type="checkbox"> 基本连接正常</li>
<li><input disabled="" type="checkbox"> 插入数据正常</li>
<li><input disabled="" type="checkbox"> 查询数据正常</li>
<li><input disabled="" type="checkbox"> 更新数据正常</li>
<li><input disabled="" type="checkbox"> 删除数据正常</li>
<li><input disabled="" type="checkbox"> 事务正常</li>
</ul>
<h3 id="9-2-分片测试"><a href="#9-2-分片测试" class="headerlink" title="9.2 分片测试"></a>9.2 分片测试</h3><ul>
<li><input disabled="" type="checkbox"> 单分片查询正确</li>
<li><input disabled="" type="checkbox"> 全分片查询正确</li>
<li><input disabled="" type="checkbox"> 数据分布正确</li>
<li><input disabled="" type="checkbox"> 聚合查询正确</li>
</ul>
<h3 id="9-3-性能测试"><a href="#9-3-性能测试" class="headerlink" title="9.3 性能测试"></a>9.3 性能测试</h3><ul>
<li><input disabled="" type="checkbox"> 批量插入性能</li>
<li><input disabled="" type="checkbox"> 查询性能</li>
<li><input disabled="" type="checkbox"> 连接池正常</li>
</ul>
<h3 id="9-4-故障测试"><a href="#9-4-故障测试" class="headerlink" title="9.4 故障测试"></a>9.4 故障测试</h3><ul>
<li><input disabled="" type="checkbox"> 数据库宕机检测</li>
<li><input disabled="" type="checkbox"> 自动重连正常</li>
</ul>
<h2 id="十、小结"><a href="#十、小结" class="headerlink" title="十、小结"></a>十、小结</h2><h3 id="测试总结"><a href="#测试总结" class="headerlink" title="测试总结"></a>测试总结</h3><p>通过上述测试，验证了 MyCat 的以下功能：</p>
<ol>
<li><strong>基本 CRUD</strong>：插入、查询、更新、删除正常</li>
<li><strong>分片路由</strong>：单分片、全分片查询正确</li>
<li><strong>数据分布</strong>：数据按规则分布到各分片</li>
<li><strong>事务支持</strong>：本地事务正常</li>
<li><strong>监控功能</strong>：可以查看服务器、数据源状态</li>
</ol>
<h3 id="常用测试命令"><a href="#常用测试命令" class="headerlink" title="常用测试命令"></a>常用测试命令</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看状态</span></span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@SERVER</span>;</span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@DATASOURCE</span>;</span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@SQL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看路由</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 测试查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>下一篇</strong>：[MySQL 运维篇 04-03 MyCat 配置详解](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 04-03 MyCat 配置详解&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 运维篇 04-01 MyCat 入门](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 04-01 MyCat 入门&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 运维篇</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>实战</tag>
        <tag>MyCat</tag>
        <tag>测试</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 运维篇 04-03 MyCat 配置详解</title>
    <url>/2026/02/24/MySQL%20%E8%BF%90%E7%BB%B4%E7%AF%87%2004-03%20MyCat%20%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<h1 id="MySQL-运维篇-04-03-MyCat-配置详解"><a href="#MySQL-运维篇-04-03-MyCat-配置详解" class="headerlink" title="MySQL 运维篇 04-03 MyCat 配置详解"></a>MySQL 运维篇 04-03 MyCat 配置详解</h1><p>本文将详细讲解 MyCat 的各个配置文件，包括 server.yml、schema.yml、datasource.yml 和 rule.yml 的完整配置说明。</p>
<h2 id="一、配置文件概述"><a href="#一、配置文件概述" class="headerlink" title="一、配置文件概述"></a>一、配置文件概述</h2><h3 id="1-1-配置文件位置"><a href="#1-1-配置文件位置" class="headerlink" title="1.1 配置文件位置"></a>1.1 配置文件位置</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/opt/mycat/conf/</span><br><span class="line">├── server.yml         # 主配置文件</span><br><span class="line">├── schema.yml         # Schema 配置</span><br><span class="line">├── datasource.yml     # 数据源配置</span><br><span class="line">├── rule.yml           # 分片规则配置</span><br><span class="line">├── sequence.yml       # 全局序列配置</span><br><span class="line">└── log4j2.xml         # 日志配置</span><br></pre></td></tr></table></figure>

<h3 id="1-2-配置加载顺序"><a href="#1-2-配置加载顺序" class="headerlink" title="1.2 配置加载顺序"></a>1.2 配置加载顺序</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. server.yml (系统配置)</span><br><span class="line">2. datasource.yml (数据源)</span><br><span class="line">3. schema.yml (Schema 和表)</span><br><span class="line">4. rule.yml (分片规则)</span><br></pre></td></tr></table></figure>

<h2 id="二、server-yml-详解"><a href="#二、server-yml-详解" class="headerlink" title="二、server.yml 详解"></a>二、server.yml 详解</h2><h3 id="2-1-完整配置示例"><a href="#2-1-完整配置示例" class="headerlink" title="2.1 完整配置示例"></a>2.1 完整配置示例</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># MyCat 服务器配置</span></span><br><span class="line"><span class="attr">system:</span></span><br><span class="line">  <span class="comment"># 系统参数</span></span><br><span class="line">  <span class="attr">schemaChecksum:</span> <span class="literal">false</span>           <span class="comment"># 是否检查 schema 配置 checksum</span></span><br><span class="line">  <span class="attr">checkTableType:</span> <span class="number">0</span>               <span class="comment"># 检查表类型 0=不检查 1=检查</span></span><br><span class="line">  <span class="attr">noneBlockHeartbeat:</span> <span class="number">0</span>           <span class="comment"># 非阻塞心跳 0=阻塞 1=非阻塞</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 连接参数</span></span><br><span class="line">  <span class="attr">maxCon:</span> <span class="number">2000</span>                    <span class="comment"># 最大连接数</span></span><br><span class="line">  <span class="attr">defaultMaxCon:</span> <span class="number">1000</span>             <span class="comment"># 默认最大连接数</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 超时参数</span></span><br><span class="line">  <span class="attr">connectTimeout:</span> <span class="number">10000</span>           <span class="comment"># 连接超时 (ms)</span></span><br><span class="line">  <span class="attr">idleTimeout:</span> <span class="number">30000000</span>           <span class="comment"># 空闲超时 (ms)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 事务参数</span></span><br><span class="line">  <span class="attr">transactionLog:</span> <span class="number">0</span>               <span class="comment"># 事务日志 0=关闭 1=开启</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 字符集</span></span><br><span class="line">  <span class="attr">charset:</span> <span class="string">utf8mb4</span>                <span class="comment"># 默认字符集</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 端口</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8066</span>                      <span class="comment"># MySQL 协议端口</span></span><br><span class="line">  <span class="attr">managePort:</span> <span class="number">9066</span>                <span class="comment"># 管理端口</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户配置</span></span><br><span class="line"><span class="attr">users:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">root</span>                    <span class="comment"># 用户名</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span>              <span class="comment"># 密码</span></span><br><span class="line">    <span class="attr">schemas:</span>                      <span class="comment"># 可访问的 schema 列表</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">testdb</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">testdb2</span></span><br><span class="line">    <span class="attr">readOnly:</span> <span class="literal">false</span>               <span class="comment"># 是否只读</span></span><br><span class="line">    <span class="attr">maxCon:</span> <span class="number">100</span>                   <span class="comment"># 用户最大连接数</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">readonly</span>                <span class="comment"># 只读用户</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">schemas:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">testdb</span></span><br><span class="line">    <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 防火墙配置</span></span><br><span class="line"><span class="attr">firewall:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">false</span>                  <span class="comment"># 是否启用防火墙</span></span><br><span class="line">  <span class="attr">whitelist:</span>                      <span class="comment"># 白名单</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.1</span><span class="string">.*</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">10.0</span><span class="number">.0</span><span class="string">.*</span></span><br><span class="line">  <span class="attr">blacklist:</span>                      <span class="comment"># 黑名单</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.2</span><span class="number">.100</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-系统参数说明"><a href="#2-2-系统参数说明" class="headerlink" title="2.2 系统参数说明"></a>2.2 系统参数说明</h3><table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>默认值</th>
</tr>
</thead>
<tbody><tr>
<td>schemaChecksum</td>
<td>检查 schema 配置 checksum</td>
<td>false</td>
</tr>
<tr>
<td>checkTableType</td>
<td>检查表类型</td>
<td>0</td>
</tr>
<tr>
<td>maxCon</td>
<td>最大连接数</td>
<td>2000</td>
</tr>
<tr>
<td>connectTimeout</td>
<td>连接超时 (ms)</td>
<td>10000</td>
</tr>
<tr>
<td>idleTimeout</td>
<td>空闲超时 (ms)</td>
<td>30000000</td>
</tr>
<tr>
<td>charset</td>
<td>默认字符集</td>
<td>utf8mb4</td>
</tr>
<tr>
<td>port</td>
<td>MySQL 协议端口</td>
<td>8066</td>
</tr>
<tr>
<td>managePort</td>
<td>管理端口</td>
<td>9066</td>
</tr>
</tbody></table>
<h3 id="2-3-用户配置说明"><a href="#2-3-用户配置说明" class="headerlink" title="2.3 用户配置说明"></a>2.3 用户配置说明</h3><table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>必填</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>用户名</td>
<td>是</td>
</tr>
<tr>
<td>password</td>
<td>密码</td>
<td>是</td>
</tr>
<tr>
<td>schemas</td>
<td>可访问的 schema 列表</td>
<td>是</td>
</tr>
<tr>
<td>readOnly</td>
<td>是否只读</td>
<td>否</td>
</tr>
<tr>
<td>maxCon</td>
<td>用户最大连接数</td>
<td>否</td>
</tr>
</tbody></table>
<h2 id="三、schema-yml-详解"><a href="#三、schema-yml-详解" class="headerlink" title="三、schema.yml 详解"></a>三、schema.yml 详解</h2><h3 id="3-1-完整配置示例"><a href="#3-1-完整配置示例" class="headerlink" title="3.1 完整配置示例"></a>3.1 完整配置示例</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">schemas:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">testdb</span>                    <span class="comment"># 逻辑库名</span></span><br><span class="line">    <span class="attr">tables:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">orders</span>                <span class="comment"># 逻辑表名</span></span><br><span class="line">        <span class="attr">primaryKey:</span> <span class="string">id</span>              <span class="comment"># 主键字段</span></span><br><span class="line">        <span class="attr">dataNodes:</span> <span class="string">dn1,dn2,dn3,dn4</span>  <span class="comment"># 数据节点</span></span><br><span class="line">        <span class="attr">rule:</span> <span class="string">mod-long</span>              <span class="comment"># 分片规则</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">order_detail</span>          <span class="comment"># 另一个表</span></span><br><span class="line">        <span class="attr">primaryKey:</span> <span class="string">id</span></span><br><span class="line">        <span class="attr">dataNodes:</span> <span class="string">dn1,dn2</span></span><br><span class="line">        <span class="attr">rule:</span> <span class="string">mod-long</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">category</span>              <span class="comment"># 全局表</span></span><br><span class="line">        <span class="attr">primaryKey:</span> <span class="string">id</span></span><br><span class="line">        <span class="attr">dataNodes:</span> <span class="string">dn1</span>              <span class="comment"># 只在一个节点</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">user</span>                  <span class="comment"># 绑定表</span></span><br><span class="line">        <span class="attr">primaryKey:</span> <span class="string">id</span></span><br><span class="line">        <span class="attr">dataNodes:</span> <span class="string">dn1,dn2,dn3,dn4</span></span><br><span class="line">        <span class="attr">rule:</span> <span class="string">mod-long</span></span><br><span class="line">        <span class="attr">parentPrimaryKey:</span> <span class="string">user_id</span>   <span class="comment"># 绑定到 orders 表</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-表配置说明"><a href="#3-2-表配置说明" class="headerlink" title="3.2 表配置说明"></a>3.2 表配置说明</h3><table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>必填</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>逻辑表名</td>
<td>是</td>
</tr>
<tr>
<td>primaryKey</td>
<td>主键字段</td>
<td>是</td>
</tr>
<tr>
<td>dataNodes</td>
<td>数据节点列表</td>
<td>是</td>
</tr>
<tr>
<td>rule</td>
<td>分片规则名</td>
<td>是</td>
</tr>
<tr>
<td>parentPrimaryKey</td>
<td>绑定表的主键</td>
<td>否</td>
</tr>
</tbody></table>
<h3 id="3-3-表类型"><a href="#3-3-表类型" class="headerlink" title="3.3 表类型"></a>3.3 表类型</h3><p><strong>分片表</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">orders</span></span><br><span class="line">  <span class="attr">dataNodes:</span> <span class="string">dn1,dn2,dn3,dn4</span></span><br><span class="line">  <span class="attr">rule:</span> <span class="string">mod-long</span></span><br></pre></td></tr></table></figure>

<p><strong>全局表</strong>（所有节点都有相同数据）：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">category</span></span><br><span class="line">  <span class="attr">dataNodes:</span> <span class="string">dn1,dn2,dn3,dn4</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">global</span></span><br></pre></td></tr></table></figure>

<p><strong>单节点表</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">  <span class="attr">dataNodes:</span> <span class="string">dn1</span></span><br></pre></td></tr></table></figure>

<h2 id="四、datasource-yml-详解"><a href="#四、datasource-yml-详解" class="headerlink" title="四、datasource.yml 详解"></a>四、datasource.yml 详解</h2><h3 id="4-1-完整配置示例"><a href="#4-1-完整配置示例" class="headerlink" title="4.1 完整配置示例"></a>4.1 完整配置示例</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 数据节点配置</span></span><br><span class="line"><span class="attr">dataNodes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn1</span>                       <span class="comment"># 节点名称</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span>                 <span class="comment"># 数据主机名</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">db1</span>                   <span class="comment"># 数据库名</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn2</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">db2</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn3</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host2</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">db1</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn4</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host2</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">db2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据主机配置</span></span><br><span class="line"><span class="attr">dataHosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">host1</span>                     <span class="comment"># 主机名称</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">mysql</span>                     <span class="comment"># 数据库类型</span></span><br><span class="line">    <span class="attr">maxCon:</span> <span class="number">1000</span>                    <span class="comment"># 最大连接数</span></span><br><span class="line">    <span class="attr">minCon:</span> <span class="number">10</span>                      <span class="comment"># 最小连接数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 心跳配置</span></span><br><span class="line">    <span class="attr">heartbeat:</span></span><br><span class="line">      <span class="attr">statement:</span> <span class="string">select</span> <span class="string">user()</span>      <span class="comment"># 心跳 SQL</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="number">10000</span>                <span class="comment"># 超时 (ms)</span></span><br><span class="line">      <span class="attr">maxRetryCount:</span> <span class="number">3</span>              <span class="comment"># 最大重试次数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 写主机</span></span><br><span class="line">    <span class="attr">writeHosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">master1</span>               <span class="comment"># 主机名称</span></span><br><span class="line">        <span class="attr">url:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.100</span><span class="string">:3306</span>     <span class="comment"># 连接地址</span></span><br><span class="line">        <span class="attr">user:</span> <span class="string">mycat</span>                 <span class="comment"># 用户名</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">MyCat@123</span>         <span class="comment"># 密码</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">1.0</span>                 <span class="comment"># 权重</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 读主机（读写分离）</span></span><br><span class="line">    <span class="attr">readHosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">slave1</span></span><br><span class="line">        <span class="attr">url:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.101</span><span class="string">:3306</span></span><br><span class="line">        <span class="attr">user:</span> <span class="string">mycat</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">MyCat@123</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">host2</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">maxCon:</span> <span class="number">1000</span></span><br><span class="line">    <span class="attr">minCon:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">heartbeat:</span></span><br><span class="line">      <span class="attr">statement:</span> <span class="string">select</span> <span class="string">user()</span></span><br><span class="line">    <span class="attr">writeHosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">master2</span></span><br><span class="line">        <span class="attr">url:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.102</span><span class="string">:3306</span></span><br><span class="line">        <span class="attr">user:</span> <span class="string">mycat</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">MyCat@123</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-数据节点参数"><a href="#4-2-数据节点参数" class="headerlink" title="4.2 数据节点参数"></a>4.2 数据节点参数</h3><table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>必填</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>节点名称</td>
<td>是</td>
</tr>
<tr>
<td>dataHost</td>
<td>数据主机名</td>
<td>是</td>
</tr>
<tr>
<td>database</td>
<td>数据库名</td>
<td>是</td>
</tr>
</tbody></table>
<h3 id="4-3-数据主机参数"><a href="#4-3-数据主机参数" class="headerlink" title="4.3 数据主机参数"></a>4.3 数据主机参数</h3><table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>默认值</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>主机名称</td>
<td>-</td>
</tr>
<tr>
<td>type</td>
<td>数据库类型</td>
<td>mysql</td>
</tr>
<tr>
<td>maxCon</td>
<td>最大连接数</td>
<td>1000</td>
</tr>
<tr>
<td>minCon</td>
<td>最小连接数</td>
<td>10</td>
</tr>
<tr>
<td>balance</td>
<td>负载均衡类型</td>
<td>0</td>
</tr>
<tr>
<td>writeType</td>
<td>写入类型</td>
<td>0</td>
</tr>
</tbody></table>
<h3 id="4-4-balance-配置"><a href="#4-4-balance-配置" class="headerlink" title="4.4 balance 配置"></a>4.4 balance 配置</h3><table>
<thead>
<tr>
<th>值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>不开启读写分离</td>
</tr>
<tr>
<td>1</td>
<td>全部读请求发送到从库</td>
</tr>
<tr>
<td>2</td>
<td>读请求随机发送到主库或从库</td>
</tr>
<tr>
<td>3</td>
<td>读请求按比例发送到主从库</td>
</tr>
</tbody></table>
<h3 id="4-5-writeType-配置"><a href="#4-5-writeType-配置" class="headerlink" title="4.5 writeType 配置"></a>4.5 writeType 配置</h3><table>
<thead>
<tr>
<th>值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>全部写到主库</td>
</tr>
<tr>
<td>1</td>
<td>写到所有库（不常用）</td>
</tr>
</tbody></table>
<h2 id="五、rule-yml-详解"><a href="#五、rule-yml-详解" class="headerlink" title="五、rule.yml 详解"></a>五、rule.yml 详解</h2><h3 id="5-1-完整配置示例"><a href="#5-1-完整配置示例" class="headerlink" title="5.1 完整配置示例"></a>5.1 完整配置示例</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 表规则配置</span></span><br><span class="line"><span class="attr">tableRules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mod-long</span>                  <span class="comment"># 规则名称</span></span><br><span class="line">    <span class="attr">function:</span> <span class="string">mod-long</span>              <span class="comment"># 函数名称</span></span><br><span class="line">    <span class="attr">columns:</span> <span class="string">id</span>                     <span class="comment"># 分片字段</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">range-date</span></span><br><span class="line">    <span class="attr">function:</span> <span class="string">range-date</span></span><br><span class="line">    <span class="attr">columns:</span> <span class="string">created_at</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hash-id</span></span><br><span class="line">    <span class="attr">function:</span> <span class="string">hash-id</span></span><br><span class="line">    <span class="attr">columns:</span> <span class="string">user_id</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 函数配置</span></span><br><span class="line"><span class="attr">functions:</span></span><br><span class="line">  <span class="comment"># 取模分片</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mod-long</span></span><br><span class="line">    <span class="attr">className:</span> <span class="string">io.mycat.router.function.PartitionByFunction</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">count:</span> <span class="number">4</span>                      <span class="comment"># 分片数量</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 范围分片（按日期）</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">range-date</span></span><br><span class="line">    <span class="attr">className:</span> <span class="string">io.mycat.router.function.PartitionByDateRange</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">sPartionDay:</span> <span class="number">2024-01-01</span>       <span class="comment"># 起始日期</span></span><br><span class="line">      <span class="attr">datePattern:</span> <span class="string">yyyy-MM-dd</span>       <span class="comment"># 日期格式</span></span><br><span class="line">      <span class="attr">days:</span> <span class="number">30</span>                      <span class="comment"># 每 30 天一个分片</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 哈希分片</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hash-id</span></span><br><span class="line">    <span class="attr">className:</span> <span class="string">io.mycat.router.function.PartitionByHash</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">count:</span> <span class="number">4</span></span><br><span class="line">      <span class="attr">seed:</span> <span class="number">0</span>                       <span class="comment"># 哈希种子</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 字符串哈希</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">string-hash</span></span><br><span class="line">    <span class="attr">className:</span> <span class="string">io.mycat.router.function.PartitionByString</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">count:</span> <span class="number">4</span></span><br><span class="line">      <span class="attr">hashLength:</span> <span class="number">16</span>                <span class="comment"># 哈希长度</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-常用分片函数"><a href="#5-2-常用分片函数" class="headerlink" title="5.2 常用分片函数"></a>5.2 常用分片函数</h3><table>
<thead>
<tr>
<th>函数名</th>
<th>类名</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>mod-long</td>
<td>PartitionByFunction</td>
<td>取模分片</td>
</tr>
<tr>
<td>hash-id</td>
<td>PartitionByHash</td>
<td>哈希分片</td>
</tr>
<tr>
<td>range-date</td>
<td>PartitionByDateRange</td>
<td>日期范围</td>
</tr>
<tr>
<td>string-hash</td>
<td>PartitionByString</td>
<td>字符串哈希</td>
</tr>
<tr>
<td>month</td>
<td>PartitionByMonth</td>
<td>月份分片</td>
</tr>
</tbody></table>
<h3 id="5-3-分片规则选择"><a href="#5-3-分片规则选择" class="headerlink" title="5.3 分片规则选择"></a>5.3 分片规则选择</h3><table>
<thead>
<tr>
<th>场景</th>
<th>推荐规则</th>
</tr>
</thead>
<tbody><tr>
<td>数值 ID</td>
<td>mod-long</td>
</tr>
<tr>
<td>日期数据</td>
<td>range-date</td>
</tr>
<tr>
<td>字符串 ID</td>
<td>string-hash</td>
</tr>
<tr>
<td>月份数据</td>
<td>month</td>
</tr>
</tbody></table>
<h2 id="六、sequence-yml-详解"><a href="#六、sequence-yml-详解" class="headerlink" title="六、sequence.yml 详解"></a>六、sequence.yml 详解</h2><h3 id="6-1-全局序列配置"><a href="#6-1-全局序列配置" class="headerlink" title="6.1 全局序列配置"></a>6.1 全局序列配置</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 全局序列配置</span></span><br><span class="line"><span class="attr">sequences:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">orders_seq</span>                <span class="comment"># 序列名称</span></span><br><span class="line">    <span class="attr">className:</span> <span class="string">io.mycat.sequence.db.DBSequence</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">db:</span> <span class="string">db1</span>                       <span class="comment"># 存储序列的数据库</span></span><br><span class="line">      <span class="attr">table:</span> <span class="string">sequence_info</span>          <span class="comment"># 序列表</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 序列表结构</span></span><br><span class="line"><span class="comment"># CREATE TABLE sequence_info (</span></span><br><span class="line"><span class="comment">#     name VARCHAR(50) PRIMARY KEY,</span></span><br><span class="line"><span class="comment">#     current_value BIGINT,</span></span><br><span class="line"><span class="comment">#     increment INT</span></span><br><span class="line"><span class="comment"># );</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-使用全局序列"><a href="#6-2-使用全局序列" class="headerlink" title="6.2 使用全局序列"></a>6.2 使用全局序列</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 在 INSERT 时使用</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (id, order_no, user_id)</span><br><span class="line"><span class="keyword">VALUES</span> (NEXT <span class="keyword">VALUE</span> <span class="keyword">FOR</span> orders_seq, <span class="string">&#x27;ORD001&#x27;</span>, <span class="number">100</span>);</span><br></pre></td></tr></table></figure>

<h2 id="七、配置实例"><a href="#七、配置实例" class="headerlink" title="七、配置实例"></a>七、配置实例</h2><h3 id="7-1-一主一从分片配置"><a href="#7-1-一主一从分片配置" class="headerlink" title="7.1 一主一从分片配置"></a>7.1 一主一从分片配置</h3><p><strong>server.yml</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">users:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">schemas:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">testdb</span></span><br></pre></td></tr></table></figure>

<p><strong>schema.yml</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">schemas:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">testdb</span></span><br><span class="line">    <span class="attr">tables:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">orders</span></span><br><span class="line">        <span class="attr">primaryKey:</span> <span class="string">id</span></span><br><span class="line">        <span class="attr">dataNodes:</span> <span class="string">dn1,dn2</span></span><br><span class="line">        <span class="attr">rule:</span> <span class="string">mod-long</span></span><br></pre></td></tr></table></figure>

<p><strong>datasource.yml</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">dataNodes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn1</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">db1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn2</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">db2</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dataHosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">maxCon:</span> <span class="number">1000</span></span><br><span class="line">    <span class="attr">minCon:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">heartbeat:</span></span><br><span class="line">      <span class="attr">statement:</span> <span class="string">select</span> <span class="string">user()</span></span><br><span class="line">    <span class="attr">writeHosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">master</span></span><br><span class="line">        <span class="attr">url:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.100</span><span class="string">:3306</span></span><br><span class="line">        <span class="attr">user:</span> <span class="string">mycat</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">MyCat@123</span></span><br><span class="line">    <span class="attr">readHosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">slave</span></span><br><span class="line">        <span class="attr">url:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.101</span><span class="string">:3306</span></span><br><span class="line">        <span class="attr">user:</span> <span class="string">mycat</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">MyCat@123</span></span><br></pre></td></tr></table></figure>

<p><strong>rule.yml</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tableRules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mod-long</span></span><br><span class="line">    <span class="attr">function:</span> <span class="string">mod-long</span></span><br><span class="line">    <span class="attr">columns:</span> <span class="string">id</span></span><br><span class="line"></span><br><span class="line"><span class="attr">functions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mod-long</span></span><br><span class="line">    <span class="attr">className:</span> <span class="string">io.mycat.router.function.PartitionByFunction</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">count:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>

<h2 id="八、配置验证"><a href="#八、配置验证" class="headerlink" title="八、配置验证"></a>八、配置验证</h2><h3 id="8-1-检查配置语法"><a href="#8-1-检查配置语法" class="headerlink" title="8.1 检查配置语法"></a>8.1 检查配置语法</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动前检查配置文件</span></span><br><span class="line"><span class="built_in">cat</span> conf/server.yml | <span class="built_in">head</span> -50</span><br><span class="line"><span class="built_in">cat</span> conf/schema.yml</span><br><span class="line"><span class="built_in">cat</span> conf/datasource.yml</span><br><span class="line"><span class="built_in">cat</span> conf/rule.yml</span><br></pre></td></tr></table></figure>

<h3 id="8-2-测试连接"><a href="#8-2-测试连接" class="headerlink" title="8.2 测试连接"></a>8.2 测试连接</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动 MyCat</span></span><br><span class="line">bin/mycat start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接测试</span></span><br><span class="line">mysql -h 127.0.0.1 -P 8066 -u root -p</span><br></pre></td></tr></table></figure>

<h3 id="8-3-查看配置信息"><a href="#8-3-查看配置信息" class="headerlink" title="8.3 查看配置信息"></a>8.3 查看配置信息</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看数据源</span></span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@DATASOURCE</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看 Schema</span></span><br><span class="line"><span class="keyword">SHOW</span> DATABASES;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看表</span></span><br><span class="line">USE testdb;</span><br><span class="line"><span class="keyword">SHOW</span> TABLES;</span><br></pre></td></tr></table></figure>

<h2 id="九、小结"><a href="#九、小结" class="headerlink" title="九、小结"></a>九、小结</h2><h3 id="配置文件总结"><a href="#配置文件总结" class="headerlink" title="配置文件总结"></a>配置文件总结</h3><table>
<thead>
<tr>
<th>文件</th>
<th>作用</th>
<th>关键配置</th>
</tr>
</thead>
<tbody><tr>
<td>server.yml</td>
<td>系统配置</td>
<td>用户、端口、连接数</td>
</tr>
<tr>
<td>schema.yml</td>
<td>Schema 配置</td>
<td>逻辑表、数据节点</td>
</tr>
<tr>
<td>datasource.yml</td>
<td>数据源配置</td>
<td>主机、数据库、读写分离</td>
</tr>
<tr>
<td>rule.yml</td>
<td>分片规则配置</td>
<td>分片函数、分片字段</td>
</tr>
</tbody></table>
<h3 id="配置流程"><a href="#配置流程" class="headerlink" title="配置流程"></a>配置流程</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 规划分片方案</span><br><span class="line">2. 配置 datasource.yml（数据源）</span><br><span class="line">3. 配置 rule.yml（分片规则）</span><br><span class="line">4. 配置 schema.yml（Schema 和表）</span><br><span class="line">5. 配置 server.yml（用户和系统）</span><br><span class="line">6. 启动测试</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>下一篇</strong>：[MySQL 运维篇 04-04 MyCat 垂直分库](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 04-04 MyCat 垂直分库&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 运维篇 04-02 MyCat 测试](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 04-02 MyCat 测试&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 运维篇</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>MyCat</tag>
        <tag>配置文件</tag>
        <tag>详解</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 运维篇 04-05 MyCat 垂直分库测试</title>
    <url>/2026/02/24/MySQL%20%E8%BF%90%E7%BB%B4%E7%AF%87%2004-05%20MyCat%20%E5%9E%82%E7%9B%B4%E5%88%86%E5%BA%93%E6%B5%8B%E8%AF%95/</url>
    <content><![CDATA[<h1 id="MySQL-运维篇-04-05-MyCat-垂直分库测试"><a href="#MySQL-运维篇-04-05-MyCat-垂直分库测试" class="headerlink" title="MySQL 运维篇 04-05 MyCat 垂直分库测试"></a>MySQL 运维篇 04-05 MyCat 垂直分库测试</h1><p>完成垂直分库配置后，需要进行全面的测试以验证各库之间的数据隔离和跨库操作是否正常。</p>
<h2 id="一、测试环境"><a href="#一、测试环境" class="headerlink" title="一、测试环境"></a>一、测试环境</h2><h3 id="1-1-环境信息"><a href="#1-1-环境信息" class="headerlink" title="1.1 环境信息"></a>1.1 环境信息</h3><table>
<thead>
<tr>
<th>组件</th>
<th>配置</th>
</tr>
</thead>
<tbody><tr>
<td>MyCat</td>
<td>2.0</td>
</tr>
<tr>
<td>MySQL</td>
<td>8.0</td>
</tr>
<tr>
<td>主机 1</td>
<td>192.168.1.100 (user_db, order_db)</td>
</tr>
<tr>
<td>主机 2</td>
<td>192.168.1.101 (product_db)</td>
</tr>
</tbody></table>
<h3 id="1-2-数据库结构"><a href="#1-2-数据库结构" class="headerlink" title="1.2 数据库结构"></a>1.2 数据库结构</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mall_db (逻辑库)</span><br><span class="line">├── users (user_db)</span><br><span class="line">├── user_profile (user_db)</span><br><span class="line">├── orders (order_db)</span><br><span class="line">├── order_detail (order_db)</span><br><span class="line">├── products (product_db)</span><br><span class="line">└── category (product_db)</span><br></pre></td></tr></table></figure>

<h2 id="二、基础功能测试"><a href="#二、基础功能测试" class="headerlink" title="二、基础功能测试"></a>二、基础功能测试</h2><h3 id="2-1-连接测试"><a href="#2-1-连接测试" class="headerlink" title="2.1 连接测试"></a>2.1 连接测试</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 连接 MyCat</span></span><br><span class="line">mysql -h 127.0.0.1 -P 8066 -u root -p123456</span><br></pre></td></tr></table></figure>

<h3 id="2-2-查看表"><a href="#2-2-查看表" class="headerlink" title="2.2 查看表"></a>2.2 查看表</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">USE mall_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看所有表</span></span><br><span class="line"><span class="keyword">SHOW</span> TABLES;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 预期输出：</span></span><br><span class="line"># <span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"># <span class="operator">|</span> Tables_in_mall_db <span class="operator">|</span></span><br><span class="line"># <span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"># <span class="operator">|</span> users            <span class="operator">|</span></span><br><span class="line"># <span class="operator">|</span> user_profile     <span class="operator">|</span></span><br><span class="line"># <span class="operator">|</span> orders           <span class="operator">|</span></span><br><span class="line"># <span class="operator">|</span> order_detail     <span class="operator">|</span></span><br><span class="line"># <span class="operator">|</span> products         <span class="operator">|</span></span><br><span class="line"># <span class="operator">|</span> category         <span class="operator">|</span></span><br><span class="line"># <span class="operator">+</span><span class="comment">------------------+</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-表结构查看"><a href="#2-3-表结构查看" class="headerlink" title="2.3 表结构查看"></a>2.3 表结构查看</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看用户表结构</span></span><br><span class="line"><span class="keyword">DESC</span> users;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看订单表结构</span></span><br><span class="line"><span class="keyword">DESC</span> orders;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看商品表结构</span></span><br><span class="line"><span class="keyword">DESC</span> products;</span><br></pre></td></tr></table></figure>

<h2 id="三、单库操作测试"><a href="#三、单库操作测试" class="headerlink" title="三、单库操作测试"></a>三、单库操作测试</h2><h3 id="3-1-用户库测试"><a href="#3-1-用户库测试" class="headerlink" title="3.1 用户库测试"></a>3.1 用户库测试</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 插入用户</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> users (id, username, email, created_at)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;zhangsan&#x27;</span>, <span class="string">&#x27;zhang@example.com&#x27;</span>, NOW());</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> users (id, username, email, created_at)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;lisi&#x27;</span>, <span class="string">&#x27;li@example.com&#x27;</span>, NOW());</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入用户详情</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> user_profile (user_id, nickname, avatar)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;张三&#x27;</span>, <span class="string">&#x27;/avatar/1.jpg&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> user_profile (user_id, nickname, avatar)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;李四&#x27;</span>, <span class="string">&#x27;/avatar/2.jpg&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询用户</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询用户详情</span></span><br><span class="line"><span class="keyword">SELECT</span> u.<span class="operator">*</span>, p.nickname, p.avatar</span><br><span class="line"><span class="keyword">FROM</span> users u</span><br><span class="line"><span class="keyword">JOIN</span> user_profile p <span class="keyword">ON</span> u.id <span class="operator">=</span> p.user_id;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-订单库测试"><a href="#3-2-订单库测试" class="headerlink" title="3.2 订单库测试"></a>3.2 订单库测试</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 插入订单</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (id, order_no, user_id, amount, created_at)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;ORD001&#x27;</span>, <span class="number">1</span>, <span class="number">199.99</span>, NOW());</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (id, order_no, user_id, amount, created_at)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;ORD002&#x27;</span>, <span class="number">2</span>, <span class="number">299.99</span>, NOW());</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入订单明细</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> order_detail (id, order_id, product_id, quantity, price)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">99.99</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> order_detail (id, order_id, product_id, quantity, price)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">299.99</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询订单</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询订单明细</span></span><br><span class="line"><span class="keyword">SELECT</span> o.order_no, od.product_id, od.quantity, od.price</span><br><span class="line"><span class="keyword">FROM</span> orders o</span><br><span class="line"><span class="keyword">JOIN</span> order_detail od <span class="keyword">ON</span> o.id <span class="operator">=</span> od.order_id;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-商品库测试"><a href="#3-3-商品库测试" class="headerlink" title="3.3 商品库测试"></a>3.3 商品库测试</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 插入商品</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> products (id, name, price, stock)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;iPhone 15&#x27;</span>, <span class="number">7999.00</span>, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> products (id, name, price, stock)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;MacBook Pro&#x27;</span>, <span class="number">14999.00</span>, <span class="number">50</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入分类</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> category (id, name, parent_id)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;手机&#x27;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> category (id, name, parent_id)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;电脑&#x27;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询商品</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> products;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询分类</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> category;</span><br></pre></td></tr></table></figure>

<h2 id="四、跨库-JOIN-测试"><a href="#四、跨库-JOIN-测试" class="headerlink" title="四、跨库 JOIN 测试"></a>四、跨库 JOIN 测试</h2><h3 id="4-1-两库-JOIN"><a href="#4-1-两库-JOIN" class="headerlink" title="4.1 两库 JOIN"></a>4.1 两库 JOIN</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 用户 + 订单</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    o.id <span class="keyword">AS</span> order_id,</span><br><span class="line">    o.order_no,</span><br><span class="line">    o.amount,</span><br><span class="line">    u.username,</span><br><span class="line">    u.email</span><br><span class="line"><span class="keyword">FROM</span> orders o</span><br><span class="line"><span class="keyword">JOIN</span> users u <span class="keyword">ON</span> o.user_id <span class="operator">=</span> u.id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 预期结果：</span></span><br><span class="line"># order_id <span class="operator">|</span> order_no <span class="operator">|</span> amount  <span class="operator">|</span> username <span class="operator">|</span> email</span><br><span class="line"># <span class="number">1</span>        <span class="operator">|</span> ORD001   <span class="operator">|</span> <span class="number">199.99</span>  <span class="operator">|</span> zhangsan <span class="operator">|</span> zhang<span class="variable">@example</span>.com</span><br><span class="line"># <span class="number">2</span>        <span class="operator">|</span> ORD002   <span class="operator">|</span> <span class="number">299.99</span>  <span class="operator">|</span> lisi     <span class="operator">|</span> li<span class="variable">@example</span>.com</span><br></pre></td></tr></table></figure>

<h3 id="4-2-三库-JOIN"><a href="#4-2-三库-JOIN" class="headerlink" title="4.2 三库 JOIN"></a>4.2 三库 JOIN</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 订单 + 用户 + 商品</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    o.order_no,</span><br><span class="line">    u.username,</span><br><span class="line">    p.name <span class="keyword">AS</span> product_name,</span><br><span class="line">    p.price,</span><br><span class="line">    od.quantity,</span><br><span class="line">    od.quantity <span class="operator">*</span> p.price <span class="keyword">AS</span> total</span><br><span class="line"><span class="keyword">FROM</span> orders o</span><br><span class="line"><span class="keyword">JOIN</span> users u <span class="keyword">ON</span> o.user_id <span class="operator">=</span> u.id</span><br><span class="line"><span class="keyword">JOIN</span> order_detail od <span class="keyword">ON</span> o.id <span class="operator">=</span> od.order_id</span><br><span class="line"><span class="keyword">JOIN</span> products p <span class="keyword">ON</span> od.product_id <span class="operator">=</span> p.id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 预期结果：</span></span><br><span class="line"># order_no <span class="operator">|</span> username <span class="operator">|</span> product_name  <span class="operator">|</span> price   <span class="operator">|</span> quantity <span class="operator">|</span> total</span><br><span class="line"># ORD001   <span class="operator">|</span> zhangsan <span class="operator">|</span> iPhone <span class="number">15</span>     <span class="operator">|</span> <span class="number">7999.00</span> <span class="operator">|</span> <span class="number">2</span>        <span class="operator">|</span> <span class="number">15998.00</span></span><br><span class="line"># ORD002   <span class="operator">|</span> lisi     <span class="operator">|</span> MacBook Pro   <span class="operator">|</span> <span class="number">14999.00</span><span class="operator">|</span> <span class="number">1</span>        <span class="operator">|</span> <span class="number">14999.00</span></span><br></pre></td></tr></table></figure>

<h3 id="4-3-复杂查询"><a href="#4-3-复杂查询" class="headerlink" title="4.3 复杂查询"></a>4.3 复杂查询</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 统计各用户的订单金额</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    u.username,</span><br><span class="line">    <span class="built_in">COUNT</span>(o.id) <span class="keyword">AS</span> order_count,</span><br><span class="line">    <span class="built_in">SUM</span>(o.amount) <span class="keyword">AS</span> total_amount</span><br><span class="line"><span class="keyword">FROM</span> users u</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> orders o <span class="keyword">ON</span> u.id <span class="operator">=</span> o.user_id</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> u.id, u.username;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 统计各商品的销售量</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    p.name,</span><br><span class="line">    <span class="built_in">SUM</span>(od.quantity) <span class="keyword">AS</span> total_quantity</span><br><span class="line"><span class="keyword">FROM</span> products p</span><br><span class="line"><span class="keyword">JOIN</span> order_detail od <span class="keyword">ON</span> p.id <span class="operator">=</span> od.product_id</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> p.id, p.name;</span><br></pre></td></tr></table></figure>

<h2 id="五、事务测试"><a href="#五、事务测试" class="headerlink" title="五、事务测试"></a>五、事务测试</h2><h3 id="5-1-单库事务"><a href="#5-1-单库事务" class="headerlink" title="5.1 单库事务"></a>5.1 单库事务</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 用户库事务</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> users (id, username, email) <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;wangwu&#x27;</span>, <span class="string">&#x27;wang@example.com&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT INTO</span> user_profile (user_id, nickname, avatar) <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;王五&#x27;</span>, <span class="string">&#x27;/avatar/3.jpg&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 验证</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">3</span>;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-跨库事务"><a href="#5-2-跨库事务" class="headerlink" title="5.2 跨库事务"></a>5.2 跨库事务</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 跨库事务（创建用户和订单）</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 用户库</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> users (id, username, email) <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="string">&#x27;zhaoliu&#x27;</span>, <span class="string">&#x27;zhao@example.com&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 订单库</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (id, order_no, user_id, amount) <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;ORD003&#x27;</span>, <span class="number">4</span>, <span class="number">399.99</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 验证</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">3</span>;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：跨库事务的支持取决于 MyCat 版本和配置。</p>
<h2 id="六、数据分布验证"><a href="#六、数据分布验证" class="headerlink" title="六、数据分布验证"></a>六、数据分布验证</h2><h3 id="6-1-查看物理数据"><a href="#6-1-查看物理数据" class="headerlink" title="6.1 查看物理数据"></a>6.1 查看物理数据</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在 user_db 验证</span></span><br><span class="line">mysql -u mycat -p -h 192.168.1.100</span><br><span class="line">USE user_db;</span><br><span class="line">SHOW TABLES;</span><br><span class="line">SELECT * FROM <span class="built_in">users</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 order_db 验证</span></span><br><span class="line">USE order_db;</span><br><span class="line">SHOW TABLES;</span><br><span class="line">SELECT * FROM orders;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 product_db 验证</span></span><br><span class="line">mysql -u mycat -p -h 192.168.1.101</span><br><span class="line">USE product_db;</span><br><span class="line">SHOW TABLES;</span><br><span class="line">SELECT * FROM products;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-数据一致性检查"><a href="#6-2-数据一致性检查" class="headerlink" title="6.2 数据一致性检查"></a>6.2 数据一致性检查</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 在 MyCat 查询总数</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> users;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> orders;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> products;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在物理库查询总数</span></span><br><span class="line"><span class="comment">-- 验证数据一致</span></span><br></pre></td></tr></table></figure>

<h2 id="七、性能测试"><a href="#七、性能测试" class="headerlink" title="七、性能测试"></a>七、性能测试</h2><h3 id="7-1-单库查询性能"><a href="#7-1-单库查询性能" class="headerlink" title="7.1 单库查询性能"></a>7.1 单库查询性能</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 用户库查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 订单库查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 商品库查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> products <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h3 id="7-2-跨库查询性能"><a href="#7-2-跨库查询性能" class="headerlink" title="7.2 跨库查询性能"></a>7.2 跨库查询性能</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 两库 JOIN 计时</span></span><br><span class="line"><span class="keyword">SELECT</span> SQL_NO_CACHE</span><br><span class="line">    o.order_no, u.username</span><br><span class="line"><span class="keyword">FROM</span> orders o</span><br><span class="line"><span class="keyword">JOIN</span> users u <span class="keyword">ON</span> o.user_id <span class="operator">=</span> u.id</span><br><span class="line"><span class="keyword">WHERE</span> o.id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 三库 JOIN 计时</span></span><br><span class="line"><span class="keyword">SELECT</span> SQL_NO_CACHE</span><br><span class="line">    o.order_no, u.username, p.name</span><br><span class="line"><span class="keyword">FROM</span> orders o</span><br><span class="line"><span class="keyword">JOIN</span> users u <span class="keyword">ON</span> o.user_id <span class="operator">=</span> u.id</span><br><span class="line"><span class="keyword">JOIN</span> order_detail od <span class="keyword">ON</span> o.id <span class="operator">=</span> od.order_id</span><br><span class="line"><span class="keyword">JOIN</span> products p <span class="keyword">ON</span> od.product_id <span class="operator">=</span> p.id</span><br><span class="line"><span class="keyword">WHERE</span> o.id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h3 id="7-3-批量插入测试"><a href="#7-3-批量插入测试" class="headerlink" title="7.3 批量插入测试"></a>7.3 批量插入测试</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 批量插入用户</span></span><br><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> batch_insert_users(<span class="keyword">IN</span> count <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>;</span><br><span class="line">    WHILE i <span class="operator">&lt;=</span> count DO</span><br><span class="line">        <span class="keyword">INSERT INTO</span> users (id, username, email)</span><br><span class="line">        <span class="keyword">VALUES</span> (i <span class="operator">+</span> <span class="number">100</span>, CONCAT(<span class="string">&#x27;user_&#x27;</span>, i), CONCAT(<span class="string">&#x27;user&#x27;</span>, i, <span class="string">&#x27;@example.com&#x27;</span>));</span><br><span class="line">        <span class="keyword">SET</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">END</span> WHILE;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CALL</span> batch_insert_users(<span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<h2 id="八、监控测试"><a href="#八、监控测试" class="headerlink" title="八、监控测试"></a>八、监控测试</h2><h3 id="8-1-查看-MyCat-状态"><a href="#8-1-查看-MyCat-状态" class="headerlink" title="8.1 查看 MyCat 状态"></a>8.1 查看 MyCat 状态</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看服务器状态</span></span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@SERVER</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看数据源状态</span></span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@DATASOURCE</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看各库连接数</span></span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@CONNECTIONPOOL</span>;</span><br></pre></td></tr></table></figure>

<h3 id="8-2-查看-SQL-统计"><a href="#8-2-查看-SQL-统计" class="headerlink" title="8.2 查看 SQL 统计"></a>8.2 查看 SQL 统计</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看 SQL 执行统计</span></span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@SQL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看慢查询</span></span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@SLOW</span>;</span><br></pre></td></tr></table></figure>

<h3 id="8-3-查看各库状态"><a href="#8-3-查看各库状态" class="headerlink" title="8.3 查看各库状态"></a>8.3 查看各库状态</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看 user_db 状态</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.SCHEMATA <span class="keyword">WHERE</span> SCHEMA_NAME <span class="operator">=</span> <span class="string">&#x27;user_db&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看各数据源</span></span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@DATASOURCE</span> <span class="keyword">WHERE</span> NAME <span class="operator">=</span> <span class="string">&#x27;dn_user&#x27;</span>;</span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@DATASOURCE</span> <span class="keyword">WHERE</span> NAME <span class="operator">=</span> <span class="string">&#x27;dn_order&#x27;</span>;</span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@DATASOURCE</span> <span class="keyword">WHERE</span> NAME <span class="operator">=</span> <span class="string">&#x27;dn_product&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="九、故障测试"><a href="#九、故障测试" class="headerlink" title="九、故障测试"></a>九、故障测试</h2><h3 id="9-1-单库故障"><a href="#9-1-单库故障" class="headerlink" title="9.1 单库故障"></a>9.1 单库故障</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 停止 product_db 所在的主机</span></span><br><span class="line"><span class="comment"># 在 MyCat 查看状态</span></span><br><span class="line"></span><br><span class="line">SHOW @@DATASOURCE;</span><br><span class="line"><span class="comment"># dn_product 应该显示连接失败</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试查询</span></span><br><span class="line">SELECT * FROM products;</span><br><span class="line"><span class="comment"># 应该报错或超时</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 恢复后</span></span><br><span class="line">SHOW @@DATASOURCE;</span><br><span class="line"><span class="comment"># 应该自动重连</span></span><br></pre></td></tr></table></figure>

<h3 id="9-2-恢复测试"><a href="#9-2-恢复测试" class="headerlink" title="9.2 恢复测试"></a>9.2 恢复测试</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 重启 MySQL</span></span><br><span class="line">systemctl start mysqld</span><br><span class="line"></span><br><span class="line"><span class="comment"># MyCat 应该自动重连</span></span><br><span class="line">SHOW @@DATASOURCE;</span><br></pre></td></tr></table></figure>

<h2 id="十、测试检查清单"><a href="#十、测试检查清单" class="headerlink" title="十、测试检查清单"></a>十、测试检查清单</h2><h3 id="10-1-功能测试"><a href="#10-1-功能测试" class="headerlink" title="10.1 功能测试"></a>10.1 功能测试</h3><ul>
<li><input disabled="" type="checkbox"> 单库 CRUD 正常</li>
<li><input disabled="" type="checkbox"> 跨库 JOIN 正常</li>
<li><input disabled="" type="checkbox"> 跨库事务正常</li>
<li><input disabled="" type="checkbox"> 数据分布正确</li>
</ul>
<h3 id="10-2-性能测试"><a href="#10-2-性能测试" class="headerlink" title="10.2 性能测试"></a>10.2 性能测试</h3><ul>
<li><input disabled="" type="checkbox"> 单库查询性能</li>
<li><input disabled="" type="checkbox"> 跨库查询性能</li>
<li><input disabled="" type="checkbox"> 批量插入性能</li>
</ul>
<h3 id="10-3-监控测试"><a href="#10-3-监控测试" class="headerlink" title="10.3 监控测试"></a>10.3 监控测试</h3><ul>
<li><input disabled="" type="checkbox"> 服务器状态正常</li>
<li><input disabled="" type="checkbox"> 数据源状态正常</li>
<li><input disabled="" type="checkbox"> SQL 统计正常</li>
</ul>
<h3 id="10-4-故障测试"><a href="#10-4-故障测试" class="headerlink" title="10.4 故障测试"></a>10.4 故障测试</h3><ul>
<li><input disabled="" type="checkbox"> 单库故障检测</li>
<li><input disabled="" type="checkbox"> 自动重连正常</li>
</ul>
<h2 id="十一、小结"><a href="#十一、小结" class="headerlink" title="十一、小结"></a>十一、小结</h2><h3 id="测试总结"><a href="#测试总结" class="headerlink" title="测试总结"></a>测试总结</h3><p>通过上述测试，验证了 MyCat 垂直分库的以下功能：</p>
<ol>
<li><strong>单库操作</strong>：各库 CRUD 正常</li>
<li><strong>跨库 JOIN</strong>：MyCat 自动处理跨库 JOIN</li>
<li><strong>数据隔离</strong>：各库数据独立存储</li>
<li><strong>监控功能</strong>：可以查看各库状态</li>
</ol>
<h3 id="垂直分库适用场景"><a href="#垂直分库适用场景" class="headerlink" title="垂直分库适用场景"></a>垂直分库适用场景</h3><table>
<thead>
<tr>
<th>场景</th>
<th>推荐</th>
</tr>
</thead>
<tbody><tr>
<td>业务模块清晰</td>
<td>✓</td>
</tr>
<tr>
<td>表数量过多</td>
<td>✓</td>
</tr>
<tr>
<td>需要独立扩展</td>
<td>✓</td>
</tr>
<tr>
<td>频繁跨库 JOIN</td>
<td>✗</td>
</tr>
</tbody></table>
<hr>
<p><strong>下一篇</strong>：[MySQL 运维篇 04-06 MyCat 水平分表](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 04-06 MyCat 水平分表&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 运维篇 04-04 MyCat 垂直分库](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 04-04 MyCat 垂直分库&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 运维篇</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>MyCat</tag>
        <tag>测试</tag>
        <tag>垂直分库</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 运维篇 04-06 MyCat 水平分表</title>
    <url>/2026/02/24/MySQL%20%E8%BF%90%E7%BB%B4%E7%AF%87%2004-06%20MyCat%20%E6%B0%B4%E5%B9%B3%E5%88%86%E8%A1%A8/</url>
    <content><![CDATA[<h1 id="MySQL-运维篇-04-06-MyCat-水平分表"><a href="#MySQL-运维篇-04-06-MyCat-水平分表" class="headerlink" title="MySQL 运维篇 04-06 MyCat 水平分表"></a>MySQL 运维篇 04-06 MyCat 水平分表</h1><p>水平分表是将一个大表的数据按照某种规则分布到多个表中。本文将介绍如何使用 MyCat 实现水平分表。</p>
<h2 id="一、水平分表介绍"><a href="#一、水平分表介绍" class="headerlink" title="一、水平分表介绍"></a>一、水平分表介绍</h2><h3 id="1-1-什么是水平分表"><a href="#1-1-什么是水平分表" class="headerlink" title="1.1 什么是水平分表"></a>1.1 什么是水平分表</h3><p><strong>水平分表</strong>：将同一个表的数据按照行拆分到多个物理表中。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">原始表：</span><br><span class="line">orders (1 亿条数据)</span><br><span class="line"></span><br><span class="line">水平分表后：</span><br><span class="line">orders_0000 (250 万条)</span><br><span class="line">orders_0001 (250 万条)</span><br><span class="line">orders_0002 (250 万条)</span><br><span class="line">orders_0003 (250 万条)</span><br></pre></td></tr></table></figure>

<h3 id="1-2-适用场景"><a href="#1-2-适用场景" class="headerlink" title="1.2 适用场景"></a>1.2 适用场景</h3><table>
<thead>
<tr>
<th>场景</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>单表数据量大</td>
<td>超过 1000 万行</td>
</tr>
<tr>
<td>查询性能下降</td>
<td>索引效率低</td>
</tr>
<tr>
<td>维护困难</td>
<td>DDL 操作耗时过长</td>
</tr>
</tbody></table>
<h3 id="1-3-分片规则"><a href="#1-3-分片规则" class="headerlink" title="1.3 分片规则"></a>1.3 分片规则</h3><table>
<thead>
<tr>
<th>规则</th>
<th>说明</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td>取模</td>
<td>id % 分片数</td>
<td>均匀分布</td>
</tr>
<tr>
<td>范围</td>
<td>按 ID 或日期范围</td>
<td>历史数据归档</td>
</tr>
<tr>
<td>哈希</td>
<td>hash(key) % 分片数</td>
<td>随机分布</td>
</tr>
</tbody></table>
<h2 id="二、环境准备"><a href="#二、环境准备" class="headerlink" title="二、环境准备"></a>二、环境准备</h2><h3 id="2-1-数据库规划"><a href="#2-1-数据库规划" class="headerlink" title="2.1 数据库规划"></a>2.1 数据库规划</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">order_db</span><br><span class="line">├── orders_0000</span><br><span class="line">├── orders_0001</span><br><span class="line">├── orders_0002</span><br><span class="line">└── orders_0003</span><br></pre></td></tr></table></figure>

<h3 id="2-2-创建数据库和表"><a href="#2-2-创建数据库和表" class="headerlink" title="2.2 创建数据库和表"></a>2.2 创建数据库和表</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建数据库</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE order_db <span class="keyword">DEFAULT</span> <span class="keyword">CHARACTER SET</span> utf8mb4;</span><br><span class="line"></span><br><span class="line">USE order_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建 4 个分表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders_0000 <span class="keyword">LIKE</span> orders_template;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders_0001 <span class="keyword">LIKE</span> orders_template;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders_0002 <span class="keyword">LIKE</span> orders_template;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders_0003 <span class="keyword">LIKE</span> orders_template;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 表模板</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders_template (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    order_no <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    user_id <span class="type">BIGINT</span>,</span><br><span class="line">    amount <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),</span><br><span class="line">    status TINYINT,</span><br><span class="line">    created_at DATETIME <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br></pre></td></tr></table></figure>

<h2 id="三、MyCat-配置"><a href="#三、MyCat-配置" class="headerlink" title="三、MyCat 配置"></a>三、MyCat 配置</h2><h3 id="3-1-datasource-yml"><a href="#3-1-datasource-yml" class="headerlink" title="3.1 datasource.yml"></a>3.1 datasource.yml</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">dataNodes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn0</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">order_db</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn1</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">order_db</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn2</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">order_db</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn3</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">order_db</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dataHosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">maxCon:</span> <span class="number">1000</span></span><br><span class="line">    <span class="attr">minCon:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">heartbeat:</span></span><br><span class="line">      <span class="attr">statement:</span> <span class="string">select</span> <span class="string">user()</span></span><br><span class="line">    <span class="attr">writeHosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">master</span></span><br><span class="line">        <span class="attr">url:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.100</span><span class="string">:3306</span></span><br><span class="line">        <span class="attr">user:</span> <span class="string">mycat</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">MyCat@123</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-schema-yml"><a href="#3-2-schema-yml" class="headerlink" title="3.2 schema.yml"></a>3.2 schema.yml</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">schemas:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">order_db</span></span><br><span class="line">    <span class="attr">tables:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">orders</span></span><br><span class="line">        <span class="attr">primaryKey:</span> <span class="string">id</span></span><br><span class="line">        <span class="attr">dataNodes:</span> <span class="string">dn0,dn1,dn2,dn3</span></span><br><span class="line">        <span class="attr">rule:</span> <span class="string">mod-long</span></span><br></pre></td></tr></table></figure>

<h3 id="3-3-rule-yml"><a href="#3-3-rule-yml" class="headerlink" title="3.3 rule.yml"></a>3.3 rule.yml</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tableRules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mod-long</span></span><br><span class="line">    <span class="attr">function:</span> <span class="string">mod-long</span></span><br><span class="line">    <span class="attr">columns:</span> <span class="string">id</span></span><br><span class="line"></span><br><span class="line"><span class="attr">functions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mod-long</span></span><br><span class="line">    <span class="attr">className:</span> <span class="string">io.mycat.router.function.PartitionByFunction</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">count:</span> <span class="number">4</span></span><br></pre></td></tr></table></figure>

<h2 id="四、测试验证"><a href="#四、测试验证" class="headerlink" title="四、测试验证"></a>四、测试验证</h2><h3 id="4-1-插入数据"><a href="#4-1-插入数据" class="headerlink" title="4.1 插入数据"></a>4.1 插入数据</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">USE order_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入数据，MyCat 会自动路由到对应分表</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (id, order_no, user_id, amount, status)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;ORD001&#x27;</span>, <span class="number">100</span>, <span class="number">199.99</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (id, order_no, user_id, amount, status)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;ORD002&#x27;</span>, <span class="number">101</span>, <span class="number">299.99</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (id, order_no, user_id, amount, status)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;ORD003&#x27;</span>, <span class="number">102</span>, <span class="number">399.99</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (id, order_no, user_id, amount, status)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="string">&#x27;ORD004&#x27;</span>, <span class="number">103</span>, <span class="number">499.99</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (id, order_no, user_id, amount, status)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">5</span>, <span class="string">&#x27;ORD005&#x27;</span>, <span class="number">104</span>, <span class="number">599.99</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (id, order_no, user_id, amount, status)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">6</span>, <span class="string">&#x27;ORD006&#x27;</span>, <span class="number">105</span>, <span class="number">699.99</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p><strong>数据分布</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">id=1 → 1%4=1 → orders_0001</span><br><span class="line">id=2 → 2%4=2 → orders_0002</span><br><span class="line">id=3 → 3%4=3 → orders_0003</span><br><span class="line">id=4 → 4%4=0 → orders_0000</span><br><span class="line">id=5 → 5%4=1 → orders_0001</span><br><span class="line">id=6 → 6%4=2 → orders_0002</span><br></pre></td></tr></table></figure>

<h3 id="4-2-查询数据"><a href="#4-2-查询数据" class="headerlink" title="4.2 查询数据"></a>4.2 查询数据</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询全部数据（MyCat 自动合并）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 单分片查询（快）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 全分片查询（慢）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> user_id <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 聚合查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> orders;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">SUM</span>(amount) <span class="keyword">FROM</span> orders;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-验证数据分布"><a href="#4-3-验证数据分布" class="headerlink" title="4.3 验证数据分布"></a>4.3 验证数据分布</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 在物理库查看</span></span><br><span class="line">mysql <span class="operator">-</span>u mycat <span class="operator">-</span>p <span class="operator">-</span>h <span class="number">192.168</span><span class="number">.1</span><span class="number">.100</span></span><br><span class="line"></span><br><span class="line">USE order_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看各分表数据</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;orders_0000&#x27;</span> <span class="keyword">AS</span> table_name, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt <span class="keyword">FROM</span> orders_0000</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;orders_0001&#x27;</span> <span class="keyword">AS</span> table_name, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt <span class="keyword">FROM</span> orders_0001</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;orders_0002&#x27;</span> <span class="keyword">AS</span> table_name, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt <span class="keyword">FROM</span> orders_0002</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;orders_0003&#x27;</span> <span class="keyword">AS</span> table_name, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt <span class="keyword">FROM</span> orders_0003;</span><br></pre></td></tr></table></figure>

<h2 id="五、按日期范围分表"><a href="#五、按日期范围分表" class="headerlink" title="五、按日期范围分表"></a>五、按日期范围分表</h2><h3 id="5-1-配置"><a href="#5-1-配置" class="headerlink" title="5.1 配置"></a>5.1 配置</h3><p><strong>rule.yml</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tableRules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">range-date</span></span><br><span class="line">    <span class="attr">function:</span> <span class="string">range-date</span></span><br><span class="line">    <span class="attr">columns:</span> <span class="string">created_at</span></span><br><span class="line"></span><br><span class="line"><span class="attr">functions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">range-date</span></span><br><span class="line">    <span class="attr">className:</span> <span class="string">io.mycat.router.function.PartitionByDateRange</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">sPartionDay:</span> <span class="number">2024-01-01</span></span><br><span class="line">      <span class="attr">datePattern:</span> <span class="string">yyyy-MM-dd</span></span><br><span class="line">      <span class="attr">days:</span> <span class="number">30</span></span><br></pre></td></tr></table></figure>

<p><strong>schema.yml</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">schemas:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">log_db</span></span><br><span class="line">    <span class="attr">tables:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">operation_log</span></span><br><span class="line">        <span class="attr">primaryKey:</span> <span class="string">id</span></span><br><span class="line">        <span class="attr">dataNodes:</span> <span class="string">dn202401,dn202402,dn202403</span></span><br><span class="line">        <span class="attr">rule:</span> <span class="string">range-date</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-创建分表"><a href="#5-2-创建分表" class="headerlink" title="5.2 创建分表"></a>5.2 创建分表</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE log_db <span class="keyword">DEFAULT</span> <span class="keyword">CHARACTER SET</span> utf8mb4;</span><br><span class="line"></span><br><span class="line">USE log_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建按月分表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> operation_log_202401 <span class="keyword">LIKE</span> operation_log_template;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> operation_log_202402 <span class="keyword">LIKE</span> operation_log_template;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> operation_log_202403 <span class="keyword">LIKE</span> operation_log_template;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-插入测试"><a href="#5-3-插入测试" class="headerlink" title="5.3 插入测试"></a>5.3 插入测试</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 插入不同月份的数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> operation_log (id, user_id, operation, created_at)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">100</span>, <span class="string">&#x27;login&#x27;</span>, <span class="string">&#x27;2024-01-15 10:00:00&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> operation_log (id, user_id, operation, created_at)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">100</span>, <span class="string">&#x27;order&#x27;</span>, <span class="string">&#x27;2024-02-20 15:00:00&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> operation_log (id, user_id, operation, created_at)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="number">100</span>, <span class="string">&#x27;logout&#x27;</span>, <span class="string">&#x27;2024-03-10 20:00:00&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="六、批量插入测试"><a href="#六、批量插入测试" class="headerlink" title="六、批量插入测试"></a>六、批量插入测试</h2><h3 id="6-1-存储过程批量插入"><a href="#6-1-存储过程批量插入" class="headerlink" title="6.1 存储过程批量插入"></a>6.1 存储过程批量插入</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> batch_insert_orders(<span class="keyword">IN</span> count <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_user_id <span class="type">BIGINT</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_amount <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    WHILE i <span class="operator">&lt;=</span> count DO</span><br><span class="line">        <span class="keyword">SET</span> v_user_id <span class="operator">=</span> <span class="built_in">FLOOR</span>(RAND() <span class="operator">*</span> <span class="number">1000</span>) <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">SET</span> v_amount <span class="operator">=</span> ROUND(RAND() <span class="operator">*</span> <span class="number">1000</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">INSERT INTO</span> orders (id, order_no, user_id, amount, status)</span><br><span class="line">        <span class="keyword">VALUES</span> (i <span class="operator">+</span> <span class="number">1000</span>, CONCAT(<span class="string">&#x27;ORD&#x27;</span>, LPAD(i <span class="operator">+</span> <span class="number">1000</span>, <span class="number">6</span>, <span class="string">&#x27;0&#x27;</span>)), v_user_id, v_amount, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">SET</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">END</span> WHILE;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入 10000 条数据</span></span><br><span class="line"><span class="keyword">CALL</span> batch_insert_orders(<span class="number">10000</span>);</span><br></pre></td></tr></table></figure>

<h3 id="6-2-查看数据分布"><a href="#6-2-查看数据分布" class="headerlink" title="6.2 查看数据分布"></a>6.2 查看数据分布</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看各分表数据量</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;orders_0000&#x27;</span> <span class="keyword">AS</span> table_name, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt <span class="keyword">FROM</span> orders_0000</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;orders_0001&#x27;</span> <span class="keyword">AS</span> table_name, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt <span class="keyword">FROM</span> orders_0001</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;orders_0002&#x27;</span> <span class="keyword">AS</span> table_name, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt <span class="keyword">FROM</span> orders_0002</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;orders_0003&#x27;</span> <span class="keyword">AS</span> table_name, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt <span class="keyword">FROM</span> orders_0003;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 预期结果：各分表数据量大致相等</span></span><br></pre></td></tr></table></figure>

<h2 id="七、查询优化"><a href="#七、查询优化" class="headerlink" title="七、查询优化"></a>七、查询优化</h2><h3 id="7-1-避免全分片扫描"><a href="#7-1-避免全分片扫描" class="headerlink" title="7.1 避免全分片扫描"></a>7.1 避免全分片扫描</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 不推荐：全分片扫描</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> user_id <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 推荐：单分片查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1001</span>;</span><br></pre></td></tr></table></figure>

<h3 id="7-2-使用覆盖索引"><a href="#7-2-使用覆盖索引" class="headerlink" title="7.2 使用覆盖索引"></a>7.2 使用覆盖索引</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建索引（在每个分表）</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> orders_0000 <span class="keyword">ADD</span> INDEX idx_user (user_id);</span><br><span class="line"><span class="keyword">ALTER TABLE</span> orders_0001 <span class="keyword">ADD</span> INDEX idx_user (user_id);</span><br><span class="line"><span class="keyword">ALTER TABLE</span> orders_0002 <span class="keyword">ADD</span> INDEX idx_user (user_id);</span><br><span class="line"><span class="keyword">ALTER TABLE</span> orders_0003 <span class="keyword">ADD</span> INDEX idx_user (user_id);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询时使用索引</span></span><br><span class="line"><span class="keyword">SELECT</span> id, order_no <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> user_id <span class="operator">=</span> <span class="number">100</span>;</span><br></pre></td></tr></table></figure>

<h2 id="八、小结"><a href="#八、小结" class="headerlink" title="八、小结"></a>八、小结</h2><h3 id="水平分表要点"><a href="#水平分表要点" class="headerlink" title="水平分表要点"></a>水平分表要点</h3><ol>
<li><strong>分片规则</strong>：取模、范围、哈希</li>
<li><strong>数据分布</strong>：确保均匀分布</li>
<li><strong>查询优化</strong>：避免全分片扫描</li>
<li><strong>索引设计</strong>：每个分表需要相同的索引</li>
</ol>
<h3 id="配置总结"><a href="#配置总结" class="headerlink" title="配置总结"></a>配置总结</h3><table>
<thead>
<tr>
<th>配置项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>dataNodes</td>
<td>每个分表一个节点</td>
</tr>
<tr>
<td>rule</td>
<td>分片规则（mod-long 等）</td>
</tr>
<tr>
<td>columns</td>
<td>分片字段</td>
</tr>
</tbody></table>
<hr>
<p><strong>下一篇</strong>：[MySQL 运维篇 04-07 MyCat 范围分片](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 04-07 MyCat 范围分片&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 运维篇 04-05 MyCat 垂直分库测试](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 04-05 MyCat 垂直分库测试&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 运维篇</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>实战</tag>
        <tag>MyCat</tag>
        <tag>水平分表</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 运维篇 04-04 MyCat 垂直分库</title>
    <url>/2026/02/24/MySQL%20%E8%BF%90%E7%BB%B4%E7%AF%87%2004-04%20MyCat%20%E5%9E%82%E7%9B%B4%E5%88%86%E5%BA%93/</url>
    <content><![CDATA[<h1 id="MySQL-运维篇-04-04-MyCat-垂直分库"><a href="#MySQL-运维篇-04-04-MyCat-垂直分库" class="headerlink" title="MySQL 运维篇 04-04 MyCat 垂直分库"></a>MySQL 运维篇 04-04 MyCat 垂直分库</h1><p>垂直分库是将不同的业务表分布到不同的数据库中。本文将介绍如何使用 MyCat 实现垂直分库。</p>
<h2 id="一、垂直分库介绍"><a href="#一、垂直分库介绍" class="headerlink" title="一、垂直分库介绍"></a>一、垂直分库介绍</h2><h3 id="1-1-什么是垂直分库"><a href="#1-1-什么是垂直分库" class="headerlink" title="1.1 什么是垂直分库"></a>1.1 什么是垂直分库</h3><p><strong>垂直分库</strong>：按照业务模块将表拆分到不同的数据库中。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">原始架构：</span><br><span class="line">single_db (users, orders, products, logs, ...)</span><br><span class="line"></span><br><span class="line">垂直分库后：</span><br><span class="line">user_db (users, user_profile, user_login, ...)</span><br><span class="line">order_db (orders, order_detail, order_log, ...)</span><br><span class="line">product_db (products, category, brand, ...)</span><br></pre></td></tr></table></figure>

<h3 id="1-2-适用场景"><a href="#1-2-适用场景" class="headerlink" title="1.2 适用场景"></a>1.2 适用场景</h3><table>
<thead>
<tr>
<th>场景</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>业务模块清晰</td>
<td>各模块相对独立</td>
</tr>
<tr>
<td>表数量过多</td>
<td>单库表数量超过 100</td>
</tr>
<tr>
<td>访问量差异大</td>
<td>热门表和冷门表分离</td>
</tr>
<tr>
<td>团队分工</td>
<td>不同团队负责不同模块</td>
</tr>
</tbody></table>
<h3 id="1-3-优缺点"><a href="#1-3-优缺点" class="headerlink" title="1.3 优缺点"></a>1.3 优缺点</h3><p><strong>优点</strong>：</p>
<ul>
<li>业务清晰，便于管理</li>
<li>减少单库压力</li>
<li>便于水平扩展</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>跨库 JOIN 复杂</li>
<li>事务处理困难</li>
<li>增加运维成本</li>
</ul>
<h2 id="二、环境准备"><a href="#二、环境准备" class="headerlink" title="二、环境准备"></a>二、环境准备</h2><h3 id="2-1-数据库规划"><a href="#2-1-数据库规划" class="headerlink" title="2.1 数据库规划"></a>2.1 数据库规划</h3><table>
<thead>
<tr>
<th>数据库</th>
<th>主机</th>
<th>表</th>
</tr>
</thead>
<tbody><tr>
<td>user_db</td>
<td>192.168.1.100</td>
<td>users, user_profile</td>
</tr>
<tr>
<td>order_db</td>
<td>192.168.1.100</td>
<td>orders, order_detail</td>
</tr>
<tr>
<td>product_db</td>
<td>192.168.1.101</td>
<td>products, category</td>
</tr>
</tbody></table>
<h3 id="2-2-创建数据库"><a href="#2-2-创建数据库" class="headerlink" title="2.2 创建数据库"></a>2.2 创建数据库</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 在 192.168.1.100 创建</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE user_db <span class="keyword">DEFAULT</span> <span class="keyword">CHARACTER SET</span> utf8mb4;</span><br><span class="line"><span class="keyword">CREATE</span> DATABASE order_db <span class="keyword">DEFAULT</span> <span class="keyword">CHARACTER SET</span> utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在 192.168.1.101 创建</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE product_db <span class="keyword">DEFAULT</span> <span class="keyword">CHARACTER SET</span> utf8mb4;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-创建表"><a href="#2-3-创建表" class="headerlink" title="2.3 创建表"></a>2.3 创建表</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- user_db</span></span><br><span class="line">USE user_db;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    username <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    created_at DATETIME</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE TABLE</span> user_profile (</span><br><span class="line">    user_id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    nickname <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    avatar <span class="type">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">    <span class="keyword">FOREIGN KEY</span> (user_id) <span class="keyword">REFERENCES</span> users(id)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- order_db</span></span><br><span class="line">USE order_db;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    order_no <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    user_id <span class="type">BIGINT</span>,</span><br><span class="line">    amount <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),</span><br><span class="line">    created_at DATETIME</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE TABLE</span> order_detail (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    order_id <span class="type">BIGINT</span>,</span><br><span class="line">    product_id <span class="type">BIGINT</span>,</span><br><span class="line">    quantity <span class="type">INT</span>,</span><br><span class="line">    price <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),</span><br><span class="line">    <span class="keyword">FOREIGN KEY</span> (order_id) <span class="keyword">REFERENCES</span> orders(id)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- product_db</span></span><br><span class="line">USE product_db;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE TABLE</span> products (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    price <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),</span><br><span class="line">    stock <span class="type">INT</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE TABLE</span> category (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    parent_id <span class="type">BIGINT</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br></pre></td></tr></table></figure>

<h2 id="三、MyCat-配置"><a href="#三、MyCat-配置" class="headerlink" title="三、MyCat 配置"></a>三、MyCat 配置</h2><h3 id="3-1-server-yml"><a href="#3-1-server-yml" class="headerlink" title="3.1 server.yml"></a>3.1 server.yml</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">system:</span></span><br><span class="line">  <span class="attr">schemaChecksum:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">maxCon:</span> <span class="number">2000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">users:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">schemas:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mall_db</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-datasource-yml"><a href="#3-2-datasource-yml" class="headerlink" title="3.2 datasource.yml"></a>3.2 datasource.yml</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">dataNodes:</span></span><br><span class="line">  <span class="comment"># 用户库数据节点</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn_user</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">user_db</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 订单库数据节点</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn_order</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">order_db</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 商品库数据节点</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn_product</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host2</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">product_db</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dataHosts:</span></span><br><span class="line">  <span class="comment"># 主机 1 (192.168.1.100)</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">maxCon:</span> <span class="number">1000</span></span><br><span class="line">    <span class="attr">minCon:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">heartbeat:</span></span><br><span class="line">      <span class="attr">statement:</span> <span class="string">select</span> <span class="string">user()</span></span><br><span class="line">    <span class="attr">writeHosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">master1</span></span><br><span class="line">        <span class="attr">url:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.100</span><span class="string">:3306</span></span><br><span class="line">        <span class="attr">user:</span> <span class="string">mycat</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">MyCat@123</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 主机 2 (192.168.1.101)</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">host2</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">maxCon:</span> <span class="number">1000</span></span><br><span class="line">    <span class="attr">minCon:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">heartbeat:</span></span><br><span class="line">      <span class="attr">statement:</span> <span class="string">select</span> <span class="string">user()</span></span><br><span class="line">    <span class="attr">writeHosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">master2</span></span><br><span class="line">        <span class="attr">url:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.101</span><span class="string">:3306</span></span><br><span class="line">        <span class="attr">user:</span> <span class="string">mycat</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">MyCat@123</span></span><br></pre></td></tr></table></figure>

<h3 id="3-3-schema-yml"><a href="#3-3-schema-yml" class="headerlink" title="3.3 schema.yml"></a>3.3 schema.yml</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">schemas:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mall_db</span></span><br><span class="line">    <span class="attr">tables:</span></span><br><span class="line">      <span class="comment"># 用户相关表</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">users</span></span><br><span class="line">        <span class="attr">primaryKey:</span> <span class="string">id</span></span><br><span class="line">        <span class="attr">dataNodes:</span> <span class="string">dn_user</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">user_profile</span></span><br><span class="line">        <span class="attr">primaryKey:</span> <span class="string">user_id</span></span><br><span class="line">        <span class="attr">dataNodes:</span> <span class="string">dn_user</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 订单相关表</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">orders</span></span><br><span class="line">        <span class="attr">primaryKey:</span> <span class="string">id</span></span><br><span class="line">        <span class="attr">dataNodes:</span> <span class="string">dn_order</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">order_detail</span></span><br><span class="line">        <span class="attr">primaryKey:</span> <span class="string">id</span></span><br><span class="line">        <span class="attr">dataNodes:</span> <span class="string">dn_order</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 商品相关表</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">products</span></span><br><span class="line">        <span class="attr">primaryKey:</span> <span class="string">id</span></span><br><span class="line">        <span class="attr">dataNodes:</span> <span class="string">dn_product</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">category</span></span><br><span class="line">        <span class="attr">primaryKey:</span> <span class="string">id</span></span><br><span class="line">        <span class="attr">dataNodes:</span> <span class="string">dn_product</span></span><br></pre></td></tr></table></figure>

<h3 id="3-4-rule-yml"><a href="#3-4-rule-yml" class="headerlink" title="3.4 rule.yml"></a>3.4 rule.yml</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 垂直分库不需要复杂的分片规则</span></span><br><span class="line"><span class="comment"># 只需要定义空规则即可</span></span><br><span class="line"><span class="attr">tableRules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">function:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">columns:</span> <span class="string">id</span></span><br><span class="line"></span><br><span class="line"><span class="attr">functions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">className:</span> <span class="string">io.mycat.router.function.DefaultFunction</span></span><br><span class="line">    <span class="attr">properties:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="四、测试验证"><a href="#四、测试验证" class="headerlink" title="四、测试验证"></a>四、测试验证</h2><h3 id="4-1-连接-MyCat"><a href="#4-1-连接-MyCat" class="headerlink" title="4.1 连接 MyCat"></a>4.1 连接 MyCat</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql -h 127.0.0.1 -P 8066 -u root -p123456</span><br></pre></td></tr></table></figure>

<h3 id="4-2-查看数据库"><a href="#4-2-查看数据库" class="headerlink" title="4.2 查看数据库"></a>4.2 查看数据库</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> DATABASES;</span><br><span class="line"><span class="comment">-- 应该显示 mall_db</span></span><br><span class="line"></span><br><span class="line">USE mall_db;</span><br><span class="line"><span class="keyword">SHOW</span> TABLES;</span><br><span class="line"><span class="comment">-- 应该显示：users, user_profile, orders, order_detail, products, category</span></span><br></pre></td></tr></table></figure>

<h3 id="4-3-插入数据"><a href="#4-3-插入数据" class="headerlink" title="4.3 插入数据"></a>4.3 插入数据</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 插入用户数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> users (id, username, email, created_at)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;zhangsan&#x27;</span>, <span class="string">&#x27;zhang@example.com&#x27;</span>, NOW());</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> user_profile (user_id, nickname, avatar)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;张三&#x27;</span>, <span class="string">&#x27;/avatar/1.jpg&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入订单数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (id, order_no, user_id, amount, created_at)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;ORD001&#x27;</span>, <span class="number">1</span>, <span class="number">199.99</span>, NOW());</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> order_detail (id, order_id, product_id, quantity, price)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">99.99</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入商品数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> products (id, name, price, stock)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;iPhone 15&#x27;</span>, <span class="number">7999.00</span>, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> category (id, name, parent_id)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;手机&#x27;</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<h3 id="4-4-查询数据"><a href="#4-4-查询数据" class="headerlink" title="4.4 查询数据"></a>4.4 查询数据</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询用户数据</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询订单数据</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询商品数据</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> products <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 跨库 JOIN（MyCat 会自动处理）</span></span><br><span class="line"><span class="keyword">SELECT</span> o.id, o.order_no, u.username</span><br><span class="line"><span class="keyword">FROM</span> orders o</span><br><span class="line"><span class="keyword">JOIN</span> users u <span class="keyword">ON</span> o.user_id <span class="operator">=</span> u.id</span><br><span class="line"><span class="keyword">WHERE</span> o.id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h3 id="4-5-验证数据分布"><a href="#4-5-验证数据分布" class="headerlink" title="4.5 验证数据分布"></a>4.5 验证数据分布</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 在物理库验证</span></span><br><span class="line"><span class="comment">-- user_db</span></span><br><span class="line">mysql <span class="operator">-</span>u mycat <span class="operator">-</span>p <span class="operator">-</span>h <span class="number">192.168</span><span class="number">.1</span><span class="number">.100</span></span><br><span class="line">USE user_db;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- order_db</span></span><br><span class="line">USE order_db;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- product_db</span></span><br><span class="line">mysql <span class="operator">-</span>u mycat <span class="operator">-</span>p <span class="operator">-</span>h <span class="number">192.168</span><span class="number">.1</span><span class="number">.101</span></span><br><span class="line">USE product_db;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> products;</span><br></pre></td></tr></table></figure>

<h2 id="五、跨库操作"><a href="#五、跨库操作" class="headerlink" title="五、跨库操作"></a>五、跨库操作</h2><h3 id="5-1-跨库-JOIN"><a href="#5-1-跨库-JOIN" class="headerlink" title="5.1 跨库 JOIN"></a>5.1 跨库 JOIN</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- MyCat 支持跨库 JOIN</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    o.id <span class="keyword">AS</span> order_id,</span><br><span class="line">    o.order_no,</span><br><span class="line">    o.amount,</span><br><span class="line">    u.username,</span><br><span class="line">    p.name <span class="keyword">AS</span> product_name</span><br><span class="line"><span class="keyword">FROM</span> orders o</span><br><span class="line"><span class="keyword">JOIN</span> users u <span class="keyword">ON</span> o.user_id <span class="operator">=</span> u.id</span><br><span class="line"><span class="keyword">JOIN</span> order_detail od <span class="keyword">ON</span> o.id <span class="operator">=</span> od.order_id</span><br><span class="line"><span class="keyword">JOIN</span> products p <span class="keyword">ON</span> od.product_id <span class="operator">=</span> p.id</span><br><span class="line"><span class="keyword">WHERE</span> o.id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-跨库事务"><a href="#5-2-跨库事务" class="headerlink" title="5.2 跨库事务"></a>5.2 跨库事务</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 开启事务</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 操作用户库</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> users (id, username, email) <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;lisi&#x27;</span>, <span class="string">&#x27;li@example.com&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 操作订单库</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (id, order_no, user_id, amount) <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;ORD002&#x27;</span>, <span class="number">2</span>, <span class="number">299.99</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 提交事务</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：跨库事务可能不支持，需要应用层保证一致性。</p>
<h2 id="六、垂直分库-水平分表"><a href="#六、垂直分库-水平分表" class="headerlink" title="六、垂直分库 + 水平分表"></a>六、垂直分库 + 水平分表</h2><h3 id="6-1-混合架构"><a href="#6-1-混合架构" class="headerlink" title="6.1 混合架构"></a>6.1 混合架构</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">先垂直分库：</span><br><span class="line">- user_db</span><br><span class="line">- order_db</span><br><span class="line">- product_db</span><br><span class="line"></span><br><span class="line">再水平分表（order_db）：</span><br><span class="line">- orders_0000, orders_0001, ..., orders_9999</span><br></pre></td></tr></table></figure>

<h3 id="6-2-MyCat-配置"><a href="#6-2-MyCat-配置" class="headerlink" title="6.2 MyCat 配置"></a>6.2 MyCat 配置</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># schema.yml</span></span><br><span class="line"><span class="attr">schemas:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mall_db</span></span><br><span class="line">    <span class="attr">tables:</span></span><br><span class="line">      <span class="comment"># 用户库（不分表）</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">users</span></span><br><span class="line">        <span class="attr">primaryKey:</span> <span class="string">id</span></span><br><span class="line">        <span class="attr">dataNodes:</span> <span class="string">dn_user</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 订单库（水平分表）</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">orders</span></span><br><span class="line">        <span class="attr">primaryKey:</span> <span class="string">id</span></span><br><span class="line">        <span class="attr">dataNodes:</span> <span class="string">dn_order1,dn_order2,dn_order3,dn_order4</span></span><br><span class="line">        <span class="attr">rule:</span> <span class="string">mod-long</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 商品库（不分表）</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">products</span></span><br><span class="line">        <span class="attr">primaryKey:</span> <span class="string">id</span></span><br><span class="line">        <span class="attr">dataNodes:</span> <span class="string">dn_product</span></span><br></pre></td></tr></table></figure>

<h2 id="七、小结"><a href="#七、小结" class="headerlink" title="七、小结"></a>七、小结</h2><h3 id="垂直分库要点"><a href="#垂直分库要点" class="headerlink" title="垂直分库要点"></a>垂直分库要点</h3><ol>
<li><strong>按业务拆分</strong>：将不同业务表放到不同数据库</li>
<li><strong>配置简单</strong>：每个表指定一个数据节点</li>
<li><strong>跨库 JOIN</strong>：MyCat 自动处理</li>
<li><strong>便于扩展</strong>：可以结合水平分表</li>
</ol>
<h3 id="配置总结"><a href="#配置总结" class="headerlink" title="配置总结"></a>配置总结</h3><table>
<thead>
<tr>
<th>配置项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>dataNodes</td>
<td>每个库一个节点</td>
</tr>
<tr>
<td>schema.yml</td>
<td>表到节点的映射</td>
</tr>
<tr>
<td>rule.yml</td>
<td>垂直分库可用默认规则</td>
</tr>
</tbody></table>
<hr>
<p><strong>下一篇</strong>：[MySQL 运维篇 04-05 MyCat 垂直分库测试](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 04-05 MyCat 垂直分库测试&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 运维篇 04-03 MyCat 配置详解](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 04-03 MyCat 配置详解&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 运维篇</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>实战</tag>
        <tag>MyCat</tag>
        <tag>垂直分库</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 运维篇 04-07 MyCat 范围分片</title>
    <url>/2026/02/24/MySQL%20%E8%BF%90%E7%BB%B4%E7%AF%87%2004-07%20MyCat%20%E8%8C%83%E5%9B%B4%E5%88%86%E7%89%87/</url>
    <content><![CDATA[<h1 id="MySQL-运维篇-04-07-MyCat-范围分片"><a href="#MySQL-运维篇-04-07-MyCat-范围分片" class="headerlink" title="MySQL 运维篇 04-07 MyCat 范围分片"></a>MySQL 运维篇 04-07 MyCat 范围分片</h1><p>范围分片是按照某个字段的范围进行数据分片。本文将介绍如何使用 MyCat 实现范围分片。</p>
<h2 id="一、范围分片介绍"><a href="#一、范围分片介绍" class="headerlink" title="一、范围分片介绍"></a>一、范围分片介绍</h2><h3 id="1-1-什么是范围分片"><a href="#1-1-什么是范围分片" class="headerlink" title="1.1 什么是范围分片"></a>1.1 什么是范围分片</h3><p><strong>范围分片</strong>：根据分片键的值范围将数据分布到不同的分片中。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">按 ID 范围分片：</span><br><span class="line">分片 0: id 1-1000000</span><br><span class="line">分片 1: id 1000001-2000000</span><br><span class="line">分片 2: id 2000001-3000000</span><br></pre></td></tr></table></figure>

<h3 id="1-2-适用场景"><a href="#1-2-适用场景" class="headerlink" title="1.2 适用场景"></a>1.2 适用场景</h3><table>
<thead>
<tr>
<th>场景</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>日期数据</td>
<td>按时间范围归档</td>
</tr>
<tr>
<td>有序 ID</td>
<td>按 ID 范围分布</td>
</tr>
<tr>
<td>地区数据</td>
<td>按地区编码范围</td>
</tr>
</tbody></table>
<h3 id="1-3-优缺点"><a href="#1-3-优缺点" class="headerlink" title="1.3 优缺点"></a>1.3 优缺点</h3><p><strong>优点</strong>：</p>
<ul>
<li>范围查询效率高</li>
<li>便于历史数据归档</li>
<li>扩容相对容易</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>数据可能分布不均</li>
<li>热点问题（最新数据集中）</li>
</ul>
<h2 id="二、按日期范围分片"><a href="#二、按日期范围分片" class="headerlink" title="二、按日期范围分片"></a>二、按日期范围分片</h2><h3 id="2-1-配置"><a href="#2-1-配置" class="headerlink" title="2.1 配置"></a>2.1 配置</h3><p><strong>rule.yml</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tableRules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">range-date</span></span><br><span class="line">    <span class="attr">function:</span> <span class="string">range-date</span></span><br><span class="line">    <span class="attr">columns:</span> <span class="string">created_at</span></span><br><span class="line"></span><br><span class="line"><span class="attr">functions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">range-date</span></span><br><span class="line">    <span class="attr">className:</span> <span class="string">io.mycat.router.function.PartitionByDateRange</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">sPartionDay:</span> <span class="number">2024-01-01</span></span><br><span class="line">      <span class="attr">datePattern:</span> <span class="string">yyyy-MM-dd</span></span><br><span class="line">      <span class="attr">days:</span> <span class="number">30</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-创建分表"><a href="#2-2-创建分表" class="headerlink" title="2.2 创建分表"></a>2.2 创建分表</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE log_db <span class="keyword">DEFAULT</span> <span class="keyword">CHARACTER SET</span> utf8mb4;</span><br><span class="line">USE log_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建按月分表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> operation_log_202401 (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    user_id <span class="type">BIGINT</span>,</span><br><span class="line">    operation <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    created_at DATETIME</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE TABLE</span> operation_log_202402 (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    user_id <span class="type">BIGINT</span>,</span><br><span class="line">    operation <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    created_at DATETIME</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE TABLE</span> operation_log_202403 (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    user_id <span class="type">BIGINT</span>,</span><br><span class="line">    operation <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    created_at DATETIME</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-schema-yml"><a href="#2-3-schema-yml" class="headerlink" title="2.3 schema.yml"></a>2.3 schema.yml</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">schemas:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">log_db</span></span><br><span class="line">    <span class="attr">tables:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">operation_log</span></span><br><span class="line">        <span class="attr">primaryKey:</span> <span class="string">id</span></span><br><span class="line">        <span class="attr">dataNodes:</span> <span class="string">dn202401,dn202402,dn202403</span></span><br><span class="line">        <span class="attr">rule:</span> <span class="string">range-date</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dataNodes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn202401</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">log_db</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn202402</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">log_db</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn202403</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">log_db</span></span><br></pre></td></tr></table></figure>

<h3 id="2-4-插入测试"><a href="#2-4-插入测试" class="headerlink" title="2.4 插入测试"></a>2.4 插入测试</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">USE log_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入 1 月数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> operation_log (id, user_id, operation, created_at)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">100</span>, <span class="string">&#x27;login&#x27;</span>, <span class="string">&#x27;2024-01-15 10:00:00&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入 2 月数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> operation_log (id, user_id, operation, created_at)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">100</span>, <span class="string">&#x27;order&#x27;</span>, <span class="string">&#x27;2024-02-20 15:00:00&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入 3 月数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> operation_log (id, user_id, operation, created_at)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="number">100</span>, <span class="string">&#x27;logout&#x27;</span>, <span class="string">&#x27;2024-03-10 20:00:00&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="2-5-查询测试"><a href="#2-5-查询测试" class="headerlink" title="2.5 查询测试"></a>2.5 查询测试</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询指定月份数据</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> operation_log</span><br><span class="line"><span class="keyword">WHERE</span> created_at <span class="operator">&gt;=</span> <span class="string">&#x27;2024-01-01&#x27;</span> <span class="keyword">AND</span> created_at <span class="operator">&lt;</span> <span class="string">&#x27;2024-02-01&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询全部数据</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> operation_log <span class="keyword">ORDER</span> <span class="keyword">BY</span> created_at;</span><br></pre></td></tr></table></figure>

<h2 id="三、按-ID-范围分片"><a href="#三、按-ID-范围分片" class="headerlink" title="三、按 ID 范围分片"></a>三、按 ID 范围分片</h2><h3 id="3-1-配置"><a href="#3-1-配置" class="headerlink" title="3.1 配置"></a>3.1 配置</h3><p><strong>rule.yml</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tableRules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">range-id</span></span><br><span class="line">    <span class="attr">function:</span> <span class="string">range-id</span></span><br><span class="line">    <span class="attr">columns:</span> <span class="string">id</span></span><br><span class="line"></span><br><span class="line"><span class="attr">functions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">range-id</span></span><br><span class="line">    <span class="attr">className:</span> <span class="string">io.mycat.router.function.PartitionByRange</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">rangeStart:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">rangeEnd:</span> <span class="number">1000000</span></span><br><span class="line">        <span class="attr">dataNode:</span> <span class="string">dn0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">rangeStart:</span> <span class="number">1000000</span></span><br><span class="line">        <span class="attr">rangeEnd:</span> <span class="number">2000000</span></span><br><span class="line">        <span class="attr">dataNode:</span> <span class="string">dn1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">rangeStart:</span> <span class="number">2000000</span></span><br><span class="line">        <span class="attr">rangeEnd:</span> <span class="number">3000000</span></span><br><span class="line">        <span class="attr">dataNode:</span> <span class="string">dn2</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-创建分表"><a href="#3-2-创建分表" class="headerlink" title="3.2 创建分表"></a>3.2 创建分表</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE user_db <span class="keyword">DEFAULT</span> <span class="keyword">CHARACTER SET</span> utf8mb4;</span><br><span class="line">USE user_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建 3 个分表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users_0000 (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    username <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">100</span>)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users_0001 (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    username <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">100</span>)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users_0002 (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    username <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">100</span>)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-schema-yml"><a href="#3-3-schema-yml" class="headerlink" title="3.3 schema.yml"></a>3.3 schema.yml</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">schemas:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">user_db</span></span><br><span class="line">    <span class="attr">tables:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">users</span></span><br><span class="line">        <span class="attr">primaryKey:</span> <span class="string">id</span></span><br><span class="line">        <span class="attr">dataNodes:</span> <span class="string">dn0,dn1,dn2</span></span><br><span class="line">        <span class="attr">rule:</span> <span class="string">range-id</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dataNodes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn0</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">user_db</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn1</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">user_db</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn2</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">user_db</span></span><br></pre></td></tr></table></figure>

<h3 id="3-4-插入测试"><a href="#3-4-插入测试" class="headerlink" title="3.4 插入测试"></a>3.4 插入测试</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">USE user_db;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入不同范围的数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> users (id, username, email) <span class="keyword">VALUES</span> (<span class="number">100</span>, <span class="string">&#x27;user1&#x27;</span>, <span class="string">&#x27;user1@example.com&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT INTO</span> users (id, username, email) <span class="keyword">VALUES</span> (<span class="number">1000100</span>, <span class="string">&#x27;user2&#x27;</span>, <span class="string">&#x27;user2@example.com&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT INTO</span> users (id, username, email) <span class="keyword">VALUES</span> (<span class="number">2000100</span>, <span class="string">&#x27;user3&#x27;</span>, <span class="string">&#x27;user3@example.com&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="四、批量插入测试"><a href="#四、批量插入测试" class="headerlink" title="四、批量插入测试"></a>四、批量插入测试</h2><h3 id="4-1-存储过程"><a href="#4-1-存储过程" class="headerlink" title="4.1 存储过程"></a>4.1 存储过程</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> batch_insert_logs(<span class="keyword">IN</span> count <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_date <span class="type">DATE</span>;</span><br><span class="line"></span><br><span class="line">    WHILE i <span class="operator">&lt;=</span> count DO</span><br><span class="line">        <span class="comment">-- 生成不同日期的数据</span></span><br><span class="line">        <span class="keyword">SET</span> v_date <span class="operator">=</span> DATE_ADD(<span class="string">&#x27;2024-01-01&#x27;</span>, <span class="type">INTERVAL</span> <span class="built_in">FLOOR</span>(RAND() <span class="operator">*</span> <span class="number">90</span>) <span class="keyword">DAY</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">INSERT INTO</span> operation_log (id, user_id, operation, created_at)</span><br><span class="line">        <span class="keyword">VALUES</span> (i, <span class="built_in">FLOOR</span>(RAND() <span class="operator">*</span> <span class="number">1000</span>) <span class="operator">+</span> <span class="number">1</span>, CONCAT(<span class="string">&#x27;op_&#x27;</span>, i), v_date);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">SET</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">END</span> WHILE;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入 1000 条数据</span></span><br><span class="line"><span class="keyword">CALL</span> batch_insert_logs(<span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<h3 id="4-2-查看数据分布"><a href="#4-2-查看数据分布" class="headerlink" title="4.2 查看数据分布"></a>4.2 查看数据分布</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看各分表数据量</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;log_202401&#x27;</span> <span class="keyword">AS</span> table_name, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt <span class="keyword">FROM</span> operation_log_202401</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;log_202402&#x27;</span> <span class="keyword">AS</span> table_name, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt <span class="keyword">FROM</span> operation_log_202402</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;log_202403&#x27;</span> <span class="keyword">AS</span> table_name, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt <span class="keyword">FROM</span> operation_log_202403;</span><br></pre></td></tr></table></figure>

<h2 id="五、范围查询优化"><a href="#五、范围查询优化" class="headerlink" title="五、范围查询优化"></a>五、范围查询优化</h2><h3 id="5-1-范围查询"><a href="#5-1-范围查询" class="headerlink" title="5.1 范围查询"></a>5.1 范围查询</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询指定日期范围（只扫描对应分片）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> operation_log</span><br><span class="line"><span class="keyword">WHERE</span> created_at <span class="operator">&gt;=</span> <span class="string">&#x27;2024-01-01&#x27;</span> <span class="keyword">AND</span> created_at <span class="operator">&lt;</span> <span class="string">&#x27;2024-01-31&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询 ID 范围</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> id <span class="keyword">BETWEEN</span> <span class="number">1</span> <span class="keyword">AND</span> <span class="number">100000</span>;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-历史数据归档"><a href="#5-2-历史数据归档" class="headerlink" title="5.2 历史数据归档"></a>5.2 历史数据归档</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 删除 1 年前的数据（直接 DROP 表）</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> operation_log_202301;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 或迁移到归档库</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> operation_log_archive</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> operation_log_202301;</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> operation_log_202301;</span><br></pre></td></tr></table></figure>

<h2 id="六、小结"><a href="#六、小结" class="headerlink" title="六、小结"></a>六、小结</h2><h3 id="范围分片要点"><a href="#范围分片要点" class="headerlink" title="范围分片要点"></a>范围分片要点</h3><ol>
<li><strong>日期范围</strong>：适合日志、订单等时间序列数据</li>
<li><strong>ID 范围</strong>：适合有序增长的数据</li>
<li><strong>范围查询</strong>：效率高，只扫描对应分片</li>
<li><strong>数据归档</strong>：便于历史数据清理</li>
</ol>
<h3 id="配置总结"><a href="#配置总结" class="headerlink" title="配置总结"></a>配置总结</h3><table>
<thead>
<tr>
<th>配置项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>range-date</td>
<td>日期范围分片</td>
</tr>
<tr>
<td>range-id</td>
<td>ID 范围分片</td>
</tr>
<tr>
<td>days</td>
<td>每个分片的天数</td>
</tr>
</tbody></table>
<hr>
<p><strong>下一篇</strong>：[MySQL 运维篇 04-08 MyCat 取模分片](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 04-08 MyCat 取模分片&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 运维篇 04-06 MyCat 水平分表](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 04-06 MyCat 水平分表&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 运维篇</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>实战</tag>
        <tag>MyCat</tag>
        <tag>范围分片</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 运维篇 04-08 MyCat 取模分片</title>
    <url>/2026/02/24/MySQL%20%E8%BF%90%E7%BB%B4%E7%AF%87%2004-08%20MyCat%20%E5%8F%96%E6%A8%A1%E5%88%86%E7%89%87/</url>
    <content><![CDATA[<h1 id="MySQL-运维篇-04-08-MyCat-取模分片"><a href="#MySQL-运维篇-04-08-MyCat-取模分片" class="headerlink" title="MySQL 运维篇 04-08 MyCat 取模分片"></a>MySQL 运维篇 04-08 MyCat 取模分片</h1><p>取模分片是最常用的分片方式，按照分片键对分片数取模来路由数据。本文将详细介绍取模分片的配置和使用。</p>
<h2 id="一、取模分片介绍"><a href="#一、取模分片介绍" class="headerlink" title="一、取模分片介绍"></a>一、取模分片介绍</h2><h3 id="1-1-什么是取模分片"><a href="#1-1-什么是取模分片" class="headerlink" title="1.1 什么是取模分片"></a>1.1 什么是取模分片</h3><p><strong>取模分片</strong>：根据分片键对分片数量取模来确定数据存储位置。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">公式：分片索引 = 分片键 % 分片数量</span><br><span class="line"></span><br><span class="line">示例（4 个分片）：</span><br><span class="line">id=1 → 1%4=1 → 分片 1</span><br><span class="line">id=2 → 2%4=2 → 分片 2</span><br><span class="line">id=3 → 3%4=3 → 分片 3</span><br><span class="line">id=4 → 4%4=0 → 分片 0</span><br><span class="line">id=5 → 5%4=1 → 分片 1</span><br></pre></td></tr></table></figure>

<h3 id="1-2-适用场景"><a href="#1-2-适用场景" class="headerlink" title="1.2 适用场景"></a>1.2 适用场景</h3><table>
<thead>
<tr>
<th>场景</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>用户订单</td>
<td>按 user_id 取模</td>
</tr>
<tr>
<td>用户数据</td>
<td>按用户 ID 取模</td>
</tr>
<tr>
<td>均匀分布</td>
<td>需要数据均匀分布</td>
</tr>
</tbody></table>
<h3 id="1-3-优缺点"><a href="#1-3-优缺点" class="headerlink" title="1.3 优缺点"></a>1.3 优缺点</h3><p><strong>优点</strong>：</p>
<ul>
<li>数据分布均匀</li>
<li>算法简单高效</li>
<li>查询效率高</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>扩容困难（需要 rehash）</li>
<li>范围查询效率低</li>
</ul>
<h2 id="二、基础配置"><a href="#二、基础配置" class="headerlink" title="二、基础配置"></a>二、基础配置</h2><h3 id="2-1-rule-yml"><a href="#2-1-rule-yml" class="headerlink" title="2.1 rule.yml"></a>2.1 rule.yml</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tableRules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mod-long</span></span><br><span class="line">    <span class="attr">function:</span> <span class="string">mod-long</span></span><br><span class="line">    <span class="attr">columns:</span> <span class="string">id</span></span><br><span class="line"></span><br><span class="line"><span class="attr">functions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mod-long</span></span><br><span class="line">    <span class="attr">className:</span> <span class="string">io.mycat.router.function.PartitionByFunction</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">count:</span> <span class="number">4</span>    <span class="comment"># 分片数量</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-schema-yml"><a href="#2-2-schema-yml" class="headerlink" title="2.2 schema.yml"></a>2.2 schema.yml</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">schemas:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">testdb</span></span><br><span class="line">    <span class="attr">tables:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">orders</span></span><br><span class="line">        <span class="attr">primaryKey:</span> <span class="string">id</span></span><br><span class="line">        <span class="attr">dataNodes:</span> <span class="string">dn0,dn1,dn2,dn3</span></span><br><span class="line">        <span class="attr">rule:</span> <span class="string">mod-long</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-datasource-yml"><a href="#2-3-datasource-yml" class="headerlink" title="2.3 datasource.yml"></a>2.3 datasource.yml</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">dataNodes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn0</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">db0</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn1</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">db1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn2</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">db2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn3</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">db3</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dataHosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">maxCon:</span> <span class="number">1000</span></span><br><span class="line">    <span class="attr">minCon:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">heartbeat:</span></span><br><span class="line">      <span class="attr">statement:</span> <span class="string">select</span> <span class="string">user()</span></span><br><span class="line">    <span class="attr">writeHosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">master</span></span><br><span class="line">        <span class="attr">url:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.100</span><span class="string">:3306</span></span><br><span class="line">        <span class="attr">user:</span> <span class="string">mycat</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">MyCat@123</span></span><br></pre></td></tr></table></figure>

<h2 id="三、环境准备"><a href="#三、环境准备" class="headerlink" title="三、环境准备"></a>三、环境准备</h2><h3 id="3-1-创建数据库"><a href="#3-1-创建数据库" class="headerlink" title="3.1 创建数据库"></a>3.1 创建数据库</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建 4 个数据库</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE db0 <span class="keyword">DEFAULT</span> <span class="keyword">CHARACTER SET</span> utf8mb4;</span><br><span class="line"><span class="keyword">CREATE</span> DATABASE db1 <span class="keyword">DEFAULT</span> <span class="keyword">CHARACTER SET</span> utf8mb4;</span><br><span class="line"><span class="keyword">CREATE</span> DATABASE db2 <span class="keyword">DEFAULT</span> <span class="keyword">CHARACTER SET</span> utf8mb4;</span><br><span class="line"><span class="keyword">CREATE</span> DATABASE db3 <span class="keyword">DEFAULT</span> <span class="keyword">CHARACTER SET</span> utf8mb4;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-创建表"><a href="#3-2-创建表" class="headerlink" title="3.2 创建表"></a>3.2 创建表</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 在每个数据库创建相同的表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    order_no <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    user_id <span class="type">BIGINT</span>,</span><br><span class="line">    amount <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),</span><br><span class="line">    status TINYINT,</span><br><span class="line">    created_at DATETIME <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br></pre></td></tr></table></figure>

<h2 id="四、测试验证"><a href="#四、测试验证" class="headerlink" title="四、测试验证"></a>四、测试验证</h2><h3 id="4-1-插入数据"><a href="#4-1-插入数据" class="headerlink" title="4.1 插入数据"></a>4.1 插入数据</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">USE testdb;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入 10 条数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (id, order_no, user_id, amount) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">1</span>, <span class="string">&#x27;ORD001&#x27;</span>, <span class="number">100</span>, <span class="number">199.99</span>),</span><br><span class="line">(<span class="number">2</span>, <span class="string">&#x27;ORD002&#x27;</span>, <span class="number">101</span>, <span class="number">299.99</span>),</span><br><span class="line">(<span class="number">3</span>, <span class="string">&#x27;ORD003&#x27;</span>, <span class="number">102</span>, <span class="number">399.99</span>),</span><br><span class="line">(<span class="number">4</span>, <span class="string">&#x27;ORD004&#x27;</span>, <span class="number">103</span>, <span class="number">499.99</span>),</span><br><span class="line">(<span class="number">5</span>, <span class="string">&#x27;ORD005&#x27;</span>, <span class="number">104</span>, <span class="number">599.99</span>),</span><br><span class="line">(<span class="number">6</span>, <span class="string">&#x27;ORD006&#x27;</span>, <span class="number">105</span>, <span class="number">699.99</span>),</span><br><span class="line">(<span class="number">7</span>, <span class="string">&#x27;ORD007&#x27;</span>, <span class="number">106</span>, <span class="number">799.99</span>),</span><br><span class="line">(<span class="number">8</span>, <span class="string">&#x27;ORD008&#x27;</span>, <span class="number">107</span>, <span class="number">899.99</span>),</span><br><span class="line">(<span class="number">9</span>, <span class="string">&#x27;ORD009&#x27;</span>, <span class="number">108</span>, <span class="number">999.99</span>),</span><br><span class="line">(<span class="number">10</span>, <span class="string">&#x27;ORD010&#x27;</span>, <span class="number">109</span>, <span class="number">1099.99</span>);</span><br></pre></td></tr></table></figure>

<p><strong>数据分布</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">id=1 → 1%4=1 → db1</span><br><span class="line">id=2 → 2%4=2 → db2</span><br><span class="line">id=3 → 3%4=3 → db3</span><br><span class="line">id=4 → 4%4=0 → db0</span><br><span class="line">id=5 → 5%4=1 → db1</span><br><span class="line">id=6 → 6%4=2 → db2</span><br><span class="line">id=7 → 7%4=3 → db3</span><br><span class="line">id=8 → 8%4=0 → db0</span><br><span class="line">id=9 → 9%4=1 → db1</span><br><span class="line">id=10 → 10%4=2 → db2</span><br></pre></td></tr></table></figure>

<h3 id="4-2-查询数据"><a href="#4-2-查询数据" class="headerlink" title="4.2 查询数据"></a>4.2 查询数据</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询全部数据</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 单分片查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 多分片查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> id <span class="keyword">IN</span> (<span class="number">1</span>, <span class="number">5</span>, <span class="number">9</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 聚合查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> orders;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">SUM</span>(amount) <span class="keyword">FROM</span> orders;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-验证数据分布"><a href="#4-3-验证数据分布" class="headerlink" title="4.3 验证数据分布"></a>4.3 验证数据分布</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 在物理库查看</span></span><br><span class="line">mysql <span class="operator">-</span>u mycat <span class="operator">-</span>p <span class="operator">-</span>h <span class="number">192.168</span><span class="number">.1</span><span class="number">.100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- db0</span></span><br><span class="line">USE db0;</span><br><span class="line"><span class="keyword">SELECT</span> id <span class="keyword">FROM</span> orders;</span><br><span class="line"><span class="comment">-- 应该返回：4, 8</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- db1</span></span><br><span class="line">USE db1;</span><br><span class="line"><span class="keyword">SELECT</span> id <span class="keyword">FROM</span> orders;</span><br><span class="line"><span class="comment">-- 应该返回：1, 5, 9</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- db2</span></span><br><span class="line">USE db2;</span><br><span class="line"><span class="keyword">SELECT</span> id <span class="keyword">FROM</span> orders;</span><br><span class="line"><span class="comment">-- 应该返回：2, 6, 10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- db3</span></span><br><span class="line">USE db3;</span><br><span class="line"><span class="keyword">SELECT</span> id <span class="keyword">FROM</span> orders;</span><br><span class="line"><span class="comment">-- 应该返回：3, 7</span></span><br></pre></td></tr></table></figure>

<h2 id="五、按-user-id-取模"><a href="#五、按-user-id-取模" class="headerlink" title="五、按 user_id 取模"></a>五、按 user_id 取模</h2><h3 id="5-1-配置"><a href="#5-1-配置" class="headerlink" title="5.1 配置"></a>5.1 配置</h3><p><strong>rule.yml</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tableRules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mod-user</span></span><br><span class="line">    <span class="attr">function:</span> <span class="string">mod-user</span></span><br><span class="line">    <span class="attr">columns:</span> <span class="string">user_id</span></span><br><span class="line"></span><br><span class="line"><span class="attr">functions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mod-user</span></span><br><span class="line">    <span class="attr">className:</span> <span class="string">io.mycat.router.function.PartitionByFunction</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">count:</span> <span class="number">4</span></span><br></pre></td></tr></table></figure>

<p><strong>schema.yml</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">schemas:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">testdb</span></span><br><span class="line">    <span class="attr">tables:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">orders</span></span><br><span class="line">        <span class="attr">primaryKey:</span> <span class="string">id</span></span><br><span class="line">        <span class="attr">dataNodes:</span> <span class="string">dn0,dn1,dn2,dn3</span></span><br><span class="line">        <span class="attr">rule:</span> <span class="string">mod-user</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-测试"><a href="#5-2-测试" class="headerlink" title="5.2 测试"></a>5.2 测试</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 插入数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (id, order_no, user_id, amount) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">1</span>, <span class="string">&#x27;ORD001&#x27;</span>, <span class="number">100</span>, <span class="number">199.99</span>),  <span class="comment">-- 100%4=0 → db0</span></span><br><span class="line">(<span class="number">2</span>, <span class="string">&#x27;ORD002&#x27;</span>, <span class="number">101</span>, <span class="number">299.99</span>),  <span class="comment">-- 101%4=1 → db1</span></span><br><span class="line">(<span class="number">3</span>, <span class="string">&#x27;ORD003&#x27;</span>, <span class="number">102</span>, <span class="number">399.99</span>),  <span class="comment">-- 102%4=2 → db2</span></span><br><span class="line">(<span class="number">4</span>, <span class="string">&#x27;ORD004&#x27;</span>, <span class="number">103</span>, <span class="number">499.99</span>);  <span class="comment">-- 103%4=3 → db3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 按 user_id 查询（单分片）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> user_id <span class="operator">=</span> <span class="number">100</span>;</span><br></pre></td></tr></table></figure>

<h2 id="六、批量插入测试"><a href="#六、批量插入测试" class="headerlink" title="六、批量插入测试"></a>六、批量插入测试</h2><h3 id="6-1-存储过程"><a href="#6-1-存储过程" class="headerlink" title="6.1 存储过程"></a>6.1 存储过程</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> batch_insert_orders(<span class="keyword">IN</span> count <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_user_id <span class="type">BIGINT</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_amount <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    WHILE i <span class="operator">&lt;=</span> count DO</span><br><span class="line">        <span class="keyword">SET</span> v_user_id <span class="operator">=</span> <span class="built_in">FLOOR</span>(RAND() <span class="operator">*</span> <span class="number">1000</span>) <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">SET</span> v_amount <span class="operator">=</span> ROUND(RAND() <span class="operator">*</span> <span class="number">1000</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">INSERT INTO</span> orders (id, order_no, user_id, amount)</span><br><span class="line">        <span class="keyword">VALUES</span> (i <span class="operator">+</span> <span class="number">100</span>, CONCAT(<span class="string">&#x27;ORD&#x27;</span>, LPAD(i <span class="operator">+</span> <span class="number">100</span>, <span class="number">6</span>, <span class="string">&#x27;0&#x27;</span>)), v_user_id, v_amount);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">SET</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">END</span> WHILE;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入 1000 条数据</span></span><br><span class="line"><span class="keyword">CALL</span> batch_insert_orders(<span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<h3 id="6-2-查看数据分布"><a href="#6-2-查看数据分布" class="headerlink" title="6.2 查看数据分布"></a>6.2 查看数据分布</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看各分片数据量</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;db0&#x27;</span> <span class="keyword">AS</span> database_name, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt <span class="keyword">FROM</span> db0.orders</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;db1&#x27;</span> <span class="keyword">AS</span> database_name, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt <span class="keyword">FROM</span> db1.orders</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;db2&#x27;</span> <span class="keyword">AS</span> database_name, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt <span class="keyword">FROM</span> db2.orders</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;db3&#x27;</span> <span class="keyword">AS</span> database_name, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt <span class="keyword">FROM</span> db3.orders;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 预期结果：各分片数据量大致相等</span></span><br></pre></td></tr></table></figure>

<h2 id="七、扩容方案"><a href="#七、扩容方案" class="headerlink" title="七、扩容方案"></a>七、扩容方案</h2><h3 id="7-1-问题"><a href="#7-1-问题" class="headerlink" title="7.1 问题"></a>7.1 问题</h3><p>取模分片扩容时需要 rehash：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">原分片数：4</span><br><span class="line">新分片数：8</span><br><span class="line"></span><br><span class="line">id=1: 1%4=1 → 1%8=1 (不变)</span><br><span class="line">id=5: 5%4=1 → 5%8=5 (变化)</span><br></pre></td></tr></table></figure>

<h3 id="7-2-解决方案"><a href="#7-2-解决方案" class="headerlink" title="7.2 解决方案"></a>7.2 解决方案</h3><p><strong>方案 1：双倍扩容</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">4 → 8 → 16</span><br><span class="line">每次翻倍，部分数据不需要迁移</span><br></pre></td></tr></table></figure>

<p><strong>方案 2：数据迁移</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 双写新旧分片</span><br><span class="line">2. 逐步迁移历史数据</span><br><span class="line">3. 切换路由规则</span><br></pre></td></tr></table></figure>

<h2 id="八、小结"><a href="#八、小结" class="headerlink" title="八、小结"></a>八、小结</h2><h3 id="取模分片要点"><a href="#取模分片要点" class="headerlink" title="取模分片要点"></a>取模分片要点</h3><ol>
<li><strong>数据分布</strong>：均匀分布到各分片</li>
<li><strong>查询效率</strong>：单分片查询效率高</li>
<li><strong>扩容困难</strong>：需要 rehash 或数据迁移</li>
<li><strong>适用场景</strong>：用户订单、用户数据等</li>
</ol>
<h3 id="配置总结"><a href="#配置总结" class="headerlink" title="配置总结"></a>配置总结</h3><table>
<thead>
<tr>
<th>配置项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>mod-long</td>
<td>取模分片规则</td>
</tr>
<tr>
<td>count</td>
<td>分片数量</td>
</tr>
<tr>
<td>columns</td>
<td>分片字段</td>
</tr>
</tbody></table>
<hr>
<p><strong>下一篇</strong>：[MySQL 运维篇 04-09 MyCat 一致性 Hash](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 04-09 MyCat 一致性 Hash&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 运维篇 04-07 MyCat 范围分片](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 04-07 MyCat 范围分片&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 运维篇</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>实战</tag>
        <tag>MyCat</tag>
        <tag>取模分片</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 运维篇 04-10 MyCat 管理与监控</title>
    <url>/2026/02/24/MySQL%20%E8%BF%90%E7%BB%B4%E7%AF%87%2004-10%20MyCat%20%E7%AE%A1%E7%90%86%E4%B8%8E%E7%9B%91%E6%8E%A7/</url>
    <content><![CDATA[<h1 id="MySQL-运维篇-04-10-MyCat-管理与监控"><a href="#MySQL-运维篇-04-10-MyCat-管理与监控" class="headerlink" title="MySQL 运维篇 04-10 MyCat 管理与监控"></a>MySQL 运维篇 04-10 MyCat 管理与监控</h1><p>本文将介绍 MyCat 的管理命令、监控方法和运维最佳实践。</p>
<h2 id="一、MyCat-管理端口"><a href="#一、MyCat-管理端口" class="headerlink" title="一、MyCat 管理端口"></a>一、MyCat 管理端口</h2><h3 id="1-1-管理端口"><a href="#1-1-管理端口" class="headerlink" title="1.1 管理端口"></a>1.1 管理端口</h3><p>MyCat 有两个端口：</p>
<ul>
<li><strong>8066</strong>：MySQL 协议端口（应用连接）</li>
<li><strong>9066</strong>：管理端口（运维管理）</li>
</ul>
<h3 id="1-2-连接管理端口"><a href="#1-2-连接管理端口" class="headerlink" title="1.2 连接管理端口"></a>1.2 连接管理端口</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 连接管理端口</span></span><br><span class="line">mysql -h 127.0.0.1 -P 9066 -u root -p123456</span><br></pre></td></tr></table></figure>

<h2 id="二、管理命令"><a href="#二、管理命令" class="headerlink" title="二、管理命令"></a>二、管理命令</h2><h3 id="2-1-查看服务器状态"><a href="#2-1-查看服务器状态" class="headerlink" title="2.1 查看服务器状态"></a>2.1 查看服务器状态</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看服务器信息</span></span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@SERVER</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 输出示例：</span></span><br><span class="line"># <span class="operator">+</span><span class="comment">---------+----------------+----------------+</span></span><br><span class="line"># <span class="operator">|</span> VERSION <span class="operator">|</span> UPTIME         <span class="operator">|</span> USED_HEAP      <span class="operator">|</span></span><br><span class="line"># <span class="operator">+</span><span class="comment">---------+----------------+----------------+</span></span><br><span class="line"># <span class="operator">|</span> <span class="number">2.0</span>     <span class="operator">|</span> <span class="number">123456</span> seconds <span class="operator">|</span> <span class="number">512</span> MB         <span class="operator">|</span></span><br><span class="line"># <span class="operator">+</span><span class="comment">---------+----------------+----------------+</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-查看数据源状态"><a href="#2-2-查看数据源状态" class="headerlink" title="2.2 查看数据源状态"></a>2.2 查看数据源状态</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看所有数据源</span></span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@DATASOURCE</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看指定数据源</span></span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@DATASOURCE</span> <span class="keyword">WHERE</span> NAME <span class="operator">=</span> <span class="string">&#x27;dn0&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 输出字段：</span></span><br><span class="line"># NAME, ACTIVE, IDLE, EXECUTE_COUNT, etc.</span><br></pre></td></tr></table></figure>

<h3 id="2-3-查看连接池状态"><a href="#2-3-查看连接池状态" class="headerlink" title="2.3 查看连接池状态"></a>2.3 查看连接池状态</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看连接池</span></span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@CONNECTIONPOOL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看连接池统计</span></span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@CONNECTIONPOOL</span> <span class="keyword">WHERE</span> DATAHOST <span class="operator">=</span> <span class="string">&#x27;host1&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-查看-SQL-统计"><a href="#2-4-查看-SQL-统计" class="headerlink" title="2.4 查看 SQL 统计"></a>2.4 查看 SQL 统计</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看所有 SQL 统计</span></span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@SQL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看慢 SQL</span></span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@SLOW</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看 SQL 执行频率</span></span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@SQL</span>.<span class="keyword">EXECUTE</span>;</span><br></pre></td></tr></table></figure>

<h3 id="2-5-查看事务"><a href="#2-5-查看事务" class="headerlink" title="2.5 查看事务"></a>2.5 查看事务</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看活跃事务</span></span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@TRANSACTION</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看大事务</span></span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@TRANSACTION</span> <span class="keyword">WHERE</span> DURATION <span class="operator">&gt;</span> <span class="number">1000</span>;</span><br></pre></td></tr></table></figure>

<h2 id="三、监控指标"><a href="#三、监控指标" class="headerlink" title="三、监控指标"></a>三、监控指标</h2><h3 id="3-1-性能指标"><a href="#3-1-性能指标" class="headerlink" title="3.1 性能指标"></a>3.1 性能指标</h3><table>
<thead>
<tr>
<th>指标</th>
<th>说明</th>
<th>告警阈值</th>
</tr>
</thead>
<tbody><tr>
<td>QPS</td>
<td>每秒查询数</td>
<td>&gt; 10000</td>
</tr>
<tr>
<td>TPS</td>
<td>每秒事务数</td>
<td>&gt; 5000</td>
</tr>
<tr>
<td>响应时间</td>
<td>平均查询响应</td>
<td>&gt; 100ms</td>
</tr>
<tr>
<td>活跃连接</td>
<td>当前活跃连接</td>
<td>&gt; 80% 最大连接</td>
</tr>
</tbody></table>
<h3 id="3-2-连接池指标"><a href="#3-2-连接池指标" class="headerlink" title="3.2 连接池指标"></a>3.2 连接池指标</h3><table>
<thead>
<tr>
<th>指标</th>
<th>说明</th>
<th>告警阈值</th>
</tr>
</thead>
<tbody><tr>
<td>ACTIVE</td>
<td>活跃连接数</td>
<td>&gt; 80% 最大</td>
</tr>
<tr>
<td>IDLE</td>
<td>空闲连接数</td>
<td>&lt; 最小连接</td>
</tr>
<tr>
<td>WAIT</td>
<td>等待连接数</td>
<td>&gt; 0</td>
</tr>
</tbody></table>
<h3 id="3-3-数据源指标"><a href="#3-3-数据源指标" class="headerlink" title="3.3 数据源指标"></a>3.3 数据源指标</h3><table>
<thead>
<tr>
<th>指标</th>
<th>说明</th>
<th>告警阈值</th>
</tr>
</thead>
<tbody><tr>
<td>READ</td>
<td>读操作次数</td>
<td>-</td>
</tr>
<tr>
<td>WRITE</td>
<td>写操作次数</td>
<td>-</td>
</tr>
<tr>
<td>ERROR</td>
<td>错误次数</td>
<td>&gt; 0</td>
</tr>
</tbody></table>
<h2 id="四、监控脚本"><a href="#四、监控脚本" class="headerlink" title="四、监控脚本"></a>四、监控脚本</h2><h3 id="4-1-状态检查脚本"><a href="#4-1-状态检查脚本" class="headerlink" title="4.1 状态检查脚本"></a>4.1 状态检查脚本</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># check_mycat.sh</span></span><br><span class="line"></span><br><span class="line">MYCAT_HOST=<span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">MYCAT_PORT=<span class="string">&quot;9066&quot;</span></span><br><span class="line">MYCAT_USER=<span class="string">&quot;root&quot;</span></span><br><span class="line">MYCAT_PASS=<span class="string">&quot;123456&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查 MyCat 是否运行</span></span><br><span class="line">mysql -h <span class="variable">$MYCAT_HOST</span> -P <span class="variable">$MYCAT_PORT</span> -u <span class="variable">$MYCAT_USER</span> -p<span class="variable">$MYCAT_PASS</span> -e <span class="string">&quot;SHOW @@SERVER;&quot;</span> &gt; /dev/null 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;ERROR: MyCat is not running&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取数据源状态</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 数据源状态 ===&quot;</span></span><br><span class="line">mysql -h <span class="variable">$MYCAT_HOST</span> -P <span class="variable">$MYCAT_PORT</span> -u <span class="variable">$MYCAT_USER</span> -p<span class="variable">$MYCAT_PASS</span> -e <span class="string">&quot;SHOW @@DATASOURCE;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取连接池状态</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 连接池状态 ===&quot;</span></span><br><span class="line">mysql -h <span class="variable">$MYCAT_HOST</span> -P <span class="variable">$MYCAT_PORT</span> -u <span class="variable">$MYCAT_USER</span> -p<span class="variable">$MYCAT_PASS</span> -e <span class="string">&quot;SHOW @@CONNECTIONPOOL;&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-慢查询监控"><a href="#4-2-慢查询监控" class="headerlink" title="4.2 慢查询监控"></a>4.2 慢查询监控</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># slow_query_monitor.sh</span></span><br><span class="line"></span><br><span class="line">MYCAT_HOST=<span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">MYCAT_PORT=<span class="string">&quot;9066&quot;</span></span><br><span class="line">MYCAT_USER=<span class="string">&quot;root&quot;</span></span><br><span class="line">MYCAT_PASS=<span class="string">&quot;123456&quot;</span></span><br><span class="line">THRESHOLD=10  <span class="comment"># 慢查询阈值</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取慢查询数量</span></span><br><span class="line">SLOW_COUNT=$(mysql -h <span class="variable">$MYCAT_HOST</span> -P <span class="variable">$MYCAT_PORT</span> -u <span class="variable">$MYCAT_USER</span> -p<span class="variable">$MYCAT_PASS</span> -e <span class="string">&quot;SHOW @@SLOW;&quot;</span> | <span class="built_in">wc</span> -l)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$SLOW_COUNT</span> -gt <span class="variable">$THRESHOLD</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;WARNING: 发现 <span class="variable">$SLOW_COUNT</span> 个慢查询&quot;</span></span><br><span class="line">    mysql -h <span class="variable">$MYCAT_HOST</span> -P <span class="variable">$MYCAT_PORT</span> -u <span class="variable">$MYCAT_USER</span> -p<span class="variable">$MYCAT_PASS</span> -e <span class="string">&quot;SHOW @@SLOW LIMIT 10;&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h2 id="五、日志管理"><a href="#五、日志管理" class="headerlink" title="五、日志管理"></a>五、日志管理</h2><h3 id="5-1-日志位置"><a href="#5-1-日志位置" class="headerlink" title="5.1 日志位置"></a>5.1 日志位置</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/opt/mycat/logs/</span><br><span class="line">├── mycat.log          # 主日志</span><br><span class="line">├── mycat.console      # 控制台日志</span><br><span class="line">└── mycat.dump         # 转储日志</span><br></pre></td></tr></table></figure>

<h3 id="5-2-日志级别"><a href="#5-2-日志级别" class="headerlink" title="5.2 日志级别"></a>5.2 日志级别</h3><p><strong>log4j2.xml</strong>：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Appenders</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">RollingFile</span> <span class="attr">name</span>=<span class="string">&quot;RollingFile&quot;</span> <span class="attr">fileName</span>=<span class="string">&quot;logs/mycat.log&quot;</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">filePattern</span>=<span class="string">&quot;logs/mycat-%d&#123;yyyy-MM-dd&#125;-%i.log&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">Pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss&#125; %-5p %c&#123;1&#125;:%L - %m%n<span class="tag">&lt;/<span class="name">Pattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">PatternLayout</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Policies</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">SizeBasedTriggeringPolicy</span> <span class="attr">size</span>=<span class="string">&quot;100MB&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">Policies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">RollingFile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Appenders</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Loggers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Root</span> <span class="attr">level</span>=<span class="string">&quot;INFO&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">&quot;RollingFile&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Loggers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-日志分析"><a href="#5-3-日志分析" class="headerlink" title="5.3 日志分析"></a>5.3 日志分析</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看错误日志</span></span><br><span class="line">grep -i <span class="string">&quot;error&quot;</span> /opt/mycat/logs/mycat.log | <span class="built_in">tail</span> -100</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看警告日志</span></span><br><span class="line">grep -i <span class="string">&quot;warning&quot;</span> /opt/mycat/logs/mycat.log | <span class="built_in">tail</span> -50</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看启动日志</span></span><br><span class="line">grep -i <span class="string">&quot;started&quot;</span> /opt/mycat/logs/mycat.log</span><br></pre></td></tr></table></figure>

<h2 id="六、性能优化"><a href="#六、性能优化" class="headerlink" title="六、性能优化"></a>六、性能优化</h2><h3 id="6-1-连接池优化"><a href="#6-1-连接池优化" class="headerlink" title="6.1 连接池优化"></a>6.1 连接池优化</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># datasource.yml</span></span><br><span class="line"><span class="attr">dataHosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">maxCon:</span> <span class="number">1000</span>        <span class="comment"># 最大连接数</span></span><br><span class="line">    <span class="attr">minCon:</span> <span class="number">10</span>          <span class="comment"># 最小连接数</span></span><br><span class="line">    <span class="attr">heartbeat:</span></span><br><span class="line">      <span class="attr">statement:</span> <span class="string">select</span> <span class="string">user()</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="number">10000</span></span><br><span class="line">      <span class="attr">maxRetryCount:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-查询优化"><a href="#6-2-查询优化" class="headerlink" title="6.2 查询优化"></a>6.2 查询优化</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 避免全分片扫描</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;  <span class="comment">-- 好</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 减少跨分片 JOIN</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> user_id <span class="operator">=</span> <span class="number">100</span>;  <span class="comment">-- 可能全分片扫描</span></span><br></pre></td></tr></table></figure>

<h3 id="6-3-缓存配置"><a href="#6-3-缓存配置" class="headerlink" title="6.3 缓存配置"></a>6.3 缓存配置</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># server.yml</span></span><br><span class="line"><span class="attr">system:</span></span><br><span class="line">  <span class="comment"># 查询缓存</span></span><br><span class="line">  <span class="attr">useSqlStat:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 结果集缓存</span></span><br><span class="line">  <span class="attr">useGlobleTableCheck:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h2 id="七、故障排查"><a href="#七、故障排查" class="headerlink" title="七、故障排查"></a>七、故障排查</h2><h3 id="7-1-MyCat-无法启动"><a href="#7-1-MyCat-无法启动" class="headerlink" title="7.1 MyCat 无法启动"></a>7.1 MyCat 无法启动</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 检查 Java 环境</span></span><br><span class="line">java -version</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查端口占用</span></span><br><span class="line">netstat -tlnp | grep 8066</span><br><span class="line">netstat -tlnp | grep 9066</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看日志</span></span><br><span class="line"><span class="built_in">cat</span> /opt/mycat/logs/mycat.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查配置文件</span></span><br><span class="line"><span class="built_in">cat</span> /opt/mycat/conf/server.yml</span><br></pre></td></tr></table></figure>

<h3 id="7-2-连接失败"><a href="#7-2-连接失败" class="headerlink" title="7.2 连接失败"></a>7.2 连接失败</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 检查 MyCat 状态</span></span><br><span class="line">bin/mycat status</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查防火墙</span></span><br><span class="line">firewall-cmd --list-ports</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试连接</span></span><br><span class="line">telnet 127.0.0.1 8066</span><br></pre></td></tr></table></figure>

<h3 id="7-3-SQL-执行错误"><a href="#7-3-SQL-执行错误" class="headerlink" title="7.3 SQL 执行错误"></a>7.3 SQL 执行错误</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看数据源状态</span></span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@DATASOURCE</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看错误信息</span></span><br><span class="line"><span class="keyword">SHOW</span> @<span class="variable">@ERROR</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看 SQL 路由</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h2 id="八、备份恢复"><a href="#八、备份恢复" class="headerlink" title="八、备份恢复"></a>八、备份恢复</h2><h3 id="8-1-配置备份"><a href="#8-1-配置备份" class="headerlink" title="8.1 配置备份"></a>8.1 配置备份</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 备份配置文件</span></span><br><span class="line">tar -czf mycat_config_$(<span class="built_in">date</span> +%Y%m%d).tar.gz /opt/mycat/conf/</span><br></pre></td></tr></table></figure>

<h3 id="8-2-数据备份"><a href="#8-2-数据备份" class="headerlink" title="8.2 数据备份"></a>8.2 数据备份</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用 mysqldump 备份物理库</span></span><br><span class="line">mysqldump -h 192.168.1.100 -u mycat -p --all-databases &gt; backup.sql</span><br></pre></td></tr></table></figure>

<h2 id="九、小结"><a href="#九、小结" class="headerlink" title="九、小结"></a>九、小结</h2><h3 id="管理命令总结"><a href="#管理命令总结" class="headerlink" title="管理命令总结"></a>管理命令总结</h3><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>SHOW @@SERVER</td>
<td>查看服务器状态</td>
</tr>
<tr>
<td>SHOW @@DATASOURCE</td>
<td>查看数据源状态</td>
</tr>
<tr>
<td>SHOW @@CONNECTIONPOOL</td>
<td>查看连接池</td>
</tr>
<tr>
<td>SHOW @@SQL</td>
<td>查看 SQL 统计</td>
</tr>
<tr>
<td>SHOW @@SLOW</td>
<td>查看慢查询</td>
</tr>
</tbody></table>
<h3 id="监控要点"><a href="#监控要点" class="headerlink" title="监控要点"></a>监控要点</h3><ol>
<li><strong>定期检查</strong>：服务器状态、数据源状态</li>
<li><strong>慢查询分析</strong>：定期分析慢查询日志</li>
<li><strong>连接池监控</strong>：确保连接池健康</li>
<li><strong>日志管理</strong>：定期查看和分析日志</li>
</ol>
<hr>
<p><strong>下一篇</strong>：[MySQL 运维篇 05-01 分库分表 - 分片规则](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 05-01 分库分表 - 分片规则&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 运维篇 04-09 MyCat 一致性 Hash](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 04-09 MyCat 一致性 Hash&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 运维篇</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>MyCat</tag>
        <tag>管理</tag>
        <tag>监控</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 运维篇 04-09 MyCat 一致性 Hash</title>
    <url>/2026/02/24/MySQL%20%E8%BF%90%E7%BB%B4%E7%AF%87%2004-09%20MyCat%20%E4%B8%80%E8%87%B4%E6%80%A7%20Hash/</url>
    <content><![CDATA[<h1 id="MySQL-运维篇-04-09-MyCat-一致性-Hash"><a href="#MySQL-运维篇-04-09-MyCat-一致性-Hash" class="headerlink" title="MySQL 运维篇 04-09 MyCat 一致性 Hash"></a>MySQL 运维篇 04-09 MyCat 一致性 Hash</h1><p>一致性 Hash 是一种分布式哈希技术，可以减少扩容时的数据迁移量。本文将介绍一致性 Hash 的原理和在 MyCat 中的应用。</p>
<h2 id="一、一致性-Hash-介绍"><a href="#一、一致性-Hash-介绍" class="headerlink" title="一、一致性 Hash 介绍"></a>一、一致性 Hash 介绍</h2><h3 id="1-1-什么是一致性-Hash"><a href="#1-1-什么是一致性-Hash" class="headerlink" title="1.1 什么是一致性 Hash"></a>1.1 什么是一致性 Hash</h3><p><strong>一致性 Hash</strong>：将数据和节点映射到一个哈希环上，数据存储在顺时针方向最近的节点上。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">传统 Hash 问题：</span><br><span class="line">- 扩容时需要 rehash 所有数据</span><br><span class="line">- 数据迁移量大</span><br><span class="line"></span><br><span class="line">一致性 Hash 优势：</span><br><span class="line">- 扩容时只影响相邻节点</span><br><span class="line">- 数据迁移量小</span><br></pre></td></tr></table></figure>

<h3 id="1-2-原理"><a href="#1-2-原理" class="headerlink" title="1.2 原理"></a>1.2 原理</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">哈希环示意图：</span><br><span class="line"></span><br><span class="line">          节点 A (hash=100)</span><br><span class="line">         /         \</span><br><span class="line">        /           \</span><br><span class="line">  数据 X            数据 Y</span><br><span class="line"> (hash=50)        (hash=200)</span><br><span class="line">      |             |</span><br><span class="line">      |             |</span><br><span class="line">  节点 C         节点 B</span><br><span class="line"> (hash=0)      (hash=300)</span><br><span class="line"></span><br><span class="line">数据存储规则：</span><br><span class="line">- 数据 X (50) → 顺时针到节点 A (100)</span><br><span class="line">- 数据 Y (200) → 顺时针到节点 B (300)</span><br></pre></td></tr></table></figure>

<h3 id="1-3-虚拟节点"><a href="#1-3-虚拟节点" class="headerlink" title="1.3 虚拟节点"></a>1.3 虚拟节点</h3><p><strong>虚拟节点</strong>：每个物理节点对应多个虚拟节点，使数据分布更均匀。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">物理节点 A → 虚拟节点 A1, A2, A3, ...</span><br><span class="line">物理节点 B → 虚拟节点 B1, B2, B3, ...</span><br></pre></td></tr></table></figure>

<h2 id="二、MyCat-配置"><a href="#二、MyCat-配置" class="headerlink" title="二、MyCat 配置"></a>二、MyCat 配置</h2><h3 id="2-1-rule-yml"><a href="#2-1-rule-yml" class="headerlink" title="2.1 rule.yml"></a>2.1 rule.yml</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tableRules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">consistent-hash</span></span><br><span class="line">    <span class="attr">function:</span> <span class="string">consistent-hash</span></span><br><span class="line">    <span class="attr">columns:</span> <span class="string">id</span></span><br><span class="line"></span><br><span class="line"><span class="attr">functions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">consistent-hash</span></span><br><span class="line">    <span class="attr">className:</span> <span class="string">io.mycat.router.function.PartitionByConsistentHash</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">virtualNodeCount:</span> <span class="number">1000</span>    <span class="comment"># 虚拟节点数量</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-schema-yml"><a href="#2-2-schema-yml" class="headerlink" title="2.2 schema.yml"></a>2.2 schema.yml</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">schemas:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">testdb</span></span><br><span class="line">    <span class="attr">tables:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">orders</span></span><br><span class="line">        <span class="attr">primaryKey:</span> <span class="string">id</span></span><br><span class="line">        <span class="attr">dataNodes:</span> <span class="string">dn0,dn1,dn2,dn3</span></span><br><span class="line">        <span class="attr">rule:</span> <span class="string">consistent-hash</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-datasource-yml"><a href="#2-3-datasource-yml" class="headerlink" title="2.3 datasource.yml"></a>2.3 datasource.yml</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">dataNodes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn0</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">db0</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn1</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">db1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn2</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">db2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn3</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">db3</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dataHosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">maxCon:</span> <span class="number">1000</span></span><br><span class="line">    <span class="attr">minCon:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">heartbeat:</span></span><br><span class="line">      <span class="attr">statement:</span> <span class="string">select</span> <span class="string">user()</span></span><br><span class="line">    <span class="attr">writeHosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">master</span></span><br><span class="line">        <span class="attr">url:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.100</span><span class="string">:3306</span></span><br><span class="line">        <span class="attr">user:</span> <span class="string">mycat</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">MyCat@123</span></span><br></pre></td></tr></table></figure>

<h2 id="三、测试验证"><a href="#三、测试验证" class="headerlink" title="三、测试验证"></a>三、测试验证</h2><h3 id="3-1-插入数据"><a href="#3-1-插入数据" class="headerlink" title="3.1 插入数据"></a>3.1 插入数据</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">USE testdb;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (id, order_no, user_id, amount) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">1</span>, <span class="string">&#x27;ORD001&#x27;</span>, <span class="number">100</span>, <span class="number">199.99</span>),</span><br><span class="line">(<span class="number">2</span>, <span class="string">&#x27;ORD002&#x27;</span>, <span class="number">101</span>, <span class="number">299.99</span>),</span><br><span class="line">(<span class="number">3</span>, <span class="string">&#x27;ORD003&#x27;</span>, <span class="number">102</span>, <span class="number">399.99</span>),</span><br><span class="line">(<span class="number">4</span>, <span class="string">&#x27;ORD004&#x27;</span>, <span class="number">103</span>, <span class="number">499.99</span>),</span><br><span class="line">(<span class="number">5</span>, <span class="string">&#x27;ORD005&#x27;</span>, <span class="number">104</span>, <span class="number">599.99</span>);</span><br></pre></td></tr></table></figure>

<h3 id="3-2-查询数据"><a href="#3-2-查询数据" class="headerlink" title="3.2 查询数据"></a>3.2 查询数据</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询全部数据</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 单分片查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 聚合查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> orders;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-验证数据分布"><a href="#3-3-验证数据分布" class="headerlink" title="3.3 验证数据分布"></a>3.3 验证数据分布</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看各分片数据量</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;db0&#x27;</span> <span class="keyword">AS</span> db_name, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt <span class="keyword">FROM</span> db0.orders</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;db1&#x27;</span> <span class="keyword">AS</span> db_name, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt <span class="keyword">FROM</span> db1.orders</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;db2&#x27;</span> <span class="keyword">AS</span> db_name, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt <span class="keyword">FROM</span> db2.orders</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;db3&#x27;</span> <span class="keyword">AS</span> db_name, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt <span class="keyword">FROM</span> db3.orders;</span><br></pre></td></tr></table></figure>

<h2 id="四、批量插入测试"><a href="#四、批量插入测试" class="headerlink" title="四、批量插入测试"></a>四、批量插入测试</h2><h3 id="4-1-存储过程"><a href="#4-1-存储过程" class="headerlink" title="4.1 存储过程"></a>4.1 存储过程</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> batch_insert_orders(<span class="keyword">IN</span> count <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    WHILE i <span class="operator">&lt;=</span> count DO</span><br><span class="line">        <span class="keyword">INSERT INTO</span> orders (id, order_no, user_id, amount)</span><br><span class="line">        <span class="keyword">VALUES</span> (i, CONCAT(<span class="string">&#x27;ORD&#x27;</span>, LPAD(i, <span class="number">6</span>, <span class="string">&#x27;0&#x27;</span>)), <span class="built_in">FLOOR</span>(RAND() <span class="operator">*</span> <span class="number">1000</span>), RAND() <span class="operator">*</span> <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">SET</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">END</span> WHILE;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入 10000 条数据</span></span><br><span class="line"><span class="keyword">CALL</span> batch_insert_orders(<span class="number">10000</span>);</span><br></pre></td></tr></table></figure>

<h3 id="4-2-查看数据分布"><a href="#4-2-查看数据分布" class="headerlink" title="4.2 查看数据分布"></a>4.2 查看数据分布</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看各分片数据量</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;db0&#x27;</span> <span class="keyword">AS</span> db_name, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt <span class="keyword">FROM</span> db0.orders</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;db1&#x27;</span> <span class="keyword">AS</span> db_name, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt <span class="keyword">FROM</span> db1.orders</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;db2&#x27;</span> <span class="keyword">AS</span> db_name, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt <span class="keyword">FROM</span> db2.orders</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;db3&#x27;</span> <span class="keyword">AS</span> db_name, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt <span class="keyword">FROM</span> db3.orders;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 一致性 Hash 应该分布更均匀</span></span><br></pre></td></tr></table></figure>

<h2 id="五、扩容测试"><a href="#五、扩容测试" class="headerlink" title="五、扩容测试"></a>五、扩容测试</h2><h3 id="5-1-添加新节点"><a href="#5-1-添加新节点" class="headerlink" title="5.1 添加新节点"></a>5.1 添加新节点</h3><p><strong>datasource.yml</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">dataNodes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn0</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">db0</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn1</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">db1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn2</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">db2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn3</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">db3</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dn4</span>        <span class="comment"># 新增节点</span></span><br><span class="line">    <span class="attr">dataHost:</span> <span class="string">host1</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">db4</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-数据迁移"><a href="#5-2-数据迁移" class="headerlink" title="5.2 数据迁移"></a>5.2 数据迁移</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">一致性 Hash 扩容影响：</span><br><span class="line">- 只影响新节点相邻的数据</span><br><span class="line">- 其他数据不受影响</span><br><span class="line">- 迁移量远小于取模分片</span><br></pre></td></tr></table></figure>

<h2 id="六、一致性-Hash-vs-取模"><a href="#六、一致性-Hash-vs-取模" class="headerlink" title="六、一致性 Hash vs 取模"></a>六、一致性 Hash vs 取模</h2><h3 id="6-1-对比"><a href="#6-1-对比" class="headerlink" title="6.1 对比"></a>6.1 对比</h3><table>
<thead>
<tr>
<th>特性</th>
<th>一致性 Hash</th>
<th>取模分片</th>
</tr>
</thead>
<tbody><tr>
<td>数据分布</td>
<td>均匀</td>
<td>均匀</td>
</tr>
<tr>
<td>扩容影响</td>
<td>小</td>
<td>大</td>
</tr>
<tr>
<td>实现复杂度</td>
<td>高</td>
<td>低</td>
</tr>
<tr>
<td>查询效率</td>
<td>高</td>
<td>高</td>
</tr>
</tbody></table>
<h3 id="6-2-选择建议"><a href="#6-2-选择建议" class="headerlink" title="6.2 选择建议"></a>6.2 选择建议</h3><table>
<thead>
<tr>
<th>场景</th>
<th>推荐</th>
</tr>
</thead>
<tbody><tr>
<td>需要频繁扩容</td>
<td>一致性 Hash</td>
</tr>
<tr>
<td>分片数固定</td>
<td>取模分片</td>
</tr>
<tr>
<td>数据量大</td>
<td>一致性 Hash</td>
</tr>
<tr>
<td>简单场景</td>
<td>取模分片</td>
</tr>
</tbody></table>
<h2 id="七、小结"><a href="#七、小结" class="headerlink" title="七、小结"></a>七、小结</h2><h3 id="一致性-Hash-要点"><a href="#一致性-Hash-要点" class="headerlink" title="一致性 Hash 要点"></a>一致性 Hash 要点</h3><ol>
<li><strong>哈希环</strong>：数据和节点映射到环上</li>
<li><strong>虚拟节点</strong>：使数据分布更均匀</li>
<li><strong>扩容优势</strong>：只影响相邻节点</li>
<li><strong>适用场景</strong>：需要频繁扩容的场景</li>
</ol>
<h3 id="配置总结"><a href="#配置总结" class="headerlink" title="配置总结"></a>配置总结</h3><table>
<thead>
<tr>
<th>配置项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>consistent-hash</td>
<td>一致性 Hash 规则</td>
</tr>
<tr>
<td>virtualNodeCount</td>
<td>虚拟节点数量</td>
</tr>
</tbody></table>
<hr>
<p><strong>下一篇</strong>：[MySQL 运维篇 04-10 MyCat 管理与监控](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 04-10 MyCat 管理与监控&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 运维篇 04-08 MyCat 取模分片](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 运维篇 04-08 MyCat 取模分片&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 运维篇</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>MyCat</tag>
        <tag>一致性 Hash</tag>
        <tag>分片</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 进阶教程 02-01 数据库约束详解</title>
    <url>/2026/02/23/MySQL%20%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B%2002-01%20%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BA%A6%E6%9D%9F%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<h1 id="MySQL-进阶教程-02-01-数据库约束详解"><a href="#MySQL-进阶教程-02-01-数据库约束详解" class="headerlink" title="MySQL 进阶教程 02-01 数据库约束详解"></a>MySQL 进阶教程 02-01 数据库约束详解</h1><p>数据库约束用于保证数据的完整性、一致性和有效性。本文将详细讲解 MySQL 中的各种约束类型及其使用方法。</p>
<h2 id="一、约束概述"><a href="#一、约束概述" class="headerlink" title="一、约束概述"></a>一、约束概述</h2><h3 id="1-1-什么是约束？"><a href="#1-1-什么是约束？" class="headerlink" title="1.1 什么是约束？"></a>1.1 什么是约束？</h3><p><strong>约束（Constraint）</strong> 是施加在数据库表上的规则，用于限制可以存储在表中的数据，确保数据的准确性和可靠性。</p>
<h3 id="1-2-约束的作用"><a href="#1-2-约束的作用" class="headerlink" title="1.2 约束的作用"></a>1.2 约束的作用</h3><ol>
<li><strong>保证数据完整性</strong>：防止无效或不一致的数据</li>
<li><strong>维护数据一致性</strong>：确保相关表之间的数据关系正确</li>
<li><strong>提高数据质量</strong>：强制执行业务规则</li>
<li><strong>减少应用层验证</strong>：在数据库层面进行数据验证</li>
</ol>
<h3 id="1-3-约束的分类"><a href="#1-3-约束的分类" class="headerlink" title="1.3 约束的分类"></a>1.3 约束的分类</h3><table>
<thead>
<tr>
<th>约束类型</th>
<th>关键字</th>
<th>说明</th>
<th>列级&#x2F;表级</th>
</tr>
</thead>
<tbody><tr>
<td>主键约束</td>
<td>PRIMARY KEY</td>
<td>唯一标识每条记录</td>
<td>两者</td>
</tr>
<tr>
<td>外键约束</td>
<td>FOREIGN KEY</td>
<td>建立表与表之间的关系</td>
<td>表级</td>
</tr>
<tr>
<td>唯一约束</td>
<td>UNIQUE</td>
<td>列值必须唯一</td>
<td>两者</td>
</tr>
<tr>
<td>非空约束</td>
<td>NOT NULL</td>
<td>列值不能为空</td>
<td>列级</td>
</tr>
<tr>
<td>默认约束</td>
<td>DEFAULT</td>
<td>列的默认值</td>
<td>列级</td>
</tr>
<tr>
<td>检查约束</td>
<td>CHECK</td>
<td>满足指定条件</td>
<td>表级</td>
</tr>
</tbody></table>
<h3 id="1-4-约束的定义时机"><a href="#1-4-约束的定义时机" class="headerlink" title="1.4 约束的定义时机"></a>1.4 约束的定义时机</h3><ul>
<li><strong>列级约束</strong>：在定义列时指定，直接跟在列名后面</li>
<li><strong>表级约束</strong>：在所有列定义完成后，在表末尾指定</li>
</ul>
<h2 id="二、约束演示"><a href="#二、约束演示" class="headerlink" title="二、约束演示"></a>二、约束演示</h2><h3 id="2-1-创建表时添加约束"><a href="#2-1-创建表时添加约束" class="headerlink" title="2.1 创建表时添加约束"></a>2.1 创建表时添加约束</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 完整示例：员工表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> employees (</span><br><span class="line">    <span class="comment">-- 主键约束</span></span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;员工 ID&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 非空约束</span></span><br><span class="line">    emp_no <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;员工编号&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 非空 + 唯一约束</span></span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">UNIQUE</span> COMMENT <span class="string">&#x27;邮箱&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 默认约束</span></span><br><span class="line">    gender ENUM(<span class="string">&#x27;男&#x27;</span>, <span class="string">&#x27;女&#x27;</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;男&#x27;</span> COMMENT <span class="string">&#x27;性别&#x27;</span>,</span><br><span class="line">    status TINYINT <span class="keyword">DEFAULT</span> <span class="number">1</span> COMMENT <span class="string">&#x27;状态：1 在职 0 离职&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 检查约束（MySQL 8.0.16+ 支持）</span></span><br><span class="line">    age TINYINT <span class="keyword">CHECK</span> (age <span class="operator">&gt;=</span> <span class="number">18</span> <span class="keyword">AND</span> age <span class="operator">&lt;=</span> <span class="number">65</span>) COMMENT <span class="string">&#x27;年龄&#x27;</span>,</span><br><span class="line">    salary <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">CHECK</span> (salary <span class="operator">&gt;=</span> <span class="number">0</span>) COMMENT <span class="string">&#x27;工资&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 日期约束</span></span><br><span class="line">    hire_date <span class="type">DATE</span> <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;入职日期&#x27;</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 COMMENT<span class="operator">=</span><span class="string">&#x27;员工表&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-表级约束语法"><a href="#2-2-表级约束语法" class="headerlink" title="2.2 表级约束语法"></a>2.2 表级约束语法</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> employees (</span><br><span class="line">    id <span class="type">INT</span> AUTO_INCREMENT,</span><br><span class="line">    emp_no <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    dept_id <span class="type">INT</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 表级约束（使用 CONSTRAINT 命名）</span></span><br><span class="line">    <span class="keyword">CONSTRAINT</span> pk_employees <span class="keyword">PRIMARY KEY</span> (id),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> uk_employees_emp_no <span class="keyword">UNIQUE</span> (emp_no),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> uk_employees_email <span class="keyword">UNIQUE</span> (email),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> chk_employees_age <span class="keyword">CHECK</span> (age <span class="operator">&gt;=</span> <span class="number">18</span> <span class="keyword">AND</span> age <span class="operator">&lt;=</span> <span class="number">65</span>),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> chk_employees_salary <span class="keyword">CHECK</span> (salary <span class="operator">&gt;=</span> <span class="number">0</span>)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br></pre></td></tr></table></figure>

<p><strong>约束命名规范</strong>：</p>
<ul>
<li>主键约束：<code>pk_表名</code> 或 <code>pk_表名_列名</code></li>
<li>外键约束：<code>fk_表名_关联表名</code> 或 <code>fk_表名_列名</code></li>
<li>唯一约束：<code>uk_表名_列名</code></li>
<li>检查约束：<code>chk_表名_列名</code></li>
</ul>
<h3 id="2-3-修改表添加约束"><a href="#2-3-修改表添加约束" class="headerlink" title="2.3 修改表添加约束"></a>2.3 修改表添加约束</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 添加主键约束</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> employees <span class="keyword">ADD</span> <span class="keyword">PRIMARY KEY</span> (id);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 添加唯一约束</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> employees <span class="keyword">ADD</span> <span class="keyword">UNIQUE</span> (emp_no);</span><br><span class="line"><span class="keyword">ALTER TABLE</span> employees <span class="keyword">ADD CONSTRAINT</span> uk_email <span class="keyword">UNIQUE</span> (email);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 添加非空约束</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> employees MODIFY <span class="keyword">COLUMN</span> name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 添加默认约束</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> employees <span class="keyword">ALTER</span> <span class="keyword">COLUMN</span> status <span class="keyword">SET</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">ALTER TABLE</span> employees <span class="keyword">ALTER</span> <span class="keyword">COLUMN</span> status <span class="keyword">DROP</span> <span class="keyword">DEFAULT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 添加检查约束（MySQL 8.0.16+）</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> employees <span class="keyword">ADD CONSTRAINT</span> chk_age <span class="keyword">CHECK</span> (age <span class="operator">&gt;=</span> <span class="number">18</span> <span class="keyword">AND</span> age <span class="operator">&lt;=</span> <span class="number">65</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除约束</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> employees <span class="keyword">DROP</span> <span class="keyword">PRIMARY KEY</span>;</span><br><span class="line"><span class="keyword">ALTER TABLE</span> employees <span class="keyword">DROP</span> INDEX uk_email;</span><br><span class="line"><span class="keyword">ALTER TABLE</span> employees <span class="keyword">DROP</span> <span class="keyword">CHECK</span> chk_age;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-查看约束信息"><a href="#2-4-查看约束信息" class="headerlink" title="2.4 查看约束信息"></a>2.4 查看约束信息</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看表结构（显示约束）</span></span><br><span class="line"><span class="keyword">DESC</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看详细表结构</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE TABLE</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看表的所有约束</span></span><br><span class="line"><span class="keyword">SELECT</span> CONSTRAINT_NAME, CONSTRAINT_TYPE, TABLE_NAME</span><br><span class="line"><span class="keyword">FROM</span> information_schema.TABLE_CONSTRAINTS</span><br><span class="line"><span class="keyword">WHERE</span> TABLE_SCHEMA <span class="operator">=</span> <span class="string">&#x27;your_database&#x27;</span> <span class="keyword">AND</span> TABLE_NAME <span class="operator">=</span> <span class="string">&#x27;employees&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看外键约束</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    CONSTRAINT_NAME,</span><br><span class="line">    TABLE_NAME,</span><br><span class="line">    COLUMN_NAME,</span><br><span class="line">    REFERENCED_TABLE_NAME,</span><br><span class="line">    REFERENCED_COLUMN_NAME</span><br><span class="line"><span class="keyword">FROM</span> information_schema.KEY_COLUMN_USAGE</span><br><span class="line"><span class="keyword">WHERE</span> TABLE_SCHEMA <span class="operator">=</span> <span class="string">&#x27;your_database&#x27;</span> <span class="keyword">AND</span> TABLE_NAME <span class="operator">=</span> <span class="string">&#x27;employees&#x27;</span></span><br><span class="line"><span class="keyword">AND</span> REFERENCED_TABLE_NAME <span class="keyword">IS</span> <span class="keyword">NOT NULL</span>;</span><br></pre></td></tr></table></figure>

<h2 id="三、主键约束（PRIMARY-KEY）"><a href="#三、主键约束（PRIMARY-KEY）" class="headerlink" title="三、主键约束（PRIMARY KEY）"></a>三、主键约束（PRIMARY KEY）</h2><h3 id="3-1-主键的特点"><a href="#3-1-主键的特点" class="headerlink" title="3.1 主键的特点"></a>3.1 主键的特点</h3><ol>
<li><strong>唯一性</strong>：主键值必须唯一</li>
<li><strong>非空性</strong>：主键值不能为 NULL</li>
<li><strong>单一性</strong>：一张表只能有一个主键</li>
<li><strong>可组合</strong>：主键可以由多列组成（复合主键）</li>
</ol>
<h3 id="3-2-创建主键"><a href="#3-2-创建主键" class="headerlink" title="3.2 创建主键"></a>3.2 创建主键</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 单列主键</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用 CONSTRAINT 命名</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users (</span><br><span class="line">    id <span class="type">INT</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> pk_users <span class="keyword">PRIMARY KEY</span> (id)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 复合主键（不推荐，建议使用单列主键）</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> order_items (</span><br><span class="line">    order_id <span class="type">INT</span>,</span><br><span class="line">    product_id <span class="type">INT</span>,</span><br><span class="line">    quantity <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (order_id, product_id)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 自增主键（最常用）</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="3-3-修改主键"><a href="#3-3-修改主键" class="headerlink" title="3.3 修改主键"></a>3.3 修改主键</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 添加主键</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> users <span class="keyword">ADD</span> <span class="keyword">PRIMARY KEY</span> (id);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除主键</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> users <span class="keyword">DROP</span> <span class="keyword">PRIMARY KEY</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改主键（先删除再添加）</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> users <span class="keyword">DROP</span> <span class="keyword">PRIMARY KEY</span>;</span><br><span class="line"><span class="keyword">ALTER TABLE</span> users <span class="keyword">ADD</span> <span class="keyword">PRIMARY KEY</span> (new_id);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改为复合主键</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> order_items</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line"><span class="keyword">ADD</span> <span class="keyword">PRIMARY KEY</span> (order_id, product_id);</span><br></pre></td></tr></table></figure>

<h3 id="3-4-主键选择建议"><a href="#3-4-主键选择建议" class="headerlink" title="3.4 主键选择建议"></a>3.4 主键选择建议</h3><ol>
<li><strong>使用无业务意义的列</strong>：如自增 ID、UUID</li>
<li><strong>避免使用业务字段</strong>：如身份证号、手机号可能变化</li>
<li><strong>优先使用单列主键</strong>：简化外键引用</li>
<li><strong>避免使用过长主键</strong>：影响索引性能</li>
</ol>
<h2 id="四、唯一约束（UNIQUE）"><a href="#四、唯一约束（UNIQUE）" class="headerlink" title="四、唯一约束（UNIQUE）"></a>四、唯一约束（UNIQUE）</h2><h3 id="4-1-唯一约束的特点"><a href="#4-1-唯一约束的特点" class="headerlink" title="4.1 唯一约束的特点"></a>4.1 唯一约束的特点</h3><ol>
<li><strong>唯一性</strong>：列值必须唯一</li>
<li><strong>允许 NULL</strong>：可以有多个 NULL 值（但有些数据库只允许一个）</li>
<li><strong>多列唯一</strong>：可以创建复合唯一索引</li>
</ol>
<h3 id="4-2-创建唯一约束"><a href="#4-2-创建唯一约束" class="headerlink" title="4.2 创建唯一约束"></a>4.2 创建唯一约束</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 列级唯一约束</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    username <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">UNIQUE</span>,</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">UNIQUE</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 表级唯一约束</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users (</span><br><span class="line">    id <span class="type">INT</span>,</span><br><span class="line">    username <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    <span class="keyword">UNIQUE</span> (username),</span><br><span class="line">    <span class="keyword">UNIQUE</span> (email)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 命名唯一约束</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users (</span><br><span class="line">    id <span class="type">INT</span>,</span><br><span class="line">    username <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> uk_username <span class="keyword">UNIQUE</span> (username),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> uk_email <span class="keyword">UNIQUE</span> (email)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 复合唯一约束（多列组合唯一）</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> user_roles (</span><br><span class="line">    user_id <span class="type">INT</span>,</span><br><span class="line">    role_id <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> uk_user_role <span class="keyword">UNIQUE</span> (user_id, role_id)</span><br><span class="line">);</span><br><span class="line"><span class="comment">-- 同一个用户不能有相同的角色，但不同用户可以有相同角色</span></span><br></pre></td></tr></table></figure>

<h3 id="4-3-唯一约束与主键的区别"><a href="#4-3-唯一约束与主键的区别" class="headerlink" title="4.3 唯一约束与主键的区别"></a>4.3 唯一约束与主键的区别</h3><table>
<thead>
<tr>
<th>对比项</th>
<th>主键约束</th>
<th>唯一约束</th>
</tr>
</thead>
<tbody><tr>
<td>NULL 值</td>
<td>不允许</td>
<td>允许（可以有多个 NULL）</td>
</tr>
<tr>
<td>数量</td>
<td>一张表只能有一个</td>
<td>一张表可以有多个</td>
</tr>
<tr>
<td>索引类型</td>
<td>创建聚簇索引（InnoDB）</td>
<td>创建唯一索引</td>
</tr>
<tr>
<td>用途</td>
<td>唯一标识记录</td>
<td>保证列值唯一</td>
</tr>
</tbody></table>
<h2 id="五、非空约束（NOT-NULL）"><a href="#五、非空约束（NOT-NULL）" class="headerlink" title="五、非空约束（NOT NULL）"></a>五、非空约束（NOT NULL）</h2><h3 id="5-1-非空约束的特点"><a href="#5-1-非空约束的特点" class="headerlink" title="5.1 非空约束的特点"></a>5.1 非空约束的特点</h3><ul>
<li>列值不能为 NULL</li>
<li>只能在列级定义，不能在表级定义</li>
<li>插入或更新时必须提供值</li>
</ul>
<h3 id="5-2-创建非空约束"><a href="#5-2-创建非空约束" class="headerlink" title="5.2 创建非空约束"></a>5.2 创建非空约束</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建时指定非空</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    username <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    phone <span class="type">VARCHAR</span>(<span class="number">20</span>),  <span class="comment">-- 允许 NULL</span></span><br><span class="line">    age <span class="type">INT</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改为非空</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> users MODIFY <span class="keyword">COLUMN</span> age <span class="type">INT</span> <span class="keyword">NOT NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改为允许 NULL</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> users MODIFY <span class="keyword">COLUMN</span> age <span class="type">INT</span>;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-非空约束实战"><a href="#5-3-非空约束实战" class="headerlink" title="5.3 非空约束实战"></a>5.3 非空约束实战</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 尝试插入 NULL 值（会报错）</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> users (id, username) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="keyword">NULL</span>);</span><br><span class="line"><span class="comment">-- ERROR: Column &#x27;username&#x27; cannot be null</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 正确插入</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> users (id, username, email) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;john&#x27;</span>, <span class="string">&#x27;john@example.com&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用 IFNULL 处理可能为 NULL 的查询</span></span><br><span class="line"><span class="keyword">SELECT</span> username, IFNULL(phone, <span class="string">&#x27;未填写&#x27;</span>) <span class="keyword">AS</span> phone <span class="keyword">FROM</span> users;</span><br></pre></td></tr></table></figure>

<h2 id="六、默认约束（DEFAULT）"><a href="#六、默认约束（DEFAULT）" class="headerlink" title="六、默认约束（DEFAULT）"></a>六、默认约束（DEFAULT）</h2><h3 id="6-1-默认约束的特点"><a href="#6-1-默认约束的特点" class="headerlink" title="6.1 默认约束的特点"></a>6.1 默认约束的特点</h3><ul>
<li>插入数据时如果不指定该列，则使用默认值</li>
<li>默认值可以是常量、表达式或函数</li>
</ul>
<h3 id="6-2-创建默认约束"><a href="#6-2-创建默认约束" class="headerlink" title="6.2 创建默认约束"></a>6.2 创建默认约束</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> users (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    username <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 常量默认值</span></span><br><span class="line">    status TINYINT <span class="keyword">DEFAULT</span> <span class="number">1</span>,</span><br><span class="line">    gender ENUM(<span class="string">&#x27;男&#x27;</span>, <span class="string">&#x27;女&#x27;</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;男&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 函数默认值</span></span><br><span class="line">    create_time DATETIME <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    update_time DATETIME <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- NULL 默认值（显式指定）</span></span><br><span class="line">    remark <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="6-3-默认约束实战"><a href="#6-3-默认约束实战" class="headerlink" title="6.3 默认约束实战"></a>6.3 默认约束实战</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 使用默认值插入</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> users (id, username) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;john&#x27;</span>);</span><br><span class="line"><span class="comment">-- status=1, gender=&#x27;男&#x27;, create_time=当前时间</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 显式指定值</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> users (id, username, status, gender)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;jane&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;女&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用 DEFAULT 关键字显式使用默认值</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> users (id, username, status)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;bob&#x27;</span>, <span class="keyword">DEFAULT</span>);</span><br></pre></td></tr></table></figure>

<h3 id="6-4-修改默认约束"><a href="#6-4-修改默认约束" class="headerlink" title="6.4 修改默认约束"></a>6.4 修改默认约束</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 添加默认约束</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> users <span class="keyword">ALTER</span> <span class="keyword">COLUMN</span> status <span class="keyword">SET</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除默认约束</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> users <span class="keyword">ALTER</span> <span class="keyword">COLUMN</span> status <span class="keyword">DROP</span> <span class="keyword">DEFAULT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改默认值（先删除再添加）</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> users <span class="keyword">ALTER</span> <span class="keyword">COLUMN</span> status <span class="keyword">DROP</span> <span class="keyword">DEFAULT</span>;</span><br><span class="line"><span class="keyword">ALTER TABLE</span> users <span class="keyword">ALTER</span> <span class="keyword">COLUMN</span> status <span class="keyword">SET</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<h2 id="七、检查约束（CHECK）"><a href="#七、检查约束（CHECK）" class="headerlink" title="七、检查约束（CHECK）"></a>七、检查约束（CHECK）</h2><h3 id="7-1-检查约束的特点"><a href="#7-1-检查约束的特点" class="headerlink" title="7.1 检查约束的特点"></a>7.1 检查约束的特点</h3><ul>
<li><strong>MySQL 8.0.16+</strong> 才开始支持 CHECK 约束</li>
<li>旧版本会忽略 CHECK 约束（不报错但不生效）</li>
<li>用于确保列值满足特定条件</li>
</ul>
<h3 id="7-2-创建检查约束"><a href="#7-2-创建检查约束" class="headerlink" title="7.2 创建检查约束"></a>7.2 创建检查约束</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建时添加检查约束</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> employees (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    age <span class="type">INT</span> <span class="keyword">CHECK</span> (age <span class="operator">&gt;=</span> <span class="number">18</span> <span class="keyword">AND</span> age <span class="operator">&lt;=</span> <span class="number">65</span>),</span><br><span class="line">    salary <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">CHECK</span> (salary <span class="operator">&gt;=</span> <span class="number">0</span>),</span><br><span class="line">    gender ENUM(<span class="string">&#x27;男&#x27;</span>, <span class="string">&#x27;女&#x27;</span>),</span><br><span class="line">    hire_date <span class="type">DATE</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> chk_hire_date <span class="keyword">CHECK</span> (hire_date <span class="operator">&lt;=</span> CURDATE())</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用多条件检查约束</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    amount <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">CHECK</span> (amount <span class="operator">&gt;</span> <span class="number">0</span>),</span><br><span class="line">    status <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">CHECK</span> (status <span class="keyword">IN</span> (<span class="string">&#x27;PENDING&#x27;</span>, <span class="string">&#x27;PAID&#x27;</span>, <span class="string">&#x27;SHIPPED&#x27;</span>, <span class="string">&#x27;CANCELLED&#x27;</span>)),</span><br><span class="line">    discount <span class="type">DECIMAL</span>(<span class="number">5</span>, <span class="number">2</span>) <span class="keyword">CHECK</span> (discount <span class="operator">&gt;=</span> <span class="number">0</span> <span class="keyword">AND</span> discount <span class="operator">&lt;=</span> <span class="number">100</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="7-3-修改检查约束"><a href="#7-3-修改检查约束" class="headerlink" title="7.3 修改检查约束"></a>7.3 修改检查约束</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 添加检查约束</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> employees</span><br><span class="line"><span class="keyword">ADD CONSTRAINT</span> chk_age <span class="keyword">CHECK</span> (age <span class="operator">&gt;=</span> <span class="number">18</span> <span class="keyword">AND</span> age <span class="operator">&lt;=</span> <span class="number">65</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除检查约束</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> employees</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">CHECK</span> chk_age;</span><br></pre></td></tr></table></figure>

<h3 id="7-4-检查约束实战"><a href="#7-4-检查约束实战" class="headerlink" title="7.4 检查约束实战"></a>7.4 检查约束实战</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 尝试插入违反约束的数据（会报错）</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> employees (id, name, age, salary) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;张三&#x27;</span>, <span class="number">17</span>, <span class="number">8000</span>);</span><br><span class="line"><span class="comment">-- ERROR: CHECK constraint &#x27;chk_age&#x27; is violated</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> employees (id, name, age, salary) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;张三&#x27;</span>, <span class="number">30</span>, <span class="number">-5000</span>);</span><br><span class="line"><span class="comment">-- ERROR: CHECK constraint &#x27;chk_salary&#x27; is violated</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 正确插入</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> employees (id, name, age, salary) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;张三&#x27;</span>, <span class="number">30</span>, <span class="number">8000</span>);</span><br></pre></td></tr></table></figure>

<h2 id="八、外键约束（FOREIGN-KEY）"><a href="#八、外键约束（FOREIGN-KEY）" class="headerlink" title="八、外键约束（FOREIGN KEY）"></a>八、外键约束（FOREIGN KEY）</h2><h3 id="8-1-外键概述"><a href="#8-1-外键概述" class="headerlink" title="8.1 外键概述"></a>8.1 外键概述</h3><p><strong>外键（Foreign Key）</strong> 用于建立两个表之间的链接，保证数据的参照完整性。</p>
<p><strong>外键的特点</strong>：</p>
<ol>
<li>外键列的值必须存在于被引用表的主键列中，或者为 NULL</li>
<li>外键约束可以防止无效的数据插入</li>
<li>外键约束可以级联更新和删除</li>
</ol>
<h3 id="8-2-创建外键约束"><a href="#8-2-创建外键约束" class="headerlink" title="8.2 创建外键约束"></a>8.2 创建外键约束</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建部门表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> departments (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    dept_name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span> <span class="keyword">UNIQUE</span>,</span><br><span class="line">    dept_location <span class="type">VARCHAR</span>(<span class="number">100</span>)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建员工表（带外键）</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> employees (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    emp_no <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span> <span class="keyword">UNIQUE</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    dept_id <span class="type">INT</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 外键约束</span></span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_emp_dept</span><br><span class="line">        <span class="keyword">FOREIGN KEY</span> (dept_id)</span><br><span class="line">        <span class="keyword">REFERENCES</span> departments(id)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 简写形式（不命名）</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> employees (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    dept_id <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">FOREIGN KEY</span> (dept_id) <span class="keyword">REFERENCES</span> departments(id)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br></pre></td></tr></table></figure>

<p><strong>重要提示</strong>：</p>
<ul>
<li>外键约束只在 InnoDB 引擎中生效</li>
<li>外键列和被引用列的数据类型必须相同</li>
<li>被引用列必须是主键或唯一索引</li>
</ul>
<h3 id="8-3-外键约束的参照完整性"><a href="#8-3-外键约束的参照完整性" class="headerlink" title="8.3 外键约束的参照完整性"></a>8.3 外键约束的参照完整性</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 插入部门</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> departments (dept_name, dept_location) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;技术部&#x27;</span>, <span class="string">&#x27;北京&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;市场部&#x27;</span>, <span class="string">&#x27;上海&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入员工（有效的外键值）</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> employees (emp_no, name, dept_id) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;E001&#x27;</span>, <span class="string">&#x27;张三&#x27;</span>, <span class="number">1</span>),  <span class="comment">-- 有效</span></span><br><span class="line">(<span class="string">&#x27;E002&#x27;</span>, <span class="string">&#x27;李四&#x27;</span>, <span class="number">2</span>);  <span class="comment">-- 有效</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入员工（无效的外键值，会报错）</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> employees (emp_no, name, dept_id) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;E003&#x27;</span>, <span class="string">&#x27;王五&#x27;</span>, <span class="number">99</span>);  <span class="comment">-- ERROR: 部门 99 不存在</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入员工（NULL 值，允许）</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> employees (emp_no, name, dept_id) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;E003&#x27;</span>, <span class="string">&#x27;王五&#x27;</span>, <span class="keyword">NULL</span>);  <span class="comment">-- 允许，表示该员工暂无部门</span></span><br></pre></td></tr></table></figure>

<h3 id="8-4-添加和删除外键"><a href="#8-4-添加和删除外键" class="headerlink" title="8.4 添加和删除外键"></a>8.4 添加和删除外键</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 添加外键约束</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> employees</span><br><span class="line"><span class="keyword">ADD CONSTRAINT</span> fk_emp_dept</span><br><span class="line"><span class="keyword">FOREIGN KEY</span> (dept_id) <span class="keyword">REFERENCES</span> departments(id);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除外键约束</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> employees</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">FOREIGN KEY</span> fk_emp_dept;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除外键后，还需要删除对应的外键索引</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> employees <span class="keyword">DROP</span> INDEX dept_id;</span><br></pre></td></tr></table></figure>

<h3 id="8-5-查看外键信息"><a href="#8-5-查看外键信息" class="headerlink" title="8.5 查看外键信息"></a>8.5 查看外键信息</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看表的外键</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE TABLE</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 从 information_schema 查询外键</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    TABLE_NAME,</span><br><span class="line">    COLUMN_NAME,</span><br><span class="line">    CONSTRAINT_NAME,</span><br><span class="line">    REFERENCED_TABLE_NAME,</span><br><span class="line">    REFERENCED_COLUMN_NAME</span><br><span class="line"><span class="keyword">FROM</span> information_schema.KEY_COLUMN_USAGE</span><br><span class="line"><span class="keyword">WHERE</span> TABLE_SCHEMA <span class="operator">=</span> <span class="string">&#x27;your_database&#x27;</span></span><br><span class="line"><span class="keyword">AND</span> TABLE_NAME <span class="operator">=</span> <span class="string">&#x27;employees&#x27;</span></span><br><span class="line"><span class="keyword">AND</span> REFERENCED_TABLE_NAME <span class="keyword">IS</span> <span class="keyword">NOT NULL</span>;</span><br></pre></td></tr></table></figure>

<h2 id="九、外键的删除和更新行为"><a href="#九、外键的删除和更新行为" class="headerlink" title="九、外键的删除和更新行为"></a>九、外键的删除和更新行为</h2><h3 id="9-1-外键行为选项"><a href="#9-1-外键行为选项" class="headerlink" title="9.1 外键行为选项"></a>9.1 外键行为选项</h3><p>当父表（被引用表）的记录被更新或删除时，子表（引用表）如何处理？</p>
<table>
<thead>
<tr>
<th>行为</th>
<th>说明</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td>RESTRICT</td>
<td>拒绝删除&#x2F;更新父表记录（默认）</td>
<td>严格参照完整性</td>
</tr>
<tr>
<td>NO ACTION</td>
<td>同 RESTRICT（在 MySQL 中）</td>
<td>严格参照完整性</td>
</tr>
<tr>
<td>CASCADE</td>
<td>级联删除&#x2F;更新</td>
<td>强关联数据</td>
</tr>
<tr>
<td>SET NULL</td>
<td>将外键设为 NULL</td>
<td>可选关联</td>
</tr>
<tr>
<td>SET DEFAULT</td>
<td>设为默认值（MySQL 不支持）</td>
<td>-</td>
</tr>
</tbody></table>
<h3 id="9-2-CASCADE（级联）"><a href="#9-2-CASCADE（级联）" class="headerlink" title="9.2 CASCADE（级联）"></a>9.2 CASCADE（级联）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建带级联删除/更新的外键</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> employees (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    dept_id <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_emp_dept</span><br><span class="line">        <span class="keyword">FOREIGN KEY</span> (dept_id)</span><br><span class="line">        <span class="keyword">REFERENCES</span> departments(id)</span><br><span class="line">        <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE    <span class="comment">-- 删除部门时，级联删除员工</span></span><br><span class="line">        <span class="keyword">ON</span> <span class="keyword">UPDATE</span> CASCADE    <span class="comment">-- 更新部门 ID 时，级联更新员工</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 演示级联删除</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> departments <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 所有 dept_id=1  的员工也会被删除</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 演示级联更新</span></span><br><span class="line"><span class="keyword">UPDATE</span> departments <span class="keyword">SET</span> id <span class="operator">=</span> <span class="number">10</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 所有 dept_id=1 的员工，dept_id 会更新为 10</span></span><br></pre></td></tr></table></figure>

<h3 id="9-3-SET-NULL（设为空）"><a href="#9-3-SET-NULL（设为空）" class="headerlink" title="9.3 SET NULL（设为空）"></a>9.3 SET NULL（设为空）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建带 SET NULL 的外键</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> employees (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    dept_id <span class="type">INT</span> <span class="keyword">NULL</span>,  <span class="comment">-- 必须允许 NULL</span></span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_emp_dept</span><br><span class="line">        <span class="keyword">FOREIGN KEY</span> (dept_id)</span><br><span class="line">        <span class="keyword">REFERENCES</span> departments(id)</span><br><span class="line">        <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">SET</span> <span class="keyword">NULL</span>  <span class="comment">-- 删除部门时，员工的 dept_id 设为 NULL</span></span><br><span class="line">        <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">SET</span> <span class="keyword">NULL</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 演示 SET NULL 删除</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> departments <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 所有 dept_id=1 的员工，dept_id 会被设为 NULL</span></span><br></pre></td></tr></table></figure>

<h3 id="9-4-RESTRICT-NO-ACTION（限制）"><a href="#9-4-RESTRICT-NO-ACTION（限制）" class="headerlink" title="9.4 RESTRICT &#x2F; NO ACTION（限制）"></a>9.4 RESTRICT &#x2F; NO ACTION（限制）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建带 RESTRICT 的外键（默认行为）</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> employees (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    dept_id <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_emp_dept</span><br><span class="line">        <span class="keyword">FOREIGN KEY</span> (dept_id)</span><br><span class="line">        <span class="keyword">REFERENCES</span> departments(id)</span><br><span class="line">        <span class="keyword">ON</span> <span class="keyword">DELETE</span> RESTRICT  <span class="comment">-- 或直接省略，默认就是 RESTRICT</span></span><br><span class="line">        <span class="keyword">ON</span> <span class="keyword">UPDATE</span> RESTRICT</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 尝试删除有员工关联的部门（会报错）</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> departments <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- ERROR: Cannot delete or update a parent row:</span></span><br><span class="line"><span class="comment">-- a foreign key constraint fails</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 必须先删除或更新子表记录</span></span><br><span class="line"><span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> dept_id <span class="operator">=</span> <span class="keyword">NULL</span> <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 或者</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 然后才能删除部门</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> departments <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h3 id="9-5-外键行为选择建议"><a href="#9-5-外键行为选择建议" class="headerlink" title="9.5 外键行为选择建议"></a>9.5 外键行为选择建议</h3><table>
<thead>
<tr>
<th>关系类型</th>
<th>推荐行为</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>强依赖关系</td>
<td>CASCADE</td>
<td>订单和订单明细</td>
</tr>
<tr>
<td>可选关联</td>
<td>SET NULL</td>
<td>员工和部门（允许暂无部门）</td>
</tr>
<tr>
<td>严格参照</td>
<td>RESTRICT</td>
<td>用户和账户（不允许删除有账户的用户）</td>
</tr>
<tr>
<td>历史数据</td>
<td>RESTRICT + 逻辑删除</td>
<td>不允许物理删除，只标记状态</td>
</tr>
</tbody></table>
<h3 id="9-6-外键实战案例"><a href="#9-6-外键实战案例" class="headerlink" title="9.6 外键实战案例"></a>9.6 外键实战案例</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 案例 1：订单系统（级联删除）</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    user_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    order_no <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">UNIQUE</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_orders_user</span><br><span class="line">        <span class="keyword">FOREIGN KEY</span> (user_id)</span><br><span class="line">        <span class="keyword">REFERENCES</span> users(id)</span><br><span class="line">        <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE</span><br><span class="line">        <span class="keyword">ON</span> <span class="keyword">UPDATE</span> CASCADE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE TABLE</span> order_items (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    order_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    product_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    quantity <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_items_order</span><br><span class="line">        <span class="keyword">FOREIGN KEY</span> (order_id)</span><br><span class="line">        <span class="keyword">REFERENCES</span> orders(id)</span><br><span class="line">        <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除用户时，自动删除其所有订单和订单明细</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 案例 2：文章评论系统（SET NULL）</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> articles (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    title <span class="type">VARCHAR</span>(<span class="number">200</span>),</span><br><span class="line">    author_id <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_articles_author</span><br><span class="line">        <span class="keyword">FOREIGN KEY</span> (author_id)</span><br><span class="line">        <span class="keyword">REFERENCES</span> users(id)</span><br><span class="line">        <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">SET</span> <span class="keyword">NULL</span>  <span class="comment">-- 作者删除后，文章保留但作者为空</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 案例 3：学生选课系统（限制删除）</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> enrollments (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    student_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    course_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_enroll_student</span><br><span class="line">        <span class="keyword">FOREIGN KEY</span> (student_id)</span><br><span class="line">        <span class="keyword">REFERENCES</span> students(id)</span><br><span class="line">        <span class="keyword">ON</span> <span class="keyword">DELETE</span> RESTRICT,  <span class="comment">-- 有选课记录时不能删除学生</span></span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_enroll_course</span><br><span class="line">        <span class="keyword">FOREIGN KEY</span> (course_id)</span><br><span class="line">        <span class="keyword">REFERENCES</span> courses(id)</span><br><span class="line">        <span class="keyword">ON</span> <span class="keyword">DELETE</span> RESTRICT   <span class="comment">-- 有选课记录时不能删除课程</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h2 id="十、约束综合实战"><a href="#十、约束综合实战" class="headerlink" title="十、约束综合实战"></a>十、约束综合实战</h2><h3 id="10-1-电商数据库设计"><a href="#10-1-电商数据库设计" class="headerlink" title="10.1 电商数据库设计"></a>10.1 电商数据库设计</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 用户表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    username <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span> <span class="keyword">UNIQUE</span>,</span><br><span class="line">    password <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT NULL</span> <span class="keyword">UNIQUE</span>,</span><br><span class="line">    phone <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">UNIQUE</span>,</span><br><span class="line">    status TINYINT <span class="keyword">DEFAULT</span> <span class="number">1</span>,</span><br><span class="line">    create_time DATETIME <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> chk_status <span class="keyword">CHECK</span> (status <span class="keyword">IN</span> (<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 商品分类表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> categories (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span> <span class="keyword">UNIQUE</span>,</span><br><span class="line">    parent_id <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    sort_order <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> chk_sort <span class="keyword">CHECK</span> (sort_order <span class="operator">&gt;=</span> <span class="number">0</span>)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 商品表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> products (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    category_id <span class="type">INT</span>,</span><br><span class="line">    price <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    stock <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    status TINYINT <span class="keyword">DEFAULT</span> <span class="number">1</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> chk_price <span class="keyword">CHECK</span> (price <span class="operator">&gt;=</span> <span class="number">0</span>),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> chk_stock <span class="keyword">CHECK</span> (stock <span class="operator">&gt;=</span> <span class="number">0</span>),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> chk_status <span class="keyword">CHECK</span> (status <span class="keyword">IN</span> (<span class="number">0</span>, <span class="number">1</span>)),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_prod_category</span><br><span class="line">        <span class="keyword">FOREIGN KEY</span> (category_id)</span><br><span class="line">        <span class="keyword">REFERENCES</span> categories(id)</span><br><span class="line">        <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">SET</span> <span class="keyword">NULL</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 订单表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    order_no <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span> <span class="keyword">UNIQUE</span>,</span><br><span class="line">    user_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    total_amount <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    status TINYINT <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    create_time DATETIME <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> chk_amount <span class="keyword">CHECK</span> (total_amount <span class="operator">&gt;=</span> <span class="number">0</span>),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> chk_order_status <span class="keyword">CHECK</span> (status <span class="keyword">IN</span> (<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_orders_user</span><br><span class="line">        <span class="keyword">FOREIGN KEY</span> (user_id)</span><br><span class="line">        <span class="keyword">REFERENCES</span> users(id)</span><br><span class="line">        <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 订单明细表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> order_items (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    order_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    product_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    price <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    quantity <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> chk_quantity <span class="keyword">CHECK</span> (quantity <span class="operator">&gt;</span> <span class="number">0</span>),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> chk_item_price <span class="keyword">CHECK</span> (price <span class="operator">&gt;=</span> <span class="number">0</span>),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_items_order</span><br><span class="line">        <span class="keyword">FOREIGN KEY</span> (order_id)</span><br><span class="line">        <span class="keyword">REFERENCES</span> orders(id)</span><br><span class="line">        <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_items_product</span><br><span class="line">        <span class="keyword">FOREIGN KEY</span> (product_id)</span><br><span class="line">        <span class="keyword">REFERENCES</span> products(id)</span><br><span class="line">        <span class="keyword">ON</span> <span class="keyword">DELETE</span> RESTRICT</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br></pre></td></tr></table></figure>

<h3 id="10-2-约束测试"><a href="#10-2-约束测试" class="headerlink" title="10.2 约束测试"></a>10.2 约束测试</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 测试 1：插入有效数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> users (username, password, email)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;test&#x27;</span>, <span class="string">&#x27;pwd123&#x27;</span>, <span class="string">&#x27;test@example.com&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 测试 2：违反唯一约束</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> users (username, password, email)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;test&#x27;</span>, <span class="string">&#x27;pwd456&#x27;</span>, <span class="string">&#x27;test2@example.com&#x27;</span>);  <span class="comment">-- ERROR: 用户名重复</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 测试 3：违反非空约束</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> users (username, email) <span class="keyword">VALUES</span> (<span class="keyword">NULL</span>, <span class="string">&#x27;test@example.com&#x27;</span>);  <span class="comment">-- ERROR</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 测试 4：违反检查约束</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> products (name, price, stock) <span class="keyword">VALUES</span> (<span class="string">&#x27;商品&#x27;</span>, <span class="number">-100</span>, <span class="number">10</span>);  <span class="comment">-- ERROR</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 测试 5：违反外键约束</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (order_no, user_id, total_amount)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;ORD001&#x27;</span>, <span class="number">999</span>, <span class="number">100</span>);  <span class="comment">-- ERROR: 用户不存在</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 测试 6：级联删除</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 该用户的所有订单也会被删除</span></span><br></pre></td></tr></table></figure>

<h2 id="十一、小结"><a href="#十一、小结" class="headerlink" title="十一、小结"></a>十一、小结</h2><h3 id="约束类型总结"><a href="#约束类型总结" class="headerlink" title="约束类型总结"></a>约束类型总结</h3><table>
<thead>
<tr>
<th>约束</th>
<th>关键字</th>
<th>作用</th>
<th>可否命名</th>
</tr>
</thead>
<tbody><tr>
<td>主键</td>
<td>PRIMARY KEY</td>
<td>唯一标识记录</td>
<td>是</td>
</tr>
<tr>
<td>外键</td>
<td>FOREIGN KEY</td>
<td>建立表间关系</td>
<td>是</td>
</tr>
<tr>
<td>唯一</td>
<td>UNIQUE</td>
<td>保证列值唯一</td>
<td>是</td>
</tr>
<tr>
<td>非空</td>
<td>NOT NULL</td>
<td>禁止 NULL 值</td>
<td>否</td>
</tr>
<tr>
<td>默认</td>
<td>DEFAULT</td>
<td>设置默认值</td>
<td>否</td>
</tr>
<tr>
<td>检查</td>
<td>CHECK</td>
<td>验证数据有效性</td>
<td>是</td>
</tr>
</tbody></table>
<h3 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h3><ol>
<li><strong>主键选择</strong>：使用无业务意义的自增 ID</li>
<li><strong>外键使用</strong>：明确指定 ON DELETE&#x2F;UPDATE 行为</li>
<li><strong>约束命名</strong>：使用有意义的约束名便于维护</li>
<li><strong>检查约束</strong>：在数据库层面验证业务规则</li>
<li><strong>适度使用</strong>：不要过度约束影响性能</li>
</ol>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ol>
<li>外键只在 InnoDB 引擎中生效</li>
<li>MySQL 8.0.16 之前不支持 CHECK 约束</li>
<li>外键会影响插入、删除、更新性能</li>
<li>级联删除要小心使用，避免误删数据</li>
</ol>
<hr>
<p><strong>下一篇</strong>：[MySQL 进阶教程 03-01 多表查询详解](&#x2F;2026&#x2F;02&#x2F;23&#x2F;MySQL 进阶教程 03-01 多表查询详解&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 进阶教程 01-01 常用函数详解](&#x2F;2026&#x2F;02&#x2F;23&#x2F;MySQL 进阶教程 01-01 常用函数详解&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 进阶教程</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>约束</tag>
        <tag>外键</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 进阶教程 04-01 窗口函数概述</title>
    <url>/2026/02/24/MySQL%20%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B%2004-01%20%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0%E6%A6%82%E8%BF%B0/</url>
    <content><![CDATA[<h1 id="MySQL-进阶教程-04-01-窗口函数概述"><a href="#MySQL-进阶教程-04-01-窗口函数概述" class="headerlink" title="MySQL 进阶教程 04-01 窗口函数概述"></a>MySQL 进阶教程 04-01 窗口函数概述</h1><p>窗口函数（Window Function）是 MySQL 8.0+ 引入的强大特性，用于实现复杂的分析查询。本文将详细介绍窗口函数的基本概念、语法结构以及与聚合函数的区别。</p>
<h2 id="一、窗口函数简介"><a href="#一、窗口函数简介" class="headerlink" title="一、窗口函数简介"></a>一、窗口函数简介</h2><h3 id="1-1-什么是窗口函数？"><a href="#1-1-什么是窗口函数？" class="headerlink" title="1.1 什么是窗口函数？"></a>1.1 什么是窗口函数？</h3><p><strong>窗口函数</strong> 是对一组行（称为”窗口”）执行计算的函数，但与聚合函数不同的是，窗口函数会为每一行返回一个结果，而不是将多行聚合为单个值。</p>
<p><strong>通俗理解</strong>：</p>
<ul>
<li>聚合函数：多行 → 一个结果</li>
<li>窗口函数：多行 → 每行一个结果（基于窗口内数据计算）</li>
</ul>
<h3 id="1-2-窗口函数的应用场景"><a href="#1-2-窗口函数的应用场景" class="headerlink" title="1.2 窗口函数的应用场景"></a>1.2 窗口函数的应用场景</h3><table>
<thead>
<tr>
<th>场景</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>排名问题</td>
<td>获取 Top N 记录</td>
<td>每个部门工资最高的 3 名员工</td>
</tr>
<tr>
<td>累计计算</td>
<td>累计求和、平均值</td>
<td>累计销售额、移动平均</td>
</tr>
<tr>
<td>前后行访问</td>
<td>访问当前行的前后行数据</td>
<td>同比、环比增长</td>
</tr>
<tr>
<td>分组内排序</td>
<td>组内排序编号</td>
<td>每笔订单在客户订单中的序号</td>
</tr>
<tr>
<td>分桶分析</td>
<td>将数据分成若干组</td>
<td>按成绩分等级、百分位分析</td>
</tr>
</tbody></table>
<h3 id="1-3-为什么需要窗口函数？"><a href="#1-3-为什么需要窗口函数？" class="headerlink" title="1.3 为什么需要窗口函数？"></a>1.3 为什么需要窗口函数？</h3><p>在窗口函数出现之前，实现类似功能通常需要：</p>
<ul>
<li>自连接</li>
<li>子查询</li>
<li>用户变量</li>
<li>应用层处理</li>
</ul>
<p>这些方法往往<strong>语法复杂、性能较差、可读性低</strong>。窗口函数提供了<strong>更简洁、高效、易读</strong>的解决方案。</p>
<h2 id="二、窗口函数-vs-聚合函数"><a href="#二、窗口函数-vs-聚合函数" class="headerlink" title="二、窗口函数 vs 聚合函数"></a>二、窗口函数 vs 聚合函数</h2><h3 id="2-1-基本区别"><a href="#2-1-基本区别" class="headerlink" title="2.1 基本区别"></a>2.1 基本区别</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 准备测试数据</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> employees;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> employees (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    dept_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    salary <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    hire_date <span class="type">DATE</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> employees (name, dept_id, salary, hire_date) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;张三&#x27;</span>, <span class="number">1</span>, <span class="number">8000</span>, <span class="string">&#x27;2022-01-01&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;李四&#x27;</span>, <span class="number">1</span>, <span class="number">10000</span>, <span class="string">&#x27;2021-06-15&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;王五&#x27;</span>, <span class="number">1</span>, <span class="number">12000</span>, <span class="string">&#x27;2020-03-20&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;赵六&#x27;</span>, <span class="number">2</span>, <span class="number">7000</span>, <span class="string">&#x27;2022-03-10&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;孙七&#x27;</span>, <span class="number">2</span>, <span class="number">9000</span>, <span class="string">&#x27;2021-09-01&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;周八&#x27;</span>, <span class="number">2</span>, <span class="number">11000</span>, <span class="string">&#x27;2020-12-01&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;吴九&#x27;</span>, <span class="number">3</span>, <span class="number">6000</span>, <span class="string">&#x27;2023-01-15&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>聚合函数示例</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 聚合函数：按部门分组，返回每个部门的平均工资</span></span><br><span class="line"><span class="keyword">SELECT</span> dept_id, <span class="built_in">AVG</span>(salary) <span class="keyword">AS</span> avg_salary</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> dept_id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果：每部门一行</span></span><br><span class="line"><span class="comment">-- dept_id | avg_salary</span></span><br><span class="line"><span class="comment">-- --------+-----------</span></span><br><span class="line"><span class="comment">--    1    | 10000.00</span></span><br><span class="line"><span class="comment">--    2    | 9000.00</span></span><br><span class="line"><span class="comment">--    3    | 6000.00</span></span><br></pre></td></tr></table></figure>

<p><strong>窗口函数示例</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 窗口函数：返回每个员工的工资，以及其所在部门的平均工资</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    name,</span><br><span class="line">    dept_id,</span><br><span class="line">    salary,</span><br><span class="line">    <span class="built_in">AVG</span>(salary) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id) <span class="keyword">AS</span> dept_avg_salary</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果：每行一个结果，保留原始数据</span></span><br><span class="line"><span class="comment">-- name | dept_id | salary | dept_avg_salary</span></span><br><span class="line"><span class="comment">-- -----+---------+--------+-----------------</span></span><br><span class="line"><span class="comment">-- 张三  |    1    | 8000   | 10000.00</span></span><br><span class="line"><span class="comment">-- 李四  |    1    | 10000  | 10000.00</span></span><br><span class="line"><span class="comment">-- 王五  |    1    | 12000  | 10000.00</span></span><br><span class="line"><span class="comment">-- 赵六  |    2    | 7000   | 9000.00</span></span><br><span class="line"><span class="comment">-- 孙七  |    2    | 9000   | 9000.00</span></span><br><span class="line"><span class="comment">-- 周八  |    2    | 11000  | 9000.00</span></span><br><span class="line"><span class="comment">-- 吴九  |    3    | 6000   | 6000.00</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-对比总结"><a href="#2-2-对比总结" class="headerlink" title="2.2 对比总结"></a>2.2 对比总结</h3><table>
<thead>
<tr>
<th>对比项</th>
<th>聚合函数</th>
<th>窗口函数</th>
</tr>
</thead>
<tbody><tr>
<td>输入</td>
<td>多行</td>
<td>多行（窗口）</td>
</tr>
<tr>
<td>输出</td>
<td>单行（分组后）</td>
<td>每行一个结果</td>
</tr>
<tr>
<td>GROUP BY</td>
<td>必须</td>
<td>可选（使用 PARTITION BY）</td>
</tr>
<tr>
<td>原始数据</td>
<td>被聚合</td>
<td>保留</td>
</tr>
<tr>
<td>应用场景</td>
<td>统计汇总</td>
<td>分析计算</td>
</tr>
</tbody></table>
<h2 id="三、窗口函数语法结构"><a href="#三、窗口函数语法结构" class="headerlink" title="三、窗口函数语法结构"></a>三、窗口函数语法结构</h2><h3 id="3-1-基本语法"><a href="#3-1-基本语法" class="headerlink" title="3.1 基本语法"></a>3.1 基本语法</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">窗口函数 <span class="keyword">OVER</span> (</span><br><span class="line">    [<span class="keyword">PARTITION</span> <span class="keyword">BY</span> 列名]</span><br><span class="line">    [<span class="keyword">ORDER</span> <span class="keyword">BY</span> 列名]</span><br><span class="line">    [<span class="keyword">ROWS</span><span class="operator">/</span><span class="keyword">RANGE</span> <span class="keyword">BETWEEN</span> 窗口边界]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="3-2-语法组件详解"><a href="#3-2-语法组件详解" class="headerlink" title="3.2 语法组件详解"></a>3.2 语法组件详解</h3><h4 id="（1）OVER-子句"><a href="#（1）OVER-子句" class="headerlink" title="（1）OVER 子句"></a>（1）OVER 子句</h4><p><strong>OVER 子句</strong> 是窗口函数的标志，没有 OVER 就不是窗口函数。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 错误：没有 OVER，AVG 是聚合函数</span></span><br><span class="line"><span class="keyword">SELECT</span> name, salary, <span class="built_in">AVG</span>(salary) <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 正确：有 OVER，AVG 是窗口函数</span></span><br><span class="line"><span class="keyword">SELECT</span> name, salary, <span class="built_in">AVG</span>(salary) <span class="keyword">OVER</span>() <span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<h4 id="（2）PARTITION-BY-子句"><a href="#（2）PARTITION-BY-子句" class="headerlink" title="（2）PARTITION BY 子句"></a>（2）PARTITION BY 子句</h4><p><strong>PARTITION BY</strong> 将数据划分为多个分区（窗口），函数在每个分区内独立计算。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 不分区：整个数据集作为一个窗口</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    name,</span><br><span class="line">    dept_id,</span><br><span class="line">    salary,</span><br><span class="line">    <span class="built_in">AVG</span>(salary) <span class="keyword">OVER</span>() <span class="keyword">AS</span> company_avg</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br><span class="line"><span class="comment">-- 所有行显示公司平均工资</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 按部门分区：每个部门作为一个窗口</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    name,</span><br><span class="line">    dept_id,</span><br><span class="line">    salary,</span><br><span class="line">    <span class="built_in">AVG</span>(salary) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id) <span class="keyword">AS</span> dept_avg</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br><span class="line"><span class="comment">-- 每行显示该部门的平均工资</span></span><br></pre></td></tr></table></figure>

<p><strong>PARTITION BY vs GROUP BY</strong>：</p>
<ul>
<li><code>GROUP BY</code>：分组后，每组返回一行</li>
<li><code>PARTITION BY</code>：分区后，每行保留，附加计算结果</li>
</ul>
<h4 id="（3）ORDER-BY-子句"><a href="#（3）ORDER-BY-子句" class="headerlink" title="（3）ORDER BY 子句"></a>（3）ORDER BY 子句</h4><p><strong>ORDER BY</strong> 在窗口内对数据进行排序，影响排名和累计类函数。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 部门内按工资排序</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    name,</span><br><span class="line">    dept_id,</span><br><span class="line">    salary,</span><br><span class="line">    <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>) <span class="keyword">AS</span> rank</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<h4 id="（4）窗口边界子句"><a href="#（4）窗口边界子句" class="headerlink" title="（4）窗口边界子句"></a>（4）窗口边界子句</h4><p><strong>ROWS&#x2F;RANGE BETWEEN</strong> 定义窗口的范围（用于累计、移动平均等）。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 累计求和：从第一行到当前行</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    name,</span><br><span class="line">    salary,</span><br><span class="line">    <span class="built_in">SUM</span>(salary) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> hire_date <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> UNBOUNDED PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span>) <span class="keyword">AS</span> running_total</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<p>窗口边界详细说明见后续章节。</p>
<h2 id="四、窗口函数分类"><a href="#四、窗口函数分类" class="headerlink" title="四、窗口函数分类"></a>四、窗口函数分类</h2><p>MySQL 窗口函数主要分为以下几类：</p>
<h3 id="4-1-排名函数"><a href="#4-1-排名函数" class="headerlink" title="4.1 排名函数"></a>4.1 排名函数</h3><table>
<thead>
<tr>
<th>函数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>ROW_NUMBER()</td>
<td>连续排名，无重复，不跳过（1,2,3,4…）</td>
</tr>
<tr>
<td>RANK()</td>
<td>跳跃排名，有重复，跳过（1,2,2,4…）</td>
</tr>
<tr>
<td>DENSE_RANK()</td>
<td>密集排名，有重复，不跳过（1,2,2,3…）</td>
</tr>
<tr>
<td>NTILE(n)</td>
<td>将数据分成 n 个桶</td>
</tr>
</tbody></table>
<h3 id="4-2-聚合函数（窗口版）"><a href="#4-2-聚合函数（窗口版）" class="headerlink" title="4.2 聚合函数（窗口版）"></a>4.2 聚合函数（窗口版）</h3><p>MySQL 的所有聚合函数都可以用作窗口函数：</p>
<table>
<thead>
<tr>
<th>函数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>SUM() OVER</td>
<td>窗口求和</td>
</tr>
<tr>
<td>AVG() OVER</td>
<td>窗口平均</td>
</tr>
<tr>
<td>COUNT() OVER</td>
<td>窗口计数</td>
</tr>
<tr>
<td>MAX() OVER</td>
<td>窗口最大值</td>
</tr>
<tr>
<td>MIN() OVER</td>
<td>窗口最小值</td>
</tr>
</tbody></table>
<h3 id="4-3-分析函数"><a href="#4-3-分析函数" class="headerlink" title="4.3 分析函数"></a>4.3 分析函数</h3><table>
<thead>
<tr>
<th>函数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>LEAD(col, n)</td>
<td>访问当前行之后第 n 行的值</td>
</tr>
<tr>
<td>LAG(col, n)</td>
<td>访问当前行之前第 n 行的值</td>
</tr>
<tr>
<td>FIRST_VALUE(col)</td>
<td>窗口内第一行的值</td>
</tr>
<tr>
<td>LAST_VALUE(col)</td>
<td>窗口内最后一行的值</td>
</tr>
<tr>
<td>NTH_VALUE(col, n)</td>
<td>窗口内第 n 行的值</td>
</tr>
</tbody></table>
<h2 id="五、窗口函数入门示例"><a href="#五、窗口函数入门示例" class="headerlink" title="五、窗口函数入门示例"></a>五、窗口函数入门示例</h2><h3 id="5-1-排名问题"><a href="#5-1-排名问题" class="headerlink" title="5.1 排名问题"></a>5.1 排名问题</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 问题：获取每个部门内工资排名</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    name,</span><br><span class="line">    dept_id,</span><br><span class="line">    salary,</span><br><span class="line">    <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>) <span class="keyword">AS</span> row_num,</span><br><span class="line">    <span class="built_in">RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>) <span class="keyword">AS</span> rank,</span><br><span class="line">    <span class="built_in">DENSE_RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>) <span class="keyword">AS</span> dense_rank</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> dept_id, salary <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果：</span></span><br><span class="line"><span class="comment">-- name | dept_id | salary | row_num | rank | dense_rank</span></span><br><span class="line"><span class="comment">-- -----+---------+--------+---------+------+-----------</span></span><br><span class="line"><span class="comment">-- 王五  |    1    | 12000  |    1    |   1  |     1</span></span><br><span class="line"><span class="comment">-- 李四  |    1    | 10000  |    2    |   2  |     2</span></span><br><span class="line"><span class="comment">-- 张三  |    1    | 8000   |    3    |   3  |     3</span></span><br><span class="line"><span class="comment">-- 周八  |    2    | 11000  |    1    |   1  |     1</span></span><br><span class="line"><span class="comment">-- 孙七  |    2    | 9000   |    2    |   2  |     2</span></span><br><span class="line"><span class="comment">-- 赵六  |    2    | 7000   |    3    |   3  |     3</span></span><br><span class="line"><span class="comment">-- 吴九  |    3    | 6000   |    1    |   1  |     1</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-累计求和"><a href="#5-2-累计求和" class="headerlink" title="5.2 累计求和"></a>5.2 累计求和</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 问题：计算累计工资和</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    name,</span><br><span class="line">    hire_date,</span><br><span class="line">    salary,</span><br><span class="line">    <span class="built_in">SUM</span>(salary) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> hire_date) <span class="keyword">AS</span> running_total</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> hire_date;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果：</span></span><br><span class="line"><span class="comment">-- name | hire_date  | salary | running_total</span></span><br><span class="line"><span class="comment">-- -----+------------+--------+--------------</span></span><br><span class="line"><span class="comment">-- 王五  | 2020-03-20 | 12000  | 12000</span></span><br><span class="line"><span class="comment">-- 周八  | 2020-12-01 | 11000  | 23000</span></span><br><span class="line"><span class="comment">-- 李四  | 2021-06-15 | 10000  | 33000</span></span><br><span class="line"><span class="comment">-- 孙七  | 2021-09-01 | 9000   | 42000</span></span><br><span class="line"><span class="comment">-- 张三  | 2022-01-01 | 8000   | 50000</span></span><br><span class="line"><span class="comment">-- 赵六  | 2022-03-10 | 7000   | 57000</span></span><br><span class="line"><span class="comment">-- 吴九  | 2023-01-15 | 6000   | 63000</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-前后行对比"><a href="#5-3-前后行对比" class="headerlink" title="5.3 前后行对比"></a>5.3 前后行对比</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 问题：计算每个员工与同部门前一位员工的工资差</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    name,</span><br><span class="line">    dept_id,</span><br><span class="line">    salary,</span><br><span class="line">    <span class="built_in">LAG</span>(salary) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary) <span class="keyword">AS</span> prev_salary,</span><br><span class="line">    salary <span class="operator">-</span> <span class="built_in">LAG</span>(salary) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary) <span class="keyword">AS</span> diff</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> dept_id, salary;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果：</span></span><br><span class="line"><span class="comment">-- name | dept_id | salary | prev_salary | diff</span></span><br><span class="line"><span class="comment">-- -----+---------+--------+-------------+------</span></span><br><span class="line"><span class="comment">-- 张三  |    1    | 8000   | NULL        | NULL</span></span><br><span class="line"><span class="comment">-- 李四  |    1    | 10000  | 8000        | 2000</span></span><br><span class="line"><span class="comment">-- 王五  |    1    | 12000  | 10000       | 2000</span></span><br><span class="line"><span class="comment">-- 赵六  |    2    | 7000   | NULL        | NULL</span></span><br><span class="line"><span class="comment">-- 孙七  |    2    | 9000   | 7000        | 2000</span></span><br><span class="line"><span class="comment">-- 周八  |    2    | 11000  | 9000        | 2000</span></span><br><span class="line"><span class="comment">-- 吴九  |    3    | 6000   | NULL        | NULL</span></span><br></pre></td></tr></table></figure>

<h3 id="5-4-Top-N-问题"><a href="#5-4-Top-N-问题" class="headerlink" title="5.4 Top N 问题"></a>5.4 Top N 问题</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 问题：获取每个部门工资最高的 2 名员工</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        name,</span><br><span class="line">        dept_id,</span><br><span class="line">        salary,</span><br><span class="line">        <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>) <span class="keyword">AS</span> rn</span><br><span class="line">    <span class="keyword">FROM</span> employees</span><br><span class="line">) t</span><br><span class="line"><span class="keyword">WHERE</span> rn <span class="operator">&lt;=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果：</span></span><br><span class="line"><span class="comment">-- name | dept_id | salary | rn</span></span><br><span class="line"><span class="comment">-- -----+---------+--------+----</span></span><br><span class="line"><span class="comment">-- 王五  |    1    | 12000  | 1</span></span><br><span class="line"><span class="comment">-- 李四  |    1    | 10000  | 2</span></span><br><span class="line"><span class="comment">-- 周八  |    2    | 11000  | 1</span></span><br><span class="line"><span class="comment">-- 孙七  |    2    | 9000   | 2</span></span><br><span class="line"><span class="comment">-- 吴九  |    3    | 6000   | 1</span></span><br></pre></td></tr></table></figure>

<h2 id="六、窗口函数的执行顺序"><a href="#六、窗口函数的执行顺序" class="headerlink" title="六、窗口函数的执行顺序"></a>六、窗口函数的执行顺序</h2><p>理解窗口函数的执行顺序对于编写正确的 SQL 至关重要。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT 执行顺序：</span><br><span class="line">1. FROM / JOIN</span><br><span class="line">2. WHERE</span><br><span class="line">3. GROUP BY</span><br><span class="line">4. HAVING</span><br><span class="line">5. 窗口函数（OVER）</span><br><span class="line">6. SELECT</span><br><span class="line">7. DISTINCT</span><br><span class="line">8. ORDER BY（最终排序）</span><br><span class="line">9. LIMIT</span><br></pre></td></tr></table></figure>

<p><strong>关键点</strong>：</p>
<ul>
<li>窗口函数在 WHERE、GROUP BY、HAVING <strong>之后</strong>执行</li>
<li>窗口函数在最终 ORDER BY <strong>之前</strong>执行</li>
<li>可以在外层查询中对窗口函数的结果进行过滤</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 错误：不能在 WHERE 中直接使用窗口函数</span></span><br><span class="line"><span class="keyword">SELECT</span> name, salary, <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> salary) <span class="keyword">AS</span> rn</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> rn <span class="operator">&lt;=</span> <span class="number">3</span>;  <span class="comment">-- ERROR: rn 在 WHERE 之后计算</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 正确：使用子查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> name, salary, <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> salary) <span class="keyword">AS</span> rn</span><br><span class="line">    <span class="keyword">FROM</span> employees</span><br><span class="line">) t</span><br><span class="line"><span class="keyword">WHERE</span> rn <span class="operator">&lt;=</span> <span class="number">3</span>;</span><br></pre></td></tr></table></figure>

<h2 id="七、窗口函数的版本要求"><a href="#七、窗口函数的版本要求" class="headerlink" title="七、窗口函数的版本要求"></a>七、窗口函数的版本要求</h2><h3 id="7-1-MySQL-版本支持"><a href="#7-1-MySQL-版本支持" class="headerlink" title="7.1 MySQL 版本支持"></a>7.1 MySQL 版本支持</h3><table>
<thead>
<tr>
<th>MySQL 版本</th>
<th>窗口函数支持</th>
</tr>
</thead>
<tbody><tr>
<td>5.7 及以下</td>
<td>❌ 不支持</td>
</tr>
<tr>
<td>8.0+</td>
<td>✅ 完全支持</td>
</tr>
</tbody></table>
<h3 id="7-2-查看-MySQL-版本"><a href="#7-2-查看-MySQL-版本" class="headerlink" title="7.2 查看 MySQL 版本"></a>7.2 查看 MySQL 版本</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> VERSION();</span><br></pre></td></tr></table></figure>

<h3 id="7-3-旧版本替代方案"><a href="#7-3-旧版本替代方案" class="headerlink" title="7.3 旧版本替代方案"></a>7.3 旧版本替代方案</h3><p>如果使用 MySQL 5.7，可以使用<strong>用户变量</strong>模拟窗口函数：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- MySQL 5.7：使用变量实现 ROW_NUMBER</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    name,</span><br><span class="line">    dept_id,</span><br><span class="line">    salary,</span><br><span class="line">    <span class="variable">@rn</span> :<span class="operator">=</span> IF(<span class="variable">@prev_dept</span> <span class="operator">=</span> dept_id, <span class="variable">@rn</span> <span class="operator">+</span> <span class="number">1</span>, <span class="number">1</span>) <span class="keyword">AS</span> rn,</span><br><span class="line">    <span class="variable">@prev_dept</span> :<span class="operator">=</span> dept_id</span><br><span class="line"><span class="keyword">FROM</span> employees, (<span class="keyword">SELECT</span> <span class="variable">@rn</span> :<span class="operator">=</span> <span class="number">0</span>, <span class="variable">@prev_dept</span> :<span class="operator">=</span> <span class="keyword">NULL</span>) vars</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> dept_id, salary <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<p>但这种方法<strong>语法复杂、易出错、性能较差</strong>，建议升级到 MySQL 8.0+。</p>
<h2 id="八、小结"><a href="#八、小结" class="headerlink" title="八、小结"></a>八、小结</h2><h3 id="核心知识点"><a href="#核心知识点" class="headerlink" title="核心知识点"></a>核心知识点</h3><ol>
<li><p><strong>窗口函数特点</strong></p>
<ul>
<li>为每一行返回一个结果</li>
<li>不改变原始数据</li>
<li>基于窗口（一组行）进行计算</li>
</ul>
</li>
<li><p><strong>与聚合函数的区别</strong></p>
<ul>
<li>聚合函数：多行 → 一个结果</li>
<li>窗口函数：多行 → 每行一个结果</li>
</ul>
</li>
<li><p><strong>OVER 子句组件</strong></p>
<ul>
<li><code>PARTITION BY</code>：划分分区</li>
<li><code>ORDER BY</code>：窗口内排序</li>
<li><code>ROWS/RANGE BETWEEN</code>：窗口边界</li>
</ul>
</li>
<li><p><strong>窗口函数分类</strong></p>
<ul>
<li>排名函数：ROW_NUMBER、RANK、DENSE_RANK、NTILE</li>
<li>聚合函数：SUM、AVG、COUNT、MAX、MIN</li>
<li>分析函数：LEAD、LAG、FIRST_VALUE、LAST_VALUE</li>
</ul>
</li>
</ol>
<h3 id="下一章预告"><a href="#下一章预告" class="headerlink" title="下一章预告"></a>下一章预告</h3><p>下一篇文章将详细介绍<strong>排名函数</strong>（ROW_NUMBER、RANK、DENSE_RANK）的使用方法，包括：</p>
<ul>
<li>三种排名函数的区别</li>
<li>实战：Top N 问题</li>
<li>实战：分组内排名</li>
<li>性能优化建议</li>
</ul>
<hr>
<p><strong>下一篇</strong>：[MySQL 进阶教程 04-02 ROW_NUMBER 和排名函数](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 04-02 ROW_NUMBER 和排名函数&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 进阶教程 03-10 表子查询](&#x2F;2026&#x2F;02&#x2F;23&#x2F;MySQL 进阶教程 03-10 表子查询&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 进阶教程</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>窗口函数</tag>
        <tag>OVER</tag>
        <tag>分析函数</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 进阶教程 03-01 多表查询详解</title>
    <url>/2026/02/23/MySQL%20%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B%2003-01%20%E5%A4%9A%E8%A1%A8%E6%9F%A5%E8%AF%A2%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<h1 id="MySQL-进阶教程-03-01-多表查询详解"><a href="#MySQL-进阶教程-03-01-多表查询详解" class="headerlink" title="MySQL 进阶教程 03-01 多表查询详解"></a>MySQL 进阶教程 03-01 多表查询详解</h1><p>在实际应用中，数据通常分布在多个表中。多表查询是 SQL 中最重要、最实用的技能之一。本文将详细讲解多表关系、连接查询、联合查询和子查询。</p>
<h2 id="一、多表关系介绍"><a href="#一、多表关系介绍" class="headerlink" title="一、多表关系介绍"></a>一、多表关系介绍</h2><h3 id="1-1-表与表之间的关系"><a href="#1-1-表与表之间的关系" class="headerlink" title="1.1 表与表之间的关系"></a>1.1 表与表之间的关系</h3><p>数据库中的表不是孤立的，它们之间通过各种关系相互关联。主要有三种关系：</p>
<table>
<thead>
<tr>
<th>关系类型</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>一对一（1:1）</td>
<td>一个表的一条记录对应另一个表的一条记录</td>
<td>用户和用户详情</td>
</tr>
<tr>
<td>一对多（1:N）</td>
<td>一个表的一条记录对应另一个表的多条记录</td>
<td>部门和员工</td>
</tr>
<tr>
<td>多对多（N:M）</td>
<td>一个表的多条记录对应另一个表的多条记录</td>
<td>学生和课程</td>
</tr>
</tbody></table>
<h3 id="1-2-一对一关系（1-1）"><a href="#1-2-一对一关系（1-1）" class="headerlink" title="1.2 一对一关系（1:1）"></a>1.2 一对一关系（1:1）</h3><p><strong>特点</strong>：</p>
<ul>
<li>表 A 的一条记录对应表 B 的一条记录</li>
<li>通常用于拆分大表，提高性能</li>
<li>外键可以放在任意一方</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 用户表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    username <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    password <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT NULL</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 用户详情表（一对一）</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> user_profiles (</span><br><span class="line">    user_id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,  <span class="comment">-- 也是主键，保证一对一</span></span><br><span class="line">    real_name <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    phone <span class="type">VARCHAR</span>(<span class="number">20</span>),</span><br><span class="line">    address <span class="type">VARCHAR</span>(<span class="number">200</span>),</span><br><span class="line">    <span class="keyword">FOREIGN KEY</span> (user_id) <span class="keyword">REFERENCES</span> users(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询用户及其详情</span></span><br><span class="line"><span class="keyword">SELECT</span> u.username, p.real_name, p.phone, p.address</span><br><span class="line"><span class="keyword">FROM</span> users u</span><br><span class="line"><span class="keyword">JOIN</span> user_profiles p <span class="keyword">ON</span> u.id <span class="operator">=</span> p.user_id;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-一对多关系（1-N）"><a href="#1-3-一对多关系（1-N）" class="headerlink" title="1.3 一对多关系（1:N）"></a>1.3 一对多关系（1:N）</h3><p><strong>特点</strong>：</p>
<ul>
<li>表 A 的一条记录对应表 B 的多条记录</li>
<li>外键放在”多”的一方</li>
<li>最常见表关系</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 部门表（一方）</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> departments (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    dept_name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 员工表（多方）</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> employees (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    dept_id <span class="type">INT</span>,  <span class="comment">-- 外键指向部门表</span></span><br><span class="line">    <span class="keyword">FOREIGN KEY</span> (dept_id) <span class="keyword">REFERENCES</span> departments(id)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 一个部门有多个员工</span></span><br><span class="line"><span class="comment">-- 一个员工只属于一个部门</span></span><br></pre></td></tr></table></figure>

<h3 id="1-4-多对多关系（N-M）"><a href="#1-4-多对多关系（N-M）" class="headerlink" title="1.4 多对多关系（N:M）"></a>1.4 多对多关系（N:M）</h3><p><strong>特点</strong>：</p>
<ul>
<li>表 A 的多条记录对应表 B 的多条记录</li>
<li>需要第三张关联表（中间表）</li>
<li>关联表包含两个外键</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 学生表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> students (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 课程表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> courses (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    course_name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 选课表（中间表）</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> enrollments (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    student_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    course_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    enroll_date <span class="type">DATE</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_DATE</span>,</span><br><span class="line">    <span class="keyword">FOREIGN KEY</span> (student_id) <span class="keyword">REFERENCES</span> students(id),</span><br><span class="line">    <span class="keyword">FOREIGN KEY</span> (course_id) <span class="keyword">REFERENCES</span> courses(id),</span><br><span class="line">    <span class="keyword">UNIQUE</span> KEY uk_student_course (student_id, course_id)  <span class="comment">-- 防止重复选课</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 一个学生可以选多门课</span></span><br><span class="line"><span class="comment">-- 一门课可以被多个学生选</span></span><br></pre></td></tr></table></figure>

<h2 id="二、多表查询概述"><a href="#二、多表查询概述" class="headerlink" title="二、多表查询概述"></a>二、多表查询概述</h2><h3 id="2-1-多表查询的方式"><a href="#2-1-多表查询的方式" class="headerlink" title="2.1 多表查询的方式"></a>2.1 多表查询的方式</h3><table>
<thead>
<tr>
<th>查询方式</th>
<th>说明</th>
<th>关键字</th>
</tr>
</thead>
<tbody><tr>
<td>连接查询</td>
<td>通过连接条件将多个表关联</td>
<td>JOIN</td>
</tr>
<tr>
<td>联合查询</td>
<td>将多个查询结果合并</td>
<td>UNION</td>
</tr>
<tr>
<td>子查询</td>
<td>在一个查询中嵌套另一个查询</td>
<td>子 SELECT</td>
</tr>
</tbody></table>
<h3 id="2-2-笛卡尔积"><a href="#2-2-笛卡尔积" class="headerlink" title="2.2 笛卡尔积"></a>2.2 笛卡尔积</h3><p>当两个表进行连接时，如果没有连接条件，会得到笛卡尔积。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 表 A 有 3 条记录，表 B 有 4 条记录</span></span><br><span class="line"><span class="comment">-- 笛卡尔积结果：3 × 4 = 12 条记录</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 笛卡尔积（不推荐，数据量大会爆炸）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> table_a, table_b;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 正确做法：添加连接条件</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> table_a, table_b <span class="keyword">WHERE</span> table_a.id <span class="operator">=</span> table_b.a_id;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-准备测试数据"><a href="#2-3-准备测试数据" class="headerlink" title="2.3 准备测试数据"></a>2.3 准备测试数据</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 部门表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> departments;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> departments (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    dept_name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    dept_location <span class="type">VARCHAR</span>(<span class="number">100</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 员工表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> employees;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> employees (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    emp_no <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    gender ENUM(<span class="string">&#x27;男&#x27;</span>, <span class="string">&#x27;女&#x27;</span>),</span><br><span class="line">    dept_id <span class="type">INT</span>,</span><br><span class="line">    salary <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),</span><br><span class="line">    manager_id <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">FOREIGN KEY</span> (dept_id) <span class="keyword">REFERENCES</span> departments(id),</span><br><span class="line">    <span class="keyword">FOREIGN KEY</span> (manager_id) <span class="keyword">REFERENCES</span> employees(id)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入部门</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> departments (dept_name, dept_location) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;技术部&#x27;</span>, <span class="string">&#x27;北京&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;市场部&#x27;</span>, <span class="string">&#x27;上海&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;财务部&#x27;</span>, <span class="string">&#x27;北京&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;人事部&#x27;</span>, <span class="string">&#x27;广州&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入员工</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> employees (emp_no, name, gender, dept_id, salary, manager_id) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;E001&#x27;</span>, <span class="string">&#x27;张三&#x27;</span>, <span class="string">&#x27;男&#x27;</span>, <span class="number">1</span>, <span class="number">10000</span>, <span class="keyword">NULL</span>),      <span class="comment">-- 技术部经理</span></span><br><span class="line">(<span class="string">&#x27;E002&#x27;</span>, <span class="string">&#x27;李四&#x27;</span>, <span class="string">&#x27;女&#x27;</span>, <span class="number">1</span>, <span class="number">8000</span>, <span class="number">1</span>),          <span class="comment">-- 技术部员工</span></span><br><span class="line">(<span class="string">&#x27;E003&#x27;</span>, <span class="string">&#x27;王五&#x27;</span>, <span class="string">&#x27;男&#x27;</span>, <span class="number">1</span>, <span class="number">9000</span>, <span class="number">1</span>),          <span class="comment">-- 技术部员工</span></span><br><span class="line">(<span class="string">&#x27;E004&#x27;</span>, <span class="string">&#x27;赵六&#x27;</span>, <span class="string">&#x27;女&#x27;</span>, <span class="number">2</span>, <span class="number">8500</span>, <span class="keyword">NULL</span>),       <span class="comment">-- 市场部经理</span></span><br><span class="line">(<span class="string">&#x27;E005&#x27;</span>, <span class="string">&#x27;孙七&#x27;</span>, <span class="string">&#x27;男&#x27;</span>, <span class="number">2</span>, <span class="number">7500</span>, <span class="number">4</span>),          <span class="comment">-- 市场部员工</span></span><br><span class="line">(<span class="string">&#x27;E006&#x27;</span>, <span class="string">&#x27;周八&#x27;</span>, <span class="string">&#x27;女&#x27;</span>, <span class="number">3</span>, <span class="number">9000</span>, <span class="keyword">NULL</span>),       <span class="comment">-- 财务部经理</span></span><br><span class="line">(<span class="string">&#x27;E007&#x27;</span>, <span class="string">&#x27;吴九&#x27;</span>, <span class="string">&#x27;男&#x27;</span>, <span class="keyword">NULL</span>, <span class="number">6000</span>, <span class="keyword">NULL</span>);    <span class="comment">-- 暂无部门</span></span><br></pre></td></tr></table></figure>

<h2 id="三、内连接（INNER-JOIN）"><a href="#三、内连接（INNER-JOIN）" class="headerlink" title="三、内连接（INNER JOIN）"></a>三、内连接（INNER JOIN）</h2><h3 id="3-1-内连接概述"><a href="#3-1-内连接概述" class="headerlink" title="3.1 内连接概述"></a>3.1 内连接概述</h3><p><strong>内连接</strong> 返回两个表中满足连接条件的记录。</p>
<p><strong>特点</strong>：</p>
<ul>
<li>只返回匹配的记录</li>
<li>不匹配的记录不会出现在结果中</li>
<li>最常用的连接方式</li>
</ul>
<h3 id="3-2-内连接语法"><a href="#3-2-内连接语法" class="headerlink" title="3.2 内连接语法"></a>3.2 内连接语法</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 标准语法（推荐）</span></span><br><span class="line"><span class="keyword">SELECT</span> 列名</span><br><span class="line"><span class="keyword">FROM</span> 表 <span class="number">1</span></span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> 表 <span class="number">2</span> <span class="keyword">ON</span> 连接条件</span><br><span class="line">[<span class="keyword">WHERE</span> 条件]</span><br><span class="line">[<span class="keyword">GROUP</span> <span class="keyword">BY</span> 分组列]</span><br><span class="line">[<span class="keyword">ORDER</span> <span class="keyword">BY</span> 排序列]</span><br><span class="line">[LIMIT 数量];</span><br><span class="line"></span><br><span class="line"><span class="comment">-- INNER 可以省略</span></span><br><span class="line"><span class="keyword">SELECT</span> 列名</span><br><span class="line"><span class="keyword">FROM</span> 表 <span class="number">1</span></span><br><span class="line"><span class="keyword">JOIN</span> 表 <span class="number">2</span> <span class="keyword">ON</span> 连接条件;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 多表连接</span></span><br><span class="line"><span class="keyword">SELECT</span> 列名</span><br><span class="line"><span class="keyword">FROM</span> 表 <span class="number">1</span></span><br><span class="line"><span class="keyword">JOIN</span> 表 <span class="number">2</span> <span class="keyword">ON</span> 表 <span class="number">1.</span>id <span class="operator">=</span> 表 <span class="number">2.</span>表 <span class="number">1</span>_id</span><br><span class="line"><span class="keyword">JOIN</span> 表 <span class="number">3</span> <span class="keyword">ON</span> 表 <span class="number">2.</span>id <span class="operator">=</span> 表 <span class="number">3.</span>表 <span class="number">2</span>_id;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-内连接示例"><a href="#3-3-内连接示例" class="headerlink" title="3.3 内连接示例"></a>3.3 内连接示例</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询员工及其所属部门</span></span><br><span class="line"><span class="keyword">SELECT</span> e.name, e.salary, d.dept_name</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> departments d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询技术部员工</span></span><br><span class="line"><span class="keyword">SELECT</span> e.name, e.salary, d.dept_name</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">JOIN</span> departments d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.id</span><br><span class="line"><span class="keyword">WHERE</span> d.dept_name <span class="operator">=</span> <span class="string">&#x27;技术部&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询工资高于 8000 的员工及部门</span></span><br><span class="line"><span class="keyword">SELECT</span> e.name, e.salary, d.dept_name, d.dept_location</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">JOIN</span> departments d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.id</span><br><span class="line"><span class="keyword">WHERE</span> e.salary <span class="operator">&gt;</span> <span class="number">8000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 多条件连接</span></span><br><span class="line"><span class="keyword">SELECT</span> e.name, d.dept_name</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">JOIN</span> departments d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.id</span><br><span class="line"><span class="keyword">WHERE</span> e.gender <span class="operator">=</span> <span class="string">&#x27;男&#x27;</span> <span class="keyword">AND</span> d.dept_location <span class="operator">=</span> <span class="string">&#x27;北京&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-4-隐式内连接"><a href="#3-4-隐式内连接" class="headerlink" title="3.4 隐式内连接"></a>3.4 隐式内连接</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 隐式内连接（旧语法，不推荐）</span></span><br><span class="line"><span class="keyword">SELECT</span> e.name, d.dept_name</span><br><span class="line"><span class="keyword">FROM</span> employees e, departments d</span><br><span class="line"><span class="keyword">WHERE</span> e.dept_id <span class="operator">=</span> d.id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 等价于显式内连接</span></span><br><span class="line"><span class="keyword">SELECT</span> e.name, d.dept_name</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">JOIN</span> departments d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 注意：隐式连接容易遗漏 WHERE 条件导致笛卡尔积</span></span><br></pre></td></tr></table></figure>

<h3 id="3-5-多表内连接"><a href="#3-5-多表内连接" class="headerlink" title="3.5 多表内连接"></a>3.5 多表内连接</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询员工、部门及其上级领导</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    e.name <span class="keyword">AS</span> 员工，</span><br><span class="line">    d.dept_name <span class="keyword">AS</span> 部门，</span><br><span class="line">    m.name <span class="keyword">AS</span> 上级领导</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">JOIN</span> departments d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.id</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> employees m <span class="keyword">ON</span> e.manager_id <span class="operator">=</span> m.id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 三表连接示例：学生 - 选课 - 课程</span></span><br><span class="line"><span class="keyword">SELECT</span> s.name <span class="keyword">AS</span> 学生，c.course_name <span class="keyword">AS</span> 课程，e.score <span class="keyword">AS</span> 成绩</span><br><span class="line"><span class="keyword">FROM</span> students s</span><br><span class="line"><span class="keyword">JOIN</span> enrollments e <span class="keyword">ON</span> s.id <span class="operator">=</span> e.student_id</span><br><span class="line"><span class="keyword">JOIN</span> courses c <span class="keyword">ON</span> e.course_id <span class="operator">=</span> c.id;</span><br></pre></td></tr></table></figure>

<h2 id="四、外连接（OUTER-JOIN）"><a href="#四、外连接（OUTER-JOIN）" class="headerlink" title="四、外连接（OUTER JOIN）"></a>四、外连接（OUTER JOIN）</h2><h3 id="4-1-外连接概述"><a href="#4-1-外连接概述" class="headerlink" title="4.1 外连接概述"></a>4.1 外连接概述</h3><p><strong>外连接</strong> 返回一个表的所有记录，另一个表只返回匹配的记录。</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
<th>返回</th>
</tr>
</thead>
<tbody><tr>
<td>左连接（LEFT JOIN）</td>
<td>返回左表所有记录</td>
<td>左表全部 + 右表匹配</td>
</tr>
<tr>
<td>右连接（RIGHT JOIN）</td>
<td>返回右表所有记录</td>
<td>右表全部 + 左表匹配</td>
</tr>
<tr>
<td>全外连接（FULL JOIN）</td>
<td>返回两个表所有记录</td>
<td>MySQL 不支持</td>
</tr>
</tbody></table>
<h3 id="4-2-左连接（LEFT-JOIN）"><a href="#4-2-左连接（LEFT-JOIN）" class="headerlink" title="4.2 左连接（LEFT JOIN）"></a>4.2 左连接（LEFT JOIN）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询所有员工及其部门（包括没有部门的员工）</span></span><br><span class="line"><span class="keyword">SELECT</span> e.name, e.dept_id, d.dept_name</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> departments d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果：吴九（dept_id=NULL）也会显示，dept_name 为 NULL</span></span><br></pre></td></tr></table></figure>

<p><strong>左连接特点</strong>：</p>
<ul>
<li>左表的所有记录都会返回</li>
<li>右表没有匹配的记录填充 NULL</li>
</ul>
<h3 id="4-3-右连接（RIGHT-JOIN）"><a href="#4-3-右连接（RIGHT-JOIN）" class="headerlink" title="4.3 右连接（RIGHT JOIN）"></a>4.3 右连接（RIGHT JOIN）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询所有部门及其员工（包括没有员工的部门）</span></span><br><span class="line"><span class="keyword">SELECT</span> d.dept_name, e.name</span><br><span class="line"><span class="keyword">FROM</span> departments d</span><br><span class="line"><span class="keyword">RIGHT</span> <span class="keyword">JOIN</span> employees e <span class="keyword">ON</span> d.id <span class="operator">=</span> e.dept_id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 等价于（推荐）</span></span><br><span class="line"><span class="keyword">SELECT</span> d.dept_name, e.name</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> departments d <span class="keyword">ON</span> d.id <span class="operator">=</span> e.dept_id;</span><br></pre></td></tr></table></figure>

<p><strong>右连接特点</strong>：</p>
<ul>
<li>右表的所有记录都会返回</li>
<li>左表没有匹配的记录填充 NULL</li>
<li>可以用左连接替代</li>
</ul>
<h3 id="4-4-左连接-vs-内连接"><a href="#4-4-左连接-vs-内连接" class="headerlink" title="4.4 左连接 vs 内连接"></a>4.4 左连接 vs 内连接</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 内连接：只返回有部门的员工</span></span><br><span class="line"><span class="keyword">SELECT</span> e.name, d.dept_name</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">JOIN</span> departments d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.id;</span><br><span class="line"><span class="comment">-- 吴九不会出现在结果中</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 左连接：返回所有员工</span></span><br><span class="line"><span class="keyword">SELECT</span> e.name, d.dept_name</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> departments d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.id;</span><br><span class="line"><span class="comment">-- 吴九会显示，dept_name 为 NULL</span></span><br></pre></td></tr></table></figure>

<h3 id="4-5-外连接查询不匹配记录"><a href="#4-5-外连接查询不匹配记录" class="headerlink" title="4.5 外连接查询不匹配记录"></a>4.5 外连接查询不匹配记录</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询没有员工的部门</span></span><br><span class="line"><span class="keyword">SELECT</span> d.dept_name</span><br><span class="line"><span class="keyword">FROM</span> departments d</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> employees e <span class="keyword">ON</span> d.id <span class="operator">=</span> e.dept_id</span><br><span class="line"><span class="keyword">WHERE</span> e.id <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询没有部门的员工</span></span><br><span class="line"><span class="keyword">SELECT</span> e.name</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> departments d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.id</span><br><span class="line"><span class="keyword">WHERE</span> d.id <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询没有选课的学生</span></span><br><span class="line"><span class="keyword">SELECT</span> s.name</span><br><span class="line"><span class="keyword">FROM</span> students s</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> enrollments e <span class="keyword">ON</span> s.id <span class="operator">=</span> e.student_id</span><br><span class="line"><span class="keyword">WHERE</span> e.course_id <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure>

<h3 id="4-6-外连接条件位置"><a href="#4-6-外连接条件位置" class="headerlink" title="4.6 外连接条件位置"></a>4.6 外连接条件位置</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 连接条件在 ON 子句</span></span><br><span class="line"><span class="keyword">SELECT</span> e.name, d.dept_name</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> departments d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 过滤条件在 WHERE 子句</span></span><br><span class="line"><span class="keyword">SELECT</span> e.name, d.dept_name</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> departments d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.id</span><br><span class="line"><span class="keyword">WHERE</span> d.dept_location <span class="operator">=</span> <span class="string">&#x27;北京&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 注意：ON 和 WHERE 的区别</span></span><br><span class="line"><span class="comment">-- ON 在连接时过滤，WHERE 在连接后过滤</span></span><br></pre></td></tr></table></figure>

<h2 id="五、自连接（SELF-JOIN）"><a href="#五、自连接（SELF-JOIN）" class="headerlink" title="五、自连接（SELF JOIN）"></a>五、自连接（SELF JOIN）</h2><h3 id="5-1-自连接概述"><a href="#5-1-自连接概述" class="headerlink" title="5.1 自连接概述"></a>5.1 自连接概述</h3><p><strong>自连接</strong> 是表自己与自己连接，用于查询具有层级关系的数据。</p>
<p><strong>特点</strong>：</p>
<ul>
<li>同一张表使用不同的别名</li>
<li>常用于组织架构、分类层级等</li>
</ul>
<h3 id="5-2-自连接示例"><a href="#5-2-自连接示例" class="headerlink" title="5.2 自连接示例"></a>5.2 自连接示例</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询员工及其上级领导</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    e.name <span class="keyword">AS</span> 员工，</span><br><span class="line">    e.emp_no <span class="keyword">AS</span> 员工编号，</span><br><span class="line">    m.name <span class="keyword">AS</span> 上级领导，</span><br><span class="line">    m.emp_no <span class="keyword">AS</span> 领导编号</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> employees m <span class="keyword">ON</span> e.manager_id <span class="operator">=</span> m.id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询所有领导（带下属的员工）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> m.id, m.name</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">JOIN</span> employees m <span class="keyword">ON</span> e.manager_id <span class="operator">=</span> m.id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询没有下属的员工（普通员工）</span></span><br><span class="line"><span class="keyword">SELECT</span> e.name</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> employees sub <span class="keyword">ON</span> sub.manager_id <span class="operator">=</span> e.id</span><br><span class="line"><span class="keyword">WHERE</span> sub.id <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-层级查询"><a href="#5-3-层级查询" class="headerlink" title="5.3 层级查询"></a>5.3 层级查询</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询员工的完整汇报链（需要递归，MySQL 8.0+ 使用 CTE）</span></span><br><span class="line"><span class="keyword">WITH</span> <span class="keyword">RECURSIVE</span> emp_hierarchy <span class="keyword">AS</span> (</span><br><span class="line">    <span class="comment">-- 基础查询：顶级领导（没有上级）</span></span><br><span class="line">    <span class="keyword">SELECT</span> id, name, manager_id, <span class="number">0</span> <span class="keyword">AS</span> level</span><br><span class="line">    <span class="keyword">FROM</span> employees</span><br><span class="line">    <span class="keyword">WHERE</span> manager_id <span class="keyword">IS</span> <span class="keyword">NULL</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 递归查询：下属</span></span><br><span class="line">    <span class="keyword">SELECT</span> e.id, e.name, e.manager_id, eh.level <span class="operator">+</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">FROM</span> employees e</span><br><span class="line">    <span class="keyword">JOIN</span> emp_hierarchy eh <span class="keyword">ON</span> e.manager_id <span class="operator">=</span> eh.id</span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> emp_hierarchy;</span><br></pre></td></tr></table></figure>

<h3 id="5-4-自连接其他应用"><a href="#5-4-自连接其他应用" class="headerlink" title="5.4 自连接其他应用"></a>5.4 自连接其他应用</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询同一部门的员工对</span></span><br><span class="line"><span class="keyword">SELECT</span> e1.name <span class="keyword">AS</span> 员工 <span class="number">1</span>, e2.name <span class="keyword">AS</span> 员工 <span class="number">2</span>, e1.dept_id</span><br><span class="line"><span class="keyword">FROM</span> employees e1</span><br><span class="line"><span class="keyword">JOIN</span> employees e2 <span class="keyword">ON</span> e1.dept_id <span class="operator">=</span> e2.dept_id <span class="keyword">AND</span> e1.id <span class="operator">&lt;</span> e2.id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询工资比同事高的员工</span></span><br><span class="line"><span class="keyword">SELECT</span> e1.name, e1.salary, e2.name <span class="keyword">AS</span> 同事，e2.salary <span class="keyword">AS</span> 同事工资</span><br><span class="line"><span class="keyword">FROM</span> employees e1</span><br><span class="line"><span class="keyword">JOIN</span> employees e2 <span class="keyword">ON</span> e1.dept_id <span class="operator">=</span> e2.dept_id</span><br><span class="line"><span class="keyword">WHERE</span> e1.salary <span class="operator">&gt;</span> e2.salary <span class="keyword">AND</span> e1.id <span class="operator">!=</span> e2.id;</span><br></pre></td></tr></table></figure>

<h2 id="六、联合查询（UNION）"><a href="#六、联合查询（UNION）" class="headerlink" title="六、联合查询（UNION）"></a>六、联合查询（UNION）</h2><h3 id="6-1-UNION-概述"><a href="#6-1-UNION-概述" class="headerlink" title="6.1 UNION 概述"></a>6.1 UNION 概述</h3><p><strong>UNION</strong> 用于将多个 SELECT 查询的结果合并为一个结果集。</p>
<p><strong>特点</strong>：</p>
<ul>
<li>自动去重（UNION ALL 不去重）</li>
<li>所有查询的列数必须相同</li>
<li>对应列的数据类型必须兼容</li>
</ul>
<h3 id="6-2-UNION-语法"><a href="#6-2-UNION-语法" class="headerlink" title="6.2 UNION 语法"></a>6.2 UNION 语法</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> 列 <span class="number">1</span>, 列 <span class="number">2</span> <span class="keyword">FROM</span> 表 <span class="number">1</span></span><br><span class="line"><span class="keyword">UNION</span> [<span class="keyword">ALL</span>]</span><br><span class="line"><span class="keyword">SELECT</span> 列 <span class="number">1</span>, 列 <span class="number">2</span> <span class="keyword">FROM</span> 表 <span class="number">2</span></span><br><span class="line">[<span class="keyword">UNION</span> [<span class="keyword">ALL</span>]</span><br><span class="line"><span class="keyword">SELECT</span> 列 <span class="number">1</span>, 列 <span class="number">2</span> <span class="keyword">FROM</span> 表 <span class="number">3</span>];</span><br></pre></td></tr></table></figure>

<h3 id="6-3-UNION-示例"><a href="#6-3-UNION-示例" class="headerlink" title="6.3 UNION 示例"></a>6.3 UNION 示例</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- UNION：合并两个查询结果并去重</span></span><br><span class="line"><span class="keyword">SELECT</span> name, dept_id <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> <span class="number">9000</span></span><br><span class="line"><span class="keyword">UNION</span></span><br><span class="line"><span class="keyword">SELECT</span> name, dept_id <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- UNION ALL：合并但保留重复（性能更好）</span></span><br><span class="line"><span class="keyword">SELECT</span> name <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> gender <span class="operator">=</span> <span class="string">&#x27;男&#x27;</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> name <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 多个查询合并</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;高工资&#x27;</span> <span class="keyword">AS</span> 类型，name <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> <span class="number">9000</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;北京部门&#x27;</span> <span class="keyword">AS</span> 类型，name</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">JOIN</span> departments d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.id</span><br><span class="line"><span class="keyword">WHERE</span> d.dept_location <span class="operator">=</span> <span class="string">&#x27;北京&#x27;</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;经理&#x27;</span> <span class="keyword">AS</span> 类型，name <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> manager_id <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure>

<h3 id="6-4-UNION-vs-OR"><a href="#6-4-UNION-vs-OR" class="headerlink" title="6.4 UNION vs OR"></a>6.4 UNION vs OR</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 使用 UNION（推荐，可以利用索引）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用 OR（可能影响索引使用）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">OR</span> dept_id <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- UNION 适用场景：</span></span><br><span class="line"><span class="comment">-- 1. 查询不同表的数据合并</span></span><br><span class="line"><span class="comment">-- 2. 复杂 OR 条件优化</span></span><br></pre></td></tr></table></figure>

<h3 id="6-5-UNION-排序和分页"><a href="#6-5-UNION-排序和分页" class="headerlink" title="6.5 UNION 排序和分页"></a>6.5 UNION 排序和分页</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- UNION 后排序（对整个结果集排序）</span></span><br><span class="line">(<span class="keyword">SELECT</span> name, salary <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">1</span>)</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">(<span class="keyword">SELECT</span> name, salary <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">2</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- UNION 后分页</span></span><br><span class="line">(<span class="keyword">SELECT</span> name, salary <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">1</span>)</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">(<span class="keyword">SELECT</span> name, salary <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">2</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span></span><br><span class="line">LIMIT <span class="number">5</span>, <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 注意：每个 SELECT 单独加 ORDER BY 需要使用括号</span></span><br><span class="line">(<span class="keyword">SELECT</span> name, salary <span class="keyword">FROM</span> employees <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span> LIMIT <span class="number">3</span>)</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">(<span class="keyword">SELECT</span> name, salary <span class="keyword">FROM</span> employees <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">ASC</span> LIMIT <span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<h2 id="七、子查询介绍"><a href="#七、子查询介绍" class="headerlink" title="七、子查询介绍"></a>七、子查询介绍</h2><h3 id="7-1-子查询概述"><a href="#7-1-子查询概述" class="headerlink" title="7.1 子查询概述"></a>7.1 子查询概述</h3><p><strong>子查询</strong> 是嵌套在其他 SQL 语句中的 SELECT 查询。</p>
<p><strong>子查询的位置</strong>：</p>
<ul>
<li>WHERE 子句中</li>
<li>FROM 子句中</li>
<li>SELECT 子句中</li>
<li>HAVING 子句中</li>
</ul>
<p><strong>子查询的分类</strong>：</p>
<ul>
<li>标量子查询：返回单个值</li>
<li>列子查询：返回单列多行</li>
<li>行子查询：返回单行多列</li>
<li>表子查询：返回多行多列</li>
</ul>
<h3 id="7-2-子查询基本语法"><a href="#7-2-子查询基本语法" class="headerlink" title="7.2 子查询基本语法"></a>7.2 子查询基本语法</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- WHERE 子句中的子查询</span></span><br><span class="line"><span class="keyword">SELECT</span> name <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> (<span class="keyword">SELECT</span> <span class="built_in">AVG</span>(salary) <span class="keyword">FROM</span> employees);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- FROM 子句中的子查询（派生表）</span></span><br><span class="line"><span class="keyword">SELECT</span> dept_name, avg_salary</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> d.dept_name, <span class="built_in">AVG</span>(e.salary) <span class="keyword">AS</span> avg_salary</span><br><span class="line">    <span class="keyword">FROM</span> departments d</span><br><span class="line">    <span class="keyword">JOIN</span> employees e <span class="keyword">ON</span> d.id <span class="operator">=</span> e.dept_id</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> d.id</span><br><span class="line">) <span class="keyword">AS</span> dept_stats;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- SELECT 子句中的子查询（标量）</span></span><br><span class="line"><span class="keyword">SELECT</span> name, salary,</span><br><span class="line">       (<span class="keyword">SELECT</span> <span class="built_in">AVG</span>(salary) <span class="keyword">FROM</span> employees) <span class="keyword">AS</span> 公司平均工资</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<h2 id="八、标量子查询"><a href="#八、标量子查询" class="headerlink" title="八、标量子查询"></a>八、标量子查询</h2><h3 id="8-1-标量子查询概述"><a href="#8-1-标量子查询概述" class="headerlink" title="8.1 标量子查询概述"></a>8.1 标量子查询概述</h3><p><strong>标量子查询</strong> 返回单个值（一行一列），通常用于比较。</p>
<h3 id="8-2-标量子查询示例"><a href="#8-2-标量子查询示例" class="headerlink" title="8.2 标量子查询示例"></a>8.2 标量子查询示例</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询工资高于平均工资的员工</span></span><br><span class="line"><span class="keyword">SELECT</span> name, salary <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> (<span class="keyword">SELECT</span> <span class="built_in">AVG</span>(salary) <span class="keyword">FROM</span> employees);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询工资最高的员工</span></span><br><span class="line"><span class="keyword">SELECT</span> name, salary <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="operator">=</span> (<span class="keyword">SELECT</span> <span class="built_in">MAX</span>(salary) <span class="keyword">FROM</span> employees);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询入职最早的员工</span></span><br><span class="line"><span class="keyword">SELECT</span> name, hire_date <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> hire_date <span class="operator">=</span> (<span class="keyword">SELECT</span> <span class="built_in">MIN</span>(hire_date) <span class="keyword">FROM</span> employees);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询低于本部门平均工资的员工</span></span><br><span class="line"><span class="keyword">SELECT</span> e1.name, e1.dept_id, e1.salary</span><br><span class="line"><span class="keyword">FROM</span> employees e1</span><br><span class="line"><span class="keyword">WHERE</span> e1.salary <span class="operator">&lt;</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="built_in">AVG</span>(e2.salary)</span><br><span class="line">    <span class="keyword">FROM</span> employees e2</span><br><span class="line">    <span class="keyword">WHERE</span> e2.dept_id <span class="operator">=</span> e1.dept_id</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在 SELECT 中使用标量子查询</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    name,</span><br><span class="line">    salary,</span><br><span class="line">    (<span class="keyword">SELECT</span> <span class="built_in">AVG</span>(salary) <span class="keyword">FROM</span> employees) <span class="keyword">AS</span> 公司平均工资，</span><br><span class="line">    (<span class="keyword">SELECT</span> <span class="built_in">AVG</span>(e2.salary) <span class="keyword">FROM</span> employees e2 <span class="keyword">WHERE</span> e2.dept_id <span class="operator">=</span> e.dept_id) <span class="keyword">AS</span> 部门平均工资</span><br><span class="line"><span class="keyword">FROM</span> employees e;</span><br></pre></td></tr></table></figure>

<h2 id="九、列子查询"><a href="#九、列子查询" class="headerlink" title="九、列子查询"></a>九、列子查询</h2><h3 id="9-1-列子查询概述"><a href="#9-1-列子查询概述" class="headerlink" title="9.1 列子查询概述"></a>9.1 列子查询概述</h3><p><strong>列子查询</strong> 返回单列多行，通常与 IN、NOT IN、ANY、ALL 配合使用。</p>
<h3 id="9-2-IN-NOT-IN"><a href="#9-2-IN-NOT-IN" class="headerlink" title="9.2 IN &#x2F; NOT IN"></a>9.2 IN &#x2F; NOT IN</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询技术部和市场部的员工</span></span><br><span class="line"><span class="keyword">SELECT</span> name, dept_id <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> dept_id <span class="keyword">IN</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> id <span class="keyword">FROM</span> departments <span class="keyword">WHERE</span> dept_name <span class="keyword">IN</span> (<span class="string">&#x27;技术部&#x27;</span>, <span class="string">&#x27;市场部&#x27;</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询没有员工的部门</span></span><br><span class="line"><span class="keyword">SELECT</span> dept_name <span class="keyword">FROM</span> departments</span><br><span class="line"><span class="keyword">WHERE</span> id <span class="keyword">NOT</span> <span class="keyword">IN</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> dept_id <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> dept_id <span class="keyword">IS</span> <span class="keyword">NOT NULL</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询选了某门课程的学生</span></span><br><span class="line"><span class="keyword">SELECT</span> name <span class="keyword">FROM</span> students</span><br><span class="line"><span class="keyword">WHERE</span> id <span class="keyword">IN</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> student_id <span class="keyword">FROM</span> enrollments <span class="keyword">WHERE</span> course_id <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="9-3-ANY-SOME"><a href="#9-3-ANY-SOME" class="headerlink" title="9.3 ANY &#x2F; SOME"></a>9.3 ANY &#x2F; SOME</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询工资比任一技术部员工高的员工</span></span><br><span class="line"><span class="keyword">SELECT</span> name, salary <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> <span class="keyword">ANY</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> salary <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 等价于（使用 MIN）</span></span><br><span class="line"><span class="keyword">SELECT</span> name, salary <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> (<span class="keyword">SELECT</span> <span class="built_in">MIN</span>(salary) <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<h3 id="9-4-ALL"><a href="#9-4-ALL" class="headerlink" title="9.4 ALL"></a>9.4 ALL</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询工资比所有技术部员工都高的员工</span></span><br><span class="line"><span class="keyword">SELECT</span> name, salary <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> <span class="keyword">ALL</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> salary <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 等价于（使用 MAX）</span></span><br><span class="line"><span class="keyword">SELECT</span> name, salary <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> (<span class="keyword">SELECT</span> <span class="built_in">MAX</span>(salary) <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<h2 id="十、行子查询"><a href="#十、行子查询" class="headerlink" title="十、行子查询"></a>十、行子查询</h2><h3 id="10-1-行子查询概述"><a href="#10-1-行子查询概述" class="headerlink" title="10.1 行子查询概述"></a>10.1 行子查询概述</h3><p><strong>行子查询</strong> 返回单行多列，可以与行构造符配合使用。</p>
<h3 id="10-2-行子查询示例"><a href="#10-2-行子查询示例" class="headerlink" title="10.2 行子查询示例"></a>10.2 行子查询示例</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询工资和部门都与张三相同的员工</span></span><br><span class="line"><span class="keyword">SELECT</span> name, dept_id, salary <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> (salary, dept_id) <span class="operator">=</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> salary, dept_id <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用行构造符比较</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> (dept_id, salary) <span class="operator">&gt;</span> (<span class="number">1</span>, <span class="number">8000</span>);  <span class="comment">-- dept_id&gt;1 或 (dept_id=1 且 salary&gt;8000)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询工资最高的前几名员工</span></span><br><span class="line"><span class="keyword">SELECT</span> name, salary <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> (salary, id) <span class="keyword">IN</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> salary, id <span class="keyword">FROM</span> employees <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span> LIMIT <span class="number">3</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h2 id="十一、表子查询"><a href="#十一、表子查询" class="headerlink" title="十一、表子查询"></a>十一、表子查询</h2><h3 id="11-1-表子查询概述"><a href="#11-1-表子查询概述" class="headerlink" title="11.1 表子查询概述"></a>11.1 表子查询概述</h3><p><strong>表子查询</strong> 返回多行多列，通常用作派生表（FROM 子句中的子查询）。</p>
<h3 id="11-2-FROM-子句中的子查询"><a href="#11-2-FROM-子句中的子查询" class="headerlink" title="11.2 FROM 子句中的子查询"></a>11.2 FROM 子句中的子查询</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询各部门平均工资及高于平均工资的员工</span></span><br><span class="line"><span class="keyword">SELECT</span> e.name, e.salary, d.dept_name, d.avg_salary</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">JOIN</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> dept_id, <span class="built_in">AVG</span>(salary) <span class="keyword">AS</span> avg_salary</span><br><span class="line">    <span class="keyword">FROM</span> employees</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> dept_id</span><br><span class="line">) d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.dept_id</span><br><span class="line"><span class="keyword">WHERE</span> e.salary <span class="operator">&gt;</span> d.avg_salary;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询员工数超过 2 人的部门</span></span><br><span class="line"><span class="keyword">SELECT</span> d.dept_name, dept_stats.emp_count</span><br><span class="line"><span class="keyword">FROM</span> departments d</span><br><span class="line"><span class="keyword">JOIN</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> dept_id, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> emp_count</span><br><span class="line">    <span class="keyword">FROM</span> employees</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> dept_id</span><br><span class="line">    <span class="keyword">HAVING</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="operator">&gt;</span> <span class="number">2</span></span><br><span class="line">) dept_stats <span class="keyword">ON</span> d.id <span class="operator">=</span> dept_stats.dept_id;</span><br></pre></td></tr></table></figure>

<h3 id="11-3-相关子查询（EXISTS）"><a href="#11-3-相关子查询（EXISTS）" class="headerlink" title="11.3 相关子查询（EXISTS）"></a>11.3 相关子查询（EXISTS）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询有员工的部门（使用 EXISTS）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> departments d</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">EXISTS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> employees e <span class="keyword">WHERE</span> e.dept_id <span class="operator">=</span> d.id</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询没有员工的部门</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> departments d</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> employees e <span class="keyword">WHERE</span> e.dept_id <span class="operator">=</span> d.id</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询至少选了 2 门课的学生</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> students s</span><br><span class="line"><span class="keyword">WHERE</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> enrollments e <span class="keyword">WHERE</span> e.student_id <span class="operator">=</span> s.id</span><br><span class="line">) <span class="operator">&gt;=</span> <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<h2 id="十二、多表查询综合练习"><a href="#十二、多表查询综合练习" class="headerlink" title="十二、多表查询综合练习"></a>十二、多表查询综合练习</h2><h3 id="练习-1：基础查询"><a href="#练习-1：基础查询" class="headerlink" title="练习 1：基础查询"></a>练习 1：基础查询</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 1. 查询所有员工姓名、工资、部门名称</span></span><br><span class="line"><span class="keyword">SELECT</span> e.name, e.salary, d.dept_name</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> departments d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 查询北京部门的员工</span></span><br><span class="line"><span class="keyword">SELECT</span> e.name, d.dept_name, d.dept_location</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">JOIN</span> departments d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.id</span><br><span class="line"><span class="keyword">WHERE</span> d.dept_location <span class="operator">=</span> <span class="string">&#x27;北京&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3. 查询工资高于公司平均工资的员工</span></span><br><span class="line"><span class="keyword">SELECT</span> name, salary</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> (<span class="keyword">SELECT</span> <span class="built_in">AVG</span>(salary) <span class="keyword">FROM</span> employees);</span><br></pre></td></tr></table></figure>

<h3 id="练习-2：分组统计"><a href="#练习-2：分组统计" class="headerlink" title="练习 2：分组统计"></a>练习 2：分组统计</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 4. 查询各部门人数</span></span><br><span class="line"><span class="keyword">SELECT</span> d.dept_name, <span class="built_in">COUNT</span>(e.id) <span class="keyword">AS</span> emp_count</span><br><span class="line"><span class="keyword">FROM</span> departments d</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> employees e <span class="keyword">ON</span> d.id <span class="operator">=</span> e.dept_id</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> d.id, d.dept_name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 5. 查询各部门平均工资</span></span><br><span class="line"><span class="keyword">SELECT</span> d.dept_name, ROUND(<span class="built_in">AVG</span>(e.salary), <span class="number">2</span>) <span class="keyword">AS</span> avg_salary</span><br><span class="line"><span class="keyword">FROM</span> departments d</span><br><span class="line"><span class="keyword">JOIN</span> employees e <span class="keyword">ON</span> d.id <span class="operator">=</span> e.dept_id</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> d.id, d.dept_name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 6. 查询平均工资高于 8000 的部门</span></span><br><span class="line"><span class="keyword">SELECT</span> d.dept_name, ROUND(<span class="built_in">AVG</span>(e.salary), <span class="number">2</span>) <span class="keyword">AS</span> avg_salary</span><br><span class="line"><span class="keyword">FROM</span> departments d</span><br><span class="line"><span class="keyword">JOIN</span> employees e <span class="keyword">ON</span> d.id <span class="operator">=</span> e.dept_id</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> d.id, d.dept_name</span><br><span class="line"><span class="keyword">HAVING</span> <span class="built_in">AVG</span>(e.salary) <span class="operator">&gt;</span> <span class="number">8000</span>;</span><br></pre></td></tr></table></figure>

<h3 id="练习-3：复杂查询"><a href="#练习-3：复杂查询" class="headerlink" title="练习 3：复杂查询"></a>练习 3：复杂查询</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 7. 查询工资最高的前 3 名员工</span></span><br><span class="line"><span class="keyword">SELECT</span> e.name, e.salary, d.dept_name</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">JOIN</span> departments d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> e.salary <span class="keyword">DESC</span></span><br><span class="line">LIMIT <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 8. 查询每个部门工资最高的员工</span></span><br><span class="line"><span class="keyword">SELECT</span> e.name, e.dept_id, e.salary</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">WHERE</span> e.salary <span class="operator">=</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="built_in">MAX</span>(e2.salary)</span><br><span class="line">    <span class="keyword">FROM</span> employees e2</span><br><span class="line">    <span class="keyword">WHERE</span> e2.dept_id <span class="operator">=</span> e.dept_id</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 9. 查询员工及其上级领导（自连接）</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    e.name <span class="keyword">AS</span> 员工，</span><br><span class="line">    m.name <span class="keyword">AS</span> 上级领导</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> employees m <span class="keyword">ON</span> e.manager_id <span class="operator">=</span> m.id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 10. 查询没有下属的领导</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> m.name</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">JOIN</span> employees m <span class="keyword">ON</span> e.manager_id <span class="operator">=</span> m.id</span><br><span class="line"><span class="keyword">WHERE</span> m.id <span class="keyword">NOT</span> <span class="keyword">IN</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> manager_id <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> manager_id <span class="keyword">IS</span> <span class="keyword">NOT NULL</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h2 id="十三、小结"><a href="#十三、小结" class="headerlink" title="十三、小结"></a>十三、小结</h2><h3 id="连接查询总结"><a href="#连接查询总结" class="headerlink" title="连接查询总结"></a>连接查询总结</h3><table>
<thead>
<tr>
<th>连接类型</th>
<th>关键字</th>
<th>返回结果</th>
</tr>
</thead>
<tbody><tr>
<td>内连接</td>
<td>INNER JOIN</td>
<td>只返回匹配记录</td>
</tr>
<tr>
<td>左连接</td>
<td>LEFT JOIN</td>
<td>左表全部 + 右表匹配</td>
</tr>
<tr>
<td>右连接</td>
<td>RIGHT JOIN</td>
<td>右表全部 + 左表匹配</td>
</tr>
<tr>
<td>自连接</td>
<td>表别名</td>
<td>表自己连接自己</td>
</tr>
<tr>
<td>交叉连接</td>
<td>CROSS JOIN</td>
<td>笛卡尔积</td>
</tr>
</tbody></table>
<h3 id="子查询总结"><a href="#子查询总结" class="headerlink" title="子查询总结"></a>子查询总结</h3><table>
<thead>
<tr>
<th>子查询类型</th>
<th>返回值</th>
<th>常用位置</th>
</tr>
</thead>
<tbody><tr>
<td>标量子查询</td>
<td>单个值</td>
<td>WHERE、SELECT</td>
</tr>
<tr>
<td>列子查询</td>
<td>单列多行</td>
<td>WHERE (IN&#x2F;NOT IN)</td>
</tr>
<tr>
<td>行子查询</td>
<td>单行多列</td>
<td>WHERE</td>
</tr>
<tr>
<td>表子查询</td>
<td>多行多列</td>
<td>FROM</td>
</tr>
</tbody></table>
<h3 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h3><ol>
<li><strong>优先使用连接</strong>：大多数子查询可以用连接改写</li>
<li><strong>EXISTS vs IN</strong>： EXISTS 通常在子查询结果集大时性能更好</li>
<li>**避免 SELECT ***：只选择需要的列</li>
<li><strong>使用表别名</strong>：简化 SQL 语句</li>
<li><strong>注意 NULL 值</strong>：NOT IN 遇到 NULL 可能返回空结果</li>
</ol>
<hr>
<p><strong>下一篇</strong>：[MySQL 进阶教程 04-01 窗口函数概述](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 04-01 窗口函数概述&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 进阶教程 02-01 数据库约束详解](&#x2F;2026&#x2F;02&#x2F;23&#x2F;MySQL 进阶教程 02-01 数据库约束详解&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 进阶教程</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>多表查询</tag>
        <tag>连接查询</tag>
        <tag>子查询</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 进阶教程 04-03 聚合窗口函数</title>
    <url>/2026/02/24/MySQL%20%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B%2004-03%20%E8%81%9A%E5%90%88%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0/</url>
    <content><![CDATA[<h1 id="MySQL-进阶教程-04-03-聚合窗口函数"><a href="#MySQL-进阶教程-04-03-聚合窗口函数" class="headerlink" title="MySQL 进阶教程 04-03 聚合窗口函数"></a>MySQL 进阶教程 04-03 聚合窗口函数</h1><p>MySQL 的所有聚合函数（SUM、AVG、COUNT、MAX、MIN）都可以用作窗口函数。本文将详细讲解聚合窗口函数的使用方法，包括累计求和、移动平均、占比计算等常见场景。</p>
<h2 id="一、聚合窗口函数基础"><a href="#一、聚合窗口函数基础" class="headerlink" title="一、聚合窗口函数基础"></a>一、聚合窗口函数基础</h2><h3 id="1-1-聚合函数-vs-聚合窗口函数"><a href="#1-1-聚合函数-vs-聚合窗口函数" class="headerlink" title="1.1 聚合函数 vs 聚合窗口函数"></a>1.1 聚合函数 vs 聚合窗口函数</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 准备测试数据</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> orders;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    order_date <span class="type">DATE</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    amount <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">NOT NULL</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (order_date, amount) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;2024-01-01&#x27;</span>, <span class="number">100</span>),</span><br><span class="line">(<span class="string">&#x27;2024-01-02&#x27;</span>, <span class="number">150</span>),</span><br><span class="line">(<span class="string">&#x27;2024-01-03&#x27;</span>, <span class="number">200</span>),</span><br><span class="line">(<span class="string">&#x27;2024-01-04&#x27;</span>, <span class="number">120</span>),</span><br><span class="line">(<span class="string">&#x27;2024-01-05&#x27;</span>, <span class="number">180</span>),</span><br><span class="line">(<span class="string">&#x27;2024-01-06&#x27;</span>, <span class="number">90</span>),</span><br><span class="line">(<span class="string">&#x27;2024-01-07&#x27;</span>, <span class="number">250</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 传统聚合函数：返回单行</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">SUM</span>(amount) <span class="keyword">AS</span> total <span class="keyword">FROM</span> orders;</span><br><span class="line"><span class="comment">-- 结果：1090</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 聚合窗口函数：返回每行</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    id,</span><br><span class="line">    order_date,</span><br><span class="line">    amount,</span><br><span class="line">    <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>() <span class="keyword">AS</span> total</span><br><span class="line"><span class="keyword">FROM</span> orders;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：</span></span><br><span class="line"><span class="comment">id | order_date | amount | total</span></span><br><span class="line"><span class="comment">---+------------+--------+------</span></span><br><span class="line"><span class="comment">1  | 2024-01-01 | 100    | 1090</span></span><br><span class="line"><span class="comment">2  | 2024-01-02 | 150    | 1090</span></span><br><span class="line"><span class="comment">3  | 2024-01-03 | 200    | 1090</span></span><br><span class="line"><span class="comment">4  | 2024-01-04 | 120    | 1090</span></span><br><span class="line"><span class="comment">5  | 2024-01-05 | 180    | 1090</span></span><br><span class="line"><span class="comment">6  | 2024-01-06 | 90     | 1090</span></span><br><span class="line"><span class="comment">7  | 2024-01-07 | 250    | 1090</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="1-2-可用的聚合窗口函数"><a href="#1-2-可用的聚合窗口函数" class="headerlink" title="1.2 可用的聚合窗口函数"></a>1.2 可用的聚合窗口函数</h3><table>
<thead>
<tr>
<th>函数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>SUM(col) OVER</td>
<td>窗口内求和</td>
</tr>
<tr>
<td>AVG(col) OVER</td>
<td>窗口内平均</td>
</tr>
<tr>
<td>COUNT(*) OVER</td>
<td>窗口内计数</td>
</tr>
<tr>
<td>MAX(col) OVER</td>
<td>窗口内最大值</td>
</tr>
<tr>
<td>MIN(col) OVER</td>
<td>窗口内最小值</td>
</tr>
</tbody></table>
<h2 id="二、累计求和（Running-Total）"><a href="#二、累计求和（Running-Total）" class="headerlink" title="二、累计求和（Running Total）"></a>二、累计求和（Running Total）</h2><h3 id="2-1-简单累计"><a href="#2-1-简单累计" class="headerlink" title="2.1 简单累计"></a>2.1 简单累计</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 问题：计算每日累计订单金额</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    id,</span><br><span class="line">    order_date,</span><br><span class="line">    amount,</span><br><span class="line">    <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date) <span class="keyword">AS</span> running_total</span><br><span class="line"><span class="keyword">FROM</span> orders</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：</span></span><br><span class="line"><span class="comment">id | order_date | amount | running_total</span></span><br><span class="line"><span class="comment">---+------------+--------+--------------</span></span><br><span class="line"><span class="comment">1  | 2024-01-01 | 100    | 100</span></span><br><span class="line"><span class="comment">2  | 2024-01-02 | 150    | 250</span></span><br><span class="line"><span class="comment">3  | 2024-01-03 | 200    | 450</span></span><br><span class="line"><span class="comment">4  | 2024-01-04 | 120    | 570</span></span><br><span class="line"><span class="comment">5  | 2024-01-05 | 180    | 750</span></span><br><span class="line"><span class="comment">6  | 2024-01-06 | 90     | 840</span></span><br><span class="line"><span class="comment">7  | 2024-01-07 | 250    | 1090</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>执行逻辑</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">第 1 行：SUM(100) = 100</span><br><span class="line">第 2 行：SUM(100, 150) = 250</span><br><span class="line">第 3 行：SUM(100, 150, 200) = 450</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="2-2-显式指定窗口边界"><a href="#2-2-显式指定窗口边界" class="headerlink" title="2.2 显式指定窗口边界"></a>2.2 显式指定窗口边界</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 显式指定窗口范围（从起点到当前行）</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    id,</span><br><span class="line">    order_date,</span><br><span class="line">    amount,</span><br><span class="line">    <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(</span><br><span class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date</span><br><span class="line">        <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> UNBOUNDED PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span></span><br><span class="line">    ) <span class="keyword">AS</span> running_total</span><br><span class="line"><span class="keyword">FROM</span> orders;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果与上面相同，但语法更明确</span></span><br></pre></td></tr></table></figure>

<p><strong>窗口边界关键字</strong>：</p>
<table>
<thead>
<tr>
<th>关键字</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>UNBOUNDED PRECEDING</td>
<td>无边界（起点）</td>
</tr>
<tr>
<td>UNBOUNDED FOLLOWING</td>
<td>无边界（终点）</td>
</tr>
<tr>
<td>CURRENT ROW</td>
<td>当前行</td>
</tr>
<tr>
<td>n PRECEDING</td>
<td>向前 n 行</td>
</tr>
<tr>
<td>n FOLLOWING</td>
<td>向后 n 行</td>
</tr>
</tbody></table>
<h3 id="2-3-分组累计"><a href="#2-3-分组累计" class="headerlink" title="2.3 分组累计"></a>2.3 分组累计</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 准备带分组的测试数据</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> sales;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> sales (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    sale_date <span class="type">DATE</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    category <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    amount <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">NOT NULL</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> sales (sale_date, category, amount) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;2024-01-01&#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="number">100</span>),</span><br><span class="line">(<span class="string">&#x27;2024-01-02&#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="number">150</span>),</span><br><span class="line">(<span class="string">&#x27;2024-01-03&#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="number">200</span>),</span><br><span class="line">(<span class="string">&#x27;2024-01-01&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="number">80</span>),</span><br><span class="line">(<span class="string">&#x27;2024-01-02&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="number">120</span>),</span><br><span class="line">(<span class="string">&#x27;2024-01-03&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="number">90</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 问题：计算每个类别的累计销售额</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    id,</span><br><span class="line">    category,</span><br><span class="line">    sale_date,</span><br><span class="line">    amount,</span><br><span class="line">    <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(</span><br><span class="line">        <span class="keyword">PARTITION</span> <span class="keyword">BY</span> category</span><br><span class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> sale_date</span><br><span class="line">    ) <span class="keyword">AS</span> running_total</span><br><span class="line"><span class="keyword">FROM</span> sales</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> category, sale_date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：</span></span><br><span class="line"><span class="comment">id | category | sale_date | amount | running_total</span></span><br><span class="line"><span class="comment">---+----------+-----------+--------+--------------</span></span><br><span class="line"><span class="comment">1  | A        | 2024-01-01 | 100   | 100</span></span><br><span class="line"><span class="comment">2  | A        | 2024-01-02 | 150   | 250</span></span><br><span class="line"><span class="comment">3  | A        | 2024-01-03 | 200   | 450</span></span><br><span class="line"><span class="comment">4  | B        | 2024-01-01 | 80    | 80</span></span><br><span class="line"><span class="comment">5  | B        | 2024-01-02 | 120   | 200</span></span><br><span class="line"><span class="comment">6  | B        | 2024-01-03 | 90    | 290</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h2 id="三、移动平均（Moving-Average）"><a href="#三、移动平均（Moving-Average）" class="headerlink" title="三、移动平均（Moving Average）"></a>三、移动平均（Moving Average）</h2><h3 id="3-1-计算移动平均"><a href="#3-1-计算移动平均" class="headerlink" title="3.1 计算移动平均"></a>3.1 计算移动平均</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 问题：计算 3 日移动平均（包含当前日期和前 2 天）</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    id,</span><br><span class="line">    order_date,</span><br><span class="line">    amount,</span><br><span class="line">    <span class="built_in">AVG</span>(amount) <span class="keyword">OVER</span>(</span><br><span class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date</span><br><span class="line">        <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">2</span> PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span></span><br><span class="line">    ) <span class="keyword">AS</span> moving_avg_3d</span><br><span class="line"><span class="keyword">FROM</span> orders</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：</span></span><br><span class="line"><span class="comment">id | order_date | amount | moving_avg_3d</span></span><br><span class="line"><span class="comment">---+------------+--------+--------------</span></span><br><span class="line"><span class="comment">1  | 2024-01-01 | 100    | 100.00        (100/1)</span></span><br><span class="line"><span class="comment">2  | 2024-01-02 | 150    | 125.00        ((100+150)/2)</span></span><br><span class="line"><span class="comment">3  | 2024-01-03 | 200    | 150.00        ((100+150+200)/3)</span></span><br><span class="line"><span class="comment">4  | 2024-01-04 | 120    | 156.67        ((150+200+120)/3)</span></span><br><span class="line"><span class="comment">5  | 2024-01-05 | 180    | 166.67        ((200+120+180)/3)</span></span><br><span class="line"><span class="comment">6  | 2024-01-06 | 90     | 130.00        ((120+180+90)/3)</span></span><br><span class="line"><span class="comment">7  | 2024-01-07 | 250    | 173.33        ((180+90+250)/3)</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-不同周期的移动平均"><a href="#3-2-不同周期的移动平均" class="headerlink" title="3.2 不同周期的移动平均"></a>3.2 不同周期的移动平均</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 计算多种移动平均进行对比</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    order_date,</span><br><span class="line">    amount,</span><br><span class="line">    <span class="built_in">AVG</span>(amount) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">2</span> PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span>) <span class="keyword">AS</span> ma_3d,</span><br><span class="line">    <span class="built_in">AVG</span>(amount) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">4</span> PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span>) <span class="keyword">AS</span> ma_5d,</span><br><span class="line">    <span class="built_in">AVG</span>(amount) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">6</span> PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span>) <span class="keyword">AS</span> ma_7d</span><br><span class="line"><span class="keyword">FROM</span> orders</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-移动总和"><a href="#3-3-移动总和" class="headerlink" title="3.3 移动总和"></a>3.3 移动总和</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 计算 7 天滚动总和（用于周报等）</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    order_date,</span><br><span class="line">    amount,</span><br><span class="line">    <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(</span><br><span class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date</span><br><span class="line">        <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">6</span> PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span></span><br><span class="line">    ) <span class="keyword">AS</span> rolling_7d_total</span><br><span class="line"><span class="keyword">FROM</span> orders;</span><br></pre></td></tr></table></figure>

<h2 id="四、占比计算"><a href="#四、占比计算" class="headerlink" title="四、占比计算"></a>四、占比计算</h2><h3 id="4-1-计算单项占比"><a href="#4-1-计算单项占比" class="headerlink" title="4.1 计算单项占比"></a>4.1 计算单项占比</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 问题：计算每笔订单占总金额的比例</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    id,</span><br><span class="line">    order_date,</span><br><span class="line">    amount,</span><br><span class="line">    ROUND(amount <span class="operator">*</span> <span class="number">100.0</span> <span class="operator">/</span> <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(), <span class="number">2</span>) <span class="keyword">AS</span> percentage</span><br><span class="line"><span class="keyword">FROM</span> orders;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：</span></span><br><span class="line"><span class="comment">id | amount | percentage</span></span><br><span class="line"><span class="comment">---+--------+------------</span></span><br><span class="line"><span class="comment">1  | 100    | 9.17</span></span><br><span class="line"><span class="comment">2  | 150    | 13.76</span></span><br><span class="line"><span class="comment">3  | 200    | 18.35</span></span><br><span class="line"><span class="comment">4  | 120    | 11.01</span></span><br><span class="line"><span class="comment">5  | 180    | 16.51</span></span><br><span class="line"><span class="comment">6  | 90     | 8.26</span></span><br><span class="line"><span class="comment">7  | 250    | 22.94</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-分组内占比"><a href="#4-2-分组内占比" class="headerlink" title="4.2 分组内占比"></a>4.2 分组内占比</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 问题：计算每笔订单在当日的占比</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    id,</span><br><span class="line">    order_date,</span><br><span class="line">    amount,</span><br><span class="line">    ROUND(amount <span class="operator">*</span> <span class="number">100.0</span> <span class="operator">/</span> <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> order_date), <span class="number">2</span>) <span class="keyword">AS</span> daily_percentage</span><br><span class="line"><span class="keyword">FROM</span> orders;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-累计占比"><a href="#4-3-累计占比" class="headerlink" title="4.3 累计占比"></a>4.3 累计占比</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 问题：计算累计金额占总金额的百分比</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    id,</span><br><span class="line">    order_date,</span><br><span class="line">    amount,</span><br><span class="line">    <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date) <span class="keyword">AS</span> running_total,</span><br><span class="line">    <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>() <span class="keyword">AS</span> grand_total,</span><br><span class="line">    ROUND(</span><br><span class="line">        <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date) <span class="operator">*</span> <span class="number">100.0</span> <span class="operator">/</span> <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(),</span><br><span class="line">        <span class="number">2</span></span><br><span class="line">    ) <span class="keyword">AS</span> running_percentage</span><br><span class="line"><span class="keyword">FROM</span> orders</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：</span></span><br><span class="line"><span class="comment">id | amount | running_total | grand_total | running_percentage</span></span><br><span class="line"><span class="comment">---+--------+---------------+-------------+-------------------</span></span><br><span class="line"><span class="comment">1  | 100    | 100           | 1090        | 9.17</span></span><br><span class="line"><span class="comment">2  | 150    | 250           | 1090        | 22.94</span></span><br><span class="line"><span class="comment">3  | 200    | 450           | 1090        | 41.28</span></span><br><span class="line"><span class="comment">4  | 120    | 570           | 1090        | 52.29</span></span><br><span class="line"><span class="comment">5  | 180    | 750           | 1090        | 68.81</span></span><br><span class="line"><span class="comment">6  | 90     | 840           | 1090        | 77.06</span></span><br><span class="line"><span class="comment">7  | 250    | 1090          | 1090        | 100.00</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h2 id="五、其他聚合窗口函数"><a href="#五、其他聚合窗口函数" class="headerlink" title="五、其他聚合窗口函数"></a>五、其他聚合窗口函数</h2><h3 id="5-1-COUNT-窗口函数"><a href="#5-1-COUNT-窗口函数" class="headerlink" title="5.1 COUNT 窗口函数"></a>5.1 COUNT 窗口函数</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 问题：计算累计订单数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    id,</span><br><span class="line">    order_date,</span><br><span class="line">    amount,</span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date) <span class="keyword">AS</span> running_count</span><br><span class="line"><span class="keyword">FROM</span> orders;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：</span></span><br><span class="line"><span class="comment">id | order_date | amount | running_count</span></span><br><span class="line"><span class="comment">---+------------+--------+--------------</span></span><br><span class="line"><span class="comment">1  | 2024-01-01 | 100    | 1</span></span><br><span class="line"><span class="comment">2  | 2024-01-02 | 150    | 2</span></span><br><span class="line"><span class="comment">3  | 2024-01-03 | 200    | 3</span></span><br><span class="line"><span class="comment">...</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 分组计数</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    category,</span><br><span class="line">    sale_date,</span><br><span class="line">    amount,</span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> category) <span class="keyword">AS</span> category_count</span><br><span class="line"><span class="keyword">FROM</span> sales;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-MAX-MIN-窗口函数"><a href="#5-2-MAX-MIN-窗口函数" class="headerlink" title="5.2 MAX&#x2F;MIN 窗口函数"></a>5.2 MAX&#x2F;MIN 窗口函数</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 问题：每行显示当前最大值和最小值</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    order_date,</span><br><span class="line">    amount,</span><br><span class="line">    <span class="built_in">MAX</span>(amount) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date) <span class="keyword">AS</span> max_so_far,</span><br><span class="line">    <span class="built_in">MIN</span>(amount) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date) <span class="keyword">AS</span> min_so_far</span><br><span class="line"><span class="keyword">FROM</span> orders;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：</span></span><br><span class="line"><span class="comment">order_date | amount | max_so_far | min_so_far</span></span><br><span class="line"><span class="comment">-----------+--------+------------+-----------</span></span><br><span class="line"><span class="comment">2024-01-01 | 100    | 100        | 100</span></span><br><span class="line"><span class="comment">2024-01-02 | 150    | 150        | 100</span></span><br><span class="line"><span class="comment">2024-01-03 | 200    | 200        | 100</span></span><br><span class="line"><span class="comment">2024-01-04 | 120    | 200        | 100</span></span><br><span class="line"><span class="comment">...</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-首尾值"><a href="#5-3-首尾值" class="headerlink" title="5.3 首尾值"></a>5.3 首尾值</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 问题：每行显示第一笔和最后一笔订单金额</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    order_date,</span><br><span class="line">    amount,</span><br><span class="line">    <span class="built_in">FIRST_VALUE</span>(amount) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date) <span class="keyword">AS</span> first_amount,</span><br><span class="line">    <span class="built_in">LAST_VALUE</span>(amount) <span class="keyword">OVER</span>(</span><br><span class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date</span><br><span class="line">        <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> UNBOUNDED PRECEDING <span class="keyword">AND</span> UNBOUNDED FOLLOWING</span><br><span class="line">    ) <span class="keyword">AS</span> last_amount</span><br><span class="line"><span class="keyword">FROM</span> orders;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：<code>LAST_VALUE</code> 需要显式指定窗口边界，否则只计算到当前行。</p>
<h2 id="六、实战案例"><a href="#六、实战案例" class="headerlink" title="六、实战案例"></a>六、实战案例</h2><h3 id="6-1-财务报表-累计收入与占比"><a href="#6-1-财务报表-累计收入与占比" class="headerlink" title="6.1 财务报表 - 累计收入与占比"></a>6.1 财务报表 - 累计收入与占比</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 场景：生成财务报表，显示累计收入和累计占比</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    DATE_FORMAT(order_date, <span class="string">&#x27;%Y-%m-%d&#x27;</span>) <span class="keyword">AS</span> <span class="type">date</span>,</span><br><span class="line">    amount <span class="keyword">AS</span> daily_amount,</span><br><span class="line">    <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date) <span class="keyword">AS</span> cumulative_amount,</span><br><span class="line">    ROUND(</span><br><span class="line">        <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date) <span class="operator">*</span> <span class="number">100.0</span> <span class="operator">/</span> <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(),</span><br><span class="line">        <span class="number">2</span></span><br><span class="line">    ) <span class="keyword">AS</span> cumulative_percentage</span><br><span class="line"><span class="keyword">FROM</span> orders</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-销售趋势分析"><a href="#6-2-销售趋势分析" class="headerlink" title="6.2 销售趋势分析"></a>6.2 销售趋势分析</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 场景：分析销售趋势，比较当日与移动平均</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    order_date,</span><br><span class="line">    amount <span class="keyword">AS</span> daily_amount,</span><br><span class="line">    <span class="built_in">AVG</span>(amount) <span class="keyword">OVER</span>(</span><br><span class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date</span><br><span class="line">        <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">2</span> PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span></span><br><span class="line">    ) <span class="keyword">AS</span> moving_avg_3d,</span><br><span class="line">    <span class="keyword">CASE</span></span><br><span class="line">        <span class="keyword">WHEN</span> amount <span class="operator">&gt;</span> <span class="built_in">AVG</span>(amount) <span class="keyword">OVER</span>(</span><br><span class="line">            <span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">2</span> PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span></span><br><span class="line">        ) <span class="keyword">THEN</span> <span class="string">&#x27;高于平均&#x27;</span></span><br><span class="line">        <span class="keyword">ELSE</span> <span class="string">&#x27;低于平均&#x27;</span></span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">AS</span> trend</span><br><span class="line"><span class="keyword">FROM</span> orders;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-年度目标完成进度"><a href="#6-3-年度目标完成进度" class="headerlink" title="6.3 年度目标完成进度"></a>6.3 年度目标完成进度</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 假设有年度目标 10000，计算完成进度</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    order_date,</span><br><span class="line">    amount,</span><br><span class="line">    <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date) <span class="keyword">AS</span> running_total,</span><br><span class="line">    <span class="number">10000</span> <span class="keyword">AS</span> annual_target,</span><br><span class="line">    ROUND(</span><br><span class="line">        <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date) <span class="operator">*</span> <span class="number">100.0</span> <span class="operator">/</span> <span class="number">10000</span>,</span><br><span class="line">        <span class="number">2</span></span><br><span class="line">    ) <span class="keyword">AS</span> target_completion_pct</span><br><span class="line"><span class="keyword">FROM</span> orders;</span><br></pre></td></tr></table></figure>

<h3 id="6-4-帕累托分析（二八法则）"><a href="#6-4-帕累托分析（二八法则）" class="headerlink" title="6.4 帕累托分析（二八法则）"></a>6.4 帕累托分析（二八法则）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 找出贡献 80% 销售额的关键订单</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WITH</span> order_ranking <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        id,</span><br><span class="line">        order_date,</span><br><span class="line">        amount,</span><br><span class="line">        <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> amount <span class="keyword">DESC</span>) <span class="keyword">AS</span> running_total,</span><br><span class="line">        <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>() <span class="keyword">AS</span> total</span><br><span class="line">    <span class="keyword">FROM</span> orders</span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    id,</span><br><span class="line">    order_date,</span><br><span class="line">    amount,</span><br><span class="line">    ROUND(running_total <span class="operator">*</span> <span class="number">100.0</span> <span class="operator">/</span> total, <span class="number">2</span>) <span class="keyword">AS</span> cumulative_pct</span><br><span class="line"><span class="keyword">FROM</span> order_ranking</span><br><span class="line"><span class="keyword">WHERE</span> running_total <span class="operator">*</span> <span class="number">100.0</span> <span class="operator">/</span> total <span class="operator">&lt;=</span> <span class="number">80</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> amount <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h2 id="七、性能优化建议"><a href="#七、性能优化建议" class="headerlink" title="七、性能优化建议"></a>七、性能优化建议</h2><h3 id="7-1-避免重复计算"><a href="#7-1-避免重复计算" class="headerlink" title="7.1 避免重复计算"></a>7.1 避免重复计算</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 不好：SUM 计算了两次</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    order_date,</span><br><span class="line">    amount,</span><br><span class="line">    <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date) <span class="keyword">AS</span> running_total,</span><br><span class="line">    <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>() <span class="keyword">AS</span> grand_total,</span><br><span class="line">    ROUND(<span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date) <span class="operator">*</span> <span class="number">100.0</span> <span class="operator">/</span> <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(), <span class="number">2</span>) <span class="keyword">AS</span> pct</span><br><span class="line"><span class="keyword">FROM</span> orders;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 好：使用子查询或 CTE</span></span><br><span class="line"><span class="keyword">WITH</span> totals <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        order_date,</span><br><span class="line">        amount,</span><br><span class="line">        <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date) <span class="keyword">AS</span> running_total,</span><br><span class="line">        <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>() <span class="keyword">AS</span> grand_total</span><br><span class="line">    <span class="keyword">FROM</span> orders</span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    order_date,</span><br><span class="line">    amount,</span><br><span class="line">    running_total,</span><br><span class="line">    grand_total,</span><br><span class="line">    ROUND(running_total <span class="operator">*</span> <span class="number">100.0</span> <span class="operator">/</span> grand_total, <span class="number">2</span>) <span class="keyword">AS</span> pct</span><br><span class="line"><span class="keyword">FROM</span> totals;</span><br></pre></td></tr></table></figure>

<h3 id="7-2-使用合适的索引"><a href="#7-2-使用合适的索引" class="headerlink" title="7.2 使用合适的索引"></a>7.2 使用合适的索引</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 为窗口排序列添加索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_order_date <span class="keyword">ON</span> orders(order_date);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 为分组 + 排序添加复合索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_category_date <span class="keyword">ON</span> sales(category, sale_date);</span><br></pre></td></tr></table></figure>

<h2 id="八、小结"><a href="#八、小结" class="headerlink" title="八、小结"></a>八、小结</h2><h3 id="核心知识点"><a href="#核心知识点" class="headerlink" title="核心知识点"></a>核心知识点</h3><ol>
<li><p><strong>累计求和</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="built_in">SUM</span>(col) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="type">date</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>移动平均</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="built_in">AVG</span>(col) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="type">date</span> <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> n PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>占比计算</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">amount <span class="operator">*</span> <span class="number">100.0</span> <span class="operator">/</span> <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>()</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>分组累计</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="built_in">SUM</span>(col) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">group</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="type">date</span>)</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="常用窗口边界"><a href="#常用窗口边界" class="headerlink" title="常用窗口边界"></a>常用窗口边界</h3><table>
<thead>
<tr>
<th>语法</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><code>ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW</code></td>
<td>从起点到当前行（累计）</td>
</tr>
<tr>
<td><code>ROWS BETWEEN n PRECEDING AND CURRENT ROW</code></td>
<td>前 n 行到当前行（移动）</td>
</tr>
<tr>
<td><code>ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING</code></td>
<td>整个窗口</td>
</tr>
</tbody></table>
<h3 id="下一章预告"><a href="#下一章预告" class="headerlink" title="下一章预告"></a>下一章预告</h3><p>下一篇文章将介绍<strong>前后行访问函数</strong>（LEAD&#x2F;LAG），包括：</p>
<ul>
<li>LEAD 函数访问后续行</li>
<li>LAG 函数访问前续行</li>
<li>同比环比计算</li>
<li>差值分析</li>
</ul>
<hr>
<p><strong>下一篇</strong>：[MySQL 进阶教程 04-04 LEAD&#x2F;LAG 前后行访问](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 04-04 LEAD LAG 前后行访问&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 进阶教程 04-02 ROW_NUMBER 和排名函数](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 04-02 ROW_NUMBER 和排名函数&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 进阶教程</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>窗口函数</tag>
        <tag>SUM</tag>
        <tag>AVG</tag>
        <tag>累计求和</tag>
        <tag>移动平均</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 进阶教程 04-02 ROW_NUMBER 和排名函数</title>
    <url>/2026/02/24/MySQL%20%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B%2004-02%20ROW_NUMBER%20%E5%92%8C%E6%8E%92%E5%90%8D%E5%87%BD%E6%95%B0/</url>
    <content><![CDATA[<h1 id="MySQL-进阶教程-04-02-ROW-NUMBER-和排名函数"><a href="#MySQL-进阶教程-04-02-ROW-NUMBER-和排名函数" class="headerlink" title="MySQL 进阶教程 04-02 ROW_NUMBER 和排名函数"></a>MySQL 进阶教程 04-02 ROW_NUMBER 和排名函数</h1><p>在窗口函数中，排名函数是最常用、最重要的一类函数。本文将详细讲解 ROW_NUMBER、RANK、DENSE_RANK 三种排名函数的区别和使用方法。</p>
<h2 id="一、排名函数简介"><a href="#一、排名函数简介" class="headerlink" title="一、排名函数简介"></a>一、排名函数简介</h2><p>MySQL 提供三种主要的排名函数：</p>
<table>
<thead>
<tr>
<th>函数</th>
<th>说明</th>
<th>排名序列示例</th>
</tr>
</thead>
<tbody><tr>
<td>ROW_NUMBER()</td>
<td>连续排名，无重复，不跳过</td>
<td>1, 2, 3, 4, 5</td>
</tr>
<tr>
<td>RANK()</td>
<td>跳跃排名，有重复，跳过</td>
<td>1, 2, 2, 4, 5</td>
</tr>
<tr>
<td>DENSE_RANK()</td>
<td>密集排名，有重复，不跳过</td>
<td>1, 2, 2, 3, 4</td>
</tr>
</tbody></table>
<h3 id="测试数据准备"><a href="#测试数据准备" class="headerlink" title="测试数据准备"></a>测试数据准备</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建员工表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> employees;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> employees (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    dept_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    salary <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">NOT NULL</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入测试数据（故意制造工资相同的情况）</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> employees (name, dept_id, salary) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;张三&#x27;</span>, <span class="number">1</span>, <span class="number">10000</span>),</span><br><span class="line">(<span class="string">&#x27;李四&#x27;</span>, <span class="number">1</span>, <span class="number">10000</span>),  <span class="comment">-- 与张三工资相同</span></span><br><span class="line">(<span class="string">&#x27;王五&#x27;</span>, <span class="number">1</span>, <span class="number">8000</span>),</span><br><span class="line">(<span class="string">&#x27;赵六&#x27;</span>, <span class="number">1</span>, <span class="number">6000</span>),</span><br><span class="line">(<span class="string">&#x27;孙七&#x27;</span>, <span class="number">2</span>, <span class="number">12000</span>),</span><br><span class="line">(<span class="string">&#x27;周八&#x27;</span>, <span class="number">2</span>, <span class="number">12000</span>),  <span class="comment">-- 与孙七工资相同</span></span><br><span class="line">(<span class="string">&#x27;吴九&#x27;</span>, <span class="number">2</span>, <span class="number">9000</span>),</span><br><span class="line">(<span class="string">&#x27;郑十&#x27;</span>, <span class="number">2</span>, <span class="number">9000</span>),   <span class="comment">-- 与吴九工资相同</span></span><br><span class="line">(<span class="string">&#x27;王十一&#x27;</span>, <span class="number">2</span>, <span class="number">5000</span>);</span><br></pre></td></tr></table></figure>

<h2 id="二、三种排名函数的区别"><a href="#二、三种排名函数的区别" class="headerlink" title="二、三种排名函数的区别"></a>二、三种排名函数的区别</h2><h3 id="2-1-全局排名演示"><a href="#2-1-全局排名演示" class="headerlink" title="2.1 全局排名演示"></a>2.1 全局排名演示</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 对比三种排名函数</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    name,</span><br><span class="line">    dept_id,</span><br><span class="line">    salary,</span><br><span class="line">    <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>) <span class="keyword">AS</span> row_num,</span><br><span class="line">    <span class="built_in">RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>) <span class="keyword">AS</span> rank,</span><br><span class="line">    <span class="built_in">DENSE_RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>) <span class="keyword">AS</span> dense_rank</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>, name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果：</span></span><br><span class="line"><span class="comment">-- name   | dept_id | salary | row_num | rank | dense_rank</span></span><br><span class="line"><span class="comment">-- -------+---------+--------+---------+------+------------</span></span><br><span class="line"><span class="comment">-- 孙七    |    2    | 12000  |    1    |   1  |     1</span></span><br><span class="line"><span class="comment">-- 周八    |    2    | 12000  |    2    |   1  |     1</span></span><br><span class="line"><span class="comment">-- 张三    |    1    | 10000  |    3    |   3  |     2</span></span><br><span class="line"><span class="comment">-- 李四    |    1    | 10000  |    4    |   3  |     2</span></span><br><span class="line"><span class="comment">-- 王五    |    1    | 8000   |    5    |   5  |     3</span></span><br><span class="line"><span class="comment">-- 吴九    |    2    | 9000   |    6    |   5  |     3</span></span><br><span class="line"><span class="comment">-- 周八    |    2    | 9000   |    7    |   5  |     3</span></span><br><span class="line"><span class="comment">-- 郑十    |    2    | 9000   |    8    |   5  |     3</span></span><br><span class="line"><span class="comment">-- 王十一  |    2    | 5000   |    9    |   9  |     4</span></span><br></pre></td></tr></table></figure>

<p><strong>关键观察</strong>：</p>
<table>
<thead>
<tr>
<th>函数</th>
<th>工资 12000</th>
<th>工资 10000</th>
<th>工资 9000</th>
<th>特点</th>
</tr>
</thead>
<tbody><tr>
<td>ROW_NUMBER</td>
<td>1, 2</td>
<td>3, 4</td>
<td>6, 7</td>
<td>连续编号，不考虑并列</td>
</tr>
<tr>
<td>RANK</td>
<td>1, 1</td>
<td>3, 3</td>
<td>5, 5, 5, 5</td>
<td>并列同名，跳过后续排名</td>
</tr>
<tr>
<td>DENSE_RANK</td>
<td>1, 1</td>
<td>2, 2</td>
<td>3, 3, 3, 3</td>
<td>并列同名，不跳过后续排名</td>
</tr>
</tbody></table>
<h3 id="2-2-图解排名原理"><a href="#2-2-图解排名原理" class="headerlink" title="2.2 图解排名原理"></a>2.2 图解排名原理</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">原始数据（按工资降序）：</span><br><span class="line">孙七  12000  ← 第 1 名</span><br><span class="line">周八  12000  ← 第 2 名（并列第 1）</span><br><span class="line">张三  10000  ← 第 3 名</span><br><span class="line">李四  10000  ← 第 4 名（并列第 3）</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">ROW_NUMBER:  1, 2, 3, 4, 5...  (按顺序编号)</span><br><span class="line">RANK:        1, 1, 3, 3, 5...  (并列第 1，跳过第 2)</span><br><span class="line">DENSE_RANK:  1, 1, 2, 2, 3...  (并列第 1，下一个是第 2)</span><br></pre></td></tr></table></figure>

<h2 id="三、分组内排名"><a href="#三、分组内排名" class="headerlink" title="三、分组内排名"></a>三、分组内排名</h2><h3 id="3-1-部门内工资排名"><a href="#3-1-部门内工资排名" class="headerlink" title="3.1 部门内工资排名"></a>3.1 部门内工资排名</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 问题：获取每个部门内的工资排名</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    name,</span><br><span class="line">    dept_id,</span><br><span class="line">    salary,</span><br><span class="line">    <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>) <span class="keyword">AS</span> row_num,</span><br><span class="line">    <span class="built_in">RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>) <span class="keyword">AS</span> rank,</span><br><span class="line">    <span class="built_in">DENSE_RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>) <span class="keyword">AS</span> dense_rank</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> dept_id, salary <span class="keyword">DESC</span>, name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果：</span></span><br><span class="line"><span class="comment">-- name   | dept_id | salary | row_num | rank | dense_rank</span></span><br><span class="line"><span class="comment">-- -------+---------+--------+---------+------+------------</span></span><br><span class="line"><span class="comment">-- 张三    |    1    | 10000  |    1    |   1  |     1</span></span><br><span class="line"><span class="comment">-- 李四    |    1    | 10000  |    2    |   1  |     1</span></span><br><span class="line"><span class="comment">-- 王五    |    1    | 8000   |    3    |   3  |     2</span></span><br><span class="line"><span class="comment">-- 赵六    |    1    | 6000   |    4    |   4  |     3</span></span><br><span class="line"><span class="comment">-- 孙七    |    2    | 12000  |    1    |   1  |     1</span></span><br><span class="line"><span class="comment">-- 周八    |    2    | 12000  |    2    |   1  |     1</span></span><br><span class="line"><span class="comment">-- 吴九    |    2    | 9000   |    3    |   3  |     2</span></span><br><span class="line"><span class="comment">-- 郑十    |    2    | 9000   |    4    |   3  |     2</span></span><br><span class="line"><span class="comment">-- 王十一  |    2    | 5000   |    5    |   5  |     3</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-多列排序"><a href="#3-2-多列排序" class="headerlink" title="3.2 多列排序"></a>3.2 多列排序</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 问题：工资相同时，按姓名拼音排序</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    name,</span><br><span class="line">    dept_id,</span><br><span class="line">    salary,</span><br><span class="line">    <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(</span><br><span class="line">        <span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id</span><br><span class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>, name <span class="keyword">ASC</span></span><br><span class="line">    ) <span class="keyword">AS</span> row_num</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> dept_id, salary <span class="keyword">DESC</span>, name;</span><br></pre></td></tr></table></figure>

<h2 id="四、实战案例"><a href="#四、实战案例" class="headerlink" title="四、实战案例"></a>四、实战案例</h2><h3 id="4-1-Top-N-问题"><a href="#4-1-Top-N-问题" class="headerlink" title="4.1 Top N 问题"></a>4.1 Top N 问题</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 问题：获取每个部门工资最高的 2 名员工</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用 ROW_NUMBER（推荐）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        name,</span><br><span class="line">        dept_id,</span><br><span class="line">        salary,</span><br><span class="line">        <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>) <span class="keyword">AS</span> rn</span><br><span class="line">    <span class="keyword">FROM</span> employees</span><br><span class="line">) t</span><br><span class="line"><span class="keyword">WHERE</span> rn <span class="operator">&lt;=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果：</span></span><br><span class="line"><span class="comment">-- name   | dept_id | salary</span></span><br><span class="line"><span class="comment">-- -------+---------+--------</span></span><br><span class="line"><span class="comment">-- 张三    |    1    | 10000</span></span><br><span class="line"><span class="comment">-- 李四    |    1    | 10000</span></span><br><span class="line"><span class="comment">-- 孙七    |    2    | 12000</span></span><br><span class="line"><span class="comment">-- 周八    |    2    | 12000</span></span><br></pre></td></tr></table></figure>

<p><strong>ROW_NUMBER vs RANK vs DENSE_RANK 选择</strong>：</p>
<table>
<thead>
<tr>
<th>需求</th>
<th>选择</th>
<th>结果</th>
</tr>
</thead>
<tbody><tr>
<td>严格取前 N 条</td>
<td>ROW_NUMBER</td>
<td>正好 N 条</td>
</tr>
<tr>
<td>并列也要算前 N</td>
<td>RANK</td>
<td>可能超过 N 条</td>
</tr>
<tr>
<td>密集排名前 N</td>
<td>DENSE_RANK</td>
<td>可能超过 N 条</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 使用 RANK：可能返回超过 2 条（因为并列）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        name,</span><br><span class="line">        dept_id,</span><br><span class="line">        salary,</span><br><span class="line">        <span class="built_in">RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>) <span class="keyword">AS</span> rn</span><br><span class="line">    <span class="keyword">FROM</span> employees</span><br><span class="line">) t</span><br><span class="line"><span class="keyword">WHERE</span> rn <span class="operator">&lt;=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 部门 1：张三、李四（都是第 1 名），王五（第 3 名，过滤）</span></span><br><span class="line"><span class="comment">-- 部门 2：孙七、周八（都是第 1 名），吴九、郑十（都是第 3 名，过滤）</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-连续排名问题"><a href="#4-2-连续排名问题" class="headerlink" title="4.2 连续排名问题"></a>4.2 连续排名问题</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 问题：成绩排名，要求名次连续（不要跳过）</span></span><br><span class="line"><span class="comment">-- 答案：使用 DENSE_RANK</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    student_name,</span><br><span class="line">    score,</span><br><span class="line">    <span class="built_in">DENSE_RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> score <span class="keyword">DESC</span>) <span class="keyword">AS</span> rank</span><br><span class="line"><span class="keyword">FROM</span> scores;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-去重问题"><a href="#4-3-去重问题" class="headerlink" title="4.3 去重问题"></a>4.3 去重问题</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 问题：删除重复记录，保留每组 ID 最小的记录</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用 ROW_NUMBER 标识重复项</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> users</span><br><span class="line"><span class="keyword">WHERE</span> id <span class="keyword">IN</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> id <span class="keyword">FROM</span> (</span><br><span class="line">        <span class="keyword">SELECT</span></span><br><span class="line">            id,</span><br><span class="line">            <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> username <span class="keyword">ORDER</span> <span class="keyword">BY</span> id) <span class="keyword">AS</span> rn</span><br><span class="line">        <span class="keyword">FROM</span> users</span><br><span class="line">    ) t</span><br><span class="line">    <span class="keyword">WHERE</span> rn <span class="operator">&gt;</span> <span class="number">1</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="4-4-分组取最新记录"><a href="#4-4-分组取最新记录" class="headerlink" title="4.4 分组取最新记录"></a>4.4 分组取最新记录</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 问题：获取每个用户最新的订单</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        o.<span class="operator">*</span>,</span><br><span class="line">        <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> user_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date <span class="keyword">DESC</span>) <span class="keyword">AS</span> rn</span><br><span class="line">    <span class="keyword">FROM</span> orders o</span><br><span class="line">) t</span><br><span class="line"><span class="keyword">WHERE</span> rn <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h3 id="4-5-百分位排名"><a href="#4-5-百分位排名" class="headerlink" title="4.5 百分位排名"></a>4.5 百分位排名</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 问题：计算每个员工的工资百分位排名（超过百分之多少的人）</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    name,</span><br><span class="line">    salary,</span><br><span class="line">    ROUND(</span><br><span class="line">        (<span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> salary) <span class="operator">-</span> <span class="number">1</span>) <span class="operator">*</span> <span class="number">100.0</span> <span class="operator">/</span></span><br><span class="line">        (<span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">OVER</span>() <span class="operator">-</span> <span class="number">1</span>),</span><br><span class="line">        <span class="number">2</span></span><br><span class="line">    ) <span class="keyword">AS</span> percentile</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果：</span></span><br><span class="line"><span class="comment">-- name   | salary | percentile</span></span><br><span class="line"><span class="comment">-- -------+--------+------------</span></span><br><span class="line"><span class="comment">-- 孙七    | 12000  | 100.00</span></span><br><span class="line"><span class="comment">-- 周八    | 12000  | 87.50</span></span><br><span class="line"><span class="comment">-- 张三    | 10000  | 75.00</span></span><br><span class="line"><span class="comment">-- ...</span></span><br></pre></td></tr></table></figure>

<h2 id="五、排名函数的性能优化"><a href="#五、排名函数的性能优化" class="headerlink" title="五、排名函数的性能优化"></a>五、排名函数的性能优化</h2><h3 id="5-1-添加适当索引"><a href="#5-1-添加适当索引" class="headerlink" title="5.1 添加适当索引"></a>5.1 添加适当索引</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 为排名查询添加索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_dept_salary <span class="keyword">ON</span> employees(dept_id, salary <span class="keyword">DESC</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询将使用索引，提高性能</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    name,</span><br><span class="line">    dept_id,</span><br><span class="line">    salary,</span><br><span class="line">    <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>) <span class="keyword">AS</span> rn</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-避免不必要的全局排序"><a href="#5-2-避免不必要的全局排序" class="headerlink" title="5.2 避免不必要的全局排序"></a>5.2 避免不必要的全局排序</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 如果只需要分组内排名，一定要加 PARTITION BY</span></span><br><span class="line"><span class="comment">-- 错误：全局排序后再分区，性能差</span></span><br><span class="line"><span class="keyword">SELECT</span> name, <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary) <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 正确：直接分区排序</span></span><br><span class="line"><span class="keyword">SELECT</span> name, <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary) <span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-使用子查询过滤"><a href="#5-3-使用子查询过滤" class="headerlink" title="5.3 使用子查询过滤"></a>5.3 使用子查询过滤</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 错误：在 WHERE 中直接使用窗口函数结果</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(...) <span class="operator">&lt;=</span> <span class="number">5</span>;  <span class="comment">-- 语法错误</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 正确：使用子查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="operator">*</span>, <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(...) <span class="keyword">AS</span> rn <span class="keyword">FROM</span> employees</span><br><span class="line">) t <span class="keyword">WHERE</span> rn <span class="operator">&lt;=</span> <span class="number">5</span>;</span><br></pre></td></tr></table></figure>

<h2 id="六、排名函数对比总结"><a href="#六、排名函数对比总结" class="headerlink" title="六、排名函数对比总结"></a>六、排名函数对比总结</h2><h3 id="6-1-三种函数对比表"><a href="#6-1-三种函数对比表" class="headerlink" title="6.1 三种函数对比表"></a>6.1 三种函数对比表</h3><table>
<thead>
<tr>
<th>对比项</th>
<th>ROW_NUMBER</th>
<th>RANK</th>
<th>DENSE_RANK</th>
</tr>
</thead>
<tbody><tr>
<td>并列处理</td>
<td>不并列（强制区分）</td>
<td>并列同名</td>
<td>并列同名</td>
</tr>
<tr>
<td>排名跳跃</td>
<td>不跳跃</td>
<td>跳跃</td>
<td>不跳跃</td>
</tr>
<tr>
<td>排名序列</td>
<td>1,2,3,4,5</td>
<td>1,1,3,4,5</td>
<td>1,1,2,3,4</td>
</tr>
<tr>
<td>适用场景</td>
<td>Top N、去重</td>
<td>允许跳过的排名</td>
<td>连续排名</td>
</tr>
</tbody></table>
<h3 id="6-2-选择建议"><a href="#6-2-选择建议" class="headerlink" title="6.2 选择建议"></a>6.2 选择建议</h3><table>
<thead>
<tr>
<th>场景</th>
<th>推荐函数</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>严格 Top N</td>
<td>ROW_NUMBER</td>
<td>每部门取前 3 名</td>
</tr>
<tr>
<td>分组取最新</td>
<td>ROW_NUMBER</td>
<td>每用户最新订单</td>
</tr>
<tr>
<td>去重</td>
<td>ROW_NUMBER</td>
<td>删除重复记录</td>
</tr>
<tr>
<td>成绩&#x2F;比赛排名</td>
<td>DENSE_RANK</td>
<td>考试排名、比赛名次</td>
</tr>
<tr>
<td>允许跳过的排名</td>
<td>RANK</td>
<td>体育比赛（并列冠军，无亚军）</td>
</tr>
</tbody></table>
<h2 id="七、综合练习"><a href="#七、综合练习" class="headerlink" title="七、综合练习"></a>七、综合练习</h2><h3 id="练习-1：获取每个部门工资排名前-3-的员工"><a href="#练习-1：获取每个部门工资排名前-3-的员工" class="headerlink" title="练习 1：获取每个部门工资排名前 3 的员工"></a>练习 1：获取每个部门工资排名前 3 的员工</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        name,</span><br><span class="line">        dept_id,</span><br><span class="line">        salary,</span><br><span class="line">        <span class="built_in">DENSE_RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>) <span class="keyword">AS</span> rank</span><br><span class="line">    <span class="keyword">FROM</span> employees</span><br><span class="line">) t</span><br><span class="line"><span class="keyword">WHERE</span> rank <span class="operator">&lt;=</span> <span class="number">3</span>;</span><br></pre></td></tr></table></figure>

<h3 id="练习-2：找出工资排名不是第-1-名的所有员工"><a href="#练习-2：找出工资排名不是第-1-名的所有员工" class="headerlink" title="练习 2：找出工资排名不是第 1 名的所有员工"></a>练习 2：找出工资排名不是第 1 名的所有员工</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        name,</span><br><span class="line">        dept_id,</span><br><span class="line">        salary,</span><br><span class="line">        <span class="built_in">RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>) <span class="keyword">AS</span> rank</span><br><span class="line">    <span class="keyword">FROM</span> employees</span><br><span class="line">) t</span><br><span class="line"><span class="keyword">WHERE</span> rank <span class="operator">&gt;</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h3 id="练习-3：统计每个排名出现的次数"><a href="#练习-3：统计每个排名出现的次数" class="headerlink" title="练习 3：统计每个排名出现的次数"></a>练习 3：统计每个排名出现的次数</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> rank, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt <span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        dept_id,</span><br><span class="line">        <span class="built_in">DENSE_RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>) <span class="keyword">AS</span> rank</span><br><span class="line">    <span class="keyword">FROM</span> employees</span><br><span class="line">) t</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> rank</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> rank;</span><br></pre></td></tr></table></figure>

<h2 id="八、小结"><a href="#八、小结" class="headerlink" title="八、小结"></a>八、小结</h2><h3 id="核心知识点"><a href="#核心知识点" class="headerlink" title="核心知识点"></a>核心知识点</h3><ol>
<li><p><strong>ROW_NUMBER()</strong></p>
<ul>
<li>连续编号，不考虑并列</li>
<li>适用于 Top N、去重、分组取最新</li>
</ul>
</li>
<li><p><strong>RANK()</strong></p>
<ul>
<li>并列同名，后续排名跳过</li>
<li>适用于允许跳过的排名场景</li>
</ul>
</li>
<li><p><strong>DENSE_RANK()</strong></p>
<ul>
<li>并列同名，后续排名不跳过</li>
<li>适用于需要连续排名的场景</li>
</ul>
</li>
<li><p><strong>PARTITION BY</strong></p>
<ul>
<li>用于分组内排名</li>
<li>每个分区独立计算排名</li>
</ul>
</li>
<li><p><strong>ORDER BY</strong></p>
<ul>
<li>决定排名的排序方向</li>
<li>可以多列排序</li>
</ul>
</li>
</ol>
<h3 id="下一章预告"><a href="#下一章预告" class="headerlink" title="下一章预告"></a>下一章预告</h3><p>下一篇文章将介绍<strong>聚合窗口函数</strong>，包括：</p>
<ul>
<li>SUM&#x2F;AVG&#x2F;COUNT 窗口用法</li>
<li>累计求和</li>
<li>移动平均</li>
<li>占比计算</li>
</ul>
<hr>
<p><strong>下一篇</strong>：[MySQL 进阶教程 04-03 聚合窗口函数](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 04-03 聚合窗口函数&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 进阶教程 04-01 窗口函数概述](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 04-01 窗口函数概述&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 进阶教程</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>窗口函数</tag>
        <tag>ROW_NUMBER</tag>
        <tag>RANK</tag>
        <tag>DENSE_RANK</tag>
        <tag>排名</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 进阶教程 01-01 常用函数概述与字符串函数</title>
    <url>/2026/02/23/MySQL%20%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B%2001-01%20%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<h1 id="MySQL-进阶教程-01-01-常用函数概述与字符串函数"><a href="#MySQL-进阶教程-01-01-常用函数概述与字符串函数" class="headerlink" title="MySQL 进阶教程 01-01 常用函数概述与字符串函数"></a>MySQL 进阶教程 01-01 常用函数概述与字符串函数</h1><p>在基础教程中，我们学习了 SQL 的基本查询和操作。本文将系统讲解 MySQL 提供的常用内置函数，重点介绍字符串函数的使用方法。</p>
<h2 id="一、函数概述"><a href="#一、函数概述" class="headerlink" title="一、函数概述"></a>一、函数概述</h2><p>MySQL 函数是对数据进行特定操作的预定义程序，可以简化 SQL 语句，提高开发效率。</p>
<p><strong>函数的分类</strong>：</p>
<ul>
<li><strong>字符串函数</strong>：处理字符串数据</li>
<li><strong>数值函数</strong>：处理数值数据</li>
<li><strong>日期时间函数</strong>：处理日期和时间</li>
<li><strong>流程函数</strong>：条件判断和流程控制</li>
<li><strong>聚合函数</strong>：对一组数据进行计算（已在 DQL 章节讲解）</li>
<li><strong>加密函数</strong>：数据加密和哈希</li>
<li><strong>其他函数</strong>：信息函数、加锁函数等</li>
</ul>
<h2 id="二、字符串函数"><a href="#二、字符串函数" class="headerlink" title="二、字符串函数"></a>二、字符串函数</h2><h3 id="2-1-字符串连接与长度"><a href="#2-1-字符串连接与长度" class="headerlink" title="2.1 字符串连接与长度"></a>2.1 字符串连接与长度</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- CONCAT(s1, s2, ...)：连接字符串</span></span><br><span class="line"><span class="keyword">SELECT</span> CONCAT(<span class="string">&#x27;Hello&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;World&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- &#x27;Hello World&#x27;</span></span><br><span class="line"><span class="keyword">SELECT</span> CONCAT(<span class="string">&#x27;姓名：&#x27;</span>, name) <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- CONCAT_WS(separator, s1, s2, ...)：用分隔符连接</span></span><br><span class="line"><span class="keyword">SELECT</span> CONCAT_WS(<span class="string">&#x27;-&#x27;</span>, <span class="string">&#x27;2024&#x27;</span>, <span class="string">&#x27;02&#x27;</span>, <span class="string">&#x27;20&#x27;</span>) <span class="keyword">AS</span> <span class="type">date</span>;  <span class="comment">-- &#x27;2024-02-20&#x27;</span></span><br><span class="line"><span class="keyword">SELECT</span> CONCAT_WS(<span class="string">&#x27; &#x27;</span>, first_name, last_name) <span class="keyword">AS</span> full_name <span class="keyword">FROM</span> users;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- LENGTH(s)：返回字符串长度（字节）</span></span><br><span class="line"><span class="keyword">SELECT</span> LENGTH(<span class="string">&#x27;hello&#x27;</span>) <span class="keyword">AS</span> len;  <span class="comment">-- 5</span></span><br><span class="line"><span class="keyword">SELECT</span> LENGTH(<span class="string">&#x27;你好&#x27;</span>) <span class="keyword">AS</span> len;   <span class="comment">-- 6（UTF-8 中一个汉字 3 字节）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- CHAR_LENGTH(s)：返回字符数</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">CHAR_LENGTH</span>(<span class="string">&#x27;hello&#x27;</span>) <span class="keyword">AS</span> len;  <span class="comment">-- 5</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">CHAR_LENGTH</span>(<span class="string">&#x27;你好&#x27;</span>) <span class="keyword">AS</span> len;    <span class="comment">-- 2</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-大小写转换"><a href="#2-2-大小写转换" class="headerlink" title="2.2 大小写转换"></a>2.2 大小写转换</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- UPPER(s) 或 UCASE(s)：转大写</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">UPPER</span>(<span class="string">&#x27;hello&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- &#x27;HELLO&#x27;</span></span><br><span class="line"><span class="keyword">SELECT</span> name, <span class="built_in">UPPER</span>(name) <span class="keyword">AS</span> upper_name <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- LOWER(s) 或 LCASE(s)：转小写</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">LOWER</span>(<span class="string">&#x27;HELLO&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- &#x27;hello&#x27;</span></span><br><span class="line"><span class="keyword">SELECT</span> email, <span class="built_in">LOWER</span>(email) <span class="keyword">AS</span> lower_email <span class="keyword">FROM</span> users;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-字符串截取"><a href="#2-3-字符串截取" class="headerlink" title="2.3 字符串截取"></a>2.3 字符串截取</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- LEFT(s, n)：返回左边 n 个字符</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">LEFT</span>(<span class="string">&#x27;Hello World&#x27;</span>, <span class="number">5</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- &#x27;Hello&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- RIGHT(s, n)：返回右边 n 个字符</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">RIGHT</span>(<span class="string">&#x27;Hello World&#x27;</span>, <span class="number">5</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- &#x27;World&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- SUBSTRING(s, pos, len)：从位置 pos 开始截取 len 个字符</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">SUBSTRING</span>(<span class="string">&#x27;Hello World&#x27;</span>, <span class="number">1</span>, <span class="number">5</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- &#x27;Hello&#x27;</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">SUBSTRING</span>(<span class="string">&#x27;Hello World&#x27;</span>, <span class="number">7</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;     <span class="comment">-- &#x27;World&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- SUBSTRING(s, pos FROM len)：另一种语法</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">SUBSTRING</span>(<span class="string">&#x27;Hello World&#x27;</span> <span class="keyword">FROM</span> <span class="number">1</span> <span class="keyword">FOR</span> <span class="number">5</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- &#x27;Hello&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- MID(s, pos, len)：同 SUBSTRING</span></span><br><span class="line"><span class="keyword">SELECT</span> MID(<span class="string">&#x27;Hello World&#x27;</span>, <span class="number">7</span>, <span class="number">5</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- &#x27;World&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：MySQL 中字符串位置从 1 开始，不是从 0 开始！</p>
<h3 id="2-4-字符串查找与替换"><a href="#2-4-字符串查找与替换" class="headerlink" title="2.4 字符串查找与替换"></a>2.4 字符串查找与替换</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- INSTR(s, substr)：返回子串第一次出现的位置</span></span><br><span class="line"><span class="keyword">SELECT</span> INSTR(<span class="string">&#x27;Hello World&#x27;</span>, <span class="string">&#x27;o&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- 5</span></span><br><span class="line"><span class="keyword">SELECT</span> INSTR(<span class="string">&#x27;Hello World&#x27;</span>, <span class="string">&#x27;xyz&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- 0（未找到）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- LOCATE(substr, s)：同 INSTR</span></span><br><span class="line"><span class="keyword">SELECT</span> LOCATE(<span class="string">&#x27;World&#x27;</span>, <span class="string">&#x27;Hello World&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- 7</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- REPLACE(s, from_str, to_str)：替换字符串</span></span><br><span class="line"><span class="keyword">SELECT</span> REPLACE(<span class="string">&#x27;Hello World&#x27;</span>, <span class="string">&#x27;World&#x27;</span>, <span class="string">&#x27;MySQL&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- &#x27;Hello MySQL&#x27;</span></span><br><span class="line"><span class="keyword">UPDATE</span> products <span class="keyword">SET</span> description <span class="operator">=</span> REPLACE(description, <span class="string">&#x27;旧版&#x27;</span>, <span class="string">&#x27;新版&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- INSERT(str, pos, len, newstr)：在指定位置插入/替换字符串</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">INSERT</span>(<span class="string">&#x27;Hello World&#x27;</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="string">&#x27;MySQL&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- &#x27;Hello MySQL&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-5-去除空格"><a href="#2-5-去除空格" class="headerlink" title="2.5 去除空格"></a>2.5 去除空格</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- TRIM(s)：去除两端空格</span></span><br><span class="line"><span class="keyword">SELECT</span> CONCAT(<span class="string">&#x27;[&#x27;</span>, <span class="built_in">TRIM</span>(<span class="string">&#x27;  hello  &#x27;</span>), <span class="string">&#x27;]&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- &#x27;[hello]&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- LTRIM(s)：去除左边空格</span></span><br><span class="line"><span class="keyword">SELECT</span> CONCAT(<span class="string">&#x27;[&#x27;</span>, LTRIM(<span class="string">&#x27;  hello  &#x27;</span>), <span class="string">&#x27;]&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- &#x27;[hello  ]&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- RTRIM(s)：去除右边空格</span></span><br><span class="line"><span class="keyword">SELECT</span> CONCAT(<span class="string">&#x27;[&#x27;</span>, RTRIM(<span class="string">&#x27;  hello  &#x27;</span>), <span class="string">&#x27;]&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- &#x27;[  hello]&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 去除指定字符（MySQL 特有）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">TRIM</span>(<span class="keyword">BOTH</span> <span class="string">&#x27;x&#x27;</span> <span class="keyword">FROM</span> <span class="string">&#x27;xxxhelloxxx&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- &#x27;hello&#x27;</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">TRIM</span>(<span class="keyword">LEADING</span> <span class="string">&#x27;x&#x27;</span> <span class="keyword">FROM</span> <span class="string">&#x27;xxxhelloxxx&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- &#x27;helloxxx&#x27;</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">TRIM</span>(<span class="keyword">TRAILING</span> <span class="string">&#x27;x&#x27;</span> <span class="keyword">FROM</span> <span class="string">&#x27;xxxhelloxxx&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- &#x27;xxxhello&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-6-字符串填充"><a href="#2-6-字符串填充" class="headerlink" title="2.6 字符串填充"></a>2.6 字符串填充</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- LPAD(s, len, pad)：左填充</span></span><br><span class="line"><span class="keyword">SELECT</span> LPAD(<span class="string">&#x27;123&#x27;</span>, <span class="number">8</span>, <span class="string">&#x27;0&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- &#x27;00000123&#x27;</span></span><br><span class="line"><span class="keyword">SELECT</span> LPAD(<span class="string">&#x27;123&#x27;</span>, <span class="number">2</span>, <span class="string">&#x27;0&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- &#x27;12&#x27;（长度超过则截断）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- RPAD(s, len, pad)：右填充</span></span><br><span class="line"><span class="keyword">SELECT</span> RPAD(<span class="string">&#x27;123&#x27;</span>, <span class="number">8</span>, <span class="string">&#x27;0&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- &#x27;12300000&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- LPAD 实战：生成固定长度的编号</span></span><br><span class="line"><span class="keyword">SELECT</span> LPAD(id, <span class="number">6</span>, <span class="string">&#x27;0&#x27;</span>) <span class="keyword">AS</span> order_no <span class="keyword">FROM</span> orders;  <span class="comment">-- &#x27;000001&#x27;, &#x27;000002&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-7-字符串反转与重复"><a href="#2-7-字符串反转与重复" class="headerlink" title="2.7 字符串反转与重复"></a>2.7 字符串反转与重复</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- REVERSE(s)：反转字符串</span></span><br><span class="line"><span class="keyword">SELECT</span> REVERSE(<span class="string">&#x27;hello&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- &#x27;olleh&#x27;</span></span><br><span class="line"><span class="keyword">SELECT</span> REVERSE(phone) <span class="keyword">AS</span> reversed_phone <span class="keyword">FROM</span> users;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- REPEAT(s, n)：重复字符串 n 次</span></span><br><span class="line"><span class="keyword">SELECT</span> REPEAT(<span class="string">&#x27;*&#x27;</span>, <span class="number">5</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- &#x27;*****&#x27;</span></span><br><span class="line"><span class="keyword">SELECT</span> REPEAT(<span class="string">&#x27;-&#x27;</span>, <span class="number">20</span>) <span class="keyword">AS</span> separator;  <span class="comment">-- &#x27;--------------------&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-8-字符串比较"><a href="#2-8-字符串比较" class="headerlink" title="2.8 字符串比较"></a>2.8 字符串比较</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- STRCMP(s1, s2)：比较字符串</span></span><br><span class="line"><span class="keyword">SELECT</span> STRCMP(<span class="string">&#x27;abc&#x27;</span>, <span class="string">&#x27;abc&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- 0（相等）</span></span><br><span class="line"><span class="keyword">SELECT</span> STRCMP(<span class="string">&#x27;abc&#x27;</span>, <span class="string">&#x27;abd&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- -1（s1 &lt; s2）</span></span><br><span class="line"><span class="keyword">SELECT</span> STRCMP(<span class="string">&#x27;abd&#x27;</span>, <span class="string">&#x27;abc&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- 1（s1 &gt; s2）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- FIELD(s, s1, s2, ...)：返回 s 在列表中的位置</span></span><br><span class="line"><span class="keyword">SELECT</span> FIELD(<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;D&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- 2</span></span><br><span class="line"><span class="keyword">SELECT</span> FIELD(<span class="string">&#x27;X&#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- 0（未找到）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ELT(n, s1, s2, ...)：返回第 n 个位置的字符串</span></span><br><span class="line"><span class="keyword">SELECT</span> ELT(<span class="number">2</span>, <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;D&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- &#x27;B&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-9-其他常用函数"><a href="#2-9-其他常用函数" class="headerlink" title="2.9 其他常用函数"></a>2.9 其他常用函数</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- SPACE(n)：返回 n 个空格</span></span><br><span class="line"><span class="keyword">SELECT</span> CONCAT(<span class="string">&#x27;[&#x27;</span>, SPACE(<span class="number">5</span>), <span class="string">&#x27;]&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- &#x27;[     ]&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ASCII(s)：返回最左边字符的 ASCII 码</span></span><br><span class="line"><span class="keyword">SELECT</span> ASCII(<span class="string">&#x27;A&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- 65</span></span><br><span class="line"><span class="keyword">SELECT</span> ASCII(<span class="string">&#x27;你好&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- 228（多字节字符返回第一个字节）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- CHAR(n, n2, ...)：返回 ASCII 码对应的字符</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="type">CHAR</span>(<span class="number">65</span>, <span class="number">66</span>, <span class="number">67</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- &#x27;ABC&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- BIN(n)：十进制转二进制</span></span><br><span class="line"><span class="keyword">SELECT</span> BIN(<span class="number">10</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- &#x27;1010&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- HEX(n 或 s)：十进制转十六进制，或字符串转十六进制</span></span><br><span class="line"><span class="keyword">SELECT</span> HEX(<span class="number">255</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- &#x27;FF&#x27;</span></span><br><span class="line"><span class="keyword">SELECT</span> HEX(<span class="string">&#x27;abc&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- &#x27;616263&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- UNHEX(s)：十六进制转字符串</span></span><br><span class="line"><span class="keyword">SELECT</span> UNHEX(<span class="string">&#x27;616263&#x27;</span>) <span class="keyword">AS</span> <span class="keyword">result</span>;  <span class="comment">-- &#x27;abc&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="三、小结"><a href="#三、小结" class="headerlink" title="三、小结"></a>三、小结</h2><h3 id="核心知识点"><a href="#核心知识点" class="headerlink" title="核心知识点"></a>核心知识点</h3><ol>
<li><strong>字符串连接</strong>：CONCAT 连接多个字符串，CONCAT_WS 用分隔符连接</li>
<li><strong>字符串长度</strong>：LENGTH 返回字节数，CHAR_LENGTH 返回字符数</li>
<li><strong>大小写转换</strong>：UPPER&#x2F;LOWER 转换大小写</li>
<li><strong>字符串截取</strong>：LEFT&#x2F;RIGHT&#x2F;SUBSTRING 截取子串</li>
<li><strong>查找替换</strong>：INSTR&#x2F;LOCATE 查找位置，REPLACE 替换字符串</li>
</ol>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ol>
<li>MySQL 中字符串位置从 1 开始，不是从 0</li>
<li>LENGTH 和 CHAR_LENGTH 的区别（字节 vs 字符）</li>
<li>REPLACE 是大小写敏感的</li>
</ol>
<h3 id="下一章预告"><a href="#下一章预告" class="headerlink" title="下一章预告"></a>下一章预告</h3><p>下一篇文章将介绍<strong>数据库约束</strong>，包括：</p>
<ul>
<li>约束概述</li>
<li>主键约束、唯一约束、非空约束</li>
<li>默认约束、检查约束</li>
<li>外键约束</li>
</ul>
<hr>
<p><strong>下一篇</strong>：[MySQL 进阶教程 02-01 数据库约束详解](&#x2F;2026&#x2F;02&#x2F;23&#x2F;MySQL 进阶教程 02-01 数据库约束详解&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 基础教程（五）DCL 数据控制语言详解](&#x2F;2026&#x2F;02&#x2F;23&#x2F;MySQL 基础教程（五）DCL 数据控制语言详解&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 进阶教程</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>函数</tag>
        <tag>字符串函数</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 进阶教程 04-04 LEAD/LAG 前后行访问</title>
    <url>/2026/02/24/MySQL%20%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B%2004-04%20LEAD%20LAG%20%E5%89%8D%E5%90%8E%E8%A1%8C%E8%AE%BF%E9%97%AE/</url>
    <content><![CDATA[<h1 id="MySQL-进阶教程-04-04-LEAD-LAG-前后行访问"><a href="#MySQL-进阶教程-04-04-LEAD-LAG-前后行访问" class="headerlink" title="MySQL 进阶教程 04-04 LEAD&#x2F;LAG 前后行访问"></a>MySQL 进阶教程 04-04 LEAD&#x2F;LAG 前后行访问</h1><p>LEAD 和 LAG 函数允许在结果集中访问当前行之前或之后的行数据，无需自连接即可实现前后行对比。本文将详细讲解这两个函数的使用方法，包括同比、环比、差值分析等常见场景。</p>
<h2 id="一、LEAD-和-LAG-函数基础"><a href="#一、LEAD-和-LAG-函数基础" class="headerlink" title="一、LEAD 和 LAG 函数基础"></a>一、LEAD 和 LAG 函数基础</h2><h3 id="1-1-函数语法"><a href="#1-1-函数语法" class="headerlink" title="1.1 函数语法"></a>1.1 函数语法</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- LAG 函数：访问当前行之前第 n 行的数据</span></span><br><span class="line"><span class="built_in">LAG</span>(col, n, <span class="keyword">default</span>) <span class="keyword">OVER</span> (</span><br><span class="line">    [<span class="keyword">PARTITION</span> <span class="keyword">BY</span> 列名]</span><br><span class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span> 列名</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- LEAD 函数：访问当前行之后第 n 行的数据</span></span><br><span class="line"><span class="built_in">LEAD</span>(col, n, <span class="keyword">default</span>) <span class="keyword">OVER</span> (</span><br><span class="line">    [<span class="keyword">PARTITION</span> <span class="keyword">BY</span> 列名]</span><br><span class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span> 列名</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><strong>参数说明</strong>：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>默认值</th>
</tr>
</thead>
<tbody><tr>
<td>col</td>
<td>要访问的列</td>
<td>-</td>
</tr>
<tr>
<td>n</td>
<td>向前&#x2F;后偏移的行数</td>
<td>1</td>
</tr>
<tr>
<td>default</td>
<td>超出范围时的默认值</td>
<td>NULL</td>
</tr>
</tbody></table>
<h3 id="1-2-测试数据准备"><a href="#1-2-测试数据准备" class="headerlink" title="1.2 测试数据准备"></a>1.2 测试数据准备</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 准备月度销售数据</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> monthly_sales;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> monthly_sales (</span><br><span class="line">    <span class="keyword">month</span> <span class="type">DATE</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    sales <span class="type">DECIMAL</span>(<span class="number">12</span>, <span class="number">2</span>) <span class="keyword">NOT NULL</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> monthly_sales (<span class="keyword">month</span>, sales) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;2024-01-01&#x27;</span>, <span class="number">10000</span>),</span><br><span class="line">(<span class="string">&#x27;2024-02-01&#x27;</span>, <span class="number">12000</span>),</span><br><span class="line">(<span class="string">&#x27;2024-03-01&#x27;</span>, <span class="number">11000</span>),</span><br><span class="line">(<span class="string">&#x27;2024-04-01&#x27;</span>, <span class="number">15000</span>),</span><br><span class="line">(<span class="string">&#x27;2024-05-01&#x27;</span>, <span class="number">14000</span>),</span><br><span class="line">(<span class="string">&#x27;2024-06-01&#x27;</span>, <span class="number">18000</span>),</span><br><span class="line">(<span class="string">&#x27;2024-07-01&#x27;</span>, <span class="number">20000</span>),</span><br><span class="line">(<span class="string">&#x27;2024-08-01&#x27;</span>, <span class="number">19000</span>),</span><br><span class="line">(<span class="string">&#x27;2024-09-01&#x27;</span>, <span class="number">22000</span>),</span><br><span class="line">(<span class="string">&#x27;2024-10-01&#x27;</span>, <span class="number">21000</span>),</span><br><span class="line">(<span class="string">&#x27;2024-11-01&#x27;</span>, <span class="number">25000</span>),</span><br><span class="line">(<span class="string">&#x27;2024-12-01&#x27;</span>, <span class="number">28000</span>);</span><br></pre></td></tr></table></figure>

<h3 id="1-3-基础示例"><a href="#1-3-基础示例" class="headerlink" title="1.3 基础示例"></a>1.3 基础示例</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 访问前一行的数据（LAG）</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">month</span>,</span><br><span class="line">    sales,</span><br><span class="line">    <span class="built_in">LAG</span>(sales, <span class="number">1</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>) <span class="keyword">AS</span> prev_month_sales</span><br><span class="line"><span class="keyword">FROM</span> monthly_sales</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：</span></span><br><span class="line"><span class="comment">month      | sales  | prev_month_sales</span></span><br><span class="line"><span class="comment">-----------+--------+-----------------</span></span><br><span class="line"><span class="comment">2024-01-01 | 10000  | NULL            (第一行，无前驱)</span></span><br><span class="line"><span class="comment">2024-02-01 | 12000  | 10000</span></span><br><span class="line"><span class="comment">2024-03-01 | 11000  | 12000</span></span><br><span class="line"><span class="comment">2024-04-01 | 15000  | 11000</span></span><br><span class="line"><span class="comment">...</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 访问后一行的数据（LEAD）</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">month</span>,</span><br><span class="line">    sales,</span><br><span class="line">    <span class="built_in">LEAD</span>(sales, <span class="number">1</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>) <span class="keyword">AS</span> next_month_sales</span><br><span class="line"><span class="keyword">FROM</span> monthly_sales</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：</span></span><br><span class="line"><span class="comment">month      | sales  | next_month_sales</span></span><br><span class="line"><span class="comment">-----------+--------+-----------------</span></span><br><span class="line"><span class="comment">2024-01-01 | 10000  | 12000</span></span><br><span class="line"><span class="comment">2024-02-01 | 12000  | 11000</span></span><br><span class="line"><span class="comment">...</span></span><br><span class="line"><span class="comment">2024-12-01 | 28000  | NULL            (最后一行，无后继)</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="1-4-设置默认值"><a href="#1-4-设置默认值" class="headerlink" title="1.4 设置默认值"></a>1.4 设置默认值</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 当没有前驱/后继行时，使用默认值</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">month</span>,</span><br><span class="line">    sales,</span><br><span class="line">    <span class="built_in">LAG</span>(sales, <span class="number">1</span>, <span class="number">0</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>) <span class="keyword">AS</span> prev_sales,</span><br><span class="line">    <span class="built_in">LEAD</span>(sales, <span class="number">1</span>, <span class="number">0</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>) <span class="keyword">AS</span> next_sales</span><br><span class="line"><span class="keyword">FROM</span> monthly_sales</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 第一行的 prev_sales 为 0，最后一行的 next_sales 为 0</span></span><br></pre></td></tr></table></figure>

<h2 id="二、访问多行数据"><a href="#二、访问多行数据" class="headerlink" title="二、访问多行数据"></a>二、访问多行数据</h2><h3 id="2-1-访问前-后多行"><a href="#2-1-访问前-后多行" class="headerlink" title="2.1 访问前&#x2F;后多行"></a>2.1 访问前&#x2F;后多行</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 访问前 2 个月和后 2 个月的数据</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">month</span>,</span><br><span class="line">    sales,</span><br><span class="line">    <span class="built_in">LAG</span>(sales, <span class="number">1</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>) <span class="keyword">AS</span> prev_1m,</span><br><span class="line">    <span class="built_in">LAG</span>(sales, <span class="number">2</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>) <span class="keyword">AS</span> prev_2m,</span><br><span class="line">    <span class="built_in">LAG</span>(sales, <span class="number">3</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>) <span class="keyword">AS</span> prev_3m,</span><br><span class="line">    <span class="built_in">LEAD</span>(sales, <span class="number">1</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>) <span class="keyword">AS</span> next_1m,</span><br><span class="line">    <span class="built_in">LEAD</span>(sales, <span class="number">2</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>) <span class="keyword">AS</span> next_2m</span><br><span class="line"><span class="keyword">FROM</span> monthly_sales</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-自定义默认值"><a href="#2-2-自定义默认值" class="headerlink" title="2.2 自定义默认值"></a>2.2 自定义默认值</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 使用有意义的默认值</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">month</span>,</span><br><span class="line">    sales,</span><br><span class="line">    <span class="built_in">LAG</span>(sales, <span class="number">1</span>, <span class="string">&#x27;无数据&#x27;</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>) <span class="keyword">AS</span> prev_sales</span><br><span class="line"><span class="keyword">FROM</span> monthly_sales</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 注意：默认值类型应与列类型兼容</span></span><br></pre></td></tr></table></figure>

<h2 id="三、同比环比计算"><a href="#三、同比环比计算" class="headerlink" title="三、同比环比计算"></a>三、同比环比计算</h2><h3 id="3-1-环比增长率（MoM）"><a href="#3-1-环比增长率（MoM）" class="headerlink" title="3.1 环比增长率（MoM）"></a>3.1 环比增长率（MoM）</h3><p><strong>环比</strong>：与上一周期（如上月）相比的增长率。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 计算月度环比增长率</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">month</span>,</span><br><span class="line">    sales,</span><br><span class="line">    <span class="built_in">LAG</span>(sales, <span class="number">1</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>) <span class="keyword">AS</span> prev_month_sales,</span><br><span class="line">    sales <span class="operator">-</span> <span class="built_in">LAG</span>(sales, <span class="number">1</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>) <span class="keyword">AS</span> mom_change,</span><br><span class="line">    ROUND(</span><br><span class="line">        (sales <span class="operator">-</span> <span class="built_in">LAG</span>(sales, <span class="number">1</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>)) <span class="operator">*</span> <span class="number">100.0</span> <span class="operator">/</span></span><br><span class="line">        <span class="built_in">LAG</span>(sales, <span class="number">1</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>),</span><br><span class="line">        <span class="number">2</span></span><br><span class="line">    ) <span class="keyword">AS</span> mom_growth_rate</span><br><span class="line"><span class="keyword">FROM</span> monthly_sales</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：</span></span><br><span class="line"><span class="comment">month      | sales  | prev_month | mom_change | mom_growth_rate</span></span><br><span class="line"><span class="comment">-----------+--------+------------+------------+----------------</span></span><br><span class="line"><span class="comment">2024-01-01 | 10000  | NULL       | NULL       | NULL</span></span><br><span class="line"><span class="comment">2024-02-01 | 12000  | 10000      | 2000       | 20.00</span></span><br><span class="line"><span class="comment">2024-03-01 | 11000  | 12000      | -1000      | -8.33</span></span><br><span class="line"><span class="comment">2024-04-01 | 15000  | 11000      | 4000       | 36.36</span></span><br><span class="line"><span class="comment">...</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-同比增长率（YoY）"><a href="#3-2-同比增长率（YoY）" class="headerlink" title="3.2 同比增长率（YoY）"></a>3.2 同比增长率（YoY）</h3><p><strong>同比</strong>：与去年同期相比的增长率。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 假设有多年数据</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> yearly_monthly_sales;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> yearly_monthly_sales (</span><br><span class="line">    <span class="keyword">year</span> <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    <span class="keyword">month</span> <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    sales <span class="type">DECIMAL</span>(<span class="number">12</span>, <span class="number">2</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (<span class="keyword">year</span>, <span class="keyword">month</span>)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> yearly_monthly_sales (<span class="keyword">year</span>, <span class="keyword">month</span>, sales) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">2023</span>, <span class="number">1</span>, <span class="number">8000</span>), (<span class="number">2023</span>, <span class="number">2</span>, <span class="number">9000</span>), (<span class="number">2023</span>, <span class="number">3</span>, <span class="number">8500</span>),</span><br><span class="line">(<span class="number">2024</span>, <span class="number">1</span>, <span class="number">10000</span>), (<span class="number">2024</span>, <span class="number">2</span>, <span class="number">12000</span>), (<span class="number">2024</span>, <span class="number">3</span>, <span class="number">11000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 计算同比增长率（需要 12 个月的偏移）</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">year</span>,</span><br><span class="line">    <span class="keyword">month</span>,</span><br><span class="line">    sales,</span><br><span class="line">    <span class="built_in">LAG</span>(sales, <span class="number">12</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">year</span>, <span class="keyword">month</span>) <span class="keyword">AS</span> same_month_last_year,</span><br><span class="line">    ROUND(</span><br><span class="line">        (sales <span class="operator">-</span> <span class="built_in">LAG</span>(sales, <span class="number">12</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">year</span>, <span class="keyword">month</span>)) <span class="operator">*</span> <span class="number">100.0</span> <span class="operator">/</span></span><br><span class="line">        <span class="built_in">LAG</span>(sales, <span class="number">12</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">year</span>, <span class="keyword">month</span>),</span><br><span class="line">        <span class="number">2</span></span><br><span class="line">    ) <span class="keyword">AS</span> yoy_growth_rate</span><br><span class="line"><span class="keyword">FROM</span> yearly_monthly_sales</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">year</span>, <span class="keyword">month</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：</span></span><br><span class="line"><span class="comment">year | month | sales  | same_month_last_year | yoy_growth_rate</span></span><br><span class="line"><span class="comment">-----+-------+--------+---------------------+----------------</span></span><br><span class="line"><span class="comment">2023 | 1     | 8000   | NULL                | NULL</span></span><br><span class="line"><span class="comment">2023 | 2     | 9000   | NULL                | NULL</span></span><br><span class="line"><span class="comment">...</span></span><br><span class="line"><span class="comment">2024 | 1     | 10000  | 8000                | 25.00</span></span><br><span class="line"><span class="comment">2024 | 2     | 12000  | 9000                | 33.33</span></span><br><span class="line"><span class="comment">2024 | 3     | 11000  | 8500                | 17.65</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h2 id="四、差值分析"><a href="#四、差值分析" class="headerlink" title="四、差值分析"></a>四、差值分析</h2><h3 id="4-1-绝对差值"><a href="#4-1-绝对差值" class="headerlink" title="4.1 绝对差值"></a>4.1 绝对差值</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 计算与前一月的销售差额</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">month</span>,</span><br><span class="line">    sales,</span><br><span class="line">    sales <span class="operator">-</span> <span class="built_in">LAG</span>(sales, <span class="number">1</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>) <span class="keyword">AS</span> diff_from_prev</span><br><span class="line"><span class="keyword">FROM</span> monthly_sales</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-累计差值"><a href="#4-2-累计差值" class="headerlink" title="4.2 累计差值"></a>4.2 累计差值</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 计算与首月的累计差额</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">month</span>,</span><br><span class="line">    sales,</span><br><span class="line">    <span class="built_in">FIRST_VALUE</span>(sales) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>) <span class="keyword">AS</span> first_month_sales,</span><br><span class="line">    sales <span class="operator">-</span> <span class="built_in">FIRST_VALUE</span>(sales) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>) <span class="keyword">AS</span> diff_from_first</span><br><span class="line"><span class="keyword">FROM</span> monthly_sales</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-与平均值对比"><a href="#4-3-与平均值对比" class="headerlink" title="4.3 与平均值对比"></a>4.3 与平均值对比</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 计算与平均销售额的差值</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">month</span>,</span><br><span class="line">    sales,</span><br><span class="line">    <span class="built_in">AVG</span>(sales) <span class="keyword">OVER</span>() <span class="keyword">AS</span> avg_sales,</span><br><span class="line">    sales <span class="operator">-</span> <span class="built_in">AVG</span>(sales) <span class="keyword">OVER</span>() <span class="keyword">AS</span> diff_from_avg</span><br><span class="line"><span class="keyword">FROM</span> monthly_sales</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>;</span><br></pre></td></tr></table></figure>

<h2 id="五、分组内前后行访问"><a href="#五、分组内前后行访问" class="headerlink" title="五、分组内前后行访问"></a>五、分组内前后行访问</h2><h3 id="5-1-部门内员工工资对比"><a href="#5-1-部门内员工工资对比" class="headerlink" title="5.1 部门内员工工资对比"></a>5.1 部门内员工工资对比</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 准备数据</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> employees;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> employees (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    dept_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    salary <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">NOT NULL</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> employees (name, dept_id, salary) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;张三&#x27;</span>, <span class="number">1</span>, <span class="number">8000</span>),</span><br><span class="line">(<span class="string">&#x27;李四&#x27;</span>, <span class="number">1</span>, <span class="number">10000</span>),</span><br><span class="line">(<span class="string">&#x27;王五&#x27;</span>, <span class="number">1</span>, <span class="number">12000</span>),</span><br><span class="line">(<span class="string">&#x27;赵六&#x27;</span>, <span class="number">2</span>, <span class="number">7000</span>),</span><br><span class="line">(<span class="string">&#x27;孙七&#x27;</span>, <span class="number">2</span>, <span class="number">9000</span>),</span><br><span class="line">(<span class="string">&#x27;周八&#x27;</span>, <span class="number">2</span>, <span class="number">11000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 部门内与前一员工的工资对比</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    name,</span><br><span class="line">    dept_id,</span><br><span class="line">    salary,</span><br><span class="line">    <span class="built_in">LAG</span>(salary, <span class="number">1</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary) <span class="keyword">AS</span> prev_salary,</span><br><span class="line">    salary <span class="operator">-</span> <span class="built_in">LAG</span>(salary, <span class="number">1</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary) <span class="keyword">AS</span> salary_diff</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> dept_id, salary;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：</span></span><br><span class="line"><span class="comment">name | dept_id | salary | prev_salary | salary_diff</span></span><br><span class="line"><span class="comment">-----+---------+--------+-------------+------------</span></span><br><span class="line"><span class="comment">张三  |    1    | 8000   | NULL        | NULL</span></span><br><span class="line"><span class="comment">李四  |    1    | 10000  | 8000        | 2000</span></span><br><span class="line"><span class="comment">王五  |    1    | 12000  | 10000       | 2000</span></span><br><span class="line"><span class="comment">赵六  |    2    | 7000   | NULL        | NULL</span></span><br><span class="line"><span class="comment">孙七  |    2    | 9000   | 7000        | 2000</span></span><br><span class="line"><span class="comment">周八  |    2    | 11000  | 9000        | 2000</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-组内首尾值对比"><a href="#5-2-组内首尾值对比" class="headerlink" title="5.2 组内首尾值对比"></a>5.2 组内首尾值对比</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 与部门内最高/最低工资对比</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    name,</span><br><span class="line">    dept_id,</span><br><span class="line">    salary,</span><br><span class="line">    <span class="built_in">FIRST_VALUE</span>(salary) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary) <span class="keyword">AS</span> min_salary,</span><br><span class="line">    <span class="built_in">LAST_VALUE</span>(salary) <span class="keyword">OVER</span>(</span><br><span class="line">        <span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id</span><br><span class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary</span><br><span class="line">        <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> UNBOUNDED PRECEDING <span class="keyword">AND</span> UNBOUNDED FOLLOWING</span><br><span class="line">    ) <span class="keyword">AS</span> max_salary</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> dept_id, salary;</span><br></pre></td></tr></table></figure>

<h2 id="六、实战案例"><a href="#六、实战案例" class="headerlink" title="六、实战案例"></a>六、实战案例</h2><h3 id="6-1-连续增长分析"><a href="#6-1-连续增长分析" class="headerlink" title="6.1 连续增长分析"></a>6.1 连续增长分析</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 问题：找出销售额连续增长的月份</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WITH</span> sales_with_prev <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        <span class="keyword">month</span>,</span><br><span class="line">        sales,</span><br><span class="line">        <span class="built_in">LAG</span>(sales, <span class="number">1</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>) <span class="keyword">AS</span> prev_sales,</span><br><span class="line">        <span class="built_in">LAG</span>(sales, <span class="number">2</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>) <span class="keyword">AS</span> prev_prev_sales</span><br><span class="line">    <span class="keyword">FROM</span> monthly_sales</span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">month</span>,</span><br><span class="line">    sales,</span><br><span class="line">    prev_sales,</span><br><span class="line">    prev_prev_sales</span><br><span class="line"><span class="keyword">FROM</span> sales_with_prev</span><br><span class="line"><span class="keyword">WHERE</span> sales <span class="operator">&gt;</span> prev_sales</span><br><span class="line">  <span class="keyword">AND</span> prev_sales <span class="operator">&gt;</span> prev_prev_sales</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-销售趋势判断"><a href="#6-2-销售趋势判断" class="headerlink" title="6.2 销售趋势判断"></a>6.2 销售趋势判断</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 问题：判断每个销售月的趋势（上升/下降/持平）</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">month</span>,</span><br><span class="line">    sales,</span><br><span class="line">    <span class="built_in">LAG</span>(sales, <span class="number">1</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>) <span class="keyword">AS</span> prev_sales,</span><br><span class="line">    <span class="keyword">CASE</span></span><br><span class="line">        <span class="keyword">WHEN</span> sales <span class="operator">&gt;</span> <span class="built_in">LAG</span>(sales, <span class="number">1</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>) <span class="keyword">THEN</span> <span class="string">&#x27;上升&#x27;</span></span><br><span class="line">        <span class="keyword">WHEN</span> sales <span class="operator">&lt;</span> <span class="built_in">LAG</span>(sales, <span class="number">1</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>) <span class="keyword">THEN</span> <span class="string">&#x27;下降&#x27;</span></span><br><span class="line">        <span class="keyword">ELSE</span> <span class="string">&#x27;持平&#x27;</span></span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">AS</span> trend</span><br><span class="line"><span class="keyword">FROM</span> monthly_sales</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-间隔时间分析"><a href="#6-3-间隔时间分析" class="headerlink" title="6.3 间隔时间分析"></a>6.3 间隔时间分析</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 准备订单数据</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> orders;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    user_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    order_date <span class="type">DATE</span> <span class="keyword">NOT NULL</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (user_id, order_date) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">1</span>, <span class="string">&#x27;2024-01-01&#x27;</span>), (<span class="number">1</span>, <span class="string">&#x27;2024-01-05&#x27;</span>), (<span class="number">1</span>, <span class="string">&#x27;2024-01-12&#x27;</span>),</span><br><span class="line">(<span class="number">2</span>, <span class="string">&#x27;2024-01-03&#x27;</span>), (<span class="number">2</span>, <span class="string">&#x27;2024-01-08&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 问题：计算用户每次订单与上次的间隔天数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    id,</span><br><span class="line">    user_id,</span><br><span class="line">    order_date,</span><br><span class="line">    <span class="built_in">LAG</span>(order_date, <span class="number">1</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> user_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date) <span class="keyword">AS</span> prev_order_date,</span><br><span class="line">    DATEDIFF(</span><br><span class="line">        order_date,</span><br><span class="line">        <span class="built_in">LAG</span>(order_date, <span class="number">1</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> user_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date)</span><br><span class="line">    ) <span class="keyword">AS</span> days_since_last_order</span><br><span class="line"><span class="keyword">FROM</span> orders</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> user_id, order_date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：</span></span><br><span class="line"><span class="comment">id | user_id | order_date | prev_order_date | days_since_last_order</span></span><br><span class="line"><span class="comment">---+---------+------------+-----------------+---------------------</span></span><br><span class="line"><span class="comment">1  |    1    | 2024-01-01 | NULL            | NULL</span></span><br><span class="line"><span class="comment">1  |    1    | 2024-01-05 | 2024-01-01      | 4</span></span><br><span class="line"><span class="comment">1  |    1    | 2024-01-12 | 2024-01-05      | 7</span></span><br><span class="line"><span class="comment">2  |    2    | 2024-01-03 | NULL            | NULL</span></span><br><span class="line"><span class="comment">2  |    2    | 2024-01-08 | 2024-01-03      | 5</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="6-4-首次-末次购买分析"><a href="#6-4-首次-末次购买分析" class="headerlink" title="6.4 首次&#x2F;末次购买分析"></a>6.4 首次&#x2F;末次购买分析</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 问题：标记用户的首次和末次购买</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    id,</span><br><span class="line">    user_id,</span><br><span class="line">    order_date,</span><br><span class="line">    <span class="keyword">CASE</span></span><br><span class="line">        <span class="keyword">WHEN</span> order_date <span class="operator">=</span> <span class="built_in">FIRST_VALUE</span>(order_date) <span class="keyword">OVER</span>(</span><br><span class="line">            <span class="keyword">PARTITION</span> <span class="keyword">BY</span> user_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date</span><br><span class="line">        ) <span class="keyword">THEN</span> <span class="string">&#x27;首次购买&#x27;</span></span><br><span class="line">        <span class="keyword">WHEN</span> order_date <span class="operator">=</span> <span class="built_in">LAST_VALUE</span>(order_date) <span class="keyword">OVER</span>(</span><br><span class="line">            <span class="keyword">PARTITION</span> <span class="keyword">BY</span> user_id</span><br><span class="line">            <span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date</span><br><span class="line">            <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> UNBOUNDED PRECEDING <span class="keyword">AND</span> UNBOUNDED FOLLOWING</span><br><span class="line">        ) <span class="keyword">THEN</span> <span class="string">&#x27;末次购买&#x27;</span></span><br><span class="line">        <span class="keyword">ELSE</span> <span class="string">&#x27;常规购买&#x27;</span></span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">AS</span> order_type</span><br><span class="line"><span class="keyword">FROM</span> orders</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> user_id, order_date;</span><br></pre></td></tr></table></figure>

<h3 id="6-5-留存分析基础"><a href="#6-5-留存分析基础" class="headerlink" title="6.5 留存分析基础"></a>6.5 留存分析基础</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 问题：计算用户下次购买时间</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    user_id,</span><br><span class="line">    order_date,</span><br><span class="line">    <span class="built_in">LEAD</span>(order_date, <span class="number">1</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> user_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date) <span class="keyword">AS</span> next_order_date,</span><br><span class="line">    <span class="keyword">CASE</span></span><br><span class="line">        <span class="keyword">WHEN</span> <span class="built_in">LEAD</span>(order_date, <span class="number">1</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> user_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date) <span class="keyword">IS</span> <span class="keyword">NOT NULL</span></span><br><span class="line">        <span class="keyword">THEN</span> <span class="string">&#x27;留存&#x27;</span></span><br><span class="line">        <span class="keyword">ELSE</span> <span class="string">&#x27;流失&#x27;</span></span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">AS</span> retention_status</span><br><span class="line"><span class="keyword">FROM</span> orders</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> user_id, order_date;</span><br></pre></td></tr></table></figure>

<h2 id="七、性能优化建议"><a href="#七、性能优化建议" class="headerlink" title="七、性能优化建议"></a>七、性能优化建议</h2><h3 id="7-1-避免重复的窗口计算"><a href="#7-1-避免重复的窗口计算" class="headerlink" title="7.1 避免重复的窗口计算"></a>7.1 避免重复的窗口计算</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 不好：重复计算 LAG</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">month</span>,</span><br><span class="line">    sales,</span><br><span class="line">    sales <span class="operator">-</span> <span class="built_in">LAG</span>(sales, <span class="number">1</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>) <span class="keyword">AS</span> diff,</span><br><span class="line">    ROUND((sales <span class="operator">-</span> <span class="built_in">LAG</span>(sales, <span class="number">1</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>)) <span class="operator">*</span> <span class="number">100.0</span> <span class="operator">/</span></span><br><span class="line">          <span class="built_in">LAG</span>(sales, <span class="number">1</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>), <span class="number">2</span>) <span class="keyword">AS</span> growth_rate</span><br><span class="line"><span class="keyword">FROM</span> monthly_sales;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 好：使用 CTE</span></span><br><span class="line"><span class="keyword">WITH</span> sales_lag <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        <span class="keyword">month</span>,</span><br><span class="line">        sales,</span><br><span class="line">        <span class="built_in">LAG</span>(sales, <span class="number">1</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>) <span class="keyword">AS</span> prev_sales</span><br><span class="line">    <span class="keyword">FROM</span> monthly_sales</span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">month</span>,</span><br><span class="line">    sales,</span><br><span class="line">    sales <span class="operator">-</span> prev_sales <span class="keyword">AS</span> diff,</span><br><span class="line">    ROUND((sales <span class="operator">-</span> prev_sales) <span class="operator">*</span> <span class="number">100.0</span> <span class="operator">/</span> prev_sales, <span class="number">2</span>) <span class="keyword">AS</span> growth_rate</span><br><span class="line"><span class="keyword">FROM</span> sales_lag;</span><br></pre></td></tr></table></figure>

<h3 id="7-2-添加适当索引"><a href="#7-2-添加适当索引" class="headerlink" title="7.2 添加适当索引"></a>7.2 添加适当索引</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 为 PARTITION BY 和 ORDER BY 列添加索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_user_order_date <span class="keyword">ON</span> orders(user_id, order_date);</span><br></pre></td></tr></table></figure>

<h2 id="八、小结"><a href="#八、小结" class="headerlink" title="八、小结"></a>八、小结</h2><h3 id="核心知识点"><a href="#核心知识点" class="headerlink" title="核心知识点"></a>核心知识点</h3><ol>
<li><p><strong>LAG 函数</strong></p>
<ul>
<li>访问当前行之前第 n 行的数据</li>
<li>常用于环比、同比计算</li>
</ul>
</li>
<li><p><strong>LEAD 函数</strong></p>
<ul>
<li>访问当前行之后第 n 行的数据</li>
<li>常用于预测、后续状态分析</li>
</ul>
</li>
<li><p><strong>语法</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="built_in">LAG</span>(col, n, <span class="keyword">default</span>) <span class="keyword">OVER</span>([<span class="keyword">PARTITION</span> <span class="keyword">BY</span>] <span class="keyword">ORDER</span> <span class="keyword">BY</span>)</span><br><span class="line"><span class="built_in">LEAD</span>(col, n, <span class="keyword">default</span>) <span class="keyword">OVER</span>([<span class="keyword">PARTITION</span> <span class="keyword">BY</span>] <span class="keyword">ORDER</span> <span class="keyword">BY</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>典型应用</strong></p>
<ul>
<li>环比增长率：<code>(本期 - 上期) / 上期</code></li>
<li>同比增长率：<code>(本期 - 同期) / 同期</code></li>
<li>差值分析：<code>本期 - 上期</code></li>
<li>趋势判断：<code>CASE WHEN 本期 &gt; 上期 THEN &#39;上升&#39;</code></li>
</ul>
</li>
</ol>
<h3 id="下一章预告"><a href="#下一章预告" class="headerlink" title="下一章预告"></a>下一章预告</h3><p>下一篇文章将详细讲解<strong>窗口框架</strong>，包括：</p>
<ul>
<li>ROWS vs RANGE 的区别</li>
<li>窗口边界详解</li>
<li>累计、移动窗口的高级用法</li>
</ul>
<hr>
<p><strong>下一篇</strong>：[MySQL 进阶教程 04-05 窗口框架详解](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 04-05 窗口框架详解&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 进阶教程 04-03 聚合窗口函数](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 04-03 聚合窗口函数&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 进阶教程</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>窗口函数</tag>
        <tag>LEAD</tag>
        <tag>LAG</tag>
        <tag>同比</tag>
        <tag>环比</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 进阶教程 04-05 窗口框架详解</title>
    <url>/2026/02/24/MySQL%20%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B%2004-05%20%E7%AA%97%E5%8F%A3%E6%A1%86%E6%9E%B6%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<h1 id="MySQL-进阶教程-04-05-窗口框架详解"><a href="#MySQL-进阶教程-04-05-窗口框架详解" class="headerlink" title="MySQL 进阶教程 04-05 窗口框架详解"></a>MySQL 进阶教程 04-05 窗口框架详解</h1><p>窗口框架（Window Frame）用于精确定义窗口函数操作的数据范围。本文将详细讲解 ROWS 和 RANGE 的区别，以及各种窗口边界的使用方法。</p>
<h2 id="一、窗口框架概述"><a href="#一、窗口框架概述" class="headerlink" title="一、窗口框架概述"></a>一、窗口框架概述</h2><h3 id="1-1-什么是窗口框架？"><a href="#1-1-什么是窗口框架？" class="headerlink" title="1.1 什么是窗口框架？"></a>1.1 什么是窗口框架？</h3><p><strong>窗口框架</strong> 是窗口函数中用于定义”窗口”具体范围的部分，决定了哪些行参与计算。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">OVER (</span><br><span class="line">    [PARTITION BY 列名]     -- 分区：将数据分成多个组</span><br><span class="line">    [ORDER BY 列名]          -- 排序：窗口内数据的排序</span><br><span class="line">    [ROWS/RANGE BETWEEN ...] -- 窗口框架：精确定义窗口范围</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="1-2-默认窗口框架"><a href="#1-2-默认窗口框架" class="headerlink" title="1.2 默认窗口框架"></a>1.2 默认窗口框架</h3><p><strong>关键规则</strong>：</p>
<ul>
<li>有 <code>ORDER BY</code> 无框架子句：默认 <code>RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW</code></li>
<li>无 <code>ORDER BY</code>：使用整个分区</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 准备测试数据</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> sales;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> sales (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    sale_date <span class="type">DATE</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    amount <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">NOT NULL</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> sales (sale_date, amount) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;2024-01-01&#x27;</span>, <span class="number">100</span>),</span><br><span class="line">(<span class="string">&#x27;2024-01-02&#x27;</span>, <span class="number">100</span>),  <span class="comment">-- 与上一行 amount 相同</span></span><br><span class="line">(<span class="string">&#x27;2024-01-03&#x27;</span>, <span class="number">200</span>),</span><br><span class="line">(<span class="string">&#x27;2024-01-04&#x27;</span>, <span class="number">200</span>),  <span class="comment">-- 与上一行 amount 相同</span></span><br><span class="line">(<span class="string">&#x27;2024-01-05&#x27;</span>, <span class="number">300</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 默认窗口框架（隐式）</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    sale_date,</span><br><span class="line">    amount,</span><br><span class="line">    <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> amount) <span class="keyword">AS</span> default_sum</span><br><span class="line"><span class="keyword">FROM</span> sales;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 等价于（显式指定）</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    sale_date,</span><br><span class="line">    amount,</span><br><span class="line">    <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(</span><br><span class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> amount</span><br><span class="line">        <span class="keyword">RANGE</span> <span class="keyword">BETWEEN</span> UNBOUNDED PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span></span><br><span class="line">    ) <span class="keyword">AS</span> range_sum</span><br><span class="line"><span class="keyword">FROM</span> sales;</span><br></pre></td></tr></table></figure>

<h2 id="二、ROWS-vs-RANGE-的区别"><a href="#二、ROWS-vs-RANGE-的区别" class="headerlink" title="二、ROWS vs RANGE 的区别"></a>二、ROWS vs RANGE 的区别</h2><h3 id="2-1-ROWS-基于行范围"><a href="#2-1-ROWS-基于行范围" class="headerlink" title="2.1 ROWS - 基于行范围"></a>2.1 ROWS - 基于行范围</h3><p><strong>ROWS</strong> 基于物理行位置定义窗口。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- ROWS BETWEEN 2 PRECEDING AND CURRENT ROW</span></span><br><span class="line"><span class="comment">-- 含义：当前行 + 前 2 行（固定 3 行）</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    sale_date,</span><br><span class="line">    amount,</span><br><span class="line">    <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(</span><br><span class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> sale_date</span><br><span class="line">        <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">2</span> PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span></span><br><span class="line">    ) <span class="keyword">AS</span> rows_3day_sum</span><br><span class="line"><span class="keyword">FROM</span> sales</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> sale_date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：</span></span><br><span class="line"><span class="comment">sale_date  | amount | rows_3day_sum</span></span><br><span class="line"><span class="comment">-----------+--------+--------------</span></span><br><span class="line"><span class="comment">2024-01-01 | 100    | 100          (只有第 1 行)</span></span><br><span class="line"><span class="comment">2024-01-02 | 100    | 200          (第 1-2 行)</span></span><br><span class="line"><span class="comment">2024-01-03 | 200    | 400          (第 1-3 行)</span></span><br><span class="line"><span class="comment">2024-01-04 | 200    | 500          (第 2-4 行)</span></span><br><span class="line"><span class="comment">2024-01-05 | 300    | 700          (第 3-5 行)</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-RANGE-基于值范围"><a href="#2-2-RANGE-基于值范围" class="headerlink" title="2.2 RANGE - 基于值范围"></a>2.2 RANGE - 基于值范围</h3><p><strong>RANGE</strong> 基于逻辑值（ORDER BY 列的值）定义窗口。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- RANGE BETWEEN 100 PRECEDING AND CURRENT ROW</span></span><br><span class="line"><span class="comment">-- 含义：当前行值 - 100 到 当前行值 范围内的所有行</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    sale_date,</span><br><span class="line">    amount,</span><br><span class="line">    <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(</span><br><span class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> amount</span><br><span class="line">        <span class="keyword">RANGE</span> <span class="keyword">BETWEEN</span> <span class="number">100</span> PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span></span><br><span class="line">    ) <span class="keyword">AS</span> range_sum</span><br><span class="line"><span class="keyword">FROM</span> sales</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> amount;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：</span></span><br><span class="line"><span class="comment">sale_date  | amount | range_sum</span></span><br><span class="line"><span class="comment">-----------+--------+----------</span></span><br><span class="line"><span class="comment">2024-01-01 | 100    | 200      (amount=100 的所有行：100+100)</span></span><br><span class="line"><span class="comment">2024-01-02 | 100    | 200      (同上，因为 amount 相同)</span></span><br><span class="line"><span class="comment">2024-01-03 | 200    | 500      (amount 在 100-200 范围内的行：100+100+200+200)</span></span><br><span class="line"><span class="comment">2024-01-04 | 200    | 500      (同上)</span></span><br><span class="line"><span class="comment">2024-01-05 | 300    | 700      (amount 在 200-300 范围内的行：200+200+300)</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-ROWS-vs-RANGE-对比总结"><a href="#2-3-ROWS-vs-RANGE-对比总结" class="headerlink" title="2.3 ROWS vs RANGE 对比总结"></a>2.3 ROWS vs RANGE 对比总结</h3><table>
<thead>
<tr>
<th>对比项</th>
<th>ROWS</th>
<th>RANGE</th>
</tr>
</thead>
<tbody><tr>
<td>定义方式</td>
<td>物理行位置</td>
<td>逻辑值范围</td>
</tr>
<tr>
<td>相同值处理</td>
<td>每行独立计算</td>
<td>相同值视为一组</td>
</tr>
<tr>
<td>性能</td>
<td>通常更快</td>
<td>可能需要额外排序</td>
</tr>
<tr>
<td>适用场景</td>
<td>移动平均、累计</td>
<td>值范围分析</td>
</tr>
<tr>
<td>MySQL 默认</td>
<td>-</td>
<td>RANGE（有 ORDER BY 时）</td>
</tr>
</tbody></table>
<h3 id="2-4-实例对比"><a href="#2-4-实例对比" class="headerlink" title="2.4 实例对比"></a>2.4 实例对比</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 对比 ROWS 和 RANGE 在相同值时的差异</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    sale_date,</span><br><span class="line">    amount,</span><br><span class="line">    <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(</span><br><span class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> amount</span><br><span class="line">        <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> UNBOUNDED PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span></span><br><span class="line">    ) <span class="keyword">AS</span> rows_sum,</span><br><span class="line">    <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(</span><br><span class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> amount</span><br><span class="line">        <span class="keyword">RANGE</span> <span class="keyword">BETWEEN</span> UNBOUNDED PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span></span><br><span class="line">    ) <span class="keyword">AS</span> range_sum</span><br><span class="line"><span class="keyword">FROM</span> sales</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> amount;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：</span></span><br><span class="line"><span class="comment">sale_date  | amount | rows_sum | range_sum</span></span><br><span class="line"><span class="comment">-----------+--------+----------+----------</span></span><br><span class="line"><span class="comment">2024-01-01 | 100    | 100      | 200      ← 差异！</span></span><br><span class="line"><span class="comment">2024-01-02 | 100    | 200      | 200</span></span><br><span class="line"><span class="comment">2024-01-03 | 200    | 400      | 600      ← 差异！</span></span><br><span class="line"><span class="comment">2024-01-04 | 200    | 600      | 600</span></span><br><span class="line"><span class="comment">2024-01-05 | 300    | 900      | 900</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>解释</strong>：</p>
<ul>
<li>ROWS：严格按物理行累加</li>
<li>RANGE：相同值的行视为一个逻辑组，同时加入窗口</li>
</ul>
<h2 id="三、窗口边界详解"><a href="#三、窗口边界详解" class="headerlink" title="三、窗口边界详解"></a>三、窗口边界详解</h2><h3 id="3-1-边界关键字"><a href="#3-1-边界关键字" class="headerlink" title="3.1 边界关键字"></a>3.1 边界关键字</h3><table>
<thead>
<tr>
<th>关键字</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>UNBOUNDED PRECEDING</td>
<td>分区的第一行</td>
</tr>
<tr>
<td>UNBOUNDED FOLLOWING</td>
<td>分区的最后一行</td>
</tr>
<tr>
<td>CURRENT ROW</td>
<td>当前行</td>
</tr>
<tr>
<td>n PRECEDING</td>
<td>当前行之前的第 n 行</td>
</tr>
<tr>
<td>n FOLLOWING</td>
<td>当前行之后的第 n 行</td>
</tr>
</tbody></table>
<h3 id="3-2-常见窗口配置"><a href="#3-2-常见窗口配置" class="headerlink" title="3.2 常见窗口配置"></a>3.2 常见窗口配置</h3><h4 id="（1）从起点到当前行（累计）"><a href="#（1）从起点到当前行（累计）" class="headerlink" title="（1）从起点到当前行（累计）"></a>（1）从起点到当前行（累计）</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 累计求和</span></span><br><span class="line"><span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(</span><br><span class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span> sale_date</span><br><span class="line">    <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> UNBOUNDED PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h4 id="（2）从当前行到终点"><a href="#（2）从当前行到终点" class="headerlink" title="（2）从当前行到终点"></a>（2）从当前行到终点</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 从当前行到最后的总和</span></span><br><span class="line"><span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(</span><br><span class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span> sale_date</span><br><span class="line">    <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span> <span class="keyword">AND</span> UNBOUNDED FOLLOWING</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h4 id="（3）移动窗口（滑动窗口）"><a href="#（3）移动窗口（滑动窗口）" class="headerlink" title="（3）移动窗口（滑动窗口）"></a>（3）移动窗口（滑动窗口）</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 前 2 行 + 当前行（3 行移动窗口）</span></span><br><span class="line"><span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(</span><br><span class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span> sale_date</span><br><span class="line">    <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">2</span> PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 前 1 行 + 当前行 + 后 1 行（3 行居中窗口）</span></span><br><span class="line"><span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(</span><br><span class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span> sale_date</span><br><span class="line">    <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">1</span> PRECEDING <span class="keyword">AND</span> <span class="number">1</span> FOLLOWING</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h4 id="（4）整个分区"><a href="#（4）整个分区" class="headerlink" title="（4）整个分区"></a>（4）整个分区</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 整个分区的总和（等价于无 ORDER BY）</span></span><br><span class="line"><span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(</span><br><span class="line">    <span class="keyword">PARTITION</span> <span class="keyword">BY</span> category</span><br><span class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span> sale_date</span><br><span class="line">    <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> UNBOUNDED PRECEDING <span class="keyword">AND</span> UNBOUNDED FOLLOWING</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="四、窗口框架实战"><a href="#四、窗口框架实战" class="headerlink" title="四、窗口框架实战"></a>四、窗口框架实战</h2><h3 id="4-1-移动平均"><a href="#4-1-移动平均" class="headerlink" title="4.1 移动平均"></a>4.1 移动平均</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 3 日移动平均（当前行 + 前 2 行）</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    sale_date,</span><br><span class="line">    amount,</span><br><span class="line">    <span class="built_in">AVG</span>(amount) <span class="keyword">OVER</span>(</span><br><span class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> sale_date</span><br><span class="line">        <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">2</span> PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span></span><br><span class="line">    ) <span class="keyword">AS</span> moving_avg_3d</span><br><span class="line"><span class="keyword">FROM</span> sales</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> sale_date;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-累计百分比"><a href="#4-2-累计百分比" class="headerlink" title="4.2 累计百分比"></a>4.2 累计百分比</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 计算累计百分比</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    sale_date,</span><br><span class="line">    amount,</span><br><span class="line">    <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> sale_date) <span class="keyword">AS</span> running_total,</span><br><span class="line">    <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>() <span class="keyword">AS</span> grand_total,</span><br><span class="line">    ROUND(</span><br><span class="line">        <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(</span><br><span class="line">            <span class="keyword">ORDER</span> <span class="keyword">BY</span> sale_date</span><br><span class="line">            <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> UNBOUNDED PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span></span><br><span class="line">        ) <span class="operator">*</span> <span class="number">100.0</span> <span class="operator">/</span> <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(),</span><br><span class="line">        <span class="number">2</span></span><br><span class="line">    ) <span class="keyword">AS</span> running_pct</span><br><span class="line"><span class="keyword">FROM</span> sales</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> sale_date;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-首尾值获取"><a href="#4-3-首尾值获取" class="headerlink" title="4.3 首尾值获取"></a>4.3 首尾值获取</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 获取每行的首值和尾值</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    sale_date,</span><br><span class="line">    amount,</span><br><span class="line">    <span class="built_in">FIRST_VALUE</span>(amount) <span class="keyword">OVER</span>(</span><br><span class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> sale_date</span><br><span class="line">        <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> UNBOUNDED PRECEDING <span class="keyword">AND</span> UNBOUNDED FOLLOWING</span><br><span class="line">    ) <span class="keyword">AS</span> first_amount,</span><br><span class="line">    <span class="built_in">LAST_VALUE</span>(amount) <span class="keyword">OVER</span>(</span><br><span class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> sale_date</span><br><span class="line">        <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> UNBOUNDED PRECEDING <span class="keyword">AND</span> UNBOUNDED FOLLOWING</span><br><span class="line">    ) <span class="keyword">AS</span> last_amount</span><br><span class="line"><span class="keyword">FROM</span> sales</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> sale_date;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：<code>LAST_VALUE</code> 必须显式指定 <code>UNBOUNDED FOLLOWING</code>，否则只计算到当前行。</p>
<h3 id="4-4-居中移动窗口"><a href="#4-4-居中移动窗口" class="headerlink" title="4.4 居中移动窗口"></a>4.4 居中移动窗口</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 计算居中移动平均（前后各 1 行）</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    sale_date,</span><br><span class="line">    amount,</span><br><span class="line">    <span class="built_in">AVG</span>(amount) <span class="keyword">OVER</span>(</span><br><span class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> sale_date</span><br><span class="line">        <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">1</span> PRECEDING <span class="keyword">AND</span> <span class="number">1</span> FOLLOWING</span><br><span class="line">    ) <span class="keyword">AS</span> centered_moving_avg</span><br><span class="line"><span class="keyword">FROM</span> sales</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> sale_date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：</span></span><br><span class="line"><span class="comment">sale_date  | amount | centered_avg</span></span><br><span class="line"><span class="comment">-----------+--------+-------------</span></span><br><span class="line"><span class="comment">2024-01-01 | 100    | 100          ((100+100)/2)</span></span><br><span class="line"><span class="comment">2024-01-02 | 100    | 133.33       ((100+100+200)/3)</span></span><br><span class="line"><span class="comment">2024-01-03 | 200    | 166.67       ((100+200+200)/3)</span></span><br><span class="line"><span class="comment">2024-01-04 | 200    | 233.33       ((200+200+300)/3)</span></span><br><span class="line"><span class="comment">2024-01-05 | 300    | 250          ((200+300)/2)</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h2 id="五、GROUPS-窗口（MySQL-8-0-）"><a href="#五、GROUPS-窗口（MySQL-8-0-）" class="headerlink" title="五、GROUPS 窗口（MySQL 8.0+）"></a>五、GROUPS 窗口（MySQL 8.0+）</h2><h3 id="5-1-GROUPS-概述"><a href="#5-1-GROUPS-概述" class="headerlink" title="5.1 GROUPS 概述"></a>5.1 GROUPS 概述</h3><p><strong>GROUPS</strong> 是另一种窗口框架类型，基于逻辑组定义窗口。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ROWS  - 基于物理行</span><br><span class="line">RANGE - 基于值范围</span><br><span class="line">GROUPS - 基于逻辑组（相同 ORDER BY 值的行视为一组）</span><br></pre></td></tr></table></figure>

<h3 id="5-2-GROUPS-示例"><a href="#5-2-GROUPS-示例" class="headerlink" title="5.2 GROUPS 示例"></a>5.2 GROUPS 示例</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- GROUPS BETWEEN 1 PRECEDING AND CURRENT ROW</span></span><br><span class="line"><span class="comment">-- 含义：当前组 + 前 1 组</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    sale_date,</span><br><span class="line">    amount,</span><br><span class="line">    <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(</span><br><span class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> amount</span><br><span class="line">        <span class="keyword">GROUPS</span> <span class="keyword">BETWEEN</span> <span class="number">1</span> PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span></span><br><span class="line">    ) <span class="keyword">AS</span> groups_sum</span><br><span class="line"><span class="keyword">FROM</span> sales</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> amount;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：</span></span><br><span class="line"><span class="comment">sale_date  | amount | groups_sum</span></span><br><span class="line"><span class="comment">-----------+--------+-----------</span></span><br><span class="line"><span class="comment">2024-01-01 | 100    | 200       (amount=100 的组 + 前无组)</span></span><br><span class="line"><span class="comment">2024-01-02 | 100    | 200</span></span><br><span class="line"><span class="comment">2024-01-03 | 200    | 600       (amount=200 的组 + amount=100 的组)</span></span><br><span class="line"><span class="comment">2024-01-04 | 200    | 600</span></span><br><span class="line"><span class="comment">2024-01-05 | 300    | 700       (amount=300 的组 + amount=200 的组)</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h2 id="六、窗口框架性能优化"><a href="#六、窗口框架性能优化" class="headerlink" title="六、窗口框架性能优化"></a>六、窗口框架性能优化</h2><h3 id="6-1-选择合适的数据类型"><a href="#6-1-选择合适的数据类型" class="headerlink" title="6.1 选择合适的数据类型"></a>6.1 选择合适的数据类型</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 使用数值类型作为 ORDER BY 列时，RANGE 性能更好</span></span><br><span class="line"><span class="comment">-- 使用日期/字符串时，ROWS 性能更好</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-避免不必要的全窗口扫描"><a href="#6-2-避免不必要的全窗口扫描" class="headerlink" title="6.2 避免不必要的全窗口扫描"></a>6.2 避免不必要的全窗口扫描</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 不好：每次都扫描整个分区</span></span><br><span class="line"><span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(</span><br><span class="line">    <span class="keyword">PARTITION</span> <span class="keyword">BY</span> category</span><br><span class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span> sale_date</span><br><span class="line">    <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> UNBOUNDED PRECEDING <span class="keyword">AND</span> UNBOUNDED FOLLOWING</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 好：如果只需要累计，使用 CURRENT ROW</span></span><br><span class="line"><span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(</span><br><span class="line">    <span class="keyword">PARTITION</span> <span class="keyword">BY</span> category</span><br><span class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span> sale_date</span><br><span class="line">    <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> UNBOUNDED PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="6-3-使用适当索引"><a href="#6-3-使用适当索引" class="headerlink" title="6.3 使用适当索引"></a>6.3 使用适当索引</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 为窗口排序列添加索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_sale_date <span class="keyword">ON</span> sales(sale_date);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 为分区 + 排序添加复合索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_category_date <span class="keyword">ON</span> sales(category, sale_date);</span><br></pre></td></tr></table></figure>

<h2 id="七、综合案例"><a href="#七、综合案例" class="headerlink" title="七、综合案例"></a>七、综合案例</h2><h3 id="7-1-股票分析-移动平均线"><a href="#7-1-股票分析-移动平均线" class="headerlink" title="7.1 股票分析 - 移动平均线"></a>7.1 股票分析 - 移动平均线</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 准备股票数据</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> stock_prices;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> stock_prices (</span><br><span class="line">    trade_date <span class="type">DATE</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    close_price <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">NOT NULL</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 计算 5 日、10 日、20 日移动平均线</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    trade_date,</span><br><span class="line">    close_price,</span><br><span class="line">    <span class="built_in">AVG</span>(close_price) <span class="keyword">OVER</span>(</span><br><span class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> trade_date</span><br><span class="line">        <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">4</span> PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span></span><br><span class="line">    ) <span class="keyword">AS</span> ma5,</span><br><span class="line">    <span class="built_in">AVG</span>(close_price) <span class="keyword">OVER</span>(</span><br><span class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> trade_date</span><br><span class="line">        <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">9</span> PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span></span><br><span class="line">    ) <span class="keyword">AS</span> ma10,</span><br><span class="line">    <span class="built_in">AVG</span>(close_price) <span class="keyword">OVER</span>(</span><br><span class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> trade_date</span><br><span class="line">        <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">19</span> PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span></span><br><span class="line">    ) <span class="keyword">AS</span> ma20</span><br><span class="line"><span class="keyword">FROM</span> stock_prices</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> trade_date;</span><br></pre></td></tr></table></figure>

<h3 id="7-2-销售分析-累计和预测"><a href="#7-2-销售分析-累计和预测" class="headerlink" title="7.2 销售分析 - 累计和预测"></a>7.2 销售分析 - 累计和预测</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 计算累计销售额和剩余目标</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    sale_date,</span><br><span class="line">    amount,</span><br><span class="line">    <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(</span><br><span class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> sale_date</span><br><span class="line">        <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> UNBOUNDED PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span></span><br><span class="line">    ) <span class="keyword">AS</span> ytd_sales,</span><br><span class="line">    <span class="number">1000000</span> <span class="keyword">AS</span> annual_target,</span><br><span class="line">    <span class="number">1000000</span> <span class="operator">-</span> <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(</span><br><span class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> sale_date</span><br><span class="line">        <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> UNBOUNDED PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span></span><br><span class="line">    ) <span class="keyword">AS</span> remaining_target</span><br><span class="line"><span class="keyword">FROM</span> sales</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> sale_date;</span><br></pre></td></tr></table></figure>

<h3 id="7-3-帕累托分析"><a href="#7-3-帕累托分析" class="headerlink" title="7.3 帕累托分析"></a>7.3 帕累托分析</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 找出贡献 80% 销售额的产品</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WITH</span> product_sales <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        product_id,</span><br><span class="line">        amount,</span><br><span class="line">        <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(</span><br><span class="line">            <span class="keyword">ORDER</span> <span class="keyword">BY</span> amount <span class="keyword">DESC</span></span><br><span class="line">            <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> UNBOUNDED PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span></span><br><span class="line">        ) <span class="keyword">AS</span> running_total,</span><br><span class="line">        <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>() <span class="keyword">AS</span> total</span><br><span class="line">    <span class="keyword">FROM</span> sales</span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    product_id,</span><br><span class="line">    amount,</span><br><span class="line">    running_total,</span><br><span class="line">    ROUND(running_total <span class="operator">*</span> <span class="number">100.0</span> <span class="operator">/</span> total, <span class="number">2</span>) <span class="keyword">AS</span> cumulative_pct</span><br><span class="line"><span class="keyword">FROM</span> product_sales</span><br><span class="line"><span class="keyword">WHERE</span> running_total <span class="operator">*</span> <span class="number">100.0</span> <span class="operator">/</span> total <span class="operator">&lt;=</span> <span class="number">80</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> amount <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h2 id="八、小结"><a href="#八、小结" class="headerlink" title="八、小结"></a>八、小结</h2><h3 id="窗口框架速查表"><a href="#窗口框架速查表" class="headerlink" title="窗口框架速查表"></a>窗口框架速查表</h3><table>
<thead>
<tr>
<th>框架类型</th>
<th>语法</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td>ROWS</td>
<td><code>ROWS BETWEEN n PRECEDING AND CURRENT ROW</code></td>
<td>移动平均、累计</td>
</tr>
<tr>
<td>RANGE</td>
<td><code>RANGE BETWEEN n PRECEDING AND CURRENT ROW</code></td>
<td>值范围分析</td>
</tr>
<tr>
<td>GROUPS</td>
<td><code>GROUPS BETWEEN n PRECEDING AND CURRENT ROW</code></td>
<td>逻辑组分析</td>
</tr>
</tbody></table>
<h3 id="常用边界组合"><a href="#常用边界组合" class="headerlink" title="常用边界组合"></a>常用边界组合</h3><table>
<thead>
<tr>
<th>组合</th>
<th>含义</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>UNBOUNDED PRECEDING AND CURRENT ROW</code></td>
<td>从起点到当前行</td>
<td>累计求和</td>
</tr>
<tr>
<td><code>CURRENT ROW AND UNBOUNDED FOLLOWING</code></td>
<td>从当前行到终点</td>
<td>剩余总和</td>
</tr>
<tr>
<td><code>n PRECEDING AND CURRENT ROW</code></td>
<td>前 n 行到当前行</td>
<td>移动窗口</td>
</tr>
<tr>
<td><code>n PRECEDING AND n FOLLOWING</code></td>
<td>前后各 n 行</td>
<td>居中窗口</td>
</tr>
<tr>
<td><code>UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING</code></td>
<td>整个分区</td>
<td>首尾值</td>
</tr>
</tbody></table>
<h3 id="核心要点"><a href="#核心要点" class="headerlink" title="核心要点"></a>核心要点</h3><ol>
<li><strong>ROWS</strong> 基于物理行，<strong>RANGE</strong> 基于值范围</li>
<li>有 <code>ORDER BY</code> 无框架时，默认使用 <code>RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW</code></li>
<li><code>LAST_VALUE</code> 需要显式指定 <code>UNBOUNDED FOLLOWING</code></li>
<li>窗口框架影响性能，应根据需求选择最合适的配置</li>
</ol>
<h3 id="下一章预告"><a href="#下一章预告" class="headerlink" title="下一章预告"></a>下一章预告</h3><p>下一篇文章将介绍<strong>NTILE 分桶函数</strong>，包括：</p>
<ul>
<li>NTILE 函数基础</li>
<li>数据分桶</li>
<li>百分位计算</li>
<li>排名分组</li>
</ul>
<hr>
<p><strong>下一篇</strong>：[MySQL 进阶教程 04-06 NTILE 分桶函数](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 04-06 NTILE 分桶函数&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 进阶教程 04-04 LEAD&#x2F;LAG 前后行访问](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 04-04 LEAD LAG 前后行访问&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 进阶教程</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>窗口函数</tag>
        <tag>窗口框架</tag>
        <tag>ROWS</tag>
        <tag>RANGE</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 进阶教程 04-07 窗口函数实战案例</title>
    <url>/2026/02/24/MySQL%20%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B%2004-07%20%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B/</url>
    <content><![CDATA[<h1 id="MySQL-进阶教程-04-07-窗口函数实战案例"><a href="#MySQL-进阶教程-04-07-窗口函数实战案例" class="headerlink" title="MySQL 进阶教程 04-07 窗口函数实战案例"></a>MySQL 进阶教程 04-07 窗口函数实战案例</h1><p>本文通过综合实战案例，展示如何运用窗口函数解决实际业务问题。案例涵盖连续登录、Top N 问题、累计分析、复杂报表等常见场景。</p>
<h2 id="一、连续登录问题"><a href="#一、连续登录问题" class="headerlink" title="一、连续登录问题"></a>一、连续登录问题</h2><h3 id="1-1-问题描述"><a href="#1-1-问题描述" class="headerlink" title="1.1 问题描述"></a>1.1 问题描述</h3><p><strong>场景</strong>：用户签到系统，找出连续签到 3 天以上的用户。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 准备签到数据</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> user_signin;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> user_signin (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    user_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    signin_date <span class="type">DATE</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    <span class="keyword">UNIQUE</span> KEY uk_user_date (user_id, signin_date)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> user_signin (user_id, signin_date) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">1</span>, <span class="string">&#x27;2024-01-01&#x27;</span>), (<span class="number">1</span>, <span class="string">&#x27;2024-01-02&#x27;</span>), (<span class="number">1</span>, <span class="string">&#x27;2024-01-03&#x27;</span>), (<span class="number">1</span>, <span class="string">&#x27;2024-01-04&#x27;</span>),</span><br><span class="line">(<span class="number">2</span>, <span class="string">&#x27;2024-01-01&#x27;</span>), (<span class="number">2</span>, <span class="string">&#x27;2024-01-03&#x27;</span>), (<span class="number">2</span>, <span class="string">&#x27;2024-01-05&#x27;</span>),</span><br><span class="line">(<span class="number">3</span>, <span class="string">&#x27;2024-01-01&#x27;</span>), (<span class="number">3</span>, <span class="string">&#x27;2024-01-02&#x27;</span>), (<span class="number">3</span>, <span class="string">&#x27;2024-01-03&#x27;</span>),</span><br><span class="line">(<span class="number">4</span>, <span class="string">&#x27;2024-01-01&#x27;</span>), (<span class="number">4</span>, <span class="string">&#x27;2024-01-02&#x27;</span>), (<span class="number">4</span>, <span class="string">&#x27;2024-01-04&#x27;</span>), (<span class="number">4</span>, <span class="string">&#x27;2024-01-05&#x27;</span>), (<span class="number">4</span>, <span class="string">&#x27;2024-01-06&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="1-2-解法：行号差值法"><a href="#1-2-解法：行号差值法" class="headerlink" title="1.2 解法：行号差值法"></a>1.2 解法：行号差值法</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 核心思路：连续日期的行号差值相同</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WITH</span> numbered_signin <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        user_id,</span><br><span class="line">        signin_date,</span><br><span class="line">        <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> user_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> signin_date) <span class="keyword">AS</span> rn</span><br><span class="line">    <span class="keyword">FROM</span> user_signin</span><br><span class="line">),</span><br><span class="line">grouped_signin <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        user_id,</span><br><span class="line">        signin_date,</span><br><span class="line">        rn,</span><br><span class="line">        <span class="comment">-- 关键：日期减去行号，连续日期的结果相同</span></span><br><span class="line">        DATE_SUB(signin_date, <span class="type">INTERVAL</span> rn <span class="keyword">DAY</span>) <span class="keyword">AS</span> grp</span><br><span class="line">    <span class="keyword">FROM</span> numbered_signin</span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    user_id,</span><br><span class="line">    <span class="built_in">MIN</span>(signin_date) <span class="keyword">AS</span> start_date,</span><br><span class="line">    <span class="built_in">MAX</span>(signin_date) <span class="keyword">AS</span> end_date,</span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> consecutive_days</span><br><span class="line"><span class="keyword">FROM</span> grouped_signin</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id, grp</span><br><span class="line"><span class="keyword">HAVING</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="operator">&gt;=</span> <span class="number">3</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> user_id, start_date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：</span></span><br><span class="line"><span class="comment">user_id | start_date | end_date   | consecutive_days</span></span><br><span class="line"><span class="comment">--------+------------+------------+-----------------</span></span><br><span class="line"><span class="comment">1       | 2024-01-01 | 2024-01-04 | 4</span></span><br><span class="line"><span class="comment">3       | 2024-01-01 | 2024-01-03 | 3</span></span><br><span class="line"><span class="comment">4       | 2024-01-04 | 2024-01-06 | 3</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>原理解析</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">用户 1 的签到：</span><br><span class="line">signin_date  | rn  | signin_date - rn (grp)</span><br><span class="line">-------------+-----+-----------------------</span><br><span class="line">2024-01-01   | 1   | 2023-12-31  ← 相同组</span><br><span class="line">2024-01-02   | 2   | 2023-12-31  ← 相同组</span><br><span class="line">2024-01-03   | 3   | 2023-12-31  ← 相同组</span><br><span class="line">2024-01-04   | 4   | 2023-12-31  ← 相同组</span><br><span class="line"></span><br><span class="line">用户 2 的签到（不连续）：</span><br><span class="line">signin_date  | rn  | signin_date - rn (grp)</span><br><span class="line">-------------+-----+-----------------------</span><br><span class="line">2024-01-01   | 1   | 2023-12-31  ← 组 1</span><br><span class="line">2024-01-03   | 2   | 2024-01-01  ← 组 2</span><br><span class="line">2024-01-05   | 3   | 2024-01-02  ← 组 3</span><br></pre></td></tr></table></figure>

<h3 id="1-3-扩展：找出最长连续登录"><a href="#1-3-扩展：找出最长连续登录" class="headerlink" title="1.3 扩展：找出最长连续登录"></a>1.3 扩展：找出最长连续登录</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 找出每个用户的最长连续登录天数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WITH</span> numbered_signin <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        user_id,</span><br><span class="line">        signin_date,</span><br><span class="line">        <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> user_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> signin_date) <span class="keyword">AS</span> rn</span><br><span class="line">    <span class="keyword">FROM</span> user_signin</span><br><span class="line">),</span><br><span class="line">grouped_signin <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        user_id,</span><br><span class="line">        signin_date,</span><br><span class="line">        DATE_SUB(signin_date, <span class="type">INTERVAL</span> rn <span class="keyword">DAY</span>) <span class="keyword">AS</span> grp</span><br><span class="line">    <span class="keyword">FROM</span> numbered_signin</span><br><span class="line">),</span><br><span class="line">consecutive_stats <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        user_id,</span><br><span class="line">        grp,</span><br><span class="line">        <span class="built_in">MIN</span>(signin_date) <span class="keyword">AS</span> start_date,</span><br><span class="line">        <span class="built_in">MAX</span>(signin_date) <span class="keyword">AS</span> end_date,</span><br><span class="line">        <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> days</span><br><span class="line">    <span class="keyword">FROM</span> grouped_signin</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id, grp</span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    user_id,</span><br><span class="line">    <span class="built_in">MAX</span>(days) <span class="keyword">AS</span> max_consecutive_days,</span><br><span class="line">    <span class="built_in">MAX</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> days <span class="operator">=</span> (<span class="keyword">SELECT</span> <span class="built_in">MAX</span>(days) <span class="keyword">FROM</span> consecutive_stats c2 <span class="keyword">WHERE</span> c2.user_id <span class="operator">=</span> c1.user_id)</span><br><span class="line">        <span class="keyword">THEN</span> start_date <span class="keyword">END</span>) <span class="keyword">AS</span> max_start_date,</span><br><span class="line">    <span class="built_in">MAX</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> days <span class="operator">=</span> (<span class="keyword">SELECT</span> <span class="built_in">MAX</span>(days) <span class="keyword">FROM</span> consecutive_stats c2 <span class="keyword">WHERE</span> c2.user_id <span class="operator">=</span> c1.user_id)</span><br><span class="line">        <span class="keyword">THEN</span> end_date <span class="keyword">END</span>) <span class="keyword">AS</span> max_end_date</span><br><span class="line"><span class="keyword">FROM</span> consecutive_stats c1</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> max_consecutive_days <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h2 id="二、Top-N-问题综合解法"><a href="#二、Top-N-问题综合解法" class="headerlink" title="二、Top N 问题综合解法"></a>二、Top N 问题综合解法</h2><h3 id="2-1-问题描述"><a href="#2-1-问题描述" class="headerlink" title="2.1 问题描述"></a>2.1 问题描述</h3><p><strong>场景</strong>：获取每个部门工资最高的 3 名员工。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 准备数据</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> employees;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> employees (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    dept_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    salary <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">NOT NULL</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> employees (name, dept_id, salary) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;张三&#x27;</span>, <span class="number">1</span>, <span class="number">8000</span>), (<span class="string">&#x27;李四&#x27;</span>, <span class="number">1</span>, <span class="number">10000</span>), (<span class="string">&#x27;王五&#x27;</span>, <span class="number">1</span>, <span class="number">12000</span>),</span><br><span class="line">(<span class="string">&#x27;赵六&#x27;</span>, <span class="number">1</span>, <span class="number">9000</span>), (<span class="string">&#x27;孙七&#x27;</span>, <span class="number">1</span>, <span class="number">11000</span>), (<span class="string">&#x27;周八&#x27;</span>, <span class="number">2</span>, <span class="number">7000</span>),</span><br><span class="line">(<span class="string">&#x27;吴九&#x27;</span>, <span class="number">2</span>, <span class="number">9000</span>), (<span class="string">&#x27;郑十&#x27;</span>, <span class="number">2</span>, <span class="number">8000</span>), (<span class="string">&#x27;王十一&#x27;</span>, <span class="number">2</span>, <span class="number">10000</span>),</span><br><span class="line">(<span class="string">&#x27;刘十二&#x27;</span>, <span class="number">2</span>, <span class="number">6000</span>), (<span class="string">&#x27;陈十三&#x27;</span>, <span class="number">3</span>, <span class="number">15000</span>);</span><br></pre></td></tr></table></figure>

<h3 id="2-2-解法对比"><a href="#2-2-解法对比" class="headerlink" title="2.2 解法对比"></a>2.2 解法对比</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 解法 1：ROW_NUMBER（推荐，严格 Top N）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        name,</span><br><span class="line">        dept_id,</span><br><span class="line">        salary,</span><br><span class="line">        <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>) <span class="keyword">AS</span> rn</span><br><span class="line">    <span class="keyword">FROM</span> employees</span><br><span class="line">) t</span><br><span class="line"><span class="keyword">WHERE</span> rn <span class="operator">&lt;=</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 解法 2：DENSE_RANK（允许并列超过 N 人）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        name,</span><br><span class="line">        dept_id,</span><br><span class="line">        salary,</span><br><span class="line">        <span class="built_in">DENSE_RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>) <span class="keyword">AS</span> dr</span><br><span class="line">    <span class="keyword">FROM</span> employees</span><br><span class="line">) t</span><br><span class="line"><span class="keyword">WHERE</span> dr <span class="operator">&lt;=</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 解法 3：RANK（跳跃排名）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        name,</span><br><span class="line">        dept_id,</span><br><span class="line">        salary,</span><br><span class="line">        <span class="built_in">RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>) <span class="keyword">AS</span> r</span><br><span class="line">    <span class="keyword">FROM</span> employees</span><br><span class="line">) t</span><br><span class="line"><span class="keyword">WHERE</span> r <span class="operator">&lt;=</span> <span class="number">3</span>;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-三种解法结果对比"><a href="#2-3-三种解法结果对比" class="headerlink" title="2.3 三种解法结果对比"></a>2.3 三种解法结果对比</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">部门 1 有 5 人，工资分别为：12000, 11000, 10000, 9000, 8000</span><br><span class="line"></span><br><span class="line">ROW_NUMBER:    取前 3 人（12000, 11000, 10000）</span><br><span class="line">DENSE_RANK:    取前 3 人（同上，无并列）</span><br><span class="line">RANK:          取前 3 人（同上，无并列）</span><br><span class="line"></span><br><span class="line">如果有并列情况（如两人都是 12000）：</span><br><span class="line">ROW_NUMBER:    强制区分，取 3 人</span><br><span class="line">DENSE_RANK:    两人都是第 1 名，取 4 人（1,1,2,3）</span><br><span class="line">RANK:          两人都是第 1 名，取 3 人（1,1,3）</span><br></pre></td></tr></table></figure>

<h2 id="三、累计分析实战"><a href="#三、累计分析实战" class="headerlink" title="三、累计分析实战"></a>三、累计分析实战</h2><h3 id="3-1-累计销售额"><a href="#3-1-累计销售额" class="headerlink" title="3.1 累计销售额"></a>3.1 累计销售额</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 准备订单数据</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> orders;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    order_date <span class="type">DATE</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    user_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    amount <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">NOT NULL</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (order_date, user_id, amount) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;2024-01-01&#x27;</span>, <span class="number">1</span>, <span class="number">100</span>), (<span class="string">&#x27;2024-01-05&#x27;</span>, <span class="number">1</span>, <span class="number">150</span>), (<span class="string">&#x27;2024-01-10&#x27;</span>, <span class="number">1</span>, <span class="number">200</span>),</span><br><span class="line">(<span class="string">&#x27;2024-01-02&#x27;</span>, <span class="number">2</span>, <span class="number">80</span>), (<span class="string">&#x27;2024-01-06&#x27;</span>, <span class="number">2</span>, <span class="number">120</span>), (<span class="string">&#x27;2024-01-11&#x27;</span>, <span class="number">2</span>, <span class="number">90</span>),</span><br><span class="line">(<span class="string">&#x27;2024-01-03&#x27;</span>, <span class="number">3</span>, <span class="number">200</span>), (<span class="string">&#x27;2024-01-07&#x27;</span>, <span class="number">3</span>, <span class="number">180</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 按日累计销售额</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    order_date,</span><br><span class="line">    <span class="built_in">SUM</span>(amount) <span class="keyword">AS</span> daily_amount,</span><br><span class="line">    <span class="built_in">SUM</span>(<span class="built_in">SUM</span>(amount)) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date) <span class="keyword">AS</span> running_total</span><br><span class="line"><span class="keyword">FROM</span> orders</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> order_date</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-用户累计消费排名"><a href="#3-2-用户累计消费排名" class="headerlink" title="3.2 用户累计消费排名"></a>3.2 用户累计消费排名</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 计算每个用户的累计消费，并排名</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WITH</span> user_totals <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        user_id,</span><br><span class="line">        <span class="built_in">SUM</span>(amount) <span class="keyword">AS</span> total_amount</span><br><span class="line">    <span class="keyword">FROM</span> orders</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id</span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    user_id,</span><br><span class="line">    total_amount,</span><br><span class="line">    <span class="built_in">RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> total_amount <span class="keyword">DESC</span>) <span class="keyword">AS</span> rank,</span><br><span class="line">    ROUND(</span><br><span class="line">        total_amount <span class="operator">*</span> <span class="number">100.0</span> <span class="operator">/</span> <span class="built_in">SUM</span>(total_amount) <span class="keyword">OVER</span>(),</span><br><span class="line">        <span class="number">2</span></span><br><span class="line">    ) <span class="keyword">AS</span> percentage</span><br><span class="line"><span class="keyword">FROM</span> user_totals</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> total_amount <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-帕累托分析（二八法则）"><a href="#3-3-帕累托分析（二八法则）" class="headerlink" title="3.3 帕累托分析（二八法则）"></a>3.3 帕累托分析（二八法则）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 找出贡献 80% 销售额的用户</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WITH</span> user_cumulative <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        user_id,</span><br><span class="line">        <span class="built_in">SUM</span>(amount) <span class="keyword">AS</span> user_total,</span><br><span class="line">        <span class="built_in">SUM</span>(<span class="built_in">SUM</span>(amount)) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="built_in">SUM</span>(amount) <span class="keyword">DESC</span>) <span class="keyword">AS</span> running_total,</span><br><span class="line">        <span class="built_in">SUM</span>(<span class="built_in">SUM</span>(amount)) <span class="keyword">OVER</span>() <span class="keyword">AS</span> grand_total</span><br><span class="line">    <span class="keyword">FROM</span> orders</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id</span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    user_id,</span><br><span class="line">    user_total,</span><br><span class="line">    running_total,</span><br><span class="line">    ROUND(running_total <span class="operator">*</span> <span class="number">100.0</span> <span class="operator">/</span> grand_total, <span class="number">2</span>) <span class="keyword">AS</span> cumulative_pct</span><br><span class="line"><span class="keyword">FROM</span> user_cumulative</span><br><span class="line"><span class="keyword">WHERE</span> running_total <span class="operator">*</span> <span class="number">100.0</span> <span class="operator">/</span> grand_total <span class="operator">&lt;=</span> <span class="number">80</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> user_total <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h2 id="四、复杂报表生成"><a href="#四、复杂报表生成" class="headerlink" title="四、复杂报表生成"></a>四、复杂报表生成</h2><h3 id="4-1-销售报表-同比环比"><a href="#4-1-销售报表-同比环比" class="headerlink" title="4.1 销售报表 - 同比环比"></a>4.1 销售报表 - 同比环比</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 准备月度销售数据</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> monthly_sales;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> monthly_sales (</span><br><span class="line">    year_month <span class="type">VARCHAR</span>(<span class="number">7</span>) <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    sales <span class="type">DECIMAL</span>(<span class="number">12</span>, <span class="number">2</span>) <span class="keyword">NOT NULL</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> monthly_sales (year_month, sales) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;2023-01&#x27;</span>, <span class="number">10000</span>), (<span class="string">&#x27;2023-02&#x27;</span>, <span class="number">12000</span>), (<span class="string">&#x27;2023-03&#x27;</span>, <span class="number">11000</span>),</span><br><span class="line">(<span class="string">&#x27;2023-04&#x27;</span>, <span class="number">15000</span>), (<span class="string">&#x27;2023-05&#x27;</span>, <span class="number">14000</span>), (<span class="string">&#x27;2023-06&#x27;</span>, <span class="number">18000</span>),</span><br><span class="line">(<span class="string">&#x27;2024-01&#x27;</span>, <span class="number">12000</span>), (<span class="string">&#x27;2024-02&#x27;</span>, <span class="number">14000</span>), (<span class="string">&#x27;2024-03&#x27;</span>, <span class="number">13000</span>),</span><br><span class="line">(<span class="string">&#x27;2024-04&#x27;</span>, <span class="number">18000</span>), (<span class="string">&#x27;2024-05&#x27;</span>, <span class="number">17000</span>), (<span class="string">&#x27;2024-06&#x27;</span>, <span class="number">22000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 生成同比环比报表</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    year_month,</span><br><span class="line">    sales <span class="keyword">AS</span> current_sales,</span><br><span class="line">    <span class="built_in">LAG</span>(sales, <span class="number">1</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> year_month) <span class="keyword">AS</span> prev_month_sales,</span><br><span class="line">    <span class="built_in">LAG</span>(sales, <span class="number">12</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> year_month) <span class="keyword">AS</span> same_month_last_year,</span><br><span class="line">    ROUND(</span><br><span class="line">        (sales <span class="operator">-</span> <span class="built_in">LAG</span>(sales, <span class="number">1</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> year_month)) <span class="operator">*</span> <span class="number">100.0</span> <span class="operator">/</span></span><br><span class="line">        <span class="built_in">LAG</span>(sales, <span class="number">1</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> year_month),</span><br><span class="line">        <span class="number">2</span></span><br><span class="line">    ) <span class="keyword">AS</span> mom_growth,</span><br><span class="line">    ROUND(</span><br><span class="line">        (sales <span class="operator">-</span> <span class="built_in">LAG</span>(sales, <span class="number">12</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> year_month)) <span class="operator">*</span> <span class="number">100.0</span> <span class="operator">/</span></span><br><span class="line">        <span class="built_in">LAG</span>(sales, <span class="number">12</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> year_month),</span><br><span class="line">        <span class="number">2</span></span><br><span class="line">    ) <span class="keyword">AS</span> yoy_growth</span><br><span class="line"><span class="keyword">FROM</span> monthly_sales</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> year_month;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-员工工资报表"><a href="#4-2-员工工资报表" class="headerlink" title="4.2 员工工资报表"></a>4.2 员工工资报表</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 生成部门工资报表（含部门内排名和占比）</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    name,</span><br><span class="line">    dept_id,</span><br><span class="line">    salary,</span><br><span class="line">    <span class="built_in">NTILE</span>(<span class="number">4</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>) <span class="keyword">AS</span> salary_quartile,</span><br><span class="line">    ROUND(</span><br><span class="line">        salary <span class="operator">*</span> <span class="number">100.0</span> <span class="operator">/</span> <span class="built_in">SUM</span>(salary) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id),</span><br><span class="line">        <span class="number">2</span></span><br><span class="line">    ) <span class="keyword">AS</span> dept_salary_pct,</span><br><span class="line">    ROUND(</span><br><span class="line">        salary <span class="operator">*</span> <span class="number">100.0</span> <span class="operator">/</span> <span class="built_in">SUM</span>(salary) <span class="keyword">OVER</span>(),</span><br><span class="line">        <span class="number">2</span></span><br><span class="line">    ) <span class="keyword">AS</span> company_salary_pct</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> dept_id, salary <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h2 id="五、时间序列分析"><a href="#五、时间序列分析" class="headerlink" title="五、时间序列分析"></a>五、时间序列分析</h2><h3 id="5-1-移动平均线"><a href="#5-1-移动平均线" class="headerlink" title="5.1 移动平均线"></a>5.1 移动平均线</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 计算 7 日移动平均</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    order_date,</span><br><span class="line">    <span class="built_in">SUM</span>(amount) <span class="keyword">AS</span> daily_total,</span><br><span class="line">    <span class="built_in">AVG</span>(<span class="built_in">SUM</span>(amount)) <span class="keyword">OVER</span>(</span><br><span class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date</span><br><span class="line">        <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">6</span> PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span></span><br><span class="line">    ) <span class="keyword">AS</span> ma_7d</span><br><span class="line"><span class="keyword">FROM</span> orders</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> order_date</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-累计差值分析"><a href="#5-2-累计差值分析" class="headerlink" title="5.2 累计差值分析"></a>5.2 累计差值分析</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 计算每日与目标值的差值</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    order_date,</span><br><span class="line">    <span class="built_in">SUM</span>(amount) <span class="keyword">AS</span> daily_amount,</span><br><span class="line">    <span class="built_in">SUM</span>(<span class="built_in">SUM</span>(amount)) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date) <span class="keyword">AS</span> running_total,</span><br><span class="line">    <span class="number">1000</span> <span class="keyword">AS</span> daily_target,</span><br><span class="line">    <span class="built_in">SUM</span>(<span class="built_in">SUM</span>(amount)) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date) <span class="operator">-</span></span><br><span class="line">        <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="operator">*</span> <span class="number">1000</span> <span class="keyword">AS</span> diff_from_target</span><br><span class="line"><span class="keyword">FROM</span> orders</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> order_date</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date;</span><br></pre></td></tr></table></figure>

<h2 id="六、综合案例：电商数据分析"><a href="#六、综合案例：电商数据分析" class="headerlink" title="六、综合案例：电商数据分析"></a>六、综合案例：电商数据分析</h2><h3 id="6-1-用户分层分析"><a href="#6-1-用户分层分析" class="headerlink" title="6.1 用户分层分析"></a>6.1 用户分层分析</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 基于 RFM 模型的用户分层</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> user_orders;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> user_orders (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    user_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    order_date <span class="type">DATE</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    amount <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">NOT NULL</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> user_orders (user_id, order_date, amount) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">1</span>, <span class="string">&#x27;2024-01-01&#x27;</span>, <span class="number">100</span>), (<span class="number">1</span>, <span class="string">&#x27;2024-02-01&#x27;</span>, <span class="number">200</span>), (<span class="number">1</span>, <span class="string">&#x27;2024-03-01&#x27;</span>, <span class="number">150</span>),</span><br><span class="line">(<span class="number">2</span>, <span class="string">&#x27;2024-01-15&#x27;</span>, <span class="number">500</span>),</span><br><span class="line">(<span class="number">3</span>, <span class="string">&#x27;2024-02-01&#x27;</span>, <span class="number">80</span>), (<span class="number">3</span>, <span class="string">&#x27;2024-02-15&#x27;</span>, <span class="number">120</span>), (<span class="number">3</span>, <span class="string">&#x27;2024-03-01&#x27;</span>, <span class="number">90</span>), (<span class="number">3</span>, <span class="string">&#x27;2024-03-15&#x27;</span>, <span class="number">110</span>),</span><br><span class="line">(<span class="number">4</span>, <span class="string">&#x27;2024-03-01&#x27;</span>, <span class="number">1000</span>),</span><br><span class="line">(<span class="number">5</span>, <span class="string">&#x27;2024-01-01&#x27;</span>, <span class="number">50</span>), (<span class="number">5</span>, <span class="string">&#x27;2024-01-15&#x27;</span>, <span class="number">60</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 计算 RFM 指标并分层</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WITH</span> rfm_data <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        user_id,</span><br><span class="line">        DATEDIFF(<span class="string">&#x27;2024-04-01&#x27;</span>, <span class="built_in">MAX</span>(order_date)) <span class="keyword">AS</span> recency,  <span class="comment">-- R: 最近一次消费距今</span></span><br><span class="line">        <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> frequency,                                <span class="comment">-- F: 消费频次</span></span><br><span class="line">        <span class="built_in">SUM</span>(amount) <span class="keyword">AS</span> monetary                               <span class="comment">-- M: 消费金额</span></span><br><span class="line">    <span class="keyword">FROM</span> user_orders</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id</span><br><span class="line">),</span><br><span class="line">rfm_scored <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        user_id,</span><br><span class="line">        recency,</span><br><span class="line">        frequency,</span><br><span class="line">        monetary,</span><br><span class="line">        <span class="built_in">NTILE</span>(<span class="number">5</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> recency <span class="keyword">DESC</span>) <span class="keyword">AS</span> r_score,  <span class="comment">-- R 越高越差</span></span><br><span class="line">        <span class="built_in">NTILE</span>(<span class="number">5</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> frequency) <span class="keyword">AS</span> f_score,     <span class="comment">-- F 越高越好</span></span><br><span class="line">        <span class="built_in">NTILE</span>(<span class="number">5</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> monetary) <span class="keyword">AS</span> m_score       <span class="comment">-- M 越高越好</span></span><br><span class="line">    <span class="keyword">FROM</span> rfm_data</span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    user_id,</span><br><span class="line">    recency,</span><br><span class="line">    frequency,</span><br><span class="line">    monetary,</span><br><span class="line">    r_score,</span><br><span class="line">    f_score,</span><br><span class="line">    m_score,</span><br><span class="line">    <span class="keyword">CASE</span></span><br><span class="line">        <span class="keyword">WHEN</span> r_score <span class="operator">&gt;=</span> <span class="number">4</span> <span class="keyword">AND</span> f_score <span class="operator">&gt;=</span> <span class="number">4</span> <span class="keyword">AND</span> m_score <span class="operator">&gt;=</span> <span class="number">4</span> <span class="keyword">THEN</span> <span class="string">&#x27;重要价值用户&#x27;</span></span><br><span class="line">        <span class="keyword">WHEN</span> r_score <span class="operator">&gt;=</span> <span class="number">4</span> <span class="keyword">AND</span> f_score <span class="operator">&gt;=</span> <span class="number">4</span> <span class="keyword">THEN</span> <span class="string">&#x27;重要发展用户&#x27;</span></span><br><span class="line">        <span class="keyword">WHEN</span> r_score <span class="operator">&gt;=</span> <span class="number">4</span> <span class="keyword">AND</span> m_score <span class="operator">&gt;=</span> <span class="number">4</span> <span class="keyword">THEN</span> <span class="string">&#x27;重要保持用户&#x27;</span></span><br><span class="line">        <span class="keyword">WHEN</span> r_score <span class="operator">&gt;=</span> <span class="number">4</span> <span class="keyword">THEN</span> <span class="string">&#x27;一般发展用户&#x27;</span></span><br><span class="line">        <span class="keyword">WHEN</span> f_score <span class="operator">&gt;=</span> <span class="number">4</span> <span class="keyword">AND</span> m_score <span class="operator">&gt;=</span> <span class="number">4</span> <span class="keyword">THEN</span> <span class="string">&#x27;重要挽留用户&#x27;</span></span><br><span class="line">        <span class="keyword">WHEN</span> f_score <span class="operator">&gt;=</span> <span class="number">4</span> <span class="keyword">THEN</span> <span class="string">&#x27;一般挽留用户&#x27;</span></span><br><span class="line">        <span class="keyword">WHEN</span> m_score <span class="operator">&gt;=</span> <span class="number">4</span> <span class="keyword">THEN</span> <span class="string">&#x27;重要沉睡用户&#x27;</span></span><br><span class="line">        <span class="keyword">ELSE</span> <span class="string">&#x27;一般沉睡用户&#x27;</span></span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">AS</span> user_segment</span><br><span class="line"><span class="keyword">FROM</span> rfm_scored</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> user_id;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-复购分析"><a href="#6-2-复购分析" class="headerlink" title="6.2 复购分析"></a>6.2 复购分析</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 计算用户复购情况</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WITH</span> user_order_pairs <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        user_id,</span><br><span class="line">        order_date,</span><br><span class="line">        <span class="built_in">LAG</span>(order_date) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> user_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date) <span class="keyword">AS</span> prev_order_date</span><br><span class="line">    <span class="keyword">FROM</span> user_orders</span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> user_id) <span class="keyword">AS</span> total_users,</span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> <span class="keyword">CASE</span> <span class="keyword">WHEN</span> prev_order_date <span class="keyword">IS</span> <span class="keyword">NOT NULL</span> <span class="keyword">THEN</span> user_id <span class="keyword">END</span>) <span class="keyword">AS</span> repurchase_users,</span><br><span class="line">    ROUND(</span><br><span class="line">        <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> <span class="keyword">CASE</span> <span class="keyword">WHEN</span> prev_order_date <span class="keyword">IS</span> <span class="keyword">NOT NULL</span> <span class="keyword">THEN</span> user_id <span class="keyword">END</span>) <span class="operator">*</span> <span class="number">100.0</span> <span class="operator">/</span></span><br><span class="line">        <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> user_id),</span><br><span class="line">        <span class="number">2</span></span><br><span class="line">    ) <span class="keyword">AS</span> repurchase_rate</span><br><span class="line"><span class="keyword">FROM</span> user_order_pairs;</span><br></pre></td></tr></table></figure>

<h2 id="七、性能优化建议"><a href="#七、性能优化建议" class="headerlink" title="七、性能优化建议"></a>七、性能优化建议</h2><h3 id="7-1-使用-CTE-提高可读性"><a href="#7-1-使用-CTE-提高可读性" class="headerlink" title="7.1 使用 CTE 提高可读性"></a>7.1 使用 CTE 提高可读性</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 不推荐：嵌套子查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="operator">*</span>, <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(...) <span class="keyword">AS</span> rn <span class="keyword">FROM</span> (</span><br><span class="line">        <span class="keyword">SELECT</span> ... <span class="keyword">FROM</span> ...</span><br><span class="line">    ) t1</span><br><span class="line">) t2 <span class="keyword">WHERE</span> rn <span class="operator">&lt;=</span> <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 推荐：使用 CTE</span></span><br><span class="line"><span class="keyword">WITH</span> numbered <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="operator">*</span>, <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(...) <span class="keyword">AS</span> rn</span><br><span class="line">    <span class="keyword">FROM</span> ...</span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> numbered <span class="keyword">WHERE</span> rn <span class="operator">&lt;=</span> <span class="number">5</span>;</span><br></pre></td></tr></table></figure>

<h3 id="7-2-添加适当索引"><a href="#7-2-添加适当索引" class="headerlink" title="7.2 添加适当索引"></a>7.2 添加适当索引</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 为窗口函数的 PARTITION BY 和 ORDER BY 列添加索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_dept_salary <span class="keyword">ON</span> employees(dept_id, salary <span class="keyword">DESC</span>);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_user_date <span class="keyword">ON</span> user_signin(user_id, signin_date);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_order_date <span class="keyword">ON</span> orders(order_date);</span><br></pre></td></tr></table></figure>

<h3 id="7-3-避免重复窗口计算"><a href="#7-3-避免重复窗口计算" class="headerlink" title="7.3 避免重复窗口计算"></a>7.3 避免重复窗口计算</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 不推荐：重复计算</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(...) <span class="keyword">AS</span> rn,</span><br><span class="line">    <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(...) <span class="keyword">AS</span> running_total</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="operator">*</span>, <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(...) <span class="keyword">AS</span> inner_rn <span class="keyword">FROM</span> ...</span><br><span class="line">) t;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 推荐：一次计算</span></span><br><span class="line"><span class="keyword">WITH</span> windowed <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        <span class="operator">*</span>,</span><br><span class="line">        <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(...) <span class="keyword">AS</span> rn,</span><br><span class="line">        <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span>(...) <span class="keyword">AS</span> running_total</span><br><span class="line">    <span class="keyword">FROM</span> ...</span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> windowed <span class="keyword">WHERE</span> rn <span class="operator">&lt;=</span> <span class="number">5</span>;</span><br></pre></td></tr></table></figure>

<h2 id="八、小结"><a href="#八、小结" class="headerlink" title="八、小结"></a>八、小结</h2><h3 id="核心案例总结"><a href="#核心案例总结" class="headerlink" title="核心案例总结"></a>核心案例总结</h3><table>
<thead>
<tr>
<th>案例类型</th>
<th>关键技术</th>
<th>应用场景</th>
</tr>
</thead>
<tbody><tr>
<td>连续登录</td>
<td>ROW_NUMBER + 日期差值</td>
<td>签到、活跃用户</td>
</tr>
<tr>
<td>Top N</td>
<td>ROW_NUMBER&#x2F;DENSE_RANK</td>
<td>排名、精选</td>
</tr>
<tr>
<td>累计分析</td>
<td>SUM OVER</td>
<td>销售、财务</td>
</tr>
<tr>
<td>同比环比</td>
<td>LAG&#x2F;LEAD</td>
<td>趋势分析</td>
</tr>
<tr>
<td>用户分层</td>
<td>NTILE</td>
<td>RFM 模型</td>
</tr>
<tr>
<td>移动平均</td>
<td>AVG OVER + ROWS</td>
<td>时间序列</td>
</tr>
</tbody></table>
<h3 id="窗口函数选择指南"><a href="#窗口函数选择指南" class="headerlink" title="窗口函数选择指南"></a>窗口函数选择指南</h3><table>
<thead>
<tr>
<th>需求</th>
<th>推荐函数</th>
</tr>
</thead>
<tbody><tr>
<td>排名</td>
<td>ROW_NUMBER&#x2F;RANK&#x2F;DENSE_RANK</td>
</tr>
<tr>
<td>分组</td>
<td>NTILE</td>
</tr>
<tr>
<td>累计</td>
<td>SUM&#x2F;COUNT OVER</td>
</tr>
<tr>
<td>对比前后</td>
<td>LAG&#x2F;LEAD</td>
</tr>
<tr>
<td>移动计算</td>
<td>AVG&#x2F;SUM + ROWS BETWEEN</td>
</tr>
<tr>
<td>首尾值</td>
<td>FIRST_VALUE&#x2F;LAST_VALUE</td>
</tr>
</tbody></table>
<hr>
<p><strong>上一篇</strong>：[MySQL 进阶教程 04-06 NTILE 分桶函数](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 04-06 NTILE 分桶函数&#x2F;)</p>
<p><strong>下一篇</strong>：[MySQL 进阶教程 05-01 事务概述](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 05-01 事务概述&#x2F;)</p>
<p><strong>窗口函数系列完结</strong></p>
]]></content>
      <categories>
        <category>MySQL 进阶教程</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>窗口函数</tag>
        <tag>实战案例</tag>
        <tag>连续登录</tag>
        <tag>TopN</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 进阶教程 04-06 NTILE 分桶函数</title>
    <url>/2026/02/24/MySQL%20%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B%2004-06%20NTILE%20%E5%88%86%E6%A1%B6%E5%87%BD%E6%95%B0/</url>
    <content><![CDATA[<h1 id="MySQL-进阶教程-04-06-NTILE-分桶函数"><a href="#MySQL-进阶教程-04-06-NTILE-分桶函数" class="headerlink" title="MySQL 进阶教程 04-06 NTILE 分桶函数"></a>MySQL 进阶教程 04-06 NTILE 分桶函数</h1><p>NTILE 函数用于将有序数据分成指定数量的组（桶），常用于排名分组、百分位计算等场景。本文将详细讲解 NTILE 函数的使用方法。</p>
<h2 id="一、NTILE-函数基础"><a href="#一、NTILE-函数基础" class="headerlink" title="一、NTILE 函数基础"></a>一、NTILE 函数基础</h2><h3 id="1-1-函数语法"><a href="#1-1-函数语法" class="headerlink" title="1.1 函数语法"></a>1.1 函数语法</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NTILE</span>(n) <span class="keyword">OVER</span> (</span><br><span class="line">    [<span class="keyword">PARTITION</span> <span class="keyword">BY</span> 列名]</span><br><span class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span> 列名</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><strong>参数说明</strong>：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>n</td>
<td>要分成的桶数量（正整数）</td>
</tr>
</tbody></table>
<p><strong>返回值</strong>：</p>
<ul>
<li>返回 1 到 n 之间的整数</li>
<li>表示该行所属的桶编号</li>
</ul>
<h3 id="1-2-测试数据准备"><a href="#1-2-测试数据准备" class="headerlink" title="1.2 测试数据准备"></a>1.2 测试数据准备</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 准备学生成绩数据</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> scores;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> scores (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    student_name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    subject <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    score <span class="type">INT</span> <span class="keyword">NOT NULL</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> scores (student_name, subject, score) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;张三&#x27;</span>, <span class="string">&#x27;数学&#x27;</span>, <span class="number">85</span>),</span><br><span class="line">(<span class="string">&#x27;李四&#x27;</span>, <span class="string">&#x27;数学&#x27;</span>, <span class="number">92</span>),</span><br><span class="line">(<span class="string">&#x27;王五&#x27;</span>, <span class="string">&#x27;数学&#x27;</span>, <span class="number">78</span>),</span><br><span class="line">(<span class="string">&#x27;赵六&#x27;</span>, <span class="string">&#x27;数学&#x27;</span>, <span class="number">95</span>),</span><br><span class="line">(<span class="string">&#x27;孙七&#x27;</span>, <span class="string">&#x27;数学&#x27;</span>, <span class="number">88</span>),</span><br><span class="line">(<span class="string">&#x27;周八&#x27;</span>, <span class="string">&#x27;数学&#x27;</span>, <span class="number">72</span>),</span><br><span class="line">(<span class="string">&#x27;吴九&#x27;</span>, <span class="string">&#x27;数学&#x27;</span>, <span class="number">91</span>),</span><br><span class="line">(<span class="string">&#x27;郑十&#x27;</span>, <span class="string">&#x27;数学&#x27;</span>, <span class="number">83</span>),</span><br><span class="line">(<span class="string">&#x27;王十一&#x27;</span>, <span class="string">&#x27;数学&#x27;</span>, <span class="number">89</span>),</span><br><span class="line">(<span class="string">&#x27;刘十二&#x27;</span>, <span class="string">&#x27;数学&#x27;</span>, <span class="number">95</span>);</span><br></pre></td></tr></table></figure>

<h3 id="1-3-基础示例"><a href="#1-3-基础示例" class="headerlink" title="1.3 基础示例"></a>1.3 基础示例</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 将学生按成绩分成 4 个组（四分位）</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    student_name,</span><br><span class="line">    score,</span><br><span class="line">    <span class="built_in">NTILE</span>(<span class="number">4</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> score <span class="keyword">DESC</span>) <span class="keyword">AS</span> quartile</span><br><span class="line"><span class="keyword">FROM</span> scores</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> score <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：</span></span><br><span class="line"><span class="comment">student_name | score | quartile</span></span><br><span class="line"><span class="comment">-------------+-------+---------</span></span><br><span class="line"><span class="comment">赵六          | 95    | 1</span></span><br><span class="line"><span class="comment">刘十二        | 95    | 1</span></span><br><span class="line"><span class="comment">李四          | 92    | 1</span></span><br><span class="line"><span class="comment">吴九          | 91    | 2</span></span><br><span class="line"><span class="comment">王十一        | 89    | 2</span></span><br><span class="line"><span class="comment">孙七          | 88    | 2</span></span><br><span class="line"><span class="comment">张三          | 85    | 3</span></span><br><span class="line"><span class="comment">郑十          | 83    | 3</span></span><br><span class="line"><span class="comment">王五          | 78    | 4</span></span><br><span class="line"><span class="comment">周八          | 72    | 4</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>解释</strong>：</p>
<ul>
<li>10 个学生分成 4 组</li>
<li>每组约 2-3 人</li>
<li>桶编号从 1 开始（1 表示最高分组）</li>
</ul>
<h2 id="二、NTILE-分配规则"><a href="#二、NTILE-分配规则" class="headerlink" title="二、NTILE 分配规则"></a>二、NTILE 分配规则</h2><h3 id="2-1-均匀分配"><a href="#2-1-均匀分配" class="headerlink" title="2.1 均匀分配"></a>2.1 均匀分配</h3><p>当数据能被桶数整除时，每个桶的行数相同。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 10 个学生分成 5 组（每组 2 人）</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    student_name,</span><br><span class="line">    score,</span><br><span class="line">    <span class="built_in">NTILE</span>(<span class="number">5</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> score <span class="keyword">DESC</span>) <span class="keyword">AS</span> quintile</span><br><span class="line"><span class="keyword">FROM</span> scores</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> score <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：</span></span><br><span class="line"><span class="comment">student_name | score | quintile</span></span><br><span class="line"><span class="comment">-------------+-------+---------</span></span><br><span class="line"><span class="comment">赵六          | 95    | 1</span></span><br><span class="line"><span class="comment">刘十二        | 95    | 1</span></span><br><span class="line"><span class="comment">李四          | 92    | 2</span></span><br><span class="line"><span class="comment">吴九          | 91    | 2</span></span><br><span class="line"><span class="comment">王十一        | 89    | 3</span></span><br><span class="line"><span class="comment">孙七          | 88    | 3</span></span><br><span class="line"><span class="comment">张三          | 85    | 4</span></span><br><span class="line"><span class="comment">郑十          | 83    | 4</span></span><br><span class="line"><span class="comment">王五          | 78    | 5</span></span><br><span class="line"><span class="comment">周八          | 72    | 5</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-不能整除的情况"><a href="#2-2-不能整除的情况" class="headerlink" title="2.2 不能整除的情况"></a>2.2 不能整除的情况</h3><p>当数据不能被桶数整除时，<strong>前面的桶会多分配一行</strong>。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 10 个学生分成 3 组（3, 3, 4 或 4, 3, 3？）</span></span><br><span class="line"><span class="comment">-- 答案：前面的桶多分配，所以是 4, 3, 3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    student_name,</span><br><span class="line">    score,</span><br><span class="line">    <span class="built_in">NTILE</span>(<span class="number">3</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> score <span class="keyword">DESC</span>) <span class="keyword">AS</span> tercile</span><br><span class="line"><span class="keyword">FROM</span> scores</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> score <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：</span></span><br><span class="line"><span class="comment">student_name | score | tercile</span></span><br><span class="line"><span class="comment">-------------+-------+--------</span></span><br><span class="line"><span class="comment">赵六          | 95    | 1</span></span><br><span class="line"><span class="comment">刘十二        | 95    | 1</span></span><br><span class="line"><span class="comment">李四          | 92    | 1</span></span><br><span class="line"><span class="comment">吴九          | 91    | 1       ← 第 1 桶有 4 人</span></span><br><span class="line"><span class="comment">王十一        | 89    | 2</span></span><br><span class="line"><span class="comment">孙七          | 88    | 2</span></span><br><span class="line"><span class="comment">张三          | 85    | 2       ← 第 2 桶有 3 人</span></span><br><span class="line"><span class="comment">郑十          | 83    | 3</span></span><br><span class="line"><span class="comment">王五          | 78    | 3</span></span><br><span class="line"><span class="comment">周八          | 72    | 3       ← 第 3 桶有 3 人</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-桶数多于数据行数"><a href="#2-3-桶数多于数据行数" class="headerlink" title="2.3 桶数多于数据行数"></a>2.3 桶数多于数据行数</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 10 个学生分成 15 组（有些组为空）</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    student_name,</span><br><span class="line">    score,</span><br><span class="line">    <span class="built_in">NTILE</span>(<span class="number">15</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> score <span class="keyword">DESC</span>) <span class="keyword">AS</span> bucket</span><br><span class="line"><span class="keyword">FROM</span> scores</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> score <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：前 10 个桶各有 1 人，后 5 个桶为空</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h2 id="三、分组内分桶"><a href="#三、分组内分桶" class="headerlink" title="三、分组内分桶"></a>三、分组内分桶</h2><h3 id="3-1-按科目分组"><a href="#3-1-按科目分组" class="headerlink" title="3.1 按科目分组"></a>3.1 按科目分组</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 准备多科目数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> scores (student_name, subject, score) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;张三&#x27;</span>, <span class="string">&#x27;英语&#x27;</span>, <span class="number">78</span>),</span><br><span class="line">(<span class="string">&#x27;李四&#x27;</span>, <span class="string">&#x27;英语&#x27;</span>, <span class="number">85</span>),</span><br><span class="line">(<span class="string">&#x27;王五&#x27;</span>, <span class="string">&#x27;英语&#x27;</span>, <span class="number">92</span>),</span><br><span class="line">(<span class="string">&#x27;赵六&#x27;</span>, <span class="string">&#x27;英语&#x27;</span>, <span class="number">88</span>),</span><br><span class="line">(<span class="string">&#x27;孙七&#x27;</span>, <span class="string">&#x27;英语&#x27;</span>, <span class="number">91</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 按科目分组，组内分成 3 个桶</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    student_name,</span><br><span class="line">    subject,</span><br><span class="line">    score,</span><br><span class="line">    <span class="built_in">NTILE</span>(<span class="number">3</span>) <span class="keyword">OVER</span>(</span><br><span class="line">        <span class="keyword">PARTITION</span> <span class="keyword">BY</span> subject</span><br><span class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> score <span class="keyword">DESC</span></span><br><span class="line">    ) <span class="keyword">AS</span> tertile</span><br><span class="line"><span class="keyword">FROM</span> scores</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> subject, score <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：</span></span><br><span class="line"><span class="comment">数学组（10 人分成 3 组：4, 3, 3）</span></span><br><span class="line"><span class="comment">英语组（5 人分成 3 组：2, 2, 1）</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h2 id="四、实战案例"><a href="#四、实战案例" class="headerlink" title="四、实战案例"></a>四、实战案例</h2><h3 id="4-1-四分位排名（Quartile-Ranking）"><a href="#4-1-四分位排名（Quartile-Ranking）" class="headerlink" title="4.1 四分位排名（Quartile Ranking）"></a>4.1 四分位排名（Quartile Ranking）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 将员工工资分成 4 个等级</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> employees;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> employees (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    dept_id <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    salary <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">NOT NULL</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> employees (name, dept_id, salary) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;张三&#x27;</span>, <span class="number">1</span>, <span class="number">8000</span>), (<span class="string">&#x27;李四&#x27;</span>, <span class="number">1</span>, <span class="number">10000</span>), (<span class="string">&#x27;王五&#x27;</span>, <span class="number">1</span>, <span class="number">12000</span>),</span><br><span class="line">(<span class="string">&#x27;赵六&#x27;</span>, <span class="number">1</span>, <span class="number">6000</span>), (<span class="string">&#x27;孙七&#x27;</span>, <span class="number">1</span>, <span class="number">9000</span>), (<span class="string">&#x27;周八&#x27;</span>, <span class="number">1</span>, <span class="number">11000</span>),</span><br><span class="line">(<span class="string">&#x27;吴九&#x27;</span>, <span class="number">1</span>, <span class="number">7000</span>), (<span class="string">&#x27;郑十&#x27;</span>, <span class="number">1</span>, <span class="number">8500</span>), (<span class="string">&#x27;王十一&#x27;</span>, <span class="number">1</span>, <span class="number">9500</span>),</span><br><span class="line">(<span class="string">&#x27;刘十二&#x27;</span>, <span class="number">1</span>, <span class="number">10500</span>), (<span class="string">&#x27;陈十三&#x27;</span>, <span class="number">1</span>, <span class="number">7500</span>), (<span class="string">&#x27;杨十四&#x27;</span>, <span class="number">1</span>, <span class="number">11500</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    name,</span><br><span class="line">    salary,</span><br><span class="line">    <span class="built_in">NTILE</span>(<span class="number">4</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>) <span class="keyword">AS</span> salary_quartile,</span><br><span class="line">    <span class="keyword">CASE</span> <span class="built_in">NTILE</span>(<span class="number">4</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>)</span><br><span class="line">        <span class="keyword">WHEN</span> <span class="number">1</span> <span class="keyword">THEN</span> <span class="string">&#x27;高收入&#x27;</span></span><br><span class="line">        <span class="keyword">WHEN</span> <span class="number">2</span> <span class="keyword">THEN</span> <span class="string">&#x27;中高收入&#x27;</span></span><br><span class="line">        <span class="keyword">WHEN</span> <span class="number">3</span> <span class="keyword">THEN</span> <span class="string">&#x27;中低收入&#x27;</span></span><br><span class="line">        <span class="keyword">WHEN</span> <span class="number">4</span> <span class="keyword">THEN</span> <span class="string">&#x27;低收入&#x27;</span></span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">AS</span> salary_level</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-百分位计算（Percentile）"><a href="#4-2-百分位计算（Percentile）" class="headerlink" title="4.2 百分位计算（Percentile）"></a>4.2 百分位计算（Percentile）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 计算每个学生的百分位排名（前百分之多少）</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    student_name,</span><br><span class="line">    score,</span><br><span class="line">    <span class="built_in">NTILE</span>(<span class="number">100</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> score <span class="keyword">DESC</span>) <span class="keyword">AS</span> percentile,</span><br><span class="line">    CONCAT(</span><br><span class="line">        <span class="string">&#x27;前 &#x27;</span>,</span><br><span class="line">        <span class="built_in">NTILE</span>(<span class="number">100</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> score <span class="keyword">DESC</span>),</span><br><span class="line">        <span class="string">&#x27;%&#x27;</span></span><br><span class="line">    ) <span class="keyword">AS</span> percentile_label</span><br><span class="line"><span class="keyword">FROM</span> scores</span><br><span class="line"><span class="keyword">WHERE</span> subject <span class="operator">=</span> <span class="string">&#x27;数学&#x27;</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> score <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：</span></span><br><span class="line"><span class="comment">student_name | score | percentile | percentile_label</span></span><br><span class="line"><span class="comment">-------------+-------+------------+-----------------</span></span><br><span class="line"><span class="comment">赵六          | 95    | 1          | 前 1%</span></span><br><span class="line"><span class="comment">刘十二        | 95    | 1          | 前 1%</span></span><br><span class="line"><span class="comment">李四          | 92    | 2          | 前 2%</span></span><br><span class="line"><span class="comment">...</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="4-3-Top-Bottom-分析"><a href="#4-3-Top-Bottom-分析" class="headerlink" title="4.3 Top&#x2F;Bottom 分析"></a>4.3 Top&#x2F;Bottom 分析</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 找出前 20% 和后 20% 的员工</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WITH</span> employee_buckets <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        name,</span><br><span class="line">        salary,</span><br><span class="line">        <span class="built_in">NTILE</span>(<span class="number">5</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>) <span class="keyword">AS</span> quintile</span><br><span class="line">    <span class="keyword">FROM</span> employees</span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    name,</span><br><span class="line">    salary,</span><br><span class="line">    <span class="keyword">CASE</span> quintile</span><br><span class="line">        <span class="keyword">WHEN</span> <span class="number">1</span> <span class="keyword">THEN</span> <span class="string">&#x27;Top 20%&#x27;</span></span><br><span class="line">        <span class="keyword">WHEN</span> <span class="number">5</span> <span class="keyword">THEN</span> <span class="string">&#x27;Bottom 20%&#x27;</span></span><br><span class="line">        <span class="keyword">ELSE</span> <span class="string">&#x27;Middle 60%&#x27;</span></span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">AS</span> salary_group</span><br><span class="line"><span class="keyword">FROM</span> employee_buckets</span><br><span class="line"><span class="keyword">WHERE</span> quintile <span class="keyword">IN</span> (<span class="number">1</span>, <span class="number">5</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h3 id="4-4-成绩等级划分"><a href="#4-4-成绩等级划分" class="headerlink" title="4.4 成绩等级划分"></a>4.4 成绩等级划分</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 将成绩分成 5 个等级（A/B/C/D/E）</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WITH</span> grade_buckets <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        student_name,</span><br><span class="line">        subject,</span><br><span class="line">        score,</span><br><span class="line">        <span class="built_in">NTILE</span>(<span class="number">5</span>) <span class="keyword">OVER</span>(</span><br><span class="line">            <span class="keyword">PARTITION</span> <span class="keyword">BY</span> subject</span><br><span class="line">            <span class="keyword">ORDER</span> <span class="keyword">BY</span> score <span class="keyword">DESC</span></span><br><span class="line">        ) <span class="keyword">AS</span> grade_group</span><br><span class="line">    <span class="keyword">FROM</span> scores</span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    student_name,</span><br><span class="line">    subject,</span><br><span class="line">    score,</span><br><span class="line">    <span class="keyword">CASE</span> grade_group</span><br><span class="line">        <span class="keyword">WHEN</span> <span class="number">1</span> <span class="keyword">THEN</span> <span class="string">&#x27;A&#x27;</span></span><br><span class="line">        <span class="keyword">WHEN</span> <span class="number">2</span> <span class="keyword">THEN</span> <span class="string">&#x27;B&#x27;</span></span><br><span class="line">        <span class="keyword">WHEN</span> <span class="number">3</span> <span class="keyword">THEN</span> <span class="string">&#x27;C&#x27;</span></span><br><span class="line">        <span class="keyword">WHEN</span> <span class="number">4</span> <span class="keyword">THEN</span> <span class="string">&#x27;D&#x27;</span></span><br><span class="line">        <span class="keyword">WHEN</span> <span class="number">5</span> <span class="keyword">THEN</span> <span class="string">&#x27;E&#x27;</span></span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">AS</span> grade</span><br><span class="line"><span class="keyword">FROM</span> grade_buckets</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> subject, score <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h3 id="4-5-销售团队分组"><a href="#4-5-销售团队分组" class="headerlink" title="4.5 销售团队分组"></a>4.5 销售团队分组</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 将销售人员分成金牌、银牌、铜牌团队</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> sales_reps;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> sales_reps (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    sales_amount <span class="type">DECIMAL</span>(<span class="number">12</span>, <span class="number">2</span>) <span class="keyword">NOT NULL</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> sales_reps (name, sales_amount) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;张三&#x27;</span>, <span class="number">150000</span>), (<span class="string">&#x27;李四&#x27;</span>, <span class="number">180000</span>), (<span class="string">&#x27;王五&#x27;</span>, <span class="number">120000</span>),</span><br><span class="line">(<span class="string">&#x27;赵六&#x27;</span>, <span class="number">200000</span>), (<span class="string">&#x27;孙七&#x27;</span>, <span class="number">160000</span>), (<span class="string">&#x27;周八&#x27;</span>, <span class="number">140000</span>),</span><br><span class="line">(<span class="string">&#x27;吴九&#x27;</span>, <span class="number">190000</span>), (<span class="string">&#x27;郑十&#x27;</span>, <span class="number">110000</span>), (<span class="string">&#x27;王十一&#x27;</span>, <span class="number">170000</span>),</span><br><span class="line">(<span class="string">&#x27;刘十二&#x27;</span>, <span class="number">130000</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">WITH</span> sales_buckets <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        name,</span><br><span class="line">        sales_amount,</span><br><span class="line">        <span class="built_in">NTILE</span>(<span class="number">3</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> sales_amount <span class="keyword">DESC</span>) <span class="keyword">AS</span> team</span><br><span class="line">    <span class="keyword">FROM</span> sales_reps</span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    name,</span><br><span class="line">    sales_amount,</span><br><span class="line">    <span class="keyword">CASE</span> team</span><br><span class="line">        <span class="keyword">WHEN</span> <span class="number">1</span> <span class="keyword">THEN</span> <span class="string">&#x27;金牌团队&#x27;</span></span><br><span class="line">        <span class="keyword">WHEN</span> <span class="number">2</span> <span class="keyword">THEN</span> <span class="string">&#x27;银牌团队&#x27;</span></span><br><span class="line">        <span class="keyword">WHEN</span> <span class="number">3</span> <span class="keyword">THEN</span> <span class="string">&#x27;铜牌团队&#x27;</span></span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">AS</span> team_name</span><br><span class="line"><span class="keyword">FROM</span> sales_buckets</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> sales_amount <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h3 id="4-6-客户价值分层"><a href="#4-6-客户价值分层" class="headerlink" title="4.6 客户价值分层"></a>4.6 客户价值分层</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 将客户按消费金额分成 VIP、普通、潜力三层</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> customers;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> customers (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    total_spent <span class="type">DECIMAL</span>(<span class="number">12</span>, <span class="number">2</span>) <span class="keyword">NOT NULL</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> customers (name, total_spent) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;客户 A&#x27;</span>, <span class="number">5000</span>), (<span class="string">&#x27;客户 B&#x27;</span>, <span class="number">15000</span>), (<span class="string">&#x27;客户 C&#x27;</span>, <span class="number">8000</span>),</span><br><span class="line">(<span class="string">&#x27;客户 D&#x27;</span>, <span class="number">25000</span>), (<span class="string">&#x27;客户 E&#x27;</span>, <span class="number">12000</span>), (<span class="string">&#x27;客户 F&#x27;</span>, <span class="number">3000</span>),</span><br><span class="line">(<span class="string">&#x27;客户 G&#x27;</span>, <span class="number">18000</span>), (<span class="string">&#x27;客户 H&#x27;</span>, <span class="number">10000</span>), (<span class="string">&#x27;客户 I&#x27;</span>, <span class="number">22000</span>),</span><br><span class="line">(<span class="string">&#x27;客户 J&#x27;</span>, <span class="number">7000</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">WITH</span> customer_segments <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        name,</span><br><span class="line">        total_spent,</span><br><span class="line">        <span class="built_in">NTILE</span>(<span class="number">3</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> total_spent <span class="keyword">DESC</span>) <span class="keyword">AS</span> segment</span><br><span class="line">    <span class="keyword">FROM</span> customers</span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    name,</span><br><span class="line">    total_spent,</span><br><span class="line">    <span class="keyword">CASE</span> segment</span><br><span class="line">        <span class="keyword">WHEN</span> <span class="number">1</span> <span class="keyword">THEN</span> <span class="string">&#x27;VIP 客户&#x27;</span></span><br><span class="line">        <span class="keyword">WHEN</span> <span class="number">2</span> <span class="keyword">THEN</span> <span class="string">&#x27;普通客户&#x27;</span></span><br><span class="line">        <span class="keyword">WHEN</span> <span class="number">3</span> <span class="keyword">THEN</span> <span class="string">&#x27;潜力客户&#x27;</span></span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">AS</span> customer_type</span><br><span class="line"><span class="keyword">FROM</span> customer_segments</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> total_spent <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h2 id="五、NTILE-与其他排名函数对比"><a href="#五、NTILE-与其他排名函数对比" class="headerlink" title="五、NTILE 与其他排名函数对比"></a>五、NTILE 与其他排名函数对比</h2><h3 id="5-1-四种函数对比"><a href="#5-1-四种函数对比" class="headerlink" title="5.1 四种函数对比"></a>5.1 四种函数对比</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 对比 NTILE、ROW_NUMBER、RANK、DENSE_RANK</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    student_name,</span><br><span class="line">    score,</span><br><span class="line">    <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> score <span class="keyword">DESC</span>) <span class="keyword">AS</span> row_num,</span><br><span class="line">    <span class="built_in">RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> score <span class="keyword">DESC</span>) <span class="keyword">AS</span> rank,</span><br><span class="line">    <span class="built_in">DENSE_RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> score <span class="keyword">DESC</span>) <span class="keyword">AS</span> dense_rank,</span><br><span class="line">    <span class="built_in">NTILE</span>(<span class="number">4</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> score <span class="keyword">DESC</span>) <span class="keyword">AS</span> ntile_4</span><br><span class="line"><span class="keyword">FROM</span> scores</span><br><span class="line"><span class="keyword">WHERE</span> subject <span class="operator">=</span> <span class="string">&#x27;数学&#x27;</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> score <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果对比：</span></span><br><span class="line"><span class="comment">student_name | score | row_num | rank | dense_rank | ntile_4</span></span><br><span class="line"><span class="comment">-------------+-------+---------+------+------------+--------</span></span><br><span class="line"><span class="comment">赵六          | 95    | 1       | 1    | 1          | 1</span></span><br><span class="line"><span class="comment">刘十二        | 95    | 2       | 1    | 1          | 1</span></span><br><span class="line"><span class="comment">李四          | 92    | 3       | 3    | 2          | 1</span></span><br><span class="line"><span class="comment">吴九          | 91    | 4       | 4    | 3          | 2</span></span><br><span class="line"><span class="comment">...</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-函数选择建议"><a href="#5-2-函数选择建议" class="headerlink" title="5.2 函数选择建议"></a>5.2 函数选择建议</h3><table>
<thead>
<tr>
<th>函数</th>
<th>特点</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td>ROW_NUMBER</td>
<td>连续编号</td>
<td>Top N、去重</td>
</tr>
<tr>
<td>RANK</td>
<td>跳跃排名</td>
<td>比赛排名</td>
</tr>
<tr>
<td>DENSE_RANK</td>
<td>密集排名</td>
<td>连续排名</td>
</tr>
<tr>
<td>NTILE</td>
<td>均匀分组</td>
<td>分层、分桶、百分位</td>
</tr>
</tbody></table>
<h2 id="六、性能优化建议"><a href="#六、性能优化建议" class="headerlink" title="六、性能优化建议"></a>六、性能优化建议</h2><h3 id="6-1-添加适当索引"><a href="#6-1-添加适当索引" class="headerlink" title="6.1 添加适当索引"></a>6.1 添加适当索引</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 为 NTILE 的 ORDER BY 列添加索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_score <span class="keyword">ON</span> scores(subject, score <span class="keyword">DESC</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 为 PARTITION BY + ORDER BY 添加复合索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_dept_salary <span class="keyword">ON</span> employees(dept_id, salary <span class="keyword">DESC</span>);</span><br></pre></td></tr></table></figure>

<h3 id="6-2-避免过大的桶数"><a href="#6-2-避免过大的桶数" class="headerlink" title="6.2 避免过大的桶数"></a>6.2 避免过大的桶数</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 不推荐：桶数过大，失去分组意义</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">NTILE</span>(<span class="number">1000</span>) <span class="keyword">OVER</span>(...) <span class="keyword">FROM</span> large_table;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 推荐：根据数据量选择合适的桶数</span></span><br><span class="line"><span class="comment">-- 一般 3-10 个桶足够</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">NTILE</span>(<span class="number">4</span>) <span class="keyword">OVER</span>(...) <span class="keyword">FROM</span> <span class="keyword">table</span>;</span><br></pre></td></tr></table></figure>

<h2 id="七、综合练习"><a href="#七、综合练习" class="headerlink" title="七、综合练习"></a>七、综合练习</h2><h3 id="练习-1：计算中位数"><a href="#练习-1：计算中位数" class="headerlink" title="练习 1：计算中位数"></a>练习 1：计算中位数</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 使用 NTILE 找出中位数（第 50 百分位）</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WITH</span> percentile_data <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        score,</span><br><span class="line">        <span class="built_in">NTILE</span>(<span class="number">100</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> score) <span class="keyword">AS</span> percentile</span><br><span class="line">    <span class="keyword">FROM</span> scores</span><br><span class="line">    <span class="keyword">WHERE</span> subject <span class="operator">=</span> <span class="string">&#x27;数学&#x27;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">AVG</span>(score) <span class="keyword">AS</span> median_score</span><br><span class="line"><span class="keyword">FROM</span> percentile_data</span><br><span class="line"><span class="keyword">WHERE</span> percentile <span class="keyword">BETWEEN</span> <span class="number">49</span> <span class="keyword">AND</span> <span class="number">51</span>;</span><br></pre></td></tr></table></figure>

<h3 id="练习-2：每个部门的工资分层"><a href="#练习-2：每个部门的工资分层" class="headerlink" title="练习 2：每个部门的工资分层"></a>练习 2：每个部门的工资分层</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 每个部门内按工资分成高、中、低三层</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WITH</span> dept_salary_tiers <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        name,</span><br><span class="line">        dept_id,</span><br><span class="line">        salary,</span><br><span class="line">        <span class="built_in">NTILE</span>(<span class="number">3</span>) <span class="keyword">OVER</span>(</span><br><span class="line">            <span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_id</span><br><span class="line">            <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span></span><br><span class="line">        ) <span class="keyword">AS</span> tier</span><br><span class="line">    <span class="keyword">FROM</span> employees</span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    name,</span><br><span class="line">    dept_id,</span><br><span class="line">    salary,</span><br><span class="line">    <span class="keyword">CASE</span> tier</span><br><span class="line">        <span class="keyword">WHEN</span> <span class="number">1</span> <span class="keyword">THEN</span> <span class="string">&#x27;高&#x27;</span></span><br><span class="line">        <span class="keyword">WHEN</span> <span class="number">2</span> <span class="keyword">THEN</span> <span class="string">&#x27;中&#x27;</span></span><br><span class="line">        <span class="keyword">WHEN</span> <span class="number">3</span> <span class="keyword">THEN</span> <span class="string">&#x27;低&#x27;</span></span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">AS</span> salary_tier</span><br><span class="line"><span class="keyword">FROM</span> dept_salary_tiers</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> dept_id, salary <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h3 id="练习-3：识别异常值"><a href="#练习-3：识别异常值" class="headerlink" title="练习 3：识别异常值"></a>练习 3：识别异常值</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 找出最高和最低 10% 的销售人员</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WITH</span> sales_percentiles <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        name,</span><br><span class="line">        sales_amount,</span><br><span class="line">        <span class="built_in">NTILE</span>(<span class="number">10</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> sales_amount <span class="keyword">DESC</span>) <span class="keyword">AS</span> decile</span><br><span class="line">    <span class="keyword">FROM</span> sales_reps</span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    name,</span><br><span class="line">    sales_amount,</span><br><span class="line">    <span class="keyword">CASE</span></span><br><span class="line">        <span class="keyword">WHEN</span> decile <span class="operator">=</span> <span class="number">1</span> <span class="keyword">THEN</span> <span class="string">&#x27;Top 10% - 明星销售&#x27;</span></span><br><span class="line">        <span class="keyword">WHEN</span> decile <span class="operator">=</span> <span class="number">10</span> <span class="keyword">THEN</span> <span class="string">&#x27;Bottom 10% - 需改进&#x27;</span></span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">AS</span> performance_flag</span><br><span class="line"><span class="keyword">FROM</span> sales_percentiles</span><br><span class="line"><span class="keyword">WHERE</span> decile <span class="keyword">IN</span> (<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> sales_amount <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h2 id="八、小结"><a href="#八、小结" class="headerlink" title="八、小结"></a>八、小结</h2><h3 id="核心知识点"><a href="#核心知识点" class="headerlink" title="核心知识点"></a>核心知识点</h3><ol>
<li><p><strong>NTILE 函数语法</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NTILE</span>(n) <span class="keyword">OVER</span>([<span class="keyword">PARTITION</span> <span class="keyword">BY</span>] <span class="keyword">ORDER</span> <span class="keyword">BY</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>分配规则</strong></p>
<ul>
<li>均匀分配：数据能被桶数整除时，每组相同</li>
<li>不能整除：前面的桶多分配一行</li>
</ul>
</li>
<li><p><strong>典型应用</strong></p>
<ul>
<li>四分位分析（NTILE(4)）</li>
<li>五分位分析（NTILE(5)）</li>
<li>百分位计算（NTILE(100)）</li>
<li>客户分层、成绩等级</li>
</ul>
</li>
</ol>
<h3 id="常用分桶数量"><a href="#常用分桶数量" class="headerlink" title="常用分桶数量"></a>常用分桶数量</h3><table>
<thead>
<tr>
<th>桶数</th>
<th>名称</th>
<th>应用场景</th>
</tr>
</thead>
<tbody><tr>
<td>2</td>
<td>二分位</td>
<td>前 50% &#x2F; 后 50%</td>
</tr>
<tr>
<td>3</td>
<td>三分位</td>
<td>上&#x2F;中&#x2F;下</td>
</tr>
<tr>
<td>4</td>
<td>四分位</td>
<td>quartile 分析</td>
</tr>
<tr>
<td>5</td>
<td>五分位</td>
<td>A&#x2F;B&#x2F;C&#x2F;D&#x2F;E 等级</td>
</tr>
<tr>
<td>10</td>
<td>十分位</td>
<td>精细分层</td>
</tr>
<tr>
<td>100</td>
<td>百分位</td>
<td>百分位排名</td>
</tr>
</tbody></table>
<h3 id="下一章预告"><a href="#下一章预告" class="headerlink" title="下一章预告"></a>下一章预告</h3><p>下一篇文章将带来<strong>窗口函数实战案例</strong>，综合运用所学知识解决实际问题，包括：</p>
<ul>
<li>连续登录问题</li>
<li>Top N 问题综合解法</li>
<li>累计分析实战</li>
<li>复杂报表生成</li>
</ul>
<hr>
<p><strong>下一篇</strong>：[MySQL 进阶教程 04-07 窗口函数实战案例](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 04-07 窗口函数实战案例&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 进阶教程 04-05 窗口框架详解](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 04-05 窗口框架详解&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 进阶教程</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>窗口函数</tag>
        <tag>NTILE</tag>
        <tag>分桶</tag>
        <tag>百分位</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 进阶教程 05-01 事务详解</title>
    <url>/2026/02/23/MySQL%20%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B%2005-01%20%E4%BA%8B%E5%8A%A1%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<h1 id="MySQL-进阶教程-05-01-事务详解"><a href="#MySQL-进阶教程-05-01-事务详解" class="headerlink" title="MySQL 进阶教程 05-01 事务详解"></a>MySQL 进阶教程 05-01 事务详解</h1><p>事务是数据库管理的核心技术之一，用于保证数据的完整性和一致性。本文将详细讲解事务的概念、ACID 特性、并发问题以及隔离级别。</p>
<h2 id="一、事务简介"><a href="#一、事务简介" class="headerlink" title="一、事务简介"></a>一、事务简介</h2><h3 id="1-1-什么是事务？"><a href="#1-1-什么是事务？" class="headerlink" title="1.1 什么是事务？"></a>1.1 什么是事务？</h3><p><strong>事务（Transaction）</strong> 是数据库管理系统执行过程中的一个逻辑单位，由一个有限的数据库操作序列构成。这些操作要么全部成功执行，要么全部不执行，是一个不可分割的工作单位。</p>
<h3 id="1-2-事务的特点"><a href="#1-2-事务的特点" class="headerlink" title="1.2 事务的特点"></a>1.2 事务的特点</h3><ol>
<li><strong>原子性</strong>：事务是一个不可分割的操作序列</li>
<li><strong>一致性</strong>：事务执行前后，数据保持一致</li>
<li><strong>独立性</strong>：多个事务并发执行时互不干扰</li>
<li><strong>持久性</strong>：事务一旦提交，修改永久保存</li>
</ol>
<h3 id="1-3-事务的使用场景"><a href="#1-3-事务的使用场景" class="headerlink" title="1.3 事务的使用场景"></a>1.3 事务的使用场景</h3><table>
<thead>
<tr>
<th>场景</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>银行转账</td>
<td>A 转给 B 钱，A 扣款和 B 收款必须同时成功或失败</td>
</tr>
<tr>
<td>订单创建</td>
<td>创建订单、扣减库存、生成物流单必须同时成功</td>
</tr>
<tr>
<td>批量操作</td>
<td>批量导入数据，要么全部导入成功，要么全部回滚</td>
</tr>
<tr>
<td>数据一致性</td>
<td>更新多个关联表时保持一致性</td>
</tr>
</tbody></table>
<h3 id="1-4-不使用事务的问题"><a href="#1-4-不使用事务的问题" class="headerlink" title="1.4 不使用事务的问题"></a>1.4 不使用事务的问题</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 不使用事务的转账操作</span></span><br><span class="line"><span class="comment">-- 步骤 1：A 账户扣款</span></span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">-</span> <span class="number">100</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 假设这里系统故障或断电...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 步骤 2：B 账户收款（可能永远不会执行）</span></span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">+</span> <span class="number">100</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果：A 的钱扣了，但 B 没收到，数据不一致！</span></span><br></pre></td></tr></table></figure>

<h2 id="二、事务操作演示"><a href="#二、事务操作演示" class="headerlink" title="二、事务操作演示"></a>二、事务操作演示</h2><h3 id="2-1-事务控制语句"><a href="#2-1-事务控制语句" class="headerlink" title="2.1 事务控制语句"></a>2.1 事务控制语句</h3><table>
<thead>
<tr>
<th>语句</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>START TRANSACTION &#x2F; BEGIN</td>
<td>开启事务</td>
</tr>
<tr>
<td>COMMIT</td>
<td>提交事务</td>
</tr>
<tr>
<td>ROLLBACK</td>
<td>回滚事务</td>
</tr>
<tr>
<td>SAVEPOINT</td>
<td>设置保存点</td>
</tr>
<tr>
<td>ROLLBACK TO SAVEPOINT</td>
<td>回滚到保存点</td>
</tr>
<tr>
<td>SET autocommit &#x3D; 0&#x2F;1</td>
<td>设置自动提交</td>
</tr>
</tbody></table>
<h3 id="2-2-准备测试数据"><a href="#2-2-准备测试数据" class="headerlink" title="2.2 准备测试数据"></a>2.2 准备测试数据</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建账户表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> accounts;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> accounts (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    account_name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    balance <span class="type">DECIMAL</span>(<span class="number">12</span>, <span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="number">0</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入测试数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> accounts (account_name, balance) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;张三&#x27;</span>, <span class="number">10000</span>),</span><br><span class="line">(<span class="string">&#x27;李四&#x27;</span>, <span class="number">5000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看初始数据</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> accounts;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-基础事务操作"><a href="#2-3-基础事务操作" class="headerlink" title="2.3 基础事务操作"></a>2.3 基础事务操作</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看自动提交状态</span></span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@autocommit</span>;  <span class="comment">-- 1 表示开启，0 表示关闭</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 开启事务</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="comment">-- 或</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 执行 DML 操作</span></span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">-</span> <span class="number">100</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">+</span> <span class="number">100</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看临时结果（当前会话可见）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> accounts;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 提交事务（使更改永久生效）</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 再次查看（其他会话也可见）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> accounts;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-事务回滚"><a href="#2-4-事务回滚" class="headerlink" title="2.4 事务回滚"></a>2.4 事务回滚</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 开启事务</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 执行操作</span></span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">-</span> <span class="number">1000</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">+</span> <span class="number">1000</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 发现问题，回滚事务</span></span><br><span class="line"><span class="keyword">ROLLBACK</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 数据恢复原状</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> accounts;</span><br></pre></td></tr></table></figure>

<h3 id="2-5-保存点（SAVEPOINT）"><a href="#2-5-保存点（SAVEPOINT）" class="headerlink" title="2.5 保存点（SAVEPOINT）"></a>2.5 保存点（SAVEPOINT）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 开启事务</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 操作 1</span></span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">-</span> <span class="number">100</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置保存点</span></span><br><span class="line"><span class="keyword">SAVEPOINT</span> sp1;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 操作 2</span></span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">-</span> <span class="number">200</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置保存点</span></span><br><span class="line"><span class="keyword">SAVEPOINT</span> sp2;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 操作 3（假设出错了）</span></span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">-</span> <span class="number">300</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 回滚到保存点 sp2（撤销操作 3）</span></span><br><span class="line"><span class="keyword">ROLLBACK</span> <span class="keyword">TO</span> sp2;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 回滚到保存点 sp1（撤销操作 2 和 3）</span></span><br><span class="line"><span class="keyword">ROLLBACK</span> <span class="keyword">TO</span> sp1;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 提交事务（只有操作 1 生效）</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 释放保存点</span></span><br><span class="line"><span class="keyword">RELEASE</span> <span class="keyword">SAVEPOINT</span> sp1;</span><br></pre></td></tr></table></figure>

<h3 id="2-6-自动提交控制"><a href="#2-6-自动提交控制" class="headerlink" title="2.6 自动提交控制"></a>2.6 自动提交控制</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看自动提交状态</span></span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@autocommit</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 关闭自动提交（之后所有操作都在事务中）</span></span><br><span class="line"><span class="keyword">SET</span> autocommit <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 执行操作（不会自动提交）</span></span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">-</span> <span class="number">100</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 手动提交</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 开启自动提交</span></span><br><span class="line"><span class="keyword">SET</span> autocommit <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h2 id="三、事务的-ACID-特性"><a href="#三、事务的-ACID-特性" class="headerlink" title="三、事务的 ACID 特性"></a>三、事务的 ACID 特性</h2><h3 id="3-1-原子性（Atomicity）"><a href="#3-1-原子性（Atomicity）" class="headerlink" title="3.1 原子性（Atomicity）"></a>3.1 原子性（Atomicity）</h3><p><strong>原子性</strong> 指事务是一个不可分割的最小工作单位，事务中的操作要么全部成功，要么全部失败。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 原子性演示</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"></span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">-</span> <span class="number">100</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 假设这里发生错误（如除零、违反约束等）</span></span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">/</span> <span class="number">0</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">2</span>;  <span class="comment">-- 错误！</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 由于发生错误，整个事务会自动回滚</span></span><br><span class="line"><span class="comment">-- 操作 1 也会被撤销</span></span><br><span class="line"><span class="keyword">ROLLBACK</span>;  <span class="comment">-- 或者让 MySQL 自动回滚</span></span><br></pre></td></tr></table></figure>

<p><strong>原子性的实现</strong>：通过 undo log（回滚日志）实现。</p>
<h3 id="3-2-一致性（Consistency）"><a href="#3-2-一致性（Consistency）" class="headerlink" title="3.2 一致性（Consistency）"></a>3.2 一致性（Consistency）</h3><p><strong>一致性</strong> 指事务执行前后，数据必须保持一致状态，满足所有约束、触发器等规则。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 一致性演示</span></span><br><span class="line"><span class="comment">-- 假设有检查约束：balance &gt;= 0</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"></span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">-</span> <span class="number">20000</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 如果余额不足，违反约束，事务会回滚</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 一致性确保：</span></span><br><span class="line"><span class="comment">-- 1. 所有约束都被满足</span></span><br><span class="line"><span class="comment">-- 2. 所有触发器都被触发</span></span><br><span class="line"><span class="comment">-- 3. 外键约束被维护</span></span><br><span class="line"><span class="comment">-- 4. 数据逻辑一致</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>

<p><strong>一致性的实现</strong>：原子性和持久性保证数据不丢失，隔离性保证并发一致。</p>
<h3 id="3-3-隔离性（Isolation）"><a href="#3-3-隔离性（Isolation）" class="headerlink" title="3.3 隔离性（Isolation）"></a>3.3 隔离性（Isolation）</h3><p><strong>隔离性</strong> 指多个事务并发执行时，一个事务的执行不应影响其他事务。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 会话 A</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">SELECT</span> balance <span class="keyword">FROM</span> accounts <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;  <span class="comment">-- 10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 B（同时）</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">-</span> <span class="number">100</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 A（再次查询）</span></span><br><span class="line"><span class="keyword">SELECT</span> balance <span class="keyword">FROM</span> accounts <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 不同隔离级别下结果可能不同</span></span><br></pre></td></tr></table></figure>

<p><strong>隔离性的实现</strong>：通过锁机制和 MVCC（多版本并发控制）实现。</p>
<h3 id="3-4-持久性（Durability）"><a href="#3-4-持久性（Durability）" class="headerlink" title="3.4 持久性（Durability）"></a>3.4 持久性（Durability）</h3><p><strong>持久性</strong> 指事务一旦提交，对数据的修改是永久的，即使系统故障也不会丢失。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">-</span> <span class="number">100</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">COMMIT</span>;  <span class="comment">-- 提交后，即使立即断电，数据也不会丢失</span></span><br></pre></td></tr></table></figure>

<p><strong>持久性的实现</strong>：通过 redo log（重做日志）实现。</p>
<h2 id="四、并发事务问题"><a href="#四、并发事务问题" class="headerlink" title="四、并发事务问题"></a>四、并发事务问题</h2><h3 id="4-1-并发事务场景"><a href="#4-1-并发事务场景" class="headerlink" title="4.1 并发事务场景"></a>4.1 并发事务场景</h3><p>当多个事务同时访问同一数据时，可能产生以下问题：</p>
<table>
<thead>
<tr>
<th>问题</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>脏读（Dirty Read）</td>
<td>读到其他事务未提交的数据</td>
</tr>
<tr>
<td>不可重复读（Non-repeatable Read）</td>
<td>同一事务中多次读取结果不一致</td>
</tr>
<tr>
<td>幻读（Phantom Read）</td>
<td>同一事务中多次查询，记录数不一致</td>
</tr>
</tbody></table>
<h3 id="4-2-脏读（Dirty-Read）"><a href="#4-2-脏读（Dirty-Read）" class="headerlink" title="4.2 脏读（Dirty Read）"></a>4.2 脏读（Dirty Read）</h3><p><strong>脏读</strong> 是指一个事务读取了另一个事务未提交的修改。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 会话 A</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">-</span> <span class="number">100</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 尚未提交</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 B</span></span><br><span class="line"><span class="keyword">SELECT</span> balance <span class="keyword">FROM</span> accounts <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 读到了 A 未提交的修改（脏读）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 A 回滚</span></span><br><span class="line"><span class="keyword">ROLLBACK</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果：会话 B 读到的数据是无效的</span></span><br></pre></td></tr></table></figure>

<h3 id="4-3-不可重复读（Non-repeatable-Read）"><a href="#4-3-不可重复读（Non-repeatable-Read）" class="headerlink" title="4.3 不可重复读（Non-repeatable Read）"></a>4.3 不可重复读（Non-repeatable Read）</h3><p><strong>不可重复读</strong> 是指在同一事务中，多次读取同一数据得到不同结果。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 会话 A</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">SELECT</span> balance <span class="keyword">FROM</span> accounts <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;  <span class="comment">-- 10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 B</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> <span class="number">9900</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 A</span></span><br><span class="line"><span class="keyword">SELECT</span> balance <span class="keyword">FROM</span> accounts <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;  <span class="comment">-- 9900（与第一次不同）</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果：同一事务中两次读取结果不同</span></span><br></pre></td></tr></table></figure>

<p><strong>与脏读的区别</strong>：不可重复读读到的是已提交的数据，但不是预期的结果。</p>
<h3 id="4-4-幻读（Phantom-Read）"><a href="#4-4-幻读（Phantom-Read）" class="headerlink" title="4.4 幻读（Phantom Read）"></a>4.4 幻读（Phantom Read）</h3><p><strong>幻读</strong> 是指在同一事务中，多次查询同一范围的数据，记录数不一致。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 会话 A</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> accounts <span class="keyword">WHERE</span> balance <span class="operator">&gt;</span> <span class="number">5000</span>;  <span class="comment">-- 返回 2 条</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 B</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">INSERT INTO</span> accounts (account_name, balance) <span class="keyword">VALUES</span> (<span class="string">&#x27;王五&#x27;</span>, <span class="number">6000</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 A</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> accounts <span class="keyword">WHERE</span> balance <span class="operator">&gt;</span> <span class="number">5000</span>;  <span class="comment">-- 返回 3 条（多出 1 条）</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果：同一事务中两次查询记录数不同</span></span><br></pre></td></tr></table></figure>

<h3 id="4-5-三种问题对比"><a href="#4-5-三种问题对比" class="headerlink" title="4.5 三种问题对比"></a>4.5 三种问题对比</h3><table>
<thead>
<tr>
<th>问题</th>
<th>原因</th>
<th>表现</th>
</tr>
</thead>
<tbody><tr>
<td>脏读</td>
<td>读到未提交数据</td>
<td>数据无效</td>
</tr>
<tr>
<td>不可重复读</td>
<td>读到已提交更新</td>
<td>值变化</td>
</tr>
<tr>
<td>幻读</td>
<td>读到已提交插入</td>
<td>记录数变化</td>
</tr>
</tbody></table>
<h2 id="五、并发事务演示及隔离级别"><a href="#五、并发事务演示及隔离级别" class="headerlink" title="五、并发事务演示及隔离级别"></a>五、并发事务演示及隔离级别</h2><h3 id="5-1-事务隔离级别"><a href="#5-1-事务隔离级别" class="headerlink" title="5.1 事务隔离级别"></a>5.1 事务隔离级别</h3><p>SQL 标准定义了四种隔离级别，从低到高：</p>
<table>
<thead>
<tr>
<th>隔离级别</th>
<th>脏读</th>
<th>不可重复读</th>
<th>幻读</th>
</tr>
</thead>
<tbody><tr>
<td>READ UNCOMMITTED（读未提交）</td>
<td>可能</td>
<td>可能</td>
<td>可能</td>
</tr>
<tr>
<td>READ COMMITTED（读已提交）</td>
<td>否</td>
<td>可能</td>
<td>可能</td>
</tr>
<tr>
<td>REPEATABLE READ（可重复读）</td>
<td>否</td>
<td>否</td>
<td>可能*</td>
</tr>
<tr>
<td>SERIALIZABLE（串行化）</td>
<td>否</td>
<td>否</td>
<td>否</td>
</tr>
</tbody></table>
<p>*MySQL InnoDB 通过 MVCC 在 REPEATABLE READ 级别避免了幻读</p>
<h3 id="5-2-查看和设置隔离级别"><a href="#5-2-查看和设置隔离级别" class="headerlink" title="5.2 查看和设置隔离级别"></a>5.2 查看和设置隔离级别</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看当前会话隔离级别</span></span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@transaction_isolation</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看全局隔离级别</span></span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@global</span>.transaction_isolation;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置会话隔离级别（只影响当前会话）</span></span><br><span class="line"><span class="keyword">SET</span> SESSION TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;</span><br><span class="line"><span class="keyword">SET</span> SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;</span><br><span class="line"><span class="keyword">SET</span> SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;  <span class="comment">-- MySQL 默认</span></span><br><span class="line"><span class="keyword">SET</span> SESSION TRANSACTION ISOLATION LEVEL SERIALIZABLE;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置全局隔离级别（影响新会话）</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> TRANSACTION ISOLATION LEVEL READ COMMITTED;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在事务开始前设置</span></span><br><span class="line"><span class="keyword">SET</span> TRANSACTION ISOLATION LEVEL SERIALIZABLE;</span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-READ-UNCOMMITTED-演示"><a href="#5-3-READ-UNCOMMITTED-演示" class="headerlink" title="5.3 READ UNCOMMITTED 演示"></a>5.3 READ UNCOMMITTED 演示</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 设置隔离级别为读未提交</span></span><br><span class="line"><span class="keyword">SET</span> SESSION TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 A</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">-</span> <span class="number">100</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 不提交</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 B</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">SELECT</span> balance <span class="keyword">FROM</span> accounts <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;  <span class="comment">-- 读到未提交的值（脏读）</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 A 回滚</span></span><br><span class="line"><span class="keyword">ROLLBACK</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果：会话 B 读到的数据是无效的</span></span><br></pre></td></tr></table></figure>

<h3 id="5-4-READ-COMMITTED-演示"><a href="#5-4-READ-COMMITTED-演示" class="headerlink" title="5.4 READ COMMITTED 演示"></a>5.4 READ COMMITTED 演示</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 设置隔离级别为读已提交</span></span><br><span class="line"><span class="keyword">SET</span> SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 A</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">SELECT</span> balance <span class="keyword">FROM</span> accounts <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;  <span class="comment">-- 10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 B</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> <span class="number">9900</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">COMMIT</span>;  <span class="comment">-- 提交</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 A</span></span><br><span class="line"><span class="keyword">SELECT</span> balance <span class="keyword">FROM</span> accounts <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;  <span class="comment">-- 9900（不可重复读）</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果：避免脏读，但出现不可重复读</span></span><br></pre></td></tr></table></figure>

<h3 id="5-5-REPEATABLE-READ-演示（MySQL-默认）"><a href="#5-5-REPEATABLE-READ-演示（MySQL-默认）" class="headerlink" title="5.5 REPEATABLE READ 演示（MySQL 默认）"></a>5.5 REPEATABLE READ 演示（MySQL 默认）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 设置隔离级别为可重复读</span></span><br><span class="line"><span class="keyword">SET</span> SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 A</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">SELECT</span> balance <span class="keyword">FROM</span> accounts <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;  <span class="comment">-- 10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 B</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> <span class="number">9900</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 A</span></span><br><span class="line"><span class="keyword">SELECT</span> balance <span class="keyword">FROM</span> accounts <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;  <span class="comment">-- 10000（仍然是原值）</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果：避免脏读和不可重复读</span></span><br></pre></td></tr></table></figure>

<p><strong>InnoDB 的 MVCC</strong>：</p>
<ul>
<li>InnoDB 在 REPEATABLE READ 级别下使用 MVCC 避免幻读</li>
<li>通过读取历史版本实现可重复读</li>
</ul>
<h3 id="5-6-SERIALIZABLE-演示"><a href="#5-6-SERIALIZABLE-演示" class="headerlink" title="5.6 SERIALIZABLE 演示"></a>5.6 SERIALIZABLE 演示</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 设置隔离级别为串行化</span></span><br><span class="line"><span class="keyword">SET</span> SESSION TRANSACTION ISOLATION LEVEL SERIALIZABLE;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 A</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> accounts <span class="keyword">WHERE</span> balance <span class="operator">&gt;</span> <span class="number">5000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 B（会被阻塞，直到 A 提交）</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">INSERT INTO</span> accounts (account_name, balance) <span class="keyword">VALUES</span> (<span class="string">&#x27;王五&#x27;</span>, <span class="number">6000</span>);</span><br><span class="line"><span class="comment">-- 等待...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 A</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 B 现在可以执行</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果：完全串行执行，性能最差</span></span><br></pre></td></tr></table></figure>

<h3 id="5-7-隔离级别选择建议"><a href="#5-7-隔离级别选择建议" class="headerlink" title="5.7 隔离级别选择建议"></a>5.7 隔离级别选择建议</h3><table>
<thead>
<tr>
<th>隔离级别</th>
<th>适用场景</th>
<th>性能</th>
</tr>
</thead>
<tbody><tr>
<td>READ UNCOMMITTED</td>
<td>几乎不用，统计数据等对一致性要求低的场景</td>
<td>最高</td>
</tr>
<tr>
<td>READ COMMITTED</td>
<td>Oracle 默认，大多数场景足够</td>
<td>较高</td>
</tr>
<tr>
<td>REPEATABLE READ</td>
<td>MySQL 默认，适合需要可重复读的场景</td>
<td>中等</td>
</tr>
<tr>
<td>SERIALIZABLE</td>
<td>对一致性要求极高，并发低的场景</td>
<td>最低</td>
</tr>
</tbody></table>
<p><strong>推荐</strong>：</p>
<ul>
<li>一般应用：使用默认的 REPEATABLE READ</li>
<li>高并发场景：可以考虑 READ COMMITTED</li>
<li>特殊场景：根据需求调整</li>
</ul>
<h2 id="六、锁机制"><a href="#六、锁机制" class="headerlink" title="六、锁机制"></a>六、锁机制</h2><h3 id="6-1-锁的类型"><a href="#6-1-锁的类型" class="headerlink" title="6.1 锁的类型"></a>6.1 锁的类型</h3><table>
<thead>
<tr>
<th>锁类型</th>
<th>说明</th>
<th>特点</th>
</tr>
</thead>
<tbody><tr>
<td>共享锁（S 锁）</td>
<td>读锁</td>
<td>多个事务可同时持有</td>
</tr>
<tr>
<td>排他锁（X 锁）</td>
<td>写锁</td>
<td>只能有一个事务持有</td>
</tr>
<tr>
<td>意向锁</td>
<td>表级锁</td>
<td>表明事务要在某行上加锁</td>
</tr>
</tbody></table>
<h3 id="6-2-显式加锁"><a href="#6-2-显式加锁" class="headerlink" title="6.2 显式加锁"></a>6.2 显式加锁</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 共享锁（读锁）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> accounts <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span> LOCK <span class="keyword">IN</span> SHARE MODE;</span><br><span class="line"><span class="comment">-- MySQL 8.0+ 语法</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> accounts <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">FOR</span> SHARE;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 排他锁（写锁）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> accounts <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 跳过已锁定的行</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> accounts <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span> <span class="keyword">SKIP</span> LOCKED;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 不等待锁（立即返回错误）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> accounts <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span> NOWAIT;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-查看锁信息"><a href="#6-3-查看锁信息" class="headerlink" title="6.3 查看锁信息"></a>6.3 查看锁信息</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看正在执行的事务</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.innodb_trx;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看锁信息</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.innodb_locks;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看锁等待情况</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.innodb_lock_waits;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看进程列表</span></span><br><span class="line"><span class="keyword">SHOW</span> PROCESSLIST;</span><br></pre></td></tr></table></figure>

<h2 id="七、事务最佳实践"><a href="#七、事务最佳实践" class="headerlink" title="七、事务最佳实践"></a>七、事务最佳实践</h2><h3 id="7-1-事务使用建议"><a href="#7-1-事务使用建议" class="headerlink" title="7.1 事务使用建议"></a>7.1 事务使用建议</h3><ol>
<li><strong>保持事务简短</strong></li>
</ol>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 不好：事务太长，占用资源</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">SELECT</span> ...;</span><br><span class="line"><span class="keyword">UPDATE</span> ...;</span><br><span class="line"><span class="keyword">SELECT</span> ...;</span><br><span class="line"><span class="keyword">UPDATE</span> ...;</span><br><span class="line"><span class="comment">-- 很多操作...</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 好：只包含必要的操作</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">UPDATE</span> ...;</span><br><span class="line"><span class="keyword">UPDATE</span> ...;</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>避免在事务中等待用户输入</strong></li>
</ol>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 不好</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">-</span> <span class="number">100</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 等待用户确认...（事务长时间不提交）</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 好：快速提交，异步处理</span></span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">-</span> <span class="number">100</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 异步发送确认邮件等</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li><strong>处理死锁</strong></li>
</ol>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 应用层捕获死锁异常并重试</span></span><br><span class="line">try &#123;</span><br><span class="line">    <span class="operator">/</span><span class="operator">/</span> 执行事务</span><br><span class="line">&#125; catch (DeadlockException e) &#123;</span><br><span class="line">    <span class="operator">/</span><span class="operator">/</span> 重试逻辑</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-2-转账事务完整示例"><a href="#7-2-转账事务完整示例" class="headerlink" title="7.2 转账事务完整示例"></a>7.2 转账事务完整示例</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> transfer_money(</span><br><span class="line">    <span class="keyword">IN</span> from_id <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">IN</span> to_id <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">IN</span> amount <span class="type">DECIMAL</span>(<span class="number">12</span>, <span class="number">2</span>)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> from_balance <span class="type">DECIMAL</span>(<span class="number">12</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> EXIT HANDLER <span class="keyword">FOR</span> <span class="keyword">SQLEXCEPTION</span></span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">        <span class="keyword">ROLLBACK</span>;</span><br><span class="line">        <span class="keyword">SELECT</span> <span class="string">&#x27;Transfer failed&#x27;</span> <span class="keyword">AS</span> <span class="keyword">result</span>;</span><br><span class="line">    <span class="keyword">END</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">START</span> TRANSACTION;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 锁定账户（防止并发修改）</span></span><br><span class="line">    <span class="keyword">SELECT</span> balance <span class="keyword">INTO</span> from_balance</span><br><span class="line">    <span class="keyword">FROM</span> accounts <span class="keyword">WHERE</span> id <span class="operator">=</span> from_id</span><br><span class="line">    <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 检查余额</span></span><br><span class="line">    IF from_balance <span class="operator">&lt;</span> amount <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">ROLLBACK</span>;</span><br><span class="line">        <span class="keyword">SELECT</span> <span class="string">&#x27;Insufficient balance&#x27;</span> <span class="keyword">AS</span> <span class="keyword">result</span>;</span><br><span class="line">    <span class="keyword">ELSE</span></span><br><span class="line">        <span class="comment">-- 扣款</span></span><br><span class="line">        <span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">-</span> amount</span><br><span class="line">        <span class="keyword">WHERE</span> id <span class="operator">=</span> from_id;</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- 收款</span></span><br><span class="line">        <span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">+</span> amount</span><br><span class="line">        <span class="keyword">WHERE</span> id <span class="operator">=</span> to_id;</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- 记录日志</span></span><br><span class="line">        <span class="keyword">INSERT INTO</span> transfer_logs (from_id, to_id, amount, create_time)</span><br><span class="line">        <span class="keyword">VALUES</span> (from_id, to_id, amount, NOW());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">COMMIT</span>;</span><br><span class="line">        <span class="keyword">SELECT</span> <span class="string">&#x27;Transfer success&#x27;</span> <span class="keyword">AS</span> <span class="keyword">result</span>;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 调用</span></span><br><span class="line"><span class="keyword">CALL</span> transfer_money(<span class="number">1</span>, <span class="number">2</span>, <span class="number">100</span>);</span><br></pre></td></tr></table></figure>

<h2 id="八、小结"><a href="#八、小结" class="headerlink" title="八、小结"></a>八、小结</h2><h3 id="事务知识点回顾"><a href="#事务知识点回顾" class="headerlink" title="事务知识点回顾"></a>事务知识点回顾</h3><ol>
<li><p><strong>事务控制语句</strong></p>
<ul>
<li>START TRANSACTION &#x2F; BEGIN：开启事务</li>
<li>COMMIT：提交事务</li>
<li>ROLLBACK：回滚事务</li>
<li>SAVEPOINT：设置保存点</li>
</ul>
</li>
<li><p><strong>ACID 特性</strong></p>
<ul>
<li>原子性：不可分割</li>
<li>一致性：数据一致</li>
<li>隔离性：互不干扰</li>
<li>持久性：永久保存</li>
</ul>
</li>
<li><p><strong>并发问题</strong></p>
<ul>
<li>脏读：读未提交数据</li>
<li>不可重复读：值变化</li>
<li>幻读：记录数变化</li>
</ul>
</li>
<li><p><strong>隔离级别</strong></p>
<ul>
<li>READ UNCOMMITTED</li>
<li>READ COMMITTED</li>
<li>REPEATABLE READ（MySQL 默认）</li>
<li>SERIALIZABLE</li>
</ul>
</li>
</ol>
<h3 id="隔离级别对比表"><a href="#隔离级别对比表" class="headerlink" title="隔离级别对比表"></a>隔离级别对比表</h3><table>
<thead>
<tr>
<th>隔离级别</th>
<th>脏读</th>
<th>不可重复读</th>
<th>幻读</th>
<th>性能</th>
</tr>
</thead>
<tbody><tr>
<td>READ UNCOMMITTED</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>最高</td>
</tr>
<tr>
<td>READ COMMITTED</td>
<td>✗</td>
<td>✓</td>
<td>✓</td>
<td>较高</td>
</tr>
<tr>
<td>REPEATABLE READ</td>
<td>✗</td>
<td>✗</td>
<td>✗*</td>
<td>中等</td>
</tr>
<tr>
<td>SERIALIZABLE</td>
<td>✗</td>
<td>✗</td>
<td>✗</td>
<td>最低</td>
</tr>
</tbody></table>
<p>*MySQL InnoDB 通过 MVCC 避免幻读</p>
<h3 id="实际应用建议"><a href="#实际应用建议" class="headerlink" title="实际应用建议"></a>实际应用建议</h3><ol>
<li>使用默认的 REPEATABLE READ 隔离级别</li>
<li>保持事务简短，避免长时间持有锁</li>
<li>处理可能的死锁情况</li>
<li>对于高并发场景，可以考虑 READ COMMITTED</li>
<li>使用合适的索引减少锁竞争</li>
</ol>
<hr>
<p><strong>下一篇</strong>：[MySQL 进阶教程 06-01 存储引擎详解](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 06-01 存储引擎详解&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 进阶教程 04-07 窗口函数实战案例](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 04-07 窗口函数实战案例&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 进阶教程</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>事务</tag>
        <tag>ACID</tag>
        <tag>并发控制</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 进阶教程 06-01 存储引擎详解</title>
    <url>/2026/02/24/MySQL%20%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B%2006-01%20%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<h1 id="MySQL-进阶教程-06-01-存储引擎详解"><a href="#MySQL-进阶教程-06-01-存储引擎详解" class="headerlink" title="MySQL 进阶教程 06-01 存储引擎详解"></a>MySQL 进阶教程 06-01 存储引擎详解</h1><p>存储引擎是 MySQL 的核心组件之一，决定了数据的存储方式和访问特性。本文将详细介绍 MySQL 的存储引擎架构和常用引擎的特点。</p>
<h2 id="一、存储引擎概述"><a href="#一、存储引擎概述" class="headerlink" title="一、存储引擎概述"></a>一、存储引擎概述</h2><h3 id="1-1-什么是存储引擎？"><a href="#1-1-什么是存储引擎？" class="headerlink" title="1.1 什么是存储引擎？"></a>1.1 什么是存储引擎？</h3><p><strong>存储引擎（Storage Engine）</strong> 是 MySQL 中负责数据存储、提取和管理的底层组件。MySQL 采用插件式存储引擎架构，可以根据需求选择不同的引擎。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MySQL 架构简图：</span><br><span class="line">┌─────────────────────────────────────┐</span><br><span class="line">│         SQL 接口（查询解析）          │</span><br><span class="line">├─────────────────────────────────────┤</span><br><span class="line">│         查询优化器                   │</span><br><span class="line">├─────────────────────────────────────┤</span><br><span class="line">│     存储引擎层（插件式架构）           │</span><br><span class="line">│  ┌─────────┬─────────┬─────────┐    │</span><br><span class="line">│  │ InnoDB  │ MyISAM  │ Memory  │    │</span><br><span class="line">│  └─────────┴─────────┴─────────┘    │</span><br><span class="line">└─────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="1-2-存储引擎的作用"><a href="#1-2-存储引擎的作用" class="headerlink" title="1.2 存储引擎的作用"></a>1.2 存储引擎的作用</h3><ul>
<li><strong>数据存储</strong>：决定数据如何在磁盘上组织</li>
<li><strong>索引管理</strong>：提供不同的索引结构</li>
<li><strong>事务支持</strong>：决定是否支持事务</li>
<li><strong>锁机制</strong>：提供不同粒度的锁</li>
<li><strong>缓存管理</strong>：决定数据和索引的缓存策略</li>
</ul>
<h2 id="二、MySQL-体系结构"><a href="#二、MySQL-体系结构" class="headerlink" title="二、MySQL 体系结构"></a>二、MySQL 体系结构</h2><h3 id="2-1-三层架构"><a href="#2-1-三层架构" class="headerlink" title="2.1 三层架构"></a>2.1 三层架构</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">┌─────────────────────────────────────┐</span><br><span class="line">│   连接层：连接处理、授权认证、安全    │</span><br><span class="line">├─────────────────────────────────────┤</span><br><span class="line">│   SQL 层：SQL 接口、解析器、优化器     │</span><br><span class="line">│        缓存、内置函数、存储过程等      │</span><br><span class="line">├─────────────────────────────────────┤</span><br><span class="line">│   引擎层：存储引擎（负责数据存取）     │</span><br><span class="line">└─────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="2-2-存储引擎层特点"><a href="#2-2-存储引擎层特点" class="headerlink" title="2.2 存储引擎层特点"></a>2.2 存储引擎层特点</h3><ol>
<li><strong>插件式设计</strong>：可以动态加载&#x2F;卸载存储引擎</li>
<li><strong>独立管理</strong>：每个引擎独立管理自己的数据和索引</li>
<li><strong>统一接口</strong>：所有引擎通过统一接口与 SQL 层交互</li>
</ol>
<h2 id="三、查看存储引擎"><a href="#三、查看存储引擎" class="headerlink" title="三、查看存储引擎"></a>三、查看存储引擎</h2><h3 id="3-1-查看所有可用引擎"><a href="#3-1-查看所有可用引擎" class="headerlink" title="3.1 查看所有可用引擎"></a>3.1 查看所有可用引擎</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看所有存储引擎</span></span><br><span class="line"><span class="keyword">SHOW</span> ENGINES;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果示例：</span></span><br><span class="line"><span class="comment">-- Engine      | Support  | Comment</span></span><br><span class="line"><span class="comment">-- ------------+----------+----------------------------------</span></span><br><span class="line"><span class="comment">-- InnoDB      | DEFAULT  | Supports transactions, row-level locking, and foreign keys</span></span><br><span class="line"><span class="comment">-- MyISAM      | YES      | MyISAM storage engine</span></span><br><span class="line"><span class="comment">-- Memory      | YES      | Hash based, stored in memory, useful for temporary tables</span></span><br><span class="line"><span class="comment">-- Archive     | YES      | Archive storage engine</span></span><br><span class="line"><span class="comment">-- CSV         | YES      | CSV storage engine</span></span><br></pre></td></tr></table></figure>

<p><strong>Support 列说明</strong>：</p>
<ul>
<li><code>DEFAULT</code>：默认引擎</li>
<li><code>YES</code>：支持</li>
<li><code>NO</code>：不支持</li>
<li><code>DISABLED</code>：已禁用</li>
</ul>
<h3 id="3-2-查看表的引擎"><a href="#3-2-查看表的引擎" class="headerlink" title="3.2 查看表的引擎"></a>3.2 查看表的引擎</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看表的创建信息（包含引擎）</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE TABLE</span> table_name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看表状态（包含引擎）</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">TABLE</span> STATUS <span class="keyword">WHERE</span> Name <span class="operator">=</span> <span class="string">&#x27;table_name&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 从 information_schema 查询</span></span><br><span class="line"><span class="keyword">SELECT</span> table_name, engine</span><br><span class="line"><span class="keyword">FROM</span> information_schema.tables</span><br><span class="line"><span class="keyword">WHERE</span> table_schema <span class="operator">=</span> <span class="string">&#x27;your_database&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-修改表的引擎"><a href="#3-3-修改表的引擎" class="headerlink" title="3.3 修改表的引擎"></a>3.3 修改表的引擎</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 修改表的存储引擎</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> table_name ENGINE <span class="operator">=</span> InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 示例：将 MyISAM 表转为 InnoDB</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> users ENGINE <span class="operator">=</span> InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 验证修改</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">TABLE</span> STATUS <span class="keyword">WHERE</span> Name <span class="operator">=</span> <span class="string">&#x27;users&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="四、InnoDB-引擎"><a href="#四、InnoDB-引擎" class="headerlink" title="四、InnoDB 引擎"></a>四、InnoDB 引擎</h2><h3 id="4-1-InnoDB-简介"><a href="#4-1-InnoDB-简介" class="headerlink" title="4.1 InnoDB 简介"></a>4.1 InnoDB 简介</h3><p><strong>InnoDB</strong> 是 MySQL 的默认存储引擎，由 Oracle 公司开发，是事务安全型（transaction-safe）的存储引擎。</p>
<p><strong>适用场景</strong>：</p>
<ul>
<li>需要事务支持的应用</li>
<li>高并发读写场景</li>
<li>需要外键约束</li>
<li>需要行级锁</li>
</ul>
<h3 id="4-2-InnoDB-核心特性"><a href="#4-2-InnoDB-核心特性" class="headerlink" title="4.2 InnoDB 核心特性"></a>4.2 InnoDB 核心特性</h3><table>
<thead>
<tr>
<th>特性</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>事务支持</td>
<td>支持 ACID 事务，提供 COMMIT、ROLLBACK</td>
</tr>
<tr>
<td>行级锁</td>
<td>支持行级锁，提高并发性能</td>
</tr>
<tr>
<td>外键</td>
<td>支持外键约束，保证数据一致性</td>
</tr>
<tr>
<td>MVCC</td>
<td>多版本并发控制，提高读性能</td>
</tr>
<tr>
<td>聚簇索引</td>
<td>数据和索引存储在一起</td>
</tr>
<tr>
<td>崩溃恢复</td>
<td>自动崩溃恢复，保证数据完整性</td>
</tr>
</tbody></table>
<h3 id="4-3-InnoDB-配置参数"><a href="#4-3-InnoDB-配置参数" class="headerlink" title="4.3 InnoDB 配置参数"></a>4.3 InnoDB 配置参数</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看 InnoDB 配置</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;innodb%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 常用参数：</span></span><br><span class="line"><span class="comment">-- innodb_buffer_pool_size: 缓冲池大小（建议为物理内存的 70-80%）</span></span><br><span class="line"><span class="comment">-- innodb_log_file_size: 日志文件大小</span></span><br><span class="line"><span class="comment">-- innodb_flush_log_at_trx_commit: 日志刷盘策略</span></span><br><span class="line"><span class="comment">-- innodb_file_per_table: 是否每表一个表空间</span></span><br></pre></td></tr></table></figure>

<h2 id="五、MyISAM-引擎"><a href="#五、MyISAM-引擎" class="headerlink" title="五、MyISAM 引擎"></a>五、MyISAM 引擎</h2><h3 id="5-1-MyISAM-简介"><a href="#5-1-MyISAM-简介" class="headerlink" title="5.1 MyISAM 简介"></a>5.1 MyISAM 简介</h3><p><strong>MyISAM</strong> 是 MySQL 5.5 之前的默认存储引擎，由 MySQL AB 开发。</p>
<p><strong>适用场景</strong>：</p>
<ul>
<li>读多写少的场景</li>
<li>不需要事务支持</li>
<li>全文索引（5.6 之前只有 MyISAM 支持）</li>
<li>数据仓库&#x2F;报表系统</li>
</ul>
<h3 id="5-2-MyISAM-核心特性"><a href="#5-2-MyISAM-核心特性" class="headerlink" title="5.2 MyISAM 核心特性"></a>5.2 MyISAM 核心特性</h3><table>
<thead>
<tr>
<th>特性</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>不支持事务</td>
<td>不提供事务支持</td>
</tr>
<tr>
<td>表级锁</td>
<td>锁粒度为表级，并发性能较差</td>
</tr>
<tr>
<td>不支持外键</td>
<td>不支持外键约束</td>
</tr>
<tr>
<td>非聚簇索引</td>
<td>索引和数据分开存储</td>
</tr>
<tr>
<td>COUNT(*) 优化</td>
<td>保存了表的行数，COUNT(*) 很快</td>
</tr>
<tr>
<td>全文索引</td>
<td>支持全文索引</td>
</tr>
</tbody></table>
<h3 id="5-3-MyISAM-文件结构"><a href="#5-3-MyISAM-文件结构" class="headerlink" title="5.3 MyISAM 文件结构"></a>5.3 MyISAM 文件结构</h3><p>MyISAM 表由三个文件组成：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">table_name.frm  - 表结构定义</span><br><span class="line">table_name.MYD  - 数据文件（MYData）</span><br><span class="line">table_name.MYI  - 索引文件（MYIndex）</span><br></pre></td></tr></table></figure>

<h2 id="六、Memory-引擎"><a href="#六、Memory-引擎" class="headerlink" title="六、Memory 引擎"></a>六、Memory 引擎</h2><h3 id="6-1-Memory-简介"><a href="#6-1-Memory-简介" class="headerlink" title="6.1 Memory 简介"></a>6.1 Memory 简介</h3><p><strong>Memory</strong> 引擎将数据存储在内存中，适用于临时表或高速缓存场景。</p>
<p><strong>适用场景</strong>：</p>
<ul>
<li>临时表&#x2F;中间结果</li>
<li>高速缓存</li>
<li>会话分析</li>
<li>需要快速访问的数据</li>
</ul>
<h3 id="6-2-Memory-特性"><a href="#6-2-Memory-特性" class="headerlink" title="6.2 Memory 特性"></a>6.2 Memory 特性</h3><table>
<thead>
<tr>
<th>特性</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>存储在内存</td>
<td>数据存储在内存中，速度快</td>
</tr>
<tr>
<td>数据易失</td>
<td>重启后数据丢失</td>
</tr>
<tr>
<td>表级锁</td>
<td>锁粒度为表级</td>
</tr>
<tr>
<td>不支持 TEXT&#x2F;BLOB</td>
<td>不支持大字段类型</td>
</tr>
<tr>
<td>默认 Hash 索引</td>
<td>只支持 Hash 索引（5.7+ 支持 B-Tree）</td>
</tr>
</tbody></table>
<h3 id="6-3-创建-Memory-表"><a href="#6-3-创建-Memory-表" class="headerlink" title="6.3 创建 Memory 表"></a>6.3 创建 Memory 表</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建 Memory 表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> temp_table (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>)</span><br><span class="line">) ENGINE <span class="operator">=</span> Memory;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用场景：临时存储中间结果</span></span><br><span class="line"><span class="keyword">CREATE</span> TEMPORARY <span class="keyword">TABLE</span> temp_result</span><br><span class="line">ENGINE <span class="operator">=</span> Memory</span><br><span class="line"><span class="keyword">AS</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> large_table <span class="keyword">WHERE</span> ...;</span><br></pre></td></tr></table></figure>

<h2 id="七、存储引擎对比"><a href="#七、存储引擎对比" class="headerlink" title="七、存储引擎对比"></a>七、存储引擎对比</h2><h3 id="7-1-功能对比"><a href="#7-1-功能对比" class="headerlink" title="7.1 功能对比"></a>7.1 功能对比</h3><table>
<thead>
<tr>
<th>特性</th>
<th>InnoDB</th>
<th>MyISAM</th>
<th>Memory</th>
</tr>
</thead>
<tbody><tr>
<td>事务支持</td>
<td>✓</td>
<td>✗</td>
<td>✗</td>
</tr>
<tr>
<td>锁粒度</td>
<td>行级</td>
<td>表级</td>
<td>表级</td>
</tr>
<tr>
<td>外键支持</td>
<td>✓</td>
<td>✗</td>
<td>✗</td>
</tr>
<tr>
<td>MVCC</td>
<td>✓</td>
<td>✗</td>
<td>✗</td>
</tr>
<tr>
<td>全文索引</td>
<td>✓ (5.6+)</td>
<td>✓</td>
<td>✗</td>
</tr>
<tr>
<td>数据持久性</td>
<td>持久</td>
<td>持久</td>
<td>易失</td>
</tr>
<tr>
<td>COUNT(*)</td>
<td>扫描表</td>
<td>直接读取</td>
<td>直接读取</td>
</tr>
</tbody></table>
<h3 id="7-2-性能对比"><a href="#7-2-性能对比" class="headerlink" title="7.2 性能对比"></a>7.2 性能对比</h3><table>
<thead>
<tr>
<th>场景</th>
<th>InnoDB</th>
<th>MyISAM</th>
<th>Memory</th>
</tr>
</thead>
<tbody><tr>
<td>大量 INSERT</td>
<td>中等</td>
<td>好</td>
<td>优秀</td>
</tr>
<tr>
<td>大量 UPDATE</td>
<td>优秀</td>
<td>差</td>
<td>优秀</td>
</tr>
<tr>
<td>大量 DELETE</td>
<td>优秀</td>
<td>差</td>
<td>优秀</td>
</tr>
<tr>
<td>SELECT COUNT(*)</td>
<td>中等</td>
<td>优秀</td>
<td>优秀</td>
</tr>
<tr>
<td>范围查询</td>
<td>优秀</td>
<td>中等</td>
<td>优秀</td>
</tr>
<tr>
<td>点查询</td>
<td>优秀</td>
<td>中等</td>
<td>优秀</td>
</tr>
</tbody></table>
<h2 id="八、存储引擎选择"><a href="#八、存储引擎选择" class="headerlink" title="八、存储引擎选择"></a>八、存储引擎选择</h2><h3 id="8-1-选择建议"><a href="#8-1-选择建议" class="headerlink" title="8.1 选择建议"></a>8.1 选择建议</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">需要事务？</span><br><span class="line">├── 是 → InnoDB</span><br><span class="line">└── 否 → 继续</span><br><span class="line">    ├── 读多写少 + COUNT 频繁？</span><br><span class="line">    │   ├── 是 → MyISAM</span><br><span class="line">    │   └── 否 → 继续</span><br><span class="line">    │</span><br><span class="line">    ├── 临时表/缓存？</span><br><span class="line">    │   ├── 是 → Memory</span><br><span class="line">    │   └── 否 → InnoDB（默认选择）</span><br></pre></td></tr></table></figure>

<h3 id="8-2-实际案例"><a href="#8-2-实际案例" class="headerlink" title="8.2 实际案例"></a>8.2 实际案例</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 用户表：需要事务和外键</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    username <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 日志表：大量 INSERT，很少 UPDATE</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> access_log (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    log_time DATETIME,</span><br><span class="line">    message TEXT</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;  <span class="comment">-- 现代场景建议统一使用 InnoDB</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 临时表：存储中间结果</span></span><br><span class="line"><span class="keyword">CREATE</span> TEMPORARY <span class="keyword">TABLE</span> temp_result (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span></span><br><span class="line">) ENGINE<span class="operator">=</span>Memory;</span><br></pre></td></tr></table></figure>

<h3 id="8-3-最佳实践"><a href="#8-3-最佳实践" class="headerlink" title="8.3 最佳实践"></a>8.3 最佳实践</h3><ol>
<li><strong>统一使用 InnoDB</strong>：除非有特殊需求，否则建议统一使用 InnoDB</li>
<li><strong>避免混用引擎</strong>：同一数据库中的表尽量使用相同引擎</li>
<li><strong>谨慎使用 MyISAM</strong>：MyISAM 在高并发下性能较差</li>
<li><strong>临时表使用 Memory</strong>：对于临时数据可以使用 Memory 引擎</li>
</ol>
<h2 id="九、小结"><a href="#九、小结" class="headerlink" title="九、小结"></a>九、小结</h2><h3 id="核心知识点"><a href="#核心知识点" class="headerlink" title="核心知识点"></a>核心知识点</h3><ol>
<li><strong>存储引擎架构</strong>：MySQL 采用插件式存储引擎架构</li>
<li><strong>InnoDB</strong>：默认引擎，支持事务、行级锁、外键</li>
<li><strong>MyISAM</strong>：读多写少场景，不支持事务</li>
<li><strong>Memory</strong>：内存存储，适用于临时表</li>
</ol>
<h3 id="引擎选择速查"><a href="#引擎选择速查" class="headerlink" title="引擎选择速查"></a>引擎选择速查</h3><table>
<thead>
<tr>
<th>需求</th>
<th>推荐引擎</th>
</tr>
</thead>
<tbody><tr>
<td>事务支持</td>
<td>InnoDB</td>
</tr>
<tr>
<td>高并发写</td>
<td>InnoDB</td>
</tr>
<tr>
<td>外键约束</td>
<td>InnoDB</td>
</tr>
<tr>
<td>只读&#x2F;读多写少</td>
<td>MyISAM</td>
</tr>
<tr>
<td>临时表</td>
<td>Memory</td>
</tr>
</tbody></table>
<h3 id="下一章预告"><a href="#下一章预告" class="headerlink" title="下一章预告"></a>下一章预告</h3><p>下一篇文章将详细介绍<strong>索引</strong>，包括：</p>
<ul>
<li>索引概述</li>
<li>B-Tree、B+Tree、Hash 索引结构</li>
<li>索引分类和语法</li>
<li>性能分析工具</li>
</ul>
<hr>
<p><strong>下一篇</strong>：[MySQL 进阶教程 07-01 索引详解](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 07-01 索引详解&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 进阶教程 05-01 事务详解](&#x2F;2026&#x2F;02&#x2F;23&#x2F;MySQL 进阶教程 05-01 事务详解&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 进阶教程</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>存储引擎</tag>
        <tag>InnoDB</tag>
        <tag>MyISAM</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 进阶教程 09-01 SQL 优化</title>
    <url>/2026/02/24/MySQL%20%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B%2009-01%20SQL%20%E4%BC%98%E5%8C%96/</url>
    <content><![CDATA[<h1 id="MySQL-进阶教程-09-01-SQL-优化"><a href="#MySQL-进阶教程-09-01-SQL-优化" class="headerlink" title="MySQL 进阶教程 09-01 SQL 优化"></a>MySQL 进阶教程 09-01 SQL 优化</h1><p>SQL 优化是数据库开发的核心技能之一。本文将介绍 SQL 优化的各种技巧，包括插入优化、查询优化、LIMIT 优化、COUNT 优化，以及如何使用 EXPLAIN 分析查询性能。</p>
<h2 id="一、插入数据优化"><a href="#一、插入数据优化" class="headerlink" title="一、插入数据优化"></a>一、插入数据优化</h2><h3 id="1-1-批量插入"><a href="#1-1-批量插入" class="headerlink" title="1.1 批量插入"></a>1.1 批量插入</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 差：逐条插入（1000 条需要 1000 次网络往返）</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> users (name, email) <span class="keyword">VALUES</span> (<span class="string">&#x27;张三&#x27;</span>, <span class="string">&#x27;zhang@example.com&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT INTO</span> users (name, email) <span class="keyword">VALUES</span> (<span class="string">&#x27;李四&#x27;</span>, <span class="string">&#x27;li@example.com&#x27;</span>);</span><br><span class="line"><span class="comment">-- ... 重复 1000 次</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 好：批量插入（1000 条只需 1 次网络往返）</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> users (name, email) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;张三&#x27;</span>, <span class="string">&#x27;zhang@example.com&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;李四&#x27;</span>, <span class="string">&#x27;li@example.com&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;王五&#x27;</span>, <span class="string">&#x27;wang@example.com&#x27;</span>),</span><br><span class="line"><span class="comment">-- ... 共 1000 条</span></span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<p><strong>性能对比</strong>：批量插入比逐条插入快 10-100 倍。</p>
<h3 id="1-2-使用事务"><a href="#1-2-使用事务" class="headerlink" title="1.2 使用事务"></a>1.2 使用事务</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 差：每条 INSERT 自动提交</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> users (name, email) <span class="keyword">VALUES</span> (...);</span><br><span class="line"><span class="keyword">INSERT INTO</span> users (name, email) <span class="keyword">VALUES</span> (...);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 好：手动控制事务</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">INSERT INTO</span> users (name, email) <span class="keyword">VALUES</span> (...);</span><br><span class="line"><span class="keyword">INSERT INTO</span> users (name, email) <span class="keyword">VALUES</span> (...);</span><br><span class="line"><span class="comment">-- ... 多条插入</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-禁用索引（大量导入时）"><a href="#1-3-禁用索引（大量导入时）" class="headerlink" title="1.3 禁用索引（大量导入时）"></a>1.3 禁用索引（大量导入时）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 导入前禁用非唯一索引</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> users DISABLE KEYS;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 批量导入数据</span></span><br><span class="line">LOAD DATA INFILE <span class="string">&#x27;users.csv&#x27;</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> users;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 导入后重新启用索引</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> users ENABLE KEYS;</span><br></pre></td></tr></table></figure>

<h3 id="1-4-主键优化"><a href="#1-4-主键优化" class="headerlink" title="1.4 主键优化"></a>1.4 主键优化</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 推荐：使用自增主键</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 不推荐：使用 UUID 作为主键（随机写入，性能差）</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users (</span><br><span class="line">    id <span class="type">VARCHAR</span>(<span class="number">36</span>) <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br></pre></td></tr></table></figure>

<h2 id="二、ORDER-BY-优化"><a href="#二、ORDER-BY-优化" class="headerlink" title="二、ORDER BY 优化"></a>二、ORDER BY 优化</h2><h3 id="2-1-使用索引排序"><a href="#2-1-使用索引排序" class="headerlink" title="2.1 使用索引排序"></a>2.1 使用索引排序</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_name <span class="keyword">ON</span> employees(name);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 可以使用索引排序</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">ORDER</span> <span class="keyword">BY</span> name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 不能使用索引排序</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">YEAR</span>(hire_date);</span><br></pre></td></tr></table></figure>

<h3 id="2-2-避免文件排序"><a href="#2-2-避免文件排序" class="headerlink" title="2.2 避免文件排序"></a>2.2 避免文件排序</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 索引：idx_dept_name (dept_id, name)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 可以使用索引排序</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 不能使用索引排序（跨列）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">ORDER</span> <span class="keyword">BY</span> dept_id, name;  <span class="comment">-- 需要 filesort</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-排序方向一致"><a href="#2-3-排序方向一致" class="headerlink" title="2.3 排序方向一致"></a>2.3 排序方向一致</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 索引：idx_name_age (name, age)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 可以（排序方向一致）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">ORDER</span> <span class="keyword">BY</span> name <span class="keyword">ASC</span>, age <span class="keyword">ASC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 不可以（排序方向不一致）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">ORDER</span> <span class="keyword">BY</span> name <span class="keyword">ASC</span>, age <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h2 id="三、GROUP-BY-优化"><a href="#三、GROUP-BY-优化" class="headerlink" title="三、GROUP BY 优化"></a>三、GROUP BY 优化</h2><h3 id="3-1-使用索引分组"><a href="#3-1-使用索引分组" class="headerlink" title="3.1 使用索引分组"></a>3.1 使用索引分组</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_dept <span class="keyword">ON</span> employees(dept_id);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 可以使用索引分组</span></span><br><span class="line"><span class="keyword">SELECT</span> dept_id, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> employees <span class="keyword">GROUP</span> <span class="keyword">BY</span> dept_id;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-避免使用临时表"><a href="#3-2-避免使用临时表" class="headerlink" title="3.2 避免使用临时表"></a>3.2 避免使用临时表</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 可能使用临时表</span></span><br><span class="line"><span class="keyword">SELECT</span> dept_id, <span class="built_in">AVG</span>(salary) <span class="keyword">FROM</span> employees <span class="keyword">GROUP</span> <span class="keyword">BY</span> dept_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="built_in">AVG</span>(salary);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 优化：先分组再排序</span></span><br><span class="line"><span class="keyword">SELECT</span> dept_id, avg_salary <span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> dept_id, <span class="built_in">AVG</span>(salary) <span class="keyword">AS</span> avg_salary</span><br><span class="line">    <span class="keyword">FROM</span> employees</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> dept_id</span><br><span class="line">) t <span class="keyword">ORDER</span> <span class="keyword">BY</span> avg_salary;</span><br></pre></td></tr></table></figure>

<h2 id="四、LIMIT-优化"><a href="#四、LIMIT-优化" class="headerlink" title="四、LIMIT 优化"></a>四、LIMIT 优化</h2><h3 id="4-1-深分页问题"><a href="#4-1-深分页问题" class="headerlink" title="4.1 深分页问题"></a>4.1 深分页问题</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 问题：深分页很慢</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">ORDER</span> <span class="keyword">BY</span> id LIMIT <span class="number">100000</span>, <span class="number">20</span>;</span><br><span class="line"><span class="comment">-- 需要扫描 100020 行，丢弃前 100000 行</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-延迟关联优化"><a href="#4-2-延迟关联优化" class="headerlink" title="4.2 延迟关联优化"></a>4.2 延迟关联优化</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 优化：使用子查询延迟关联</span></span><br><span class="line"><span class="keyword">SELECT</span> o.<span class="operator">*</span> <span class="keyword">FROM</span> orders o</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> id <span class="keyword">FROM</span> orders <span class="keyword">ORDER</span> <span class="keyword">BY</span> id LIMIT <span class="number">100000</span>, <span class="number">20</span></span><br><span class="line">) t <span class="keyword">ON</span> o.id <span class="operator">=</span> t.id;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-游标式分页"><a href="#4-3-游标式分页" class="headerlink" title="4.3 游标式分页"></a>4.3 游标式分页</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 记录上次查询的最大 ID</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> id <span class="operator">&gt;</span> <span class="number">100000</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> id LIMIT <span class="number">20</span>;</span><br></pre></td></tr></table></figure>

<h2 id="五、COUNT-优化"><a href="#五、COUNT-优化" class="headerlink" title="五、COUNT 优化"></a>五、COUNT 优化</h2><h3 id="5-1-COUNT-性能对比"><a href="#5-1-COUNT-性能对比" class="headerlink" title="5.1 COUNT 性能对比"></a>5.1 COUNT 性能对比</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 推荐（InnoDB 优化）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> users;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 不推荐（需要检查列是否为 NULL）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(col) <span class="keyword">FROM</span> users;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-带条件-COUNT-优化"><a href="#5-2-带条件-COUNT-优化" class="headerlink" title="5.2 带条件 COUNT 优化"></a>5.2 带条件 COUNT 优化</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 使用覆盖索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_status <span class="keyword">ON</span> orders(status);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> status <span class="operator">=</span> <span class="string">&#x27;COMPLETED&#x27;</span>;</span><br><span class="line"><span class="comment">-- 索引覆盖扫描，无需回表</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-近似计数"><a href="#5-3-近似计数" class="headerlink" title="5.3 近似计数"></a>5.3 近似计数</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 使用系统表获取近似值（很快但不精确）</span></span><br><span class="line"><span class="keyword">SELECT</span> TABLE_ROWS <span class="keyword">FROM</span> information_schema.TABLES</span><br><span class="line"><span class="keyword">WHERE</span> TABLE_SCHEMA <span class="operator">=</span> <span class="string">&#x27;your_db&#x27;</span> <span class="keyword">AND</span> TABLE_NAME <span class="operator">=</span> <span class="string">&#x27;orders&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="5-4-缓存计数"><a href="#5-4-缓存计数" class="headerlink" title="5.4 缓存计数"></a>5.4 缓存计数</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建计数缓存表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> order_stats (</span><br><span class="line">    status <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    cnt <span class="type">INT</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询时直接读取</span></span><br><span class="line"><span class="keyword">SELECT</span> cnt <span class="keyword">FROM</span> order_stats <span class="keyword">WHERE</span> status <span class="operator">=</span> <span class="string">&#x27;COMPLETED&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="六、UPDATE-优化"><a href="#六、UPDATE-优化" class="headerlink" title="六、UPDATE 优化"></a>六、UPDATE 优化</h2><h3 id="6-1-使用索引更新"><a href="#6-1-使用索引更新" class="headerlink" title="6.1 使用索引更新"></a>6.1 使用索引更新</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 确保 WHERE 条件列有索引</span></span><br><span class="line"><span class="keyword">UPDATE</span> orders <span class="keyword">SET</span> status <span class="operator">=</span> <span class="string">&#x27;SHIPPED&#x27;</span></span><br><span class="line"><span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">12345</span>;  <span class="comment">-- 主键查询，很快</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-批量更新使用事务"><a href="#6-2-批量更新使用事务" class="headerlink" title="6.2 批量更新使用事务"></a>6.2 批量更新使用事务</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">UPDATE</span> orders <span class="keyword">SET</span> status <span class="operator">=</span> <span class="string">&#x27;SHIPPED&#x27;</span> <span class="keyword">WHERE</span> id <span class="keyword">IN</span> (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-避免长事务"><a href="#6-3-避免长事务" class="headerlink" title="6.3 避免长事务"></a>6.3 避免长事务</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 差：长时间持有锁</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="comment">-- 大量操作...</span></span><br><span class="line"><span class="comment">-- 中间可能有其他逻辑</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 好：快速提交</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="comment">-- 必要的数据库操作</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>

<h2 id="七、EXPLAIN-详解"><a href="#七、EXPLAIN-详解" class="headerlink" title="七、EXPLAIN 详解"></a>七、EXPLAIN 详解</h2><h3 id="7-1-使用方法"><a href="#7-1-使用方法" class="headerlink" title="7.1 使用方法"></a>7.1 使用方法</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 基本语法</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 详细模式（MySQL 5.6+）</span></span><br><span class="line">EXPLAIN FORMAT<span class="operator">=</span>JSON <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 简写</span></span><br><span class="line"><span class="keyword">DESCRIBE</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span>;</span><br><span class="line"><span class="keyword">DESC</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="7-2-EXPLAIN-结果字段"><a href="#7-2-EXPLAIN-结果字段" class="headerlink" title="7.2 EXPLAIN 结果字段"></a>7.2 EXPLAIN 结果字段</h3><table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>查询的序列号</td>
</tr>
<tr>
<td>select_type</td>
<td>查询类型</td>
</tr>
<tr>
<td>table</td>
<td>表名</td>
</tr>
<tr>
<td>type</td>
<td>连接类型（重要）</td>
</tr>
<tr>
<td>possible_keys</td>
<td>可能使用的索引</td>
</tr>
<tr>
<td>key</td>
<td>实际使用的索引</td>
</tr>
<tr>
<td>key_len</td>
<td>索引使用长度</td>
</tr>
<tr>
<td>ref</td>
<td>列与索引的比较类型</td>
</tr>
<tr>
<td>rows</td>
<td>扫描行数（越大约差）</td>
</tr>
<tr>
<td>Extra</td>
<td>额外信息</td>
</tr>
</tbody></table>
<h3 id="7-3-type-字段详解（从差到好）"><a href="#7-3-type-字段详解（从差到好）" class="headerlink" title="7.3 type 字段详解（从差到好）"></a>7.3 type 字段详解（从差到好）</h3><table>
<thead>
<tr>
<th>type</th>
<th>说明</th>
<th>优化建议</th>
</tr>
</thead>
<tbody><tr>
<td>ALL</td>
<td>全表扫描</td>
<td>需要优化</td>
</tr>
<tr>
<td>index</td>
<td>全索引扫描</td>
<td>考虑优化</td>
</tr>
<tr>
<td>range</td>
<td>索引范围扫描</td>
<td>可以接受</td>
</tr>
<tr>
<td>ref</td>
<td>非唯一索引查找</td>
<td>良好</td>
</tr>
<tr>
<td>eq_ref</td>
<td>唯一索引查找</td>
<td>很好</td>
</tr>
<tr>
<td>const</td>
<td>常量查询</td>
<td>极好</td>
</tr>
<tr>
<td>system</td>
<td>系统表</td>
<td>最优</td>
</tr>
</tbody></table>
<h3 id="7-4-Extra-字段常见值"><a href="#7-4-Extra-字段常见值" class="headerlink" title="7.4 Extra 字段常见值"></a>7.4 Extra 字段常见值</h3><table>
<thead>
<tr>
<th>Extra</th>
<th>说明</th>
<th>优化建议</th>
</tr>
</thead>
<tbody><tr>
<td>Using index</td>
<td>使用覆盖索引</td>
<td>好</td>
</tr>
<tr>
<td>Using where</td>
<td>使用 WHERE 过滤</td>
<td>正常</td>
</tr>
<tr>
<td>Using temporary</td>
<td>使用临时表</td>
<td>需要优化</td>
</tr>
<tr>
<td>Using filesort</td>
<td>使用文件排序</td>
<td>需要优化</td>
</tr>
<tr>
<td>NULL</td>
<td>无特殊</td>
<td>正常</td>
</tr>
</tbody></table>
<h3 id="7-5-EXPLAIN-实战"><a href="#7-5-EXPLAIN-实战" class="headerlink" title="7.5 EXPLAIN 实战"></a>7.5 EXPLAIN 实战</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 测试数据</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> test_explain (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    age <span class="type">INT</span>,</span><br><span class="line">    dept_id <span class="type">INT</span>,</span><br><span class="line">    INDEX idx_name (name),</span><br><span class="line">    INDEX idx_age (age),</span><br><span class="line">    INDEX idx_dept (dept_id)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 全表扫描（type=ALL）</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> test_explain <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">+----+-------------+------+-------+----------+------+---------+------+-------+-------------+</span></span><br><span class="line"><span class="comment">| id | select_type | table| type | possible_keys | key | key_len | ref | rows | Extra     |</span></span><br><span class="line"><span class="comment">+----+-------------+------+-------+----------+------+---------+------+-------+-------------+</span></span><br><span class="line"><span class="comment">|  1 | SIMPLE      | test | ALL  | idx_name | NULL | NULL    | NULL| 1000  | Using where |</span></span><br><span class="line"><span class="comment">+----+-------------+------+-------+----------+------+---------+------+-------+-------------+</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 索引查找（type=ref）</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> test_explain <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">type: ref, key: idx_dept, rows: 100</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h2 id="八、慢查询日志"><a href="#八、慢查询日志" class="headerlink" title="八、慢查询日志"></a>八、慢查询日志</h2><h3 id="8-1-开启慢查询日志"><a href="#8-1-开启慢查询日志" class="headerlink" title="8.1 开启慢查询日志"></a>8.1 开启慢查询日志</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看状态</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;slow_query_log&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 开启（临时）</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> slow_query_log <span class="operator">=</span> <span class="string">&#x27;ON&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 永久开启（my.cnf）</span></span><br><span class="line"><span class="comment">-- [mysqld]</span></span><br><span class="line"><span class="comment">-- slow_query_log = 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看日志文件位置</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;slow_query_log_file&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置慢查询阈值</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> long_query_time <span class="operator">=</span> <span class="number">1</span>;  <span class="comment">-- 1 秒以上</span></span><br></pre></td></tr></table></figure>

<h3 id="8-2-慢查询日志格式"><a href="#8-2-慢查询日志格式" class="headerlink" title="8.2 慢查询日志格式"></a>8.2 慢查询日志格式</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># Time: 2024-02-24T10:30:45.123456Z</span><br><span class="line"># User@Host: root[root] @ localhost []</span><br><span class="line"># Query_time: 2.345678  Lock_time: 0.000123</span><br><span class="line"># Rows_sent: 1000  Rows_examined: 100000</span><br><span class="line">SET timestamp=1708772445;</span><br><span class="line">SELECT * FROM employees WHERE dept_id = 1;</span><br></pre></td></tr></table></figure>

<p><strong>关键字段</strong>：</p>
<ul>
<li><code>Query_time</code>: 执行时间</li>
<li><code>Rows_examined</code>: 扫描行数（越大越需要优化）</li>
</ul>
<h3 id="8-3-分析工具"><a href="#8-3-分析工具" class="headerlink" title="8.3 分析工具"></a>8.3 分析工具</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mysqldumpslow</span></span><br><span class="line">mysqldumpslow -s t -t 10 /var/log/mysql/slow.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># pt-query-digest（推荐）</span></span><br><span class="line">pt-query-digest /var/log/mysql/slow.log</span><br></pre></td></tr></table></figure>

<h2 id="九、慢查询实战案例"><a href="#九、慢查询实战案例" class="headerlink" title="九、慢查询实战案例"></a>九、慢查询实战案例</h2><h3 id="9-1-全表扫描优化"><a href="#9-1-全表扫描优化" class="headerlink" title="9.1 全表扫描优化"></a>9.1 全表扫描优化</h3><p><strong>问题 SQL</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders</span><br><span class="line"><span class="keyword">WHERE</span> user_id <span class="operator">=</span> <span class="number">12345</span> <span class="keyword">AND</span> status <span class="operator">=</span> <span class="string">&#x27;PAID&#x27;</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> create_time <span class="keyword">DESC</span> LIMIT <span class="number">20</span>;</span><br></pre></td></tr></table></figure>

<p><strong>EXPLAIN 分析</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">type = ALL, key = NULL, rows = 500000, Extra = Using filesort</span><br></pre></td></tr></table></figure>

<p><strong>优化方案</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> INDEX idx_user_status_time <span class="keyword">ON</span> orders(user_id, status, create_time <span class="keyword">DESC</span>);</span><br></pre></td></tr></table></figure>

<p><strong>优化后</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">type = ref, key = idx_user_status_time, rows = 100, Extra = Using index</span><br></pre></td></tr></table></figure>

<h3 id="9-2-LIKE-搜索优化"><a href="#9-2-LIKE-搜索优化" class="headerlink" title="9.2 LIKE 搜索优化"></a>9.2 LIKE 搜索优化</h3><p><strong>问题 SQL</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> products <span class="keyword">WHERE</span> product_name <span class="keyword">LIKE</span> <span class="string">&#x27;%手机%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>优化方案</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 方案 1：改为后缀匹配</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> products <span class="keyword">WHERE</span> product_name <span class="keyword">LIKE</span> <span class="string">&#x27;手机%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方案 2：使用全文索引</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> products <span class="keyword">ADD</span> FULLTEXT INDEX ft_name (product_name);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> products <span class="keyword">WHERE</span> <span class="keyword">MATCH</span>(product_name) AGAINST(<span class="string">&#x27;手机&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="9-3-深分页优化"><a href="#9-3-深分页优化" class="headerlink" title="9.3 深分页优化"></a>9.3 深分页优化</h3><p><strong>问题 SQL</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">ORDER</span> <span class="keyword">BY</span> id LIMIT <span class="number">100000</span>, <span class="number">20</span>;</span><br></pre></td></tr></table></figure>

<p><strong>优化方案</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 延迟关联</span></span><br><span class="line"><span class="keyword">SELECT</span> o.<span class="operator">*</span> <span class="keyword">FROM</span> orders o</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> id <span class="keyword">FROM</span> orders <span class="keyword">ORDER</span> <span class="keyword">BY</span> id LIMIT <span class="number">100000</span>, <span class="number">20</span></span><br><span class="line">) t <span class="keyword">ON</span> o.id <span class="operator">=</span> t.id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 游标式</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> id <span class="operator">&gt;</span> <span class="number">100000</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> id LIMIT <span class="number">20</span>;</span><br></pre></td></tr></table></figure>

<h2 id="十、SQL-优化-Checklist"><a href="#十、SQL-优化-Checklist" class="headerlink" title="十、SQL 优化 Checklist"></a>十、SQL 优化 Checklist</h2><h3 id="10-1-SELECT-优化"><a href="#10-1-SELECT-优化" class="headerlink" title="10.1 SELECT 优化"></a>10.1 SELECT 优化</h3><ul>
<li><input disabled="" type="checkbox"> 避免 SELECT *，只查需要的列</li>
<li><input disabled="" type="checkbox"> 使用覆盖索引</li>
<li><input disabled="" type="checkbox"> 避免前缀通配符 LIKE ‘%xxx’</li>
<li><input disabled="" type="checkbox"> 避免在索引列上使用函数</li>
</ul>
<h3 id="10-2-WHERE-优化"><a href="#10-2-WHERE-优化" class="headerlink" title="10.2 WHERE 优化"></a>10.2 WHERE 优化</h3><ul>
<li><input disabled="" type="checkbox"> WHERE 条件列有索引</li>
<li><input disabled="" type="checkbox"> 避免 OR 条件（使用 UNION）</li>
<li><input disabled="" type="checkbox"> 避免类型隐式转换</li>
</ul>
<h3 id="10-3-JOIN-优化"><a href="#10-3-JOIN-优化" class="headerlink" title="10.3 JOIN 优化"></a>10.3 JOIN 优化</h3><ul>
<li><input disabled="" type="checkbox"> JOIN 条件列有索引</li>
<li><input disabled="" type="checkbox"> 小表驱动大表</li>
<li><input disabled="" type="checkbox"> 使用 EXISTS 代替 IN（子查询结果集大时）</li>
</ul>
<h3 id="10-4-索引优化"><a href="#10-4-索引优化" class="headerlink" title="10.4 索引优化"></a>10.4 索引优化</h3><ul>
<li><input disabled="" type="checkbox"> 定期 ANALYZE TABLE</li>
<li><input disabled="" type="checkbox"> 删除未使用的索引</li>
<li><input disabled="" type="checkbox"> 避免冗余索引</li>
</ul>
<h2 id="十一、小结"><a href="#十一、小结" class="headerlink" title="十一、小结"></a>十一、小结</h2><h3 id="优化原则"><a href="#优化原则" class="headerlink" title="优化原则"></a>优化原则</h3><ol>
<li><strong>先分析后优化</strong>：使用 EXPLAIN 分析问题</li>
<li><strong>先 SQL 后索引</strong>：先优化 SQL 写法，再考虑索引</li>
<li><strong>先局部后整体</strong>：先优化最慢的查询</li>
<li><strong>权衡读写比例</strong>：读多写少多建索引，写多读少精简索引</li>
</ol>
<h3 id="核心技巧速查"><a href="#核心技巧速查" class="headerlink" title="核心技巧速查"></a>核心技巧速查</h3><table>
<thead>
<tr>
<th>问题</th>
<th>优化方案</th>
</tr>
</thead>
<tbody><tr>
<td>插入慢</td>
<td>批量插入 + 事务</td>
</tr>
<tr>
<td>分页慢</td>
<td>延迟关联&#x2F;游标</td>
</tr>
<tr>
<td>COUNT 慢</td>
<td>覆盖索引&#x2F;缓存</td>
</tr>
<tr>
<td>全表扫描</td>
<td>添加索引</td>
</tr>
<tr>
<td>文件排序</td>
<td>ORDER BY 列加索引</td>
</tr>
<tr>
<td>临时表</td>
<td>GROUP BY 列加索引</td>
</tr>
</tbody></table>
<h3 id="下一章预告"><a href="#下一章预告" class="headerlink" title="下一章预告"></a>下一章预告</h3><p>下一篇文章将介绍<strong>锁机制</strong>，包括：</p>
<ul>
<li>锁的基本概念</li>
<li>全局锁、表级锁、行级锁</li>
<li>死锁问题</li>
<li>锁的监控</li>
</ul>
<hr>
<p><strong>下一篇</strong>：[MySQL 进阶教程 10-01 锁机制详解](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 10-01 锁机制详解&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 进阶教程 08-01 索引使用规则](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 08-01 索引使用规则&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 进阶教程</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>性能优化</tag>
        <tag>SQL 优化</tag>
        <tag>EXPLAIN</tag>
        <tag>慢查询</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 进阶教程 08-01 索引使用规则</title>
    <url>/2026/02/24/MySQL%20%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B%2008-01%20%E7%B4%A2%E5%BC%95%E4%BD%BF%E7%94%A8%E8%A7%84%E5%88%99/</url>
    <content><![CDATA[<h1 id="MySQL-进阶教程-08-01-索引使用规则"><a href="#MySQL-进阶教程-08-01-索引使用规则" class="headerlink" title="MySQL 进阶教程 08-01 索引使用规则"></a>MySQL 进阶教程 08-01 索引使用规则</h1><p>创建索引只是第一步，正确使用索引才能发挥其最大价值。本文将详细介绍索引的使用规则、失效场景以及设计原则。</p>
<h2 id="一、验证索引效率"><a href="#一、验证索引效率" class="headerlink" title="一、验证索引效率"></a>一、验证索引效率</h2><h3 id="1-1-索引效果对比"><a href="#1-1-索引效果对比" class="headerlink" title="1.1 索引效果对比"></a>1.1 索引效果对比</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 准备测试数据</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> test_index;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> test_index (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    age <span class="type">INT</span>,</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    content TEXT</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入 10 万条测试数据</span></span><br><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> insert_data()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>;</span><br><span class="line">    WHILE i <span class="operator">&lt;=</span> <span class="number">100000</span> DO</span><br><span class="line">        <span class="keyword">INSERT INTO</span> test_index (name, age, email, content)</span><br><span class="line">        <span class="keyword">VALUES</span> (CONCAT(<span class="string">&#x27;user&#x27;</span>, i), <span class="built_in">FLOOR</span>(RAND()<span class="operator">*</span><span class="number">50</span>)<span class="operator">+</span><span class="number">18</span>,</span><br><span class="line">                CONCAT(<span class="string">&#x27;user&#x27;</span>, i, <span class="string">&#x27;@example.com&#x27;</span>),</span><br><span class="line">                REPEAT(<span class="string">&#x27;a&#x27;</span>, <span class="number">100</span>));</span><br><span class="line">        <span class="keyword">SET</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">END</span> WHILE;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CALL</span> insert_data();</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_name <span class="keyword">ON</span> test_index(name);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_age <span class="keyword">ON</span> test_index(age);</span><br></pre></td></tr></table></figure>

<h3 id="1-2-使用-EXPLAIN-验证"><a href="#1-2-使用-EXPLAIN-验证" class="headerlink" title="1.2 使用 EXPLAIN 验证"></a>1.2 使用 EXPLAIN 验证</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 无索引：全表扫描</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> test_index <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;user50000&#x27;</span>;</span><br><span class="line"><span class="comment">-- type: ALL, rows: 100000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 有索引：索引查找</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> test_index <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;user50000&#x27;</span>;</span><br><span class="line"><span class="comment">-- type: ref, rows: 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 对比查询时间</span></span><br><span class="line"><span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> test_index <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;user50000&#x27;</span>;</span><br><span class="line"><span class="comment">-- 有索引：约 0.01 秒</span></span><br><span class="line"><span class="comment">-- 无索引：约 0.5 秒</span></span><br></pre></td></tr></table></figure>

<h2 id="二、最左前缀法则"><a href="#二、最左前缀法则" class="headerlink" title="二、最左前缀法则"></a>二、最左前缀法则</h2><h3 id="2-1-什么是联合索引？"><a href="#2-1-什么是联合索引？" class="headerlink" title="2.1 什么是联合索引？"></a>2.1 什么是联合索引？</h3><p><strong>联合索引（复合索引）</strong> 是在多个列上创建的索引。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建联合索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_name_age_dept <span class="keyword">ON</span> employees(name, age, dept_id);</span><br></pre></td></tr></table></figure>

<h3 id="2-2-最左前缀法则"><a href="#2-2-最左前缀法则" class="headerlink" title="2.2 最左前缀法则"></a>2.2 最左前缀法则</h3><p><strong>最左前缀法则</strong>：查询必须从索引的最左边列开始匹配，不能跳过索引中的列。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 联合索引：idx_name_age_dept (name, age, dept_id)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ✓ 可以使用索引</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span> <span class="keyword">AND</span> age <span class="operator">=</span> <span class="number">25</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span> <span class="keyword">AND</span> age <span class="operator">=</span> <span class="number">25</span> <span class="keyword">AND</span> dept_id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span> <span class="keyword">AND</span> dept_id <span class="operator">=</span> <span class="number">1</span>;  <span class="comment">-- 只用 name 列</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ✗ 不能使用索引（跳过最左列）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> age <span class="operator">=</span> <span class="number">25</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> age <span class="operator">=</span> <span class="number">25</span> <span class="keyword">AND</span> dept_id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-最左前缀法则图解"><a href="#2-3-最左前缀法则图解" class="headerlink" title="2.3 最左前缀法则图解"></a>2.3 最左前缀法则图解</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">索引：(name, age, dept_id)</span><br><span class="line"></span><br><span class="line">查询条件                  索引使用情况</span><br><span class="line">name = &#x27;张三&#x27;            → 使用 name 列</span><br><span class="line">name + age               → 使用 name + age 列</span><br><span class="line">name + age + dept_id     → 使用全部三列</span><br><span class="line">name + dept_id           → 只使用 name 列（跳过 age）</span><br><span class="line">age                      → 不使用索引（跳过 name）</span><br><span class="line">dept_id                  → 不使用索引（跳过 name）</span><br></pre></td></tr></table></figure>

<h3 id="2-4-范围查询后的列失效"><a href="#2-4-范围查询后的列失效" class="headerlink" title="2.4 范围查询后的列失效"></a>2.4 范围查询后的列失效</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 索引：idx_name_age_dept (name, age, dept_id)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- range 查询后的列无法使用索引</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span> <span class="keyword">AND</span> age <span class="operator">&gt;</span> <span class="number">25</span> <span class="keyword">AND</span> dept_id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- name 使用索引，age 使用索引进行范围查找，dept_id 不使用索引</span></span><br></pre></td></tr></table></figure>

<h2 id="三、索引失效情况"><a href="#三、索引失效情况" class="headerlink" title="三、索引失效情况"></a>三、索引失效情况</h2><h3 id="3-1-在索引列上使用函数"><a href="#3-1-在索引列上使用函数" class="headerlink" title="3.1 在索引列上使用函数"></a>3.1 在索引列上使用函数</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 索引：idx_hire_date (hire_date)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ✗ 索引失效</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> <span class="keyword">YEAR</span>(hire_date) <span class="operator">=</span> <span class="number">2024</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ✓ 优化写法</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> hire_date <span class="operator">&gt;=</span> <span class="string">&#x27;2024-01-01&#x27;</span> <span class="keyword">AND</span> hire_date <span class="operator">&lt;</span> <span class="string">&#x27;2025-01-01&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-在索引列上进行运算"><a href="#3-2-在索引列上进行运算" class="headerlink" title="3.2 在索引列上进行运算"></a>3.2 在索引列上进行运算</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 索引：idx_age (age)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ✗ 索引失效</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> age <span class="operator">+</span> <span class="number">1</span> <span class="operator">=</span> <span class="number">25</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ✓ 优化写法</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> age <span class="operator">=</span> <span class="number">24</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-模糊查询通配符在前"><a href="#3-3-模糊查询通配符在前" class="headerlink" title="3.3 模糊查询通配符在前"></a>3.3 模糊查询通配符在前</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 索引：idx_name (name)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ✗ 索引失效（前缀模糊）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="keyword">LIKE</span> <span class="string">&#x27;%三&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ✓ 可以使用索引（后缀模糊）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="keyword">LIKE</span> <span class="string">&#x27;张%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ✓ 可以使用索引（精确匹配）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-4-类型隐式转换"><a href="#3-4-类型隐式转换" class="headerlink" title="3.4 类型隐式转换"></a>3.4 类型隐式转换</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 索引：idx_phone (phone), phone 是 VARCHAR 类型</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ✗ 索引失效（字符串转数字）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> phone <span class="operator">=</span> <span class="number">13800138000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ✓ 使用引号</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> phone <span class="operator">=</span> <span class="string">&#x27;13800138000&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-5-OR-条件使用不当"><a href="#3-5-OR-条件使用不当" class="headerlink" title="3.5 OR 条件使用不当"></a>3.5 OR 条件使用不当</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 索引：idx_name (name), idx_age (age)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ✗ 可能只使用一个索引</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span> <span class="keyword">OR</span> age <span class="operator">=</span> <span class="number">25</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ✓ 使用 UNION</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span></span><br><span class="line"><span class="keyword">UNION</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> age <span class="operator">=</span> <span class="number">25</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-6-IS-NULL-和-IS-NOT-NULL"><a href="#3-6-IS-NULL-和-IS-NOT-NULL" class="headerlink" title="3.6 IS NULL 和 IS NOT NULL"></a>3.6 IS NULL 和 IS NOT NULL</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 索引：idx_name (name)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 可能失效（取决于数据分布）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="keyword">IS</span> <span class="keyword">NOT NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 建议：避免在索引列上使用 NULL</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> employees MODIFY name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-7-不等于条件"><a href="#3-7-不等于条件" class="headerlink" title="3.7 不等于条件"></a>3.7 不等于条件</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 索引：idx_age (age)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 可能失效</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> age <span class="operator">!=</span> <span class="number">25</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> age <span class="operator">&lt;&gt;</span> <span class="number">25</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 优化：使用 IN 或 UNION</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> age <span class="keyword">IN</span> (<span class="number">20</span>, <span class="number">21</span>, <span class="number">22</span>, <span class="number">23</span>, <span class="number">24</span>, <span class="number">26</span>, <span class="number">27</span>, <span class="number">28</span>);</span><br></pre></td></tr></table></figure>

<h2 id="四、SQL-提示"><a href="#四、SQL-提示" class="headerlink" title="四、SQL 提示"></a>四、SQL 提示</h2><h3 id="4-1-强制使用索引"><a href="#4-1-强制使用索引" class="headerlink" title="4.1 强制使用索引"></a>4.1 强制使用索引</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- USE INDEX：建议使用索引</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees USE INDEX (idx_name)</span><br><span class="line"><span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- FORCE INDEX：强制使用索引</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees FORCE INDEX (idx_name)</span><br><span class="line"><span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- IGNORE INDEX：忽略索引</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees IGNORE INDEX (idx_name)</span><br><span class="line"><span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-使用场景"><a href="#4-2-使用场景" class="headerlink" title="4.2 使用场景"></a>4.2 使用场景</h3><table>
<thead>
<tr>
<th>提示</th>
<th>说明</th>
<th>使用场景</th>
</tr>
</thead>
<tbody><tr>
<td>USE INDEX</td>
<td>建议使用</td>
<td>优化器选择了错误的索引</td>
</tr>
<tr>
<td>FORCE INDEX</td>
<td>强制使用</td>
<td>确定某个索引更好</td>
</tr>
<tr>
<td>IGNORE INDEX</td>
<td>忽略索引</td>
<td>索引效果不好时</td>
</tr>
</tbody></table>
<p><strong>注意</strong>：SQL 提示应谨慎使用，通常优化器能选择最优索引。</p>
<h2 id="五、覆盖索引与回表"><a href="#五、覆盖索引与回表" class="headerlink" title="五、覆盖索引与回表"></a>五、覆盖索引与回表</h2><h3 id="5-1-什么是覆盖索引？"><a href="#5-1-什么是覆盖索引？" class="headerlink" title="5.1 什么是覆盖索引？"></a>5.1 什么是覆盖索引？</h3><p><strong>覆盖索引（Covering Index）</strong>：查询的列都在索引中，无需回表查询数据。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 索引：idx_name_age (name, age)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ✓ 使用覆盖索引（查询列都在索引中）</span></span><br><span class="line"><span class="keyword">SELECT</span> name, age <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ✗ 需要回表（查询列不在索引中）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span>;</span><br><span class="line"><span class="keyword">SELECT</span> name, age, salary <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-覆盖索引的优势"><a href="#5-2-覆盖索引的优势" class="headerlink" title="5.2 覆盖索引的优势"></a>5.2 覆盖索引的优势</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">普通查询（需要回表）：</span><br><span class="line">1. 在 idx_name 中找到 name=&#x27;张三&#x27; 的记录</span><br><span class="line">2. 获取主键 id=100</span><br><span class="line">3. 回到聚簇索引中查找 id=100 的完整行数据</span><br><span class="line">4. 返回结果</span><br><span class="line"></span><br><span class="line">覆盖索引查询（无需回表）：</span><br><span class="line">1. 在 idx_name_age 中找到 name=&#x27;张三&#x27; 的记录</span><br><span class="line">2. 直接返回 age 值</span><br><span class="line">3. 完成</span><br></pre></td></tr></table></figure>

<h3 id="5-3-使用覆盖索引优化"><a href="#5-3-使用覆盖索引优化" class="headerlink" title="5.3 使用覆盖索引优化"></a>5.3 使用覆盖索引优化</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 原查询（需要回表）</span></span><br><span class="line"><span class="keyword">SELECT</span> id, name <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 优化：创建覆盖索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_name_id <span class="keyword">ON</span> employees(name, id);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用覆盖索引</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> id, name <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span>;</span><br><span class="line"><span class="comment">-- Extra: Using index（表示使用覆盖索引）</span></span><br></pre></td></tr></table></figure>

<h3 id="5-4-回表查询"><a href="#5-4-回表查询" class="headerlink" title="5.4 回表查询"></a>5.4 回表查询</h3><p><strong>回表</strong>：通过非聚簇索引找到主键后，再回到聚簇索引中查询完整数据。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 索引：idx_name (name)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 回表查询过程：</span></span><br><span class="line"><span class="number">1.</span> 在 idx_name 中找到 name<span class="operator">=</span><span class="string">&#x27;张三&#x27;</span> → 得到主键 id<span class="operator">=</span><span class="number">100</span></span><br><span class="line"><span class="number">2.</span> 在聚簇索引（主键索引）中找到 id<span class="operator">=</span><span class="number">100</span> → 获取完整行数据</span><br></pre></td></tr></table></figure>

<h2 id="六、前缀索引"><a href="#六、前缀索引" class="headerlink" title="六、前缀索引"></a>六、前缀索引</h2><h3 id="6-1-什么是前缀索引？"><a href="#6-1-什么是前缀索引？" class="headerlink" title="6.1 什么是前缀索引？"></a>6.1 什么是前缀索引？</h3><p><strong>前缀索引</strong>：只对列的前 n 个字符创建索引，节省空间。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 完整索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_email <span class="keyword">ON</span> users(email);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 前缀索引（只索引前 10 个字符）</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_email_prefix <span class="keyword">ON</span> users(email(<span class="number">10</span>));</span><br></pre></td></tr></table></figure>

<h3 id="6-2-适用场景"><a href="#6-2-适用场景" class="headerlink" title="6.2 适用场景"></a>6.2 适用场景</h3><ul>
<li>字符串较长的列（如 URL、邮箱）</li>
<li>列的前缀选择性较高</li>
</ul>
<h3 id="6-3-选择合适的前缀长度"><a href="#6-3-选择合适的前缀长度" class="headerlink" title="6.3 选择合适的前缀长度"></a>6.3 选择合适的前缀长度</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 计算不同前缀长度的选择性</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> email) <span class="operator">/</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> full_ratio,</span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> <span class="keyword">LEFT</span>(email, <span class="number">5</span>)) <span class="operator">/</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> prefix_5_ratio,</span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> <span class="keyword">LEFT</span>(email, <span class="number">10</span>)) <span class="operator">/</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> prefix_10_ratio,</span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> <span class="keyword">LEFT</span>(email, <span class="number">20</span>)) <span class="operator">/</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> prefix_20_ratio</span><br><span class="line"><span class="keyword">FROM</span> users;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 选择性接近 1 说明区分度高</span></span><br></pre></td></tr></table></figure>

<h3 id="6-4-前缀索引的局限"><a href="#6-4-前缀索引的局限" class="headerlink" title="6.4 前缀索引的局限"></a>6.4 前缀索引的局限</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 前缀索引：idx_email_prefix (email(10))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ✗ 无法用于 ORDER BY</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">ORDER</span> <span class="keyword">BY</span> email;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ✗ 无法用于覆盖索引</span></span><br><span class="line"><span class="keyword">SELECT</span> email <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> email <span class="operator">=</span> <span class="string">&#x27;test@example.com&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="七、单列与联合索引"><a href="#七、单列与联合索引" class="headerlink" title="七、单列与联合索引"></a>七、单列与联合索引</h2><h3 id="7-1-选择策略"><a href="#7-1-选择策略" class="headerlink" title="7.1 选择策略"></a>7.1 选择策略</h3><table>
<thead>
<tr>
<th>场景</th>
<th>推荐索引</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>单列查询</td>
<td>单列索引</td>
<td>简单直接</td>
</tr>
<tr>
<td>多列组合查询</td>
<td>联合索引</td>
<td>更高效</td>
</tr>
<tr>
<td>多列独立查询</td>
<td>多个单列索引</td>
<td>灵活</td>
</tr>
</tbody></table>
<h3 id="7-2-联合索引的优势"><a href="#7-2-联合索引的优势" class="headerlink" title="7.2 联合索引的优势"></a>7.2 联合索引的优势</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 场景：经常查询 name + age</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方案 1：两个单列索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_name <span class="keyword">ON</span> employees(name);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_age <span class="keyword">ON</span> employees(age);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方案 2：一个联合索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_name_age <span class="keyword">ON</span> employees(name, age);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 联合索引更好：</span></span><br><span class="line"><span class="comment">-- 1. 占用空间更小</span></span><br><span class="line"><span class="comment">-- 2. 查询效率更高</span></span><br><span class="line"><span class="comment">-- 3. 维护成本更低</span></span><br></pre></td></tr></table></figure>

<h3 id="7-3-索引列顺序"><a href="#7-3-索引列顺序" class="headerlink" title="7.3 索引列顺序"></a>7.3 索引列顺序</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 原则：选择性高的列放在前面</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 假设 name 的选择性高于 age</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_name_age <span class="keyword">ON</span> employees(name, age);  <span class="comment">-- 推荐</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_age_name <span class="keyword">ON</span> employees(age, name);  <span class="comment">-- 不推荐</span></span><br></pre></td></tr></table></figure>

<h2 id="八、索引设计原则"><a href="#八、索引设计原则" class="headerlink" title="八、索引设计原则"></a>八、索引设计原则</h2><h3 id="8-1-设计原则"><a href="#8-1-设计原则" class="headerlink" title="8.1 设计原则"></a>8.1 设计原则</h3><ol>
<li><strong>适合场景</strong>：根据查询模式设计索引</li>
<li><strong>选择性高</strong>：优先为区分度高的列创建索引</li>
<li><strong>联合索引</strong>：多列查询优先考虑联合索引</li>
<li><strong>前缀索引</strong>：长字符串使用前缀索引</li>
<li><strong>避免冗余</strong>：避免创建重复或覆盖的索引</li>
<li><strong>控制数量</strong>：单表索引不宜过多（建议不超过 5 个）</li>
</ol>
<h3 id="8-2-索引设计流程"><a href="#8-2-索引设计流程" class="headerlink" title="8.2 索引设计流程"></a>8.2 索引设计流程</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 分析查询模式</span><br><span class="line">   ↓</span><br><span class="line">2. 确定 WHERE、JOIN、ORDER BY、GROUP BY 列</span><br><span class="line">   ↓</span><br><span class="line">3. 评估列的选择性</span><br><span class="line">   ↓</span><br><span class="line">4. 设计联合索引（考虑最左前缀）</span><br><span class="line">   ↓</span><br><span class="line">5. 测试索引效果</span><br><span class="line">   ↓</span><br><span class="line">6. 调整优化</span><br></pre></td></tr></table></figure>

<h3 id="8-3-索引维护建议"><a href="#8-3-索引维护建议" class="headerlink" title="8.3 索引维护建议"></a>8.3 索引维护建议</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 定期分析表</span></span><br><span class="line">ANALYZE <span class="keyword">TABLE</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 定期优化表</span></span><br><span class="line">OPTIMIZE <span class="keyword">TABLE</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看索引使用情况</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> sys.schema_unused_indexes;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除未使用的索引</span></span><br><span class="line"><span class="keyword">DROP</span> INDEX idx_unused <span class="keyword">ON</span> employees;</span><br></pre></td></tr></table></figure>

<h2 id="九、小结"><a href="#九、小结" class="headerlink" title="九、小结"></a>九、小结</h2><h3 id="核心知识点"><a href="#核心知识点" class="headerlink" title="核心知识点"></a>核心知识点</h3><ol>
<li><strong>最左前缀法则</strong>：联合索引从最左列开始匹配，不能跳过</li>
<li><strong>索引失效场景</strong>：函数、运算、前缀模糊、类型转换等</li>
<li><strong>覆盖索引</strong>：查询列都在索引中，无需回表</li>
<li><strong>前缀索引</strong>：长字符串可创建前缀索引节省空间</li>
</ol>
<h3 id="索引使用速查"><a href="#索引使用速查" class="headerlink" title="索引使用速查"></a>索引使用速查</h3><table>
<thead>
<tr>
<th>场景</th>
<th>是否使用索引</th>
</tr>
</thead>
<tbody><tr>
<td>name &#x3D; ‘张三’</td>
<td>✓</td>
</tr>
<tr>
<td>name LIKE ‘张%’</td>
<td>✓</td>
</tr>
<tr>
<td>name LIKE ‘%三’</td>
<td>✗</td>
</tr>
<tr>
<td>YEAR(date) &#x3D; 2024</td>
<td>✗</td>
</tr>
<tr>
<td>date &gt;&#x3D; ‘2024-01-01’</td>
<td>✓</td>
</tr>
<tr>
<td>age + 1 &#x3D; 25</td>
<td>✗</td>
</tr>
<tr>
<td>phone &#x3D; 138xxxx（无引号）</td>
<td>✗</td>
</tr>
</tbody></table>
<h3 id="下一章预告"><a href="#下一章预告" class="headerlink" title="下一章预告"></a>下一章预告</h3><p>下一篇文章将介绍<strong>SQL 优化</strong>，包括：</p>
<ul>
<li>插入数据优化</li>
<li>ORDER BY 和 GROUP BY 优化</li>
<li>LIMIT 优化</li>
<li>COUNT 优化</li>
</ul>
<hr>
<p><strong>下一篇</strong>：[MySQL 进阶教程 09-01 SQL 优化](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 09-01 SQL 优化&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 进阶教程 07-01 索引详解](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 07-01 索引详解&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 进阶教程</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>性能优化</tag>
        <tag>索引</tag>
        <tag>最左前缀</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 进阶教程 10-01 锁机制详解</title>
    <url>/2026/02/24/MySQL%20%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B%2010-01%20%E9%94%81%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<h1 id="MySQL-进阶教程-10-01-锁机制详解"><a href="#MySQL-进阶教程-10-01-锁机制详解" class="headerlink" title="MySQL 进阶教程 10-01 锁机制详解"></a>MySQL 进阶教程 10-01 锁机制详解</h1><p>锁机制是数据库并发控制的核心技术。本文将详细介绍 MySQL 中的各种锁类型，包括全局锁、表级锁、行级锁，以及锁的分析和优化方法。</p>
<h2 id="一、锁介绍"><a href="#一、锁介绍" class="headerlink" title="一、锁介绍"></a>一、锁介绍</h2><h3 id="1-1-什么是锁？"><a href="#1-1-什么是锁？" class="headerlink" title="1.1 什么是锁？"></a>1.1 什么是锁？</h3><p><strong>锁（Lock）</strong> 是数据库用于管理并发访问的机制，确保多个事务同时访问数据时的一致性和完整性。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">场景：两个事务同时修改同一行数据</span><br><span class="line"></span><br><span class="line">事务 A: UPDATE accounts SET balance = balance - 100 WHERE id = 1;</span><br><span class="line">事务 B: UPDATE accounts SET balance = balance + 100 WHERE id = 1;</span><br><span class="line"></span><br><span class="line">没有锁：可能导致数据丢失</span><br><span class="line">有锁：事务 B 等待事务 A 完成</span><br></pre></td></tr></table></figure>

<h3 id="1-2-锁的粒度"><a href="#1-2-锁的粒度" class="headerlink" title="1.2 锁的粒度"></a>1.2 锁的粒度</h3><table>
<thead>
<tr>
<th>粒度</th>
<th>范围</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td>全局锁</td>
<td>整个数据库实例</td>
<td>简单</td>
<td>并发度最低</td>
</tr>
<tr>
<td>表级锁</td>
<td>整张表</td>
<td>开销小，加锁快</td>
<td>冲突概率高</td>
</tr>
<tr>
<td>行级锁</td>
<td>单行记录</td>
<td>并发度高</td>
<td>开销大，可能死锁</td>
</tr>
</tbody></table>
<h3 id="1-3-InnoDB-锁类型概述"><a href="#1-3-InnoDB-锁类型概述" class="headerlink" title="1.3 InnoDB 锁类型概述"></a>1.3 InnoDB 锁类型概述</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MySQL 锁体系</span><br><span class="line">├── 全局锁</span><br><span class="line">├── 表级锁</span><br><span class="line">│   ├── 表锁（Table Lock）</span><br><span class="line">│   ├── 元数据锁（MDL）</span><br><span class="line">│   └── 意向锁（Intention Lock）</span><br><span class="line">└── 行级锁（Row Lock）</span><br><span class="line">    ├── 记录锁（Record Lock）</span><br><span class="line">    ├── 间隙锁（Gap Lock）</span><br><span class="line">    └── 临键锁（Next-Key Lock）</span><br></pre></td></tr></table></figure>

<h2 id="二、全局锁介绍"><a href="#二、全局锁介绍" class="headerlink" title="二、全局锁介绍"></a>二、全局锁介绍</h2><h3 id="2-1-什么是全局锁？"><a href="#2-1-什么是全局锁？" class="headerlink" title="2.1 什么是全局锁？"></a>2.1 什么是全局锁？</h3><p><strong>全局锁（Global Lock）</strong> 锁定整个数据库实例，使所有表处于只读状态。</p>
<h3 id="2-2-加锁命令"><a href="#2-2-加锁命令" class="headerlink" title="2.2 加锁命令"></a>2.2 加锁命令</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 添加全局读锁</span></span><br><span class="line">FLUSH TABLES <span class="keyword">WITH</span> READ LOCK;</span><br><span class="line"><span class="comment">-- 或简写</span></span><br><span class="line">FTWRL;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 释放全局锁</span></span><br><span class="line">UNLOCK TABLES;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-全局锁的影响"><a href="#2-3-全局锁的影响" class="headerlink" title="2.3 全局锁的影响"></a>2.3 全局锁的影响</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">加锁后：</span><br><span class="line">- 所有 DML 操作（INSERT、UPDATE、DELETE）被阻塞</span><br><span class="line">- DDL 操作（CREATE、ALTER、DROP）被阻塞</span><br><span class="line">- SELECT 可以正常执行</span><br><span class="line">- 其他会话的写操作被阻塞</span><br></pre></td></tr></table></figure>

<h3 id="2-4-使用场景"><a href="#2-4-使用场景" class="headerlink" title="2.4 使用场景"></a>2.4 使用场景</h3><p><strong>典型场景：全库逻辑备份</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 会话 1：加锁</span></span><br><span class="line">FLUSH TABLES <span class="keyword">WITH</span> READ LOCK;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 2：备份（此时数据不会变化）</span></span><br><span class="line">mysqldump <span class="operator">-</span>u root <span class="operator">-</span>p your_database <span class="operator">&gt;</span> backup.sql</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 1：释放锁</span></span><br><span class="line">UNLOCK TABLES;</span><br></pre></td></tr></table></figure>

<h3 id="2-5-注意事项"><a href="#2-5-注意事项" class="headerlink" title="2.5 注意事项"></a>2.5 注意事项</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 问题：如果加锁后会话断开，锁不会自动释放</span></span><br><span class="line"><span class="comment">-- 解决：使用 --single-transaction 参数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- mysqldump 推荐方式（InnoDB）</span></span><br><span class="line">mysqldump <span class="operator">-</span>u root <span class="operator">-</span>p <span class="comment">--single-transaction your_database &gt; backup.sql</span></span><br><span class="line"><span class="comment">-- 无需加全局锁，使用 MVCC 保证一致性</span></span><br></pre></td></tr></table></figure>

<h2 id="三、全局锁与数据备份"><a href="#三、全局锁与数据备份" class="headerlink" title="三、全局锁与数据备份"></a>三、全局锁与数据备份</h2><h3 id="3-1-使用全局锁备份（MyISAM）"><a href="#3-1-使用全局锁备份（MyISAM）" class="headerlink" title="3.1 使用全局锁备份（MyISAM）"></a>3.1 使用全局锁备份（MyISAM）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># MyISAM 引擎需要全局锁保证一致性</span></span><br><span class="line">mysql -u root -p -e <span class="string">&quot;FLUSH TABLES WITH READ LOCK&quot;</span></span><br><span class="line">mysqldump -u root -p your_database &gt; backup.sql</span><br><span class="line">mysql -u root -p -e <span class="string">&quot;UNLOCK TABLES&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-使用-MVCC-备份（InnoDB）"><a href="#3-2-使用-MVCC-备份（InnoDB）" class="headerlink" title="3.2 使用 MVCC 备份（InnoDB）"></a>3.2 使用 MVCC 备份（InnoDB）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># InnoDB 引擎使用 MVCC，无需全局锁</span></span><br><span class="line">mysqldump -u root -p --single-transaction your_database &gt; backup.sql</span><br></pre></td></tr></table></figure>

<h3 id="3-3-热备工具"><a href="#3-3-热备工具" class="headerlink" title="3.3 热备工具"></a>3.3 热备工具</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Percona XtraBackup（物理备份）</span></span><br><span class="line">xtrabackup --backup --target-dir=/data/backup</span><br><span class="line"></span><br><span class="line"><span class="comment"># MySQL Enterprise Backup</span></span><br><span class="line">mysqlbackup --backup-dir=/data/backup backup</span><br></pre></td></tr></table></figure>

<h2 id="四、表级锁-表锁"><a href="#四、表级锁-表锁" class="headerlink" title="四、表级锁 - 表锁"></a>四、表级锁 - 表锁</h2><h3 id="4-1-表锁类型"><a href="#4-1-表锁类型" class="headerlink" title="4.1 表锁类型"></a>4.1 表锁类型</h3><table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
<th>兼容性</th>
</tr>
</thead>
<tbody><tr>
<td>表读锁（READ）</td>
<td>共享锁，允许多个事务同时读</td>
<td>与其他读锁兼容</td>
</tr>
<tr>
<td>表写锁（WRITE）</td>
<td>排他锁，只允许一个事务写</td>
<td>与任何锁都不兼容</td>
</tr>
</tbody></table>
<h3 id="4-2-加锁命令"><a href="#4-2-加锁命令" class="headerlink" title="4.2 加锁命令"></a>4.2 加锁命令</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 显式添加表锁</span></span><br><span class="line">LOCK TABLES employees READ;</span><br><span class="line">LOCK TABLES employees WRITE;</span><br><span class="line">LOCK TABLES employees READ, departments WRITE;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 释放表锁</span></span><br><span class="line">UNLOCK TABLES;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-表锁特性"><a href="#4-3-表锁特性" class="headerlink" title="4.3 表锁特性"></a>4.3 表锁特性</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 会话 A</span></span><br><span class="line">LOCK TABLES employees WRITE;</span><br><span class="line"><span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> <span class="number">5000</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 不解锁，锁不会释放</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 B（被阻塞）</span></span><br><span class="line"><span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> <span class="number">6000</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="comment">-- 等待会话 A 释放锁</span></span><br></pre></td></tr></table></figure>

<h3 id="4-4-表锁的优缺点"><a href="#4-4-表锁的优缺点" class="headerlink" title="4.4 表锁的优缺点"></a>4.4 表锁的优缺点</h3><table>
<thead>
<tr>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td>开销小</td>
<td>粒度大，易冲突</td>
</tr>
<tr>
<td>加锁快</td>
<td>并发度低</td>
</tr>
<tr>
<td>不会死锁</td>
<td>不适合高并发</td>
</tr>
</tbody></table>
<h2 id="五、表级锁-元数据锁"><a href="#五、表级锁-元数据锁" class="headerlink" title="五、表级锁 - 元数据锁"></a>五、表级锁 - 元数据锁</h2><h3 id="5-1-什么是元数据锁？"><a href="#5-1-什么是元数据锁？" class="headerlink" title="5.1 什么是元数据锁？"></a>5.1 什么是元数据锁？</h3><p><strong>元数据锁（Metadata Lock，MDL）</strong> 是 MySQL 5.5 引入的机制，用于保护表元数据的一致性。</p>
<h3 id="5-2-MDL-自动加锁"><a href="#5-2-MDL-自动加锁" class="headerlink" title="5.2 MDL 自动加锁"></a>5.2 MDL 自动加锁</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 任何访问表的语句都会自动添加 MDL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees;  <span class="comment">-- 添加 MDL 读锁</span></span><br><span class="line"><span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> ...; <span class="comment">-- 添加 MDL 写锁</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- DDL 操作需要 MDL 排他锁</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> employees <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> age <span class="type">INT</span>;  <span class="comment">-- 需要 MDL 排他锁</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-MDL-阻塞场景"><a href="#5-3-MDL-阻塞场景" class="headerlink" title="5.3 MDL 阻塞场景"></a>5.3 MDL 阻塞场景</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 会话 A：长查询</span></span><br><span class="line"><span class="keyword">SELECT</span> SLEEP(<span class="number">100</span>) <span class="keyword">FROM</span> employees;  <span class="comment">-- 持有 MDL 读锁</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 B：DDL 被阻塞</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> employees <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> age <span class="type">INT</span>;</span><br><span class="line"><span class="comment">-- Waiting for table metadata lock</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 C：DML 也被阻塞</span></span><br><span class="line"><span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> <span class="number">5000</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- Waiting for table metadata lock</span></span><br></pre></td></tr></table></figure>

<h3 id="5-4-查看-MDL-锁"><a href="#5-4-查看-MDL-锁" class="headerlink" title="5.4 查看 MDL 锁"></a>5.4 查看 MDL 锁</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- MySQL 5.7+ 查看元数据锁</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> performance_schema.metadata_locks</span><br><span class="line"><span class="keyword">WHERE</span> OBJECT_NAME <span class="operator">=</span> <span class="string">&#x27;employees&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看锁等待</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> performance_schema.data_lock_waits;</span><br></pre></td></tr></table></figure>

<h3 id="5-5-解决-MDL-阻塞"><a href="#5-5-解决-MDL-阻塞" class="headerlink" title="5.5 解决 MDL 阻塞"></a>5.5 解决 MDL 阻塞</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 1. 找到阻塞的会话</span></span><br><span class="line"><span class="keyword">SELECT</span> t.thread_id, t.processlist_id, t.processlist_info</span><br><span class="line"><span class="keyword">FROM</span> performance_schema.threads t</span><br><span class="line"><span class="keyword">JOIN</span> performance_schema.metadata_locks ml <span class="keyword">ON</span> t.thread_id <span class="operator">=</span> ml.owner_thread_id</span><br><span class="line"><span class="keyword">WHERE</span> ml.OBJECT_NAME <span class="operator">=</span> <span class="string">&#x27;employees&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 终止阻塞的会话</span></span><br><span class="line">KILL <span class="operator">&lt;</span>processlist_id<span class="operator">&gt;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="六、表级锁-意向锁"><a href="#六、表级锁-意向锁" class="headerlink" title="六、表级锁 - 意向锁"></a>六、表级锁 - 意向锁</h2><h3 id="6-1-什么是意向锁？"><a href="#6-1-什么是意向锁？" class="headerlink" title="6.1 什么是意向锁？"></a>6.1 什么是意向锁？</h3><p><strong>意向锁（Intention Lock）</strong> 是一种表级锁，用于表明事务将在行上添加何种类型的锁。</p>
<h3 id="6-2-意向锁类型"><a href="#6-2-意向锁类型" class="headerlink" title="6.2 意向锁类型"></a>6.2 意向锁类型</h3><table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
<th>添加时机</th>
</tr>
</thead>
<tbody><tr>
<td>意向共享锁（IS）</td>
<td>事务打算在某行上加共享锁</td>
<td>SELECT … LOCK IN SHARE MODE</td>
</tr>
<tr>
<td>意向排他锁（IX）</td>
<td>事务打算在某行上加排他锁</td>
<td>SELECT … FOR UPDATE</td>
</tr>
</tbody></table>
<h3 id="6-3-意向锁的作用"><a href="#6-3-意向锁的作用" class="headerlink" title="6.3 意向锁的作用"></a>6.3 意向锁的作用</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">问题：没有意向锁时，如何知道表中是否有行锁？</span><br><span class="line">解决：意向锁作为&quot;标记&quot;，快速判断表的使用情况</span><br><span class="line"></span><br><span class="line">场景：</span><br><span class="line">事务 A：对某行加行锁 → 先对表加 IX 锁</span><br><span class="line">事务 B：想对全表加锁 → 检查是否有 IX/IS 锁</span><br><span class="line">       如果有，说明有事务在使用某些行，需要等待</span><br></pre></td></tr></table></figure>

<h3 id="6-4-意向锁兼容性"><a href="#6-4-意向锁兼容性" class="headerlink" title="6.4 意向锁兼容性"></a>6.4 意向锁兼容性</h3><table>
<thead>
<tr>
<th></th>
<th>IS</th>
<th>IX</th>
<th>S</th>
<th>X</th>
</tr>
</thead>
<tbody><tr>
<td>IS</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✗</td>
</tr>
<tr>
<td>IX</td>
<td>✓</td>
<td>✓</td>
<td>✗</td>
<td>✗</td>
</tr>
<tr>
<td>S</td>
<td>✓</td>
<td>✗</td>
<td>✓</td>
<td>✗</td>
</tr>
<tr>
<td>X</td>
<td>✗</td>
<td>✗</td>
<td>✗</td>
<td>✗</td>
</tr>
</tbody></table>
<p><strong>说明</strong>：</p>
<ul>
<li>IS 与 IS、IX 兼容（多个事务可以同时有意向锁）</li>
<li>IX 与 IS、IX 兼容</li>
<li>S（表读锁）与 IS 兼容，与 IX 不兼容</li>
<li>X（表写锁）与任何锁都不兼容</li>
</ul>
<h2 id="七、表级锁-意向锁测试"><a href="#七、表级锁-意向锁测试" class="headerlink" title="七、表级锁 - 意向锁测试"></a>七、表级锁 - 意向锁测试</h2><h3 id="7-1-测试准备"><a href="#7-1-测试准备" class="headerlink" title="7.1 测试准备"></a>7.1 测试准备</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建测试表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> test_lock (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> test_lock (name) <span class="keyword">VALUES</span> (<span class="string">&#x27;张三&#x27;</span>), (<span class="string">&#x27;李四&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="7-2-测试意向共享锁"><a href="#7-2-测试意向共享锁" class="headerlink" title="7.2 测试意向共享锁"></a>7.2 测试意向共享锁</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 会话 A</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> test_lock <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span> LOCK <span class="keyword">IN</span> SHARE MODE;</span><br><span class="line"><span class="comment">-- 添加 IS 锁</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 B（查看锁）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> sys.innodb_lock_waits;</span><br><span class="line"><span class="comment">-- 或</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.innodb_trx;</span><br></pre></td></tr></table></figure>

<h3 id="7-3-测试意向排他锁"><a href="#7-3-测试意向排他锁" class="headerlink" title="7.3 测试意向排他锁"></a>7.3 测试意向排他锁</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 会话 A</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> test_lock <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line"><span class="comment">-- 添加 IX 锁</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 B（尝试加表锁，被阻塞）</span></span><br><span class="line">LOCK TABLES test_lock READ;</span><br><span class="line"><span class="comment">-- Waiting for lock</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 C（尝试修改其他行，不阻塞）</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> test_lock <span class="keyword">SET</span> name <span class="operator">=</span> <span class="string">&#x27;王五&#x27;</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="comment">-- 可以执行（行锁不冲突）</span></span><br></pre></td></tr></table></figure>

<h2 id="八、行级锁介绍"><a href="#八、行级锁介绍" class="headerlink" title="八、行级锁介绍"></a>八、行级锁介绍</h2><h3 id="8-1-什么是行级锁？"><a href="#8-1-什么是行级锁？" class="headerlink" title="8.1 什么是行级锁？"></a>8.1 什么是行级锁？</h3><p><strong>行级锁（Row Lock）</strong> 是 InnoDB 引擎提供的最细粒度锁，只锁定特定的行记录。</p>
<h3 id="8-2-行级锁特点"><a href="#8-2-行级锁特点" class="headerlink" title="8.2 行级锁特点"></a>8.2 行级锁特点</h3><table>
<thead>
<tr>
<th>特点</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>只锁住行</td>
<td>不影响其他行访问</td>
</tr>
<tr>
<td>仅 InnoDB 支持</td>
<td>MyISAM 只有表锁</td>
</tr>
<tr>
<td>可能死锁</td>
<td>需要注意死锁问题</td>
</tr>
<tr>
<td>开销较大</td>
<td>但并发度高</td>
</tr>
</tbody></table>
<h3 id="8-3-行锁添加方式"><a href="#8-3-行锁添加方式" class="headerlink" title="8.3 行锁添加方式"></a>8.3 行锁添加方式</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 当前读（会添加行锁）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;      <span class="comment">-- 排他锁</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span> LOCK <span class="keyword">IN</span> SHARE MODE; <span class="comment">-- 共享锁（8.0+ 改为 FOR SHARE）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- DML 语句（自动添加行锁）</span></span><br><span class="line"><span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> <span class="number">5000</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 快照读（不加锁，使用 MVCC）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;  <span class="comment">-- 普通 SELECT 不加锁</span></span><br></pre></td></tr></table></figure>

<h2 id="九、行级锁-行锁"><a href="#九、行级锁-行锁" class="headerlink" title="九、行级锁 - 行锁"></a>九、行级锁 - 行锁</h2><h3 id="9-1-行锁模式"><a href="#9-1-行锁模式" class="headerlink" title="9.1 行锁模式"></a>9.1 行锁模式</h3><table>
<thead>
<tr>
<th>模式</th>
<th>说明</th>
<th>兼容性</th>
</tr>
</thead>
<tbody><tr>
<td>S（共享锁）</td>
<td>允许读，不允许写</td>
<td>与其他 S 锁兼容</td>
</tr>
<tr>
<td>X（排他锁）</td>
<td>不允许读，不允许写</td>
<td>与任何锁都不兼容</td>
</tr>
</tbody></table>
<h3 id="9-2-行锁测试"><a href="#9-2-行锁测试" class="headerlink" title="9.2 行锁测试"></a>9.2 行锁测试</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 会话 A</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> <span class="number">5000</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 对 id=1 的行添加 X 锁</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 B</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> <span class="number">6000</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 被阻塞，等待会话 A 释放锁</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 C</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> <span class="number">7000</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="comment">-- 可以执行（不同行，不冲突）</span></span><br></pre></td></tr></table></figure>

<h3 id="9-3-行锁升级为表锁"><a href="#9-3-行锁升级为表锁" class="headerlink" title="9.3 行锁升级为表锁"></a>9.3 行锁升级为表锁</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 情况 1：没有索引，全表扫描</span></span><br><span class="line"><span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> status <span class="operator">=</span> <span class="number">1</span>;  <span class="comment">-- 所有行都被锁定，相当于表锁</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 情况 2：索引失效</span></span><br><span class="line"><span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> status <span class="operator">=</span> <span class="number">1</span> <span class="keyword">WHERE</span> <span class="keyword">YEAR</span>(hire_date) <span class="operator">=</span> <span class="number">2024</span>;</span><br><span class="line"><span class="comment">-- 索引失效，全表扫描，所有行加锁</span></span><br></pre></td></tr></table></figure>

<h2 id="十、行级锁-间隙锁"><a href="#十、行级锁-间隙锁" class="headerlink" title="十、行级锁 - 间隙锁"></a>十、行级锁 - 间隙锁</h2><h3 id="10-1-什么是间隙锁？"><a href="#10-1-什么是间隙锁？" class="headerlink" title="10.1 什么是间隙锁？"></a>10.1 什么是间隙锁？</h3><p><strong>间隙锁（Gap Lock）</strong> 锁定索引记录之间的间隙，防止其他事务在间隙中插入新记录。</p>
<h3 id="10-2-间隙锁场景"><a href="#10-2-间隙锁场景" class="headerlink" title="10.2 间隙锁场景"></a>10.2 间隙锁场景</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 数据：id = 1, 5, 10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 A（范围查询加锁）</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> id <span class="keyword">BETWEEN</span> <span class="number">5</span> <span class="keyword">AND</span> <span class="number">10</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line"><span class="comment">-- 锁定 id=5 和 id=10 的行，以及 (5, 10) 的间隙</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 B（插入被阻塞）</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> employees (id, name) <span class="keyword">VALUES</span> (<span class="number">7</span>, <span class="string">&#x27;张三&#x27;</span>);</span><br><span class="line"><span class="comment">-- 被阻塞，间隙锁阻止插入</span></span><br></pre></td></tr></table></figure>

<h3 id="10-3-间隙锁的目的"><a href="#10-3-间隙锁的目的" class="headerlink" title="10.3 间隙锁的目的"></a>10.3 间隙锁的目的</h3><p><strong>防止幻读（Phantom Read）</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- RR 隔离级别下</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话 A</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> id <span class="operator">&gt;</span> <span class="number">5</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line"><span class="comment">-- 第一次查询：id = 10, 15</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 如果没有间隙锁：</span></span><br><span class="line"><span class="comment">-- 会话 B：INSERT INTO employees (id, name) VALUES (8, &#x27;张三&#x27;);</span></span><br><span class="line"><span class="comment">-- 会话 A 第二次查询：id = 8, 10, 15（出现幻读）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 有间隙锁：</span></span><br><span class="line"><span class="comment">-- 会话 B 的 INSERT 被阻塞，防止幻读</span></span><br></pre></td></tr></table></figure>

<h2 id="十一、行级锁-临键锁"><a href="#十一、行级锁-临键锁" class="headerlink" title="十一、行级锁 - 临键锁"></a>十一、行级锁 - 临键锁</h2><h3 id="11-1-什么是临键锁？"><a href="#11-1-什么是临键锁？" class="headerlink" title="11.1 什么是临键锁？"></a>11.1 什么是临键锁？</h3><p><strong>临键锁（Next-Key Lock）</strong> &#x3D; 记录锁 + 间隙锁，锁定记录本身和前面的间隙。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">数据：id = 1, 5, 10, 15</span><br><span class="line"></span><br><span class="line">查询：SELECT * FROM employees WHERE id &gt;= 5 AND id &lt; 15 FOR UPDATE;</span><br><span class="line"></span><br><span class="line">临键锁锁定范围：</span><br><span class="line">- (1, 5]  ← 锁住 id=5 和间隙 (1,5)</span><br><span class="line">- (5, 10] ← 锁住 id=10 和间隙 (5,10]</span><br><span class="line">- 注意：不包含 15（开区间）</span><br></pre></td></tr></table></figure>

<h3 id="11-2-临键锁降级"><a href="#11-2-临键锁降级" class="headerlink" title="11.2 临键锁降级"></a>11.2 临键锁降级</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 唯一索引等值查询，临键锁降级为记录锁</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 前提：id 是唯一索引</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">5</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line"><span class="comment">-- 只锁 id=5 的记录，不锁间隙</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 非唯一索引或范围查询，使用临键锁</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">5</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line"><span class="comment">-- 临键锁，锁住所有 dept_id=5 的记录和间隙</span></span><br></pre></td></tr></table></figure>

<h2 id="十二、小结"><a href="#十二、小结" class="headerlink" title="十二、小结"></a>十二、小结</h2><h3 id="锁类型速查"><a href="#锁类型速查" class="headerlink" title="锁类型速查"></a>锁类型速查</h3><table>
<thead>
<tr>
<th>锁类型</th>
<th>粒度</th>
<th>使用场景</th>
</tr>
</thead>
<tbody><tr>
<td>全局锁</td>
<td>实例级</td>
<td>全库备份</td>
</tr>
<tr>
<td>表锁</td>
<td>表级</td>
<td>DDL、MyISAM</td>
</tr>
<tr>
<td>元数据锁</td>
<td>表级</td>
<td>自动添加</td>
</tr>
<tr>
<td>意向锁</td>
<td>表级</td>
<td>行锁前置标记</td>
</tr>
<tr>
<td>行锁</td>
<td>行级</td>
<td>InnoDB DML</td>
</tr>
<tr>
<td>间隙锁</td>
<td>间隙</td>
<td>防止幻读</td>
</tr>
<tr>
<td>临键锁</td>
<td>记录 + 间隙</td>
<td>RR 隔离级别</td>
</tr>
</tbody></table>
<h3 id="锁兼容性总结"><a href="#锁兼容性总结" class="headerlink" title="锁兼容性总结"></a>锁兼容性总结</h3><table>
<thead>
<tr>
<th></th>
<th>全局锁</th>
<th>表锁</th>
<th>意向锁</th>
<th>行锁</th>
</tr>
</thead>
<tbody><tr>
<td>全局锁</td>
<td>✗</td>
<td>✗</td>
<td>✗</td>
<td>-</td>
</tr>
<tr>
<td>表锁</td>
<td>✗</td>
<td>读读兼容</td>
<td>部分兼容</td>
<td>-</td>
</tr>
<tr>
<td>意向锁</td>
<td>✗</td>
<td>部分兼容</td>
<td>互相兼容</td>
<td>-</td>
</tr>
<tr>
<td>行锁</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>读读兼容</td>
</tr>
</tbody></table>
<h3 id="下一章预告"><a href="#下一章预告" class="headerlink" title="下一章预告"></a>下一章预告</h3><p>下一篇文章将深入介绍<strong>InnoDB 存储引擎</strong>，包括：</p>
<ul>
<li>InnoDB 逻辑存储结构</li>
<li>内存结构</li>
<li>磁盘结构</li>
<li>后台线程</li>
</ul>
<hr>
<p><strong>下一篇</strong>：[MySQL 进阶教程 11-01 InnoDB 存储引擎深入](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 11-01 InnoDB 存储引擎深入&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 进阶教程 09-01 SQL 优化](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 09-01 SQL 优化&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 进阶教程</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>并发控制</tag>
        <tag>锁机制</tag>
        <tag>死锁</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 进阶教程 11-01 InnoDB 存储引擎深入</title>
    <url>/2026/02/24/MySQL%20%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B%2011-01%20InnoDB%20%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E6%B7%B1%E5%85%A5/</url>
    <content><![CDATA[<h1 id="MySQL-进阶教程-11-01-InnoDB-存储引擎深入"><a href="#MySQL-进阶教程-11-01-InnoDB-存储引擎深入" class="headerlink" title="MySQL 进阶教程 11-01 InnoDB 存储引擎深入"></a>MySQL 进阶教程 11-01 InnoDB 存储引擎深入</h1><p>InnoDB 是 MySQL 的默认存储引擎，也是使用最广泛的引擎。本文将深入探讨 InnoDB 的内部架构、存储结构、事务原理和 MVCC 机制。</p>
<h2 id="一、InnoDB-逻辑存储结构"><a href="#一、InnoDB-逻辑存储结构" class="headerlink" title="一、InnoDB 逻辑存储结构"></a>一、InnoDB 逻辑存储结构</h2><h3 id="1-1-存储结构层次"><a href="#1-1-存储结构层次" class="headerlink" title="1.1 存储结构层次"></a>1.1 存储结构层次</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">InnoDB 存储结构</span><br><span class="line">├── 表空间（Tablespace）</span><br><span class="line">│   ├── 段（Segment）</span><br><span class="line">│   │   ├── 区（Extent）</span><br><span class="line">│   │   │   ├── 页（Page）</span><br><span class="line">│   │   │   │   └── 行（Row）</span><br></pre></td></tr></table></figure>

<h3 id="1-2-表空间"><a href="#1-2-表空间" class="headerlink" title="1.2 表空间"></a>1.2 表空间</h3><p><strong>表空间</strong> 是 InnoDB 的最高层存储结构，分为：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 系统表空间（shared tablespace）</span></span><br><span class="line"><span class="comment">-- 存储：数据字典、undo log、doublewrite buffer、change buffer 等</span></span><br><span class="line"><span class="comment">-- 文件：ibdata1, ibdata2...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 独立表空间（file-per-table tablespace）</span></span><br><span class="line"><span class="comment">-- 每个表一个 .ibd 文件</span></span><br><span class="line"><span class="comment">-- MySQL 5.6+ 默认开启</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;innodb_file_per_table&#x27;</span>;  <span class="comment">-- ON</span></span><br></pre></td></tr></table></figure>

<h3 id="1-3-段"><a href="#1-3-段" class="headerlink" title="1.3 段"></a>1.3 段</h3><p><strong>段（Segment）</strong> 是不同数据类型的存储区域：</p>
<table>
<thead>
<tr>
<th>段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>数据段</td>
<td>存储表数据（聚簇索引的叶子节点）</td>
</tr>
<tr>
<td>索引段</td>
<td>存储索引数据（非聚簇索引）</td>
</tr>
<tr>
<td>Undo 段</td>
<td>存储 Undo Log</td>
</tr>
<tr>
<td>临时段</td>
<td>排序、临时表等</td>
</tr>
</tbody></table>
<h3 id="1-4-区"><a href="#1-4-区" class="headerlink" title="1.4 区"></a>1.4 区</h3><p><strong>区（Extent）</strong> 是连续的页集合：</p>
<ul>
<li>1 个区 &#x3D; 64 个连续页</li>
<li>默认页大小 16KB，1 个区 &#x3D; 1MB</li>
</ul>
<h3 id="1-5-页"><a href="#1-5-页" class="headerlink" title="1.5 页"></a>1.5 页</h3><p><strong>页（Page）</strong> 是 InnoDB 最小的存储单位：</p>
<table>
<thead>
<tr>
<th>页类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>数据页</td>
<td>存储记录数据</td>
</tr>
<tr>
<td>索引页</td>
<td>存储索引数据</td>
</tr>
<tr>
<td>Undo 页</td>
<td>存储 Undo Log</td>
</tr>
<tr>
<td>系统页</td>
<td>存储系统信息</td>
</tr>
</tbody></table>
<h2 id="二、内存结构"><a href="#二、内存结构" class="headerlink" title="二、内存结构"></a>二、内存结构</h2><h3 id="2-1-InnoDB-内存结构概览"><a href="#2-1-InnoDB-内存结构概览" class="headerlink" title="2.1 InnoDB 内存结构概览"></a>2.1 InnoDB 内存结构概览</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">InnoDB Buffer Pool</span><br><span class="line">├── 数据页缓存</span><br><span class="line">├── 索引页缓存</span><br><span class="line">├── 插入缓冲（Insert Buffer）</span><br><span class="line">├── 自适应哈希索引（AHI）</span><br><span class="line">└── 锁信息</span><br></pre></td></tr></table></figure>

<h3 id="2-2-Buffer-Pool"><a href="#2-2-Buffer-Pool" class="headerlink" title="2.2 Buffer Pool"></a>2.2 Buffer Pool</h3><p><strong>Buffer Pool</strong> 是 InnoDB 最重要的内存区域，用于缓存数据和索引页。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看 Buffer Pool 大小</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;innodb_buffer_pool_size&#x27;</span>;</span><br><span class="line"><span class="comment">-- 建议：物理内存的 70-80%</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看 Buffer Pool 使用情况</span></span><br><span class="line"><span class="keyword">SHOW</span> ENGINE INNODB STATUS\G</span><br><span class="line"><span class="comment">-- 或</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.innodb_buffer_pool_stats;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-Buffer-Pool-工作原理"><a href="#2-3-Buffer-Pool-工作原理" class="headerlink" title="2.3 Buffer Pool 工作原理"></a>2.3 Buffer Pool 工作原理</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">读取数据流程：</span><br><span class="line">1. 检查数据页是否在 Buffer Pool 中</span><br><span class="line">2. 如果在（命中），直接返回</span><br><span class="line">3. 如果不在（未命中），从磁盘加载到 Buffer Pool</span><br><span class="line"></span><br><span class="line">写入数据流程：</span><br><span class="line">1. 修改 Buffer Pool 中的数据页（脏页）</span><br><span class="line">2. 标记为脏页</span><br><span class="line">3. 后台线程异步刷盘到磁盘</span><br></pre></td></tr></table></figure>

<h3 id="2-4-脏页刷新"><a href="#2-4-脏页刷新" class="headerlink" title="2.4 脏页刷新"></a>2.4 脏页刷新</h3><p><strong>脏页（Dirty Page）</strong>：Buffer Pool 中被修改但未刷盘的页。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 脏页刷新触发条件：</span></span><br><span class="line"><span class="comment">-- 1. Redo Log 空间不足</span></span><br><span class="line"><span class="comment">-- 2. Buffer Pool 空间不足（LRU 淘汰）</span></span><br><span class="line"><span class="comment">-- 3. 系统空闲时</span></span><br><span class="line"><span class="comment">-- 4. 正常关闭时</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看脏页比例</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;Innodb_buffer_pool_pages_dirty&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="三、磁盘结构"><a href="#三、磁盘结构" class="headerlink" title="三、磁盘结构"></a>三、磁盘结构</h2><h3 id="3-1-InnoDB-主要文件"><a href="#3-1-InnoDB-主要文件" class="headerlink" title="3.1 InnoDB 主要文件"></a>3.1 InnoDB 主要文件</h3><table>
<thead>
<tr>
<th>文件</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>ibdata*</td>
<td>系统表空间文件</td>
</tr>
<tr>
<td>*.ibd</td>
<td>独立表空间文件</td>
</tr>
<tr>
<td>ib_logfile*</td>
<td>Redo Log 文件</td>
</tr>
<tr>
<td>ibtmp*</td>
<td>临时表空间</td>
</tr>
</tbody></table>
<h3 id="3-2-表空间文件结构"><a href="#3-2-表空间文件结构" class="headerlink" title="3.2 表空间文件结构"></a>3.2 表空间文件结构</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.ibd 文件结构</span><br><span class="line">├── File Header（38 字节）</span><br><span class="line">├── File Foot（38 字节）</span><br><span class="line">└── Pages</span><br><span class="line">    ├── Page 0: Insert Cache</span><br><span class="line">    ├── Page 1: Data Dictionary</span><br><span class="line">    ├── Page 2: Undo Log</span><br><span class="line">    ├── Page 3: Change Log</span><br><span class="line">    └── Page 4+: 用户数据</span><br></pre></td></tr></table></figure>

<h2 id="四、后台线程"><a href="#四、后台线程" class="headerlink" title="四、后台线程"></a>四、后台线程</h2><h3 id="4-1-InnoDB-后台线程"><a href="#4-1-InnoDB-后台线程" class="headerlink" title="4.1 InnoDB 后台线程"></a>4.1 InnoDB 后台线程</h3><table>
<thead>
<tr>
<th>线程</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>Master Thread</td>
<td>刷新 Buffer Pool、Undo 页</td>
</tr>
<tr>
<td>IO Thread</td>
<td>处理 IO 请求</td>
</tr>
<tr>
<td>Purge Thread</td>
<td>清理 Undo Log</td>
</tr>
<tr>
<td>Page Cleaner Thread</td>
<td>刷新脏页</td>
</tr>
</tbody></table>
<h3 id="4-2-Master-Thread"><a href="#4-2-Master-Thread" class="headerlink" title="4.2 Master Thread"></a>4.2 Master Thread</h3><p><strong>Master Thread</strong> 是 InnoDB 最重要的后台线程：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Master Thread 工作周期：</span><br><span class="line">├── 每秒执行</span><br><span class="line">│   ├── 刷新日志缓冲</span><br><span class="line">│   └── 合并插入缓冲</span><br><span class="line">├── 每 10 秒执行</span><br><span class="line">│   ├── 刷新脏页</span><br><span class="line">│   └── 清理 Undo 页</span><br><span class="line">└── 每 300 秒执行</span><br><span class="line">    └── 清理无用数据</span><br></pre></td></tr></table></figure>

<h2 id="五、事务原理概述"><a href="#五、事务原理概述" class="headerlink" title="五、事务原理概述"></a>五、事务原理概述</h2><h3 id="5-1-InnoDB-事务特性"><a href="#5-1-InnoDB-事务特性" class="headerlink" title="5.1 InnoDB 事务特性"></a>5.1 InnoDB 事务特性</h3><p>InnoDB 实现了完整的 ACID 事务特性：</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>实现机制</th>
</tr>
</thead>
<tbody><tr>
<td>原子性</td>
<td>Undo Log</td>
</tr>
<tr>
<td>一致性</td>
<td>锁 + MVCC</td>
</tr>
<tr>
<td>隔离性</td>
<td>锁 + MVCC</td>
</tr>
<tr>
<td>持久性</td>
<td>Redo Log</td>
</tr>
</tbody></table>
<h3 id="5-2-事务日志"><a href="#5-2-事务日志" class="headerlink" title="5.2 事务日志"></a>5.2 事务日志</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">InnoDB 事务日志</span><br><span class="line">├── Redo Log（重做日志）- 保证持久性</span><br><span class="line">└── Undo Log（回滚日志）- 保证原子性</span><br></pre></td></tr></table></figure>

<h2 id="六、Redo-Log"><a href="#六、Redo-Log" class="headerlink" title="六、Redo Log"></a>六、Redo Log</h2><h3 id="6-1-Redo-Log-作用"><a href="#6-1-Redo-Log-作用" class="headerlink" title="6.1 Redo Log 作用"></a>6.1 Redo Log 作用</h3><p><strong>Redo Log（重做日志）</strong> 记录数据页的物理修改，用于：</p>
<ul>
<li>崩溃恢复</li>
<li>保证事务持久性</li>
</ul>
<h3 id="6-2-Redo-Log-结构"><a href="#6-2-Redo-Log-结构" class="headerlink" title="6.2 Redo Log 结构"></a>6.2 Redo Log 结构</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Redo Log 是循环写入的环形文件：</span><br><span class="line">┌──────────────────────────────────────┐</span><br><span class="line">│ write pos ──────→ checkpoint         │</span><br><span class="line">│   (写入位置)         (回收位置)        │</span><br><span class="line">└──────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">- write pos 到 checkpoint 之间：空闲空间</span><br><span class="line">- checkpoint 到 write pos 之间：待刷盘数据</span><br></pre></td></tr></table></figure>

<h3 id="6-3-Redo-Log-写入流程"><a href="#6-3-Redo-Log-写入流程" class="headerlink" title="6.3 Redo Log 写入流程"></a>6.3 Redo Log 写入流程</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 事务修改数据 → 生成 Redo Record</span><br><span class="line">2. Redo Record 写入 Log Buffer</span><br><span class="line">3. Log Buffer 刷新到 Redo Log 文件</span><br><span class="line">4. 数据页标记为脏页</span><br><span class="line">5. 后台线程异步刷盘</span><br></pre></td></tr></table></figure>

<h3 id="6-4-Redo-Log-配置"><a href="#6-4-Redo-Log-配置" class="headerlink" title="6.4 Redo Log 配置"></a>6.4 Redo Log 配置</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看 Redo Log 配置</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;innodb_log_file_size&#x27;</span>;   <span class="comment">-- 日志文件大小</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;innodb_log_buffer_size&#x27;</span>; <span class="comment">-- 日志缓冲大小</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;innodb_flush_log_at_trx_commit&#x27;</span>;</span><br><span class="line"><span class="comment">-- 0: 每秒刷盘</span></span><br><span class="line"><span class="comment">-- 1: 每次事务提交刷盘（默认，最安全）</span></span><br><span class="line"><span class="comment">-- 2: 每次事务写入但不刷盘，每秒刷盘</span></span><br></pre></td></tr></table></figure>

<h2 id="七、Undo-Log"><a href="#七、Undo-Log" class="headerlink" title="七、Undo Log"></a>七、Undo Log</h2><h3 id="7-1-Undo-Log-作用"><a href="#7-1-Undo-Log-作用" class="headerlink" title="7.1 Undo Log 作用"></a>7.1 Undo Log 作用</h3><p><strong>Undo Log（回滚日志）</strong> 记录逻辑操作的逆操作，用于：</p>
<ul>
<li>事务回滚</li>
<li>MVCC 版本控制</li>
<li>崩溃恢复</li>
</ul>
<h3 id="7-2-Undo-Log-示例"><a href="#7-2-Undo-Log-示例" class="headerlink" title="7.2 Undo Log 示例"></a>7.2 Undo Log 示例</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 原始操作</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> users (id, name) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;张三&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Undo Log 记录</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 原始操作</span></span><br><span class="line"><span class="keyword">UPDATE</span> users <span class="keyword">SET</span> name <span class="operator">=</span> <span class="string">&#x27;李四&#x27;</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Undo Log 记录</span></span><br><span class="line"><span class="keyword">UPDATE</span> users <span class="keyword">SET</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h3 id="7-3-Undo-Log-类型"><a href="#7-3-Undo-Log-类型" class="headerlink" title="7.3 Undo Log 类型"></a>7.3 Undo Log 类型</h3><table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Insert Undo Log</td>
<td>INSERT 操作产生，事务提交后可立即清除</td>
</tr>
<tr>
<td>Update Undo Log</td>
<td>UPDATE&#x2F;DELETE 操作产生，用于 MVCC</td>
</tr>
</tbody></table>
<h2 id="八、MVCC-基本概念"><a href="#八、MVCC-基本概念" class="headerlink" title="八、MVCC 基本概念"></a>八、MVCC 基本概念</h2><h3 id="8-1-什么是-MVCC？"><a href="#8-1-什么是-MVCC？" class="headerlink" title="8.1 什么是 MVCC？"></a>8.1 什么是 MVCC？</h3><p><strong>MVCC（Multi-Version Concurrency Control，多版本并发控制）</strong> 是一种并发控制机制，通过保存数据的历史版本来实现读写不阻塞。</p>
<h3 id="8-2-MVCC-的优势"><a href="#8-2-MVCC-的优势" class="headerlink" title="8.2 MVCC 的优势"></a>8.2 MVCC 的优势</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">传统锁机制：</span><br><span class="line">- 读阻塞写，写阻塞读</span><br><span class="line">- 并发度低</span><br><span class="line"></span><br><span class="line">MVCC：</span><br><span class="line">- 读不阻塞写，写不阻塞读</span><br><span class="line">- 并发度高</span><br></pre></td></tr></table></figure>

<h3 id="8-3-MVCC-实现原理"><a href="#8-3-MVCC-实现原理" class="headerlink" title="8.3 MVCC 实现原理"></a>8.3 MVCC 实现原理</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MVCC 通过以下方式实现：</span><br><span class="line">1. 每行数据有多个版本</span><br><span class="line">2. 每个事务看到特定版本的数据</span><br><span class="line">3. 通过 ReadView 决定可见性</span><br></pre></td></tr></table></figure>

<h2 id="九、MVCC-隐藏字段"><a href="#九、MVCC-隐藏字段" class="headerlink" title="九、MVCC 隐藏字段"></a>九、MVCC 隐藏字段</h2><h3 id="9-1-隐藏列"><a href="#9-1-隐藏列" class="headerlink" title="9.1 隐藏列"></a>9.1 隐藏列</h3><p>InnoDB 每行记录有三个隐藏列：</p>
<table>
<thead>
<tr>
<th>隐藏列</th>
<th>大小</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>DB_ROW_ID</td>
<td>6 字节</td>
<td>行 ID（无主键时自动生成）</td>
</tr>
<tr>
<td>DB_TRX_ID</td>
<td>6 字节</td>
<td>最近修改事务 ID</td>
</tr>
<tr>
<td>DB_ROLL_PTR</td>
<td>7 字节</td>
<td>回滚指针（指向 Undo Log）</td>
</tr>
</tbody></table>
<h3 id="9-2-隐藏列查看"><a href="#9-2-隐藏列查看" class="headerlink" title="9.2 隐藏列查看"></a>9.2 隐藏列查看</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看表的实际列（包含隐藏列）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.columns</span><br><span class="line"><span class="keyword">WHERE</span> table_schema <span class="operator">=</span> <span class="string">&#x27;your_db&#x27;</span> <span class="keyword">AND</span> table_name <span class="operator">=</span> <span class="string">&#x27;your_table&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 隐藏列不会显示，但实际存在</span></span><br></pre></td></tr></table></figure>

<h2 id="十、MVCC-版本链"><a href="#十、MVCC-版本链" class="headerlink" title="十、MVCC 版本链"></a>十、MVCC 版本链</h2><h3 id="10-1-版本链结构"><a href="#10-1-版本链结构" class="headerlink" title="10.1 版本链结构"></a>10.1 版本链结构</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">版本链通过 DB_ROLL_PTR 连接：</span><br><span class="line"></span><br><span class="line">当前行 → [版本 3, trx=103] → [版本 2, trx=102] → [版本 1, trx=101] → NULL</span><br><span class="line">           ↓                   ↓                   ↓</span><br><span class="line">       Undo Log            Undo Log            Undo Log</span><br></pre></td></tr></table></figure>

<h3 id="10-2-版本链形成过程"><a href="#10-2-版本链形成过程" class="headerlink" title="10.2 版本链形成过程"></a>10.2 版本链形成过程</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 初始状态</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> users (id, name) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;张三&#x27;</span>);</span><br><span class="line"><span class="comment">-- 版本 1: name=&#x27;张三&#x27;, trx_id=101</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 第一次更新</span></span><br><span class="line"><span class="keyword">UPDATE</span> users <span class="keyword">SET</span> name <span class="operator">=</span> <span class="string">&#x27;李四&#x27;</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 版本 2: name=&#x27;李四&#x27;, trx_id=102</span></span><br><span class="line"><span class="comment">-- 旧版本通过回滚指针连接</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 第二次更新</span></span><br><span class="line"><span class="keyword">UPDATE</span> users <span class="keyword">SET</span> name <span class="operator">=</span> <span class="string">&#x27;王五&#x27;</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 版本 3: name=&#x27;王五&#x27;, trx_id=103</span></span><br><span class="line"><span class="comment">-- 形成版本链</span></span><br></pre></td></tr></table></figure>

<h2 id="十一、MVCC-ReadView"><a href="#十一、MVCC-ReadView" class="headerlink" title="十一、MVCC ReadView"></a>十一、MVCC ReadView</h2><h3 id="11-1-什么是-ReadView？"><a href="#11-1-什么是-ReadView？" class="headerlink" title="11.1 什么是 ReadView？"></a>11.1 什么是 ReadView？</h3><p><strong>ReadView</strong> 是事务启动时生成的快照，包含：</p>
<ul>
<li>当前活跃事务列表</li>
<li>最小活跃事务 ID</li>
<li>最大事务 ID</li>
</ul>
<h3 id="11-2-ReadView-可见性规则"><a href="#11-2-ReadView-可见性规则" class="headerlink" title="11.2 ReadView 可见性规则"></a>11.2 ReadView 可见性规则</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">假设 ReadView 包含：</span><br><span class="line">- m_ids = [100, 102, 105]  ← 活跃事务列表</span><br><span class="line">- min_trx_id = 100         ← 最小活跃事务 ID</span><br><span class="line">- max_trx_id = 106         ← 最大事务 ID</span><br><span class="line"></span><br><span class="line">数据版本 trx_id = X：</span><br><span class="line">1. X &lt; min_trx_id → 可见（事务已提交）</span><br><span class="line">2. X &gt;= max_trx_id → 不可见（事务在 ReadView 之后启动）</span><br><span class="line">3. X in m_ids → 不可见（事务还在运行）</span><br><span class="line">4. min_trx_id &lt;= X &lt; max_trx_id 且 X not in m_ids → 可见（事务已提交）</span><br></pre></td></tr></table></figure>

<h2 id="十二、MVCC-RC-级别原理"><a href="#十二、MVCC-RC-级别原理" class="headerlink" title="十二、MVCC RC 级别原理"></a>十二、MVCC RC 级别原理</h2><h3 id="12-1-RC-级别的-ReadView"><a href="#12-1-RC-级别的-ReadView" class="headerlink" title="12.1 RC 级别的 ReadView"></a>12.1 RC 级别的 ReadView</h3><p><strong>READ COMMITTED（RC）</strong> 级别：每次 SELECT 都生成新的 ReadView。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- RC 级别</span></span><br><span class="line"><span class="comment">-- 事务 A</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;  <span class="comment">-- 生成 ReadView 1</span></span><br><span class="line"><span class="comment">-- 此时看到数据版本 V1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 事务 B 提交</span></span><br><span class="line"><span class="keyword">UPDATE</span> users <span class="keyword">SET</span> name <span class="operator">=</span> <span class="string">&#x27;新值&#x27;</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 事务 A 再次查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;  <span class="comment">-- 生成 ReadView 2</span></span><br><span class="line"><span class="comment">-- 此时可以看到事务 B 提交的数据 V2（幻读）</span></span><br></pre></td></tr></table></figure>

<h2 id="十三、MVCC-RR-级别原理"><a href="#十三、MVCC-RR-级别原理" class="headerlink" title="十三、MVCC RR 级别原理"></a>十三、MVCC RR 级别原理</h2><h3 id="13-1-RR-级别的-ReadView"><a href="#13-1-RR-级别的-ReadView" class="headerlink" title="13.1 RR 级别的 ReadView"></a>13.1 RR 级别的 ReadView</h3><p><strong>REPEATABLE READ（RR）</strong> 级别：只在第一次 SELECT 时生成 ReadView。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- RR 级别</span></span><br><span class="line"><span class="comment">-- 事务 A</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;  <span class="comment">-- 生成 ReadView 1</span></span><br><span class="line"><span class="comment">-- 此时看到数据版本 V1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 事务 B 提交</span></span><br><span class="line"><span class="keyword">UPDATE</span> users <span class="keyword">SET</span> name <span class="operator">=</span> <span class="string">&#x27;新值&#x27;</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 事务 A 再次查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;  <span class="comment">-- 复用 ReadView 1</span></span><br><span class="line"><span class="comment">-- 仍然看到 V1（可重复读）</span></span><br></pre></td></tr></table></figure>

<h3 id="13-2-RR-级别解决幻读"><a href="#13-2-RR-级别解决幻读" class="headerlink" title="13.2 RR 级别解决幻读"></a>13.2 RR 级别解决幻读</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">RR 级别通过两种方式解决幻读：</span><br><span class="line">1. MVCC - 快照读（普通 SELECT）</span><br><span class="line">2. 临键锁 - 当前读（SELECT FOR UPDATE）</span><br></pre></td></tr></table></figure>

<h2 id="十四、小结"><a href="#十四、小结" class="headerlink" title="十四、小结"></a>十四、小结</h2><h3 id="InnoDB-架构总结"><a href="#InnoDB-架构总结" class="headerlink" title="InnoDB 架构总结"></a>InnoDB 架构总结</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">InnoDB 存储引擎</span><br><span class="line">├── 内存结构</span><br><span class="line">│   └── Buffer Pool（数据缓存）</span><br><span class="line">├── 磁盘结构</span><br><span class="line">│   ├── 表空间</span><br><span class="line">│   └── Redo Log/Undo Log</span><br><span class="line">├── 后台线程</span><br><span class="line">│   ├── Master Thread</span><br><span class="line">│   └── Page Cleaner</span><br><span class="line">└── 事务机制</span><br><span class="line">    ├── Redo Log（持久性）</span><br><span class="line">    ├── Undo Log（原子性）</span><br><span class="line">    └── MVCC（隔离性）</span><br></pre></td></tr></table></figure>

<h3 id="MVCC-核心概念"><a href="#MVCC-核心概念" class="headerlink" title="MVCC 核心概念"></a>MVCC 核心概念</h3><table>
<thead>
<tr>
<th>概念</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>隐藏列</td>
<td>DB_TRX_ID、DB_ROLL_PTR</td>
</tr>
<tr>
<td>版本链</td>
<td>通过回滚指针连接的多个版本</td>
</tr>
<tr>
<td>ReadView</td>
<td>事务快照，决定可见性</td>
</tr>
<tr>
<td>RC 级别</td>
<td>每次查询生成新 ReadView</td>
</tr>
<tr>
<td>RR 级别</td>
<td>第一次查询生成 ReadView 并复用</td>
</tr>
</tbody></table>
<h3 id="下一章预告"><a href="#下一章预告" class="headerlink" title="下一章预告"></a>下一章预告</h3><p>下一篇文章将介绍<strong>视图</strong>，包括：</p>
<ul>
<li>视图的概念和语法</li>
<li>视图的检查选项</li>
<li>视图的更新</li>
<li>视图的应用场景</li>
</ul>
<hr>
<p><strong>上一篇</strong>：[MySQL 进阶教程 10-01 锁机制详解](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 10-01 锁机制详解&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 进阶教程</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>事务</tag>
        <tag>存储引擎</tag>
        <tag>InnoDB</tag>
        <tag>MVCC</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 进阶教程 07-01 索引详解</title>
    <url>/2026/02/24/MySQL%20%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B%2007-01%20%E7%B4%A2%E5%BC%95%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<h1 id="MySQL-进阶教程-07-01-索引详解"><a href="#MySQL-进阶教程-07-01-索引详解" class="headerlink" title="MySQL 进阶教程 07-01 索引详解"></a>MySQL 进阶教程 07-01 索引详解</h1><p>索引是数据库性能优化的核心技术。本文将详细介绍索引的概念、数据结构、分类、创建和使用方法，以及如何使用 EXPLAIN 分析查询性能。</p>
<h2 id="一、索引概述"><a href="#一、索引概述" class="headerlink" title="一、索引概述"></a>一、索引概述</h2><h3 id="1-1-什么是索引？"><a href="#1-1-什么是索引？" class="headerlink" title="1.1 什么是索引？"></a>1.1 什么是索引？</h3><p><strong>索引（Index）</strong> 是帮助数据库高效获取数据的数据结构。类似于书籍的目录，通过索引可以快速定位到目标数据，而无需扫描整个表。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">无索引查询（全表扫描）：</span><br><span class="line">数据：[A][B][C][D][E][F][G]...[Z]</span><br><span class="line">查找 M：需要遍历 13 次</span><br><span class="line"></span><br><span class="line">有索引查询：</span><br><span class="line">索引：A→1, B→2, C→3, ..., M→13, ..., Z→26</span><br><span class="line">查找 M：直接定位，1 次找到</span><br></pre></td></tr></table></figure>

<h3 id="1-2-索引的优缺点"><a href="#1-2-索引的优缺点" class="headerlink" title="1.2 索引的优缺点"></a>1.2 索引的优缺点</h3><p><strong>优点</strong>：</p>
<ul>
<li>大幅提高查询速度（最主要目的）</li>
<li>加速表连接（JOIN）操作</li>
<li>加速 ORDER BY 和 GROUP BY</li>
<li>实现唯一性约束</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>占用额外存储空间</li>
<li>降低 INSERT、UPDATE、DELETE 速度（需要同时更新索引）</li>
<li>创建和维护需要时间</li>
</ul>
<h3 id="1-3-索引使用场景"><a href="#1-3-索引使用场景" class="headerlink" title="1.3 索引使用场景"></a>1.3 索引使用场景</h3><table>
<thead>
<tr>
<th>场景</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>主键&#x2F;外键列</td>
<td>自动创建索引</td>
</tr>
<tr>
<td>WHERE 条件列</td>
<td>经常作为查询条件的列</td>
</tr>
<tr>
<td>JOIN 连接列</td>
<td>表连接的关联列</td>
</tr>
<tr>
<td>ORDER BY 列</td>
<td>排序字段</td>
</tr>
<tr>
<td>GROUP BY 列</td>
<td>分组字段</td>
</tr>
<tr>
<td>范围查询</td>
<td>使用 BETWEEN、&gt;、&lt; 等</td>
</tr>
</tbody></table>
<p><strong>不适合创建索引的场景</strong>：</p>
<ul>
<li>数据量很小的表</li>
<li>频繁更新的列</li>
<li>选择性低的列（如性别、状态）</li>
<li>使用函数或表达式的列</li>
</ul>
<h2 id="二、索引数据结构"><a href="#二、索引数据结构" class="headerlink" title="二、索引数据结构"></a>二、索引数据结构</h2><h3 id="2-1-B-Tree-索引"><a href="#2-1-B-Tree-索引" class="headerlink" title="2.1 B-Tree 索引"></a>2.1 B-Tree 索引</h3><p><strong>B-Tree（多路平衡查找树）</strong> 是一种自平衡的多路查找树。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">       [50]</span><br><span class="line">      /    \</span><br><span class="line">   [20]    [80]</span><br><span class="line">  /  \     /  \</span><br><span class="line">[10][30] [60][90]</span><br></pre></td></tr></table></figure>

<p><strong>特点</strong>：</p>
<ul>
<li>所有节点都存储数据</li>
<li>叶子节点在同一层</li>
<li>查找、插入、删除时间复杂度：O(log n)</li>
<li>适合范围查询</li>
</ul>
<h3 id="2-2-B-Tree-索引"><a href="#2-2-B-Tree-索引" class="headerlink" title="2.2 B+Tree 索引"></a>2.2 B+Tree 索引</h3><p><strong>B+Tree</strong> 是 B-Tree 的变种，是 MySQL InnoDB 的默认索引结构。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">非叶子节点（只存索引）：   [50]</span><br><span class="line">                         /    \</span><br><span class="line">                       [20]   [80]</span><br><span class="line">叶子节点（存数据 + 链表）： [10][20][30][50][60][80][90]</span><br><span class="line">                          ↑                    ↑</span><br><span class="line">                        head                 tail</span><br></pre></td></tr></table></figure>

<p><strong>B+Tree vs B-Tree</strong>：</p>
<table>
<thead>
<tr>
<th>对比项</th>
<th>B-Tree</th>
<th>B+Tree</th>
</tr>
</thead>
<tbody><tr>
<td>数据存储</td>
<td>所有节点</td>
<td>只存在叶子节点</td>
</tr>
<tr>
<td>非叶子节点</td>
<td>存数据和索引</td>
<td>只存索引</td>
</tr>
<tr>
<td>叶子节点</td>
<td>无链表</td>
<td>有双向链表</td>
</tr>
<tr>
<td>范围查询</td>
<td>需要中序遍历</td>
<td>直接遍历链表</td>
</tr>
<tr>
<td>查询稳定性</td>
<td>不稳定</td>
<td>稳定</td>
</tr>
</tbody></table>
<p><strong>为什么 InnoDB 选择 B+Tree</strong>：</p>
<ol>
<li>非叶子节点不存数据，单页能存更多索引</li>
<li>树的高度更低，IO 次数更少</li>
<li>叶子节点有链表，范围查询效率高</li>
<li>全表扫描只需遍历叶子节点</li>
</ol>
<h3 id="2-3-Hash-索引"><a href="#2-3-Hash-索引" class="headerlink" title="2.3 Hash 索引"></a>2.3 Hash 索引</h3><p><strong>Hash 索引</strong> 基于哈希表实现，只适用于精确匹配。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Hash 函数：h(key) = key % 10</span><br><span class="line"></span><br><span class="line">数据：</span><br><span class="line">15 → h(15)=5 → 桶 5</span><br><span class="line">25 → h(25)=5 → 桶 5（冲突）</span><br><span class="line">30 → h(30)=0 → 桶 0</span><br></pre></td></tr></table></figure>

<p><strong>特点</strong>：</p>
<ul>
<li>等值查询极快（O(1)）</li>
<li>不支持范围查询</li>
<li>不支持排序</li>
<li>不支持模糊查询</li>
<li>InnoDB 的自适应哈希索引</li>
</ul>
<h3 id="2-4-数据结构对比"><a href="#2-4-数据结构对比" class="headerlink" title="2.4 数据结构对比"></a>2.4 数据结构对比</h3><table>
<thead>
<tr>
<th>特性</th>
<th>B-Tree</th>
<th>B+Tree</th>
<th>Hash</th>
</tr>
</thead>
<tbody><tr>
<td>等值查询</td>
<td>O(log n)</td>
<td>O(log n)</td>
<td>O(1)</td>
</tr>
<tr>
<td>范围查询</td>
<td>支持</td>
<td>支持（优秀）</td>
<td>不支持</td>
</tr>
<tr>
<td>排序</td>
<td>支持</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>模糊查询</td>
<td>支持</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>空间效率</td>
<td>一般</td>
<td>高</td>
<td>一般</td>
</tr>
</tbody></table>
<h2 id="三、索引分类"><a href="#三、索引分类" class="headerlink" title="三、索引分类"></a>三、索引分类</h2><h3 id="3-1-按存储结构分类"><a href="#3-1-按存储结构分类" class="headerlink" title="3.1 按存储结构分类"></a>3.1 按存储结构分类</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- B+Tree 索引（默认）</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_name <span class="keyword">ON</span> employees(name);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Hash 索引（Memory 引擎默认）</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_hash <span class="keyword">ON</span> table_name <span class="keyword">USING</span> HASH (column_name);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 全文索引（5.6+ InnoDB 支持）</span></span><br><span class="line"><span class="keyword">CREATE</span> FULLTEXT INDEX idx_content <span class="keyword">ON</span> articles(content);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 空间索引（GIS 数据）</span></span><br><span class="line"><span class="keyword">CREATE</span> SPATIAL INDEX idx_location <span class="keyword">ON</span> maps(location);</span><br></pre></td></tr></table></figure>

<h3 id="3-2-按物理存储分类"><a href="#3-2-按物理存储分类" class="headerlink" title="3.2 按物理存储分类"></a>3.2 按物理存储分类</h3><p><strong>聚簇索引（Clustered Index）</strong>：</p>
<ul>
<li>数据和索引存储在一起</li>
<li>叶子节点存储完整的行数据</li>
<li>一个表只能有一个聚簇索引</li>
<li>InnoDB 的主键索引就是聚簇索引</li>
</ul>
<p><strong>非聚簇索引（Secondary Index）</strong>：</p>
<ul>
<li>索引和数据分开存储</li>
<li>叶子节点存储主键值</li>
<li>一个表可以有多个非聚簇索引</li>
<li>InnoDB 的非主键索引都是非聚簇索引</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">聚簇索引（主键索引）：</span><br><span class="line">[1][name:A][...]  ← 数据就在索引中</span><br><span class="line">[2][name:B][...]</span><br><span class="line">[3][name:C][...]</span><br><span class="line"></span><br><span class="line">非聚簇索引：</span><br><span class="line">索引：[A]→1, [B]→2, [C]→3  ← 只存主键</span><br><span class="line">数据：[1][name:A][...]       ← 数据在聚簇索引中</span><br></pre></td></tr></table></figure>

<h3 id="3-3-按字段数量分类"><a href="#3-3-按字段数量分类" class="headerlink" title="3.3 按字段数量分类"></a>3.3 按字段数量分类</h3><p><strong>单列索引</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> INDEX idx_name <span class="keyword">ON</span> employees(name);</span><br></pre></td></tr></table></figure>

<p><strong>联合索引（复合索引）</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> INDEX idx_name_age <span class="keyword">ON</span> employees(name, age);</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：联合索引遵循最左前缀法则。</p>
<h3 id="3-4-按特性分类"><a href="#3-4-按特性分类" class="headerlink" title="3.4 按特性分类"></a>3.4 按特性分类</h3><table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>普通索引</td>
<td>最基本的索引</td>
<td><code>INDEX idx_name (name)</code></td>
</tr>
<tr>
<td>唯一索引</td>
<td>索引列值唯一</td>
<td><code>UNIQUE INDEX idx_unique (name)</code></td>
</tr>
<tr>
<td>主键索引</td>
<td>主键的索引</td>
<td><code>PRIMARY KEY (id)</code></td>
</tr>
<tr>
<td>全文索引</td>
<td>全文搜索</td>
<td><code>FULLTEXT INDEX idx_content (content)</code></td>
</tr>
</tbody></table>
<h2 id="四、索引语法"><a href="#四、索引语法" class="headerlink" title="四、索引语法"></a>四、索引语法</h2><h3 id="4-1-创建索引"><a href="#4-1-创建索引" class="headerlink" title="4.1 创建索引"></a>4.1 创建索引</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建表时添加索引</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> employees (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">UNIQUE</span>,</span><br><span class="line">    dept_id <span class="type">INT</span>,</span><br><span class="line">    INDEX idx_name (name),</span><br><span class="line">    INDEX idx_dept (dept_id)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 已存在的表添加索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_name <span class="keyword">ON</span> employees(name);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 添加唯一索引</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">UNIQUE</span> INDEX idx_email <span class="keyword">ON</span> employees(email);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 添加联合索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_name_dept <span class="keyword">ON</span> employees(name, dept_id);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用前缀索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_name_prefix <span class="keyword">ON</span> employees(name(<span class="number">10</span>));</span><br></pre></td></tr></table></figure>

<h3 id="4-2-查看索引"><a href="#4-2-查看索引" class="headerlink" title="4.2 查看索引"></a>4.2 查看索引</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看表的所有索引</span></span><br><span class="line"><span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 从 information_schema 查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.STATISTICS</span><br><span class="line"><span class="keyword">WHERE</span> table_name <span class="operator">=</span> <span class="string">&#x27;employees&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>SHOW INDEX 结果说明</strong>：</p>
<ul>
<li><code>Key_name</code>: 索引名称</li>
<li><code>Column_name</code>: 索引列名</li>
<li><code>Seq_in_index</code>: 列在索引中的顺序</li>
<li><code>Cardinality</code>: 索引选择性（越大约好）</li>
<li><code>Index_type</code>: 索引类型（BTREE、HASH 等）</li>
</ul>
<h3 id="4-3-删除索引"><a href="#4-3-删除索引" class="headerlink" title="4.3 删除索引"></a>4.3 删除索引</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 删除普通索引</span></span><br><span class="line"><span class="keyword">DROP</span> INDEX idx_name <span class="keyword">ON</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除唯一索引</span></span><br><span class="line"><span class="keyword">DROP</span> INDEX idx_email <span class="keyword">ON</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除主键索引</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> employees <span class="keyword">DROP</span> <span class="keyword">PRIMARY KEY</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除全文索引</span></span><br><span class="line"><span class="keyword">DROP</span> INDEX idx_content <span class="keyword">ON</span> articles;</span><br></pre></td></tr></table></figure>

<h3 id="4-4-修改索引"><a href="#4-4-修改索引" class="headerlink" title="4.4 修改索引"></a>4.4 修改索引</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- MySQL 不支持直接修改索引，需要先删除再创建</span></span><br><span class="line"><span class="keyword">DROP</span> INDEX idx_name <span class="keyword">ON</span> employees;</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_new_name <span class="keyword">ON</span> employees(name);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用 ALTER TABLE</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> employees <span class="keyword">DROP</span> INDEX idx_name;</span><br><span class="line"><span class="keyword">ALTER TABLE</span> employees <span class="keyword">ADD</span> INDEX idx_new_name(name);</span><br></pre></td></tr></table></figure>

<h2 id="五、性能分析工具"><a href="#五、性能分析工具" class="headerlink" title="五、性能分析工具"></a>五、性能分析工具</h2><h3 id="5-1-查看执行频次"><a href="#5-1-查看执行频次" class="headerlink" title="5.1 查看执行频次"></a>5.1 查看执行频次</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看慢查询次数</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;Slow_queries&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看表扫描次数</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;Handler_read%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Handler_read_rnd_next 高说明全表扫描多</span></span><br><span class="line"><span class="comment">-- Handler_read_key 高说明索引使用多</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-慢查询日志（基础）"><a href="#5-2-慢查询日志（基础）" class="headerlink" title="5.2 慢查询日志（基础）"></a>5.2 慢查询日志（基础）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看慢查询日志状态</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;slow_query_log&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 开启慢查询日志</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> slow_query_log <span class="operator">=</span> <span class="string">&#x27;ON&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置慢查询阈值（秒）</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> long_query_time <span class="operator">=</span> <span class="number">1</span>;  <span class="comment">-- 1 秒以上的查询</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看慢查询日志文件</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;slow_query_log_file&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-SHOW-PROFILES"><a href="#5-3-SHOW-PROFILES" class="headerlink" title="5.3 SHOW PROFILES"></a>5.3 SHOW PROFILES</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 开启 profiling</span></span><br><span class="line"><span class="keyword">SET</span> profiling <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 执行查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看 profile 列表</span></span><br><span class="line"><span class="keyword">SHOW</span> PROFILES;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看某条查询的详细耗时</span></span><br><span class="line"><span class="keyword">SHOW</span> PROFILE <span class="keyword">FOR</span> QUERY <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看 CPU 使用情况</span></span><br><span class="line"><span class="keyword">SHOW</span> PROFILE CPU <span class="keyword">FOR</span> QUERY <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h3 id="5-4-EXPLAIN-详解"><a href="#5-4-EXPLAIN-详解" class="headerlink" title="5.4 EXPLAIN 详解"></a>5.4 EXPLAIN 详解</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 基本用法</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果字段说明：</span></span><br><span class="line"><span class="comment">-- id: 查询的序列号</span></span><br><span class="line"><span class="comment">-- select_type: 查询类型（SIMPLE、PRIMARY、SUBQUERY 等）</span></span><br><span class="line"><span class="comment">-- table: 表名</span></span><br><span class="line"><span class="comment">-- type: 连接类型（ALL、index、range、ref、eq_ref、const、system）</span></span><br><span class="line"><span class="comment">-- possible_keys: 可能使用的索引</span></span><br><span class="line"><span class="comment">-- key: 实际使用的索引</span></span><br><span class="line"><span class="comment">-- key_len: 索引使用长度</span></span><br><span class="line"><span class="comment">-- ref: 列与索引的比较类型</span></span><br><span class="line"><span class="comment">-- rows: 扫描行数（越大约差）</span></span><br><span class="line"><span class="comment">-- Extra: 额外信息</span></span><br></pre></td></tr></table></figure>

<p><strong>type 字段详解（从差到好）</strong>：</p>
<table>
<thead>
<tr>
<th>type</th>
<th>说明</th>
<th>优化建议</th>
</tr>
</thead>
<tbody><tr>
<td>ALL</td>
<td>全表扫描</td>
<td>需要优化</td>
</tr>
<tr>
<td>index</td>
<td>全索引扫描</td>
<td>考虑优化</td>
</tr>
<tr>
<td>range</td>
<td>索引范围扫描</td>
<td>可以接受</td>
</tr>
<tr>
<td>ref</td>
<td>非唯一索引查找</td>
<td>良好</td>
</tr>
<tr>
<td>eq_ref</td>
<td>唯一索引查找</td>
<td>很好</td>
</tr>
<tr>
<td>const</td>
<td>常量查询</td>
<td>极好</td>
</tr>
<tr>
<td>system</td>
<td>系统表</td>
<td>最优</td>
</tr>
</tbody></table>
<h3 id="5-5-EXPLAIN-实战"><a href="#5-5-EXPLAIN-实战" class="headerlink" title="5.5 EXPLAIN 实战"></a>5.5 EXPLAIN 实战</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 测试数据</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> test_explain (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    age <span class="type">INT</span>,</span><br><span class="line">    dept_id <span class="type">INT</span>,</span><br><span class="line">    INDEX idx_name (name),</span><br><span class="line">    INDEX idx_age (age),</span><br><span class="line">    INDEX idx_dept (dept_id)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 全表扫描（type=ALL）</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> test_explain <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 索引范围扫描（type=range）</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> test_explain <span class="keyword">WHERE</span> age <span class="operator">&gt;</span> <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 索引查找（type=ref）</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> test_explain <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Extra 字段常见值：</span></span><br><span class="line"><span class="comment">-- Using index: 使用覆盖索引</span></span><br><span class="line"><span class="comment">-- Using where: 使用 WHERE 过滤</span></span><br><span class="line"><span class="comment">-- Using temporary: 使用临时表（需要优化）</span></span><br><span class="line"><span class="comment">-- Using filesort: 使用文件排序（需要优化）</span></span><br></pre></td></tr></table></figure>

<h2 id="六、索引最佳实践"><a href="#六、索引最佳实践" class="headerlink" title="六、索引最佳实践"></a>六、索引最佳实践</h2><h3 id="6-1-索引设计原则"><a href="#6-1-索引设计原则" class="headerlink" title="6.1 索引设计原则"></a>6.1 索引设计原则</h3><ol>
<li><strong>为 WHERE 子句的列创建索引</strong></li>
<li><strong>为 JOIN 连接列创建索引</strong></li>
<li><strong>为 ORDER BY 和 GROUP BY 列创建索引</strong></li>
<li><strong>使用联合索引代替多个单列索引</strong></li>
<li><strong>避免在索引列上使用函数</strong></li>
<li><strong>避免在索引列上使用 NOT NULL</strong></li>
<li><strong>字符串列使用前缀索引</strong></li>
<li><strong>定期分析和优化表</strong></li>
</ol>
<h3 id="6-2-索引使用技巧"><a href="#6-2-索引使用技巧" class="headerlink" title="6.2 索引使用技巧"></a>6.2 索引使用技巧</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 好的写法（使用索引）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> age <span class="keyword">BETWEEN</span> <span class="number">20</span> <span class="keyword">AND</span> <span class="number">30</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="keyword">LIKE</span> <span class="string">&#x27;张%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 不好的写法（不使用索引）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> <span class="keyword">YEAR</span>(hire_date) <span class="operator">=</span> <span class="number">2024</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> name <span class="keyword">LIKE</span> <span class="string">&#x27;%三&#x27;</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> age <span class="operator">+</span> <span class="number">1</span> <span class="operator">=</span> <span class="number">25</span>;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-索引维护"><a href="#6-3-索引维护" class="headerlink" title="6.3 索引维护"></a>6.3 索引维护</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 分析表（更新索引统计信息）</span></span><br><span class="line">ANALYZE <span class="keyword">TABLE</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 优化表（整理碎片）</span></span><br><span class="line">OPTIMIZE <span class="keyword">TABLE</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查表</span></span><br><span class="line"><span class="keyword">CHECK</span> <span class="keyword">TABLE</span> employees;</span><br></pre></td></tr></table></figure>

<h2 id="七、小结"><a href="#七、小结" class="headerlink" title="七、小结"></a>七、小结</h2><h3 id="核心知识点"><a href="#核心知识点" class="headerlink" title="核心知识点"></a>核心知识点</h3><ol>
<li><strong>索引数据结构</strong>：B+Tree 是 InnoDB 的默认结构</li>
<li><strong>聚簇索引</strong>：数据和索引在一起，一个表只能有一个</li>
<li><strong>非聚簇索引</strong>：索引和数据分开，可以有多个</li>
<li><strong>索引分类</strong>：普通、唯一、主键、全文索引</li>
<li><strong>性能分析</strong>：EXPLAIN 是最重要的分析工具</li>
</ol>
<h3 id="EXPLAIN-速查"><a href="#EXPLAIN-速查" class="headerlink" title="EXPLAIN 速查"></a>EXPLAIN 速查</h3><table>
<thead>
<tr>
<th>字段</th>
<th>关注点</th>
</tr>
</thead>
<tbody><tr>
<td>type</td>
<td>ALL 最差，const 最好</td>
</tr>
<tr>
<td>key</td>
<td>是否使用了索引</td>
</tr>
<tr>
<td>rows</td>
<td>扫描行数，越少越好</td>
</tr>
<tr>
<td>Extra</td>
<td>避免 Using temporary、Using filesort</td>
</tr>
</tbody></table>
<h3 id="下一章预告"><a href="#下一章预告" class="headerlink" title="下一章预告"></a>下一章预告</h3><p>下一篇文章将介绍<strong>索引使用规则</strong>，包括：</p>
<ul>
<li>最左前缀法则</li>
<li>索引失效场景</li>
<li>覆盖索引和回表</li>
<li>索引设计原则</li>
</ul>
<hr>
<p><strong>下一篇</strong>：[MySQL 进阶教程 08-01 索引使用规则](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 08-01 索引使用规则&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 进阶教程 06-01 存储引擎详解](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 06-01 存储引擎详解&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 进阶教程</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>性能优化</tag>
        <tag>索引</tag>
        <tag>B+Tree</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 进阶教程 12-01 视图详解</title>
    <url>/2026/02/24/MySQL%20%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B%2012-01%20%E8%A7%86%E5%9B%BE%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<h1 id="MySQL-进阶教程-12-01-视图详解"><a href="#MySQL-进阶教程-12-01-视图详解" class="headerlink" title="MySQL 进阶教程 12-01 视图详解"></a>MySQL 进阶教程 12-01 视图详解</h1><p>视图是数据库中的虚拟表，可以简化复杂查询、提高安全性。本文将详细介绍视图的概念、创建、使用和限制。</p>
<h2 id="一、视图介绍及语法"><a href="#一、视图介绍及语法" class="headerlink" title="一、视图介绍及语法"></a>一、视图介绍及语法</h2><h3 id="1-1-什么是视图？"><a href="#1-1-什么是视图？" class="headerlink" title="1.1 什么是视图？"></a>1.1 什么是视图？</h3><p><strong>视图（View）</strong> 是基于 SQL 查询结果的虚拟表，视图本身不存储数据，只存储查询定义。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">视图 vs 表：</span><br><span class="line">├── 表：存储实际数据</span><br><span class="line">└── 视图：存储查询定义，数据来自基表</span><br></pre></td></tr></table></figure>

<h3 id="1-2-视图的作用"><a href="#1-2-视图的作用" class="headerlink" title="1.2 视图的作用"></a>1.2 视图的作用</h3><table>
<thead>
<tr>
<th>作用</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>简化查询</td>
<td>将复杂查询封装为视图</td>
</tr>
<tr>
<td>数据安全</td>
<td>只暴露部分字段给用户</td>
</tr>
<tr>
<td>逻辑独立</td>
<td>基表结构变化不影响应用</td>
</tr>
<tr>
<td>重用 SQL</td>
<td>避免重复编写相同查询</td>
</tr>
</tbody></table>
<h3 id="1-3-创建视图语法"><a href="#1-3-创建视图语法" class="headerlink" title="1.3 创建视图语法"></a>1.3 创建视图语法</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 基本语法</span></span><br><span class="line"><span class="keyword">CREATE</span> [<span class="keyword">OR</span> REPLACE] <span class="keyword">VIEW</span> view_name [(column_list)]</span><br><span class="line"><span class="keyword">AS</span> select_statement</span><br><span class="line">[<span class="keyword">WITH</span> [<span class="keyword">CASCADED</span> <span class="operator">|</span> <span class="keyword">LOCAL</span>] <span class="keyword">CHECK</span> OPTION];</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 示例：创建员工信息视图</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> v_emp_info <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> e.id, e.name, e.salary, d.dept_name</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">JOIN</span> departments d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用视图</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> v_emp_info <span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> <span class="number">10000</span>;</span><br></pre></td></tr></table></figure>

<h3 id="1-4-查看视图"><a href="#1-4-查看视图" class="headerlink" title="1.4 查看视图"></a>1.4 查看视图</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看所有视图</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">FULL</span> TABLES <span class="keyword">WHERE</span> table_type <span class="operator">=</span> <span class="string">&#x27;VIEW&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看视图定义</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">VIEW</span> v_emp_info;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 从 information_schema 查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.views</span><br><span class="line"><span class="keyword">WHERE</span> table_schema <span class="operator">=</span> <span class="string">&#x27;your_db&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="1-5-修改视图"><a href="#1-5-修改视图" class="headerlink" title="1.5 修改视图"></a>1.5 修改视图</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 方法 1：CREATE OR REPLACE</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">VIEW</span> v_emp_info <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> e.id, e.name, e.salary, d.dept_name, e.hire_date</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">JOIN</span> departments d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法 2：ALTER VIEW</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">VIEW</span> v_emp_info <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> e.id, e.name, e.salary, d.dept_name, e.hire_date</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">JOIN</span> departments d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.id;</span><br></pre></td></tr></table></figure>

<h3 id="1-6-删除视图"><a href="#1-6-删除视图" class="headerlink" title="1.6 删除视图"></a>1.6 删除视图</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 删除单个视图</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">VIEW</span> v_emp_info;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除多个视图</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">VIEW</span> v_emp_info, v_dept_stats;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 安全删除（不存在时不报错）</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">VIEW</span> IF <span class="keyword">EXISTS</span> v_emp_info;</span><br></pre></td></tr></table></figure>

<h2 id="二、检查选项-CASCADE"><a href="#二、检查选项-CASCADE" class="headerlink" title="二、检查选项 CASCADE"></a>二、检查选项 CASCADE</h2><h3 id="2-1-WITH-CHECK-OPTION-作用"><a href="#2-1-WITH-CHECK-OPTION-作用" class="headerlink" title="2.1 WITH CHECK OPTION 作用"></a>2.1 WITH CHECK OPTION 作用</h3><p><strong>WITH CHECK OPTION</strong> 确保通过视图进行的 INSERT&#x2F;UPDATE 操作必须满足视图的 WHERE 条件。</p>
<h3 id="2-2-CASCADED-选项"><a href="#2-2-CASCADED-选项" class="headerlink" title="2.2 CASCADED 选项"></a>2.2 CASCADED 选项</h3><p><strong>CASCADED</strong> 是默认选项，检查所有相关视图的条件。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建基表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> employees (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    dept_id <span class="type">INT</span>,</span><br><span class="line">    salary <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建视图（只显示高薪员工）</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> v_high_salary <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> <span class="number">10000</span></span><br><span class="line"><span class="keyword">WITH</span> <span class="keyword">CASCADED</span> <span class="keyword">CHECK</span> OPTION;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 通过视图插入数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> v_high_salary <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;张三&#x27;</span>, <span class="number">1</span>, <span class="number">15000</span>);  <span class="comment">-- 成功</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> v_high_salary <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;李四&#x27;</span>, <span class="number">1</span>, <span class="number">8000</span>);   <span class="comment">-- 失败！不满足 salary &gt; 10000</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-级联检查示例"><a href="#2-3-级联检查示例" class="headerlink" title="2.3 级联检查示例"></a>2.3 级联检查示例</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 多层视图</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> v_dept_1 <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">WITH</span> <span class="keyword">CASCADED</span> <span class="keyword">CHECK</span> OPTION;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> v_dept_1_high <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> v_dept_1 <span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> <span class="number">10000</span></span><br><span class="line"><span class="keyword">WITH</span> <span class="keyword">CASCADED</span> <span class="keyword">CHECK</span> OPTION;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入数据会检查所有层级</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> v_dept_1_high <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;张三&#x27;</span>, <span class="number">1</span>, <span class="number">15000</span>);  <span class="comment">-- 成功</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> v_dept_1_high <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;李四&#x27;</span>, <span class="number">2</span>, <span class="number">15000</span>);  <span class="comment">-- 失败！dept_id != 1</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> v_dept_1_high <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;王五&#x27;</span>, <span class="number">1</span>, <span class="number">8000</span>);   <span class="comment">-- 失败！salary &lt; 10000</span></span><br></pre></td></tr></table></figure>

<h2 id="三、检查选项-LOCAL"><a href="#三、检查选项-LOCAL" class="headerlink" title="三、检查选项 LOCAL"></a>三、检查选项 LOCAL</h2><h3 id="3-1-LOCAL-选项"><a href="#3-1-LOCAL-选项" class="headerlink" title="3.1 LOCAL 选项"></a>3.1 LOCAL 选项</h3><p><strong>LOCAL</strong> 只检查当前视图的条件，不检查底层视图的条件。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 使用 LOCAL</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> v_dept_1_local <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">WITH</span> <span class="keyword">LOCAL</span> <span class="keyword">CHECK</span> OPTION;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> v_dept_1_high_local <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> v_dept_1_local <span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> <span class="number">10000</span></span><br><span class="line"><span class="keyword">WITH</span> <span class="keyword">LOCAL</span> <span class="keyword">CHECK</span> OPTION;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> v_dept_1_high_local <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;张三&#x27;</span>, <span class="number">1</span>, <span class="number">15000</span>);  <span class="comment">-- 成功</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> v_dept_1_high_local <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;李四&#x27;</span>, <span class="number">2</span>, <span class="number">15000</span>);  <span class="comment">-- 失败！当前视图只检查 salary</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> v_dept_1_high_local <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;王五&#x27;</span>, <span class="number">1</span>, <span class="number">8000</span>);   <span class="comment">-- 失败！不满足 salary &gt; 10000</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-CASCADED-vs-LOCAL-对比"><a href="#3-2-CASCADED-vs-LOCAL-对比" class="headerlink" title="3.2 CASCADED vs LOCAL 对比"></a>3.2 CASCADED vs LOCAL 对比</h3><table>
<thead>
<tr>
<th>选项</th>
<th>检查范围</th>
<th>默认值</th>
</tr>
</thead>
<tbody><tr>
<td>CASCADED</td>
<td>检查所有层级视图</td>
<td>是</td>
</tr>
<tr>
<td>LOCAL</td>
<td>只检查当前视图</td>
<td>否</td>
</tr>
</tbody></table>
<h2 id="四、视图更新"><a href="#四、视图更新" class="headerlink" title="四、视图更新"></a>四、视图更新</h2><h3 id="4-1-可更新视图条件"><a href="#4-1-可更新视图条件" class="headerlink" title="4.1 可更新视图条件"></a>4.1 可更新视图条件</h3><p>视图可以 UPDATE&#x2F;DELETE&#x2F;INSERT 的条件：</p>
<ol>
<li>视图基于单个表</li>
<li>视图包含所有 NOT NULL 列</li>
<li>没有使用聚合函数</li>
<li>没有使用 DISTINCT</li>
<li>没有使用 GROUP BY</li>
<li>没有使用 HAVING</li>
<li>没有使用 UNION</li>
<li>没有使用子查询（某些情况）</li>
</ol>
<h3 id="4-2-可更新视图示例"><a href="#4-2-可更新视图示例" class="headerlink" title="4.2 可更新视图示例"></a>4.2 可更新视图示例</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 简单视图（可更新）</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> v_emp_simple <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> id, name, salary <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 可以通过视图更新</span></span><br><span class="line"><span class="keyword">UPDATE</span> v_emp_simple <span class="keyword">SET</span> salary <span class="operator">=</span> <span class="number">12000</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">INSERT INTO</span> v_emp_simple <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;张三&#x27;</span>, <span class="number">10000</span>);</span><br></pre></td></tr></table></figure>

<h3 id="4-3-不可更新视图"><a href="#4-3-不可更新视图" class="headerlink" title="4.3 不可更新视图"></a>4.3 不可更新视图</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 包含聚合函数（不可更新）</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> v_dept_stats <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> dept_id, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> emp_count, <span class="built_in">AVG</span>(salary) <span class="keyword">AS</span> avg_salary</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> dept_id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 以下操作会失败</span></span><br><span class="line"><span class="keyword">UPDATE</span> v_dept_stats <span class="keyword">SET</span> emp_count <span class="operator">=</span> <span class="number">10</span> <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">1</span>;  <span class="comment">-- 错误</span></span><br></pre></td></tr></table></figure>

<h3 id="4-4-INSTEAD-OF-触发器"><a href="#4-4-INSTEAD-OF-触发器" class="headerlink" title="4.4 INSTEAD OF 触发器"></a>4.4 INSTEAD OF 触发器</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- MySQL 不支持 INSTEAD OF 触发器</span></span><br><span class="line"><span class="comment">-- 可以使用 BEFORE 触发器模拟</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 场景：通过视图插入数据到多个表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> v_order_detail <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> o.id, o.order_no, c.name <span class="keyword">AS</span> customer_name</span><br><span class="line"><span class="keyword">FROM</span> orders o</span><br><span class="line"><span class="keyword">JOIN</span> customers c <span class="keyword">ON</span> o.customer_id <span class="operator">=</span> c.id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用触发器处理复杂插入</span></span><br><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trg_v_order_detail_insert</span><br><span class="line">BEFORE <span class="keyword">INSERT</span> <span class="keyword">ON</span> v_order_detail</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="comment">-- 先插入 customers 表</span></span><br><span class="line">    <span class="keyword">INSERT INTO</span> customers (name) <span class="keyword">VALUES</span> (NEW.customer_name);</span><br><span class="line">    <span class="keyword">SET</span> NEW.customer_id <span class="operator">=</span> LAST_INSERT_ID();</span><br><span class="line">    <span class="comment">-- 再插入 orders 表</span></span><br><span class="line">    <span class="keyword">INSERT INTO</span> orders (order_no, customer_id) <span class="keyword">VALUES</span> (NEW.order_no, NEW.customer_id);</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<h2 id="五、视图案例"><a href="#五、视图案例" class="headerlink" title="五、视图案例"></a>五、视图案例</h2><h3 id="5-1-简化复杂查询"><a href="#5-1-简化复杂查询" class="headerlink" title="5.1 简化复杂查询"></a>5.1 简化复杂查询</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 原始复杂查询</span></span><br><span class="line"><span class="keyword">SELECT</span> e.id, e.name, e.salary, d.dept_name, l.city</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">JOIN</span> departments d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.id</span><br><span class="line"><span class="keyword">JOIN</span> locations l <span class="keyword">ON</span> d.location_id <span class="operator">=</span> l.id</span><br><span class="line"><span class="keyword">WHERE</span> e.salary <span class="operator">&gt;</span> <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建视图简化</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> v_emp_detail <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> e.id, e.name, e.salary, d.dept_name, l.city</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">JOIN</span> departments d <span class="keyword">ON</span> e.dept_id <span class="operator">=</span> d.id</span><br><span class="line"><span class="keyword">JOIN</span> locations l <span class="keyword">ON</span> d.location_id <span class="operator">=</span> l.id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用视图</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> v_emp_detail <span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> <span class="number">10000</span>;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-数据安全"><a href="#5-2-数据安全" class="headerlink" title="5.2 数据安全"></a>5.2 数据安全</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建视图只暴露部分字段</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> v_emp_public <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> id, name, dept_id</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br><span class="line"><span class="comment">-- 不暴露 salary、phone 等敏感字段</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 授予视图权限</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> v_emp_public <span class="keyword">TO</span> <span class="string">&#x27;guest&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-逻辑独立性"><a href="#5-3-逻辑独立性" class="headerlink" title="5.3 逻辑独立性"></a>5.3 逻辑独立性</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 原始表结构</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> employees_v1 (</span><br><span class="line">    id <span class="type">INT</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    salary <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建视图屏蔽底层变化</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> v_employees <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> id, name, salary <span class="keyword">FROM</span> employees_v1;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 表结构变化（添加列、改名）</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> employees_v1 <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> bonus <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>);</span><br><span class="line">RENAME <span class="keyword">TABLE</span> employees_v1 <span class="keyword">TO</span> employees_v2;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改视图定义，应用层无需修改</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">VIEW</span> v_employees <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> id, name, salary <span class="keyword">FROM</span> employees_v2;</span><br></pre></td></tr></table></figure>

<h3 id="5-4-统计视图"><a href="#5-4-统计视图" class="headerlink" title="5.4 统计视图"></a>5.4 统计视图</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建部门统计视图</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> v_dept_stats <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    d.dept_name,</span><br><span class="line">    <span class="built_in">COUNT</span>(e.id) <span class="keyword">AS</span> emp_count,</span><br><span class="line">    <span class="built_in">AVG</span>(e.salary) <span class="keyword">AS</span> avg_salary,</span><br><span class="line">    <span class="built_in">MAX</span>(e.salary) <span class="keyword">AS</span> max_salary,</span><br><span class="line">    <span class="built_in">MIN</span>(e.salary) <span class="keyword">AS</span> min_salary</span><br><span class="line"><span class="keyword">FROM</span> departments d</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> employees e <span class="keyword">ON</span> d.id <span class="operator">=</span> e.dept_id</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> d.id, d.dept_name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用视图</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> v_dept_stats <span class="keyword">WHERE</span> emp_count <span class="operator">&gt;</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<h3 id="5-5-行列转换视图"><a href="#5-5-行列转换视图" class="headerlink" title="5.5 行列转换视图"></a>5.5 行列转换视图</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 行转列</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> v_score_pivot <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    student_name,</span><br><span class="line">    <span class="built_in">MAX</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> subject <span class="operator">=</span> <span class="string">&#x27;数学&#x27;</span> <span class="keyword">THEN</span> score <span class="keyword">END</span>) <span class="keyword">AS</span> math,</span><br><span class="line">    <span class="built_in">MAX</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> subject <span class="operator">=</span> <span class="string">&#x27;语文&#x27;</span> <span class="keyword">THEN</span> score <span class="keyword">END</span>) <span class="keyword">AS</span> chinese,</span><br><span class="line">    <span class="built_in">MAX</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> subject <span class="operator">=</span> <span class="string">&#x27;英语&#x27;</span> <span class="keyword">THEN</span> score <span class="keyword">END</span>) <span class="keyword">AS</span> english</span><br><span class="line"><span class="keyword">FROM</span> scores</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> student_name;</span><br></pre></td></tr></table></figure>

<h2 id="六、视图性能"><a href="#六、视图性能" class="headerlink" title="六、视图性能"></a>六、视图性能</h2><h3 id="6-1-视图执行原理"><a href="#6-1-视图执行原理" class="headerlink" title="6.1 视图执行原理"></a>6.1 视图执行原理</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">视图不是物化的，每次查询视图时：</span><br><span class="line">1. MySQL 将视图定义与查询合并</span><br><span class="line">2. 生成执行计划</span><br><span class="line">3. 执行查询</span><br><span class="line"></span><br><span class="line">所以视图本身不会提高性能，但也不会降低性能</span><br></pre></td></tr></table></figure>

<h3 id="6-2-物化视图"><a href="#6-2-物化视图" class="headerlink" title="6.2 物化视图"></a>6.2 物化视图</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- MySQL 不直接支持物化视图</span></span><br><span class="line"><span class="comment">-- 可以使用表模拟</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建物化表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> mv_dept_stats <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> dept_id, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> emp_count, <span class="built_in">AVG</span>(salary) <span class="keyword">AS</span> avg_salary</span><br><span class="line"><span class="keyword">FROM</span> employees <span class="keyword">GROUP</span> <span class="keyword">BY</span> dept_id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 定期刷新</span></span><br><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> refresh_mv_stats()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span> mv_dept_stats;</span><br><span class="line">    <span class="keyword">INSERT INTO</span> mv_dept_stats</span><br><span class="line">    <span class="keyword">SELECT</span> dept_id, <span class="built_in">COUNT</span>(<span class="operator">*</span>), <span class="built_in">AVG</span>(salary)</span><br><span class="line">    <span class="keyword">FROM</span> employees <span class="keyword">GROUP</span> <span class="keyword">BY</span> dept_id;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<h2 id="七、小结"><a href="#七、小结" class="headerlink" title="七、小结"></a>七、小结</h2><h3 id="核心知识点"><a href="#核心知识点" class="headerlink" title="核心知识点"></a>核心知识点</h3><ol>
<li><strong>视图概念</strong>：虚拟表，存储查询定义</li>
<li><strong>创建视图</strong>：CREATE VIEW AS SELECT</li>
<li><strong>检查选项</strong>：CASCADED（级联检查）、LOCAL（只检查当前）</li>
<li><strong>视图更新</strong>：简单视图可更新，复杂视图不可更新</li>
<li><strong>视图作用</strong>：简化查询、数据安全、逻辑独立</li>
</ol>
<h3 id="视图使用建议"><a href="#视图使用建议" class="headerlink" title="视图使用建议"></a>视图使用建议</h3><table>
<thead>
<tr>
<th>场景</th>
<th>建议</th>
</tr>
</thead>
<tbody><tr>
<td>复杂查询</td>
<td>使用视图封装</td>
</tr>
<tr>
<td>敏感数据</td>
<td>创建视图限制访问</td>
</tr>
<tr>
<td>报表统计</td>
<td>考虑物化视图</td>
</tr>
<tr>
<td>频繁更新</td>
<td>避免复杂视图</td>
</tr>
</tbody></table>
<h3 id="下一章预告"><a href="#下一章预告" class="headerlink" title="下一章预告"></a>下一章预告</h3><p>下一篇文章将介绍<strong>存储过程与函数</strong>，包括：</p>
<ul>
<li>存储过程语法</li>
<li>变量和参数</li>
<li>流程控制</li>
<li>游标和异常处理</li>
</ul>
<hr>
<p><strong>下一篇</strong>：[MySQL 进阶教程 13-01 存储过程与函数](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 13-01 存储过程与函数&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 进阶教程 11-01 InnoDB 存储引擎深入](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 11-01 InnoDB 存储引擎深入&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 进阶教程</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>视图</tag>
        <tag>虚拟表</tag>
        <tag>查询优化</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 进阶教程 13-01 存储过程与函数</title>
    <url>/2026/02/24/MySQL%20%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B%2013-01%20%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E4%B8%8E%E5%87%BD%E6%95%B0/</url>
    <content><![CDATA[<h1 id="MySQL-进阶教程-13-01-存储过程与函数"><a href="#MySQL-进阶教程-13-01-存储过程与函数" class="headerlink" title="MySQL 进阶教程 13-01 存储过程与函数"></a>MySQL 进阶教程 13-01 存储过程与函数</h1><p>存储过程和函数是存储在数据库中的程序，可以封装复杂业务逻辑、提高代码复用性。本文将详细介绍存储过程与函数的语法、变量、流程控制和游标使用。</p>
<h2 id="一、存储过程介绍"><a href="#一、存储过程介绍" class="headerlink" title="一、存储过程介绍"></a>一、存储过程介绍</h2><h3 id="1-1-什么是存储过程？"><a href="#1-1-什么是存储过程？" class="headerlink" title="1.1 什么是存储过程？"></a>1.1 什么是存储过程？</h3><p><strong>存储过程（Stored Procedure）</strong> 是预编译并存储在数据库中的 SQL 程序，可以接受参数、执行复杂逻辑、返回结果。</p>
<h3 id="1-2-存储过程的优点"><a href="#1-2-存储过程的优点" class="headerlink" title="1.2 存储过程的优点"></a>1.2 存储过程的优点</h3><table>
<thead>
<tr>
<th>优点</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>代码复用</td>
<td>一次编写，多次调用</td>
</tr>
<tr>
<td>性能提升</td>
<td>预编译，减少网络传输</td>
</tr>
<tr>
<td>安全性高</td>
<td>可以限制直接访问表</td>
</tr>
<tr>
<td>维护方便</td>
<td>逻辑集中在数据库层</td>
</tr>
</tbody></table>
<h3 id="1-3-存储过程的缺点"><a href="#1-3-存储过程的缺点" class="headerlink" title="1.3 存储过程的缺点"></a>1.3 存储过程的缺点</h3><table>
<thead>
<tr>
<th>缺点</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>可移植性差</td>
<td>不同数据库语法不同</td>
</tr>
<tr>
<td>调试困难</td>
<td>缺乏好的调试工具</td>
</tr>
<tr>
<td>服务器压力</td>
<td>逻辑在数据库层执行</td>
</tr>
</tbody></table>
<h2 id="二、存储过程基本语法"><a href="#二、存储过程基本语法" class="headerlink" title="二、存储过程基本语法"></a>二、存储过程基本语法</h2><h3 id="2-1-创建存储过程"><a href="#2-1-创建存储过程" class="headerlink" title="2.1 创建存储过程"></a>2.1 创建存储过程</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 基本语法</span></span><br><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> procedure_name([<span class="keyword">IN</span><span class="operator">|</span><span class="keyword">OUT</span><span class="operator">|</span><span class="keyword">INOUT</span>] param_name type, ...)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="comment">-- 存储过程体</span></span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 示例：无参数存储过程</span></span><br><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> get_all_employees()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 调用存储过程</span></span><br><span class="line"><span class="keyword">CALL</span> get_all_employees();</span><br></pre></td></tr></table></figure>

<h3 id="2-2-为什么需要-DELIMITER？"><a href="#2-2-为什么需要-DELIMITER？" class="headerlink" title="2.2 为什么需要 DELIMITER？"></a>2.2 为什么需要 DELIMITER？</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- MySQL 默认分隔符是 ;</span></span><br><span class="line"><span class="comment">-- 存储过程内部也有 ;，需要临时更改分隔符</span></span><br><span class="line"></span><br><span class="line">DELIMITER $$  <span class="comment">-- 将分隔符改为 $$</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> proc()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users;  <span class="comment">-- 这里的;不会结束语句</span></span><br><span class="line"><span class="keyword">END</span>$$                       <span class="comment">-- $$ 结束整个 CREATE 语句</span></span><br><span class="line">DELIMITER ;  <span class="comment">-- 恢复默认分隔符</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-查看存储过程"><a href="#2-3-查看存储过程" class="headerlink" title="2.3 查看存储过程"></a>2.3 查看存储过程</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看所有存储过程</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">PROCEDURE</span> STATUS;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看特定存储过程</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">PROCEDURE</span> STATUS <span class="keyword">WHERE</span> Name <span class="operator">=</span> <span class="string">&#x27;get_all_employees&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看创建语句</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> get_all_employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 从 information_schema 查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.ROUTINES</span><br><span class="line"><span class="keyword">WHERE</span> ROUTINE_TYPE <span class="operator">=</span> <span class="string">&#x27;PROCEDURE&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-修改和删除存储过程"><a href="#2-4-修改和删除存储过程" class="headerlink" title="2.4 修改和删除存储过程"></a>2.4 修改和删除存储过程</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- MySQL 不支持直接修改存储过程</span></span><br><span class="line"><span class="comment">-- 需要先删除再创建</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">PROCEDURE</span> IF <span class="keyword">EXISTS</span> get_all_employees;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> get_all_employees()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除存储过程</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">PROCEDURE</span> IF <span class="keyword">EXISTS</span> procedure_name;</span><br></pre></td></tr></table></figure>

<h2 id="三、系统变量"><a href="#三、系统变量" class="headerlink" title="三、系统变量"></a>三、系统变量</h2><h3 id="3-1-查看系统变量"><a href="#3-1-查看系统变量" class="headerlink" title="3.1 查看系统变量"></a>3.1 查看系统变量</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看所有系统变量</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看特定变量</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;max_connections&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看会话级变量</span></span><br><span class="line"><span class="keyword">SHOW</span> SESSION VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;autocommit&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看全局变量</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;max_connections&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-设置系统变量"><a href="#3-2-设置系统变量" class="headerlink" title="3.2 设置系统变量"></a>3.2 设置系统变量</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 设置会话级变量</span></span><br><span class="line"><span class="keyword">SET</span> autocommit <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">SET</span> SESSION autocommit <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置全局变量（需要 SUPER 权限）</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> max_connections <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line"><span class="keyword">SET</span> @<span class="variable">@GLOBAL</span>.max_connections <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置当前会话变量</span></span><br><span class="line"><span class="keyword">SET</span> @<span class="variable">@SESSION</span>.autocommit <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">SET</span> @<span class="variable">@autocommit</span> <span class="operator">=</span> <span class="number">0</span>;  <span class="comment">-- 默认当前会话</span></span><br></pre></td></tr></table></figure>

<h2 id="四、用户定义变量"><a href="#四、用户定义变量" class="headerlink" title="四、用户定义变量"></a>四、用户定义变量</h2><h3 id="4-1-用户变量语法"><a href="#4-1-用户变量语法" class="headerlink" title="4.1 用户变量语法"></a>4.1 用户变量语法</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 用户变量以 @ 开头</span></span><br><span class="line"><span class="comment">-- 会话级别，连接断开后失效</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-用户变量使用"><a href="#4-2-用户变量使用" class="headerlink" title="4.2 用户变量使用"></a>4.2 用户变量使用</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 定义变量</span></span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@name</span> <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@age</span> <span class="operator">=</span> <span class="number">25</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@salary</span> :<span class="operator">=</span> <span class="number">10000</span>;  <span class="comment">-- 使用 := 赋值</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询赋值</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@count</span> :<span class="operator">=</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用变量</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@name</span>, <span class="variable">@age</span>, <span class="variable">@salary</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在查询中使用</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> <span class="variable">@salary</span>;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-用户变量应用"><a href="#4-3-用户变量应用" class="headerlink" title="4.3 用户变量应用"></a>4.3 用户变量应用</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 行号</span></span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@rownum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@rownum</span> :<span class="operator">=</span> <span class="variable">@rownum</span> <span class="operator">+</span> <span class="number">1</span> <span class="keyword">AS</span> rownum, name <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 累计求和</span></span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">SELECT</span> name, salary, <span class="variable">@sum</span> :<span class="operator">=</span> <span class="variable">@sum</span> <span class="operator">+</span> salary <span class="keyword">AS</span> running_total</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<h2 id="五、局部变量"><a href="#五、局部变量" class="headerlink" title="五、局部变量"></a>五、局部变量</h2><h3 id="5-1-声明局部变量"><a href="#5-1-声明局部变量" class="headerlink" title="5.1 声明局部变量"></a>5.1 声明局部变量</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 局部变量在 BEGIN...END 中声明</span></span><br><span class="line"><span class="comment">-- 使用 DECLARE 关键字</span></span><br><span class="line"></span><br><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> var_demo()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="comment">-- 声明变量</span></span><br><span class="line">    <span class="keyword">DECLARE</span> v_name <span class="type">VARCHAR</span>(<span class="number">50</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> v_age <span class="type">INT</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_salary <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 声明并初始化</span></span><br><span class="line">    <span class="keyword">DECLARE</span> v_count <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 赋值</span></span><br><span class="line">    <span class="keyword">SET</span> v_name <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span>;</span><br><span class="line">    <span class="keyword">SET</span> v_age <span class="operator">=</span> <span class="number">25</span>;</span><br><span class="line">    <span class="keyword">SET</span> v_salary <span class="operator">=</span> <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">SELECT</span> v_name, v_age, v_salary;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-SELECT-INTO-赋值"><a href="#5-2-SELECT-INTO-赋值" class="headerlink" title="5.2 SELECT INTO 赋值"></a>5.2 SELECT INTO 赋值</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> select_into_demo()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> v_name <span class="type">VARCHAR</span>(<span class="number">50</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> v_salary <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- SELECT INTO 赋值</span></span><br><span class="line">    <span class="keyword">SELECT</span> name, salary <span class="keyword">INTO</span> v_name, v_salary</span><br><span class="line">    <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">SELECT</span> v_name, v_salary;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<h2 id="六、IF-判断"><a href="#六、IF-判断" class="headerlink" title="六、IF 判断"></a>六、IF 判断</h2><h3 id="6-1-IF-语句语法"><a href="#6-1-IF-语句语法" class="headerlink" title="6.1 IF 语句语法"></a>6.1 IF 语句语法</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 基本语法</span></span><br><span class="line">IF <span class="keyword">condition</span> <span class="keyword">THEN</span></span><br><span class="line">    <span class="comment">-- 语句</span></span><br><span class="line">ELSEIF <span class="keyword">condition</span> <span class="keyword">THEN</span></span><br><span class="line">    <span class="comment">-- 语句</span></span><br><span class="line"><span class="keyword">ELSE</span></span><br><span class="line">    <span class="comment">-- 语句</span></span><br><span class="line"><span class="keyword">END</span> IF;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-IF-语句示例"><a href="#6-2-IF-语句示例" class="headerlink" title="6.2 IF 语句示例"></a>6.2 IF 语句示例</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> salary_level(<span class="keyword">IN</span> v_salary <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>))</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    IF v_salary <span class="operator">&gt;=</span> <span class="number">20000</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SELECT</span> <span class="string">&#x27;高收入&#x27;</span> <span class="keyword">AS</span> level;</span><br><span class="line">    ELSEIF v_salary <span class="operator">&gt;=</span> <span class="number">10000</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SELECT</span> <span class="string">&#x27;中高收入&#x27;</span> <span class="keyword">AS</span> level;</span><br><span class="line">    ELSEIF v_salary <span class="operator">&gt;=</span> <span class="number">5000</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SELECT</span> <span class="string">&#x27;中等收入&#x27;</span> <span class="keyword">AS</span> level;</span><br><span class="line">    <span class="keyword">ELSE</span></span><br><span class="line">        <span class="keyword">SELECT</span> <span class="string">&#x27;低收入&#x27;</span> <span class="keyword">AS</span> level;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 调用</span></span><br><span class="line"><span class="keyword">CALL</span> salary_level(<span class="number">15000</span>);  <span class="comment">-- 中高收入</span></span><br></pre></td></tr></table></figure>

<h2 id="七、参数-IN-OUT-INOUT"><a href="#七、参数-IN-OUT-INOUT" class="headerlink" title="七、参数 IN&#x2F;OUT&#x2F;INOUT"></a>七、参数 IN&#x2F;OUT&#x2F;INOUT</h2><h3 id="7-1-IN-参数（输入）"><a href="#7-1-IN-参数（输入）" class="headerlink" title="7.1 IN 参数（输入）"></a>7.1 IN 参数（输入）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> get_employee(<span class="keyword">IN</span> v_id <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> id <span class="operator">=</span> v_id;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 调用</span></span><br><span class="line"><span class="keyword">CALL</span> get_employee(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<h3 id="7-2-OUT-参数（输出）"><a href="#7-2-OUT-参数（输出）" class="headerlink" title="7.2 OUT 参数（输出）"></a>7.2 OUT 参数（输出）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> get_emp_count(<span class="keyword">OUT</span> v_count <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">INTO</span> v_count <span class="keyword">FROM</span> employees;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 调用</span></span><br><span class="line"><span class="keyword">CALL</span> get_emp_count(<span class="variable">@count</span>);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@count</span>;  <span class="comment">-- 查看结果</span></span><br></pre></td></tr></table></figure>

<h3 id="7-3-INOUT-参数（输入输出）"><a href="#7-3-INOUT-参数（输入输出）" class="headerlink" title="7.3 INOUT 参数（输入输出）"></a>7.3 INOUT 参数（输入输出）</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> increment(<span class="keyword">INOUT</span> v_value <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">SET</span> v_value <span class="operator">=</span> v_value <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 调用</span></span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@num</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"><span class="keyword">CALL</span> increment(<span class="variable">@num</span>);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@num</span>;  <span class="comment">-- 11</span></span><br></pre></td></tr></table></figure>

<h2 id="八、CASE-语句"><a href="#八、CASE-语句" class="headerlink" title="八、CASE 语句"></a>八、CASE 语句</h2><h3 id="8-1-简单-CASE"><a href="#8-1-简单-CASE" class="headerlink" title="8.1 简单 CASE"></a>8.1 简单 CASE</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> case_simple(<span class="keyword">IN</span> v_dept_id <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">CASE</span> v_dept_id</span><br><span class="line">        <span class="keyword">WHEN</span> <span class="number">1</span> <span class="keyword">THEN</span> <span class="keyword">SELECT</span> <span class="string">&#x27;技术部&#x27;</span> <span class="keyword">AS</span> dept_name;</span><br><span class="line">        <span class="keyword">WHEN</span> <span class="number">2</span> <span class="keyword">THEN</span> <span class="keyword">SELECT</span> <span class="string">&#x27;市场部&#x27;</span> <span class="keyword">AS</span> dept_name;</span><br><span class="line">        <span class="keyword">WHEN</span> <span class="number">3</span> <span class="keyword">THEN</span> <span class="keyword">SELECT</span> <span class="string">&#x27;财务部&#x27;</span> <span class="keyword">AS</span> dept_name;</span><br><span class="line">        <span class="keyword">ELSE</span> <span class="keyword">SELECT</span> <span class="string">&#x27;其他部门&#x27;</span> <span class="keyword">AS</span> dept_name;</span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">CASE</span>;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<h3 id="8-2-搜索-CASE"><a href="#8-2-搜索-CASE" class="headerlink" title="8.2 搜索 CASE"></a>8.2 搜索 CASE</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> case_search(<span class="keyword">IN</span> v_salary <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>))</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">CASE</span></span><br><span class="line">        <span class="keyword">WHEN</span> v_salary <span class="operator">&gt;=</span> <span class="number">20000</span> <span class="keyword">THEN</span> <span class="keyword">SELECT</span> <span class="string">&#x27;高薪&#x27;</span> <span class="keyword">AS</span> level;</span><br><span class="line">        <span class="keyword">WHEN</span> v_salary <span class="operator">&gt;=</span> <span class="number">10000</span> <span class="keyword">THEN</span> <span class="keyword">SELECT</span> <span class="string">&#x27;中等&#x27;</span> <span class="keyword">AS</span> level;</span><br><span class="line">        <span class="keyword">ELSE</span> <span class="keyword">SELECT</span> <span class="string">&#x27;低薪&#x27;</span> <span class="keyword">AS</span> level;</span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">CASE</span>;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<h2 id="九、WHILE-循环"><a href="#九、WHILE-循环" class="headerlink" title="九、WHILE 循环"></a>九、WHILE 循环</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> while_demo()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> v_i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    WHILE v_i <span class="operator">&lt;=</span> <span class="number">5</span> DO</span><br><span class="line">        <span class="keyword">SELECT</span> CONCAT(<span class="string">&#x27;第&#x27;</span>, v_i, <span class="string">&#x27;次循环&#x27;</span>) <span class="keyword">AS</span> msg;</span><br><span class="line">        <span class="keyword">SET</span> v_i <span class="operator">=</span> v_i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">END</span> WHILE;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CALL</span> while_demo();</span><br></pre></td></tr></table></figure>

<h2 id="十、REPEAT-循环"><a href="#十、REPEAT-循环" class="headerlink" title="十、REPEAT 循环"></a>十、REPEAT 循环</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> repeat_demo()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> v_i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    REPEAT</span><br><span class="line">        <span class="keyword">SELECT</span> CONCAT(<span class="string">&#x27;第&#x27;</span>, v_i, <span class="string">&#x27;次循环&#x27;</span>) <span class="keyword">AS</span> msg;</span><br><span class="line">        <span class="keyword">SET</span> v_i <span class="operator">=</span> v_i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">    UNTIL v_i <span class="operator">&gt;</span> <span class="number">5</span></span><br><span class="line">    <span class="keyword">END</span> REPEAT;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CALL</span> repeat_demo();</span><br></pre></td></tr></table></figure>

<h2 id="十一、LOOP-循环"><a href="#十一、LOOP-循环" class="headerlink" title="十一、LOOP 循环"></a>十一、LOOP 循环</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> loop_demo()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> v_i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    loop_label: LOOP</span><br><span class="line">        IF v_i <span class="operator">&gt;</span> <span class="number">5</span> <span class="keyword">THEN</span></span><br><span class="line">            LEAVE loop_label;</span><br><span class="line">        <span class="keyword">END</span> IF;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">SELECT</span> CONCAT(<span class="string">&#x27;第&#x27;</span>, v_i, <span class="string">&#x27;次循环&#x27;</span>) <span class="keyword">AS</span> msg;</span><br><span class="line">        <span class="keyword">SET</span> v_i <span class="operator">=</span> v_i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">END</span> LOOP;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CALL</span> loop_demo();</span><br></pre></td></tr></table></figure>

<h2 id="十二、游标-CURSOR"><a href="#十二、游标-CURSOR" class="headerlink" title="十二、游标 CURSOR"></a>十二、游标 CURSOR</h2><h3 id="12-1-游标使用步骤"><a href="#12-1-游标使用步骤" class="headerlink" title="12.1 游标使用步骤"></a>12.1 游标使用步骤</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> cursor_demo()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> v_id <span class="type">INT</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_name <span class="type">VARCHAR</span>(<span class="number">50</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> done <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 1. 声明游标</span></span><br><span class="line">    <span class="keyword">DECLARE</span> cur_emp <span class="keyword">CURSOR</span> <span class="keyword">FOR</span> <span class="keyword">SELECT</span> id, name <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 2. 声明继续处理器</span></span><br><span class="line">    <span class="keyword">DECLARE</span> CONTINUE HANDLER <span class="keyword">FOR</span> <span class="keyword">NOT</span> FOUND <span class="keyword">SET</span> done <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 3. 打开游标</span></span><br><span class="line">    <span class="keyword">OPEN</span> cur_emp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 4. 读取数据</span></span><br><span class="line">    read_loop: LOOP</span><br><span class="line">        <span class="keyword">FETCH</span> cur_emp <span class="keyword">INTO</span> v_id, v_name;</span><br><span class="line"></span><br><span class="line">        IF done <span class="operator">=</span> <span class="number">1</span> <span class="keyword">THEN</span></span><br><span class="line">            LEAVE read_loop;</span><br><span class="line">        <span class="keyword">END</span> IF;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">SELECT</span> CONCAT(<span class="string">&#x27;ID:&#x27;</span>, v_id, <span class="string">&#x27; Name:&#x27;</span>, v_name) <span class="keyword">AS</span> emp_info;</span><br><span class="line">    <span class="keyword">END</span> LOOP;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 5. 关闭游标</span></span><br><span class="line">    <span class="keyword">CLOSE</span> cur_emp;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<h3 id="12-2-游标嵌套"><a href="#12-2-游标嵌套" class="headerlink" title="12.2 游标嵌套"></a>12.2 游标嵌套</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> cursor_nested()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> v_dept_id <span class="type">INT</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> v_dept_name <span class="type">VARCHAR</span>(<span class="number">50</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> v_emp_name <span class="type">VARCHAR</span>(<span class="number">50</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> done_dept <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> done_emp <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 外层游标</span></span><br><span class="line">    <span class="keyword">DECLARE</span> cur_dept <span class="keyword">CURSOR</span> <span class="keyword">FOR</span> <span class="keyword">SELECT</span> id, name <span class="keyword">FROM</span> departments;</span><br><span class="line">    <span class="keyword">DECLARE</span> CONTINUE HANDLER <span class="keyword">FOR</span> <span class="keyword">NOT</span> FOUND <span class="keyword">SET</span> done_dept <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">OPEN</span> cur_dept;</span><br><span class="line"></span><br><span class="line">    dept_loop: LOOP</span><br><span class="line">        <span class="keyword">FETCH</span> cur_dept <span class="keyword">INTO</span> v_dept_id, v_dept_name;</span><br><span class="line">        IF done_dept <span class="operator">=</span> <span class="number">1</span> <span class="keyword">THEN</span></span><br><span class="line">            LEAVE dept_loop;</span><br><span class="line">        <span class="keyword">END</span> IF;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">SELECT</span> CONCAT(<span class="string">&#x27;部门:&#x27;</span>, v_dept_name) <span class="keyword">AS</span> dept_info;</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- 内层游标</span></span><br><span class="line">        <span class="keyword">BEGIN</span></span><br><span class="line">            <span class="keyword">DECLARE</span> cur_emp <span class="keyword">CURSOR</span> <span class="keyword">FOR</span></span><br><span class="line">                <span class="keyword">SELECT</span> name <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> v_dept_id;</span><br><span class="line">            <span class="keyword">DECLARE</span> CONTINUE HANDLER <span class="keyword">FOR</span> <span class="keyword">NOT</span> FOUND <span class="keyword">SET</span> done_emp <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">OPEN</span> cur_emp;</span><br><span class="line"></span><br><span class="line">            emp_loop: LOOP</span><br><span class="line">                <span class="keyword">FETCH</span> cur_emp <span class="keyword">INTO</span> v_emp_name;</span><br><span class="line">                IF done_emp <span class="operator">=</span> <span class="number">1</span> <span class="keyword">THEN</span></span><br><span class="line">                    <span class="keyword">SET</span> done_emp <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                    LEAVE emp_loop;</span><br><span class="line">                <span class="keyword">END</span> IF;</span><br><span class="line">                <span class="keyword">SELECT</span> CONCAT(<span class="string">&#x27;  员工:&#x27;</span>, v_emp_name) <span class="keyword">AS</span> emp_info;</span><br><span class="line">            <span class="keyword">END</span> LOOP;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">CLOSE</span> cur_emp;</span><br><span class="line">        <span class="keyword">END</span>;</span><br><span class="line">    <span class="keyword">END</span> LOOP;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">CLOSE</span> cur_dept;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<h2 id="十三、条件处理程序-HANDLER"><a href="#十三、条件处理程序-HANDLER" class="headerlink" title="十三、条件处理程序 HANDLER"></a>十三、条件处理程序 HANDLER</h2><h3 id="13-1-HANDLER-语法"><a href="#13-1-HANDLER-语法" class="headerlink" title="13.1 HANDLER 语法"></a>13.1 HANDLER 语法</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 基本语法</span></span><br><span class="line"><span class="keyword">DECLARE</span> handler_type HANDLER <span class="keyword">FOR</span> condition_value statement</span><br><span class="line"></span><br><span class="line"><span class="comment">-- handler_type:</span></span><br><span class="line"><span class="comment">--   CONTINUE    - 继续执行</span></span><br><span class="line"><span class="comment">--   EXIT        - 退出</span></span><br><span class="line"><span class="comment">--   UNDO        - 回滚（MySQL 不支持）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- condition_value:</span></span><br><span class="line"><span class="comment">--   SQLSTATE &#x27;error_code&#x27;</span></span><br><span class="line"><span class="comment">--   SQLWARNING</span></span><br><span class="line"><span class="comment">--   NOT FOUND</span></span><br><span class="line"><span class="comment">--   SQLEXCEPTION</span></span><br></pre></td></tr></table></figure>

<h3 id="13-2-HANDLER-示例"><a href="#13-2-HANDLER-示例" class="headerlink" title="13.2 HANDLER 示例"></a>13.2 HANDLER 示例</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> handler_demo()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> v_result <span class="type">INT</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 声明继续处理器</span></span><br><span class="line">    <span class="keyword">DECLARE</span> CONTINUE HANDLER <span class="keyword">FOR</span> <span class="keyword">SQLEXCEPTION</span></span><br><span class="line">        <span class="keyword">SELECT</span> <span class="string">&#x27;发生错误&#x27;</span> <span class="keyword">AS</span> msg;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 声明退出处理器</span></span><br><span class="line">    <span class="keyword">DECLARE</span> EXIT HANDLER <span class="keyword">FOR</span> <span class="keyword">NOT</span> FOUND</span><br><span class="line">        <span class="keyword">SELECT</span> <span class="string">&#x27;未找到数据&#x27;</span> <span class="keyword">AS</span> msg;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 可能出错的语句</span></span><br><span class="line">    <span class="keyword">SELECT</span> <span class="number">1</span><span class="operator">/</span><span class="number">0</span> <span class="keyword">INTO</span> v_result;  <span class="comment">-- 除零错误</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">SELECT</span> <span class="string">&#x27;继续执行&#x27;</span> <span class="keyword">AS</span> msg;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<h2 id="十四、存储函数"><a href="#十四、存储函数" class="headerlink" title="十四、存储函数"></a>十四、存储函数</h2><h3 id="14-1-存储函数语法"><a href="#14-1-存储函数语法" class="headerlink" title="14.1 存储函数语法"></a>14.1 存储函数语法</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> function_name(param_name type)</span><br><span class="line"><span class="keyword">RETURNS</span> return_type</span><br><span class="line"><span class="keyword">DETERMINISTIC</span>  <span class="comment">-- 或 NO SQL / READS SQL DATA / MODIFIES SQL DATA</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="comment">-- 函数体</span></span><br><span class="line">    <span class="keyword">RETURN</span> <span class="keyword">value</span>;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<h3 id="14-2-存储函数示例"><a href="#14-2-存储函数示例" class="headerlink" title="14.2 存储函数示例"></a>14.2 存储函数示例</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> get_dept_name(v_dept_id <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">RETURNS</span> <span class="type">VARCHAR</span>(<span class="number">50</span>)</span><br><span class="line"><span class="keyword">READS</span> <span class="keyword">SQL</span> DATA</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> v_name <span class="type">VARCHAR</span>(<span class="number">50</span>);</span><br><span class="line">    <span class="keyword">SELECT</span> dept_name <span class="keyword">INTO</span> v_name <span class="keyword">FROM</span> departments <span class="keyword">WHERE</span> id <span class="operator">=</span> v_dept_id;</span><br><span class="line">    <span class="keyword">RETURN</span> v_name;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 调用</span></span><br><span class="line"><span class="keyword">SELECT</span> get_dept_name(<span class="number">1</span>) <span class="keyword">AS</span> dept_name;</span><br><span class="line"><span class="keyword">SELECT</span> id, name, get_dept_name(dept_id) <span class="keyword">AS</span> dept <span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<h3 id="14-3-函数与存储过程的区别"><a href="#14-3-函数与存储过程的区别" class="headerlink" title="14.3 函数与存储过程的区别"></a>14.3 函数与存储过程的区别</h3><table>
<thead>
<tr>
<th>区别</th>
<th>存储过程</th>
<th>存储函数</th>
</tr>
</thead>
<tbody><tr>
<td>返回值</td>
<td>可以有多个 OUT 参数</td>
<td>必须有一个返回值</td>
</tr>
<tr>
<td>调用方式</td>
<td>CALL</td>
<td>SELECT</td>
</tr>
<tr>
<td>使用场景</td>
<td>复杂业务逻辑</td>
<td>计算、转换</td>
</tr>
</tbody></table>
<h2 id="十五、小结"><a href="#十五、小结" class="headerlink" title="十五、小结"></a>十五、小结</h2><h3 id="核心知识点"><a href="#核心知识点" class="headerlink" title="核心知识点"></a>核心知识点</h3><ol>
<li><strong>存储过程</strong>：预编译的 SQL 程序，使用 CALL 调用</li>
<li><strong>变量</strong>：系统变量、用户变量、局部变量</li>
<li><strong>流程控制</strong>：IF、CASE、WHILE、REPEAT、LOOP</li>
<li><strong>游标</strong>：遍历查询结果集</li>
<li><strong>HANDLER</strong>：异常处理机制</li>
<li><strong>存储函数</strong>：有返回值，使用 SELECT 调用</li>
</ol>
<h3 id="使用建议"><a href="#使用建议" class="headerlink" title="使用建议"></a>使用建议</h3><table>
<thead>
<tr>
<th>场景</th>
<th>推荐</th>
</tr>
</thead>
<tbody><tr>
<td>复杂业务逻辑</td>
<td>存储过程</td>
</tr>
<tr>
<td>代码复用</td>
<td>存储过程&#x2F;函数</td>
</tr>
<tr>
<td>计算转换</td>
<td>存储函数</td>
</tr>
<tr>
<td>批量处理</td>
<td>存储过程</td>
</tr>
</tbody></table>
<h3 id="下一章预告"><a href="#下一章预告" class="headerlink" title="下一章预告"></a>下一章预告</h3><p>下一篇文章将介绍<strong>触发器</strong>，包括：</p>
<ul>
<li>触发器概念</li>
<li>INSERT&#x2F;UPDATE&#x2F;DELETE 触发器</li>
<li>触发器应用场景</li>
</ul>
<hr>
<p><strong>下一篇</strong>：[MySQL 进阶教程 14-01 触发器详解](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 14-01 触发器详解&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 进阶教程 12-01 视图详解](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 12-01 视图详解&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 进阶教程</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>存储过程</tag>
        <tag>存储函数</tag>
        <tag>游标</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 进阶教程 15-01 MySQL 管理</title>
    <url>/2026/02/24/MySQL%20%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B%2015-01%20MySQL%20%E7%AE%A1%E7%90%86/</url>
    <content><![CDATA[<h1 id="MySQL-进阶教程-15-01-MySQL-管理"><a href="#MySQL-进阶教程-15-01-MySQL-管理" class="headerlink" title="MySQL 进阶教程 15-01 MySQL 管理"></a>MySQL 进阶教程 15-01 MySQL 管理</h1><p>本文将介绍 MySQL 的系统数据库、常用管理工具，并对整个进阶教程进行总结。</p>
<h2 id="一、系统数据库介绍"><a href="#一、系统数据库介绍" class="headerlink" title="一、系统数据库介绍"></a>一、系统数据库介绍</h2><h3 id="1-1-MySQL-系统数据库"><a href="#1-1-MySQL-系统数据库" class="headerlink" title="1.1 MySQL 系统数据库"></a>1.1 MySQL 系统数据库</h3><table>
<thead>
<tr>
<th>数据库</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>mysql</td>
<td>核心系统表（用户、权限、存储过程等）</td>
</tr>
<tr>
<td>information_schema</td>
<td>信息数据库（表结构、权限等元数据）</td>
</tr>
<tr>
<td>performance_schema</td>
<td>性能监控数据库</td>
</tr>
<tr>
<td>sys</td>
<td>简化性能监控的视图和函数</td>
</tr>
</tbody></table>
<h3 id="1-2-mysql-数据库"><a href="#1-2-mysql-数据库" class="headerlink" title="1.2 mysql 数据库"></a>1.2 mysql 数据库</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看 mysql 数据库中的表</span></span><br><span class="line">USE mysql;</span><br><span class="line"><span class="keyword">SHOW</span> TABLES;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 重要表说明：</span></span><br><span class="line"><span class="comment">-- user: 用户账号和全局权限</span></span><br><span class="line"><span class="comment">-- db: 数据库级权限</span></span><br><span class="line"><span class="comment">-- tables_priv: 表级权限</span></span><br><span class="line"><span class="comment">-- columns_priv: 列级权限</span></span><br><span class="line"><span class="comment">-- procs_priv: 存储过程和函数权限</span></span><br></pre></td></tr></table></figure>

<h3 id="1-3-information-schema-数据库"><a href="#1-3-information-schema-数据库" class="headerlink" title="1.3 information_schema 数据库"></a>1.3 information_schema 数据库</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看表信息</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.tables</span><br><span class="line"><span class="keyword">WHERE</span> table_schema <span class="operator">=</span> <span class="string">&#x27;your_db&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看列信息</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.columns</span><br><span class="line"><span class="keyword">WHERE</span> table_schema <span class="operator">=</span> <span class="string">&#x27;your_db&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看索引信息</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.statistics</span><br><span class="line"><span class="keyword">WHERE</span> table_schema <span class="operator">=</span> <span class="string">&#x27;your_db&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看外键信息</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.key_column_usage</span><br><span class="line"><span class="keyword">WHERE</span> table_schema <span class="operator">=</span> <span class="string">&#x27;your_db&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="1-4-performance-schema-数据库"><a href="#1-4-performance-schema-数据库" class="headerlink" title="1.4 performance_schema 数据库"></a>1.4 performance_schema 数据库</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看性能监控表</span></span><br><span class="line"><span class="keyword">SHOW</span> TABLES <span class="keyword">FROM</span> performance_schema;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 常用性能视图：</span></span><br><span class="line"><span class="comment">-- events_statements_summary_by_digest: SQL 执行统计</span></span><br><span class="line"><span class="comment">-- table_io_waits_summary_by_table: 表 IO 统计</span></span><br><span class="line"><span class="comment">-- mutex_instances: 锁实例信息</span></span><br></pre></td></tr></table></figure>

<h3 id="1-5-sys-数据库"><a href="#1-5-sys-数据库" class="headerlink" title="1.5 sys 数据库"></a>1.5 sys 数据库</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- sys 库提供简化的性能监控视图</span></span><br><span class="line"><span class="keyword">SHOW</span> TABLES <span class="keyword">FROM</span> sys;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 常用视图：</span></span><br><span class="line"><span class="comment">-- sys.schema_table_statistics: 表使用统计</span></span><br><span class="line"><span class="comment">-- sys.session: 当前会话信息</span></span><br><span class="line"><span class="comment">-- sys.statement_analysis: SQL 分析</span></span><br><span class="line"><span class="comment">-- sys.schema_unused_indexes: 未使用的索引</span></span><br></pre></td></tr></table></figure>

<h2 id="二、常用工具-1"><a href="#二、常用工具-1" class="headerlink" title="二、常用工具 1"></a>二、常用工具 1</h2><h3 id="2-1-mysql-命令行工具"><a href="#2-1-mysql-命令行工具" class="headerlink" title="2.1 mysql 命令行工具"></a>2.1 mysql 命令行工具</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 连接 MySQL</span></span><br><span class="line">mysql -u root -p</span><br><span class="line">mysql -u root -p -h 127.0.0.1 -P 3306</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行 SQL 文件</span></span><br><span class="line">mysql -u root -p database_name &lt; backup.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行单条 SQL</span></span><br><span class="line">mysql -u root -p -e <span class="string">&quot;SELECT VERSION();&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 常用命令</span></span><br><span class="line">mysql&gt; \h           <span class="comment"># 帮助</span></span><br><span class="line">mysql&gt; \u database  <span class="comment"># 使用数据库</span></span><br><span class="line">mysql&gt; \s           <span class="comment"># 显示连接信息</span></span><br><span class="line">mysql&gt; \q           <span class="comment"># 退出</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-mysqldump-备份工具"><a href="#2-2-mysqldump-备份工具" class="headerlink" title="2.2 mysqldump 备份工具"></a>2.2 mysqldump 备份工具</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 备份整个数据库</span></span><br><span class="line">mysqldump -u root -p database_name &gt; backup.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份多个数据库</span></span><br><span class="line">mysqldump -u root -p --databases db1 db2 &gt; backup.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份所有数据库</span></span><br><span class="line">mysqldump -u root -p --all-databases &gt; all_backup.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只备份结构</span></span><br><span class="line">mysqldump -u root -p --no-data database_name &gt; structure.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只备份数据</span></span><br><span class="line">mysqldump -u root -p --no-create-info database_name &gt; data.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份特定表</span></span><br><span class="line">mysqldump -u root -p database_name table1 table2 &gt; tables.sql</span><br></pre></td></tr></table></figure>

<h3 id="2-3-mysqlpump-备份工具（MySQL-5-7-）"><a href="#2-3-mysqlpump-备份工具（MySQL-5-7-）" class="headerlink" title="2.3 mysqlpump 备份工具（MySQL 5.7+）"></a>2.3 mysqlpump 备份工具（MySQL 5.7+）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mysqlpump 支持并行备份，速度更快</span></span><br><span class="line">mysqlpump -u root -p database_name &gt; backup.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 并行备份</span></span><br><span class="line">mysqlpump -u root -p --parallel-schemas=4 database_name &gt; backup.sql</span><br></pre></td></tr></table></figure>

<h2 id="三、常用工具-2"><a href="#三、常用工具-2" class="headerlink" title="三、常用工具 2"></a>三、常用工具 2</h2><h3 id="3-1-mysqlimport-导入工具"><a href="#3-1-mysqlimport-导入工具" class="headerlink" title="3.1 mysqlimport 导入工具"></a>3.1 mysqlimport 导入工具</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 从 CSV 文件导入</span></span><br><span class="line">mysqlimport -u root -p --<span class="built_in">local</span> database_name /path/to/file.csv</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定字段分隔符</span></span><br><span class="line">mysqlimport -u root -p --<span class="built_in">local</span> --fields-terminated-by=<span class="string">&#x27;,&#x27;</span> database_name file.txt</span><br></pre></td></tr></table></figure>

<h3 id="3-2-myisamchk-表检查工具"><a href="#3-2-myisamchk-表检查工具" class="headerlink" title="3.2 myisamchk 表检查工具"></a>3.2 myisamchk 表检查工具</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 检查 MyISAM 表</span></span><br><span class="line">myisamchk /path/to/table.MYI</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修复 MyISAM 表</span></span><br><span class="line">myisamchk -r /path/to/table.MYI</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分析 MyISAM 表</span></span><br><span class="line">myisamchk -a /path/to/table.MYI</span><br></pre></td></tr></table></figure>

<h3 id="3-3-mysqladmin-管理工具"><a href="#3-3-mysqladmin-管理工具" class="headerlink" title="3.3 mysqladmin 管理工具"></a>3.3 mysqladmin 管理工具</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">mysqladmin -u root -p status</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看变量</span></span><br><span class="line">mysqladmin -u root -p variables</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭服务器</span></span><br><span class="line">mysqladmin -u root -p shutdown</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建数据库</span></span><br><span class="line">mysqladmin -u root -p create database_name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除数据库</span></span><br><span class="line">mysqladmin -u root -p drop database_name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 刷新权限</span></span><br><span class="line">mysqladmin -u root -p flush-privileges</span><br></pre></td></tr></table></figure>

<h3 id="3-4-pt-tools（Percona-Toolkit）"><a href="#3-4-pt-tools（Percona-Toolkit）" class="headerlink" title="3.4 pt-tools（Percona Toolkit）"></a>3.4 pt-tools（Percona Toolkit）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># pt-query-digest: 分析慢查询</span></span><br><span class="line">pt-query-digest /var/log/mysql/slow.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># pt-table-checksum: 检查主从数据一致性</span></span><br><span class="line">pt-table-checksum -u root -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># pt-table-sync: 同步主从数据</span></span><br><span class="line">pt-table-sync -u root -p h=slave_host</span><br><span class="line"></span><br><span class="line"><span class="comment"># pt-online-schema-change: 在线修改表结构</span></span><br><span class="line">pt-online-schema-change -u root -p --alter <span class="string">&quot;ADD COLUMN age INT&quot;</span> D=database,t=table</span><br></pre></td></tr></table></figure>

<h2 id="四、进阶篇总结"><a href="#四、进阶篇总结" class="headerlink" title="四、进阶篇总结"></a>四、进阶篇总结</h2><h3 id="4-1-知识体系回顾"><a href="#4-1-知识体系回顾" class="headerlink" title="4.1 知识体系回顾"></a>4.1 知识体系回顾</h3><p>本进阶篇共 15 章，涵盖了以下核心内容：</p>
<table>
<thead>
<tr>
<th>篇章</th>
<th>主题</th>
<th>核心内容</th>
</tr>
</thead>
<tbody><tr>
<td>01</td>
<td>常用函数</td>
<td>字符串、数值、日期、流程函数</td>
</tr>
<tr>
<td>02</td>
<td>数据库约束</td>
<td>主键、外键、唯一、检查约束</td>
</tr>
<tr>
<td>03</td>
<td>多表查询</td>
<td>连接查询、子查询、联合查询</td>
</tr>
<tr>
<td>04</td>
<td>窗口函数</td>
<td>ROW_NUMBER、RANK、LEAD&#x2F;LAG</td>
</tr>
<tr>
<td>05</td>
<td>事务</td>
<td>ACID、隔离级别、并发问题</td>
</tr>
<tr>
<td>06</td>
<td>存储引擎</td>
<td>InnoDB、MyISAM、Memory</td>
</tr>
<tr>
<td>07</td>
<td>索引</td>
<td>B+Tree、索引分类、EXPLAIN</td>
</tr>
<tr>
<td>08</td>
<td>索引使用</td>
<td>最左前缀、索引失效、覆盖索引</td>
</tr>
<tr>
<td>09</td>
<td>SQL 优化</td>
<td>插入优化、LIMIT 优化、慢查询</td>
</tr>
<tr>
<td>10</td>
<td>锁机制</td>
<td>全局锁、表锁、行锁、间隙锁</td>
</tr>
<tr>
<td>11</td>
<td>InnoDB 深入</td>
<td>存储结构、Redo&#x2F;Undo、MVCC</td>
</tr>
<tr>
<td>12</td>
<td>视图</td>
<td>视图创建、检查选项、视图更新</td>
</tr>
<tr>
<td>13</td>
<td>存储过程</td>
<td>变量、流程控制、游标</td>
</tr>
<tr>
<td>14</td>
<td>触发器</td>
<td>INSERT&#x2F;UPDATE&#x2F;DELETE 触发器</td>
</tr>
<tr>
<td>15</td>
<td>MySQL 管理</td>
<td>系统数据库、管理工具</td>
</tr>
</tbody></table>
<h3 id="4-2-核心技能树"><a href="#4-2-核心技能树" class="headerlink" title="4.2 核心技能树"></a>4.2 核心技能树</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MySQL 进阶技能</span><br><span class="line">├── SQL 编程</span><br><span class="line">│   ├── 函数和运算符</span><br><span class="line">│   ├── 存储过程和函数</span><br><span class="line">│   ├── 触发器</span><br><span class="line">│   └── 视图</span><br><span class="line">│</span><br><span class="line">├── 性能优化</span><br><span class="line">│   ├── 索引设计与优化</span><br><span class="line">│   ├── SQL 语句优化</span><br><span class="line">│   ├── 锁机制理解</span><br><span class="line">│   └── 慢查询分析</span><br><span class="line">│</span><br><span class="line">├── 事务与并发</span><br><span class="line">│   ├── 事务 ACID</span><br><span class="line">│   ├── 隔离级别</span><br><span class="line">│   ├── MVCC</span><br><span class="line">│   └── 锁机制</span><br><span class="line">│</span><br><span class="line">└── 存储引擎</span><br><span class="line">    ├── InnoDB 架构</span><br><span class="line">    ├── 日志系统</span><br><span class="line">    └── 存储结构</span><br></pre></td></tr></table></figure>

<h3 id="4-3-学习建议"><a href="#4-3-学习建议" class="headerlink" title="4.3 学习建议"></a>4.3 学习建议</h3><ol>
<li><strong>理论结合实践</strong>：多在实际环境中练习</li>
<li><strong>理解原理</strong>：不只是记住语法，理解背后的原理</li>
<li><strong>性能意识</strong>：写 SQL 时考虑性能影响</li>
<li><strong>持续学习</strong>：关注 MySQL 新版本特性</li>
</ol>
<h3 id="4-4-推荐资源"><a href="#4-4-推荐资源" class="headerlink" title="4.4 推荐资源"></a>4.4 推荐资源</h3><p><strong>官方文档</strong>：</p>
<ul>
<li><a href="https://dev.mysql.com/doc/">MySQL 官方文档</a></li>
</ul>
<p><strong>书籍</strong>：</p>
<ul>
<li>《高性能 MySQL》</li>
<li>《MySQL 技术内幕：InnoDB 存储引擎》</li>
<li>《MySQL 必知必会》</li>
</ul>
<p><strong>在线练习</strong>：</p>
<ul>
<li>LeetCode 数据库题</li>
<li>牛客网 SQL 练习</li>
</ul>
<h2 id="五、结语"><a href="#五、结语" class="headerlink" title="五、结语"></a>五、结语</h2><p>恭喜完成 MySQL 进阶教程的学习！</p>
<p>本教程涵盖了 MySQL 的核心进阶知识，包括：</p>
<ul>
<li>常用函数和数据库约束</li>
<li>多表查询和窗口函数</li>
<li>事务和锁机制</li>
<li>索引和 SQL 优化</li>
<li>InnoDB 存储引擎深入</li>
<li>视图、存储过程、触发器</li>
</ul>
<p><strong>下一步学习建议</strong>：</p>
<ol>
<li>在项目中实践所学知识</li>
<li>深入学习数据库性能调优</li>
<li>了解分布式数据库和分库分表</li>
<li>学习其他数据库（PostgreSQL、MongoDB 等）</li>
</ol>
<p>祝你在数据库学习的道路上越走越远！</p>
<hr>
<p><strong>进阶教程系列完结</strong></p>
<p><strong>下一篇</strong>：[MySQL 进阶教程 15-05 进阶篇总结](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 15-05 进阶篇总结&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 进阶教程 14-01 触发器详解](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 14-01 触发器详解&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 进阶教程</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>数据库管理</tag>
        <tag>系统数据库</tag>
        <tag>工具</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 进阶教程 15-05 进阶篇总结</title>
    <url>/2026/02/23/MySQL%20%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B%2015-05%20%E8%BF%9B%E9%98%B6%E7%AF%87%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<h1 id="MySQL-进阶教程-15-05-进阶篇总结"><a href="#MySQL-进阶教程-15-05-进阶篇总结" class="headerlink" title="MySQL 进阶教程 15-05 进阶篇总结"></a>MySQL 进阶教程 15-05 进阶篇总结</h1><p>至此，MySQL 基础篇和进阶教程全部完成！本文将对整个系列进行系统总结，并提供学习路线建议。</p>
<h2 id="一、系列文章回顾"><a href="#一、系列文章回顾" class="headerlink" title="一、系列文章回顾"></a>一、系列文章回顾</h2><h3 id="基础教程系列"><a href="#基础教程系列" class="headerlink" title="基础教程系列"></a>基础教程系列</h3><table>
<thead>
<tr>
<th>篇目</th>
<th>主题</th>
<th>核心内容</th>
</tr>
</thead>
<tbody><tr>
<td>基础（一）</td>
<td>数据库基础与环境搭建</td>
<td>数据库概念、MySQL 安装、数据模型、SQL 分类</td>
</tr>
<tr>
<td>基础（二）</td>
<td>DDL 数据定义语言</td>
<td>数据库操作、表操作、数据类型、DataGrip</td>
</tr>
<tr>
<td>基础（三）</td>
<td>DML 数据操作语言</td>
<td>INSERT、UPDATE、DELETE、事务基础</td>
</tr>
<tr>
<td>基础（四）</td>
<td>DQL 数据查询语言</td>
<td>基础查询、条件查询、聚合函数、分组、排序、分页、连接查询、子查询</td>
</tr>
<tr>
<td>基础（五）</td>
<td>DCL 数据控制语言</td>
<td>用户管理、权限控制、事务控制</td>
</tr>
</tbody></table>
<h3 id="进阶教程系列"><a href="#进阶教程系列" class="headerlink" title="进阶教程系列"></a>进阶教程系列</h3><table>
<thead>
<tr>
<th>篇目</th>
<th>主题</th>
<th>核心内容</th>
</tr>
</thead>
<tbody><tr>
<td>进阶（一）</td>
<td>常用函数详解</td>
<td>字符串函数、数值函数、日期函数、流程函数</td>
</tr>
<tr>
<td>进阶（二）</td>
<td>数据库约束</td>
<td>主键、外键、唯一、非空、默认、检查约束</td>
</tr>
<tr>
<td>进阶（三）</td>
<td>多表查询</td>
<td>表关系、连接查询、联合查询、子查询</td>
</tr>
<tr>
<td>进阶（四）</td>
<td>事务</td>
<td>ACID 特性、并发问题、隔离级别、锁机制</td>
</tr>
</tbody></table>
<h2 id="二、知识体系思维导图"><a href="#二、知识体系思维导图" class="headerlink" title="二、知识体系思维导图"></a>二、知识体系思维导图</h2><h3 id="2-1-SQL-语言分类"><a href="#2-1-SQL-语言分类" class="headerlink" title="2.1 SQL 语言分类"></a>2.1 SQL 语言分类</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SQL</span><br><span class="line">├── DDL（数据定义语言）</span><br><span class="line">│   ├── CREATE DATABASE/TABLE</span><br><span class="line">│   ├── ALTER DATABASE/TABLE</span><br><span class="line">│   ├── DROP DATABASE/TABLE</span><br><span class="line">│   └── TRUNCATE TABLE</span><br><span class="line">│</span><br><span class="line">├── DML（数据操作语言）</span><br><span class="line">│   ├── INSERT INTO ... VALUES</span><br><span class="line">│   ├── UPDATE ... SET ... WHERE</span><br><span class="line">│   └── DELETE FROM ... WHERE</span><br><span class="line">│</span><br><span class="line">├── DQL（数据查询语言）</span><br><span class="line">│   ├── SELECT ... FROM ... WHERE</span><br><span class="line">│   ├── GROUP BY ... HAVING</span><br><span class="line">│   ├── ORDER BY ... LIMIT</span><br><span class="line">│   └── JOIN / UNION / 子查询</span><br><span class="line">│</span><br><span class="line">└── DCL（数据控制语言）</span><br><span class="line">    ├── CREATE USER / DROP USER</span><br><span class="line">    ├── GRANT / REVOKE</span><br><span class="line">    ├── START TRANSACTION / COMMIT / ROLLBACK</span><br><span class="line">    └── SAVEPOINT</span><br></pre></td></tr></table></figure>

<h3 id="2-2-核心知识点"><a href="#2-2-核心知识点" class="headerlink" title="2.2 核心知识点"></a>2.2 核心知识点</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MySQL</span><br><span class="line">├── 基础概念</span><br><span class="line">│   ├── 数据库、DBMS、SQL</span><br><span class="line">│   ├── 数据模型（关系模型、ER 图）</span><br><span class="line">│   └── 三大范式</span><br><span class="line">│</span><br><span class="line">├── 数据类型</span><br><span class="line">│   ├── 数值类型（INT、DECIMAL、FLOAT）</span><br><span class="line">│   ├── 字符串类型（CHAR、VARCHAR、TEXT）</span><br><span class="line">│   └── 日期时间类型（DATE、DATETIME、TIMESTAMP）</span><br><span class="line">│</span><br><span class="line">├── 函数</span><br><span class="line">│   ├── 字符串函数（CONCAT、SUBSTRING、REPLACE）</span><br><span class="line">│   ├── 数值函数（ABS、ROUND、CEIL、FLOOR）</span><br><span class="line">│   ├── 日期函数（NOW、DATE_FORMAT、DATEDIFF）</span><br><span class="line">│   └── 流程函数（IF、CASE、IFNULL）</span><br><span class="line">│</span><br><span class="line">├── 约束</span><br><span class="line">│   ├── PRIMARY KEY（主键）</span><br><span class="line">│   ├── FOREIGN KEY（外键）</span><br><span class="line">│   ├── UNIQUE（唯一）</span><br><span class="line">│   ├── NOT NULL（非空）</span><br><span class="line">│   ├── DEFAULT（默认）</span><br><span class="line">│   └── CHECK（检查）</span><br><span class="line">│</span><br><span class="line">├── 查询</span><br><span class="line">│   ├── 单表查询</span><br><span class="line">│   ├── 多表连接（INNER/LEFT/RIGHT JOIN）</span><br><span class="line">│   ├── 自连接</span><br><span class="line">│   ├── UNION 联合</span><br><span class="line">│   └── 子查询（标量/列/行/表）</span><br><span class="line">│</span><br><span class="line">└── 事务</span><br><span class="line">    ├── ACID 特性</span><br><span class="line">    ├── 隔离级别</span><br><span class="line">    ├── 并发问题（脏读/不可重复读/幻读）</span><br><span class="line">    └── 锁机制</span><br></pre></td></tr></table></figure>

<h2 id="三、SQL-语法速查"><a href="#三、SQL-语法速查" class="headerlink" title="三、SQL 语法速查"></a>三、SQL 语法速查</h2><h3 id="3-1-完整-SELECT-语法"><a href="#3-1-完整-SELECT-语法" class="headerlink" title="3.1 完整 SELECT 语法"></a>3.1 完整 SELECT 语法</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> [<span class="keyword">DISTINCT</span>] 列名 [<span class="keyword">AS</span> 别名], ...</span><br><span class="line"><span class="keyword">FROM</span> 表名 [<span class="keyword">AS</span> 别名]</span><br><span class="line">[<span class="keyword">INNER</span> <span class="operator">|</span> <span class="keyword">LEFT</span> <span class="operator">|</span> <span class="keyword">RIGHT</span>] <span class="keyword">JOIN</span> 表名 <span class="keyword">ON</span> 连接条件</span><br><span class="line">[<span class="keyword">WHERE</span> 条件]</span><br><span class="line">[<span class="keyword">GROUP</span> <span class="keyword">BY</span> 分组列 [<span class="keyword">HAVING</span> 分组过滤]]</span><br><span class="line">[<span class="keyword">ORDER</span> <span class="keyword">BY</span> 排序列 [<span class="keyword">ASC</span> <span class="operator">|</span> <span class="keyword">DESC</span>]]</span><br><span class="line">[LIMIT [<span class="keyword">offset</span>,] count];</span><br></pre></td></tr></table></figure>

<h3 id="3-2-SQL-执行顺序"><a href="#3-2-SQL-执行顺序" class="headerlink" title="3.2 SQL 执行顺序"></a>3.2 SQL 执行顺序</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">FROM → JOIN → WHERE → GROUP BY → HAVING → SELECT → DISTINCT → ORDER BY → LIMIT</span><br></pre></td></tr></table></figure>

<p><strong>记忆要点</strong>：</p>
<ul>
<li>WHERE 在 SELECT 之前执行（不能使用别名）</li>
<li>HAVING 在 GROUP BY 之后执行（可以使用聚合函数）</li>
<li>ORDER BY 在 HAVING 之后执行</li>
<li>LIMIT 最后执行</li>
</ul>
<h3 id="3-3-常用命令速查"><a href="#3-3-常用命令速查" class="headerlink" title="3.3 常用命令速查"></a>3.3 常用命令速查</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 数据库操作</span></span><br><span class="line"><span class="keyword">SHOW</span> DATABASES;</span><br><span class="line"><span class="keyword">CREATE</span> DATABASE db_name;</span><br><span class="line">USE db_name;</span><br><span class="line"><span class="keyword">DROP</span> DATABASE db_name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 表操作</span></span><br><span class="line"><span class="keyword">SHOW</span> TABLES;</span><br><span class="line"><span class="keyword">DESC</span> table_name;</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE TABLE</span> table_name;</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> table_name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 数据操作</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> <span class="keyword">table</span> (col1, col2) <span class="keyword">VALUES</span> (val1, val2);</span><br><span class="line"><span class="keyword">UPDATE</span> <span class="keyword">table</span> <span class="keyword">SET</span> col1 <span class="operator">=</span> val1 <span class="keyword">WHERE</span> <span class="keyword">condition</span>;</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> <span class="keyword">condition</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询操作</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> <span class="keyword">condition</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> <span class="keyword">table</span>;</span><br><span class="line"><span class="keyword">SELECT</span> col, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> col;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 事务操作</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="keyword">ROLLBACK</span>;</span><br><span class="line"><span class="keyword">SAVEPOINT</span> sp_name;</span><br><span class="line"><span class="keyword">ROLLBACK</span> <span class="keyword">TO</span> sp_name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 用户权限</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;user&#x27;</span>@<span class="string">&#x27;host&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;pwd&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> db.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;user&#x27;</span>@<span class="string">&#x27;host&#x27;</span>;</span><br><span class="line"><span class="keyword">REVOKE</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> db.<span class="operator">*</span> <span class="keyword">FROM</span> <span class="string">&#x27;user&#x27;</span>@<span class="string">&#x27;host&#x27;</span>;</span><br><span class="line"><span class="keyword">SHOW</span> GRANTS <span class="keyword">FOR</span> <span class="string">&#x27;user&#x27;</span>@<span class="string">&#x27;host&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="四、常用函数速查"><a href="#四、常用函数速查" class="headerlink" title="四、常用函数速查"></a>四、常用函数速查</h2><h3 id="4-1-字符串函数"><a href="#4-1-字符串函数" class="headerlink" title="4.1 字符串函数"></a>4.1 字符串函数</h3><table>
<thead>
<tr>
<th>函数</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>CONCAT(s1, s2, …)</td>
<td>连接字符串</td>
<td><code>CONCAT(&#39;Hello&#39;, &#39;World&#39;)</code></td>
</tr>
<tr>
<td>LENGTH(s)</td>
<td>字节长度</td>
<td><code>LENGTH(&#39;hello&#39;)</code></td>
</tr>
<tr>
<td>CHAR_LENGTH(s)</td>
<td>字符数</td>
<td><code>CHAR_LENGTH(&#39;你好&#39;)</code></td>
</tr>
<tr>
<td>UPPER(s)</td>
<td>转大写</td>
<td><code>UPPER(&#39;hello&#39;)</code></td>
</tr>
<tr>
<td>LOWER(s)</td>
<td>转小写</td>
<td><code>LOWER(&#39;HELLO&#39;)</code></td>
</tr>
<tr>
<td>SUBSTRING(s, pos, len)</td>
<td>截取字符串</td>
<td><code>SUBSTRING(&#39;hello&#39;, 1, 3)</code></td>
</tr>
<tr>
<td>REPLACE(s, from, to)</td>
<td>替换</td>
<td><code>REPLACE(&#39;hello&#39;, &#39;l&#39;, &#39;x&#39;)</code></td>
</tr>
<tr>
<td>TRIM(s)</td>
<td>去空格</td>
<td><code>TRIM(&#39; hello &#39;)</code></td>
</tr>
<tr>
<td>LPAD&#x2F;RPAD</td>
<td>左右填充</td>
<td><code>LPAD(&#39;123&#39;, 6, &#39;0&#39;)</code></td>
</tr>
</tbody></table>
<h3 id="4-2-数值函数"><a href="#4-2-数值函数" class="headerlink" title="4.2 数值函数"></a>4.2 数值函数</h3><table>
<thead>
<tr>
<th>函数</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>ABS(n)</td>
<td>绝对值</td>
<td><code>ABS(-10)</code></td>
</tr>
<tr>
<td>ROUND(n, d)</td>
<td>四舍五入</td>
<td><code>ROUND(3.14159, 2)</code></td>
</tr>
<tr>
<td>CEIL(n)</td>
<td>向上取整</td>
<td><code>CEIL(3.14)</code></td>
</tr>
<tr>
<td>FLOOR(n)</td>
<td>向下取整</td>
<td><code>FLOOR(3.99)</code></td>
</tr>
<tr>
<td>MOD(n, m)</td>
<td>取模</td>
<td><code>MOD(10, 3)</code></td>
</tr>
<tr>
<td>RAND()</td>
<td>随机数</td>
<td><code>RAND()</code></td>
</tr>
<tr>
<td>SQRT(n)</td>
<td>平方根</td>
<td><code>SQRT(16)</code></td>
</tr>
</tbody></table>
<h3 id="4-3-日期函数"><a href="#4-3-日期函数" class="headerlink" title="4.3 日期函数"></a>4.3 日期函数</h3><table>
<thead>
<tr>
<th>函数</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>NOW()</td>
<td>当前日期时间</td>
<td><code>NOW()</code></td>
</tr>
<tr>
<td>CURDATE()</td>
<td>当前日期</td>
<td><code>CURDATE()</code></td>
</tr>
<tr>
<td>YEAR(d)</td>
<td>年份</td>
<td><code>YEAR(NOW())</code></td>
</tr>
<tr>
<td>MONTH(d)</td>
<td>月份</td>
<td><code>MONTH(NOW())</code></td>
</tr>
<tr>
<td>DAY(d)</td>
<td>日期</td>
<td><code>DAY(NOW())</code></td>
</tr>
<tr>
<td>DATE_FORMAT(d, fmt)</td>
<td>格式化</td>
<td><code>DATE_FORMAT(NOW(), &#39;%Y-%m-%d&#39;)</code></td>
</tr>
<tr>
<td>DATE_ADD(d, INTERVAL n UNIT)</td>
<td>日期增加</td>
<td><code>DATE_ADD(NOW(), INTERVAL 1 DAY)</code></td>
</tr>
<tr>
<td>DATEDIFF(d1, d2)</td>
<td>日期差</td>
<td><code>DATEDIFF(d1, d2)</code></td>
</tr>
</tbody></table>
<h3 id="4-4-流程函数"><a href="#4-4-流程函数" class="headerlink" title="4.4 流程函数"></a>4.4 流程函数</h3><table>
<thead>
<tr>
<th>函数</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>IF(expr, v1, v2)</td>
<td>条件判断</td>
<td><code>IF(1&gt;2, &#39;Y&#39;, &#39;N&#39;)</code></td>
</tr>
<tr>
<td>IFNULL(v1, v2)</td>
<td>NULL 处理</td>
<td><code>IFNULL(val, 0)</code></td>
</tr>
<tr>
<td>NULLIF(v1, v2)</td>
<td>相等返回 NULL</td>
<td><code>NULLIF(a, 0)</code></td>
</tr>
<tr>
<td>CASE WHEN … THEN … END</td>
<td>条件表达式</td>
<td><code>CASE WHEN x&gt;0 THEN &#39;正&#39; ELSE &#39;非正&#39; END</code></td>
</tr>
</tbody></table>
<h2 id="五、常见场景-SQL-模板"><a href="#五、常见场景-SQL-模板" class="headerlink" title="五、常见场景 SQL 模板"></a>五、常见场景 SQL 模板</h2><h3 id="5-1-分页查询"><a href="#5-1-分页查询" class="headerlink" title="5.1 分页查询"></a>5.1 分页查询</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 第 n 页，每页 size 条</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> id</span><br><span class="line">LIMIT (n<span class="number">-1</span>)<span class="operator">*</span>size, size;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-分组统计"><a href="#5-2-分组统计" class="headerlink" title="5.2 分组统计"></a>5.2 分组统计</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 按部门统计人数和平均工资</span></span><br><span class="line"><span class="keyword">SELECT</span> dept_id,</span><br><span class="line">       <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> emp_count,</span><br><span class="line">       <span class="built_in">AVG</span>(salary) <span class="keyword">AS</span> avg_salary</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> dept_id</span><br><span class="line"><span class="keyword">HAVING</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="operator">&gt;</span> <span class="number">5</span>;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-排名查询"><a href="#5-3-排名查询" class="headerlink" title="5.3 排名查询"></a>5.3 排名查询</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 按工资降序排名</span></span><br><span class="line"><span class="keyword">SELECT</span> name, salary,</span><br><span class="line">       <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span> (<span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>) <span class="keyword">AS</span> rank</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- MySQL 8.0 之前使用变量</span></span><br><span class="line"><span class="keyword">SELECT</span> name, salary,</span><br><span class="line">       <span class="variable">@rank</span> :<span class="operator">=</span> <span class="variable">@rank</span> <span class="operator">+</span> <span class="number">1</span> <span class="keyword">AS</span> rank</span><br><span class="line"><span class="keyword">FROM</span> employees, (<span class="keyword">SELECT</span> <span class="variable">@rank</span> :<span class="operator">=</span> <span class="number">0</span>) r</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h3 id="5-4-去重查询"><a href="#5-4-去重查询" class="headerlink" title="5.4 去重查询"></a>5.4 去重查询</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 删除重复记录，保留 ID 最小的</span></span><br><span class="line"><span class="keyword">DELETE</span> t1 <span class="keyword">FROM</span> <span class="keyword">table</span> t1</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> <span class="keyword">table</span> t2</span><br><span class="line"><span class="keyword">WHERE</span> t1.id <span class="operator">&gt;</span> t2.id <span class="keyword">AND</span> t1.name <span class="operator">=</span> t2.name;</span><br></pre></td></tr></table></figure>

<h3 id="5-5-行列转换"><a href="#5-5-行列转换" class="headerlink" title="5.5 行列转换"></a>5.5 行列转换</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 行转列（使用 CASE）</span></span><br><span class="line"><span class="keyword">SELECT</span> name,</span><br><span class="line">       <span class="built_in">MAX</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> subject <span class="operator">=</span> <span class="string">&#x27;数学&#x27;</span> <span class="keyword">THEN</span> score <span class="keyword">END</span>) <span class="keyword">AS</span> 数学，</span><br><span class="line">       <span class="built_in">MAX</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> subject <span class="operator">=</span> <span class="string">&#x27;语文&#x27;</span> <span class="keyword">THEN</span> score <span class="keyword">END</span>) <span class="keyword">AS</span> 语文，</span><br><span class="line">       <span class="built_in">MAX</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> subject <span class="operator">=</span> <span class="string">&#x27;英语&#x27;</span> <span class="keyword">THEN</span> score <span class="keyword">END</span>) <span class="keyword">AS</span> 英语</span><br><span class="line"><span class="keyword">FROM</span> scores</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> name;</span><br></pre></td></tr></table></figure>

<h3 id="5-6-连续日期查询"><a href="#5-6-连续日期查询" class="headerlink" title="5.6 连续日期查询"></a>5.6 连续日期查询</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询连续登录 3 天以上的用户</span></span><br><span class="line"><span class="keyword">SELECT</span> user_id, <span class="built_in">MIN</span>(<span class="type">date</span>) <span class="keyword">AS</span> start_date, <span class="built_in">MAX</span>(<span class="type">date</span>) <span class="keyword">AS</span> end_date, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> days</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> user_id, <span class="type">date</span>,</span><br><span class="line">           DATE_SUB(<span class="type">date</span>, <span class="type">INTERVAL</span> <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> user_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="type">date</span>) <span class="keyword">DAY</span>) <span class="keyword">AS</span> grp</span><br><span class="line">    <span class="keyword">FROM</span> logins</span><br><span class="line">) t</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id, grp</span><br><span class="line"><span class="keyword">HAVING</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="operator">&gt;=</span> <span class="number">3</span>;</span><br></pre></td></tr></table></figure>

<h2 id="六、性能优化建议"><a href="#六、性能优化建议" class="headerlink" title="六、性能优化建议"></a>六、性能优化建议</h2><h3 id="6-1-索引优化"><a href="#6-1-索引优化" class="headerlink" title="6.1 索引优化"></a>6.1 索引优化</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_name <span class="keyword">ON</span> <span class="keyword">table</span>(<span class="keyword">column</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 联合索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_dept_salary <span class="keyword">ON</span> employees(dept_id, salary);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看索引</span></span><br><span class="line"><span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> table_name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 分析查询</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><strong>索引使用原则</strong>：</p>
<ol>
<li>在 WHERE 和 JOIN 的列上创建索引</li>
<li>使用联合索引时注意最左前缀原则</li>
<li>避免在索引列上使用函数</li>
<li>避免 SELECT *</li>
</ol>
<h3 id="6-2-查询优化"><a href="#6-2-查询优化" class="headerlink" title="6.2 查询优化"></a>6.2 查询优化</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 优化前：全表扫描</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> <span class="keyword">YEAR</span>(hire_date) <span class="operator">=</span> <span class="number">2024</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 优化后：使用索引</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> hire_date <span class="operator">&gt;=</span> <span class="string">&#x27;2024-01-01&#x27;</span></span><br><span class="line"><span class="keyword">AND</span> hire_date <span class="operator">&lt;</span> <span class="string">&#x27;2025-01-01&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 优化前：OR 条件可能不使用索引</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">OR</span> dept_id <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 优化后：使用 UNION</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-表结构优化"><a href="#6-3-表结构优化" class="headerlink" title="6.3 表结构优化"></a>6.3 表结构优化</h3><ol>
<li><p><strong>选择合适的数据类型</strong></p>
<ul>
<li>能用 TINYINT 就不用 INT</li>
<li>金额使用 DECIMAL</li>
<li>字符串长度合理</li>
</ul>
</li>
<li><p><strong>范式与反范式</strong></p>
<ul>
<li>遵循三大范式减少冗余</li>
<li>适当冗余提高查询性能</li>
</ul>
</li>
<li><p><strong>分区表</strong></p>
<ul>
<li>大表按时间或范围分区</li>
<li>提高查询和管理效率</li>
</ul>
</li>
</ol>
<h2 id="七、学习路线建议"><a href="#七、学习路线建议" class="headerlink" title="七、学习路线建议"></a>七、学习路线建议</h2><h3 id="7-1-入门阶段（已完成）"><a href="#7-1-入门阶段（已完成）" class="headerlink" title="7.1 入门阶段（已完成）"></a>7.1 入门阶段（已完成）</h3><ul>
<li><input checked="" disabled="" type="checkbox"> 数据库基础概念</li>
<li><input checked="" disabled="" type="checkbox"> MySQL 安装配置</li>
<li><input checked="" disabled="" type="checkbox"> 基本 SQL 语法（DDL、DML、DQL、DCL）</li>
<li><input checked="" disabled="" type="checkbox"> 常用函数</li>
<li><input checked="" disabled="" type="checkbox"> 约束和多表查询</li>
<li><input checked="" disabled="" type="checkbox"> 事务基础</li>
</ul>
<h3 id="7-2-进阶阶段"><a href="#7-2-进阶阶段" class="headerlink" title="7.2 进阶阶段"></a>7.2 进阶阶段</h3><ul>
<li><input disabled="" type="checkbox"> 索引原理与优化</li>
<li><input disabled="" type="checkbox"> 执行计划分析（EXPLAIN）</li>
<li><input disabled="" type="checkbox"> 锁机制深入</li>
<li><input disabled="" type="checkbox"> 存储引擎（InnoDB vs MyISAM）</li>
<li><input disabled="" type="checkbox"> 日志系统（redo log、undo log、binlog）</li>
<li><input disabled="" type="checkbox"> 主从复制</li>
<li><input disabled="" type="checkbox"> 备份恢复</li>
</ul>
<h3 id="7-3-高级阶段"><a href="#7-3-高级阶段" class="headerlink" title="7.3 高级阶段"></a>7.3 高级阶段</h3><ul>
<li><input disabled="" type="checkbox"> 性能调优</li>
<li><input disabled="" type="checkbox"> 分库分表</li>
<li><input disabled="" type="checkbox"> 读写分离</li>
<li><input disabled="" type="checkbox"> 高可用架构</li>
<li><input disabled="" type="checkbox"> MySQL 8.0 新特性</li>
<li><input disabled="" type="checkbox"> 与其他数据库对比（PostgreSQL、MongoDB）</li>
</ul>
<h3 id="7-4-实战建议"><a href="#7-4-实战建议" class="headerlink" title="7.4 实战建议"></a>7.4 实战建议</h3><ol>
<li><strong>搭建个人博客&#x2F;项目</strong>：实践数据库设计</li>
<li><strong>LeetCode 刷题</strong>：练习 SQL 查询</li>
<li><strong>阅读优秀项目</strong>：学习实际数据库设计</li>
<li><strong>性能测试</strong>：了解不同查询的性能差异</li>
<li><strong>参与开源</strong>：贡献或学习数据库相关项目</li>
</ol>
<h2 id="八、常见问题-FAQ"><a href="#八、常见问题-FAQ" class="headerlink" title="八、常见问题 FAQ"></a>八、常见问题 FAQ</h2><h3 id="Q1-COUNT-、COUNT-1-、COUNT-列-的区别？"><a href="#Q1-COUNT-、COUNT-1-、COUNT-列-的区别？" class="headerlink" title="Q1: COUNT(*)、COUNT(1)、COUNT(列) 的区别？"></a>Q1: COUNT(*)、COUNT(1)、COUNT(列) 的区别？</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="built_in">COUNT</span>(<span class="operator">*</span>)   <span class="comment">-- 统计所有行（包括 NULL），推荐</span></span><br><span class="line"><span class="built_in">COUNT</span>(<span class="number">1</span>)   <span class="comment">-- 同 COUNT(*)</span></span><br><span class="line"><span class="built_in">COUNT</span>(col) <span class="comment">-- 只统计非 NULL 的行</span></span><br></pre></td></tr></table></figure>

<h3 id="Q2-DELETE、TRUNCATE、DROP-的区别？"><a href="#Q2-DELETE、TRUNCATE、DROP-的区别？" class="headerlink" title="Q2: DELETE、TRUNCATE、DROP 的区别？"></a>Q2: DELETE、TRUNCATE、DROP 的区别？</h3><table>
<thead>
<tr>
<th>命令</th>
<th>类型</th>
<th>作用</th>
<th>可回滚</th>
</tr>
</thead>
<tbody><tr>
<td>DELETE</td>
<td>DML</td>
<td>删除符合条件的行</td>
<td>是</td>
</tr>
<tr>
<td>TRUNCATE</td>
<td>DDL</td>
<td>清空整张表</td>
<td>否</td>
</tr>
<tr>
<td>DROP</td>
<td>DDL</td>
<td>删除整个表</td>
<td>否</td>
</tr>
</tbody></table>
<h3 id="Q3-WHERE-和-HAVING-的区别？"><a href="#Q3-WHERE-和-HAVING-的区别？" class="headerlink" title="Q3: WHERE 和 HAVING 的区别？"></a>Q3: WHERE 和 HAVING 的区别？</h3><ul>
<li>WHERE：在分组前过滤，不能使用聚合函数</li>
<li>HAVING：在分组后过滤，可以使用聚合函数</li>
</ul>
<h3 id="Q4-INNER-JOIN-和-LEFT-JOIN-的选择？"><a href="#Q4-INNER-JOIN-和-LEFT-JOIN-的选择？" class="headerlink" title="Q4: INNER JOIN 和 LEFT JOIN 的选择？"></a>Q4: INNER JOIN 和 LEFT JOIN 的选择？</h3><ul>
<li>只返回匹配记录：INNER JOIN</li>
<li>需要保留左表全部记录：LEFT JOIN</li>
</ul>
<h3 id="Q5-如何避免-SQL-注入？"><a href="#Q5-如何避免-SQL-注入？" class="headerlink" title="Q5: 如何避免 SQL 注入？"></a>Q5: 如何避免 SQL 注入？</h3><ol>
<li>使用预编译语句（Prepare Statement）</li>
<li>使用 ORM 框架</li>
<li>验证用户输入</li>
<li>最小权限原则</li>
</ol>
<h2 id="九、推荐资源"><a href="#九、推荐资源" class="headerlink" title="九、推荐资源"></a>九、推荐资源</h2><h3 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h3><ul>
<li><a href="https://dev.mysql.com/doc/">MySQL 官方文档</a></li>
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/tutorial.html">MySQL 教程</a></li>
</ul>
<h3 id="在线练习"><a href="#在线练习" class="headerlink" title="在线练习"></a>在线练习</h3><ul>
<li><a href="https://leetcode.com/problemset/database/">LeetCode 数据库题</a></li>
<li>[牛客网 SQL 练习](<a href="https://www.nowcoder.com/exam/oj?tab=SQL">https://www.nowcoder.com/exam/oj?tab=SQL</a> 篇)</li>
<li><a href="https://sqlzoo.net/">SQLZOO</a></li>
</ul>
<h3 id="书籍推荐"><a href="#书籍推荐" class="headerlink" title="书籍推荐"></a>书籍推荐</h3><ul>
<li>《MySQL 必知必会》- 入门经典</li>
<li>《高性能 MySQL》- 进阶必读</li>
<li>《MySQL 技术内幕：InnoDB 存储引擎》- 深入理解</li>
</ul>
<h2 id="十、结语"><a href="#十、结语" class="headerlink" title="十、结语"></a>十、结语</h2><p>恭喜完成 MySQL 基础篇和进阶教程的学习！</p>
<p><strong>学习建议</strong>：</p>
<ol>
<li>理论结合实践，多动手写 SQL</li>
<li>理解原理，不只是死记语法</li>
<li>关注性能，养成写高效 SQL 的习惯</li>
<li>持续学习，数据库技术不断更新</li>
</ol>
<p><strong>下一步</strong>：</p>
<ul>
<li>开始进阶阶段的学习</li>
<li>在项目中实践所学知识</li>
<li>深入学习 InnoDB 存储引擎</li>
<li>了解数据库性能优化</li>
</ul>
<p>祝你在数据库学习的道路上越走越远！</p>
<hr>
<p><strong>上一篇</strong>：[MySQL 进阶教程 15-01 MySQL 管理](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 15-01 MySQL 管理&#x2F;)</p>
<p><strong>基础教程系列</strong>：</p>
<ul>
<li>[（一）数据库基础与环境搭建](&#x2F;2026&#x2F;02&#x2F;23&#x2F;MySQL 基础教程（一）数据库基础与环境搭建&#x2F;)</li>
<li>[（二）DDL 数据定义语言详解](&#x2F;2026&#x2F;02&#x2F;23&#x2F;MySQL 基础教程（二）DDL 数据定义语言详解&#x2F;)</li>
<li>[（三）DML 数据操作语言详解](&#x2F;2026&#x2F;02&#x2F;23&#x2F;MySQL 基础教程（三）DML 数据操作语言详解&#x2F;)</li>
<li>[（四）DQL 数据查询语言详解](&#x2F;2026&#x2F;02&#x2F;23&#x2F;MySQL 基础教程（四）DQL 数据查询语言详解（上）&#x2F;)</li>
<li>[（五）DCL 数据控制语言详解](&#x2F;2026&#x2F;02&#x2F;23&#x2F;MySQL 基础教程（五）DCL 数据控制语言详解&#x2F;)</li>
</ul>
<p><strong>进阶教程系列</strong>：</p>
<ul>
<li>[01-01 常用函数详解](&#x2F;2026&#x2F;02&#x2F;23&#x2F;MySQL 进阶教程 01-01 常用函数详解&#x2F;)</li>
<li>[02-01 数据库约束详解](&#x2F;2026&#x2F;02&#x2F;23&#x2F;MySQL 进阶教程 02-01 数据库约束详解&#x2F;)</li>
<li>[03-01 多表查询详解](&#x2F;2026&#x2F;02&#x2F;23&#x2F;MySQL 进阶教程 03-01 多表查询详解&#x2F;)</li>
<li>[04-01 窗口函数概述](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 04-01 窗口函数概述&#x2F;)</li>
<li>[05-01 事务详解](&#x2F;2026&#x2F;02&#x2F;23&#x2F;MySQL 进阶教程 05-01 事务详解&#x2F;)</li>
</ul>
]]></content>
      <categories>
        <category>MySQL 进阶教程</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>总结</tag>
        <tag>学习路线</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 进阶教程 14-01 触发器详解</title>
    <url>/2026/02/24/MySQL%20%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B%2014-01%20%E8%A7%A6%E5%8F%91%E5%99%A8%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<h1 id="MySQL-进阶教程-14-01-触发器详解"><a href="#MySQL-进阶教程-14-01-触发器详解" class="headerlink" title="MySQL 进阶教程 14-01 触发器详解"></a>MySQL 进阶教程 14-01 触发器详解</h1><p>触发器是在特定事件（INSERT、UPDATE、DELETE）发生时自动执行的存储程序。本文将详细介绍触发器的概念、语法、应用场景和注意事项。</p>
<h2 id="一、触发器介绍"><a href="#一、触发器介绍" class="headerlink" title="一、触发器介绍"></a>一、触发器介绍</h2><h3 id="1-1-什么是触发器？"><a href="#1-1-什么是触发器？" class="headerlink" title="1.1 什么是触发器？"></a>1.1 什么是触发器？</h3><p><strong>触发器（Trigger）</strong> 是与表关联的特殊存储过程，当表中发生 INSERT、UPDATE 或 DELETE 事件时自动执行。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">触发器要素：</span><br><span class="line">├── 触发时机：BEFORE 或 AFTER</span><br><span class="line">├── 触发事件：INSERT、UPDATE、DELETE</span><br><span class="line">├── 触发对象：某张表</span><br><span class="line">└── 触发器体：要执行的 SQL 语句</span><br></pre></td></tr></table></figure>

<h3 id="1-2-触发器作用"><a href="#1-2-触发器作用" class="headerlink" title="1.2 触发器作用"></a>1.2 触发器作用</h3><table>
<thead>
<tr>
<th>作用</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>数据验证</td>
<td>检查数据有效性</td>
</tr>
<tr>
<td>自动计算</td>
<td>自动更新相关字段</td>
</tr>
<tr>
<td>审计追踪</td>
<td>记录数据变更历史</td>
</tr>
<tr>
<td>级联操作</td>
<td>自动维护相关表</td>
</tr>
</tbody></table>
<h3 id="1-3-触发器限制"><a href="#1-3-触发器限制" class="headerlink" title="1.3 触发器限制"></a>1.3 触发器限制</h3><ul>
<li>每个表每个事件每种时机只能有一个触发器</li>
<li>触发器不能调用存储过程（某些版本限制）</li>
<li>触发器不能有输入输出参数</li>
<li>触发器不能使用 COMMIT&#x2F;ROLLBACK</li>
</ul>
<h2 id="二、CREATE-TRIGGER-语法"><a href="#二、CREATE-TRIGGER-语法" class="headerlink" title="二、CREATE TRIGGER 语法"></a>二、CREATE TRIGGER 语法</h2><h3 id="2-1-基本语法"><a href="#2-1-基本语法" class="headerlink" title="2.1 基本语法"></a>2.1 基本语法</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trigger_name</span><br><span class="line">&#123;BEFORE <span class="operator">|</span> AFTER&#125; &#123;<span class="keyword">INSERT</span> <span class="operator">|</span> <span class="keyword">UPDATE</span> <span class="operator">|</span> <span class="keyword">DELETE</span>&#125;</span><br><span class="line"><span class="keyword">ON</span> table_name</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="comment">-- 触发器体</span></span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-触发器时机"><a href="#2-2-触发器时机" class="headerlink" title="2.2 触发器时机"></a>2.2 触发器时机</h3><table>
<thead>
<tr>
<th>时机</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>BEFORE</td>
<td>在操作执行之前触发</td>
</tr>
<tr>
<td>AFTER</td>
<td>在操作执行之后触发</td>
</tr>
</tbody></table>
<h3 id="2-3-NEW-和-OLD-关键字"><a href="#2-3-NEW-和-OLD-关键字" class="headerlink" title="2.3 NEW 和 OLD 关键字"></a>2.3 NEW 和 OLD 关键字</h3><table>
<thead>
<tr>
<th>关键字</th>
<th>INSERT</th>
<th>UPDATE</th>
<th>DELETE</th>
</tr>
</thead>
<tbody><tr>
<td>NEW</td>
<td>新插入的值</td>
<td>新值</td>
<td>无</td>
</tr>
<tr>
<td>OLD</td>
<td>无</td>
<td>旧值</td>
<td>删除的值</td>
</tr>
</tbody></table>
<h2 id="三、INSERT-类型案例"><a href="#三、INSERT-类型案例" class="headerlink" title="三、INSERT 类型案例"></a>三、INSERT 类型案例</h2><h3 id="3-1-自动创建时间"><a href="#3-1-自动创建时间" class="headerlink" title="3.1 自动创建时间"></a>3.1 自动创建时间</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 表结构</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> articles (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    title <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    content TEXT,</span><br><span class="line">    created_at DATETIME</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 触发器：自动设置创建时间</span></span><br><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trg_articles_before_insert</span><br><span class="line">BEFORE <span class="keyword">INSERT</span> <span class="keyword">ON</span> articles</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    IF NEW.created_at <span class="keyword">IS</span> <span class="keyword">NULL</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">SET</span> NEW.created_at <span class="operator">=</span> NOW();</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 测试</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> articles (title, content) <span class="keyword">VALUES</span> (<span class="string">&#x27;标题&#x27;</span>, <span class="string">&#x27;内容&#x27;</span>);</span><br><span class="line"><span class="comment">-- created_at 自动设置为当前时间</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-数据验证"><a href="#3-2-数据验证" class="headerlink" title="3.2 数据验证"></a>3.2 数据验证</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 触发器：验证工资范围</span></span><br><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trg_emp_salary_check</span><br><span class="line">BEFORE <span class="keyword">INSERT</span> <span class="keyword">ON</span> employees</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    IF NEW.salary <span class="operator">&lt;</span> <span class="number">0</span> <span class="keyword">THEN</span></span><br><span class="line">        SIGNAL <span class="keyword">SQLSTATE</span> <span class="string">&#x27;45000&#x27;</span></span><br><span class="line">        <span class="keyword">SET</span> MESSAGE_TEXT <span class="operator">=</span> <span class="string">&#x27;工资不能为负数&#x27;</span>;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line"></span><br><span class="line">    IF NEW.salary <span class="operator">&gt;</span> <span class="number">100000</span> <span class="keyword">THEN</span></span><br><span class="line">        SIGNAL <span class="keyword">SQLSTATE</span> <span class="string">&#x27;45000&#x27;</span></span><br><span class="line">        <span class="keyword">SET</span> MESSAGE_TEXT <span class="operator">=</span> <span class="string">&#x27;工资不能超过 100000&#x27;</span>;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-级联插入"><a href="#3-3-级联插入" class="headerlink" title="3.3 级联插入"></a>3.3 级联插入</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 员工表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> employees (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    dept_id <span class="type">INT</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 员工日志表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> emp_log (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    emp_id <span class="type">INT</span>,</span><br><span class="line">    action <span class="type">VARCHAR</span>(<span class="number">20</span>),</span><br><span class="line">    action_time DATETIME</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 触发器：插入员工时自动记录日志</span></span><br><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trg_emp_after_insert</span><br><span class="line">AFTER <span class="keyword">INSERT</span> <span class="keyword">ON</span> employees</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">INSERT INTO</span> emp_log (emp_id, action, action_time)</span><br><span class="line">    <span class="keyword">VALUES</span> (NEW.id, <span class="string">&#x27;INSERT&#x27;</span>, NOW());</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<h2 id="四、UPDATE-类型案例"><a href="#四、UPDATE-类型案例" class="headerlink" title="四、UPDATE 类型案例"></a>四、UPDATE 类型案例</h2><h3 id="4-1-自动更新时间"><a href="#4-1-自动更新时间" class="headerlink" title="4.1 自动更新时间"></a>4.1 自动更新时间</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 表结构</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> products (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    price <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),</span><br><span class="line">    updated_at DATETIME</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 触发器：更新时自动更新时间</span></span><br><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trg_products_before_update</span><br><span class="line">BEFORE <span class="keyword">UPDATE</span> <span class="keyword">ON</span> products</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">SET</span> NEW.updated_at <span class="operator">=</span> NOW();</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-数据变更追踪"><a href="#4-2-数据变更追踪" class="headerlink" title="4.2 数据变更追踪"></a>4.2 数据变更追踪</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 工资变更日志表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> salary_log (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    emp_id <span class="type">INT</span>,</span><br><span class="line">    old_salary <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),</span><br><span class="line">    new_salary <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),</span><br><span class="line">    change_time DATETIME</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 触发器：记录工资变更</span></span><br><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trg_emp_salary_log</span><br><span class="line">AFTER <span class="keyword">UPDATE</span> <span class="keyword">ON</span> employees</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    IF OLD.salary <span class="operator">!=</span> NEW.salary <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">INSERT INTO</span> salary_log (emp_id, old_salary, new_salary, change_time)</span><br><span class="line">        <span class="keyword">VALUES</span> (NEW.id, OLD.salary, NEW.salary, NOW());</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-库存扣减"><a href="#4-3-库存扣减" class="headerlink" title="4.3 库存扣减"></a>4.3 库存扣减</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 商品表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> products (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    stock <span class="type">INT</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 订单表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    product_id <span class="type">INT</span>,</span><br><span class="line">    quantity <span class="type">INT</span>,</span><br><span class="line">    status <span class="type">VARCHAR</span>(<span class="number">20</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 触发器：订单确认后扣减库存</span></span><br><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trg_order_confirm</span><br><span class="line">AFTER <span class="keyword">UPDATE</span> <span class="keyword">ON</span> orders</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    IF OLD.status <span class="operator">=</span> <span class="string">&#x27;PENDING&#x27;</span> <span class="keyword">AND</span> NEW.status <span class="operator">=</span> <span class="string">&#x27;CONFIRMED&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">UPDATE</span> products <span class="keyword">SET</span> stock <span class="operator">=</span> stock <span class="operator">-</span> NEW.quantity</span><br><span class="line">        <span class="keyword">WHERE</span> id <span class="operator">=</span> NEW.product_id;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<h2 id="五、DELETE-类型案例"><a href="#五、DELETE-类型案例" class="headerlink" title="五、DELETE 类型案例"></a>五、DELETE 类型案例</h2><h3 id="5-1-软删除"><a href="#5-1-软删除" class="headerlink" title="5.1 软删除"></a>5.1 软删除</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 表结构（添加 deleted 字段）</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    deleted TINYINT <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    deleted_at DATETIME</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 触发器：将物理删除转为软删除</span></span><br><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trg_users_before_delete</span><br><span class="line">BEFORE <span class="keyword">DELETE</span> <span class="keyword">ON</span> users</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="comment">-- 不真正删除，而是标记为已删除</span></span><br><span class="line">    <span class="keyword">SET</span> OLD.deleted <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">SET</span> OLD.deleted_at <span class="operator">=</span> NOW();</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 阻止实际删除（需要配合其他机制）</span></span><br><span class="line">    <span class="comment">-- 注意：MySQL 触发器不能直接阻止删除</span></span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 更好的方式是使用 BEFORE DELETE 记录日志，然后手动处理</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-删除日志"><a href="#5-2-删除日志" class="headerlink" title="5.2 删除日志"></a>5.2 删除日志</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 用户删除日志表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> user_delete_log (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    user_id <span class="type">INT</span>,</span><br><span class="line">    user_name <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    delete_time DATETIME</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 触发器：记录删除操作</span></span><br><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trg_users_after_delete</span><br><span class="line">AFTER <span class="keyword">DELETE</span> <span class="keyword">ON</span> users</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">INSERT INTO</span> user_delete_log (user_id, user_name, delete_time)</span><br><span class="line">    <span class="keyword">VALUES</span> (OLD.id, OLD.name, NOW());</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-级联删除"><a href="#5-3-级联删除" class="headerlink" title="5.3 级联删除"></a>5.3 级联删除</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 部门表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> departments (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    dept_name <span class="type">VARCHAR</span>(<span class="number">50</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 员工表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> employees (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    dept_id <span class="type">INT</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 触发器：删除部门时自动删除员工</span></span><br><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trg_dept_after_delete</span><br><span class="line">AFTER <span class="keyword">DELETE</span> <span class="keyword">ON</span> departments</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DELETE</span> <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> dept_id <span class="operator">=</span> OLD.id;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 注意：实际应用中建议使用外键的 ON DELETE CASCADE</span></span><br></pre></td></tr></table></figure>

<h2 id="六、触发器应用场景"><a href="#六、触发器应用场景" class="headerlink" title="六、触发器应用场景"></a>六、触发器应用场景</h2><h3 id="6-1-数据审计"><a href="#6-1-数据审计" class="headerlink" title="6.1 数据审计"></a>6.1 数据审计</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 审计日志表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> audit_log (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    table_name <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    record_id <span class="type">INT</span>,</span><br><span class="line">    action <span class="type">VARCHAR</span>(<span class="number">20</span>),</span><br><span class="line">    old_data JSON,</span><br><span class="line">    new_data JSON,</span><br><span class="line">    change_time DATETIME</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 通用审计触发器</span></span><br><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trg_emp_audit</span><br><span class="line">AFTER <span class="keyword">UPDATE</span> <span class="keyword">ON</span> employees</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">INSERT INTO</span> audit_log (table_name, record_id, action, old_data, new_data, change_time)</span><br><span class="line">    <span class="keyword">VALUES</span> (</span><br><span class="line">        <span class="string">&#x27;employees&#x27;</span>,</span><br><span class="line">        NEW.id,</span><br><span class="line">        <span class="string">&#x27;UPDATE&#x27;</span>,</span><br><span class="line">        <span class="built_in">JSON_OBJECT</span>(<span class="string">&#x27;name&#x27;</span>, OLD.name, <span class="string">&#x27;salary&#x27;</span>, OLD.salary),</span><br><span class="line">        <span class="built_in">JSON_OBJECT</span>(<span class="string">&#x27;name&#x27;</span>, NEW.name, <span class="string">&#x27;salary&#x27;</span>, NEW.salary),</span><br><span class="line">        NOW()</span><br><span class="line">    );</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-数据同步"><a href="#6-2-数据同步" class="headerlink" title="6.2 数据同步"></a>6.2 数据同步</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 主表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">100</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 缓存表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users_cache (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    updated_at DATETIME</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 触发器：同步数据到缓存表</span></span><br><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trg_users_after_insert</span><br><span class="line">AFTER <span class="keyword">INSERT</span> <span class="keyword">ON</span> users</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">INSERT INTO</span> users_cache (id, name, updated_at)</span><br><span class="line">    <span class="keyword">VALUES</span> (NEW.id, NEW.name, NOW());</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-复杂约束"><a href="#6-3-复杂约束" class="headerlink" title="6.3 复杂约束"></a>6.3 复杂约束</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 触发器：确保订单金额等于商品单价×数量</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> order_items (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    order_id <span class="type">INT</span>,</span><br><span class="line">    product_id <span class="type">INT</span>,</span><br><span class="line">    price <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),</span><br><span class="line">    quantity <span class="type">INT</span>,</span><br><span class="line">    total <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trg_order_item_before_insert</span><br><span class="line">BEFORE <span class="keyword">INSERT</span> <span class="keyword">ON</span> order_items</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">SET</span> NEW.total <span class="operator">=</span> NEW.price <span class="operator">*</span> NEW.quantity;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<h2 id="七、触发器管理"><a href="#七、触发器管理" class="headerlink" title="七、触发器管理"></a>七、触发器管理</h2><h3 id="7-1-查看触发器"><a href="#7-1-查看触发器" class="headerlink" title="7.1 查看触发器"></a>7.1 查看触发器</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看所有触发器</span></span><br><span class="line"><span class="keyword">SHOW</span> TRIGGERS;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看特定数据库的触发器</span></span><br><span class="line"><span class="keyword">SHOW</span> TRIGGERS <span class="keyword">FROM</span> database_name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看触发器创建语句</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trigger_name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 从 information_schema 查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.triggers</span><br><span class="line"><span class="keyword">WHERE</span> trigger_schema <span class="operator">=</span> <span class="string">&#x27;your_db&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="7-2-删除触发器"><a href="#7-2-删除触发器" class="headerlink" title="7.2 删除触发器"></a>7.2 删除触发器</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 删除触发器</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> IF <span class="keyword">EXISTS</span> trigger_name;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除特定数据库的触发器</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> IF <span class="keyword">EXISTS</span> database_name.trigger_name;</span><br></pre></td></tr></table></figure>

<h3 id="7-3-触发器最佳实践"><a href="#7-3-触发器最佳实践" class="headerlink" title="7.3 触发器最佳实践"></a>7.3 触发器最佳实践</h3><ol>
<li><strong>保持触发器简短</strong>：避免复杂逻辑</li>
<li><strong>避免递归触发</strong>：可能导致无限循环</li>
<li><strong>注意性能影响</strong>：触发器会增加操作开销</li>
<li><strong>明确文档化</strong>：记录触发器的作用和逻辑</li>
<li><strong>谨慎使用</strong>：能用外键解决的不用触发器</li>
</ol>
<h2 id="八、小结"><a href="#八、小结" class="headerlink" title="八、小结"></a>八、小结</h2><h3 id="核心知识点"><a href="#核心知识点" class="headerlink" title="核心知识点"></a>核心知识点</h3><ol>
<li><strong>触发器类型</strong>：BEFORE&#x2F;AFTER + INSERT&#x2F;UPDATE&#x2F;DELETE</li>
<li><strong>NEW 和 OLD</strong>：访问新值和旧值</li>
<li><strong>应用场景</strong>：审计、同步、约束、级联操作</li>
<li><strong>注意事项</strong>：保持简短、避免递归、注意性能</li>
</ol>
<h3 id="触发器对比"><a href="#触发器对比" class="headerlink" title="触发器对比"></a>触发器对比</h3><table>
<thead>
<tr>
<th>时机</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td>BEFORE INSERT</td>
<td>数据验证、默认值</td>
</tr>
<tr>
<td>AFTER INSERT</td>
<td>日志记录、级联插入</td>
</tr>
<tr>
<td>BEFORE UPDATE</td>
<td>数据验证、计算字段</td>
</tr>
<tr>
<td>AFTER UPDATE</td>
<td>日志记录、数据同步</td>
</tr>
<tr>
<td>AFTER DELETE</td>
<td>日志记录、级联删除</td>
</tr>
</tbody></table>
<h3 id="进阶篇完结"><a href="#进阶篇完结" class="headerlink" title="进阶篇完结"></a>进阶篇完结</h3><p>恭喜完成 MySQL 进阶教程的学习！</p>
<p>下一篇文章将是<strong>MySQL 管理</strong>，包括：</p>
<ul>
<li>系统数据库介绍</li>
<li>常用管理工具</li>
<li>进阶篇总结</li>
</ul>
<hr>
<p><strong>下一篇</strong>：[MySQL 进阶教程 15-01 MySQL 管理](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 15-01 MySQL 管理&#x2F;)</p>
<p><strong>上一篇</strong>：[MySQL 进阶教程 13-01 存储过程与函数](&#x2F;2026&#x2F;02&#x2F;24&#x2F;MySQL 进阶教程 13-01 存储过程与函数&#x2F;)</p>
]]></content>
      <categories>
        <category>MySQL 进阶教程</category>
      </categories>
      <tags>
        <tag>自动化</tag>
        <tag>MySQL</tag>
        <tag>触发器</tag>
        <tag>数据完整性</tag>
      </tags>
  </entry>
  <entry>
    <title>Python 基础教程（三）异常处理</title>
    <url>/2026/02/24/Python%20%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B%EF%BC%88%E4%B8%89%EF%BC%89%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/</url>
    <content><![CDATA[<h1 id="Python-基础教程（三）异常处理"><a href="#Python-基础教程（三）异常处理" class="headerlink" title="Python 基础教程（三）异常处理"></a>Python 基础教程（三）异常处理</h1><p>异常处理是编写健壮程序的关键。本篇将介绍 Python 中的异常处理机制，以及如何优雅地处理错误。</p>
<h2 id="一、异常基础"><a href="#一、异常基础" class="headerlink" title="一、异常基础"></a>一、异常基础</h2><h3 id="1-1-什么是异常？"><a href="#1-1-什么是异常？" class="headerlink" title="1.1 什么是异常？"></a>1.1 什么是异常？</h3><p><strong>异常（Exception）</strong> 是程序运行过程中发生的错误事件。当 Python 无法正常执行代码时，会抛出异常。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 常见异常示例</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ZeroDivisionError: 除以零</span></span><br><span class="line">result = <span class="number">10</span> / <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># FileNotFoundError: 文件不存在</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;不存在的文件.txt&quot;</span>, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    content = f.read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># IndexError: 索引超出范围</span></span><br><span class="line">lst = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="built_in">print</span>(lst[<span class="number">10</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># KeyError: 字典键不存在</span></span><br><span class="line">d = &#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>, <span class="string">&quot;b&quot;</span>: <span class="number">2</span>&#125;</span><br><span class="line"><span class="built_in">print</span>(d[<span class="string">&quot;c&quot;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># ValueError: 值错误</span></span><br><span class="line">num = <span class="built_in">int</span>(<span class="string">&quot;abc&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># TypeError: 类型错误</span></span><br><span class="line">result = <span class="string">&quot;hello&quot;</span> + <span class="number">123</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># AttributeError: 属性不存在</span></span><br><span class="line">name = <span class="string">&quot;张三&quot;</span></span><br><span class="line">name.nonexistent_method()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：遇到异常不要慌，先读懂错误信息</span></span><br></pre></td></tr></table></figure>

<h3 id="1-2-异常的结构"><a href="#1-2-异常的结构" class="headerlink" title="1.2 异常的结构"></a>1.2 异常的结构</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看异常继承层次</span></span><br><span class="line"><span class="built_in">print</span>(Exception.__mro__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 常见异常类型（都是 Exception 的子类）：</span></span><br><span class="line"><span class="comment"># - ArithmeticError: 算术错误</span></span><br><span class="line"><span class="comment"># - AssertionError: 断言失败</span></span><br><span class="line"><span class="comment"># - AttributeError: 属性错误</span></span><br><span class="line"><span class="comment"># - EOFError: 输入结束</span></span><br><span class="line"><span class="comment"># - FileNotFoundError: 文件未找到</span></span><br><span class="line"><span class="comment"># - ImportError: 导入失败</span></span><br><span class="line"><span class="comment"># - IndexError: 索引错误</span></span><br><span class="line"><span class="comment"># - KeyError: 键错误</span></span><br><span class="line"><span class="comment"># - KeyboardInterrupt: Ctrl+C 中断</span></span><br><span class="line"><span class="comment"># - MemoryError: 内存不足</span></span><br><span class="line"><span class="comment"># - NameError: 名称未定义</span></span><br><span class="line"><span class="comment"># - NotImplementedError: 方法未实现</span></span><br><span class="line"><span class="comment"># - OSError: 操作系统错误</span></span><br><span class="line"><span class="comment"># - TypeError: 类型错误</span></span><br><span class="line"><span class="comment"># - ValueError: 值错误</span></span><br></pre></td></tr></table></figure>

<h2 id="二、try-except-语句"><a href="#二、try-except-语句" class="headerlink" title="二、try-except 语句"></a>二、try-except 语句</h2><h3 id="2-1-基础用法"><a href="#2-1-基础用法" class="headerlink" title="2.1 基础用法"></a>2.1 基础用法</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 最简单的异常处理</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    result = <span class="number">10</span> / <span class="number">0</span></span><br><span class="line"><span class="keyword">except</span> ZeroDivisionError:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;错误：不能除以零！&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;程序继续执行...&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出：</span></span><br><span class="line"><span class="comment"># 错误：不能除以零！</span></span><br><span class="line"><span class="comment"># 程序继续执行...</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-捕获多个异常"><a href="#2-2-捕获多个异常" class="headerlink" title="2.2 捕获多个异常"></a>2.2 捕获多个异常</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 方法一：多个 except 子句</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    num = <span class="built_in">int</span>(<span class="built_in">input</span>(<span class="string">&quot;请输入数字：&quot;</span>))</span><br><span class="line">    result = <span class="number">100</span> / num</span><br><span class="line"><span class="keyword">except</span> ValueError:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;错误：请输入有效的数字！&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> ZeroDivisionError:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;错误：不能除以零！&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法二：元组捕获多个异常</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    num = <span class="built_in">int</span>(<span class="built_in">input</span>(<span class="string">&quot;请输入数字：&quot;</span>))</span><br><span class="line">    result = <span class="number">100</span> / num</span><br><span class="line"><span class="keyword">except</span> (ValueError, ZeroDivisionError):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;错误：输入无效！&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法三：捕获所有异常（不推荐滥用）</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    risky_operation()</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;发生错误：<span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - 不要随意使用 except: 或 except Exception:</span></span><br><span class="line"><span class="comment"># - 应该明确指定要捕获的异常类型</span></span><br><span class="line"><span class="comment"># -  bare except 会捕获所有异常，包括 KeyboardInterrupt</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-获取异常信息"><a href="#2-3-获取异常信息" class="headerlink" title="2.3 获取异常信息"></a>2.3 获取异常信息</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    result = <span class="number">10</span> / <span class="number">0</span></span><br><span class="line"><span class="keyword">except</span> ZeroDivisionError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;异常类型：<span class="subst">&#123;<span class="built_in">type</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;异常信息：<span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;异常详情：<span class="subst">&#123;<span class="built_in">repr</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出：</span></span><br><span class="line"><span class="comment"># 异常类型：&lt;class &#x27;ZeroDivisionError&#x27;&gt;</span></span><br><span class="line"><span class="comment"># 异常信息：division by zero</span></span><br></pre></td></tr></table></figure>

<h3 id="2-4-else-子句"><a href="#2-4-else-子句" class="headerlink" title="2.4 else 子句"></a>2.4 else 子句</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># else 在没有异常时执行</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    num = <span class="built_in">int</span>(<span class="built_in">input</span>(<span class="string">&quot;请输入数字：&quot;</span>))</span><br><span class="line">    result = <span class="number">100</span> / num</span><br><span class="line"><span class="keyword">except</span> (ValueError, ZeroDivisionError) <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;错误：<span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;计算结果：<span class="subst">&#123;result&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;计算成功！&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - else 块在没有异常时执行</span></span><br><span class="line"><span class="comment"># - else 应该包含可能产生异常的代码之后的逻辑</span></span><br><span class="line"><span class="comment"># - 将可能出错的代码放在 try 中，其他放在 else 中</span></span><br></pre></td></tr></table></figure>

<h3 id="2-5-finally-子句"><a href="#2-5-finally-子句" class="headerlink" title="2.5 finally 子句"></a>2.5 finally 子句</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># finally 无论是否发生异常都会执行</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    file = <span class="built_in">open</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;r&quot;</span>)</span><br><span class="line">    content = file.read()</span><br><span class="line">    result = <span class="number">10</span> / <span class="number">0</span>  <span class="comment"># 故意制造异常</span></span><br><span class="line"><span class="keyword">except</span> ZeroDivisionError:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;发生除零错误&quot;</span>)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;始终会执行&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;file&#x27;</span> <span class="keyword">in</span> <span class="built_in">locals</span>():</span><br><span class="line">        file.close()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;文件已关闭&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出：</span></span><br><span class="line"><span class="comment"># 发生除零错误</span></span><br><span class="line"><span class="comment"># 始终会执行</span></span><br><span class="line"><span class="comment"># 文件已关闭</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - finally 总是执行，即使 try 中有 return</span></span><br><span class="line"><span class="comment"># - 常用于资源清理（关闭文件、数据库连接等）</span></span><br><span class="line"><span class="comment"># - 现在更推荐使用 with 语句自动管理资源</span></span><br></pre></td></tr></table></figure>

<h3 id="2-6-完整结构"><a href="#2-6-完整结构" class="headerlink" title="2.6 完整结构"></a>2.6 完整结构</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># 可能出错的代码</span></span><br><span class="line">    result = risky_operation()</span><br><span class="line"><span class="keyword">except</span> SpecificError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="comment"># 处理特定异常</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;特定错误：<span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="comment"># 处理其他异常</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;其他错误：<span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># 没有异常时执行</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;成功：<span class="subst">&#123;result&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    <span class="comment"># 总是执行</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;清理工作&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="三、抛出异常"><a href="#三、抛出异常" class="headerlink" title="三、抛出异常"></a>三、抛出异常</h2><h3 id="3-1-raise-语句"><a href="#3-1-raise-语句" class="headerlink" title="3.1 raise 语句"></a>3.1 raise 语句</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 抛出异常</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">divide</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="keyword">if</span> b == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> ZeroDivisionError(<span class="string">&quot;除数不能为零！&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> a / b</span><br><span class="line"></span><br><span class="line"><span class="comment"># 抛出异常时携带信息</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">validate_age</span>(<span class="params">age</span>):</span><br><span class="line">    <span class="keyword">if</span> age &lt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;年龄不能为负数&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> age &gt; <span class="number">150</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;年龄不合理&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新抛出捕获的异常</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    result = <span class="number">10</span> / <span class="number">0</span></span><br><span class="line"><span class="keyword">except</span> ZeroDivisionError:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;记录日志...&quot;</span>)</span><br><span class="line">    <span class="keyword">raise</span>  <span class="comment"># 重新抛出当前异常</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - 只在自己能处理时才捕获异常</span></span><br><span class="line"><span class="comment"># - 否则应该让异常向上传播</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-自定义异常"><a href="#3-2-自定义异常" class="headerlink" title="3.2 自定义异常"></a>3.2 自定义异常</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 自定义异常类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyError</span>(<span class="title class_ inherited__">Exception</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;自定义异常基类&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ValidationError</span>(<span class="title class_ inherited__">MyError</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;验证错误&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, field, message</span>):</span><br><span class="line">        <span class="variable language_">self</span>.field = field</span><br><span class="line">        <span class="variable language_">self</span>.message = message</span><br><span class="line">        <span class="built_in">super</span>().__init__(<span class="string">f&quot;<span class="subst">&#123;field&#125;</span>: <span class="subst">&#123;message&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DatabaseError</span>(<span class="title class_ inherited__">MyError</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;数据库错误&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, query, reason</span>):</span><br><span class="line">        <span class="variable language_">self</span>.query = query</span><br><span class="line">        <span class="variable language_">self</span>.reason = reason</span><br><span class="line">        <span class="built_in">super</span>().__init__(<span class="string">f&quot;SQL &#x27;<span class="subst">&#123;query&#125;</span>&#x27; 失败：<span class="subst">&#123;reason&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用自定义异常</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">validate_user</span>(<span class="params">username, email</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> username:</span><br><span class="line">        <span class="keyword">raise</span> ValidationError(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;不能为空&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;@&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> email:</span><br><span class="line">        <span class="keyword">raise</span> ValidationError(<span class="string">&quot;email&quot;</span>, <span class="string">&quot;格式不正确&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    validate_user(<span class="string">&quot;&quot;</span>, <span class="string">&quot;invalid&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> ValidationError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;验证失败：<span class="subst">&#123;e.field&#125;</span> - <span class="subst">&#123;e.message&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="3-3-异常链"><a href="#3-3-异常链" class="headerlink" title="3.3 异常链"></a>3.3 异常链</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在捕获一个异常后抛出另一个异常</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    result = database.query()</span><br><span class="line"><span class="keyword">except</span> DatabaseConnectionError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="keyword">raise</span> ApplicationError(<span class="string">&quot;数据库连接失败&quot;</span>) <span class="keyword">from</span> e</span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问原始异常</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">except</span> ApplicationError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;应用错误：<span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;原始错误：<span class="subst">&#123;e.__cause__&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - from e 保留原始异常信息</span></span><br><span class="line"><span class="comment"># - 有助于追踪错误根源</span></span><br></pre></td></tr></table></figure>

<h2 id="四、断言"><a href="#四、断言" class="headerlink" title="四、断言"></a>四、断言</h2><h3 id="4-1-assert-语句"><a href="#4-1-assert-语句" class="headerlink" title="4.1 assert 语句"></a>4.1 assert 语句</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 断言用于调试和验证假设</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calculate_discount</span>(<span class="params">price, discount</span>):</span><br><span class="line">    <span class="comment"># 断言条件必须为真</span></span><br><span class="line">    <span class="keyword">assert</span> <span class="number">0</span> &lt;= price &lt;= <span class="number">10000</span>, <span class="string">&quot;价格超出范围&quot;</span></span><br><span class="line">    <span class="keyword">assert</span> <span class="number">0</span> &lt;= discount &lt;= <span class="number">1</span>, <span class="string">&quot;折扣必须在 0-1 之间&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> price * (<span class="number">1</span> - discount)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 断言失败会抛出 AssertionError</span></span><br><span class="line"><span class="comment"># calculate_discount(-100, 0.1)  # AssertionError!</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 断言 vs 异常</span></span><br><span class="line"><span class="comment"># - 断言用于检查程序内部逻辑错误（开发阶段）</span></span><br><span class="line"><span class="comment"># - 异常用于处理运行时错误（生产环境）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - 不要用断言验证用户输入</span></span><br><span class="line"><span class="comment"># - 断言可以用-O 选项禁用</span></span><br><span class="line"><span class="comment"># - 生产环境应该用异常处理</span></span><br></pre></td></tr></table></figure>

<h2 id="五、上下文管理器"><a href="#五、上下文管理器" class="headerlink" title="五、上下文管理器"></a>五、上下文管理器</h2><h3 id="5-1-with-语句"><a href="#5-1-with-语句" class="headerlink" title="5.1 with 语句"></a>5.1 with 语句</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 自动管理资源</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    content = f.read()</span><br><span class="line"><span class="comment"># 文件自动关闭，即使发生异常</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 等价于：</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    f = <span class="built_in">open</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;r&quot;</span>)</span><br><span class="line">    content = f.read()</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    f.close()</span><br></pre></td></tr></table></figure>

<h3 id="5-2-自定义上下文管理器（类方式）"><a href="#5-2-自定义上下文管理器（类方式）" class="headerlink" title="5.2 自定义上下文管理器（类方式）"></a>5.2 自定义上下文管理器（类方式）</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ManagedFile</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;自定义文件管理器&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, filename, mode</span>):</span><br><span class="line">        <span class="variable language_">self</span>.filename = filename</span><br><span class="line">        <span class="variable language_">self</span>.mode = mode</span><br><span class="line">        <span class="variable language_">self</span>.file = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__enter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;进入上下文时调用&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;打开文件：<span class="subst">&#123;self.filename&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.file = <span class="built_in">open</span>(<span class="variable language_">self</span>.filename, <span class="variable language_">self</span>.mode)</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.file</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__exit__</span>(<span class="params">self, exc_type, exc_val, exc_tb</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;退出上下文时调用&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;关闭文件&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.file.close()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 返回 True 会抑制异常，False/None 会传播异常</span></span><br><span class="line">        <span class="keyword">if</span> exc_type <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;发生异常：<span class="subst">&#123;exc_type.__name__&#125;</span>: <span class="subst">&#123;exc_val&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line"><span class="keyword">with</span> ManagedFile(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="string">&quot;Hello, World!&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="5-3-contextlib-模块"><a href="#5-3-contextlib-模块" class="headerlink" title="5.3 contextlib 模块"></a>5.3 contextlib 模块</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> contextlib <span class="keyword">import</span> contextmanager</span><br><span class="line"></span><br><span class="line"><span class="meta">@contextmanager</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">managed_file</span>(<span class="params">filename, mode</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;使用生成器创建上下文管理器&quot;&quot;&quot;</span></span><br><span class="line">    f = <span class="built_in">open</span>(filename, mode)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">yield</span> f</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        f.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line"><span class="keyword">with</span> managed_file(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="string">&quot;Hello!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理多个资源</span></span><br><span class="line"><span class="keyword">from</span> contextlib <span class="keyword">import</span> ExitStack</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> ExitStack() <span class="keyword">as</span> stack:</span><br><span class="line">    file1 = stack.enter_context(<span class="built_in">open</span>(<span class="string">&quot;file1.txt&quot;</span>))</span><br><span class="line">    file2 = stack.enter_context(<span class="built_in">open</span>(<span class="string">&quot;file2.txt&quot;</span>))</span><br><span class="line">    <span class="comment"># 所有文件会自动关闭</span></span><br></pre></td></tr></table></figure>

<h2 id="六、最佳实践"><a href="#六、最佳实践" class="headerlink" title="六、最佳实践"></a>六、最佳实践</h2><h3 id="6-1-异常处理原则"><a href="#6-1-异常处理原则" class="headerlink" title="6.1 异常处理原则"></a>6.1 异常处理原则</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ❌ 不好的做法</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 捕获所有异常</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    do_something()</span><br><span class="line"><span class="keyword">except</span>:  <span class="comment"># 太宽泛！</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 忽略异常</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    dangerous_operation()</span><br><span class="line"><span class="keyword">except</span> Exception:  <span class="comment"># 没有记录或处理</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 异常范围太大</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    connect_db()</span><br><span class="line">    query_db()</span><br><span class="line">    process_data()</span><br><span class="line">    save_result()</span><br><span class="line"><span class="keyword">except</span> Exception:  <span class="comment"># 不知道哪里出错了</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;出错了&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ✅ 好的做法</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 明确指定异常类型</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    result = <span class="built_in">int</span>(user_input)</span><br><span class="line"><span class="keyword">except</span> ValueError:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;请输入有效的数字&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 记录异常信息</span></span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    risky_operation()</span><br><span class="line"><span class="keyword">except</span> SpecificError <span class="keyword">as</span> e:</span><br><span class="line">    logging.error(<span class="string">f&quot;操作失败：<span class="subst">&#123;e&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 缩小 try 块范围</span></span><br><span class="line">connect_db()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    data = query_db()</span><br><span class="line"><span class="keyword">except</span> DatabaseError:</span><br><span class="line">    handle_db_error()</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    close_db()</span><br></pre></td></tr></table></figure>

<h3 id="6-2-日志记录"><a href="#6-2-日志记录" class="headerlink" title="6.2 日志记录"></a>6.2 日志记录</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置日志</span></span><br><span class="line">logging.basicConfig(</span><br><span class="line">    level=logging.INFO,</span><br><span class="line">    <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_data</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result = risky_operation(data)</span><br><span class="line">        logger.info(<span class="string">f&quot;处理成功：<span class="subst">&#123;result&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    <span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;数据错误：<span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">raise</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.exception(<span class="string">f&quot;未知错误：<span class="subst">&#123;e&#125;</span>&quot;</span>)  <span class="comment"># exception() 会自动记录堆栈</span></span><br><span class="line">        <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - 生产环境应该记录异常堆栈</span></span><br><span class="line"><span class="comment"># - 使用 logger.exception() 记录完整堆栈信息</span></span><br><span class="line"><span class="comment"># - 不要记录敏感信息（密码、token 等）</span></span><br></pre></td></tr></table></figure>

<h3 id="6-3-资源清理模式"><a href="#6-3-资源清理模式" class="headerlink" title="6.3 资源清理模式"></a>6.3 资源清理模式</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 模式 1：with 语句（推荐）</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;file.txt&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    data = f.read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模式 2：try-finally</span></span><br><span class="line">f = <span class="literal">None</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    f = <span class="built_in">open</span>(<span class="string">&quot;file.txt&quot;</span>)</span><br><span class="line">    data = f.read()</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    <span class="keyword">if</span> f:</span><br><span class="line">        f.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模式 3：try-except-finally</span></span><br><span class="line">conn = <span class="literal">None</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    conn = create_connection()</span><br><span class="line">    do_work(conn)</span><br><span class="line"><span class="keyword">except</span> ConnectionError:</span><br><span class="line">    handle_error()</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    <span class="keyword">if</span> conn:</span><br><span class="line">        conn.close()</span><br></pre></td></tr></table></figure>

<h2 id="七、实战示例"><a href="#七、实战示例" class="headerlink" title="七、实战示例"></a>七、实战示例</h2><h3 id="7-1-文件处理"><a href="#7-1-文件处理" class="headerlink" title="7.1 文件处理"></a>7.1 文件处理</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">safe_read_json</span>(<span class="params">filepath</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;安全读取 JSON 文件&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        path = Path(filepath)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> path.exists():</span><br><span class="line">            <span class="keyword">raise</span> FileNotFoundError(<span class="string">f&quot;文件不存在：<span class="subst">&#123;filepath&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">return</span> json.load(f)</span><br><span class="line">    <span class="keyword">except</span> json.JSONDecodeError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;JSON 格式错误：<span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;读取失败：<span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line">data = safe_read_json(<span class="string">&quot;config.json&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="7-2-网络请求"><a href="#7-2-网络请求" class="headerlink" title="7.2 网络请求"></a>7.2 网络请求</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> requests.exceptions <span class="keyword">import</span> RequestException, Timeout, HTTPError</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fetch_url</span>(<span class="params">url, timeout=<span class="number">5</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;安全获取 URL 内容&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = requests.get(url, timeout=timeout)</span><br><span class="line">        response.raise_for_status()  <span class="comment"># 检查 HTTP 错误</span></span><br><span class="line">        <span class="keyword">return</span> response.text</span><br><span class="line">    <span class="keyword">except</span> Timeout:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;请求超时：<span class="subst">&#123;url&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> HTTPError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;HTTP 错误：<span class="subst">&#123;e.response.status_code&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> RequestException <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;请求失败：<span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line">content = fetch_url(<span class="string">&quot;https://api.example.com/data&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="7-3-数据验证"><a href="#7-3-数据验证" class="headerlink" title="7.3 数据验证"></a>7.3 数据验证</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DataValidationError</span>(<span class="title class_ inherited__">Exception</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;数据验证错误&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">validate_user_data</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;验证用户数据&quot;&quot;&quot;</span></span><br><span class="line">    errors = []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 检查必填字段</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> data.get(<span class="string">&#x27;username&#x27;</span>):</span><br><span class="line">        errors.append(<span class="string">&quot;用户名不能为空&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> data.get(<span class="string">&#x27;email&#x27;</span>):</span><br><span class="line">        errors.append(<span class="string">&quot;邮箱不能为空&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> <span class="string">&#x27;@&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> data[<span class="string">&#x27;email&#x27;</span>]:</span><br><span class="line">        errors.append(<span class="string">&quot;邮箱格式不正确&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;age&#x27;</span> <span class="keyword">in</span> data:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(data[<span class="string">&#x27;age&#x27;</span>], <span class="built_in">int</span>):</span><br><span class="line">            errors.append(<span class="string">&quot;年龄必须是整数&quot;</span>)</span><br><span class="line">        <span class="keyword">elif</span> data[<span class="string">&#x27;age&#x27;</span>] &lt; <span class="number">0</span> <span class="keyword">or</span> data[<span class="string">&#x27;age&#x27;</span>] &gt; <span class="number">150</span>:</span><br><span class="line">            errors.append(<span class="string">&quot;年龄不合理&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> errors:</span><br><span class="line">        <span class="keyword">raise</span> DataValidationError(<span class="string">&quot;; &quot;</span>.join(errors))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    validate_user_data(&#123;<span class="string">&quot;username&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;email&quot;</span>: <span class="string">&quot;invalid&quot;</span>&#125;)</span><br><span class="line"><span class="keyword">except</span> DataValidationError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;验证失败：<span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="八、总结"><a href="#八、总结" class="headerlink" title="八、总结"></a>八、总结</h2><blockquote>
<p><strong>提醒自己</strong>：</p>
<ol>
<li><strong>只捕获能处理的异常</strong>：不要为了捕获而捕获</li>
<li><strong>明确异常类型</strong>：避免使用 bare except</li>
<li><strong>记录异常信息</strong>：方便调试和问题追踪</li>
<li><strong>及时清理资源</strong>：使用 with 或 finally</li>
<li><strong>合理的异常层次</strong>：不要过度嵌套 try-except</li>
<li><strong>自定义异常要有意义</strong>：有助于问题定位</li>
</ol>
</blockquote>
<h2 id="九、练习"><a href="#九、练习" class="headerlink" title="九、练习"></a>九、练习</h2><ol>
<li>编写一个函数，安全地将字符串转换为整数，处理各种异常情况</li>
<li>实现一个文件复制函数，处理文件不存在、权限不足等情况</li>
<li>自定义一个 API 调用异常类，处理超时、HTTP 错误等情况</li>
<li>编写一个配置文件加载器，处理各种可能的错误</li>
<li>实现一个简单的日志系统，记录异常信息到文件</li>
</ol>
<hr>
<p><strong>上一篇</strong>：<a href="/2026/02/24/Python-%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B%EF%BC%88%E4%BA%8C%EF%BC%89%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%BC%96%E7%A8%8B/">Python 基础教程（二）：面向对象编程</a></p>
<p><strong>下一篇</strong>：[Python 数据科学（一）：NumPy 数值计算](&#x2F;2026&#x2F;02&#x2F;24&#x2F;Python-数据科学（一）NumPy 数值计算&#x2F;)</p>
<p><strong>参考资源</strong>：</p>
<ul>
<li><a href="https://docs.python.org/zh-cn/3/tutorial/errors.html">Python 官方文档 - 异常处理</a></li>
<li><a href="https://docs.python.org/zh-cn/3/library/exceptions.html">Python 官方文档 - 内置异常</a></li>
<li><a href="https://docs.python.org/zh-cn/3/library/contextlib.html">contextlib 模块文档</a></li>
</ul>
]]></content>
      <categories>
        <category>Python 教程</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>异常处理</tag>
        <tag>错误处理</tag>
      </tags>
  </entry>
  <entry>
    <title>Python 基础教程（一）基础语法入门</title>
    <url>/2026/02/24/Python%20%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B%EF%BC%88%E4%B8%80%EF%BC%89%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95%E5%85%A5%E9%97%A8/</url>
    <content><![CDATA[<h1 id="Python-基础教程（一）基础语法入门"><a href="#Python-基础教程（一）基础语法入门" class="headerlink" title="Python 基础教程（一）基础语法入门"></a>Python 基础教程（一）基础语法入门</h1><p>欢迎来到 Python 基础教程系列！本篇将从零开始介绍 Python 的基础语法，帮助你快速上手 Python 编程。</p>
<h2 id="一、Python-简介"><a href="#一、Python-简介" class="headerlink" title="一、Python 简介"></a>一、Python 简介</h2><h3 id="1-1-为什么选择-Python？"><a href="#1-1-为什么选择-Python？" class="headerlink" title="1.1 为什么选择 Python？"></a>1.1 为什么选择 Python？</h3><ul>
<li><strong>语法简洁</strong>：代码可读性强，接近自然语言</li>
<li><strong>生态丰富</strong>：拥有庞大的第三方库生态系统</li>
<li><strong>应用广泛</strong>：Web 开发、数据分析、人工智能、自动化脚本等</li>
<li><strong>跨平台</strong>：Windows、Linux、macOS 均可运行</li>
<li><strong>社区活跃</strong>：遇到问题容易找到解决方案</li>
</ul>
<h3 id="1-2-Python-版本选择"><a href="#1-2-Python-版本选择" class="headerlink" title="1.2 Python 版本选择"></a>1.2 Python 版本选择</h3><blockquote>
<p><strong>提醒自己</strong>：务必使用 <strong>Python 3.x</strong>（推荐 3.8+），Python 2 已停止维护。</p>
</blockquote>
<h2 id="二、环境搭建"><a href="#二、环境搭建" class="headerlink" title="二、环境搭建"></a>二、环境搭建</h2><h3 id="2-1-安装-Python"><a href="#2-1-安装-Python" class="headerlink" title="2.1 安装 Python"></a>2.1 安装 Python</h3><p><strong>Windows：</strong></p>
<ol>
<li>访问 <a href="https://www.python.org/downloads/">https://www.python.org/downloads/</a></li>
<li>下载最新稳定版（如 3.11.x）</li>
<li>安装时勾选 <strong>“Add Python to PATH”</strong></li>
</ol>
<p><strong>验证安装：</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python --version</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">python3 --version</span><br></pre></td></tr></table></figure>

<h3 id="2-2-包管理工具-pip"><a href="#2-2-包管理工具-pip" class="headerlink" title="2.2 包管理工具 pip"></a>2.2 包管理工具 pip</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看 pip 版本</span></span><br><span class="line">pip --version</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装包</span></span><br><span class="line">pip install 包名</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装指定版本</span></span><br><span class="line">pip install 包名==1.0.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 升级包</span></span><br><span class="line">pip install --upgrade 包名</span><br><span class="line"></span><br><span class="line"><span class="comment"># 卸载包</span></span><br><span class="line">pip uninstall 包名</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看已安装的包</span></span><br><span class="line">pip list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导出依赖</span></span><br><span class="line">pip freeze &gt; requirements.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从文件安装依赖</span></span><br><span class="line">pip install -r requirements.txt</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>提醒自己</strong>：</p>
<ul>
<li>国内用户可使用清华&#x2F;阿里镜像源加速安装</li>
<li><code>pip install -i https://pypi.tuna.tsinghua.edu.cn/simple 包名</code></li>
</ul>
</blockquote>
<h3 id="2-3-虚拟环境（重要！）"><a href="#2-3-虚拟环境（重要！）" class="headerlink" title="2.3 虚拟环境（重要！）"></a>2.3 虚拟环境（重要！）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建虚拟环境</span></span><br><span class="line">python -m venv venv</span><br><span class="line"></span><br><span class="line"><span class="comment"># Windows 激活</span></span><br><span class="line">venv\Scripts\activate</span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux/macOS 激活</span></span><br><span class="line"><span class="built_in">source</span> venv/bin/activate</span><br><span class="line"></span><br><span class="line"><span class="comment"># 退出虚拟环境</span></span><br><span class="line">deactivate</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>提醒自己</strong>：</p>
<ul>
<li>每个项目都应该使用独立的虚拟环境</li>
<li>避免不同项目之间的依赖冲突</li>
<li>虚拟环境目录不要提交到 Git</li>
</ul>
</blockquote>
<h3 id="2-4-第一个-Python-程序"><a href="#2-4-第一个-Python-程序" class="headerlink" title="2.4 第一个 Python 程序"></a>2.4 第一个 Python 程序</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># hello.py</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Hello, World!&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>运行：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python hello.py</span><br></pre></td></tr></table></figure>

<h2 id="三、基础语法"><a href="#三、基础语法" class="headerlink" title="三、基础语法"></a>三、基础语法</h2><h3 id="3-1-注释"><a href="#3-1-注释" class="headerlink" title="3.1 注释"></a>3.1 注释</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 这是单行注释</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">这是多行注释（文档字符串）</span></span><br><span class="line"><span class="string">可以写多行</span></span><br><span class="line"><span class="string">通常用于函数、类的说明</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：函数和模块应该用 docstring 说明用途</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-变量与数据类型"><a href="#3-2-变量与数据类型" class="headerlink" title="3.2 变量与数据类型"></a>3.2 变量与数据类型</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 变量定义（无需声明类型）</span></span><br><span class="line">name = <span class="string">&quot;张三&quot;</span>       <span class="comment"># 字符串 str</span></span><br><span class="line">age = <span class="number">25</span>            <span class="comment"># 整数 int</span></span><br><span class="line">height = <span class="number">1.75</span>       <span class="comment"># 浮点数 float</span></span><br><span class="line">is_student = <span class="literal">False</span>  <span class="comment"># 布尔 bool</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 同时给多个变量赋值</span></span><br><span class="line">x, y, z = <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span></span><br><span class="line">a = b = c = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看类型</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(name))   <span class="comment"># &lt;class &#x27;str&#x27;&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 类型转换</span></span><br><span class="line">num_str = <span class="string">&quot;123&quot;</span></span><br><span class="line">num_int = <span class="built_in">int</span>(num_str)  <span class="comment"># 字符串转整数</span></span><br><span class="line"></span><br><span class="line">float_num = <span class="built_in">float</span>(<span class="number">10</span>)   <span class="comment"># 整数转浮点数：10.0</span></span><br><span class="line">str_num = <span class="built_in">str</span>(<span class="number">123</span>)      <span class="comment"># 整数转字符串：&quot;123&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>提醒自己</strong>：</p>
<ul>
<li>变量名只能包含字母、数字、下划线</li>
<li>变量名不能以数字开头</li>
<li>不能使用 Python 关键字（如 if、for、while 等）</li>
<li>推荐使用<strong>小写字母 + 下划线</strong>的命名风格（snake_case）</li>
</ul>
</blockquote>
<h3 id="3-3-常用数据类型"><a href="#3-3-常用数据类型" class="headerlink" title="3.3 常用数据类型"></a>3.3 常用数据类型</h3><h4 id="字符串（str）"><a href="#字符串（str）" class="headerlink" title="字符串（str）"></a>字符串（str）</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 字符串定义</span></span><br><span class="line">s1 = <span class="string">&#x27;单引号&#x27;</span></span><br><span class="line">s2 = <span class="string">&quot;双引号&quot;</span></span><br><span class="line">s3 = <span class="string">&quot;&quot;&quot;三引号，可以跨行&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 字符串操作</span></span><br><span class="line">name = <span class="string">&quot;Hello, Python&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(name))           <span class="comment"># 长度：13</span></span><br><span class="line"><span class="built_in">print</span>(name[<span class="number">0</span>])             <span class="comment"># 第一个字符：H</span></span><br><span class="line"><span class="built_in">print</span>(name[-<span class="number">1</span>])            <span class="comment"># 最后一个字符：n</span></span><br><span class="line"><span class="built_in">print</span>(name[<span class="number">0</span>:<span class="number">5</span>])           <span class="comment"># 切片：Hello</span></span><br><span class="line"><span class="built_in">print</span>(name.lower())        <span class="comment"># 转小写：hello, python</span></span><br><span class="line"><span class="built_in">print</span>(name.upper())        <span class="comment"># 转大写：HELLO, PYTHON</span></span><br><span class="line"><span class="built_in">print</span>(name.split(<span class="string">&quot;, &quot;</span>))    <span class="comment"># 分割：[&#x27;Hello&#x27;, &#x27;Python&#x27;]</span></span><br><span class="line"><span class="built_in">print</span>(name.replace(<span class="string">&quot;Python&quot;</span>, <span class="string">&quot;World&quot;</span>))  <span class="comment"># 替换</span></span><br><span class="line"><span class="built_in">print</span>(name.find(<span class="string">&quot;Python&quot;</span>)) <span class="comment"># 查找位置：7</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Python&quot;</span> <span class="keyword">in</span> name)    <span class="comment"># 判断包含：True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># f-string 格式化（Python 3.6+）</span></span><br><span class="line">name = <span class="string">&quot;张三&quot;</span></span><br><span class="line">age = <span class="number">25</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;我叫<span class="subst">&#123;name&#125;</span>，今年<span class="subst">&#123;age&#125;</span>岁&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 格式化数字</span></span><br><span class="line">pi = <span class="number">3.1415926</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;π ≈ <span class="subst">&#123;pi:<span class="number">.2</span>f&#125;</span>&quot;</span>)     <span class="comment"># π ≈ 3.14</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：优先使用 f-string，比 format() 更简洁</span></span><br></pre></td></tr></table></figure>

<h4 id="列表（list）"><a href="#列表（list）" class="headerlink" title="列表（list）"></a>列表（list）</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 列表定义</span></span><br><span class="line">fruits = [<span class="string">&quot;苹果&quot;</span>, <span class="string">&quot;香蕉&quot;</span>, <span class="string">&quot;橙子&quot;</span>]</span><br><span class="line">numbers = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line">mixed = [<span class="number">1</span>, <span class="string">&quot;hello&quot;</span>, <span class="number">3.14</span>, <span class="literal">True</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问元素</span></span><br><span class="line"><span class="built_in">print</span>(fruits[<span class="number">0</span>])      <span class="comment"># 苹果</span></span><br><span class="line"><span class="built_in">print</span>(fruits[-<span class="number">1</span>])     <span class="comment"># 橙子（最后一个）</span></span><br><span class="line"><span class="built_in">print</span>(fruits[<span class="number">1</span>:<span class="number">3</span>])    <span class="comment"># 切片：[&#x27;香蕉&#x27;, &#x27;橙子&#x27;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改元素</span></span><br><span class="line">fruits[<span class="number">0</span>] = <span class="string">&quot;葡萄&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 列表操作</span></span><br><span class="line">fruits.append(<span class="string">&quot;西瓜&quot;</span>)           <span class="comment"># 末尾添加</span></span><br><span class="line">fruits.insert(<span class="number">1</span>, <span class="string">&quot;柠檬&quot;</span>)        <span class="comment"># 指定位置插入</span></span><br><span class="line">fruits.remove(<span class="string">&quot;香蕉&quot;</span>)           <span class="comment"># 删除指定值</span></span><br><span class="line">last = fruits.pop()             <span class="comment"># 删除并返回最后一个</span></span><br><span class="line"><span class="keyword">del</span> fruits[<span class="number">0</span>]                   <span class="comment"># 删除指定索引</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 列表运算</span></span><br><span class="line">list1 = [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">list2 = [<span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"><span class="built_in">print</span>(list1 + list2)   <span class="comment"># [1, 2, 3, 4]</span></span><br><span class="line"><span class="built_in">print</span>(list1 * <span class="number">3</span>)       <span class="comment"># [1, 2, 1, 2, 1, 2]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 列表推导式（重要！）</span></span><br><span class="line">squares = [x**<span class="number">2</span> <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)]          <span class="comment"># [0, 1, 4, 9, 16, ...]</span></span><br><span class="line">evens = [x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>) <span class="keyword">if</span> x % <span class="number">2</span> == <span class="number">0</span>] <span class="comment"># 偶数列表</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：列表推导式可以简化代码，但不要太复杂</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 常用函数</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(fruits))       <span class="comment"># 长度</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">max</span>(numbers))      <span class="comment"># 最大值</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">min</span>(numbers))      <span class="comment"># 最小值</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sum</span>(numbers))      <span class="comment"># 求和</span></span><br></pre></td></tr></table></figure>

<h4 id="元组（tuple）"><a href="#元组（tuple）" class="headerlink" title="元组（tuple）"></a>元组（tuple）</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 元组定义（不可变列表）</span></span><br><span class="line">colors = (<span class="string">&quot;红&quot;</span>, <span class="string">&quot;绿&quot;</span>, <span class="string">&quot;蓝&quot;</span>)</span><br><span class="line">point = (<span class="number">10</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问元素</span></span><br><span class="line"><span class="built_in">print</span>(colors[<span class="number">0</span>])    <span class="comment"># 红</span></span><br><span class="line"><span class="built_in">print</span>(colors[-<span class="number">1</span>])   <span class="comment"># 蓝</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 元组解包</span></span><br><span class="line">x, y = point</span><br><span class="line"><span class="built_in">print</span>(x, y)         <span class="comment"># 10 20</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 交换变量</span></span><br><span class="line">a, b = <span class="number">1</span>, <span class="number">2</span></span><br><span class="line">a, b = b, a</span><br><span class="line"><span class="built_in">print</span>(a, b)         <span class="comment"># 2 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - 元组不可修改，适合存储不应改变的数据</span></span><br><span class="line"><span class="comment"># - 函数返回多个值时实际返回的是元组</span></span><br></pre></td></tr></table></figure>

<h4 id="字典（dict）"><a href="#字典（dict）" class="headerlink" title="字典（dict）"></a>字典（dict）</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 字典定义（键值对）</span></span><br><span class="line">person = &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">    <span class="string">&quot;age&quot;</span>: <span class="number">25</span>,</span><br><span class="line">    <span class="string">&quot;city&quot;</span>: <span class="string">&quot;北京&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问值</span></span><br><span class="line"><span class="built_in">print</span>(person[<span class="string">&quot;name&quot;</span>])        <span class="comment"># 张三</span></span><br><span class="line"><span class="built_in">print</span>(person.get(<span class="string">&quot;age&quot;</span>))     <span class="comment"># 25</span></span><br><span class="line"><span class="built_in">print</span>(person.get(<span class="string">&quot;email&quot;</span>, <span class="string">&quot;未提供&quot;</span>))  <span class="comment"># 默认值</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改/添加</span></span><br><span class="line">person[<span class="string">&quot;age&quot;</span>] = <span class="number">26</span></span><br><span class="line">person[<span class="string">&quot;email&quot;</span>] = <span class="string">&quot;zhangsan@example.com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除</span></span><br><span class="line"><span class="keyword">del</span> person[<span class="string">&quot;city&quot;</span>]</span><br><span class="line">email = person.pop(<span class="string">&quot;email&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 遍历字典</span></span><br><span class="line"><span class="keyword">for</span> key, value <span class="keyword">in</span> person.items():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;key&#125;</span>: <span class="subst">&#123;value&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取所有键/值</span></span><br><span class="line"><span class="built_in">print</span>(person.keys())</span><br><span class="line"><span class="built_in">print</span>(person.values())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 字典推导式</span></span><br><span class="line">squares = &#123;x: x**<span class="number">2</span> <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>)&#125;</span><br><span class="line"><span class="comment"># &#123;0: 0, 1: 1, 2: 4, 3: 9, 4: 16&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：字典查找速度很快（O(1)），适合频繁查找的场景</span></span><br></pre></td></tr></table></figure>

<h4 id="集合（set）"><a href="#集合（set）" class="headerlink" title="集合（set）"></a>集合（set）</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 集合定义（无序、不重复）</span></span><br><span class="line">fruits = &#123;<span class="string">&quot;苹果&quot;</span>, <span class="string">&quot;香蕉&quot;</span>, <span class="string">&quot;橙子&quot;</span>&#125;</span><br><span class="line">numbers = <span class="built_in">set</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>])  <span class="comment"># &#123;1, 2, 3&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 集合操作</span></span><br><span class="line">fruits.add(<span class="string">&quot;葡萄&quot;</span>)           <span class="comment"># 添加元素</span></span><br><span class="line">fruits.remove(<span class="string">&quot;香蕉&quot;</span>)         <span class="comment"># 删除元素</span></span><br><span class="line">fruits.discard(<span class="string">&quot;西瓜&quot;</span>)        <span class="comment"># 删除（不存在不报错）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 集合运算</span></span><br><span class="line">set1 = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;</span><br><span class="line">set2 = &#123;<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(set1 | set2)   <span class="comment"># 并集：&#123;1, 2, 3, 4, 5, 6&#125;</span></span><br><span class="line"><span class="built_in">print</span>(set1 &amp; set2)   <span class="comment"># 交集：&#123;3, 4&#125;</span></span><br><span class="line"><span class="built_in">print</span>(set1 - set2)   <span class="comment"># 差集：&#123;1, 2&#125;</span></span><br><span class="line"><span class="built_in">print</span>(set1 ^ set2)   <span class="comment"># 对称差集：&#123;1, 2, 5, 6&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：集合适合去重和判断成员关系</span></span><br></pre></td></tr></table></figure>

<h3 id="3-4-运算符"><a href="#3-4-运算符" class="headerlink" title="3.4 运算符"></a>3.4 运算符</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 算术运算符</span></span><br><span class="line">a, b = <span class="number">10</span>, <span class="number">3</span></span><br><span class="line"><span class="built_in">print</span>(a + b)   <span class="comment"># 加：13</span></span><br><span class="line"><span class="built_in">print</span>(a - b)   <span class="comment"># 减：7</span></span><br><span class="line"><span class="built_in">print</span>(a * b)   <span class="comment"># 乘：30</span></span><br><span class="line"><span class="built_in">print</span>(a / b)   <span class="comment"># 除：3.333...</span></span><br><span class="line"><span class="built_in">print</span>(a // b)  <span class="comment"># 整除：3</span></span><br><span class="line"><span class="built_in">print</span>(a % b)   <span class="comment"># 取余：1</span></span><br><span class="line"><span class="built_in">print</span>(a ** b)  <span class="comment"># 幂：1000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 比较运算符</span></span><br><span class="line"><span class="built_in">print</span>(a &gt; b)    <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(a &lt; b)    <span class="comment"># False</span></span><br><span class="line"><span class="built_in">print</span>(a == b)   <span class="comment"># False</span></span><br><span class="line"><span class="built_in">print</span>(a != b)   <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(a &gt;= <span class="number">10</span>)  <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(a &lt;= <span class="number">10</span>)  <span class="comment"># True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 逻辑运算符</span></span><br><span class="line"><span class="built_in">print</span>(<span class="literal">True</span> <span class="keyword">and</span> <span class="literal">False</span>)   <span class="comment"># False</span></span><br><span class="line"><span class="built_in">print</span>(<span class="literal">True</span> <span class="keyword">or</span> <span class="literal">False</span>)    <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="keyword">not</span> <span class="literal">True</span>)         <span class="comment"># False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 成员运算符</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;a&quot;</span> <span class="keyword">in</span> <span class="string">&quot;abc&quot;</span>)      <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;x&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="string">&quot;abc&quot;</span>)  <span class="comment"># True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 身份运算符（比较内存地址）</span></span><br><span class="line">x = [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">y = [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">z = x</span><br><span class="line"><span class="built_in">print</span>(x == y)   <span class="comment"># True（值相等）</span></span><br><span class="line"><span class="built_in">print</span>(x <span class="keyword">is</span> y)   <span class="comment"># False（不是同一个对象）</span></span><br><span class="line"><span class="built_in">print</span>(x <span class="keyword">is</span> z)   <span class="comment"># True（同一个对象）</span></span><br></pre></td></tr></table></figure>

<h2 id="四、流程控制"><a href="#四、流程控制" class="headerlink" title="四、流程控制"></a>四、流程控制</h2><h3 id="4-1-条件语句"><a href="#4-1-条件语句" class="headerlink" title="4.1 条件语句"></a>4.1 条件语句</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># if-elif-else 结构</span></span><br><span class="line">score = <span class="number">85</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> score &gt;= <span class="number">90</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;优秀&quot;</span>)</span><br><span class="line"><span class="keyword">elif</span> score &gt;= <span class="number">80</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;良好&quot;</span>)</span><br><span class="line"><span class="keyword">elif</span> score &gt;= <span class="number">60</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;及格&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;不及格&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 简化写法（三元表达式）</span></span><br><span class="line">result = <span class="string">&quot;及格&quot;</span> <span class="keyword">if</span> score &gt;= <span class="number">60</span> <span class="keyword">else</span> <span class="string">&quot;不及格&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：Python 用缩进表示代码块，不要用 Tab 和空格混用</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-循环语句"><a href="#4-2-循环语句" class="headerlink" title="4.2 循环语句"></a>4.2 循环语句</h3><h4 id="for-循环"><a href="#for-循环" class="headerlink" title="for 循环"></a>for 循环</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 遍历列表</span></span><br><span class="line">fruits = [<span class="string">&quot;苹果&quot;</span>, <span class="string">&quot;香蕉&quot;</span>, <span class="string">&quot;橙子&quot;</span>]</span><br><span class="line"><span class="keyword">for</span> fruit <span class="keyword">in</span> fruits:</span><br><span class="line">    <span class="built_in">print</span>(fruit)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 带索引遍历</span></span><br><span class="line"><span class="keyword">for</span> i, fruit <span class="keyword">in</span> <span class="built_in">enumerate</span>(fruits):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;i&#125;</span>: <span class="subst">&#123;fruit&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 遍历范围</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):        <span class="comment"># 0 到 4</span></span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">6</span>):     <span class="comment"># 1 到 5</span></span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>, <span class="number">2</span>): <span class="comment"># 1, 3, 5, 7, 9（步长为 2）</span></span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 遍历字典</span></span><br><span class="line">person = &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;张三&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">25</span>&#125;</span><br><span class="line"><span class="keyword">for</span> key, value <span class="keyword">in</span> person.items():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;key&#125;</span>: <span class="subst">&#123;value&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="while-循环"><a href="#while-循环" class="headerlink" title="while 循环"></a>while 循环</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">count = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> count &lt; <span class="number">5</span>:</span><br><span class="line">    <span class="built_in">print</span>(count)</span><br><span class="line">    count += <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h4 id="循环控制"><a href="#循环控制" class="headerlink" title="循环控制"></a>循环控制</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># break - 跳出循环</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">5</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="built_in">print</span>(i)  <span class="comment"># 0, 1, 2, 3, 4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># continue - 跳过本次</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="built_in">print</span>(i)  <span class="comment"># 0, 1, 3, 4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># else - 循环正常结束（非 break 退出）时执行</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;循环结束&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="五、函数"><a href="#五、函数" class="headerlink" title="五、函数"></a>五、函数</h2><h3 id="5-1-函数定义"><a href="#5-1-函数定义" class="headerlink" title="5.1 函数定义"></a>5.1 函数定义</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 定义函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">greet</span>(<span class="params">name</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;问候函数&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;Hello, <span class="subst">&#123;name&#125;</span>!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用函数</span></span><br><span class="line">result = greet(<span class="string">&quot;张三&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(result)  <span class="comment"># Hello, 张三！</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 多个返回值</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_person</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;张三&quot;</span>, <span class="number">25</span>, <span class="string">&quot;北京&quot;</span></span><br><span class="line"></span><br><span class="line">name, age, city = get_person()</span><br></pre></td></tr></table></figure>

<h3 id="5-2-函数参数"><a href="#5-2-函数参数" class="headerlink" title="5.2 函数参数"></a>5.2 函数参数</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 位置参数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">describe_pet</span>(<span class="params">pet_name, animal_type</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;animal_type&#125;</span>: <span class="subst">&#123;pet_name&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">describe_pet(<span class="string">&quot;旺财&quot;</span>, <span class="string">&quot;狗&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关键字参数</span></span><br><span class="line">describe_pet(animal_type=<span class="string">&quot;猫&quot;</span>, pet_name=<span class="string">&quot;咪咪&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认参数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">greet</span>(<span class="params">name=<span class="string">&quot;朋友&quot;</span></span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Hello, <span class="subst">&#123;name&#125;</span>!&quot;</span>)</span><br><span class="line"></span><br><span class="line">greet()           <span class="comment"># Hello, 朋友！</span></span><br><span class="line">greet(<span class="string">&quot;张三&quot;</span>)     <span class="comment"># Hello, 张三！</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 可变参数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sum_all</span>(<span class="params">*args</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;接收任意数量的位置参数&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sum</span>(args)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(sum_all(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>))  <span class="comment"># 10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_info</span>(<span class="params">**kwargs</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;接收任意数量的关键字参数&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> key, value <span class="keyword">in</span> kwargs.items():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;key&#125;</span>: <span class="subst">&#123;value&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">print_info(name=<span class="string">&quot;张三&quot;</span>, age=<span class="number">25</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 组合使用</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>(<span class="params">a, b, *args, default=<span class="literal">True</span>, **kwargs</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-Lambda-表达式"><a href="#5-3-Lambda-表达式" class="headerlink" title="5.3 Lambda 表达式"></a>5.3 Lambda 表达式</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 匿名函数</span></span><br><span class="line">square = <span class="keyword">lambda</span> x: x ** <span class="number">2</span></span><br><span class="line"><span class="built_in">print</span>(square(<span class="number">5</span>))  <span class="comment"># 25</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用于排序</span></span><br><span class="line">students = [(<span class="string">&quot;张三&quot;</span>, <span class="number">85</span>), (<span class="string">&quot;李四&quot;</span>, <span class="number">92</span>), (<span class="string">&quot;王五&quot;</span>, <span class="number">78</span>)]</span><br><span class="line">students.sort(key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：lambda 适合简单函数，复杂逻辑还是用 def</span></span><br></pre></td></tr></table></figure>

<h2 id="六、模块与导入"><a href="#六、模块与导入" class="headerlink" title="六、模块与导入"></a>六、模块与导入</h2><h3 id="6-1-导入模块"><a href="#6-1-导入模块" class="headerlink" title="6.1 导入模块"></a>6.1 导入模块</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 导入整个模块</span></span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="built_in">print</span>(math.sqrt(<span class="number">16</span>))  <span class="comment"># 4.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入特定函数</span></span><br><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> sqrt, ceil</span><br><span class="line"><span class="built_in">print</span>(sqrt(<span class="number">16</span>))  <span class="comment"># 4.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入并重命名</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime <span class="keyword">as</span> dt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入所有（不推荐）</span></span><br><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> *</span><br></pre></td></tr></table></figure>

<h3 id="6-2-常用内置模块"><a href="#6-2-常用内置模块" class="headerlink" title="6.2 常用内置模块"></a>6.2 常用内置模块</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># os - 操作系统接口</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">os.getcwd()              <span class="comment"># 当前工作目录</span></span><br><span class="line">os.listdir()             <span class="comment"># 列出目录内容</span></span><br><span class="line">os.path.join(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>)   <span class="comment"># 拼接路径</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># datetime - 日期时间</span></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line">now = datetime.now()</span><br><span class="line">tomorrow = now + timedelta(days=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># random - 随机数</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line">random.random()          <span class="comment"># 0-1 随机浮点数</span></span><br><span class="line">random.randint(<span class="number">1</span>, <span class="number">10</span>)    <span class="comment"># 1-10 随机整数</span></span><br><span class="line">random.choice([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]) <span class="comment"># 随机选择</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># json - JSON 处理</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">json.dumps(&#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>&#125;)     <span class="comment"># 字典转 JSON 字符串</span></span><br><span class="line">json.loads(<span class="string">&#x27;&#123;&quot;a&quot;: 1&#125;&#x27;</span>)   <span class="comment"># JSON 字符串转字典</span></span><br></pre></td></tr></table></figure>

<h2 id="七、文件操作"><a href="#七、文件操作" class="headerlink" title="七、文件操作"></a>七、文件操作</h2><h3 id="7-1-读写文件"><a href="#7-1-读写文件" class="headerlink" title="7.1 读写文件"></a>7.1 读写文件</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 写入文件</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;w&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="string">&quot;Hello, World!\n&quot;</span>)</span><br><span class="line">    f.write(<span class="string">&quot;第二行\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取文件</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    content = f.read()      <span class="comment"># 读取全部内容</span></span><br><span class="line">    <span class="built_in">print</span>(content)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 逐行读取</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">        <span class="built_in">print</span>(line.strip())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取所有行</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    lines = f.readlines()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - 务必使用 with 语句，自动关闭文件</span></span><br><span class="line"><span class="comment"># - 指定 encoding=&#x27;utf-8&#x27; 避免中文乱码</span></span><br><span class="line"><span class="comment"># - 模式：&#x27;r&#x27; 读取，&#x27;w&#x27; 写入（覆盖），&#x27;a&#x27; 追加，&#x27;b&#x27; 二进制</span></span><br></pre></td></tr></table></figure>

<h2 id="八、实践建议"><a href="#八、实践建议" class="headerlink" title="八、实践建议"></a>八、实践建议</h2><blockquote>
<p><strong>提醒自己</strong>：</p>
<ol>
<li><strong>多动手写代码</strong>：看十遍不如写一遍</li>
<li><strong>善用调试</strong>：用 print() 或断点调试理解代码执行</li>
<li><strong>阅读错误信息</strong>：Python 的错误信息很友好，仔细阅读能找到问题</li>
<li><strong>代码规范</strong>：遵循 PEP 8 规范，变量命名要有意义</li>
<li><strong>写注释</strong>：关键逻辑要写注释，但不要注释显而易见的代码</li>
</ol>
</blockquote>
<h2 id="九、练习"><a href="#九、练习" class="headerlink" title="九、练习"></a>九、练习</h2><ol>
<li>编写程序，计算 1 到 100 的和</li>
<li>编写函数，判断一个数是否为素数</li>
<li>编写程序，统计字符串中每个字符出现的次数</li>
<li>编写函数，将列表中的重复元素去重</li>
<li>读取一个文件，统计文件行数</li>
</ol>
<hr>
<p><strong>下一篇</strong>：<a href="/2026/02/24/Python-%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B%EF%BC%88%E4%BA%8C%EF%BC%89%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%BC%96%E7%A8%8B/">Python 基础教程（二）：面向对象编程</a></p>
<p><strong>参考资源</strong>：</p>
<ul>
<li><a href="https://docs.python.org/zh-cn/3/">Python 官方文档</a></li>
<li><a href="https://www.liaoxuefeng.com/wiki/1016959663602400">Python 入门教程</a></li>
<li><a href="https://peps.python.org/pep-0008/">PEP 8 代码风格指南</a></li>
</ul>
]]></content>
      <categories>
        <category>Python 教程</category>
      </categories>
      <tags>
        <tag>入门教程</tag>
        <tag>Python</tag>
        <tag>基础语法</tag>
      </tags>
  </entry>
  <entry>
    <title>Python 基础教程（二）面向对象编程</title>
    <url>/2026/02/24/Python%20%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B%EF%BC%88%E4%BA%8C%EF%BC%89%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%BC%96%E7%A8%8B/</url>
    <content><![CDATA[<h1 id="Python-基础教程（二）面向对象编程"><a href="#Python-基础教程（二）面向对象编程" class="headerlink" title="Python 基础教程（二）面向对象编程"></a>Python 基础教程（二）面向对象编程</h1><p>面向对象编程（OOP）是 Python 的核心编程范式之一。本篇将详细介绍 Python 中的类与对象、继承、多态等核心概念。</p>
<h2 id="一、面向对象基础"><a href="#一、面向对象基础" class="headerlink" title="一、面向对象基础"></a>一、面向对象基础</h2><h3 id="1-1-什么是面向对象？"><a href="#1-1-什么是面向对象？" class="headerlink" title="1.1 什么是面向对象？"></a>1.1 什么是面向对象？</h3><p><strong>面向对象编程（Object-Oriented Programming, OOP）</strong> 是一种编程范式，它将数据和处理数据的方法封装在一起，形成”对象”。</p>
<p><strong>核心概念：</strong></p>
<ul>
<li><strong>类（Class）</strong>：对象的模板&#x2F;蓝图，定义对象的属性和方法</li>
<li><strong>对象（Object）</strong>：类的实例，具体的实体</li>
<li><strong>属性（Attribute）</strong>：对象的特征&#x2F;数据</li>
<li><strong>方法（Method）</strong>：对象的行为&#x2F;操作</li>
</ul>
<p><strong>比喻理解：</strong></p>
<ul>
<li>类 &#x3D; 房屋设计图</li>
<li>对象 &#x3D; 根据设计图建造的具体房屋</li>
</ul>
<h3 id="1-2-为什么使用面向对象？"><a href="#1-2-为什么使用面向对象？" class="headerlink" title="1.2 为什么使用面向对象？"></a>1.2 为什么使用面向对象？</h3><blockquote>
<p><strong>提醒自己</strong>：</p>
<ul>
<li><strong>代码复用</strong>：继承机制减少重复代码</li>
<li><strong>易于维护</strong>：封装使代码结构清晰</li>
<li><strong>模块化</strong>：不同对象独立工作，降低耦合</li>
<li><strong>模拟现实</strong>：更符合人类思维方式</li>
</ul>
</blockquote>
<h2 id="二、类的定义与使用"><a href="#二、类的定义与使用" class="headerlink" title="二、类的定义与使用"></a>二、类的定义与使用</h2><h3 id="2-1-定义类"><a href="#2-1-定义类" class="headerlink" title="2.1 定义类"></a>2.1 定义类</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;人类&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 类属性（所有实例共享）</span></span><br><span class="line">    species = <span class="string">&quot;Homo sapiens&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 构造方法（初始化方法）</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, age</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        初始化 Person 对象</span></span><br><span class="line"><span class="string">        :param name: 姓名</span></span><br><span class="line"><span class="string">        :param age: 年龄</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 实例属性（每个实例独立）</span></span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        <span class="variable language_">self</span>.age = age</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 实例方法</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">greet</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;问候&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;你好，我是<span class="subst">&#123;self.name&#125;</span>！&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">birthday</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;过生日，年龄 +1&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.age += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;我<span class="subst">&#123;self.age&#125;</span>岁了！&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 类方法</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_species</span>(<span class="params">cls</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取物种&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> cls.species</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 静态方法</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_adult</span>(<span class="params">age</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;判断是否成年&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> age &gt;= <span class="number">18</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建对象</span></span><br><span class="line">p1 = Person(<span class="string">&quot;张三&quot;</span>, <span class="number">25</span>)</span><br><span class="line">p2 = Person(<span class="string">&quot;李四&quot;</span>, <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问属性</span></span><br><span class="line"><span class="built_in">print</span>(p1.name)        <span class="comment"># 张三</span></span><br><span class="line"><span class="built_in">print</span>(p2.age)         <span class="comment"># 30</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用方法</span></span><br><span class="line"><span class="built_in">print</span>(p1.greet())     <span class="comment"># 你好，我是张三！</span></span><br><span class="line">p1.birthday()         <span class="comment"># 我 26 岁了！</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问类属性</span></span><br><span class="line"><span class="built_in">print</span>(Person.species)     <span class="comment"># Homo sapiens</span></span><br><span class="line"><span class="built_in">print</span>(p1.species)         <span class="comment"># Homo sapiens（实例也能访问）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用类方法</span></span><br><span class="line"><span class="built_in">print</span>(Person.get_species())  <span class="comment"># Homo sapiens</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用静态方法</span></span><br><span class="line"><span class="built_in">print</span>(Person.is_adult(<span class="number">20</span>))   <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(Person.is_adult(<span class="number">15</span>))   <span class="comment"># False</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-self-参数"><a href="#2-2-self-参数" class="headerlink" title="2.2 self 参数"></a>2.2 self 参数</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">method</span>(<span class="params">instance_self, arg</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        self 只是一个约定俗成的名字</span></span><br><span class="line"><span class="string">        第一个参数始终代表实例本身</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;实例：<span class="subst">&#123;instance_self&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;参数：<span class="subst">&#123;arg&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># self 在调用时自动传入，不需要手动传递</span></span><br><span class="line">obj = MyClass()</span><br><span class="line">obj.method(<span class="string">&quot;hello&quot;</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>提醒自己</strong>：</p>
<ul>
<li><code>self</code> 是实例方法的第一个参数，代表调用该方法的对象</li>
<li><code>self</code> 是约定俗成的命名，可以用其他名字但不推荐</li>
<li>类方法的第一个参数是 <code>cls</code>，代表类本身</li>
<li>静态方法不需要 <code>self</code> 或 <code>cls</code></li>
</ul>
</blockquote>
<h3 id="2-3-属性封装"><a href="#2-3-属性封装" class="headerlink" title="2.3 属性封装"></a>2.3 属性封装</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BankAccount</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;银行账户&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, owner, balance=<span class="number">0</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.owner = owner</span><br><span class="line">        <span class="variable language_">self</span>.__balance = balance  <span class="comment"># 私有属性（双下划线开头）</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">deposit</span>(<span class="params">self, amount</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;存款&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> amount &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="variable language_">self</span>.__balance += amount</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f&quot;存入<span class="subst">&#123;amount&#125;</span>，余额<span class="subst">&#123;self.__balance&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;存款金额必须大于 0&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">withdraw</span>(<span class="params">self, amount</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;取款&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> amount &gt; <span class="variable language_">self</span>.__balance:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;余额不足&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.__balance -= amount</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;取出<span class="subst">&#123;amount&#125;</span>，余额<span class="subst">&#123;self.__balance&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_balance</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;查询余额（只读访问）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.__balance</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 使用@property 装饰器</span></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">balance</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;getter 方法&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.__balance</span><br><span class="line"></span><br><span class="line"><span class="meta">    @balance.setter</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">balance</span>(<span class="params">self, value</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;setter 方法&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> value &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;余额不能为负数&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.__balance = value</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line">account = BankAccount(<span class="string">&quot;张三&quot;</span>, <span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不能直接访问私有属性</span></span><br><span class="line"><span class="comment"># print(account.__balance)  # AttributeError!</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过方法访问</span></span><br><span class="line"><span class="built_in">print</span>(account.get_balance())  <span class="comment"># 1000</span></span><br><span class="line"><span class="built_in">print</span>(account.deposit(<span class="number">500</span>))   <span class="comment"># 存入 500，余额 1500</span></span><br><span class="line"><span class="built_in">print</span>(account.withdraw(<span class="number">200</span>))  <span class="comment"># 取出 200，余额 1300</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用@property</span></span><br><span class="line"><span class="built_in">print</span>(account.balance)  <span class="comment"># 1300（像访问属性一样）</span></span><br><span class="line">account.balance = <span class="number">2000</span>  <span class="comment"># 调用 setter</span></span><br><span class="line"><span class="built_in">print</span>(account.balance)  <span class="comment"># 2000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - 单下划线 _attr：约定俗成的&quot;保护&quot;属性（外部仍可访问）</span></span><br><span class="line"><span class="comment"># - 双下划线 __attr：私有属性（名称修饰，外部无法直接访问）</span></span><br></pre></td></tr></table></figure>

<h2 id="三、继承"><a href="#三、继承" class="headerlink" title="三、继承"></a>三、继承</h2><h3 id="3-1-基础继承"><a href="#3-1-基础继承" class="headerlink" title="3.1 基础继承"></a>3.1 基础继承</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 父类（基类）</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;动物类&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">speak</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;说话&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;...&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">info</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;信息&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;我是<span class="subst">&#123;self.name&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 子类（派生类）</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dog</span>(<span class="title class_ inherited__">Animal</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;狗类&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, breed</span>):</span><br><span class="line">        <span class="comment"># 调用父类构造方法</span></span><br><span class="line">        <span class="built_in">super</span>().__init__(name)</span><br><span class="line">        <span class="variable language_">self</span>.breed = breed  <span class="comment"># 新增属性</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 重写父类方法</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">speak</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;汪汪汪！&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 新增方法</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">fetch</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;捡球&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Cat</span>(<span class="title class_ inherited__">Animal</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;猫类&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">speak</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;喵喵喵！&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line">dog = Dog(<span class="string">&quot;旺财&quot;</span>, <span class="string">&quot;金毛&quot;</span>)</span><br><span class="line">cat = Cat(<span class="string">&quot;咪咪&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(dog.info())    <span class="comment"># 我是旺财（继承自父类）</span></span><br><span class="line"><span class="built_in">print</span>(dog.speak())   <span class="comment"># 汪汪汪！（重写）</span></span><br><span class="line"><span class="built_in">print</span>(dog.fetch())   <span class="comment"># 捡球（子类特有）</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(cat.info())    <span class="comment"># 我是咪咪</span></span><br><span class="line"><span class="built_in">print</span>(cat.speak())   <span class="comment"># 喵喵喵！</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断类型</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>(dog, Dog))    <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>(dog, Animal)) <span class="comment"># True（狗也是动物）</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>(cat, Dog))    <span class="comment"># False</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-多重继承"><a href="#3-2-多重继承" class="headerlink" title="3.2 多重继承"></a>3.2 多重继承</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Flyable</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;会飞的&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">fly</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;我会飞！&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Swimmable</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;会游泳的&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">swim</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;我会游泳！&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Duck</span>(Flyable, Swimmable):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;鸭子&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">speak</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;嘎嘎嘎！&quot;</span></span><br><span class="line"></span><br><span class="line">duck = Duck(<span class="string">&quot;唐老鸭&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(duck.speak())  <span class="comment"># 嘎嘎嘎！</span></span><br><span class="line"><span class="built_in">print</span>(duck.fly())    <span class="comment"># 我会飞！</span></span><br><span class="line"><span class="built_in">print</span>(duck.swim())   <span class="comment"># 我会游泳！</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看继承顺序（MRO）</span></span><br><span class="line"><span class="built_in">print</span>(Duck.__mro__)</span><br><span class="line"><span class="comment"># (&lt;class &#x27;Duck&#x27;&gt;, &lt;class &#x27;Flyable&#x27;&gt;, &lt;class &#x27;Swimmable&#x27;&gt;, &lt;class &#x27;object&#x27;&gt;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - 多重继承可能导致&quot;菱形问题&quot;</span></span><br><span class="line"><span class="comment"># - Python 使用 C3 算法确定方法解析顺序（MRO）</span></span><br><span class="line"><span class="comment"># - 能用组合解决的就不要用多重继承</span></span><br></pre></td></tr></table></figure>

<h3 id="3-3-super-的使用"><a href="#3-3-super-的使用" class="headerlink" title="3.3 super() 的使用"></a>3.3 super() 的使用</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Parent</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Parent: <span class="subst">&#123;name&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Child</span>(<span class="title class_ inherited__">Parent</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, age</span>):</span><br><span class="line">        <span class="comment"># 调用父类的__init__</span></span><br><span class="line">        <span class="built_in">super</span>().__init__(name)</span><br><span class="line">        <span class="variable language_">self</span>.age = age</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Child: <span class="subst">&#123;name&#125;</span>, <span class="subst">&#123;age&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">c = Child(<span class="string">&quot;张三&quot;</span>, <span class="number">10</span>)</span><br><span class="line"><span class="comment"># 输出：</span></span><br><span class="line"><span class="comment"># Parent: 张三</span></span><br><span class="line"><span class="comment"># Child: 张三，10</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>提醒自己</strong>：</p>
<ul>
<li><code>super()</code> 用于调用父类方法</li>
<li>在多重继承中，<code>super()</code> 按照 MRO 顺序调用</li>
<li>始终使用 <code>super()</code> 而不是直接调用父类名</li>
</ul>
</blockquote>
<h2 id="四、多态"><a href="#四、多态" class="headerlink" title="四、多态"></a>四、多态</h2><h3 id="4-1-什么是多态？"><a href="#4-1-什么是多态？" class="headerlink" title="4.1 什么是多态？"></a>4.1 什么是多态？</h3><p><strong>多态（Polymorphism）</strong> 指同一个接口可以作用于不同的对象。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Dog</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">speak</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;汪汪！&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Cat</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">speak</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;喵喵！&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Duck</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">speak</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;嘎嘎！&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 多态函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">animal_sound</span>(<span class="params">animal</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;不关心对象类型，只关心对象是否有 speak 方法&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(animal.speak())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不同的对象，相同的接口</span></span><br><span class="line">animals = [Dog(), Cat(), Duck()]</span><br><span class="line"><span class="keyword">for</span> animal <span class="keyword">in</span> animals:</span><br><span class="line">    animal_sound(animal)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出：</span></span><br><span class="line"><span class="comment"># 汪汪！</span></span><br><span class="line"><span class="comment"># 喵喵！</span></span><br><span class="line"><span class="comment"># 嘎嘎！</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-Python-的”鸭子类型”"><a href="#4-2-Python-的”鸭子类型”" class="headerlink" title="4.2 Python 的”鸭子类型”"></a>4.2 Python 的”鸭子类型”</h3><blockquote>
<p>“如果走起来像鸭子，叫起来像鸭子，那它就是鸭子。”</p>
</blockquote>
<p>Python 不关心对象的类型，只关心对象是否有需要的方法&#x2F;属性。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 不检查类型，只检查方法</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_sound</span>(<span class="params">obj</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">hasattr</span>(obj, <span class="string">&#x27;speak&#x27;</span>):</span><br><span class="line">        <span class="built_in">print</span>(obj.speak())</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;这个对象不会说话&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 任何有 speak 方法的对象都可以</span></span><br><span class="line">make_sound(Dog())  <span class="comment"># 汪汪！</span></span><br><span class="line">make_sound(Cat())  <span class="comment"># 喵喵！</span></span><br></pre></td></tr></table></figure>

<h2 id="五、特殊方法（魔术方法）"><a href="#五、特殊方法（魔术方法）" class="headerlink" title="五、特殊方法（魔术方法）"></a>五、特殊方法（魔术方法）</h2><h3 id="5-1-字符串表示"><a href="#5-1-字符串表示" class="headerlink" title="5.1 字符串表示"></a>5.1 字符串表示</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, age</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        <span class="variable language_">self</span>.age = age</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;用户看到的字符串表示（print() 时使用）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;<span class="subst">&#123;self.name&#125;</span>，<span class="subst">&#123;self.age&#125;</span>岁&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;开发者看到的字符串表示（交互式命令行/调试时使用）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;Person(&#x27;<span class="subst">&#123;self.name&#125;</span>&#x27;, <span class="subst">&#123;self.age&#125;</span>)&quot;</span></span><br><span class="line"></span><br><span class="line">p = Person(<span class="string">&quot;张三&quot;</span>, <span class="number">25</span>)</span><br><span class="line"><span class="built_in">print</span>(p)          <span class="comment"># 张三，25 岁（调用__str__）</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">repr</span>(p))    <span class="comment"># Person(&#x27;张三&#x27;, 25)（调用__repr__）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - __str__ 给用户看，应该友好易读</span></span><br><span class="line"><span class="comment"># - __repr__ 给开发者看，应该精确无歧义（理想情况下 eval(repr(obj)) == obj）</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-数值运算"><a href="#5-2-数值运算" class="headerlink" title="5.2 数值运算"></a>5.2 数值运算</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Vector</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;二维向量&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, x, y</span>):</span><br><span class="line">        <span class="variable language_">self</span>.x = x</span><br><span class="line">        <span class="variable language_">self</span>.y = y</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__add__</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;向量相加 v1 + v2&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> Vector(<span class="variable language_">self</span>.x + other.x, <span class="variable language_">self</span>.y + other.y)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__sub__</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;向量相减 v1 - v2&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> Vector(<span class="variable language_">self</span>.x - other.x, <span class="variable language_">self</span>.y - other.y)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__mul__</span>(<span class="params">self, scalar</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;数乘 v * n&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> Vector(<span class="variable language_">self</span>.x * scalar, <span class="variable language_">self</span>.y * scalar)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__eq__</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;相等判断 v1 == v2&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.x == other.x <span class="keyword">and</span> <span class="variable language_">self</span>.y == other.y</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;向量长度（模）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">int</span>((<span class="variable language_">self</span>.x ** <span class="number">2</span> + <span class="variable language_">self</span>.y ** <span class="number">2</span>) ** <span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;Vector(<span class="subst">&#123;self.x&#125;</span>, <span class="subst">&#123;self.y&#125;</span>)&quot;</span></span><br><span class="line"></span><br><span class="line">v1 = Vector(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">v2 = Vector(<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(v1 + v2)   <span class="comment"># Vector(4, 6)</span></span><br><span class="line"><span class="built_in">print</span>(v1 - v2)   <span class="comment"># Vector(-2, -2)</span></span><br><span class="line"><span class="built_in">print</span>(v1 * <span class="number">3</span>)    <span class="comment"># Vector(3, 6)</span></span><br><span class="line"><span class="built_in">print</span>(v1 == v2)  <span class="comment"># False</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(v1))   <span class="comment"># 2（向下取整）</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-常用魔术方法"><a href="#5-3-常用魔术方法" class="headerlink" title="5.3 常用魔术方法"></a>5.3 常用魔术方法</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyList</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;自定义列表&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, items</span>):</span><br><span class="line">        <span class="variable language_">self</span>.items = items</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;len(obj)&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(<span class="variable language_">self</span>.items)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, index</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;obj[index]&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.items[index]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__setitem__</span>(<span class="params">self, index, value</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;obj[index] = value&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.items[index] = value</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__delitem__</span>(<span class="params">self, index</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;del obj[index]&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">del</span> <span class="variable language_">self</span>.items[index]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;迭代器&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">iter</span>(<span class="variable language_">self</span>.items)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__contains__</span>(<span class="params">self, item</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;item in obj&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> item <span class="keyword">in</span> <span class="variable language_">self</span>.items</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, *args</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;obj() 使对象可调用&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;被调用了！参数：<span class="subst">&#123;args&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="六、抽象基类（ABC）"><a href="#六、抽象基类（ABC）" class="headerlink" title="六、抽象基类（ABC）"></a>六、抽象基类（ABC）</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC, abstractmethod</span><br><span class="line"></span><br><span class="line"><span class="comment"># 抽象基类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Shape</span>(<span class="title class_ inherited__">ABC</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;形状抽象基类&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">area</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;计算面积（必须由子类实现）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">perimeter</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;计算周长（必须由子类实现）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 普通方法（子类可继承）</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">describe</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;我是一个形状&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 具体实现</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Rectangle</span>(<span class="title class_ inherited__">Shape</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, width, height</span>):</span><br><span class="line">        <span class="variable language_">self</span>.width = width</span><br><span class="line">        <span class="variable language_">self</span>.height = height</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">area</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.width * <span class="variable language_">self</span>.height</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">perimeter</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span> * (<span class="variable language_">self</span>.width + <span class="variable language_">self</span>.height)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Circle</span>(<span class="title class_ inherited__">Shape</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, radius</span>):</span><br><span class="line">        <span class="variable language_">self</span>.radius = radius</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">area</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3.14159</span> * <span class="variable language_">self</span>.radius ** <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">perimeter</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span> * <span class="number">3.14159</span> * <span class="variable language_">self</span>.radius</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line">rect = Rectangle(<span class="number">5</span>, <span class="number">3</span>)</span><br><span class="line">circle = Circle(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(rect.area())        <span class="comment"># 15</span></span><br><span class="line"><span class="built_in">print</span>(circle.area())      <span class="comment"># 50.27</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 不能实例化抽象基类</span></span><br><span class="line"><span class="comment"># shape = Shape()  # TypeError!</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - ABC 强制子类实现指定方法</span></span><br><span class="line"><span class="comment"># - 适合定义接口/规范</span></span><br><span class="line"><span class="comment"># - @abstractmethod 装饰的方法必须被子类重写</span></span><br></pre></td></tr></table></figure>

<h2 id="七、类与实例的关系总结"><a href="#七、类与实例的关系总结" class="headerlink" title="七、类与实例的关系总结"></a>七、类与实例的关系总结</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span>:</span><br><span class="line">    class_attr = <span class="string">&quot;我是类属性&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.instance_attr = <span class="string">&quot;我是实例属性&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">class_method</span>(<span class="params">cls</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;类方法，访问：<span class="subst">&#123;cls.class_attr&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">static_method</span>():</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;静态方法，不访问类或实例&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">instance_method</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;实例方法，访问：<span class="subst">&#123;self.instance_attr&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 类属性 vs 实例属性</span></span><br><span class="line">obj1 = MyClass()</span><br><span class="line">obj2 = MyClass()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(MyClass.class_attr)  <span class="comment"># 类属性（所有实例共享）</span></span><br><span class="line"><span class="built_in">print</span>(obj1.instance_attr)  <span class="comment"># 实例属性（每个实例独立）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改类属性</span></span><br><span class="line">MyClass.class_attr = <span class="string">&quot;新的类属性&quot;</span></span><br><span class="line"><span class="built_in">print</span>(obj2.class_attr)  <span class="comment"># 新的类属性</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - 类属性：所有实例共享，通过类或实例访问</span></span><br><span class="line"><span class="comment"># - 实例属性：每个实例独立，只能通过实例访问</span></span><br><span class="line"><span class="comment"># - 类方法：用@classmethod，第一个参数是 cls</span></span><br><span class="line"><span class="comment"># - 静态方法：用@staticmethod，不需要 cls 或 self</span></span><br><span class="line"><span class="comment"># - 实例方法：默认，第一个参数是 self</span></span><br></pre></td></tr></table></figure>

<h2 id="八、实践建议"><a href="#八、实践建议" class="headerlink" title="八、实践建议"></a>八、实践建议</h2><blockquote>
<p><strong>提醒自己</strong>：</p>
<ol>
<li><strong>优先使用组合而非继承</strong>：组合更灵活，继承层次不要太深</li>
<li><strong>遵循单一职责原则</strong>：一个类只做一件事</li>
<li><strong>善用封装</strong>：私有属性保护数据，提供公共接口访问</li>
<li><strong>不要过度设计</strong>：简单的脚本不需要类</li>
<li><strong>理解 Python 的哲学</strong>：约定优于强制</li>
</ol>
</blockquote>
<h2 id="九、练习"><a href="#九、练习" class="headerlink" title="九、练习"></a>九、练习</h2><ol>
<li>定义一个 <code>Student</code> 类，包含姓名、学号、成绩等属性，以及计算平均分的方法</li>
<li>定义 <code>Teacher</code> 类，继承自 <code>Person</code> 类，添加工资、所教科目等属性</li>
<li>实现一个简易的栈（Stack）类，支持 push、pop、peek 操作</li>
<li>使用继承实现一个图形计算器，支持计算矩形、圆形、三角形的面积</li>
<li>实现一个上下文管理器类，用于自动关闭文件</li>
</ol>
<hr>
<p><strong>上一篇</strong>：<a href="/2026/02/24/Python-%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B%EF%BC%88%E4%B8%80%EF%BC%89%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95%E5%85%A5%E9%97%A8/">Python 基础教程（一）：基础语法入门</a></p>
<p><strong>下一篇</strong>：<a href="/2026/02/24/Python-%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B%EF%BC%88%E4%B8%89%EF%BC%89%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/">Python 基础教程（三）：异常处理</a></p>
<p><strong>参考资源</strong>：</p>
<ul>
<li><a href="https://docs.python.org/zh-cn/3/tutorial/classes.html">Python 官方文档 - 类</a></li>
<li><a href="https://docs.python.org/zh-cn/3/reference/datamodel.html">Python 官方文档 - 数据模型</a></li>
</ul>
]]></content>
      <categories>
        <category>Python 教程</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>面向对象</tag>
        <tag>类与对象</tag>
      </tags>
  </entry>
  <entry>
    <title>Python 常用库（三）logging 日志模块</title>
    <url>/2026/02/24/Python%20%E5%B8%B8%E7%94%A8%E5%BA%93%EF%BC%88%E4%B8%89%EF%BC%89logging%20%E6%97%A5%E5%BF%97%E6%A8%A1%E5%9D%97/</url>
    <content><![CDATA[<h1 id="Python-常用库（三）logging-日志模块"><a href="#Python-常用库（三）logging-日志模块" class="headerlink" title="Python 常用库（三）logging 日志模块"></a>Python 常用库（三）logging 日志模块</h1><p>日志是程序调试、监控和问题排查的重要工具。本篇将详细介绍 Python 内置的 logging 模块。</p>
<h2 id="一、logging-简介"><a href="#一、logging-简介" class="headerlink" title="一、logging 简介"></a>一、logging 简介</h2><h3 id="1-1-为什么使用-logging？"><a href="#1-1-为什么使用-logging？" class="headerlink" title="1.1 为什么使用 logging？"></a>1.1 为什么使用 logging？</h3><ul>
<li><strong>标准库</strong>：无需安装，开箱即用</li>
<li><strong>灵活配置</strong>：可配置输出格式、级别、目标等</li>
<li><strong>高性能</strong>：内置优化，适合生产环境</li>
<li><strong>可扩展</strong>：支持自定义 Handler、Formatter、Filter</li>
</ul>
<h3 id="1-2-日志级别"><a href="#1-2-日志级别" class="headerlink" title="1.2 日志级别"></a>1.2 日志级别</h3><table>
<thead>
<tr>
<th>级别</th>
<th>数值</th>
<th>说明</th>
<th>使用场景</th>
</tr>
</thead>
<tbody><tr>
<td>DEBUG</td>
<td>10</td>
<td>调试信息</td>
<td>开发调试时的详细信息</td>
</tr>
<tr>
<td>INFO</td>
<td>20</td>
<td>一般信息</td>
<td>程序正常运行的信息</td>
</tr>
<tr>
<td>WARNING</td>
<td>30</td>
<td>警告信息</td>
<td>不影响运行但需要注意</td>
</tr>
<tr>
<td>ERROR</td>
<td>40</td>
<td>错误信息</td>
<td>程序错误但不影响继续运行</td>
</tr>
<tr>
<td>CRITICAL</td>
<td>50</td>
<td>严重错误</td>
<td>严重错误，程序可能无法继续</td>
</tr>
</tbody></table>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line">logging.debug(<span class="string">&quot;调试信息&quot;</span>)</span><br><span class="line">logging.info(<span class="string">&quot;一般信息&quot;</span>)</span><br><span class="line">logging.warning(<span class="string">&quot;警告信息&quot;</span>)</span><br><span class="line">logging.error(<span class="string">&quot;错误信息&quot;</span>)</span><br><span class="line">logging.critical(<span class="string">&quot;严重错误&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="二、基础使用"><a href="#二、基础使用" class="headerlink" title="二、基础使用"></a>二、基础使用</h2><h3 id="2-1-快速开始"><a href="#2-1-快速开始" class="headerlink" title="2.1 快速开始"></a>2.1 快速开始</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="comment"># 基础配置</span></span><br><span class="line">logging.basicConfig(</span><br><span class="line">    level=logging.INFO,</span><br><span class="line">    <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#x27;</span>,</span><br><span class="line">    datefmt=<span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 记录日志</span></span><br><span class="line">logging.info(<span class="string">&quot;程序启动&quot;</span>)</span><br><span class="line">logging.warning(<span class="string">&quot;这是一个警告&quot;</span>)</span><br><span class="line">logging.error(<span class="string">&quot;发生了一个错误&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出：</span></span><br><span class="line"><span class="comment"># 2026-02-24 10:00:00 - root - INFO - 程序启动</span></span><br><span class="line"><span class="comment"># 2026-02-24 10:00:00 - root - WARNING - 这是一个警告</span></span><br><span class="line"><span class="comment"># 2026-02-24 10:00:00 - root - ERROR - 发生了一个错误</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-日志输出目标"><a href="#2-2-日志输出目标" class="headerlink" title="2.2 日志输出目标"></a>2.2 日志输出目标</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出到控制台（默认）</span></span><br><span class="line">logging.info(<span class="string">&quot;输出到控制台&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出到文件</span></span><br><span class="line">logging.basicConfig(</span><br><span class="line">    filename=<span class="string">&#x27;app.log&#x27;</span>,</span><br><span class="line">    level=logging.INFO,</span><br><span class="line">    filemode=<span class="string">&#x27;a&#x27;</span>,  <span class="comment"># &#x27;a&#x27; 追加，&#x27;w&#x27; 覆盖</span></span><br><span class="line">    encoding=<span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">logging.info(<span class="string">&quot;输出到文件&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - basicConfig 只能在第一次调用时生效</span></span><br><span class="line"><span class="comment"># - 多次调用需要更复杂的配置</span></span><br></pre></td></tr></table></figure>

<h2 id="三、核心组件"><a href="#三、核心组件" class="headerlink" title="三、核心组件"></a>三、核心组件</h2><h3 id="3-1-Logger（记录器）"><a href="#3-1-Logger（记录器）" class="headerlink" title="3.1 Logger（记录器）"></a>3.1 Logger（记录器）</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取 Logger</span></span><br><span class="line">logger = logging.getLogger(__name__)  <span class="comment"># 推荐使用模块名</span></span><br><span class="line">logger = logging.getLogger(<span class="string">&#x27;myapp&#x27;</span>)   <span class="comment"># 或使用自定义名</span></span><br><span class="line">logger = logging.getLogger()          <span class="comment"># root logger</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置日志级别</span></span><br><span class="line">logger.setLevel(logging.DEBUG)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 记录日志</span></span><br><span class="line">logger.debug(<span class="string">&quot;调试信息&quot;</span>)</span><br><span class="line">logger.info(<span class="string">&quot;一般信息&quot;</span>)</span><br><span class="line">logger.warning(<span class="string">&quot;警告信息&quot;</span>)</span><br><span class="line">logger.error(<span class="string">&quot;错误信息&quot;</span>)</span><br><span class="line">logger.critical(<span class="string">&quot;严重错误&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 带异常的日志</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    result = <span class="number">10</span> / <span class="number">0</span></span><br><span class="line"><span class="keyword">except</span> ZeroDivisionError:</span><br><span class="line">    logger.exception(<span class="string">&quot;除零错误&quot;</span>)  <span class="comment"># 自动记录堆栈</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-Handler（处理器）"><a href="#3-2-Handler（处理器）" class="headerlink" title="3.2 Handler（处理器）"></a>3.2 Handler（处理器）</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(<span class="string">&#x27;myapp&#x27;</span>)</span><br><span class="line">logger.setLevel(logging.DEBUG)  <span class="comment"># Logger 级别设低</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 控制台 Handler（只输出 INFO 及以上）</span></span><br><span class="line">console_handler = logging.StreamHandler()</span><br><span class="line">console_handler.setLevel(logging.INFO)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件 Handler（输出所有级别）</span></span><br><span class="line">file_handler = logging.FileHandler(<span class="string">&#x27;app.log&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">file_handler.setLevel(logging.DEBUG)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加到 Logger</span></span><br><span class="line">logger.addHandler(console_handler)</span><br><span class="line">logger.addHandler(file_handler)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 移除 Handler</span></span><br><span class="line">logger.removeHandler(file_handler)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - Logger 级别决定哪些日志被处理</span></span><br><span class="line"><span class="comment"># - Handler 级别决定哪些日志被输出</span></span><br><span class="line"><span class="comment"># - 日志需要同时通过 Logger 和 Handler 的级别检查</span></span><br></pre></td></tr></table></figure>

<h3 id="3-3-Formatter（格式化器）"><a href="#3-3-Formatter（格式化器）" class="headerlink" title="3.3 Formatter（格式化器）"></a>3.3 Formatter（格式化器）</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(<span class="string">&#x27;myapp&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 Formatter</span></span><br><span class="line">formatter = logging.Formatter(</span><br><span class="line">    fmt=<span class="string">&#x27;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#x27;</span>,</span><br><span class="line">    datefmt=<span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 常用格式参数：</span></span><br><span class="line"><span class="comment"># %(name)s       Logger 名称</span></span><br><span class="line"><span class="comment"># %(levelname)s  日志级别</span></span><br><span class="line"><span class="comment"># %(message)s    日志消息</span></span><br><span class="line"><span class="comment"># %(asctime)s    时间戳</span></span><br><span class="line"><span class="comment"># %(filename)s   文件名</span></span><br><span class="line"><span class="comment"># %(lineno)d     行号</span></span><br><span class="line"><span class="comment"># %(funcName)s   函数名</span></span><br><span class="line"><span class="comment"># %(threadName)s 线程名</span></span><br><span class="line"><span class="comment"># %(process)d    进程 ID</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 更详细的格式</span></span><br><span class="line">detailed_formatter = logging.Formatter(</span><br><span class="line">    fmt=<span class="string">&#x27;%(asctime)s - %(name)s - %(levelname)s [%(filename)s:%(lineno)d - %(funcName)s()] - %(message)s&#x27;</span>,</span><br><span class="line">    datefmt=<span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用到 Handler</span></span><br><span class="line">console_handler = logging.StreamHandler()</span><br><span class="line">console_handler.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line">file_handler = logging.FileHandler(<span class="string">&#x27;app.log&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">file_handler.setFormatter(detailed_formatter)</span><br><span class="line"></span><br><span class="line">logger.addHandler(console_handler)</span><br><span class="line">logger.addHandler(file_handler)</span><br></pre></td></tr></table></figure>

<h3 id="3-4-Filter（过滤器）"><a href="#3-4-Filter（过滤器）" class="headerlink" title="3.4 Filter（过滤器）"></a>3.4 Filter（过滤器）</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LevelFilter</span>(logging.Filter):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;只记录特定级别&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, level</span>):</span><br><span class="line">        <span class="variable language_">self</span>.level = level</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">filter</span>(<span class="params">self, record</span>):</span><br><span class="line">        <span class="keyword">return</span> record.levelno == <span class="variable language_">self</span>.level</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只记录 ERROR 级别</span></span><br><span class="line">error_filter = LevelFilter(logging.ERROR)</span><br><span class="line"></span><br><span class="line">handler = logging.StreamHandler()</span><br><span class="line">handler.addFilter(error_filter)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义过滤器</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyFilter</span>(logging.Filter):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">filter</span>(<span class="params">self, record</span>):</span><br><span class="line">        <span class="comment"># 只记录包含特定关键字的日志</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;important&#x27;</span> <span class="keyword">in</span> record.getMessage()</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(<span class="string">&#x27;myapp&#x27;</span>)</span><br><span class="line">logger.addFilter(MyFilter())</span><br></pre></td></tr></table></figure>

<h2 id="四、完整配置示例"><a href="#四、完整配置示例" class="headerlink" title="四、完整配置示例"></a>四、完整配置示例</h2><h3 id="4-1-控制台-文件输出"><a href="#4-1-控制台-文件输出" class="headerlink" title="4.1 控制台 + 文件输出"></a>4.1 控制台 + 文件输出</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> logging.handlers</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setup_logger</span>(<span class="params">name, log_file, level=logging.INFO</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;设置日志&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 格式化器</span></span><br><span class="line">    formatter = logging.Formatter(</span><br><span class="line">        <span class="string">&#x27;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#x27;</span>,</span><br><span class="line">        datefmt=<span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 控制台 Handler</span></span><br><span class="line">    console_handler = logging.StreamHandler()</span><br><span class="line">    console_handler.setLevel(logging.INFO)</span><br><span class="line">    console_handler.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 文件 Handler</span></span><br><span class="line">    file_handler = logging.FileHandler(log_file, encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    file_handler.setLevel(level)</span><br><span class="line">    file_handler.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Logger</span></span><br><span class="line">    logger = logging.getLogger(name)</span><br><span class="line">    logger.setLevel(level)</span><br><span class="line">    logger.addHandler(console_handler)</span><br><span class="line">    logger.addHandler(file_handler)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> logger</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line">logger = setup_logger(<span class="string">&#x27;myapp&#x27;</span>, <span class="string">&#x27;app.log&#x27;</span>, logging.DEBUG)</span><br><span class="line">logger.info(<span class="string">&quot;程序启动&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="4-2-日志轮转（RotatingFileHandler）"><a href="#4-2-日志轮转（RotatingFileHandler）" class="headerlink" title="4.2 日志轮转（RotatingFileHandler）"></a>4.2 日志轮转（RotatingFileHandler）</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> logging.handlers</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(<span class="string">&#x27;myapp&#x27;</span>)</span><br><span class="line">logger.setLevel(logging.DEBUG)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按文件大小轮转</span></span><br><span class="line">handler = logging.handlers.RotatingFileHandler(</span><br><span class="line">    <span class="string">&#x27;app.log&#x27;</span>,</span><br><span class="line">    maxBytes=<span class="number">10</span>*<span class="number">1024</span>*<span class="number">1024</span>,  <span class="comment"># 10MB</span></span><br><span class="line">    backupCount=<span class="number">5</span>,          <span class="comment"># 保留 5 个备份</span></span><br><span class="line">    encoding=<span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按时间轮转</span></span><br><span class="line">handler = logging.handlers.TimedRotatingFileHandler(</span><br><span class="line">    <span class="string">&#x27;app.log&#x27;</span>,</span><br><span class="line">    when=<span class="string">&#x27;D&#x27;</span>,              <span class="comment"># D=天，W=周，M=月，H=小时，S=秒</span></span><br><span class="line">    interval=<span class="number">1</span>,            <span class="comment"># 每 1 个单位轮转</span></span><br><span class="line">    backupCount=<span class="number">7</span>,         <span class="comment"># 保留 7 个备份</span></span><br><span class="line">    encoding=<span class="string">&#x27;utf-8&#x27;</span>,</span><br><span class="line">    atMidnight=<span class="literal">True</span>        <span class="comment"># 在午夜轮转</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">formatter = logging.Formatter(</span><br><span class="line">    <span class="string">&#x27;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#x27;</span></span><br><span class="line">)</span><br><span class="line">handler.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line">logger.addHandler(handler)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - 生产环境一定要用日志轮转</span></span><br><span class="line"><span class="comment"># - 避免日志文件无限增长</span></span><br></pre></td></tr></table></figure>

<h3 id="4-3-多-Logger-配置"><a href="#4-3-多-Logger-配置" class="headerlink" title="4.3 多 Logger 配置"></a>4.3 多 Logger 配置</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主应用 Logger</span></span><br><span class="line">app_logger = logging.getLogger(<span class="string">&#x27;app&#x27;</span>)</span><br><span class="line">app_logger.setLevel(logging.INFO)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据库 Logger</span></span><br><span class="line">db_logger = logging.getLogger(<span class="string">&#x27;app.database&#x27;</span>)</span><br><span class="line">db_logger.setLevel(logging.DEBUG)</span><br><span class="line"></span><br><span class="line"><span class="comment"># API Logger</span></span><br><span class="line">api_logger = logging.getLogger(<span class="string">&#x27;app.api&#x27;</span>)</span><br><span class="line">api_logger.setLevel(logging.WARNING)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不同 Logger 使用不同 Handler</span></span><br><span class="line">app_handler = logging.FileHandler(<span class="string">&#x27;app.log&#x27;</span>)</span><br><span class="line">db_handler = logging.FileHandler(<span class="string">&#x27;database.log&#x27;</span>)</span><br><span class="line">api_handler = logging.FileHandler(<span class="string">&#x27;api.log&#x27;</span>)</span><br><span class="line"></span><br><span class="line">formatter = logging.Formatter(<span class="string">&#x27;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> handler <span class="keyword">in</span> [app_handler, db_handler, api_handler]:</span><br><span class="line">    handler.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line">app_logger.addHandler(app_handler)</span><br><span class="line">db_logger.addHandler(db_handler)</span><br><span class="line">api_logger.addHandler(api_handler)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line">app_logger.info(<span class="string">&quot;应用信息&quot;</span>)</span><br><span class="line">db_logger.debug(<span class="string">&quot;数据库查询：SELECT * FROM users&quot;</span>)</span><br><span class="line">api_logger.warning(<span class="string">&quot;API 调用失败&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志传播（子 Logger 的日志会传递给父 Logger）</span></span><br><span class="line">db_logger.propagate = <span class="literal">False</span>  <span class="comment"># 禁止传播</span></span><br></pre></td></tr></table></figure>

<h2 id="五、字典配置"><a href="#五、字典配置" class="headerlink" title="五、字典配置"></a>五、字典配置</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> logging.config</span><br><span class="line"></span><br><span class="line">LOGGING_CONFIG = &#123;</span><br><span class="line">    <span class="string">&#x27;version&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&#x27;disable_existing_loggers&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 格式化器</span></span><br><span class="line">    <span class="string">&#x27;formatters&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;format&#x27;</span>: <span class="string">&#x27;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;datefmt&#x27;</span>: <span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;detailed&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;format&#x27;</span>: <span class="string">&#x27;%(asctime)s - %(name)s - %(levelname)s [%(filename)s:%(lineno)d] - %(message)s&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;datefmt&#x27;</span>: <span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Handler</span></span><br><span class="line">    <span class="string">&#x27;handlers&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;console&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;logging.StreamHandler&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;INFO&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;formatter&#x27;</span>: <span class="string">&#x27;default&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;stream&#x27;</span>: <span class="string">&#x27;ext://sys.stdout&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;file&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;logging.FileHandler&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;formatter&#x27;</span>: <span class="string">&#x27;detailed&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;filename&#x27;</span>: <span class="string">&#x27;app.log&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;encoding&#x27;</span>: <span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;rotating&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;logging.handlers.RotatingFileHandler&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;formatter&#x27;</span>: <span class="string">&#x27;detailed&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;filename&#x27;</span>: <span class="string">&#x27;app_rotating.log&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;encoding&#x27;</span>: <span class="string">&#x27;utf-8&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;maxBytes&#x27;</span>: <span class="number">10485760</span>,  <span class="comment"># 10MB</span></span><br><span class="line">            <span class="string">&#x27;backupCount&#x27;</span>: <span class="number">5</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Logger</span></span><br><span class="line">    <span class="string">&#x27;loggers&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;app&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;console&#x27;</span>, <span class="string">&#x27;file&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;propagate&#x27;</span>: <span class="literal">False</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;app.database&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;console&#x27;</span>, <span class="string">&#x27;rotating&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;propagate&#x27;</span>: <span class="literal">False</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Root Logger</span></span><br><span class="line">    <span class="string">&#x27;root&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;INFO&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;console&#x27;</span>, <span class="string">&#x27;file&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用配置</span></span><br><span class="line">logging.config.dictConfig(LOGGING_CONFIG)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line">logger = logging.getLogger(<span class="string">&#x27;app&#x27;</span>)</span><br><span class="line">logger.info(<span class="string">&quot;程序启动&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="从-YAML-文件加载配置"><a href="#从-YAML-文件加载配置" class="headerlink" title="从 YAML 文件加载配置"></a>从 YAML 文件加载配置</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> logging.config</span><br><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;logging_config.yaml&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    config = yaml.safe_load(f)</span><br><span class="line">    logging.config.dictConfig(config)</span><br></pre></td></tr></table></figure>

<h2 id="六、实用技巧"><a href="#六、实用技巧" class="headerlink" title="六、实用技巧"></a>六、实用技巧</h2><h3 id="6-1-日志性能优化"><a href="#6-1-日志性能优化" class="headerlink" title="6.1 日志性能优化"></a>6.1 日志性能优化</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式一：使用 lazy evaluation（推荐）</span></span><br><span class="line"><span class="keyword">if</span> logger.isEnabledFor(logging.DEBUG):</span><br><span class="line">    logger.debug(<span class="string">&quot;详细信息：%s&quot;</span>, expensive_operation())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式二：使用 % 格式化（延迟求值）</span></span><br><span class="line">logger.debug(<span class="string">&quot;详细信息：%s&quot;</span>, expensive_operation())  <span class="comment"># 只有需要时才执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 不要这样做（总是会执行）</span></span><br><span class="line">logger.debug(<span class="string">f&quot;详细信息：<span class="subst">&#123;expensive_operation()&#125;</span>&quot;</span>)  <span class="comment"># 即使不输出也会执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - 使用 % 格式化而不是 f-string</span></span><br><span class="line"><span class="comment"># - 避免在日志中执行昂贵操作</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-记录异常"><a href="#6-2-记录异常" class="headerlink" title="6.2 记录异常"></a>6.2 记录异常</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> traceback</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式一：exception() 自动记录堆栈</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    result = <span class="number">10</span> / <span class="number">0</span></span><br><span class="line"><span class="keyword">except</span> ZeroDivisionError:</span><br><span class="line">    logger.exception(<span class="string">&quot;除零错误&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式二：手动记录堆栈</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    result = <span class="number">10</span> / <span class="number">0</span></span><br><span class="line"><span class="keyword">except</span> ZeroDivisionError:</span><br><span class="line">    logger.error(<span class="string">&quot;除零错误&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式三：在任何地方记录堆栈</span></span><br><span class="line">logger.error(<span class="string">&quot;错误信息&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式四：记录完整堆栈</span></span><br><span class="line">logger.error(<span class="string">&quot;错误信息&quot;</span>, exc_info=<span class="literal">True</span>, stack_info=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - exception() 只在 except 块中使用</span></span><br><span class="line"><span class="comment"># - exc_info=True 可以在任何地方记录堆栈</span></span><br></pre></td></tr></table></figure>

<h3 id="6-3-上下文日志"><a href="#6-3-上下文日志" class="headerlink" title="6.3 上下文日志"></a>6.3 上下文日志</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> contextlib <span class="keyword">import</span> contextmanager</span><br><span class="line"></span><br><span class="line"><span class="meta">@contextmanager</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">log_context</span>(<span class="params">logger, message</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;带上下文的日志&quot;&quot;&quot;</span></span><br><span class="line">    logger.info(<span class="string">f&quot;开始：<span class="subst">&#123;message&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">yield</span></span><br><span class="line">        logger.info(<span class="string">f&quot;完成：<span class="subst">&#123;message&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;失败：<span class="subst">&#123;message&#125;</span> - <span class="subst">&#123;e&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> log_context(logger, <span class="string">&quot;处理数据&quot;</span>):</span><br><span class="line">    process_data()</span><br></pre></td></tr></table></figure>

<h3 id="6-4-彩色日志（控制台）"><a href="#6-4-彩色日志（控制台）" class="headerlink" title="6.4 彩色日志（控制台）"></a>6.4 彩色日志（控制台）</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="comment"># ANSI 颜色代码</span></span><br><span class="line">COLORS = &#123;</span><br><span class="line">    <span class="string">&#x27;DEBUG&#x27;</span>: <span class="string">&#x27;\033[36m&#x27;</span>,     <span class="comment"># 青色</span></span><br><span class="line">    <span class="string">&#x27;INFO&#x27;</span>: <span class="string">&#x27;\033[32m&#x27;</span>,      <span class="comment"># 绿色</span></span><br><span class="line">    <span class="string">&#x27;WARNING&#x27;</span>: <span class="string">&#x27;\033[33m&#x27;</span>,   <span class="comment"># 黄色</span></span><br><span class="line">    <span class="string">&#x27;ERROR&#x27;</span>: <span class="string">&#x27;\033[31m&#x27;</span>,     <span class="comment"># 红色</span></span><br><span class="line">    <span class="string">&#x27;CRITICAL&#x27;</span>: <span class="string">&#x27;\033[35m&#x27;</span>,  <span class="comment"># 紫色</span></span><br><span class="line">    <span class="string">&#x27;RESET&#x27;</span>: <span class="string">&#x27;\033[0m&#x27;</span>       <span class="comment"># 重置</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ColoredFormatter</span>(logging.Formatter):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">format</span>(<span class="params">self, record</span>):</span><br><span class="line">        log_color = COLORS.get(record.levelname, COLORS[<span class="string">&#x27;RESET&#x27;</span>])</span><br><span class="line">        record.levelname = <span class="string">f&quot;<span class="subst">&#123;log_color&#125;</span><span class="subst">&#123;record.levelname&#125;</span><span class="subst">&#123;COLORS[<span class="string">&#x27;RESET&#x27;</span>]&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().<span class="built_in">format</span>(record)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line">logger = logging.getLogger(<span class="string">&#x27;myapp&#x27;</span>)</span><br><span class="line">handler = logging.StreamHandler()</span><br><span class="line">handler.setFormatter(ColoredFormatter(<span class="string">&#x27;%(asctime)s - %(levelname)s - %(message)s&#x27;</span>))</span><br><span class="line">logger.addHandler(handler)</span><br></pre></td></tr></table></figure>

<h3 id="6-5-JSON-日志（适合日志收集系统）"><a href="#6-5-JSON-日志（适合日志收集系统）" class="headerlink" title="6.5 JSON 日志（适合日志收集系统）"></a>6.5 JSON 日志（适合日志收集系统）</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JSONFormatter</span>(logging.Formatter):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">format</span>(<span class="params">self, record</span>):</span><br><span class="line">        log_data = &#123;</span><br><span class="line">            <span class="string">&#x27;timestamp&#x27;</span>: datetime.utcnow().isoformat(),</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span>: record.levelname,</span><br><span class="line">            <span class="string">&#x27;logger&#x27;</span>: record.name,</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: record.getMessage(),</span><br><span class="line">            <span class="string">&#x27;module&#x27;</span>: record.module,</span><br><span class="line">            <span class="string">&#x27;function&#x27;</span>: record.funcName,</span><br><span class="line">            <span class="string">&#x27;line&#x27;</span>: record.lineno</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> record.exc_info:</span><br><span class="line">            log_data[<span class="string">&#x27;exception&#x27;</span>] = <span class="variable language_">self</span>.formatException(record.exc_info)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> json.dumps(log_data, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line">logger = logging.getLogger(<span class="string">&#x27;myapp&#x27;</span>)</span><br><span class="line">handler = logging.FileHandler(<span class="string">&#x27;app.json.log&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">handler.setFormatter(JSONFormatter())</span><br><span class="line">logger.addHandler(handler)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出：</span></span><br><span class="line"><span class="comment"># &#123;&quot;timestamp&quot;: &quot;2026-02-24T10:00:00&quot;, &quot;level&quot;: &quot;ERROR&quot;, &quot;logger&quot;: &quot;myapp&quot;, &quot;message&quot;: &quot;错误信息&quot;, ...&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="七、最佳实践"><a href="#七、最佳实践" class="headerlink" title="七、最佳实践"></a>七、最佳实践</h2><blockquote>
<p><strong>提醒自己</strong>：</p>
<ol>
<li><strong>使用模块名作为 Logger 名</strong>：<code>logging.getLogger(__name__)</code></li>
<li><strong>不要在循环中创建 Logger</strong>：在模块级别创建</li>
<li><strong>合理设置日志级别</strong>：开发 DEBUG，生产 INFO 或 WARNING</li>
<li><strong>使用日志轮转</strong>：避免日志文件过大</li>
<li><strong>不要记录敏感信息</strong>：密码、token、个人信息等</li>
<li><strong>结构化日志</strong>：便于日志收集和分析</li>
<li><strong>使用%格式化</strong>：延迟求值，提高性能</li>
</ol>
</blockquote>
<h2 id="八、完整示例"><a href="#八、完整示例" class="headerlink" title="八、完整示例"></a>八、完整示例</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># app.py</span></span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> logging.handlers</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setup_logging</span>(<span class="params">app_name=<span class="string">&#x27;myapp&#x27;</span>, log_dir=<span class="string">&#x27;logs&#x27;</span>, level=logging.INFO</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;设置日志配置&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建日志目录</span></span><br><span class="line">    Path(log_dir).mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 格式化器</span></span><br><span class="line">    formatter = logging.Formatter(</span><br><span class="line">        <span class="string">&#x27;%(asctime)s - %(name)s - %(levelname)s [%(filename)s:%(lineno)d] - %(message)s&#x27;</span>,</span><br><span class="line">        datefmt=<span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 控制台 Handler</span></span><br><span class="line">    console_handler = logging.StreamHandler()</span><br><span class="line">    console_handler.setLevel(logging.INFO)</span><br><span class="line">    console_handler.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 文件 Handler（所有级别）</span></span><br><span class="line">    file_handler = logging.FileHandler(</span><br><span class="line">        <span class="string">f&#x27;<span class="subst">&#123;log_dir&#125;</span>/<span class="subst">&#123;app_name&#125;</span>.log&#x27;</span>,</span><br><span class="line">        encoding=<span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    file_handler.setLevel(level)</span><br><span class="line">    file_handler.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 错误文件 Handler（只记录 ERROR 及以上）</span></span><br><span class="line">    error_handler = logging.FileHandler(</span><br><span class="line">        <span class="string">f&#x27;<span class="subst">&#123;log_dir&#125;</span>/<span class="subst">&#123;app_name&#125;</span>_error.log&#x27;</span>,</span><br><span class="line">        encoding=<span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    error_handler.setLevel(logging.ERROR)</span><br><span class="line">    error_handler.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 日志轮转（可选）</span></span><br><span class="line">    <span class="comment"># rotating_handler = logging.handlers.RotatingFileHandler(</span></span><br><span class="line">    <span class="comment">#     f&#x27;&#123;log_dir&#125;/&#123;app_name&#125;.log&#x27;,</span></span><br><span class="line">    <span class="comment">#     maxBytes=10*1024*1024,  # 10MB</span></span><br><span class="line">    <span class="comment">#     backupCount=5,</span></span><br><span class="line">    <span class="comment">#     encoding=&#x27;utf-8&#x27;</span></span><br><span class="line">    <span class="comment"># )</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Root Logger</span></span><br><span class="line">    root_logger = logging.getLogger()</span><br><span class="line">    root_logger.setLevel(level)</span><br><span class="line">    root_logger.addHandler(console_handler)</span><br><span class="line">    root_logger.addHandler(file_handler)</span><br><span class="line">    root_logger.addHandler(error_handler)</span><br><span class="line"></span><br><span class="line">    logging.info(<span class="string">f&quot;<span class="subst">&#123;app_name&#125;</span> 日志系统初始化完成&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line">setup_logging(<span class="string">&#x27;myapp&#x27;</span>, <span class="string">&#x27;logs&#x27;</span>, logging.DEBUG)</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    logger.info(<span class="string">&quot;程序启动&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 业务逻辑</span></span><br><span class="line">        process_data()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.exception(<span class="string">&quot;程序执行失败&quot;</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        logger.info(<span class="string">&quot;程序结束&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h2 id="九、练习"><a href="#九、练习" class="headerlink" title="九、练习"></a>九、练习</h2><ol>
<li>创建一个完整的日志配置，包含控制台、文件、轮转输出</li>
<li>使用字典配置方式设置日志系统</li>
<li>实现一个 JSON 格式的日志输出器</li>
<li>编写一个带上下文的日志装饰器</li>
<li>配置多 Logger，使不同模块输出到不同文件</li>
</ol>
<hr>
<p><strong>上一篇</strong>：<a href="/2026/02/24/Python-%E5%B8%B8%E7%94%A8%E5%BA%93%EF%BC%88%E4%BA%8C%EF%BC%89json-yaml-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/">Python 常用库（二）：json&#x2F;yaml 配置文件处理</a></p>
<p><strong>系列完成！</strong></p>
<p><strong>参考资源</strong>：</p>
<ul>
<li><a href="https://docs.python.org/zh-cn/3/library/logging.html">logging 官方文档</a></li>
<li><a href="https://docs.python.org/zh-cn/3/library/logging.config.html">logging 配置文档</a></li>
<li><a href="https://docs.python.org/3/howto/logging-cookbook.html">Python Logging Cookbook</a></li>
</ul>
]]></content>
      <categories>
        <category>Python 教程</category>
      </categories>
      <tags>
        <tag>日志</tag>
        <tag>Python</tag>
        <tag>logging</tag>
        <tag>调试</tag>
      </tags>
  </entry>
  <entry>
    <title>Python 数据科学（一）NumPy 数值计算</title>
    <url>/2026/02/24/Python%20%E6%95%B0%E6%8D%AE%E7%A7%91%E5%AD%A6%EF%BC%88%E4%B8%80%EF%BC%89NumPy%20%E6%95%B0%E5%80%BC%E8%AE%A1%E7%AE%97/</url>
    <content><![CDATA[<h1 id="Python-数据科学（一）NumPy-数值计算"><a href="#Python-数据科学（一）NumPy-数值计算" class="headerlink" title="Python 数据科学（一）NumPy 数值计算"></a>Python 数据科学（一）NumPy 数值计算</h1><p>NumPy 是 Python 数据科学的基石。本篇将介绍 NumPy 的核心功能，包括 ndarray 数组、向量化计算、广播机制等。</p>
<h2 id="一、NumPy-简介"><a href="#一、NumPy-简介" class="headerlink" title="一、NumPy 简介"></a>一、NumPy 简介</h2><h3 id="1-1-为什么使用-NumPy？"><a href="#1-1-为什么使用-NumPy？" class="headerlink" title="1.1 为什么使用 NumPy？"></a>1.1 为什么使用 NumPy？</h3><ul>
<li><strong>性能优势</strong>：底层用 C 实现，比纯 Python 快 10-100 倍</li>
<li><strong>内存效率</strong>：连续存储，占用更少内存</li>
<li><strong>向量化操作</strong>：无需循环，代码更简洁</li>
<li><strong>生态基础</strong>：Pandas、SciPy、scikit-learn 等都基于 NumPy</li>
</ul>
<h3 id="1-2-安装与导入"><a href="#1-2-安装与导入" class="headerlink" title="1.2 安装与导入"></a>1.2 安装与导入</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pip install numpy</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看版本</span></span><br><span class="line"><span class="built_in">print</span>(np.__version__)</span><br></pre></td></tr></table></figure>

<h2 id="二、ndarray-数组"><a href="#二、ndarray-数组" class="headerlink" title="二、ndarray 数组"></a>二、ndarray 数组</h2><h3 id="2-1-创建数组"><a href="#2-1-创建数组" class="headerlink" title="2.1 创建数组"></a>2.1 创建数组</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从列表创建</span></span><br><span class="line">arr1 = np.array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>])</span><br><span class="line">arr2 = np.array([[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]])  <span class="comment"># 二维数组</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 特殊数组</span></span><br><span class="line">zeros = np.zeros((<span class="number">3</span>, <span class="number">4</span>))      <span class="comment"># 3x4 全零数组</span></span><br><span class="line">ones = np.ones((<span class="number">2</span>, <span class="number">3</span>))        <span class="comment"># 2x3 全一数组</span></span><br><span class="line">full = np.full((<span class="number">2</span>, <span class="number">2</span>), <span class="number">7</span>)     <span class="comment"># 2x2 填充 7 的数组</span></span><br><span class="line">empty = np.empty((<span class="number">3</span>, <span class="number">3</span>))      <span class="comment"># 未初始化的数组（速度快，值随机）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 范围数组</span></span><br><span class="line">range1 = np.arange(<span class="number">0</span>, <span class="number">10</span>, <span class="number">2</span>)     <span class="comment"># [0, 2, 4, 6, 8]</span></span><br><span class="line">range2 = np.linspace(<span class="number">0</span>, <span class="number">1</span>, <span class="number">5</span>)    <span class="comment"># [0., 0.25, 0.5, 0.75, 1.] 等间距</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 随机数组</span></span><br><span class="line">rand1 = np.random.rand(<span class="number">3</span>, <span class="number">3</span>)          <span class="comment"># 0-1 均匀分布</span></span><br><span class="line">rand2 = np.random.randn(<span class="number">3</span>, <span class="number">3</span>)         <span class="comment"># 标准正态分布</span></span><br><span class="line">rand3 = np.random.randint(<span class="number">0</span>, <span class="number">10</span>, <span class="number">5</span>)   <span class="comment"># [0,10) 随机整数</span></span><br><span class="line">rand4 = np.random.random((<span class="number">2</span>, <span class="number">3</span>))      <span class="comment"># 0-1 均匀分布</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 单位矩阵</span></span><br><span class="line">eye = np.eye(<span class="number">3</span>)</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">[[1. 0. 0.]</span></span><br><span class="line"><span class="string"> [0. 1. 0.]</span></span><br><span class="line"><span class="string"> [0. 0. 1.]]</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - arange 类似 Python 的 range，但支持浮点数</span></span><br><span class="line"><span class="comment"># - linspace 指定的是点数而非步长</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-数组属性"><a href="#2-2-数组属性" class="headerlink" title="2.2 数组属性"></a>2.2 数组属性</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">arr = np.array([[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]])</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(arr.ndim)      <span class="comment"># 2 维度</span></span><br><span class="line"><span class="built_in">print</span>(arr.shape)     <span class="comment"># (2, 3) 形状</span></span><br><span class="line"><span class="built_in">print</span>(arr.size)      <span class="comment"># 6 元素总数</span></span><br><span class="line"><span class="built_in">print</span>(arr.dtype)     <span class="comment"># int32/int64 数据类型</span></span><br><span class="line"><span class="built_in">print</span>(arr.itemsize)  <span class="comment"># 8 每个元素的字节数</span></span><br><span class="line"><span class="built_in">print</span>(arr.nbytes)    <span class="comment"># 48 总字节数</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-数据类型"><a href="#2-3-数据类型" class="headerlink" title="2.3 数据类型"></a>2.3 数据类型</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 指定数据类型</span></span><br><span class="line">arr = np.array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], dtype=np.float32)</span><br><span class="line">arr = np.array([<span class="number">1.0</span>, <span class="number">2.0</span>], dtype=np.complex128)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 常用数据类型</span></span><br><span class="line"><span class="comment"># - np.int8/16/32/64: 有符号整数</span></span><br><span class="line"><span class="comment"># - np.uint8/16/32/64: 无符号整数</span></span><br><span class="line"><span class="comment"># - np.float16/32/64: 浮点数</span></span><br><span class="line"><span class="comment"># - np.complex64/128: 复数</span></span><br><span class="line"><span class="comment"># - np.bool_: 布尔值</span></span><br><span class="line"><span class="comment"># - np.str_: 字符串</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 类型转换</span></span><br><span class="line">arr = arr.astype(np.int32)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - float64 是默认浮点类型</span></span><br><span class="line"><span class="comment"># - 大规模计算可用 float32 节省内存</span></span><br></pre></td></tr></table></figure>

<h2 id="三、数组索引与切片"><a href="#三、数组索引与切片" class="headerlink" title="三、数组索引与切片"></a>三、数组索引与切片</h2><h3 id="3-1-基础索引"><a href="#3-1-基础索引" class="headerlink" title="3.1 基础索引"></a>3.1 基础索引</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">arr = np.array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>])</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(arr[<span class="number">0</span>])      <span class="comment"># 1</span></span><br><span class="line"><span class="built_in">print</span>(arr[-<span class="number">1</span>])     <span class="comment"># 5</span></span><br><span class="line"><span class="built_in">print</span>(arr[<span class="number">2</span>:<span class="number">4</span>])    <span class="comment"># [3, 4] 切片</span></span><br><span class="line"><span class="built_in">print</span>(arr[::<span class="number">2</span>])    <span class="comment"># [1, 3, 5] 步长</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 二维数组</span></span><br><span class="line">arr2d = np.array([[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>], [<span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]])</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(arr2d[<span class="number">0</span>, <span class="number">1</span>])    <span class="comment"># 2 第 0 行第 1 列</span></span><br><span class="line"><span class="built_in">print</span>(arr2d[<span class="number">0</span>])       <span class="comment"># [1, 2, 3] 第一行</span></span><br><span class="line"><span class="built_in">print</span>(arr2d[:, <span class="number">1</span>])    <span class="comment"># [2, 5, 8] 第二列</span></span><br><span class="line"><span class="built_in">print</span>(arr2d[<span class="number">1</span>:<span class="number">3</span>, <span class="number">0</span>:<span class="number">2</span>]) <span class="comment"># [[4, 5], [7, 8]]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：NumPy 切片返回的是视图（view），不是拷贝！</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-布尔索引"><a href="#3-2-布尔索引" class="headerlink" title="3.2 布尔索引"></a>3.2 布尔索引</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">arr = np.array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 条件筛选</span></span><br><span class="line">mask = arr &gt; <span class="number">3</span></span><br><span class="line"><span class="built_in">print</span>(mask)         <span class="comment"># [False, False, False, True, True, True]</span></span><br><span class="line"><span class="built_in">print</span>(arr[mask])    <span class="comment"># [4, 5, 6]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 简化写法</span></span><br><span class="line"><span class="built_in">print</span>(arr[arr &gt; <span class="number">3</span>])    <span class="comment"># [4, 5, 6]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 多条件</span></span><br><span class="line"><span class="built_in">print</span>(arr[(arr &gt; <span class="number">2</span>) &amp; (arr &lt; <span class="number">5</span>)])  <span class="comment"># [3, 4]  与</span></span><br><span class="line"><span class="built_in">print</span>(arr[(arr &lt; <span class="number">2</span>) | (arr &gt; <span class="number">5</span>)])  <span class="comment"># [1, 6]  或</span></span><br><span class="line"><span class="built_in">print</span>(arr[~(arr % <span class="number">2</span> == <span class="number">0</span>)])        <span class="comment"># [1, 3, 5] 非</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - 多条件用 &amp; | ~，不能用 and or not</span></span><br><span class="line"><span class="comment"># - 条件要用括号括起来</span></span><br></pre></td></tr></table></figure>

<h3 id="3-3-花式索引"><a href="#3-3-花式索引" class="headerlink" title="3.3 花式索引"></a>3.3 花式索引</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">arr = np.array([<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>, <span class="number">50</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按索引数组取值</span></span><br><span class="line">indices = [<span class="number">0</span>, <span class="number">2</span>, <span class="number">4</span>]</span><br><span class="line"><span class="built_in">print</span>(arr[indices])  <span class="comment"># [10, 30, 50]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 二维数组花式索引</span></span><br><span class="line">arr2d = np.array([[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>], [<span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]])</span><br><span class="line">rows = [<span class="number">0</span>, <span class="number">2</span>]</span><br><span class="line">cols = [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line"><span class="built_in">print</span>(arr2d[rows, cols])  <span class="comment"># [2, 9] 对应 (0,1) 和 (2,2)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：花式索引返回的是拷贝，不是视图</span></span><br></pre></td></tr></table></figure>

<h2 id="四、数组操作"><a href="#四、数组操作" class="headerlink" title="四、数组操作"></a>四、数组操作</h2><h3 id="4-1-形状变换"><a href="#4-1-形状变换" class="headerlink" title="4.1 形状变换"></a>4.1 形状变换</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">arr = np.arange(<span class="number">12</span>)  <span class="comment"># [0, 1, 2, ..., 11]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># reshape 改变形状</span></span><br><span class="line">arr2d = arr.reshape(<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">[[ 0,  1,  2,  3],</span></span><br><span class="line"><span class="string"> [ 4,  5,  6,  7],</span></span><br><span class="line"><span class="string"> [ 8,  9, 10, 11]]</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -1 自动推断</span></span><br><span class="line">arr3d = arr.reshape(<span class="number">2</span>, <span class="number">2</span>, -<span class="number">1</span>)  <span class="comment"># (2, 2, 3)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># flatten 展平</span></span><br><span class="line">flat = arr2d.flatten()  <span class="comment"># 返回拷贝</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ravel 展平</span></span><br><span class="line">flat = arr2d.ravel()  <span class="comment"># 返回视图（更快）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># transpose 转置</span></span><br><span class="line">transposed = arr2d.T</span><br><span class="line"></span><br><span class="line"><span class="comment"># swapaxes 交换轴</span></span><br><span class="line">swapped = arr3d.swapaxes(<span class="number">0</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - reshape 不改变原数组</span></span><br><span class="line"><span class="comment"># - -1 表示自动计算该维度大小</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-合并与分割"><a href="#4-2-合并与分割" class="headerlink" title="4.2 合并与分割"></a>4.2 合并与分割</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 合并</span></span><br><span class="line">arr1 = np.array([[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">3</span>, <span class="number">4</span>]])</span><br><span class="line">arr2 = np.array([[<span class="number">5</span>, <span class="number">6</span>], [<span class="number">7</span>, <span class="number">8</span>]])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 垂直堆叠</span></span><br><span class="line">vstack = np.vstack([arr1, arr2])</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">[[1, 2],</span></span><br><span class="line"><span class="string"> [3, 4],</span></span><br><span class="line"><span class="string"> [5, 6],</span></span><br><span class="line"><span class="string"> [7, 8]]</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 水平堆叠</span></span><br><span class="line">hstack = np.hstack([arr1, arr2])</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">[[1, 2, 5, 6],</span></span><br><span class="line"><span class="string"> [3, 4, 7, 8]]</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 按行/列堆叠</span></span><br><span class="line">concat_v = np.concatenate([arr1, arr2], axis=<span class="number">0</span>)  <span class="comment"># 按行</span></span><br><span class="line">concat_h = np.concatenate([arr1, arr2], axis=<span class="number">1</span>)  <span class="comment"># 按列</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 分割</span></span><br><span class="line">arr = np.arange(<span class="number">12</span>).reshape(<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">split_v = np.vsplit(arr, <span class="number">3</span>)  <span class="comment"># 垂直分割成 3 份</span></span><br><span class="line">split_h = np.hsplit(arr, <span class="number">2</span>)  <span class="comment"># 水平分割成 2 份</span></span><br><span class="line">split = np.split(arr, <span class="number">3</span>, axis=<span class="number">0</span>)  <span class="comment"># 按轴分割</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - axis=0 表示行（垂直），axis=1 表示列（水平）</span></span><br></pre></td></tr></table></figure>

<h3 id="4-3-增删元素"><a href="#4-3-增删元素" class="headerlink" title="4.3 增删元素"></a>4.3 增删元素</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">arr = np.array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加元素</span></span><br><span class="line">arr_append = np.append(arr, [<span class="number">6</span>, <span class="number">7</span>])  <span class="comment"># [1, 2, 3, 4, 5, 6, 7]</span></span><br><span class="line">arr_insert = np.insert(arr, <span class="number">2</span>, [<span class="number">10</span>, <span class="number">20</span>])  <span class="comment"># 在索引 2 插入 [1, 2, 10, 20, 3, 4, 5]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除元素</span></span><br><span class="line">arr_delete = np.delete(arr, [<span class="number">1</span>, <span class="number">3</span>])  <span class="comment"># [1, 3, 5] 删除索引 1 和 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：这些操作返回新数组，不修改原数组</span></span><br></pre></td></tr></table></figure>

<h2 id="五、向量化计算"><a href="#五、向量化计算" class="headerlink" title="五、向量化计算"></a>五、向量化计算</h2><h3 id="5-1-算术运算"><a href="#5-1-算术运算" class="headerlink" title="5.1 算术运算"></a>5.1 算术运算</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">arr1 = np.array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])</span><br><span class="line">arr2 = np.array([<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 元素级运算</span></span><br><span class="line"><span class="built_in">print</span>(arr1 + arr2)    <span class="comment"># [3, 4, 5, 6]</span></span><br><span class="line"><span class="built_in">print</span>(arr1 - arr2)    <span class="comment"># [-1, 0, 1, 2]</span></span><br><span class="line"><span class="built_in">print</span>(arr1 * arr2)    <span class="comment"># [2, 4, 6, 8]</span></span><br><span class="line"><span class="built_in">print</span>(arr1 / arr2)    <span class="comment"># [0.5, 1.0, 1.5, 2.0]</span></span><br><span class="line"><span class="built_in">print</span>(arr1 // arr2)   <span class="comment"># [0, 1, 1, 2] 整除</span></span><br><span class="line"><span class="built_in">print</span>(arr1 ** <span class="number">2</span>)      <span class="comment"># [1, 4, 9, 16] 幂</span></span><br><span class="line"><span class="built_in">print</span>(arr1 % <span class="number">2</span>)       <span class="comment"># [1, 0, 1, 0] 取余</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数学函数</span></span><br><span class="line">arr = np.array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>])</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(np.sqrt(arr))      <span class="comment"># 平方根</span></span><br><span class="line"><span class="built_in">print</span>(np.exp(arr))       <span class="comment"># e 的幂</span></span><br><span class="line"><span class="built_in">print</span>(np.log(arr))       <span class="comment"># 自然对数</span></span><br><span class="line"><span class="built_in">print</span>(np.log10(arr))     <span class="comment"># 常用对数</span></span><br><span class="line"><span class="built_in">print</span>(np.sin(arr))       <span class="comment"># 正弦</span></span><br><span class="line"><span class="built_in">print</span>(np.cos(arr))       <span class="comment"># 余弦</span></span><br><span class="line"><span class="built_in">print</span>(np.<span class="built_in">abs</span>(arr))       <span class="comment"># 绝对值</span></span><br><span class="line"><span class="built_in">print</span>(np.ceil(arr/<span class="number">2</span>))    <span class="comment"># 向上取整</span></span><br><span class="line"><span class="built_in">print</span>(np.floor(arr/<span class="number">2</span>))   <span class="comment"># 向下取整</span></span><br><span class="line"><span class="built_in">print</span>(np.<span class="built_in">round</span>(arr/<span class="number">2</span>))   <span class="comment"># 四舍五入</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - 向量化运算比循环快得多</span></span><br><span class="line"><span class="comment"># - 避免使用 for 循环处理数组</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-聚合函数"><a href="#5-2-聚合函数" class="headerlink" title="5.2 聚合函数"></a>5.2 聚合函数</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">arr = np.array([[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 全局聚合</span></span><br><span class="line"><span class="built_in">print</span>(arr.<span class="built_in">sum</span>())        <span class="comment"># 21 总和</span></span><br><span class="line"><span class="built_in">print</span>(arr.mean())       <span class="comment"># 3.5 平均值</span></span><br><span class="line"><span class="built_in">print</span>(arr.std())        <span class="comment"># 标准差</span></span><br><span class="line"><span class="built_in">print</span>(arr.var())        <span class="comment"># 方差</span></span><br><span class="line"><span class="built_in">print</span>(arr.<span class="built_in">min</span>())        <span class="comment"># 1 最小值</span></span><br><span class="line"><span class="built_in">print</span>(arr.<span class="built_in">max</span>())        <span class="comment"># 6 最大值</span></span><br><span class="line"><span class="built_in">print</span>(arr.argmin())     <span class="comment"># 0 最小值索引</span></span><br><span class="line"><span class="built_in">print</span>(arr.argmax())     <span class="comment"># 5 最大值索引</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 按轴聚合</span></span><br><span class="line"><span class="built_in">print</span>(arr.<span class="built_in">sum</span>(axis=<span class="number">0</span>))   <span class="comment"># [5, 7, 9] 每列求和</span></span><br><span class="line"><span class="built_in">print</span>(arr.<span class="built_in">sum</span>(axis=<span class="number">1</span>))   <span class="comment"># [6, 15] 每行求和</span></span><br><span class="line"><span class="built_in">print</span>(arr.mean(axis=<span class="number">0</span>))  <span class="comment"># [2.5, 3.5, 4.5] 每列平均</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 累积运算</span></span><br><span class="line"><span class="built_in">print</span>(arr.cumsum())      <span class="comment"># 累积和</span></span><br><span class="line"><span class="built_in">print</span>(arr.cumprod())     <span class="comment"># 累积积</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - axis=0 按列（跨行），axis=1 按行（跨列）</span></span><br><span class="line"><span class="comment"># - 记住：axis 指的是&quot;沿着哪个轴操作&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-排序"><a href="#5-3-排序" class="headerlink" title="5.3 排序"></a>5.3 排序</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">arr = np.array([<span class="number">3</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">6</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 排序</span></span><br><span class="line">sorted_arr = np.sort(arr)  <span class="comment"># [1, 1, 2, 3, 4, 5, 6, 9]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 排序索引</span></span><br><span class="line">indices = np.argsort(arr)  <span class="comment"># 排序后的索引</span></span><br><span class="line"><span class="comment"># [1, 3, 6, 0, 2, 4, 7, 5]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 分区（部分排序）</span></span><br><span class="line">partitioned = np.partition(arr, <span class="number">3</span>)  <span class="comment"># 前 3 个是最小的</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 二维数组排序</span></span><br><span class="line">arr2d = np.array([[<span class="number">3</span>, <span class="number">1</span>, <span class="number">4</span>], [<span class="number">1</span>, <span class="number">5</span>, <span class="number">9</span>]])</span><br><span class="line"><span class="built_in">print</span>(np.sort(arr2d, axis=<span class="number">1</span>))  <span class="comment"># 每行排序</span></span><br><span class="line"><span class="built_in">print</span>(np.sort(arr2d, axis=<span class="number">0</span>))  <span class="comment"># 每列排序</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - np.sort 返回新数组</span></span><br><span class="line"><span class="comment"># - arr.sort() 原地排序</span></span><br></pre></td></tr></table></figure>

<h2 id="六、广播机制"><a href="#六、广播机制" class="headerlink" title="六、广播机制"></a>六、广播机制</h2><h3 id="6-1-广播规则"><a href="#6-1-广播规则" class="headerlink" title="6.1 广播规则"></a>6.1 广播规则</h3><p>广播（Broadcasting）允许不同形状的数组进行运算。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 规则 1：标量与数组</span></span><br><span class="line">arr = np.array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line"><span class="built_in">print</span>(arr + <span class="number">5</span>)  <span class="comment"># [6, 7, 8]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 规则 2：形状兼容</span></span><br><span class="line">arr1 = np.array([[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]])  <span class="comment"># (2, 3)</span></span><br><span class="line">arr2 = np.array([<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>])             <span class="comment"># (3,)</span></span><br><span class="line"><span class="built_in">print</span>(arr1 + arr2)</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">[[11, 22, 33],</span></span><br><span class="line"><span class="string"> [14, 24, 34]]</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 规则 3：多维广播</span></span><br><span class="line">arr1 = np.array([[<span class="number">1</span>], [<span class="number">2</span>], [<span class="number">3</span>]])  <span class="comment"># (3, 1)</span></span><br><span class="line">arr2 = np.array([<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>])     <span class="comment"># (3,)</span></span><br><span class="line"><span class="built_in">print</span>(arr1 + arr2)</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">[[11, 21, 31],</span></span><br><span class="line"><span class="string"> [12, 22, 32],</span></span><br><span class="line"><span class="string"> [13, 23, 33]]</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 广播条件：</span></span><br><span class="line"><span class="comment"># 1. 维度相同或其中一个为 1</span></span><br><span class="line"><span class="comment"># 2. 从后向前比较维度，每个维度要么相等，要么其中一个为 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - 广播可以节省内存（不需要实际复制数据）</span></span><br><span class="line"><span class="comment"># - 不兼容的形状会报错</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-广播示例"><a href="#6-2-广播示例" class="headerlink" title="6.2 广播示例"></a>6.2 广播示例</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 标准化数据</span></span><br><span class="line">data = np.random.randn(<span class="number">100</span>, <span class="number">5</span>)  <span class="comment"># 100 个样本，5 个特征</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 每列标准化（减去均值，除以标准差）</span></span><br><span class="line">mean = data.mean(axis=<span class="number">0</span>)  <span class="comment"># (5,)</span></span><br><span class="line">std = data.std(axis=<span class="number">0</span>)    <span class="comment"># (5,)</span></span><br><span class="line">standardized = (data - mean) / std</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算距离</span></span><br><span class="line">points = np.array([[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">3</span>, <span class="number">4</span>], [<span class="number">5</span>, <span class="number">6</span>]])  <span class="comment"># (3, 2)</span></span><br><span class="line">origin = np.array([<span class="number">0</span>, <span class="number">0</span>])                    <span class="comment"># (2,)</span></span><br><span class="line">distances = np.sqrt(((points - origin) ** <span class="number">2</span>).<span class="built_in">sum</span>(axis=<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 外积</span></span><br><span class="line">a = np.array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])    <span class="comment"># (3,)</span></span><br><span class="line">b = np.array([<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>])  <span class="comment"># (4,)</span></span><br><span class="line">outer = a[:, np.newaxis] * b  <span class="comment"># (3, 4)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">[[10, 20, 30, 40],</span></span><br><span class="line"><span class="string"> [20, 40, 60, 80],</span></span><br><span class="line"><span class="string"> [30, 60, 90, 120]]</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="七、线性代数"><a href="#七、线性代数" class="headerlink" title="七、线性代数"></a>七、线性代数</h2><h3 id="7-1-矩阵运算"><a href="#7-1-矩阵运算" class="headerlink" title="7.1 矩阵运算"></a>7.1 矩阵运算</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">A = np.array([[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">3</span>, <span class="number">4</span>]])</span><br><span class="line">B = np.array([[<span class="number">5</span>, <span class="number">6</span>], [<span class="number">7</span>, <span class="number">8</span>]])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 矩阵乘法</span></span><br><span class="line">C = A @ B           <span class="comment"># Python 3.5+</span></span><br><span class="line">C = np.dot(A, B)    <span class="comment"># 点积</span></span><br><span class="line">C = A.dot(B)        <span class="comment"># 方法形式</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 元素级乘法</span></span><br><span class="line">C = A * B</span><br><span class="line"></span><br><span class="line"><span class="comment"># 转置</span></span><br><span class="line">A_T = A.T</span><br><span class="line">A_T = np.transpose(A)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 逆矩阵</span></span><br><span class="line">A_inv = np.linalg.inv(A)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 行列式</span></span><br><span class="line">det = np.linalg.det(A)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 特征值和特征向量</span></span><br><span class="line">eigenvalues, eigenvectors = np.linalg.eig(A)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解线性方程组 Ax = b</span></span><br><span class="line">A = np.array([[<span class="number">3</span>, <span class="number">1</span>], [<span class="number">1</span>, <span class="number">2</span>]])</span><br><span class="line">b = np.array([<span class="number">9</span>, <span class="number">8</span>])</span><br><span class="line">x = np.linalg.solve(A, b)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己去查文档：</span></span><br><span class="line"><span class="comment"># - np.linalg 包含更多线性代数函数</span></span><br></pre></td></tr></table></figure>

<h3 id="7-2-实用示例"><a href="#7-2-实用示例" class="headerlink" title="7.2 实用示例"></a>7.2 实用示例</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 最小二乘法拟合</span></span><br><span class="line">x = np.array([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])</span><br><span class="line">y = np.array([<span class="number">0</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">8</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拟合 y = ax + b</span></span><br><span class="line">A = np.vstack([x, np.ones(<span class="built_in">len</span>(x))]).T</span><br><span class="line">a, b = np.linalg.lstsq(A, y, rcond=<span class="literal">None</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 协方差矩阵</span></span><br><span class="line">data = np.random.randn(<span class="number">100</span>, <span class="number">5</span>)</span><br><span class="line">cov_matrix = np.cov(data.T)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 相关系数矩阵</span></span><br><span class="line">corr_matrix = np.corrcoef(data.T)</span><br></pre></td></tr></table></figure>

<h2 id="八、文件操作"><a href="#八、文件操作" class="headerlink" title="八、文件操作"></a>八、文件操作</h2><h3 id="8-1-NumPy-文件读写"><a href="#8-1-NumPy-文件读写" class="headerlink" title="8.1 NumPy 文件读写"></a>8.1 NumPy 文件读写</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 保存为 npy 格式</span></span><br><span class="line">arr = np.array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>])</span><br><span class="line">np.save(<span class="string">&#x27;arr.npy&#x27;</span>, arr)</span><br><span class="line">loaded = np.load(<span class="string">&#x27;arr.npy&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存多个数组</span></span><br><span class="line">np.savez(<span class="string">&#x27;arrays.npz&#x27;</span>, a=arr1, b=arr2)</span><br><span class="line">data = np.load(<span class="string">&#x27;arrays.npz&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(data[<span class="string">&#x27;a&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存为文本</span></span><br><span class="line">np.savetxt(<span class="string">&#x27;arr.txt&#x27;</span>, arr, fmt=<span class="string">&#x27;%.2f&#x27;</span>, delimiter=<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">loaded = np.loadtxt(<span class="string">&#x27;arr.txt&#x27;</span>, delimiter=<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># CSV 文件</span></span><br><span class="line">data = np.genfromtxt(<span class="string">&#x27;data.csv&#x27;</span>, delimiter=<span class="string">&#x27;,&#x27;</span>, skip_header=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - npy 是 NumPy 专用格式，速度快</span></span><br><span class="line"><span class="comment"># - txt/csv 可读性好，但慢且占用空间大</span></span><br></pre></td></tr></table></figure>

<h2 id="九、性能优化建议"><a href="#九、性能优化建议" class="headerlink" title="九、性能优化建议"></a>九、性能优化建议</h2><blockquote>
<p><strong>提醒自己</strong>：</p>
<ol>
<li><strong>使用向量化</strong>：避免 Python 循环</li>
<li><strong>利用广播</strong>：减少内存复制</li>
<li><strong>选择合适的数据类型</strong>：float32 比 float64 快且省内存</li>
<li><strong>原地操作</strong>：使用 out 参数减少内存分配</li>
<li><strong>使用 views 而非 copies</strong>：切片时注意</li>
</ol>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 性能对比</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 循环方式（慢）</span></span><br><span class="line">arr = np.random.randn(<span class="number">1000000</span>)</span><br><span class="line">start = time.time()</span><br><span class="line">result = []</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> arr:</span><br><span class="line">    result.append(x ** <span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(time.time() - start)  <span class="comment"># ~0.5 秒</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 向量化（快）</span></span><br><span class="line">start = time.time()</span><br><span class="line">result = arr ** <span class="number">2</span></span><br><span class="line"><span class="built_in">print</span>(time.time() - start)  <span class="comment"># ~0.001 秒</span></span><br></pre></td></tr></table></figure>

<h2 id="十、练习"><a href="#十、练习" class="headerlink" title="十、练习"></a>十、练习</h2><ol>
<li>创建一个 5x5 的随机矩阵，计算每行每列的平均值</li>
<li>使用布尔索引找出数组中所有大于均值的元素</li>
<li>实现矩阵乘法（不使用@ 或 dot）</li>
<li>使用广播计算两组点之间的欧氏距离</li>
<li>生成 1000 个正态分布随机数，计算均值和标准差</li>
</ol>
<hr>
<p><strong>上一篇</strong>：<a href="/2026/02/24/Python-%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B%EF%BC%88%E4%B8%89%EF%BC%89%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/">Python 基础教程（三）：异常处理</a></p>
<p><strong>下一篇</strong>：[Python 数据科学（二）：Pandas 数据处理](&#x2F;2026&#x2F;02&#x2F;24&#x2F;Python-数据科学（二）Pandas 数据处理&#x2F;)</p>
<p><strong>参考资源</strong>：</p>
<ul>
<li><a href="https://numpy.org/doc/stable/">NumPy 官方文档</a></li>
<li><a href="https://numpy.org/doc/stable/user/quickstart.html">NumPy 快速入门</a></li>
<li><a href="https://github.com/rougier/numpy-100">100 道 NumPy 练习题</a></li>
</ul>
]]></content>
      <categories>
        <category>Python 数据科学</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>NumPy</tag>
        <tag>数据科学</tag>
        <tag>数值计算</tag>
      </tags>
  </entry>
  <entry>
    <title>Python 常用库（一）requests API 调用</title>
    <url>/2026/02/24/Python%20%E5%B8%B8%E7%94%A8%E5%BA%93%EF%BC%88%E4%B8%80%EF%BC%89requests%20API%20%E8%B0%83%E7%94%A8/</url>
    <content><![CDATA[<h1 id="Python-常用库（一）requests-API-调用"><a href="#Python-常用库（一）requests-API-调用" class="headerlink" title="Python 常用库（一）requests API 调用"></a>Python 常用库（一）requests API 调用</h1><p>requests 是 Python 最流行的 HTTP 客户端库。本篇将介绍如何使用 requests 进行 API 调用、处理响应、文件上传等实用技能。</p>
<h2 id="一、requests-简介"><a href="#一、requests-简介" class="headerlink" title="一、requests 简介"></a>一、requests 简介</h2><h3 id="1-1-为什么使用-requests？"><a href="#1-1-为什么使用-requests？" class="headerlink" title="1.1 为什么使用 requests？"></a>1.1 为什么使用 requests？</h3><ul>
<li><strong>简洁 API</strong>：人性化设计，代码简单易读</li>
<li><strong>功能强大</strong>：支持各种 HTTP 方法、认证、会话等</li>
<li><strong>生态完善</strong>：文档丰富，社区活跃</li>
<li><strong>自动处理</strong>：自动处理 URL 编码、Cookie、Session 等</li>
</ul>
<h3 id="1-2-安装与导入"><a href="#1-2-安装与导入" class="headerlink" title="1.2 安装与导入"></a>1.2 安装与导入</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pip install requests</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看版本</span></span><br><span class="line"><span class="built_in">print</span>(requests.__version__)</span><br></pre></td></tr></table></figure>

<h2 id="二、基础请求"><a href="#二、基础请求" class="headerlink" title="二、基础请求"></a>二、基础请求</h2><h3 id="2-1-GET-请求"><a href="#2-1-GET-请求" class="headerlink" title="2.1 GET 请求"></a>2.1 GET 请求</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment"># 最简单的 GET 请求</span></span><br><span class="line">response = requests.get(<span class="string">&#x27;https://api.example.com/data&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 带参数的 GET 请求</span></span><br><span class="line">params = &#123;<span class="string">&#x27;q&#x27;</span>: <span class="string">&#x27;python&#x27;</span>, <span class="string">&#x27;page&#x27;</span>: <span class="number">1</span>&#125;</span><br><span class="line">response = requests.get(<span class="string">&#x27;https://api.example.com/search&#x27;</span>, params=params)</span><br><span class="line"></span><br><span class="line"><span class="comment"># params 会自动拼接成 URL</span></span><br><span class="line"><span class="comment"># https://api.example.com/search?q=python&amp;page=1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看最终 URL</span></span><br><span class="line"><span class="built_in">print</span>(response.url)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加请求头</span></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">response = requests.get(<span class="string">&#x27;https://api.example.com/data&#x27;</span>, headers=headers)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置超时（秒）</span></span><br><span class="line">response = requests.get(<span class="string">&#x27;https://api.example.com/data&#x27;</span>, timeout=<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - timeout 是必须的，防止程序无限等待</span></span><br><span class="line"><span class="comment"># - User-Agent 避免被某些网站屏蔽</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-POST-请求"><a href="#2-2-POST-请求" class="headerlink" title="2.2 POST 请求"></a>2.2 POST 请求</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 发送 JSON 数据</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;张三&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;123456&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;email&#x27;</span>: <span class="string">&#x27;zhangsan@example.com&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">response = requests.post(<span class="string">&#x27;https://api.example.com/login&#x27;</span>, json=data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># json 参数会自动：</span></span><br><span class="line"><span class="comment"># 1. 将字典序列化为 JSON</span></span><br><span class="line"><span class="comment"># 2. 设置 Content-Type: application/json</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送表单数据</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;张三&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;123456&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">response = requests.post(<span class="string">&#x27;https://api.example.com/login&#x27;</span>, data=data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># data 参数会发送 application/x-www-form-urlencoded</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - 发送 JSON 用 json= 参数</span></span><br><span class="line"><span class="comment"># - 发送表单用 data= 参数</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-其他-HTTP-方法"><a href="#2-3-其他-HTTP-方法" class="headerlink" title="2.3 其他 HTTP 方法"></a>2.3 其他 HTTP 方法</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># PUT 请求（更新资源）</span></span><br><span class="line">response = requests.put(<span class="string">&#x27;https://api.example.com/users/1&#x27;</span>, json=&#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;新名字&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;email&#x27;</span>: <span class="string">&#x27;new@example.com&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># PATCH 请求（部分更新）</span></span><br><span class="line">response = requests.patch(<span class="string">&#x27;https://api.example.com/users/1&#x27;</span>, json=&#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;新名字&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># DELETE 请求（删除资源）</span></span><br><span class="line">response = requests.delete(<span class="string">&#x27;https://api.example.com/users/1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># HEAD 请求（只获取响应头）</span></span><br><span class="line">response = requests.head(<span class="string">&#x27;https://api.example.com/data&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(response.headers)</span><br><span class="line"></span><br><span class="line"><span class="comment"># OPTIONS 请求（获取服务器支持的方法）</span></span><br><span class="line">response = requests.options(<span class="string">&#x27;https://api.example.com/data&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(response.headers[<span class="string">&#x27;Allow&#x27;</span>])</span><br></pre></td></tr></table></figure>

<h2 id="三、响应处理"><a href="#三、响应处理" class="headerlink" title="三、响应处理"></a>三、响应处理</h2><h3 id="3-1-响应状态码"><a href="#3-1-响应状态码" class="headerlink" title="3.1 响应状态码"></a>3.1 响应状态码</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">response = requests.get(<span class="string">&#x27;https://api.example.com/data&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 状态码</span></span><br><span class="line"><span class="built_in">print</span>(response.status_code)  <span class="comment"># 200, 404, 500 等</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 常用状态码含义</span></span><br><span class="line"><span class="comment"># 200 OK - 请求成功</span></span><br><span class="line"><span class="comment"># 201 Created - 资源创建成功</span></span><br><span class="line"><span class="comment"># 204 No Content - 成功但无内容返回</span></span><br><span class="line"><span class="comment"># 400 Bad Request - 请求参数错误</span></span><br><span class="line"><span class="comment"># 401 Unauthorized - 未授权</span></span><br><span class="line"><span class="comment"># 403 Forbidden - 禁止访问</span></span><br><span class="line"><span class="comment"># 404 Not Found - 资源不存在</span></span><br><span class="line"><span class="comment"># 500 Internal Server Error - 服务器内部错误</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查是否成功</span></span><br><span class="line"><span class="keyword">if</span> response.ok:  <span class="comment"># 状态码 200-399</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;请求成功&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;成功&quot;</span>)</span><br><span class="line"><span class="keyword">elif</span> response.status_code == <span class="number">404</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;资源不存在&quot;</span>)</span><br><span class="line"><span class="keyword">elif</span> response.status_code &gt;= <span class="number">500</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;服务器错误&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 抛出异常（如果不是 200）</span></span><br><span class="line">response.raise_for_status()  <span class="comment"># 非 2xx 会抛出 HTTPError</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-响应内容"><a href="#3-2-响应内容" class="headerlink" title="3.2 响应内容"></a>3.2 响应内容</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">response = requests.get(<span class="string">&#x27;https://api.example.com/data&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># JSON 响应</span></span><br><span class="line">data = response.json()  <span class="comment"># 返回字典或列表</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 文本响应</span></span><br><span class="line">text = response.text  <span class="comment"># 字符串，自动解码</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 字节响应</span></span><br><span class="line">content = response.content  <span class="comment"># bytes，适合下载文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 响应头</span></span><br><span class="line"><span class="built_in">print</span>(response.headers)</span><br><span class="line"><span class="built_in">print</span>(response.headers[<span class="string">&#x27;Content-Type&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编码</span></span><br><span class="line"><span class="built_in">print</span>(response.encoding)  <span class="comment"># 检测的编码</span></span><br><span class="line">response.encoding = <span class="string">&#x27;utf-8&#x27;</span>  <span class="comment"># 手动设置编码</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - response.json() 会解析 JSON</span></span><br><span class="line"><span class="comment"># - response.text 自动解码</span></span><br><span class="line"><span class="comment"># - response.content 原始字节</span></span><br></pre></td></tr></table></figure>

<h3 id="3-3-下载文件"><a href="#3-3-下载文件" class="headerlink" title="3.3 下载文件"></a>3.3 下载文件</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 小文件下载</span></span><br><span class="line">response = requests.get(<span class="string">&#x27;https://example.com/file.jpg&#x27;</span>)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;file.jpg&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(response.content)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 大文件下载（流式，节省内存）</span></span><br><span class="line">response = requests.get(<span class="string">&#x27;https://example.com/large_file.zip&#x27;</span>, stream=<span class="literal">True</span>)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;large_file.zip&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> chunk <span class="keyword">in</span> response.iter_content(chunk_size=<span class="number">8192</span>):</span><br><span class="line">        f.write(chunk)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 带进度条的下载（需要 tqdm）</span></span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line">response = requests.get(<span class="string">&#x27;https://example.com/large_file.zip&#x27;</span>, stream=<span class="literal">True</span>)</span><br><span class="line">total = <span class="built_in">int</span>(response.headers.get(<span class="string">&#x27;content-length&#x27;</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;large_file.zip&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">with</span> tqdm(total=total, unit=<span class="string">&#x27;B&#x27;</span>, unit_scale=<span class="literal">True</span>) <span class="keyword">as</span> pbar:</span><br><span class="line">        <span class="keyword">for</span> chunk <span class="keyword">in</span> response.iter_content(chunk_size=<span class="number">8192</span>):</span><br><span class="line">            f.write(chunk)</span><br><span class="line">            pbar.update(<span class="built_in">len</span>(chunk))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - 大文件一定要用 stream=True</span></span><br><span class="line"><span class="comment"># - iter_content 分块读取，避免内存溢出</span></span><br></pre></td></tr></table></figure>

<h2 id="四、请求头与认证"><a href="#四、请求头与认证" class="headerlink" title="四、请求头与认证"></a>四、请求头与认证</h2><h3 id="4-1-自定义请求头"><a href="#4-1-自定义请求头" class="headerlink" title="4.1 自定义请求头"></a>4.1 自定义请求头</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;MyApp/1.0&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Authorization&#x27;</span>: <span class="string">&#x27;Bearer YOUR_TOKEN&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;X-Custom-Header&#x27;</span>: <span class="string">&#x27;value&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">response = requests.get(<span class="string">&#x27;https://api.example.com/data&#x27;</span>, headers=headers)</span><br></pre></td></tr></table></figure>

<h3 id="4-2-Basic-认证"><a href="#4-2-Basic-认证" class="headerlink" title="4.2 Basic 认证"></a>4.2 Basic 认证</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> requests.auth <span class="keyword">import</span> HTTPBasicAuth</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式一：使用 HTTPBasicAuth</span></span><br><span class="line">response = requests.get(</span><br><span class="line">    <span class="string">&#x27;https://api.example.com/protected&#x27;</span>,</span><br><span class="line">    auth=HTTPBasicAuth(<span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式二：简化写法</span></span><br><span class="line">response = requests.get(</span><br><span class="line">    <span class="string">&#x27;https://api.example.com/protected&#x27;</span>,</span><br><span class="line">    auth=(<span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式三：手动设置 Header</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">credentials = base64.b64encode(<span class="string">b&#x27;username:password&#x27;</span>).decode()</span><br><span class="line">headers = &#123;<span class="string">&#x27;Authorization&#x27;</span>: <span class="string">f&#x27;Basic <span class="subst">&#123;credentials&#125;</span>&#x27;</span>&#125;</span><br><span class="line">response = requests.get(<span class="string">&#x27;https://api.example.com/protected&#x27;</span>, headers=headers)</span><br></pre></td></tr></table></figure>

<h3 id="4-3-Token-Bearer-认证"><a href="#4-3-Token-Bearer-认证" class="headerlink" title="4.3 Token&#x2F;Bearer 认证"></a>4.3 Token&#x2F;Bearer 认证</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># API Key</span></span><br><span class="line">headers = &#123;<span class="string">&#x27;Authorization&#x27;</span>: <span class="string">&#x27;Bearer YOUR_ACCESS_TOKEN&#x27;</span>&#125;</span><br><span class="line">response = requests.get(<span class="string">&#x27;https://api.example.com/data&#x27;</span>, headers=headers)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">headers = &#123;<span class="string">&#x27;X-API-Key&#x27;</span>: <span class="string">&#x27;YOUR_API_KEY&#x27;</span>&#125;</span><br><span class="line">response = requests.get(<span class="string">&#x27;https://api.example.com/data&#x27;</span>, headers=headers)</span><br></pre></td></tr></table></figure>

<h3 id="4-4-Cookie-处理"><a href="#4-4-Cookie-处理" class="headerlink" title="4.4 Cookie 处理"></a>4.4 Cookie 处理</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 发送 Cookie</span></span><br><span class="line">cookies = &#123;<span class="string">&#x27;session_id&#x27;</span>: <span class="string">&#x27;abc123&#x27;</span>, <span class="string">&#x27;user&#x27;</span>: <span class="string">&#x27;zhangsan&#x27;</span>&#125;</span><br><span class="line">response = requests.get(<span class="string">&#x27;https://api.example.com/data&#x27;</span>, cookies=cookies)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取 Cookie</span></span><br><span class="line">response = requests.get(<span class="string">&#x27;https://api.example.com/login&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(response.cookies.get_dict())</span><br><span class="line"><span class="built_in">print</span>(response.cookies[<span class="string">&#x27;session_id&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 持久化 Cookie（使用 Session）</span></span><br><span class="line">session = requests.Session()</span><br><span class="line">session.get(<span class="string">&#x27;https://api.example.com/login&#x27;</span>, data=&#123;<span class="string">&#x27;user&#x27;</span>: <span class="string">&#x27;张三&#x27;</span>, <span class="string">&#x27;pwd&#x27;</span>: <span class="string">&#x27;123&#x27;</span>&#125;)</span><br><span class="line"><span class="comment"># Cookie 自动保存</span></span><br><span class="line">response = session.get(<span class="string">&#x27;https://api.example.com/protected&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="五、Session-会话"><a href="#五、Session-会话" class="headerlink" title="五、Session 会话"></a>五、Session 会话</h2><h3 id="5-1-Session-基础"><a href="#5-1-Session-基础" class="headerlink" title="5.1 Session 基础"></a>5.1 Session 基础</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建会话</span></span><br><span class="line">session = requests.Session()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 会话会保持 Cookie 和连接</span></span><br><span class="line">session.get(<span class="string">&#x27;https://api.example.com/login&#x27;</span>, data=&#123;</span><br><span class="line">    <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;张三&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;123456&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 后续请求自动携带 Cookie</span></span><br><span class="line">response = session.get(<span class="string">&#x27;https://api.example.com/profile&#x27;</span>)</span><br><span class="line">response = session.get(<span class="string">&#x27;https://api.example.com/settings&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭会话</span></span><br><span class="line">session.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 推荐使用上下文管理器</span></span><br><span class="line"><span class="keyword">with</span> requests.Session() <span class="keyword">as</span> session:</span><br><span class="line">    session.get(<span class="string">&#x27;https://api.example.com/login&#x27;</span>, data=&#123;...&#125;)</span><br><span class="line">    response = session.get(<span class="string">&#x27;https://api.example.com/profile&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="5-2-Session-配置"><a href="#5-2-Session-配置" class="headerlink" title="5.2 Session 配置"></a>5.2 Session 配置</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">session = requests.Session()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置默认请求头</span></span><br><span class="line">session.headers.update(&#123;</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;MyApp/1.0&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置默认超时</span></span><br><span class="line"><span class="comment"># 注意：requests 不直接支持 Session 级别的超时设置</span></span><br><span class="line"><span class="comment"># 需要在每次请求时指定</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加 Adapter（连接池配置）</span></span><br><span class="line"><span class="keyword">from</span> requests.adapters <span class="keyword">import</span> HTTPAdapter</span><br><span class="line"></span><br><span class="line">adapter = HTTPAdapter(</span><br><span class="line">    pool_connections=<span class="number">10</span>,      <span class="comment"># 连接池大小</span></span><br><span class="line">    pool_maxsize=<span class="number">20</span>,          <span class="comment"># 最大连接数</span></span><br><span class="line">    max_retries=<span class="number">3</span>,            <span class="comment"># 重试次数</span></span><br><span class="line">    pool_block=<span class="literal">False</span>          <span class="comment"># 是否阻塞</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">session.mount(<span class="string">&#x27;https://&#x27;</span>, adapter)</span><br><span class="line">session.mount(<span class="string">&#x27;http://&#x27;</span>, adapter)</span><br></pre></td></tr></table></figure>

<h3 id="5-3-性能优势"><a href="#5-3-性能优势" class="headerlink" title="5.3 性能优势"></a>5.3 性能优势</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不使用 Session（每次新建连接）</span></span><br><span class="line">start = time.time()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    requests.get(<span class="string">&#x27;https://api.example.com/data&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Without Session: <span class="subst">&#123;time.time() - start:<span class="number">.2</span>f&#125;</span>s&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 Session（复用连接）</span></span><br><span class="line">start = time.time()</span><br><span class="line">session = requests.Session()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    session.get(<span class="string">&#x27;https://api.example.com/data&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;With Session: <span class="subst">&#123;time.time() - start:<span class="number">.2</span>f&#125;</span>s&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - 多次请求同一域名一定要用 Session</span></span><br><span class="line"><span class="comment"># - 连接池可以显著提升性能</span></span><br></pre></td></tr></table></figure>

<h2 id="六、异常处理"><a href="#六、异常处理" class="headerlink" title="六、异常处理"></a>六、异常处理</h2><h3 id="6-1-常见异常"><a href="#6-1-常见异常" class="headerlink" title="6.1 常见异常"></a>6.1 常见异常</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> requests.exceptions <span class="keyword">import</span> (</span><br><span class="line">    RequestException,</span><br><span class="line">    Timeout,</span><br><span class="line">    ConnectionError,</span><br><span class="line">    HTTPError,</span><br><span class="line">    TooManyRedirects,</span><br><span class="line">    JSONDecodeError</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = requests.get(<span class="string">&#x27;https://api.example.com/data&#x27;</span>, timeout=<span class="number">5</span>)</span><br><span class="line">    response.raise_for_status()</span><br><span class="line">    data = response.json()</span><br><span class="line"><span class="keyword">except</span> Timeout:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;请求超时&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> ConnectionError:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;连接错误&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> HTTPError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;HTTP 错误：<span class="subst">&#123;e.response.status_code&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> JSONDecodeError:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;JSON 解析失败&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> RequestException <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;请求异常：<span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="6-2-重试机制"><a href="#6-2-重试机制" class="headerlink" title="6.2 重试机制"></a>6.2 重试机制</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> requests.adapters <span class="keyword">import</span> HTTPAdapter</span><br><span class="line"><span class="keyword">from</span> urllib3.util.retry <span class="keyword">import</span> Retry</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_retry_session</span>():</span><br><span class="line">    session = requests.Session()</span><br><span class="line"></span><br><span class="line">    retry = Retry(</span><br><span class="line">        total=<span class="number">3</span>,                    <span class="comment"># 总重试次数</span></span><br><span class="line">        backoff_factor=<span class="number">0.5</span>,         <span class="comment"># 重试间隔倍数</span></span><br><span class="line">        status_forcelist=[<span class="number">500</span>, <span class="number">502</span>, <span class="number">503</span>, <span class="number">504</span>],  <span class="comment"># 需要重试的状态码</span></span><br><span class="line">        allowed_methods=[<span class="string">&quot;HEAD&quot;</span>, <span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>, <span class="string">&quot;PUT&quot;</span>]  <span class="comment"># 可重试的方法</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    adapter = HTTPAdapter(max_retries=retry)</span><br><span class="line">    session.mount(<span class="string">&#x27;https://&#x27;</span>, adapter)</span><br><span class="line">    session.mount(<span class="string">&#x27;http://&#x27;</span>, adapter)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> session</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line">session = create_retry_session()</span><br><span class="line">response = session.get(<span class="string">&#x27;https://api.example.com/data&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="七、高级用法"><a href="#七、高级用法" class="headerlink" title="七、高级用法"></a>七、高级用法</h2><h3 id="7-1-文件上传"><a href="#7-1-文件上传" class="headerlink" title="7.1 文件上传"></a>7.1 文件上传</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 上传单个文件</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;file.txt&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    files = &#123;<span class="string">&#x27;file&#x27;</span>: f&#125;</span><br><span class="line">    response = requests.post(<span class="string">&#x27;https://api.example.com/upload&#x27;</span>, files=files)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定文件名</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;file.txt&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    files = &#123;<span class="string">&#x27;file&#x27;</span>: (<span class="string">&#x27;custom_name.txt&#x27;</span>, f)&#125;</span><br><span class="line">    response = requests.post(<span class="string">&#x27;https://api.example.com/upload&#x27;</span>, files=files)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定文件类型</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;image.jpg&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    files = &#123;<span class="string">&#x27;file&#x27;</span>: (<span class="string">&#x27;image.jpg&#x27;</span>, f, <span class="string">&#x27;image/jpeg&#x27;</span>)&#125;</span><br><span class="line">    response = requests.post(<span class="string">&#x27;https://api.example.com/upload&#x27;</span>, files=files)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 完整格式</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;file.txt&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    files = &#123;</span><br><span class="line">        <span class="string">&#x27;file&#x27;</span>: (<span class="string">&#x27;filename.txt&#x27;</span>, f, <span class="string">&#x27;text/plain&#x27;</span>, &#123;<span class="string">&#x27;Expires&#x27;</span>: <span class="string">&#x27;0&#x27;</span>&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    response = requests.post(<span class="string">&#x27;https://api.example.com/upload&#x27;</span>, files=files)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传多个文件</span></span><br><span class="line">files = &#123;</span><br><span class="line">    <span class="string">&#x27;file1&#x27;</span>: <span class="built_in">open</span>(<span class="string">&#x27;file1.txt&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>),</span><br><span class="line">    <span class="string">&#x27;file2&#x27;</span>: <span class="built_in">open</span>(<span class="string">&#x27;file2.txt&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line">response = requests.post(<span class="string">&#x27;https://api.example.com/upload&#x27;</span>, files=files)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 带其他表单数据</span></span><br><span class="line">data = &#123;<span class="string">&#x27;description&#x27;</span>: <span class="string">&#x27;文件描述&#x27;</span>&#125;</span><br><span class="line">files = &#123;<span class="string">&#x27;file&#x27;</span>: <span class="built_in">open</span>(<span class="string">&#x27;file.txt&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>)&#125;</span><br><span class="line">response = requests.post(<span class="string">&#x27;https://api.example.com/upload&#x27;</span>, data=data, files=files)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - 文件要用 &#x27;rb&#x27; 模式打开</span></span><br><span class="line"><span class="comment"># - 上传后记得关闭文件</span></span><br></pre></td></tr></table></figure>

<h3 id="7-2-发送-Cookie"><a href="#7-2-发送-Cookie" class="headerlink" title="7.2 发送 Cookie"></a>7.2 发送 Cookie</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 发送 Cookie</span></span><br><span class="line">cookies = &#123;<span class="string">&#x27;session&#x27;</span>: <span class="string">&#x27;abc123&#x27;</span>, <span class="string">&#x27;user&#x27;</span>: <span class="string">&#x27;zhangsan&#x27;</span>&#125;</span><br><span class="line">response = requests.get(<span class="string">&#x27;https://api.example.com/data&#x27;</span>, cookies=cookies)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 CookieJar</span></span><br><span class="line"><span class="keyword">from</span> http.cookiejar <span class="keyword">import</span> CookieJar</span><br><span class="line"></span><br><span class="line">cj = CookieJar()</span><br><span class="line">session = requests.Session()</span><br><span class="line">session.cookies = cj</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录后 Cookie 自动保存</span></span><br><span class="line">session.post(<span class="string">&#x27;https://api.example.com/login&#x27;</span>, data=&#123;<span class="string">&#x27;user&#x27;</span>: <span class="string">&#x27;张三&#x27;</span>, <span class="string">&#x27;pwd&#x27;</span>: <span class="string">&#x27;123&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 后续请求自动携带 Cookie</span></span><br><span class="line">response = session.get(<span class="string">&#x27;https://api.example.com/protected&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="7-3-代理设置"><a href="#7-3-代理设置" class="headerlink" title="7.3 代理设置"></a>7.3 代理设置</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 单个请求使用代理</span></span><br><span class="line">proxies = &#123;</span><br><span class="line">    <span class="string">&#x27;http&#x27;</span>: <span class="string">&#x27;http://proxy.example.com:8080&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;https&#x27;</span>: <span class="string">&#x27;https://proxy.example.com:8080&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">response = requests.get(<span class="string">&#x27;https://api.example.com/data&#x27;</span>, proxies=proxies)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 带认证的代理</span></span><br><span class="line">proxies = &#123;</span><br><span class="line">    <span class="string">&#x27;https&#x27;</span>: <span class="string">&#x27;http://user:password@proxy.example.com:8080&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Session 级别设置代理</span></span><br><span class="line">session = requests.Session()</span><br><span class="line">session.proxies = &#123;</span><br><span class="line">    <span class="string">&#x27;https&#x27;</span>: <span class="string">&#x27;https://proxy.example.com:8080&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-4-请求准备与发送"><a href="#7-4-请求准备与发送" class="headerlink" title="7.4 请求准备与发送"></a>7.4 请求准备与发送</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 手动准备请求</span></span><br><span class="line">req = requests.Request(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;https://api.example.com/data&#x27;</span>, json=&#123;<span class="string">&#x27;key&#x27;</span>: <span class="string">&#x27;value&#x27;</span>&#125;)</span><br><span class="line">prepared = req.prepare()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看请求详情</span></span><br><span class="line"><span class="built_in">print</span>(prepared.url)</span><br><span class="line"><span class="built_in">print</span>(prepared.headers)</span><br><span class="line"><span class="built_in">print</span>(prepared.body)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 Session 发送</span></span><br><span class="line">session = requests.Session()</span><br><span class="line">response = session.send(prepared)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - 适合需要完全控制请求的场景</span></span><br><span class="line"><span class="comment"># - 可以用于请求签名等高级操作</span></span><br></pre></td></tr></table></figure>

<h2 id="八、实战示例"><a href="#八、实战示例" class="headerlink" title="八、实战示例"></a>八、实战示例</h2><h3 id="8-1-调用-REST-API"><a href="#8-1-调用-REST-API" class="headerlink" title="8.1 调用 REST API"></a>8.1 调用 REST API</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">APIClient</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;简单的 API 客户端&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, base_url, api_key=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.base_url = base_url</span><br><span class="line">        <span class="variable language_">self</span>.session = requests.Session()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> api_key:</span><br><span class="line">            <span class="variable language_">self</span>.session.headers.update(&#123;</span><br><span class="line">                <span class="string">&#x27;Authorization&#x27;</span>: <span class="string">f&#x27;Bearer <span class="subst">&#123;api_key&#125;</span>&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, endpoint, **kwargs</span>):</span><br><span class="line">        url = <span class="string">f&quot;<span class="subst">&#123;self.base_url&#125;</span>/<span class="subst">&#123;endpoint&#125;</span>&quot;</span></span><br><span class="line">        response = <span class="variable language_">self</span>.session.get(url, **kwargs)</span><br><span class="line">        response.raise_for_status()</span><br><span class="line">        <span class="keyword">return</span> response.json()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">post</span>(<span class="params">self, endpoint, data=<span class="literal">None</span>, **kwargs</span>):</span><br><span class="line">        url = <span class="string">f&quot;<span class="subst">&#123;self.base_url&#125;</span>/<span class="subst">&#123;endpoint&#125;</span>&quot;</span></span><br><span class="line">        response = <span class="variable language_">self</span>.session.post(url, json=data, **kwargs)</span><br><span class="line">        response.raise_for_status()</span><br><span class="line">        <span class="keyword">return</span> response.json()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">put</span>(<span class="params">self, endpoint, data=<span class="literal">None</span>, **kwargs</span>):</span><br><span class="line">        url = <span class="string">f&quot;<span class="subst">&#123;self.base_url&#125;</span>/<span class="subst">&#123;endpoint&#125;</span>&quot;</span></span><br><span class="line">        response = <span class="variable language_">self</span>.session.put(url, json=data, **kwargs)</span><br><span class="line">        response.raise_for_status()</span><br><span class="line">        <span class="keyword">return</span> response.json()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">self, endpoint, **kwargs</span>):</span><br><span class="line">        url = <span class="string">f&quot;<span class="subst">&#123;self.base_url&#125;</span>/<span class="subst">&#123;endpoint&#125;</span>&quot;</span></span><br><span class="line">        response = <span class="variable language_">self</span>.session.delete(url, **kwargs)</span><br><span class="line">        response.raise_for_status()</span><br><span class="line">        <span class="keyword">return</span> response.status_code == <span class="number">204</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line">client = APIClient(<span class="string">&#x27;https://api.example.com&#x27;</span>, api_key=<span class="string">&#x27;YOUR_KEY&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取列表</span></span><br><span class="line">users = client.get(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取单个</span></span><br><span class="line">user = client.get(<span class="string">&#x27;users/1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建</span></span><br><span class="line">new_user = client.post(<span class="string">&#x27;users&#x27;</span>, &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;张三&#x27;</span>, <span class="string">&#x27;email&#x27;</span>: <span class="string">&#x27;zhangsan@example.com&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新</span></span><br><span class="line">client.put(<span class="string">&#x27;users/1&#x27;</span>, &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;李四&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除</span></span><br><span class="line">client.delete(<span class="string">&#x27;users/1&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="8-2-分页数据获取"><a href="#8-2-分页数据获取" class="headerlink" title="8.2 分页数据获取"></a>8.2 分页数据获取</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_all_pages</span>(<span class="params">base_url</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;获取所有分页数据&quot;&quot;&quot;</span></span><br><span class="line">    all_data = []</span><br><span class="line">    page = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        response = requests.get(base_url, params=&#123;<span class="string">&#x27;page&#x27;</span>: page&#125;)</span><br><span class="line">        response.raise_for_status()</span><br><span class="line">        data = response.json()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:  <span class="comment"># 没有更多数据</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        all_data.extend(data)</span><br><span class="line">        page += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> all_data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line">all_users = get_all_pages(<span class="string">&#x27;https://api.example.com/users&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="8-3-并发请求（配合-concurrent-futures）"><a href="#8-3-并发请求（配合-concurrent-futures）" class="headerlink" title="8.3 并发请求（配合 concurrent.futures）"></a>8.3 并发请求（配合 concurrent.futures）</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor, as_completed</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fetch_url</span>(<span class="params">url</span>):</span><br><span class="line">    response = requests.get(url, timeout=<span class="number">5</span>)</span><br><span class="line">    <span class="keyword">return</span> url, response.status_code</span><br><span class="line"></span><br><span class="line">urls = [</span><br><span class="line">    <span class="string">&#x27;https://api.example.com/data1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;https://api.example.com/data2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;https://api.example.com/data3&#x27;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">results = &#123;&#125;</span><br><span class="line"><span class="keyword">with</span> ThreadPoolExecutor(max_workers=<span class="number">5</span>) <span class="keyword">as</span> executor:</span><br><span class="line">    futures = &#123;executor.submit(fetch_url, url): url <span class="keyword">for</span> url <span class="keyword">in</span> urls&#125;</span><br><span class="line">    <span class="keyword">for</span> future <span class="keyword">in</span> as_completed(futures):</span><br><span class="line">        url, status = future.result()</span><br><span class="line">        results[url] = status</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(results)</span><br></pre></td></tr></table></figure>

<h2 id="九、最佳实践"><a href="#九、最佳实践" class="headerlink" title="九、最佳实践"></a>九、最佳实践</h2><blockquote>
<p><strong>提醒自己</strong>：</p>
<ol>
<li><strong>始终设置超时</strong>：防止程序卡死</li>
<li><strong>使用 Session</strong>：复用连接，提高效率</li>
<li><strong>处理异常</strong>：网络请求随时可能失败</li>
<li><strong>检查状态码</strong>：不要假设请求总是成功</li>
<li><strong>限制重试</strong>：避免无限重试</li>
<li><strong>使用上下文管理器</strong>：确保资源正确释放</li>
<li><strong>记录日志</strong>：方便调试和问题追踪</li>
</ol>
</blockquote>
<h2 id="十、练习"><a href="#十、练习" class="headerlink" title="十、练习"></a>十、练习</h2><ol>
<li>编写一个函数，获取 GitHub 用户的公开信息</li>
<li>实现一个带重试机制的下载器</li>
<li>使用 Session 实现需要登录的 API 调用</li>
<li>编写一个批量检测网站可用性的脚本</li>
<li>实现一个简单的 API 客户端类，封装常用的 CRUD 操作</li>
</ol>
<hr>
<p><strong>上一篇</strong>：[Python 数据科学（三）：PyArrow 高性能数据操作](&#x2F;2026&#x2F;02&#x2F;24&#x2F;Python-数据科学（三）PyArrow 高性能数据操作&#x2F;)</p>
<p><strong>下一篇</strong>：<a href="/2026/02/24/Python-%E5%B8%B8%E7%94%A8%E5%BA%93%EF%BC%88%E4%BA%8C%EF%BC%89json-yaml-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/">Python 常用库（二）：json&#x2F;yaml配置文件处理</a></p>
<p><strong>参考资源</strong>：</p>
<ul>
<li><a href="https://requests.readthedocs.io/">requests 官方文档</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status">HTTP 状态码文档</a></li>
<li><a href="https://docs.python-requests.org/en/master/user/advanced/">Real World Requests</a></li>
</ul>
]]></content>
      <categories>
        <category>Python 教程</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>requests</tag>
        <tag>API</tag>
        <tag>HTTP</tag>
      </tags>
  </entry>
  <entry>
    <title>Python 常用库（二）json/yaml 配置文件处理</title>
    <url>/2026/02/24/Python%20%E5%B8%B8%E7%94%A8%E5%BA%93%EF%BC%88%E4%BA%8C%EF%BC%89json%20yaml%20%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/</url>
    <content><![CDATA[<h1 id="Python-常用库（二）json-yaml-配置文件处理"><a href="#Python-常用库（二）json-yaml-配置文件处理" class="headerlink" title="Python 常用库（二）json&#x2F;yaml 配置文件处理"></a>Python 常用库（二）json&#x2F;yaml 配置文件处理</h1><p>配置文件是项目中不可或缺的部分。本篇将介绍如何使用 json 和 yaml 格式进行配置管理。</p>
<h2 id="一、JSON-基础"><a href="#一、JSON-基础" class="headerlink" title="一、JSON 基础"></a>一、JSON 基础</h2><h3 id="1-1-JSON-简介"><a href="#1-1-JSON-简介" class="headerlink" title="1.1 JSON 简介"></a>1.1 JSON 简介</h3><p><strong>JSON（JavaScript Object Notation）</strong> 是一种轻量级的数据交换格式，易于人阅读和编写，也易于机器解析和生成。</p>
<p><strong>JSON 支持的数据类型：</strong></p>
<ul>
<li>字符串（string）</li>
<li>数字（number）</li>
<li>布尔值（boolean）</li>
<li>null</li>
<li>数组（array）</li>
<li>对象（object）</li>
</ul>
<h3 id="1-2-JSON-与-Python-类型对应"><a href="#1-2-JSON-与-Python-类型对应" class="headerlink" title="1.2 JSON 与 Python 类型对应"></a>1.2 JSON 与 Python 类型对应</h3><table>
<thead>
<tr>
<th>JSON</th>
<th>Python</th>
</tr>
</thead>
<tbody><tr>
<td>object</td>
<td>dict</td>
</tr>
<tr>
<td>array</td>
<td>list</td>
</tr>
<tr>
<td>string</td>
<td>str</td>
</tr>
<tr>
<td>number (int)</td>
<td>int</td>
</tr>
<tr>
<td>number (float)</td>
<td>float</td>
</tr>
<tr>
<td>true</td>
<td>True</td>
</tr>
<tr>
<td>false</td>
<td>False</td>
</tr>
<tr>
<td>null</td>
<td>None</td>
</tr>
</tbody></table>
<h2 id="二、json-模块使用"><a href="#二、json-模块使用" class="headerlink" title="二、json 模块使用"></a>二、json 模块使用</h2><h3 id="2-1-序列化与反序列化"><a href="#2-1-序列化与反序列化" class="headerlink" title="2.1 序列化与反序列化"></a>2.1 序列化与反序列化</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="comment"># Python 对象</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;张三&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;age&#x27;</span>: <span class="number">25</span>,</span><br><span class="line">    <span class="string">&#x27;is_student&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">    <span class="string">&#x27;skills&#x27;</span>: [<span class="string">&#x27;Python&#x27;</span>, <span class="string">&#x27;Java&#x27;</span>, <span class="string">&#x27;Go&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;address&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;city&#x27;</span>: <span class="string">&#x27;北京&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;district&#x27;</span>: <span class="string">&#x27;海淀区&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;salary&#x27;</span>: <span class="literal">None</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 序列化：Python -&gt; JSON 字符串</span></span><br><span class="line">json_str = json.dumps(data)</span><br><span class="line"><span class="built_in">print</span>(json_str)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 带格式的 JSON 字符串</span></span><br><span class="line">json_str = json.dumps(data, indent=<span class="number">2</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line"><span class="built_in">print</span>(json_str)</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;name&quot;: &quot;张三&quot;,</span></span><br><span class="line"><span class="string">  &quot;age&quot;: 25,</span></span><br><span class="line"><span class="string">  &quot;is_student&quot;: false,</span></span><br><span class="line"><span class="string">  &quot;skills&quot;: [</span></span><br><span class="line"><span class="string">    &quot;Python&quot;,</span></span><br><span class="line"><span class="string">    &quot;Java&quot;,</span></span><br><span class="line"><span class="string">    &quot;Go&quot;</span></span><br><span class="line"><span class="string">  ],</span></span><br><span class="line"><span class="string">  &quot;address&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;city&quot;: &quot;北京&quot;,</span></span><br><span class="line"><span class="string">    &quot;district&quot;: &quot;海淀区&quot;</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  &quot;salary&quot;: null</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 反序列化：JSON 字符串 -&gt; Python 对象</span></span><br><span class="line">data = json.loads(json_str)</span><br><span class="line"><span class="built_in">print</span>(data[<span class="string">&#x27;name&#x27;</span>])  <span class="comment"># 张三</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - indent 控制缩进，让 JSON 更可读</span></span><br><span class="line"><span class="comment"># - ensure_ascii=False 保留中文字符</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-文件读写"><a href="#2-2-文件读写" class="headerlink" title="2.2 文件读写"></a>2.2 文件读写</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入 JSON 文件</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;张三&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;age&#x27;</span>: <span class="number">25</span>,</span><br><span class="line">    <span class="string">&#x27;skills&#x27;</span>: [<span class="string">&#x27;Python&#x27;</span>, <span class="string">&#x27;Java&#x27;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;data.json&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    json.dump(data, f, indent=<span class="number">2</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取 JSON 文件</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;data.json&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    data = json.load(f)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - json.dump() 写入文件</span></span><br><span class="line"><span class="comment"># - json.load() 从文件读取</span></span><br><span class="line"><span class="comment"># - json.dumps() 转为字符串（s = string）</span></span><br><span class="line"><span class="comment"># - json.loads() 从字符串读取</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-自定义序列化"><a href="#2-3-自定义序列化" class="headerlink" title="2.3 自定义序列化"></a>2.3 自定义序列化</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义类型无法直接序列化</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, age</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        <span class="variable language_">self</span>.age = age</span><br><span class="line"></span><br><span class="line">person = Person(<span class="string">&#x27;张三&#x27;</span>, <span class="number">25</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式一：使用 default 参数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">default_handler</span>(<span class="params">obj</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">hasattr</span>(obj, <span class="string">&#x27;__dict__&#x27;</span>):</span><br><span class="line">        <span class="keyword">return</span> obj.__dict__</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(obj, datetime):</span><br><span class="line">        <span class="keyword">return</span> obj.isoformat()</span><br><span class="line">    <span class="keyword">raise</span> TypeError(<span class="string">f&quot;Type <span class="subst">&#123;<span class="built_in">type</span>(obj)&#125;</span> not serializable&quot;</span>)</span><br><span class="line"></span><br><span class="line">json_str = json.dumps(person, default=default_handler, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式二：使用 JSONEncoder</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomEncoder</span>(json.JSONEncoder):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">default</span>(<span class="params">self, obj</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(obj, Person):</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&#x27;name&#x27;</span>: obj.name, <span class="string">&#x27;age&#x27;</span>: obj.age, <span class="string">&#x27;__type__&#x27;</span>: <span class="string">&#x27;Person&#x27;</span>&#125;</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(obj, datetime):</span><br><span class="line">            <span class="keyword">return</span> obj.isoformat()</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().default(obj)</span><br><span class="line"></span><br><span class="line">json_str = json.dumps(person, cls=CustomEncoder, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式三：实现 to_dict 方法</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, age</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        <span class="variable language_">self</span>.age = age</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">to_dict</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&#x27;name&#x27;</span>: <span class="variable language_">self</span>.name, <span class="string">&#x27;age&#x27;</span>: <span class="variable language_">self</span>.age&#125;</span><br><span class="line"></span><br><span class="line">person = Person(<span class="string">&#x27;张三&#x27;</span>, <span class="number">25</span>)</span><br><span class="line">json_str = json.dumps(person.to_dict(), ensure_ascii=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - default 参数处理无法序列化的对象</span></span><br><span class="line"><span class="comment"># - 自定义 Encoder 更灵活</span></span><br><span class="line"><span class="comment"># - 最简单的方式是自己实现 to_dict()</span></span><br></pre></td></tr></table></figure>

<h3 id="2-4-自定义反序列化"><a href="#2-4-自定义反序列化" class="headerlink" title="2.4 自定义反序列化"></a>2.4 自定义反序列化</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 恢复自定义类型</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">object_hook</span>(<span class="params">d</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;__type__&#x27;</span> <span class="keyword">in</span> d:</span><br><span class="line">        <span class="keyword">if</span> d[<span class="string">&#x27;__type__&#x27;</span>] == <span class="string">&#x27;Person&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> Person(d[<span class="string">&#x27;name&#x27;</span>], d[<span class="string">&#x27;age&#x27;</span>])</span><br><span class="line">    <span class="keyword">return</span> d</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, age</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        <span class="variable language_">self</span>.age = age</span><br><span class="line"></span><br><span class="line">json_str = <span class="string">&#x27;&#123;&quot;name&quot;: &quot;张三&quot;, &quot;age&quot;: 25, &quot;__type__&quot;: &quot;Person&quot;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">person = json.loads(json_str, object_hook=object_hook)</span><br><span class="line"><span class="built_in">print</span>(person.name)  <span class="comment"># 张三</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(person))  <span class="comment"># &lt;class &#x27;__main__.Person&#x27;&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="三、YAML-基础"><a href="#三、YAML-基础" class="headerlink" title="三、YAML 基础"></a>三、YAML 基础</h2><h3 id="3-1-YAML-简介"><a href="#3-1-YAML-简介" class="headerlink" title="3.1 YAML 简介"></a>3.1 YAML 简介</h3><p><strong>YAML（YAML Ain’t a Markup Language）</strong> 是一种人类可读的数据序列化格式，特别适合配置文件。</p>
<p><strong>YAML 特点：</strong></p>
<ul>
<li>使用缩进表示层级（类似 Python）</li>
<li>支持注释（# 开头）</li>
<li>语法简洁，可读性好</li>
</ul>
<h3 id="3-2-YAML-语法"><a href="#3-2-YAML-语法" class="headerlink" title="3.2 YAML 语法"></a>3.2 YAML 语法</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 基本数据类型</span></span><br><span class="line"><span class="attr">string:</span> <span class="string">hello</span></span><br><span class="line"><span class="attr">number:</span> <span class="number">42</span></span><br><span class="line"><span class="attr">float:</span> <span class="number">3.14</span></span><br><span class="line"><span class="attr">boolean:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">null_value:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">another_null:</span> <span class="string">~</span>  <span class="comment"># YAML 特有的 null 表示法</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 字符串</span></span><br><span class="line"><span class="attr">plain:</span> <span class="string">普通字符串</span></span><br><span class="line"><span class="attr">quoted:</span> <span class="string">&quot;带引号的字符串&quot;</span></span><br><span class="line"><span class="attr">with_newline:</span> <span class="string">|</span></span><br><span class="line"><span class="string">  这是多行字符串</span></span><br><span class="line"><span class="string">  第二行</span></span><br><span class="line"><span class="string">  第三行</span></span><br><span class="line"><span class="string"></span><span class="attr">folded:</span> <span class="string">&gt;</span></span><br><span class="line"><span class="string">  这是折叠的多行字符串</span></span><br><span class="line"><span class="string">  会被合并成一行</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="comment"># 列表/数组</span></span><br><span class="line"><span class="attr">fruits:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apple</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">banana</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">orange</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 行内列表</span></span><br><span class="line"><span class="attr">colors:</span> [<span class="string">red</span>, <span class="string">green</span>, <span class="string">blue</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 字典/对象</span></span><br><span class="line"><span class="attr">person:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">张三</span></span><br><span class="line">  <span class="attr">age:</span> <span class="number">25</span></span><br><span class="line">  <span class="attr">city:</span> <span class="string">北京</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 行内字典</span></span><br><span class="line"><span class="attr">point:</span> &#123;<span class="attr">x:</span> <span class="number">10</span>, <span class="attr">y:</span> <span class="number">20</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 嵌套结构</span></span><br><span class="line"><span class="attr">company:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ABC</span> <span class="string">公司</span></span><br><span class="line">  <span class="attr">employees:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">张三</span></span><br><span class="line">      <span class="attr">role:</span> <span class="string">开发</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">李四</span></span><br><span class="line">      <span class="attr">role:</span> <span class="string">测试</span></span><br><span class="line">  <span class="attr">departments:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">技术部</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">产品部</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 锚点和引用（YAML 高级特性）</span></span><br><span class="line"><span class="attr">defaults:</span> <span class="meta">&amp;defaults</span></span><br><span class="line">  <span class="attr">adapter:</span> <span class="string">postgres</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line"></span><br><span class="line"><span class="attr">development:</span></span><br><span class="line">  <span class="attr">database:</span> <span class="string">dev_db</span></span><br><span class="line">  <span class="string">&lt;&lt;:</span> <span class="string">*defaults</span>  <span class="comment"># 合并引用</span></span><br><span class="line"></span><br><span class="line"><span class="attr">production:</span></span><br><span class="line">  <span class="attr">database:</span> <span class="string">prod_db</span></span><br><span class="line">  <span class="string">&lt;&lt;:</span> <span class="meta">*defaults</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">production.example.com</span></span><br></pre></td></tr></table></figure>

<h3 id="3-3-安装-PyYAML"><a href="#3-3-安装-PyYAML" class="headerlink" title="3.3 安装 PyYAML"></a>3.3 安装 PyYAML</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pip install pyyaml</span><br></pre></td></tr></table></figure>

<h2 id="四、yaml-模块使用"><a href="#四、yaml-模块使用" class="headerlink" title="四、yaml 模块使用"></a>四、yaml 模块使用</h2><h3 id="4-1-读取-YAML"><a href="#4-1-读取-YAML" class="headerlink" title="4.1 读取 YAML"></a>4.1 读取 YAML</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># YAML 字符串</span></span><br><span class="line">yaml_str = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">name: 张三</span></span><br><span class="line"><span class="string">age: 25</span></span><br><span class="line"><span class="string">skills:</span></span><br><span class="line"><span class="string">  - Python</span></span><br><span class="line"><span class="string">  - Java</span></span><br><span class="line"><span class="string">address:</span></span><br><span class="line"><span class="string">  city: 北京</span></span><br><span class="line"><span class="string">  district: 海淀区</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 反序列化：YAML 字符串 -&gt; Python 对象</span></span><br><span class="line">data = yaml.safe_load(yaml_str)</span><br><span class="line"><span class="built_in">print</span>(data)</span><br><span class="line"><span class="comment"># &#123;&#x27;name&#x27;: &#x27;张三&#x27;, &#x27;age&#x27;: 25, &#x27;skills&#x27;: [&#x27;Python&#x27;, &#x27;Java&#x27;], &#x27;address&#x27;: &#123;&#x27;city&#x27;: &#x27;北京&#x27;, &#x27;district&#x27;: &#x27;海淀区&#x27;&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取 YAML 文件</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;config.yaml&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    data = yaml.safe_load(f)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取多个文档（一个文件包含多个 YAML 文档）</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;multi.yaml&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    docs = yaml.safe_load_all(f)</span><br><span class="line">    <span class="keyword">for</span> doc <span class="keyword">in</span> docs:</span><br><span class="line">        <span class="built_in">print</span>(doc)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - 始终使用 safe_load() 而不是 load()</span></span><br><span class="line"><span class="comment"># - load() 会执行任意 Python 对象，有安全风险</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-写入-YAML"><a href="#4-2-写入-YAML" class="headerlink" title="4.2 写入 YAML"></a>4.2 写入 YAML</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;张三&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;age&#x27;</span>: <span class="number">25</span>,</span><br><span class="line">    <span class="string">&#x27;skills&#x27;</span>: [<span class="string">&#x27;Python&#x27;</span>, <span class="string">&#x27;Java&#x27;</span>, <span class="string">&#x27;Go&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;address&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;city&#x27;</span>: <span class="string">&#x27;北京&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;district&#x27;</span>: <span class="string">&#x27;海淀区&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;is_student&#x27;</span>: <span class="literal">False</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入文件</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;output.yaml&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    yaml.dump(data, f, allow_unicode=<span class="literal">True</span>, default_flow_style=<span class="literal">False</span>, sort_keys=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">输出：</span></span><br><span class="line"><span class="string">name: 张三</span></span><br><span class="line"><span class="string">age: 25</span></span><br><span class="line"><span class="string">skills:</span></span><br><span class="line"><span class="string">- Python</span></span><br><span class="line"><span class="string">- Java</span></span><br><span class="line"><span class="string">- Go</span></span><br><span class="line"><span class="string">address:</span></span><br><span class="line"><span class="string">  city: 北京</span></span><br><span class="line"><span class="string">  district: 海淀区</span></span><br><span class="line"><span class="string">is_student: false</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 序列化为字符串</span></span><br><span class="line">yaml_str = yaml.dump(data, allow_unicode=<span class="literal">True</span>, default_flow_style=<span class="literal">False</span>, sort_keys=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 参数说明：</span></span><br><span class="line"><span class="comment"># - allow_unicode=True: 保留中文</span></span><br><span class="line"><span class="comment"># - default_flow_style=False: 使用块式风格（更易读）</span></span><br><span class="line"><span class="comment"># - sort_keys=False: 不排序键（保持插入顺序）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - Python 3.7+ 字典保持插入顺序</span></span><br><span class="line"><span class="comment"># - sort_keys=False 保持这个特性</span></span><br></pre></td></tr></table></figure>

<h3 id="4-3-自定义类型处理"><a href="#4-3-自定义类型处理" class="headerlink" title="4.3 自定义类型处理"></a>4.3 自定义类型处理</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, age</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line">        <span class="variable language_">self</span>.age = age</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义序列化</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">represent_person</span>(<span class="params">dumper, person</span>):</span><br><span class="line">    <span class="keyword">return</span> dumper.represent_mapping(<span class="string">&#x27;tag:yaml.org,2002:map&#x27;</span>, &#123;</span><br><span class="line">        <span class="string">&#x27;__type__&#x27;</span>: <span class="string">&#x27;Person&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span>: person.name,</span><br><span class="line">        <span class="string">&#x27;age&#x27;</span>: person.age</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">yaml.add_representer(Person, represent_person)</span><br><span class="line"></span><br><span class="line">person = Person(<span class="string">&#x27;张三&#x27;</span>, <span class="number">25</span>)</span><br><span class="line">yaml_str = yaml.dump(person, allow_unicode=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义反序列化</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">construct_person</span>(<span class="params">loader, node</span>):</span><br><span class="line">    data = loader.construct_mapping(node)</span><br><span class="line">    <span class="keyword">return</span> Person(data[<span class="string">&#x27;name&#x27;</span>], data[<span class="string">&#x27;age&#x27;</span>])</span><br><span class="line"></span><br><span class="line">yaml.add_constructor(<span class="string">&#x27;tag:yaml.org,2002:map&#x27;</span>, construct_person)</span><br><span class="line"></span><br><span class="line">data = yaml.safe_load(yaml_str)</span><br></pre></td></tr></table></figure>

<h2 id="五、配置文件管理实践"><a href="#五、配置文件管理实践" class="headerlink" title="五、配置文件管理实践"></a>五、配置文件管理实践</h2><h3 id="5-1-配置文件示例"><a href="#5-1-配置文件示例" class="headerlink" title="5.1 配置文件示例"></a>5.1 配置文件示例</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># config.yaml</span></span><br><span class="line"><span class="comment"># 应用配置</span></span><br><span class="line"><span class="attr">app:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">我的应用</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">1.0</span><span class="number">.0</span></span><br><span class="line">  <span class="attr">debug:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据库配置</span></span><br><span class="line"><span class="attr">database:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">5432</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mydb</span></span><br><span class="line">  <span class="attr">user:</span> <span class="string">admin</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">$&#123;DB_PASSWORD&#125;</span>  <span class="comment"># 环境变量引用</span></span><br><span class="line">  <span class="attr">pool_size:</span> <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志配置</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span> <span class="string">INFO</span></span><br><span class="line">  <span class="attr">format:</span> <span class="string">&quot;%(asctime)s - %(name)s - %(levelname)s - %(message)s&quot;</span></span><br><span class="line">  <span class="attr">file:</span> <span class="string">logs/app.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># API 配置</span></span><br><span class="line"><span class="attr">api:</span></span><br><span class="line">  <span class="attr">base_url:</span> <span class="string">https://api.example.com</span></span><br><span class="line">  <span class="attr">timeout:</span> <span class="number">30</span></span><br><span class="line">  <span class="attr">retry:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">users:</span> <span class="string">/users</span></span><br><span class="line">    <span class="attr">posts:</span> <span class="string">/posts</span></span><br><span class="line">    <span class="attr">comments:</span> <span class="string">/comments</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 功能开关</span></span><br><span class="line"><span class="attr">features:</span></span><br><span class="line">  <span class="attr">enable_cache:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">enable_auth:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">enable_rate_limit:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-配置加载类"><a href="#5-2-配置加载类" class="headerlink" title="5.2 配置加载类"></a>5.2 配置加载类</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Any</span>, <span class="type">Dict</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Config</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;配置文件管理器&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config_path: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.config_path = Path(config_path)</span><br><span class="line">        <span class="variable language_">self</span>._config: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>] = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.load()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;加载配置文件&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.config_path.exists():</span><br><span class="line">            <span class="keyword">raise</span> FileNotFoundError(<span class="string">f&quot;配置文件不存在：<span class="subst">&#123;self.config_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        suffix = <span class="variable language_">self</span>.config_path.suffix.lower()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="variable language_">self</span>.config_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">if</span> suffix <span class="keyword">in</span> [<span class="string">&#x27;.yaml&#x27;</span>, <span class="string">&#x27;.yml&#x27;</span>]:</span><br><span class="line">                <span class="variable language_">self</span>._config = yaml.safe_load(f)</span><br><span class="line">            <span class="keyword">elif</span> suffix == <span class="string">&#x27;.json&#x27;</span>:</span><br><span class="line">                <span class="variable language_">self</span>._config = json.load(f)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">f&quot;不支持的配置格式：<span class="subst">&#123;suffix&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 处理环境变量引用 $&#123;VAR_NAME&#125;</span></span><br><span class="line">        <span class="variable language_">self</span>._config = <span class="variable language_">self</span>._expand_env(<span class="variable language_">self</span>._config)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_expand_env</span>(<span class="params">self, obj: <span class="type">Any</span></span>) -&gt; <span class="type">Any</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;递归展开环境变量引用&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(obj, <span class="built_in">str</span>):</span><br><span class="line">            <span class="comment"># 替换 $&#123;VAR_NAME&#125; 格式</span></span><br><span class="line">            <span class="keyword">import</span> re</span><br><span class="line">            pattern = <span class="string">r&#x27;\$\&#123;(\w+)\&#125;&#x27;</span></span><br><span class="line">            matches = re.findall(pattern, obj)</span><br><span class="line">            <span class="keyword">for</span> var_name <span class="keyword">in</span> matches:</span><br><span class="line">                env_value = os.environ.get(var_name, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">                obj = obj.replace(<span class="string">f&#x27;$&#123;&#123;<span class="subst">&#123;var_name&#125;</span>&#125;&#125;&#x27;</span>, env_value)</span><br><span class="line">            <span class="keyword">return</span> obj</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(obj, <span class="built_in">dict</span>):</span><br><span class="line">            <span class="keyword">return</span> &#123;k: <span class="variable language_">self</span>._expand_env(v) <span class="keyword">for</span> k, v <span class="keyword">in</span> obj.items()&#125;</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(obj, <span class="built_in">list</span>):</span><br><span class="line">            <span class="keyword">return</span> [<span class="variable language_">self</span>._expand_env(item) <span class="keyword">for</span> item <span class="keyword">in</span> obj]</span><br><span class="line">        <span class="keyword">return</span> obj</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, key: <span class="built_in">str</span>, default: <span class="type">Any</span> = <span class="literal">None</span></span>) -&gt; <span class="type">Any</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取配置值&quot;&quot;&quot;</span></span><br><span class="line">        keys = key.split(<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">        value = <span class="variable language_">self</span>._config</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> keys:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(value, <span class="built_in">dict</span>) <span class="keyword">and</span> k <span class="keyword">in</span> value:</span><br><span class="line">                value = value[k]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> default</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, key: <span class="built_in">str</span></span>) -&gt; <span class="type">Any</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.get(key)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;Config(<span class="subst">&#123;self._config&#125;</span>)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line">config = Config(<span class="string">&#x27;config.yaml&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取配置</span></span><br><span class="line">app_name = config.get(<span class="string">&#x27;app.name&#x27;</span>)</span><br><span class="line">db_host = config.get(<span class="string">&#x27;database.host&#x27;</span>)</span><br><span class="line">api_timeout = config.get(<span class="string">&#x27;api.timeout&#x27;</span>, <span class="number">30</span>)  <span class="comment"># 带默认值</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 链式访问</span></span><br><span class="line">db_config = config.get(<span class="string">&#x27;database&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(db_config[<span class="string">&#x27;host&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">db_host = config[<span class="string">&#x27;database.host&#x27;</span>]</span><br></pre></td></tr></table></figure>

<h3 id="5-3-多环境配置"><a href="#5-3-多环境配置" class="headerlink" title="5.3 多环境配置"></a>5.3 多环境配置</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># config.yaml</span></span><br><span class="line"><span class="comment"># 公共配置</span></span><br><span class="line"><span class="attr">common:</span></span><br><span class="line">  <span class="attr">app_name:</span> <span class="string">我的应用</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">1.0</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开发环境</span></span><br><span class="line"><span class="attr">development:</span></span><br><span class="line">  <span class="attr">debug:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">database:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5432</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">dev_db</span></span><br><span class="line">  <span class="attr">logging:</span></span><br><span class="line">    <span class="attr">level:</span> <span class="string">DEBUG</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试环境</span></span><br><span class="line"><span class="attr">testing:</span></span><br><span class="line">  <span class="attr">debug:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">database:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">test-db.example.com</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5432</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">test_db</span></span><br><span class="line">  <span class="attr">logging:</span></span><br><span class="line">    <span class="attr">level:</span> <span class="string">INFO</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生产环境</span></span><br><span class="line"><span class="attr">production:</span></span><br><span class="line">  <span class="attr">debug:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">database:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">prod-db.example.com</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5432</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">prod_db</span></span><br><span class="line">  <span class="attr">logging:</span></span><br><span class="line">    <span class="attr">level:</span> <span class="string">WARNING</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MultiEnvConfig</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;多环境配置管理&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config_path: <span class="built_in">str</span>, env: <span class="built_in">str</span> = <span class="literal">None</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.env = env <span class="keyword">or</span> os.environ.get(<span class="string">&#x27;APP_ENV&#x27;</span>, <span class="string">&#x27;development&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.config_path = Path(config_path)</span><br><span class="line">        <span class="variable language_">self</span>._config = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.load()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="variable language_">self</span>.config_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            full_config = yaml.safe_load(f)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 合并公共配置和环境配置</span></span><br><span class="line">        common = full_config.get(<span class="string">&#x27;common&#x27;</span>, &#123;&#125;)</span><br><span class="line">        env_config = full_config.get(<span class="variable language_">self</span>.env, &#123;&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>._config = <span class="variable language_">self</span>._deep_merge(common, env_config)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_deep_merge</span>(<span class="params">self, base: <span class="built_in">dict</span>, override: <span class="built_in">dict</span></span>) -&gt; <span class="built_in">dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;深度合并字典&quot;&quot;&quot;</span></span><br><span class="line">        result = base.copy()</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> override.items():</span><br><span class="line">            <span class="keyword">if</span> key <span class="keyword">in</span> result <span class="keyword">and</span> <span class="built_in">isinstance</span>(result[key], <span class="built_in">dict</span>) <span class="keyword">and</span> <span class="built_in">isinstance</span>(value, <span class="built_in">dict</span>):</span><br><span class="line">                result[key] = <span class="variable language_">self</span>._deep_merge(result[key], value)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                result[key] = value</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, key: <span class="built_in">str</span>, default: <span class="type">Any</span> = <span class="literal">None</span></span>) -&gt; <span class="type">Any</span>:</span><br><span class="line">        keys = key.split(<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">        value = <span class="variable language_">self</span>._config</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> keys:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(value, <span class="built_in">dict</span>) <span class="keyword">and</span> k <span class="keyword">in</span> value:</span><br><span class="line">                value = value[k]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> default</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line">config = MultiEnvConfig(<span class="string">&#x27;config.yaml&#x27;</span>)</span><br><span class="line"><span class="comment"># 或设置环境变量：export APP_ENV=production</span></span><br></pre></td></tr></table></figure>

<h3 id="5-4-配置验证"><a href="#5-4-配置验证" class="headerlink" title="5.4 配置验证"></a>5.4 配置验证</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Any</span>, <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DatabaseConfig</span>:</span><br><span class="line">    host: <span class="built_in">str</span></span><br><span class="line">    port: <span class="built_in">int</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    user: <span class="built_in">str</span></span><br><span class="line">    password: <span class="built_in">str</span></span><br><span class="line">    pool_size: <span class="built_in">int</span> = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AppConfig</span>:</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    version: <span class="built_in">str</span></span><br><span class="line">    debug: <span class="built_in">bool</span> = <span class="literal">False</span></span><br><span class="line">    database: <span class="type">Optional</span>[DatabaseConfig] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">validate_config</span>(<span class="params">config: <span class="type">Dict</span></span>) -&gt; AppConfig:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;验证配置并返回类型安全的配置对象&quot;&quot;&quot;</span></span><br><span class="line">    errors = []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 验证 app 配置</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;app&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> config:</span><br><span class="line">        errors.append(<span class="string">&quot;缺少 app 配置&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        app = config[<span class="string">&#x27;app&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;name&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> app:</span><br><span class="line">            errors.append(<span class="string">&quot;缺少 app.name&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;version&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> app:</span><br><span class="line">            errors.append(<span class="string">&quot;缺少 app.version&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 验证数据库配置</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;database&#x27;</span> <span class="keyword">in</span> config:</span><br><span class="line">        db = config[<span class="string">&#x27;database&#x27;</span>]</span><br><span class="line">        required_fields = [<span class="string">&#x27;host&#x27;</span>, <span class="string">&#x27;port&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;user&#x27;</span>]</span><br><span class="line">        <span class="keyword">for</span> field <span class="keyword">in</span> required_fields:</span><br><span class="line">            <span class="keyword">if</span> field <span class="keyword">not</span> <span class="keyword">in</span> db:</span><br><span class="line">                errors.append(<span class="string">f&quot;缺少 database.<span class="subst">&#123;field&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> errors:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;配置验证失败:\n&quot;</span> + <span class="string">&quot;\n&quot;</span>.join(errors))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 构建配置对象</span></span><br><span class="line">    app_config = AppConfig(</span><br><span class="line">        name=config[<span class="string">&#x27;app&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],</span><br><span class="line">        version=config[<span class="string">&#x27;app&#x27;</span>][<span class="string">&#x27;version&#x27;</span>],</span><br><span class="line">        debug=config.get(<span class="string">&#x27;app&#x27;</span>, &#123;&#125;).get(<span class="string">&#x27;debug&#x27;</span>, <span class="literal">False</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;database&#x27;</span> <span class="keyword">in</span> config:</span><br><span class="line">        db = config[<span class="string">&#x27;database&#x27;</span>]</span><br><span class="line">        app_config.database = DatabaseConfig(</span><br><span class="line">            host=db[<span class="string">&#x27;host&#x27;</span>],</span><br><span class="line">            port=db[<span class="string">&#x27;port&#x27;</span>],</span><br><span class="line">            name=db[<span class="string">&#x27;name&#x27;</span>],</span><br><span class="line">            user=db[<span class="string">&#x27;user&#x27;</span>],</span><br><span class="line">            password=db.get(<span class="string">&#x27;password&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            pool_size=db.get(<span class="string">&#x27;pool_size&#x27;</span>, <span class="number">10</span>)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> app_config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;config.yaml&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    raw_config = yaml.safe_load(f)</span><br><span class="line"></span><br><span class="line">config = validate_config(raw_config)</span><br><span class="line"><span class="built_in">print</span>(config.name)</span><br><span class="line"><span class="built_in">print</span>(config.database.host)</span><br></pre></td></tr></table></figure>

<h2 id="六、JSON-vs-YAML-对比"><a href="#六、JSON-vs-YAML-对比" class="headerlink" title="六、JSON vs YAML 对比"></a>六、JSON vs YAML 对比</h2><table>
<thead>
<tr>
<th>特性</th>
<th>JSON</th>
<th>YAML</th>
</tr>
</thead>
<tbody><tr>
<td>可读性</td>
<td>一般</td>
<td>优秀</td>
</tr>
<tr>
<td>简洁性</td>
<td>一般（需要大量括号）</td>
<td>优秀（缩进表示层级）</td>
</tr>
<tr>
<td>注释支持</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>数据类型</td>
<td>基础类型</td>
<td>基础类型 + 更多</td>
</tr>
<tr>
<td>解析速度</td>
<td>快</td>
<td>较慢</td>
</tr>
<tr>
<td>适用场景</td>
<td>API 数据交换</td>
<td>配置文件</td>
</tr>
<tr>
<td>Python 标准库</td>
<td>内置 json</td>
<td>需要 PyYAML</td>
</tr>
</tbody></table>
<h2 id="七、最佳实践"><a href="#七、最佳实践" class="headerlink" title="七、最佳实践"></a>七、最佳实践</h2><blockquote>
<p><strong>提醒自己</strong>：</p>
<ol>
<li><strong>配置文件不要提交敏感信息</strong>：使用环境变量或单独的 secrets 文件</li>
<li><strong>提供默认值</strong>：配置项应该有合理的默认值</li>
<li><strong>配置验证</strong>：启动时验证配置完整性</li>
<li><strong>使用合适的格式</strong>：API 用 JSON，配置用 YAML</li>
<li><strong>注释说明</strong>：配置项要有注释说明用途</li>
<li><strong>环境分离</strong>：不同环境使用不同配置</li>
</ol>
</blockquote>
<h2 id="八、练习"><a href="#八、练习" class="headerlink" title="八、练习"></a>八、练习</h2><ol>
<li>创建一个项目配置文件（YAML 格式），包含数据库、日志、API 等配置</li>
<li>实现一个配置加载器，支持环境变量替换</li>
<li>编写配置验证函数，确保必要配置项存在</li>
<li>实现多环境配置合并功能</li>
<li>创建一个 JSON 配置文件，并实现读取和写入功能</li>
</ol>
<hr>
<p><strong>上一篇</strong>：<a href="/2026/02/24/Python-%E5%B8%B8%E7%94%A8%E5%BA%93%EF%BC%88%E4%B8%80%EF%BC%89requests-API-%E8%B0%83%E7%94%A8/">Python 常用库（一）：requests API 调用</a></p>
<p><strong>下一篇</strong>：<a href="/2026/02/24/Python-%E5%B8%B8%E7%94%A8%E5%BA%93%EF%BC%88%E4%B8%89%EF%BC%89logging-%E6%97%A5%E5%BF%97%E6%A8%A1%E5%9D%97/">Python 常用库（三）：logging 日志模块</a></p>
<p><strong>参考资源</strong>：</p>
<ul>
<li><a href="https://docs.python.org/zh-cn/3/library/json.html">json 官方文档</a></li>
<li><a href="https://pyyaml.org/wiki/PyYAMLDocumentation">PyYAML 官方文档</a></li>
<li><a href="https://yaml.org/spec/">YAML 语法教程</a></li>
</ul>
]]></content>
      <categories>
        <category>Python 教程</category>
      </categories>
      <tags>
        <tag>配置文件</tag>
        <tag>Python</tag>
        <tag>json</tag>
        <tag>yaml</tag>
      </tags>
  </entry>
  <entry>
    <title>Python 数据科学（三）PyArrow 高性能数据操作</title>
    <url>/2026/02/24/Python%20%E6%95%B0%E6%8D%AE%E7%A7%91%E5%AD%A6%EF%BC%88%E4%B8%89%EF%BC%89PyArrow%20%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C/</url>
    <content><![CDATA[<h1 id="Python-数据科学（三）PyArrow-高性能数据操作"><a href="#Python-数据科学（三）PyArrow-高性能数据操作" class="headerlink" title="Python 数据科学（三）PyArrow 高性能数据操作"></a>Python 数据科学（三）PyArrow 高性能数据操作</h1><p>PyArrow 是一个高性能的数据处理库，提供列式内存格式和快速的数据 I&#x2F;O。本篇将介绍 PyArrow 的核心功能和使用技巧。</p>
<h2 id="一、PyArrow-简介"><a href="#一、PyArrow-简介" class="headerlink" title="一、PyArrow 简介"></a>一、PyArrow 简介</h2><h3 id="1-1-为什么使用-PyArrow？"><a href="#1-1-为什么使用-PyArrow？" class="headerlink" title="1.1 为什么使用 PyArrow？"></a>1.1 为什么使用 PyArrow？</h3><ul>
<li><strong>高性能</strong>：列式存储，比 Pandas 快数倍到数十倍</li>
<li><strong>零拷贝</strong>：与 Pandas、NumPy 无缝集成，无需数据复制</li>
<li><strong>跨语言</strong>：支持 Python、C++、Java、R 等</li>
<li><strong>大文件处理</strong>：支持流式处理超大文件</li>
<li><strong>现代格式</strong>：Parquet、Feather 等高效格式支持</li>
</ul>
<h3 id="1-2-安装与导入"><a href="#1-2-安装与导入" class="headerlink" title="1.2 安装与导入"></a>1.2 安装与导入</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pip install pyarrow</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pyarrow <span class="keyword">as</span> pa</span><br><span class="line"><span class="keyword">import</span> pyarrow.parquet <span class="keyword">as</span> pq</span><br><span class="line"><span class="keyword">import</span> pyarrow.csv <span class="keyword">as</span> csv</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看版本</span></span><br><span class="line"><span class="built_in">print</span>(pa.__version__)</span><br></pre></td></tr></table></figure>

<h2 id="二、PyArrow-数据结构"><a href="#二、PyArrow-数据结构" class="headerlink" title="二、PyArrow 数据结构"></a>二、PyArrow 数据结构</h2><h3 id="2-1-Table（表格）"><a href="#2-1-Table（表格）" class="headerlink" title="2.1 Table（表格）"></a>2.1 Table（表格）</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pyarrow <span class="keyword">as</span> pa</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从字典创建</span></span><br><span class="line">table = pa.table(&#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: [<span class="string">&#x27;张三&#x27;</span>, <span class="string">&#x27;李四&#x27;</span>, <span class="string">&#x27;王五&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;age&#x27;</span>: [<span class="number">25</span>, <span class="number">30</span>, <span class="number">35</span>],</span><br><span class="line">    <span class="string">&#x27;city&#x27;</span>: [<span class="string">&#x27;北京&#x27;</span>, <span class="string">&#x27;上海&#x27;</span>, <span class="string">&#x27;广州&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从 Pandas DataFrame 创建（零拷贝）</span></span><br><span class="line">df = pd.DataFrame(&#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: [<span class="string">&#x27;张三&#x27;</span>, <span class="string">&#x27;李四&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;age&#x27;</span>: [<span class="number">25</span>, <span class="number">30</span>]</span><br><span class="line">&#125;)</span><br><span class="line">table = pa.Table.from_pandas(df)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 转回 Pandas（零拷贝）</span></span><br><span class="line">df = table.to_pandas()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：PyArrow Table 与 Pandas DataFrame 互转非常高效</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-数据类型"><a href="#2-2-数据类型" class="headerlink" title="2.2 数据类型"></a>2.2 数据类型</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 基本类型</span></span><br><span class="line">pa.int8()      <span class="comment"># 8 位整数</span></span><br><span class="line">pa.int32()     <span class="comment"># 32 位整数</span></span><br><span class="line">pa.int64()     <span class="comment"># 64 位整数</span></span><br><span class="line">pa.float32()   <span class="comment"># 单精度浮点</span></span><br><span class="line">pa.float64()   <span class="comment"># 双精度浮点</span></span><br><span class="line">pa.string()    <span class="comment"># 字符串</span></span><br><span class="line">pa.bool_()     <span class="comment"># 布尔值</span></span><br><span class="line">pa.timestamp() <span class="comment"># 时间戳</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复杂类型</span></span><br><span class="line">pa.list_(pa.int32())           <span class="comment"># 列表</span></span><br><span class="line">pa.struct([(<span class="string">&#x27;x&#x27;</span>, pa.int32()), (<span class="string">&#x27;y&#x27;</span>, pa.int32())])  <span class="comment"># 结构体</span></span><br><span class="line">pa.dictionary(pa.int32(), pa.string())  <span class="comment"># 字典编码</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建带类型的数组</span></span><br><span class="line">arr = pa.array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], <span class="built_in">type</span>=pa.int32())</span><br></pre></td></tr></table></figure>

<h3 id="2-3-Array-和-ChunkedArray"><a href="#2-3-Array-和-ChunkedArray" class="headerlink" title="2.3 Array 和 ChunkedArray"></a>2.3 Array 和 ChunkedArray</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Array（连续数组）</span></span><br><span class="line">arr = pa.array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>])</span><br><span class="line">arr = pa.array([<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>])</span><br><span class="line">arr = pa.array([<span class="literal">True</span>, <span class="literal">False</span>, <span class="literal">True</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 带空值的数组</span></span><br><span class="line">arr = pa.array([<span class="number">1</span>, <span class="literal">None</span>, <span class="number">3</span>, <span class="literal">None</span>, <span class="number">5</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># ChunkedArray（分块数组，适合大数据）</span></span><br><span class="line">chunk1 = pa.array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line">chunk2 = pa.array([<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>])</span><br><span class="line">chunked = pa.chunked_array([chunk1, chunk2])</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(chunked))      <span class="comment"># 6</span></span><br><span class="line"><span class="built_in">print</span>(chunked.num_chunks)  <span class="comment"># 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - Array 是连续内存</span></span><br><span class="line"><span class="comment"># - ChunkedArray 由多个 Array 组成，适合流式处理</span></span><br></pre></td></tr></table></figure>

<h2 id="三、数据-I-O"><a href="#三、数据-I-O" class="headerlink" title="三、数据 I&#x2F;O"></a>三、数据 I&#x2F;O</h2><h3 id="3-1-Parquet-文件读写"><a href="#3-1-Parquet-文件读写" class="headerlink" title="3.1 Parquet 文件读写"></a>3.1 Parquet 文件读写</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pyarrow.parquet <span class="keyword">as</span> pq</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建示例数据</span></span><br><span class="line">table = pa.table(&#123;</span><br><span class="line">    <span class="string">&#x27;id&#x27;</span>: <span class="built_in">range</span>(<span class="number">1000000</span>),</span><br><span class="line">    <span class="string">&#x27;value&#x27;</span>: [i * <span class="number">2</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000000</span>)],</span><br><span class="line">    <span class="string">&#x27;category&#x27;</span>: [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>] * <span class="number">333333</span> + [<span class="string">&#x27;A&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入 Parquet</span></span><br><span class="line">pq.write_table(table, <span class="string">&#x27;data.parquet&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入带压缩</span></span><br><span class="line">pq.write_table(table, <span class="string">&#x27;data.parquet&#x27;</span>, compression=<span class="string">&#x27;gzip&#x27;</span>)</span><br><span class="line">pq.write_table(table, <span class="string">&#x27;data.parquet&#x27;</span>, compression=<span class="string">&#x27;snappy&#x27;</span>)  <span class="comment"># 更快</span></span><br><span class="line">pq.write_table(table, <span class="string">&#x27;data.parquet&#x27;</span>, compression=<span class="string">&#x27;brotli&#x27;</span>)  <span class="comment"># 更高压缩率</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取 Parquet</span></span><br><span class="line">table = pq.read_table(<span class="string">&#x27;data.parquet&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取部分列</span></span><br><span class="line">table = pq.read_table(<span class="string">&#x27;data.parquet&#x27;</span>, columns=[<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;value&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取部分行（行组过滤）</span></span><br><span class="line">parquet_file = pq.ParquetFile(<span class="string">&#x27;data.parquet&#x27;</span>)</span><br><span class="line">table = parquet_file.read_row_group(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 元数据</span></span><br><span class="line">meta = parquet_file.metadata</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;行数：<span class="subst">&#123;meta.num_rows&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;列数：<span class="subst">&#123;meta.num_columns&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;行组数：<span class="subst">&#123;meta.num_row_groups&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分区读取（适合大数据集）</span></span><br><span class="line"><span class="comment"># 数据按年/月分区存储</span></span><br><span class="line"><span class="comment"># data/year=2024/month=01/data.parquet</span></span><br><span class="line"><span class="comment"># data/year=2024/month=02/data.parquet</span></span><br><span class="line">dataset = pq.read_table(<span class="string">&#x27;data/&#x27;</span>, filters=[(<span class="string">&#x27;year&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, <span class="number">2024</span>), (<span class="string">&#x27;month&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>, <span class="number">6</span>)])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - Parquet 是列式存储，读取特定列非常快</span></span><br><span class="line"><span class="comment"># - 压缩可以显著减小文件大小</span></span><br><span class="line"><span class="comment"># - 分区查询可以只读取需要的数据</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-CSV-文件读写"><a href="#3-2-CSV-文件读写" class="headerlink" title="3.2 CSV 文件读写"></a>3.2 CSV 文件读写</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pyarrow.csv <span class="keyword">as</span> csv</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取 CSV</span></span><br><span class="line">table = csv.read_csv(<span class="string">&#x27;data.csv&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取时指定类型</span></span><br><span class="line">table = csv.read_csv(<span class="string">&#x27;data.csv&#x27;</span>,</span><br><span class="line">    convert_options=csv.ConvertOptions(</span><br><span class="line">        column_types=&#123;</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>: pa.int32(),</span><br><span class="line">            <span class="string">&#x27;value&#x27;</span>: pa.float64(),</span><br><span class="line">            <span class="string">&#x27;category&#x27;</span>: pa.string()</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取部分列</span></span><br><span class="line">table = csv.read_csv(<span class="string">&#x27;data.csv&#x27;</span>,</span><br><span class="line">    usecols=[<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;value&#x27;</span>]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入 CSV</span></span><br><span class="line">csv.write_csv(table, <span class="string">&#x27;output.csv&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 流式读取大 CSV（内存友好）</span></span><br><span class="line">reader = csv.open_csv(<span class="string">&#x27;large_file.csv&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> batch <span class="keyword">in</span> reader:</span><br><span class="line">    <span class="comment"># batch 是 RecordBatch，逐个处理</span></span><br><span class="line">    process(batch)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - PyArrow 读取 CSV 比 Pandas 快 5-10 倍</span></span><br><span class="line"><span class="comment"># - 流式读取适合处理超大文件</span></span><br></pre></td></tr></table></figure>

<h3 id="3-3-Feather-格式"><a href="#3-3-Feather-格式" class="headerlink" title="3.3 Feather 格式"></a>3.3 Feather 格式</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Feather 是超快的中间存储格式</span></span><br><span class="line"><span class="keyword">import</span> pyarrow.feather <span class="keyword">as</span> feather</span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入</span></span><br><span class="line">feather.write_feather(table, <span class="string">&#x27;data.feather&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取</span></span><br><span class="line">table = feather.read_table(<span class="string">&#x27;data.feather&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 与 Pandas 互转</span></span><br><span class="line">df = pd.DataFrame(&#123;<span class="string">&#x27;a&#x27;</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]&#125;)</span><br><span class="line">df.to_feather(<span class="string">&#x27;data.feather&#x27;</span>)</span><br><span class="line">df = pd.read_feather(<span class="string">&#x27;data.feather&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - Feather 比 Parquet 更快，但压缩率较低</span></span><br><span class="line"><span class="comment"># - 适合临时存储和进程间数据传输</span></span><br></pre></td></tr></table></figure>

<h3 id="3-4-IPC-格式（进程间通信）"><a href="#3-4-IPC-格式（进程间通信）" class="headerlink" title="3.4 IPC 格式（进程间通信）"></a>3.4 IPC 格式（进程间通信）</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 写入</span></span><br><span class="line"><span class="keyword">with</span> pa.ipc.new_file(<span class="string">&#x27;data.arrow&#x27;</span>, table.schema) <span class="keyword">as</span> writer:</span><br><span class="line">    writer.write_table(table)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取</span></span><br><span class="line"><span class="keyword">with</span> pa.ipc.open_file(<span class="string">&#x27;data.arrow&#x27;</span>) <span class="keyword">as</span> reader:</span><br><span class="line">    table = reader.read_all()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 流式写入（多个 RecordBatch）</span></span><br><span class="line"><span class="keyword">with</span> pa.ipc.new_stream(<span class="string">&#x27;data.arrow&#x27;</span>, table.schema) <span class="keyword">as</span> writer:</span><br><span class="line">    <span class="keyword">for</span> batch <span class="keyword">in</span> table.to_batches():</span><br><span class="line">        writer.write_batch(batch)</span><br></pre></td></tr></table></figure>

<h2 id="四、数据操作"><a href="#四、数据操作" class="headerlink" title="四、数据操作"></a>四、数据操作</h2><h3 id="4-1-列操作"><a href="#4-1-列操作" class="headerlink" title="4.1 列操作"></a>4.1 列操作</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">table = pa.table(&#123;</span><br><span class="line">    <span class="string">&#x27;a&#x27;</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>],</span><br><span class="line">    <span class="string">&#x27;b&#x27;</span>: [<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>, <span class="number">50</span>],</span><br><span class="line">    <span class="string">&#x27;c&#x27;</span>: [<span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;z&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, <span class="string">&#x27;v&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 选择列</span></span><br><span class="line">col = table[<span class="string">&#x27;a&#x27;</span>]</span><br><span class="line">cols = table.select([<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加列</span></span><br><span class="line">new_col = pa.array([<span class="number">100</span>, <span class="number">200</span>, <span class="number">300</span>, <span class="number">400</span>, <span class="number">500</span>])</span><br><span class="line">table = table.append_column(<span class="string">&#x27;d&#x27;</span>, new_col)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重命名列</span></span><br><span class="line">table = table.rename_columns([<span class="string">&#x27;col1&#x27;</span>, <span class="string">&#x27;col2&#x27;</span>, <span class="string">&#x27;col3&#x27;</span>, <span class="string">&#x27;col4&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除列</span></span><br><span class="line">table = table.drop([<span class="string">&#x27;c&#x27;</span>])</span><br><span class="line">table = table.remove_column(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 替换列</span></span><br><span class="line">table = table.set_column(<span class="number">0</span>, <span class="string">&#x27;a&#x27;</span>, pa.array([<span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>]))</span><br></pre></td></tr></table></figure>

<h3 id="4-2-行操作"><a href="#4-2-行操作" class="headerlink" title="4.2 行操作"></a>4.2 行操作</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 切片</span></span><br><span class="line">subset = table.<span class="built_in">slice</span>(<span class="number">0</span>, <span class="number">3</span>)  <span class="comment"># 前三行</span></span><br><span class="line">subset = table.<span class="built_in">slice</span>(-<span class="number">2</span>)    <span class="comment"># 最后两行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 过滤（使用表达式）</span></span><br><span class="line"><span class="keyword">import</span> pyarrow.compute <span class="keyword">as</span> pc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 条件过滤</span></span><br><span class="line">mask = pc.greater(table[<span class="string">&#x27;a&#x27;</span>], <span class="number">2</span>)  <span class="comment"># a &gt; 2</span></span><br><span class="line">filtered = table.<span class="built_in">filter</span>(mask)</span><br><span class="line"></span><br><span class="line">mask = pc.equal(table[<span class="string">&#x27;c&#x27;</span>], <span class="string">&#x27;x&#x27;</span>)  <span class="comment"># c == &#x27;x&#x27;</span></span><br><span class="line">filtered = table.<span class="built_in">filter</span>(mask)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 多条件</span></span><br><span class="line">mask1 = pc.greater(table[<span class="string">&#x27;a&#x27;</span>], <span class="number">2</span>)</span><br><span class="line">mask2 = pc.less(table[<span class="string">&#x27;b&#x27;</span>], <span class="number">40</span>)</span><br><span class="line">combined = pc.and_(mask1, mask2)</span><br><span class="line">filtered = table.<span class="built_in">filter</span>(combined)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 排序</span></span><br><span class="line">sorted_table = table.sort_by(<span class="string">&#x27;a&#x27;</span>)           <span class="comment"># 升序</span></span><br><span class="line">sorted_table = table.sort_by([(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;descending&#x27;</span>)])  <span class="comment"># 降序</span></span><br><span class="line">sorted_table = table.sort_by([(<span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;ascending&#x27;</span>), (<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;descending&#x27;</span>)])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 去重</span></span><br><span class="line">unique_table = table.drop_duplicates()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - pc 是 pyarrow.compute 的缩写</span></span><br><span class="line"><span class="comment"># - 过滤操作返回新表，不修改原表</span></span><br></pre></td></tr></table></figure>

<h3 id="4-3-计算函数（compute）"><a href="#4-3-计算函数（compute）" class="headerlink" title="4.3 计算函数（compute）"></a>4.3 计算函数（compute）</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pyarrow.compute <span class="keyword">as</span> pc</span><br><span class="line"></span><br><span class="line">arr = pa.array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 算术运算</span></span><br><span class="line"><span class="built_in">print</span>(pc.add(arr, <span class="number">10</span>))        <span class="comment"># [11, 12, 13, 14, 15]</span></span><br><span class="line"><span class="built_in">print</span>(pc.subtract(arr, <span class="number">1</span>))    <span class="comment"># [2, 3, 4, 5, 6]</span></span><br><span class="line"><span class="built_in">print</span>(pc.multiply(arr, <span class="number">2</span>))    <span class="comment"># [2, 4, 6, 8, 10]</span></span><br><span class="line"><span class="built_in">print</span>(pc.divide(arr, <span class="number">2</span>))      <span class="comment"># [0.5, 1.0, 1.5, 2.0, 2.5]</span></span><br><span class="line"><span class="built_in">print</span>.pc.power(arr, <span class="number">2</span>))       <span class="comment"># [1, 4, 9, 16, 25]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 比较运算</span></span><br><span class="line"><span class="built_in">print</span>(pc.greater(arr, <span class="number">3</span>))     <span class="comment"># [False, False, False, True, True]</span></span><br><span class="line"><span class="built_in">print</span>(pc.less(arr, <span class="number">3</span>))        <span class="comment"># [True, True, False, False, False]</span></span><br><span class="line"><span class="built_in">print</span>(pc.equal(arr, <span class="number">3</span>))       <span class="comment"># [False, False, True, False, False]</span></span><br><span class="line"><span class="built_in">print</span>(pc.greater_equal(arr, <span class="number">3</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 聚合函数</span></span><br><span class="line"><span class="built_in">print</span>(pc.<span class="built_in">sum</span>(arr))            <span class="comment"># 15</span></span><br><span class="line"><span class="built_in">print</span>(pc.mean(arr))           <span class="comment"># 3.0</span></span><br><span class="line"><span class="built_in">print</span>(pc.<span class="built_in">min</span>(arr))            <span class="comment"># 1</span></span><br><span class="line"><span class="built_in">print</span>(pc.<span class="built_in">max</span>(arr))            <span class="comment"># 5</span></span><br><span class="line"><span class="built_in">print</span>(pc.count(arr))          <span class="comment"># 5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 字符串函数</span></span><br><span class="line">str_arr = pa.array([<span class="string">&#x27;hello&#x27;</span>, <span class="string">&#x27;WORLD&#x27;</span>, <span class="string">&#x27;PyArrow&#x27;</span>])</span><br><span class="line"><span class="built_in">print</span>(pc.ascii_upper(str_arr))    <span class="comment"># [&#x27;HELLO&#x27;, &#x27;WORLD&#x27;, &#x27;PYARROW&#x27;]</span></span><br><span class="line"><span class="built_in">print</span>(pc.ascii_lower(str_arr))    <span class="comment"># [&#x27;hello&#x27;, &#x27;world&#x27;, &#x27;pyarrow&#x27;]</span></span><br><span class="line"><span class="built_in">print</span>(pc.utf8_length(str_arr))    <span class="comment"># [5, 5, 8]</span></span><br><span class="line"><span class="built_in">print</span>(pc.utf8_slice_codeunits(str_arr, <span class="number">0</span>, <span class="number">3</span>))  <span class="comment"># [&#x27;hel&#x27;, &#x27;WOR&#x27;, &#x27;PyA&#x27;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - compute 模块提供大量向量化函数</span></span><br><span class="line"><span class="comment"># - 性能优于 Python 循环</span></span><br></pre></td></tr></table></figure>

<h3 id="4-4-连接和合并"><a href="#4-4-连接和合并" class="headerlink" title="4.4 连接和合并"></a>4.4 连接和合并</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">table1 = pa.table(&#123;<span class="string">&#x27;a&#x27;</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], <span class="string">&#x27;b&#x27;</span>: [<span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;z&#x27;</span>]&#125;)</span><br><span class="line">table2 = pa.table(&#123;<span class="string">&#x27;a&#x27;</span>: [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>], <span class="string">&#x27;b&#x27;</span>: [<span class="string">&#x27;w&#x27;</span>, <span class="string">&#x27;v&#x27;</span>, <span class="string">&#x27;u&#x27;</span>]&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 垂直连接（concat）</span></span><br><span class="line">combined = pa.concat_tables([table1, table2])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接多个表</span></span><br><span class="line">tables = [table1, table2, table3]</span><br><span class="line">combined = pa.concat_tables(tables)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Join（类似 SQL）</span></span><br><span class="line"><span class="comment"># PyArrow 本身不直接支持 join，需要转 Pandas 或用其他方式</span></span><br><span class="line">df1 = table1.to_pandas()</span><br><span class="line">df2 = table2.to_pandas()</span><br><span class="line">merged = df1.merge(df2, on=<span class="string">&#x27;key&#x27;</span>, how=<span class="string">&#x27;left&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="五、与-Pandas-集成"><a href="#五、与-Pandas-集成" class="headerlink" title="五、与 Pandas 集成"></a>五、与 Pandas 集成</h2><h3 id="5-1-数据转换"><a href="#5-1-数据转换" class="headerlink" title="5.1 数据转换"></a>5.1 数据转换</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># PyArrow -&gt; Pandas</span></span><br><span class="line">table = pa.table(&#123;<span class="string">&#x27;a&#x27;</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], <span class="string">&#x27;b&#x27;</span>: [<span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;z&#x27;</span>]&#125;)</span><br><span class="line">df = table.to_pandas()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Pandas -&gt; PyArrow</span></span><br><span class="line">df = pd.DataFrame(&#123;<span class="string">&#x27;a&#x27;</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], <span class="string">&#x27;b&#x27;</span>: [<span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;z&#x27;</span>]&#125;)</span><br><span class="line">table = pa.Table.from_pandas(df)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 零拷贝选项</span></span><br><span class="line">table = pa.Table.from_pandas(df, preserve_index=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<h3 id="5-2-使用-PyArrow-作为-Pandas-后端"><a href="#5-2-使用-PyArrow-作为-Pandas-后端" class="headerlink" title="5.2 使用 PyArrow 作为 Pandas 后端"></a>5.2 使用 PyArrow 作为 Pandas 后端</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Pandas 可以使用 PyArrow 作为后端</span></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取 CSV 时使用 PyArrow 引擎</span></span><br><span class="line">df = pd.read_csv(<span class="string">&#x27;data.csv&#x27;</span>, engine=<span class="string">&#x27;pyarrow&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取 Parquet 时使用 PyArrow</span></span><br><span class="line">df = pd.read_parquet(<span class="string">&#x27;data.parquet&#x27;</span>, engine=<span class="string">&#x27;pyarrow&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 PyArrow 数据类型</span></span><br><span class="line">df = pd.DataFrame(&#123;</span><br><span class="line">    <span class="string">&#x27;a&#x27;</span>: pd.array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], dtype=<span class="string">&#x27;int32[pyarrow]&#x27;</span>),</span><br><span class="line">    <span class="string">&#x27;b&#x27;</span>: pd.array([<span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;z&#x27;</span>], dtype=<span class="string">&#x27;string[pyarrow]&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - PyArrow 引擎通常比默认引擎快</span></span><br><span class="line"><span class="comment"># - PyArrow 数据类型可以节省内存</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-性能对比"><a href="#5-3-性能对比" class="headerlink" title="5.3 性能对比"></a>5.3 性能对比</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> pyarrow <span class="keyword">as</span> pa</span><br><span class="line"><span class="keyword">import</span> pyarrow.parquet <span class="keyword">as</span> pq</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成大数据</span></span><br><span class="line">n = <span class="number">1000000</span></span><br><span class="line">df_pandas = pd.DataFrame(&#123;</span><br><span class="line">    <span class="string">&#x27;id&#x27;</span>: <span class="built_in">range</span>(n),</span><br><span class="line">    <span class="string">&#x27;value&#x27;</span>: np.random.randn(n),</span><br><span class="line">    <span class="string">&#x27;category&#x27;</span>: np.random.choice([<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>], n)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Pandas 读写 CSV</span></span><br><span class="line">start = time.time()</span><br><span class="line">df_pandas.to_csv(<span class="string">&#x27;pandas.csv&#x27;</span>, index=<span class="literal">False</span>)</span><br><span class="line">df_read = pd.read_csv(<span class="string">&#x27;pandas.csv&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Pandas CSV: <span class="subst">&#123;time.time() - start:<span class="number">.2</span>f&#125;</span>s&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># PyArrow 读写 CSV</span></span><br><span class="line">start = time.time()</span><br><span class="line">table = pa.Table.from_pandas(df_pandas)</span><br><span class="line">pa.csv.write_csv(table, <span class="string">&#x27;arrow.csv&#x27;</span>)</span><br><span class="line">table_read = pa.csv.read_csv(<span class="string">&#x27;arrow.csv&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;PyArrow CSV: <span class="subst">&#123;time.time() - start:<span class="number">.2</span>f&#125;</span>s&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Parquet 格式</span></span><br><span class="line">start = time.time()</span><br><span class="line">pq.write_table(table, <span class="string">&#x27;data.parquet&#x27;</span>)</span><br><span class="line">table_read = pq.read_table(<span class="string">&#x27;data.parquet&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Parquet: <span class="subst">&#123;time.time() - start:<span class="number">.2</span>f&#125;</span>s&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：实际测试中 PyArrow 通常快 3-10 倍</span></span><br></pre></td></tr></table></figure>

<h2 id="六、高级特性"><a href="#六、高级特性" class="headerlink" title="六、高级特性"></a>六、高级特性</h2><h3 id="6-1-Dataset-API（大数据集）"><a href="#6-1-Dataset-API（大数据集）" class="headerlink" title="6.1 Dataset API（大数据集）"></a>6.1 Dataset API（大数据集）</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pyarrow.dataset <span class="keyword">import</span> dataset, write_dataset</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取多个文件</span></span><br><span class="line">ds = dataset(<span class="string">&#x27;data/&#x27;</span>, <span class="built_in">format</span>=<span class="string">&#x27;parquet&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 过滤读取</span></span><br><span class="line">ds = dataset(<span class="string">&#x27;data/&#x27;</span>, <span class="built_in">format</span>=<span class="string">&#x27;parquet&#x27;</span>)</span><br><span class="line">table = ds.to_table(<span class="built_in">filter</span>=pc.greater(pa.field(<span class="string">&#x27;value&#x27;</span>), <span class="number">100</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分区数据集</span></span><br><span class="line"><span class="comment"># 自动识别 year=/month= 分区结构</span></span><br><span class="line">ds = dataset(<span class="string">&#x27;data/&#x27;</span>, <span class="built_in">format</span>=<span class="string">&#x27;parquet&#x27;</span>, partitioning=<span class="string">&#x27;hive&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入分区数据集</span></span><br><span class="line">table = pa.table(&#123;<span class="string">&#x27;a&#x27;</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], <span class="string">&#x27;b&#x27;</span>: [<span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;z&#x27;</span>]&#125;)</span><br><span class="line">write_dataset(</span><br><span class="line">    table,</span><br><span class="line">    <span class="string">&#x27;output/&#x27;</span>,</span><br><span class="line">    <span class="built_in">format</span>=<span class="string">&#x27;parquet&#x27;</span>,</span><br><span class="line">    partitioning=[<span class="string">&#x27;b&#x27;</span>]  <span class="comment"># 按 b 列分区</span></span><br><span class="line">)</span><br><span class="line"><span class="comment"># 输出：output/b=x/part-0.parquet, output/b=y/part-0.parquet</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-内存映射（Memory-Map）"><a href="#6-2-内存映射（Memory-Map）" class="headerlink" title="6.2 内存映射（Memory Map）"></a>6.2 内存映射（Memory Map）</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 内存映射读取大文件（不全部加载到内存）</span></span><br><span class="line">mmap = pa.memory_map(<span class="string">&#x27;large_file.parquet&#x27;</span>)</span><br><span class="line">table = pa.ipc.open_file(mmap).read_all()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：内存映射适合处理超大文件，按需加载数据</span></span><br></pre></td></tr></table></figure>

<h3 id="6-3-批处理"><a href="#6-3-批处理" class="headerlink" title="6.3 批处理"></a>6.3 批处理</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 处理大文件时分批处理</span></span><br><span class="line">parquet_file = pq.ParquetFile(<span class="string">&#x27;large.parquet&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> batch <span class="keyword">in</span> parquet_file.iter_batches(batch_size=<span class="number">10000</span>):</span><br><span class="line">    <span class="comment"># 每次处理 10000 行</span></span><br><span class="line">    process(batch)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 批处理聚合</span></span><br><span class="line">total = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> batch <span class="keyword">in</span> parquet_file.iter_batches():</span><br><span class="line">    total += pc.<span class="built_in">sum</span>(batch[<span class="string">&#x27;value&#x27;</span>]).as_py()</span><br></pre></td></tr></table></figure>

<h2 id="七、实用示例"><a href="#七、实用示例" class="headerlink" title="七、实用示例"></a>七、实用示例</h2><h3 id="7-1-数据管道"><a href="#7-1-数据管道" class="headerlink" title="7.1 数据管道"></a>7.1 数据管道</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pyarrow <span class="keyword">as</span> pa</span><br><span class="line"><span class="keyword">import</span> pyarrow.parquet <span class="keyword">as</span> pq</span><br><span class="line"><span class="keyword">import</span> pyarrow.compute <span class="keyword">as</span> pc</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_data</span>(<span class="params">input_file, output_file</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;数据处理管道&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 读取</span></span><br><span class="line">    table = pq.read_table(input_file)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 过滤</span></span><br><span class="line">    mask = pc.greater(table[<span class="string">&#x27;value&#x27;</span>], <span class="number">0</span>)</span><br><span class="line">    table = table.<span class="built_in">filter</span>(mask)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 添加计算列</span></span><br><span class="line">    doubled = pc.multiply(table[<span class="string">&#x27;value&#x27;</span>], <span class="number">2</span>)</span><br><span class="line">    table = table.append_column(<span class="string">&#x27;doubled&#x27;</span>, doubled)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 排序</span></span><br><span class="line">    table = table.sort_by(<span class="string">&#x27;value&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 写入</span></span><br><span class="line">    pq.write_table(table, output_file, compression=<span class="string">&#x27;snappy&#x27;</span>)</span><br><span class="line"></span><br><span class="line">process_data(<span class="string">&#x27;input.parquet&#x27;</span>, <span class="string">&#x27;output.parquet&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="7-2-多文件合并"><a href="#7-2-多文件合并" class="headerlink" title="7.2 多文件合并"></a>7.2 多文件合并</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">import</span> pyarrow <span class="keyword">as</span> pa</span><br><span class="line"><span class="keyword">import</span> pyarrow.parquet <span class="keyword">as</span> pq</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge_parquet_files</span>(<span class="params">input_dir, output_file</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;合并多个 Parquet 文件&quot;&quot;&quot;</span></span><br><span class="line">    files = <span class="built_in">list</span>(Path(input_dir).glob(<span class="string">&#x27;*.parquet&#x27;</span>))</span><br><span class="line">    tables = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> f <span class="keyword">in</span> files:</span><br><span class="line">        table = pq.read_table(<span class="built_in">str</span>(f))</span><br><span class="line">        tables.append(table)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 合并</span></span><br><span class="line">    combined = pa.concat_tables(tables)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 写入</span></span><br><span class="line">    pq.write_table(combined, output_file)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;合并 <span class="subst">&#123;<span class="built_in">len</span>(files)&#125;</span> 个文件，共 <span class="subst">&#123;combined.num_rows&#125;</span> 行&quot;</span>)</span><br><span class="line"></span><br><span class="line">merge_parquet_files(<span class="string">&#x27;data/&#x27;</span>, <span class="string">&#x27;merged.parquet&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="7-3-数据验证"><a href="#7-3-数据验证" class="headerlink" title="7.3 数据验证"></a>7.3 数据验证</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">validate_data</span>(<span class="params">table, schema</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;验证数据是否符合预期&quot;&quot;&quot;</span></span><br><span class="line">    issues = []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 检查列</span></span><br><span class="line">    <span class="keyword">for</span> col <span class="keyword">in</span> schema.names:</span><br><span class="line">        <span class="keyword">if</span> col <span class="keyword">not</span> <span class="keyword">in</span> table.column_names:</span><br><span class="line">            issues.append(<span class="string">f&quot;缺少列：<span class="subst">&#123;col&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 检查空值</span></span><br><span class="line">    <span class="keyword">for</span> col <span class="keyword">in</span> table.column_names:</span><br><span class="line">        null_count = table[col].null_count</span><br><span class="line">        <span class="keyword">if</span> null_count &gt; <span class="number">0</span>:</span><br><span class="line">            issues.append(<span class="string">f&quot;列 <span class="subst">&#123;col&#125;</span> 有 <span class="subst">&#123;null_count&#125;</span> 个空值&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 检查数据类型</span></span><br><span class="line">    <span class="keyword">for</span> i, col <span class="keyword">in</span> <span class="built_in">enumerate</span>(table.column_names):</span><br><span class="line">        expected_type = schema.field(i).<span class="built_in">type</span></span><br><span class="line">        actual_type = table.schema.field(i).<span class="built_in">type</span></span><br><span class="line">        <span class="keyword">if</span> expected_type != actual_type:</span><br><span class="line">            issues.append(<span class="string">f&quot;列 <span class="subst">&#123;col&#125;</span> 类型不匹配&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> issues</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line">schema = pa.schema([</span><br><span class="line">    (<span class="string">&#x27;id&#x27;</span>, pa.int32()),</span><br><span class="line">    (<span class="string">&#x27;value&#x27;</span>, pa.float64()),</span><br><span class="line">    (<span class="string">&#x27;category&#x27;</span>, pa.string())</span><br><span class="line">])</span><br><span class="line">issues = validate_data(table, schema)</span><br><span class="line"><span class="keyword">if</span> issues:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;数据质量问题：&quot;</span>, issues)</span><br></pre></td></tr></table></figure>

<h2 id="八、最佳实践"><a href="#八、最佳实践" class="headerlink" title="八、最佳实践"></a>八、最佳实践</h2><blockquote>
<p><strong>提醒自己</strong>：</p>
<ol>
<li><strong>使用 Parquet 格式</strong>：比 CSV 更快、更节省空间</li>
<li><strong>列式处理</strong>：只读取需要的列</li>
<li><strong>适当压缩</strong>：Snappy 平衡速度和大小，Gzip 追求压缩率</li>
<li><strong>批量处理</strong>：大文件分批次处理，避免内存溢出</li>
<li><strong>利用分区</strong>：按时间&#x2F;类别分区，加速查询</li>
<li><strong>零拷贝转换</strong>：PyArrow 与 Pandas 互转时避免不必要的数据复制</li>
</ol>
</blockquote>
<h2 id="九、练习"><a href="#九、练习" class="headerlink" title="九、练习"></a>九、练习</h2><ol>
<li>将一个大 CSV 文件转换为 Parquet 格式，比较文件大小和读写速度</li>
<li>使用 PyArrow 读取多个 Parquet 文件并合并</li>
<li>实现一个数据过滤管道，筛选符合条件的数据</li>
<li>使用 compute 模块实现数据的聚合统计</li>
<li>创建分区数据集，并演示分区查询的优势</li>
</ol>
<hr>
<p><strong>上一篇</strong>：[Python 数据科学（二）：Pandas 数据处理](&#x2F;2026&#x2F;02&#x2F;24&#x2F;Python-数据科学（二）Pandas 数据处理&#x2F;)</p>
<p><strong>下一篇</strong>：<a href="/2026/02/24/Python-%E5%B8%B8%E7%94%A8%E5%BA%93%EF%BC%88%E4%B8%80%EF%BC%89requests-API-%E8%B0%83%E7%94%A8/">Python 常用库（一）：requests API 调用</a></p>
<p><strong>参考资源</strong>：</p>
<ul>
<li><a href="https://arrow.apache.org/docs/python/">PyArrow 官方文档</a></li>
<li><a href="https://parquet.apache.org/docs/">Parquet 格式规范</a></li>
<li><a href="https://arrow.apache.org/docs/python/benchmarks.html">PyArrow 性能基准</a></li>
</ul>
]]></content>
      <categories>
        <category>Python 数据科学</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>PyArrow</tag>
        <tag>高性能</tag>
        <tag>DataFrame</tag>
      </tags>
  </entry>
  <entry>
    <title>我的第一篇博客</title>
    <url>/2026/02/20/%E6%88%91%E7%9A%84%E7%AC%AC%E4%B8%80%E7%AF%87%E5%8D%9A%E5%AE%A2/</url>
    <content><![CDATA[<p>这是我的第一篇博客文章，记录博客搭建的起点。</p>
]]></content>
      <categories>
        <category>生活随笔</category>
      </categories>
      <tags>
        <tag>博客搭建</tag>
        <tag>Hexo</tag>
        <tag>开始</tag>
      </tags>
  </entry>
  <entry>
    <title>Python 数据科学（二）Pandas 数据处理</title>
    <url>/2026/02/24/Python%20%E6%95%B0%E6%8D%AE%E7%A7%91%E5%AD%A6%EF%BC%88%E4%BA%8C%EF%BC%89Pandas%20%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86/</url>
    <content><![CDATA[<h1 id="Python-数据科学（二）Pandas-数据处理"><a href="#Python-数据科学（二）Pandas-数据处理" class="headerlink" title="Python 数据科学（二）Pandas 数据处理"></a>Python 数据科学（二）Pandas 数据处理</h1><p>Pandas 是 Python 数据分析的核心库。本篇将详细介绍 DataFrame 操作、数据清洗、数据转换等核心技能。</p>
<h2 id="一、Pandas-简介"><a href="#一、Pandas-简介" class="headerlink" title="一、Pandas 简介"></a>一、Pandas 简介</h2><h3 id="1-1-为什么使用-Pandas？"><a href="#1-1-为什么使用-Pandas？" class="headerlink" title="1.1 为什么使用 Pandas？"></a>1.1 为什么使用 Pandas？</h3><ul>
<li><strong>数据处理强大</strong>：支持 CSV、Excel、SQL、JSON 等多种格式</li>
<li><strong>DataFrame 结构</strong>：类似 Excel 表格，直观易用</li>
<li><strong>数据清洗方便</strong>：处理缺失值、重复值、异常值</li>
<li><strong>数据分析功能</strong>：分组、聚合、透视表</li>
<li><strong>与 NumPy 兼容</strong>：底层使用 NumPy，性能优秀</li>
</ul>
<h3 id="1-2-安装与导入"><a href="#1-2-安装与导入" class="headerlink" title="1.2 安装与导入"></a>1.2 安装与导入</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pip install pandas</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看版本</span></span><br><span class="line"><span class="built_in">print</span>(pd.__version__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置显示选项</span></span><br><span class="line">pd.set_option(<span class="string">&#x27;display.max_columns&#x27;</span>, <span class="literal">None</span>)  <span class="comment"># 显示所有列</span></span><br><span class="line">pd.set_option(<span class="string">&#x27;display.width&#x27;</span>, <span class="literal">None</span>)        <span class="comment"># 自适应宽度</span></span><br></pre></td></tr></table></figure>

<h2 id="二、Series-和-DataFrame"><a href="#二、Series-和-DataFrame" class="headerlink" title="二、Series 和 DataFrame"></a>二、Series 和 DataFrame</h2><h3 id="2-1-Series（系列）"><a href="#2-1-Series（系列）" class="headerlink" title="2.1 Series（系列）"></a>2.1 Series（系列）</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 从列表创建</span></span><br><span class="line">s = pd.Series([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定索引</span></span><br><span class="line">s = pd.Series([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>], index=[<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;e&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从字典创建</span></span><br><span class="line">s = pd.Series(&#123;<span class="string">&#x27;a&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;b&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;c&#x27;</span>: <span class="number">3</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问元素</span></span><br><span class="line"><span class="built_in">print</span>(s[<span class="number">0</span>])        <span class="comment"># 1 位置索引</span></span><br><span class="line"><span class="built_in">print</span>(s[<span class="string">&#x27;a&#x27;</span>])      <span class="comment"># 1 标签索引</span></span><br><span class="line"><span class="built_in">print</span>(s[<span class="number">0</span>:<span class="number">3</span>])      <span class="comment"># 切片</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Series 运算</span></span><br><span class="line">s1 = pd.Series([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line">s2 = pd.Series([<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>])</span><br><span class="line"><span class="built_in">print</span>(s1 + s2)     <span class="comment"># [5, 7, 9]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：Series 是一维带标签的数组</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-DataFrame（数据框）"><a href="#2-2-DataFrame（数据框）" class="headerlink" title="2.2 DataFrame（数据框）"></a>2.2 DataFrame（数据框）</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 从字典创建</span></span><br><span class="line">df = pd.DataFrame(&#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: [<span class="string">&#x27;张三&#x27;</span>, <span class="string">&#x27;李四&#x27;</span>, <span class="string">&#x27;王五&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;age&#x27;</span>: [<span class="number">25</span>, <span class="number">30</span>, <span class="number">35</span>],</span><br><span class="line">    <span class="string">&#x27;city&#x27;</span>: [<span class="string">&#x27;北京&#x27;</span>, <span class="string">&#x27;上海&#x27;</span>, <span class="string">&#x27;广州&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从列表嵌套创建</span></span><br><span class="line">df = pd.DataFrame([</span><br><span class="line">    [<span class="string">&#x27;张三&#x27;</span>, <span class="number">25</span>, <span class="string">&#x27;北京&#x27;</span>],</span><br><span class="line">    [<span class="string">&#x27;李四&#x27;</span>, <span class="number">30</span>, <span class="string">&#x27;上海&#x27;</span>],</span><br><span class="line">    [<span class="string">&#x27;王五&#x27;</span>, <span class="number">35</span>, <span class="string">&#x27;广州&#x27;</span>]</span><br><span class="line">], columns=[<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;age&#x27;</span>, <span class="string">&#x27;city&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从 CSV 文件读取</span></span><br><span class="line">df = pd.read_csv(<span class="string">&#x27;data.csv&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从 Excel 文件读取</span></span><br><span class="line">df = pd.read_excel(<span class="string">&#x27;data.xlsx&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看数据</span></span><br><span class="line"><span class="built_in">print</span>(df.head())      <span class="comment"># 前 5 行</span></span><br><span class="line"><span class="built_in">print</span>(df.tail(<span class="number">3</span>))     <span class="comment"># 后 3 行</span></span><br><span class="line"><span class="built_in">print</span>(df.sample(<span class="number">2</span>))   <span class="comment"># 随机 2 行</span></span><br><span class="line"><span class="built_in">print</span>(df.info())      <span class="comment"># 数据信息</span></span><br><span class="line"><span class="built_in">print</span>(df.describe())  <span class="comment"># 统计摘要</span></span><br><span class="line"><span class="built_in">print</span>(df.shape)       <span class="comment"># 形状 (行，列)</span></span><br><span class="line"><span class="built_in">print</span>(df.columns)     <span class="comment"># 列名</span></span><br><span class="line"><span class="built_in">print</span>(df.index)       <span class="comment"># 索引</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - read_csv 是最常用的数据读取方式</span></span><br><span class="line"><span class="comment"># - info() 快速了解数据结构和缺失情况</span></span><br></pre></td></tr></table></figure>

<h2 id="三、数据选择与索引"><a href="#三、数据选择与索引" class="headerlink" title="三、数据选择与索引"></a>三、数据选择与索引</h2><h3 id="3-1-列选择"><a href="#3-1-列选择" class="headerlink" title="3.1 列选择"></a>3.1 列选择</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 选择单列（返回 Series）</span></span><br><span class="line">col = df[<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">col = df.name  <span class="comment"># 也可以这样</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 选择多列（返回 DataFrame）</span></span><br><span class="line">cols = df[[<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;age&#x27;</span>]]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：选择单列用 df[&#x27;col&#x27;]，多列用 df[[&#x27;col1&#x27;, &#x27;col2&#x27;]]</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-行选择"><a href="#3-2-行选择" class="headerlink" title="3.2 行选择"></a>3.2 行选择</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 按位置选择</span></span><br><span class="line"><span class="built_in">print</span>(df.iloc[<span class="number">0</span>])      <span class="comment"># 第一行</span></span><br><span class="line"><span class="built_in">print</span>(df.iloc[<span class="number">0</span>:<span class="number">3</span>])    <span class="comment"># 前三行</span></span><br><span class="line"><span class="built_in">print</span>(df.iloc[-<span class="number">1</span>])     <span class="comment"># 最后一行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 按标签选择</span></span><br><span class="line"><span class="built_in">print</span>(df.loc[<span class="number">0</span>])       <span class="comment"># 索引为 0 的行</span></span><br><span class="line"><span class="built_in">print</span>(df.loc[<span class="number">0</span>:<span class="number">2</span>])     <span class="comment"># 索引 0 到 2 的行（包含 2）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 条件选择</span></span><br><span class="line">adults = df[df[<span class="string">&#x27;age&#x27;</span>] &gt; <span class="number">25</span>]</span><br><span class="line">beijing = df[df[<span class="string">&#x27;city&#x27;</span>] == <span class="string">&#x27;北京&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 多条件</span></span><br><span class="line">result = df[(df[<span class="string">&#x27;age&#x27;</span>] &gt; <span class="number">25</span>) &amp; (df[<span class="string">&#x27;city&#x27;</span>] == <span class="string">&#x27;北京&#x27;</span>)]</span><br><span class="line">result = df[(df[<span class="string">&#x27;age&#x27;</span>] &lt; <span class="number">25</span>) | (df[<span class="string">&#x27;age&#x27;</span>] &gt; <span class="number">35</span>)]</span><br><span class="line">result = df[~(df[<span class="string">&#x27;age&#x27;</span>] == <span class="number">25</span>)]  <span class="comment"># 非</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - iloc 按整数位置</span></span><br><span class="line"><span class="comment"># - loc 按标签</span></span><br><span class="line"><span class="comment"># - 多条件用 &amp; | ~，不用 and or not</span></span><br></pre></td></tr></table></figure>

<h3 id="3-3-单元格选择"><a href="#3-3-单元格选择" class="headerlink" title="3.3 单元格选择"></a>3.3 单元格选择</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 按位置</span></span><br><span class="line">val = df.iloc[<span class="number">0</span>, <span class="number">1</span>]      <span class="comment"># 第 0 行第 1 列</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 按标签</span></span><br><span class="line">val = df.loc[<span class="number">0</span>, <span class="string">&#x27;name&#x27;</span>]  <span class="comment"># 索引 0，name 列</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改值</span></span><br><span class="line">df.loc[<span class="number">0</span>, <span class="string">&#x27;age&#x27;</span>] = <span class="number">26</span></span><br><span class="line">df.iloc[<span class="number">0</span>, <span class="number">1</span>] = <span class="number">26</span></span><br></pre></td></tr></table></figure>

<h3 id="3-4-布尔索引进阶"><a href="#3-4-布尔索引进阶" class="headerlink" title="3.4 布尔索引进阶"></a>3.4 布尔索引进阶</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># isin 判断是否在列表中</span></span><br><span class="line">df[df[<span class="string">&#x27;city&#x27;</span>].isin([<span class="string">&#x27;北京&#x27;</span>, <span class="string">&#x27;上海&#x27;</span>])]</span><br><span class="line"></span><br><span class="line"><span class="comment"># str.contains 字符串包含</span></span><br><span class="line">df[df[<span class="string">&#x27;name&#x27;</span>].<span class="built_in">str</span>.contains(<span class="string">&#x27;张&#x27;</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># between 范围判断</span></span><br><span class="line">df[df[<span class="string">&#x27;age&#x27;</span>].between(<span class="number">25</span>, <span class="number">35</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># isnull/notnull 空值判断</span></span><br><span class="line">df[df[<span class="string">&#x27;age&#x27;</span>].isnull()]</span><br><span class="line">df[df[<span class="string">&#x27;age&#x27;</span>].notnull()]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：这些方法在数据筛选中非常常用</span></span><br></pre></td></tr></table></figure>

<h2 id="四、数据清洗"><a href="#四、数据清洗" class="headerlink" title="四、数据清洗"></a>四、数据清洗</h2><h3 id="4-1-处理缺失值"><a href="#4-1-处理缺失值" class="headerlink" title="4.1 处理缺失值"></a>4.1 处理缺失值</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建含缺失值的数据</span></span><br><span class="line">df = pd.DataFrame(&#123;</span><br><span class="line">    <span class="string">&#x27;A&#x27;</span>: [<span class="number">1</span>, <span class="number">2</span>, np.nan, <span class="number">4</span>],</span><br><span class="line">    <span class="string">&#x27;B&#x27;</span>: [<span class="number">5</span>, np.nan, np.nan, <span class="number">8</span>],</span><br><span class="line">    <span class="string">&#x27;C&#x27;</span>: [<span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查缺失值</span></span><br><span class="line"><span class="built_in">print</span>(df.isnull())       <span class="comment"># 布尔矩阵</span></span><br><span class="line"><span class="built_in">print</span>(df.isnull().<span class="built_in">sum</span>()) <span class="comment"># 每列缺失数量</span></span><br><span class="line"><span class="built_in">print</span>(df.notnull())      <span class="comment"># 非缺失</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除缺失值</span></span><br><span class="line">df_dropped = df.dropna()           <span class="comment"># 删除任何含缺失的行</span></span><br><span class="line">df_dropped = df.dropna(axis=<span class="number">1</span>)     <span class="comment"># 删除含缺失的列</span></span><br><span class="line">df_dropped = df.dropna(thresh=<span class="number">2</span>)   <span class="comment"># 至少 2 个非缺失值才保留</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 填充缺失值</span></span><br><span class="line">df_filled = df.fillna(<span class="number">0</span>)           <span class="comment"># 填充为 0</span></span><br><span class="line">df_filled = df.fillna(df.mean())   <span class="comment"># 填充为均值</span></span><br><span class="line">df_filled = df.fillna(method=<span class="string">&#x27;ffill&#x27;</span>)  <span class="comment"># 向前填充</span></span><br><span class="line">df_filled = df.fillna(method=<span class="string">&#x27;bfill&#x27;</span>)  <span class="comment"># 向后填充</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 插值</span></span><br><span class="line">df_interpolated = df.interpolate()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - 删除缺失值会丢失数据</span></span><br><span class="line"><span class="comment"># - 填充策略要根据业务场景选择</span></span><br><span class="line"><span class="comment"># - 均值填充会改变数据分布</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-处理重复值"><a href="#4-2-处理重复值" class="headerlink" title="4.2 处理重复值"></a>4.2 处理重复值</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df = pd.DataFrame(&#123;</span><br><span class="line">    <span class="string">&#x27;A&#x27;</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line">    <span class="string">&#x27;B&#x27;</span>: [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查重复</span></span><br><span class="line"><span class="built_in">print</span>(df.duplicated())      <span class="comment"># 布尔序列</span></span><br><span class="line"><span class="built_in">print</span>(df.duplicated().<span class="built_in">sum</span>()) <span class="comment"># 重复数量</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除重复</span></span><br><span class="line">df_unique = df.drop_duplicates()</span><br><span class="line">df_unique = df.drop_duplicates(subset=[<span class="string">&#x27;A&#x27;</span>])  <span class="comment"># 按指定列</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 保留最后一个</span></span><br><span class="line">df_unique = df.drop_duplicates(keep=<span class="string">&#x27;last&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不删除（保留所有）</span></span><br><span class="line">df_unique = df.drop_duplicates(keep=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<h3 id="4-3-数据类型转换"><a href="#4-3-数据类型转换" class="headerlink" title="4.3 数据类型转换"></a>4.3 数据类型转换</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df = pd.DataFrame(&#123;</span><br><span class="line">    <span class="string">&#x27;a&#x27;</span>: [<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;b&#x27;</span>: [<span class="number">1.0</span>, <span class="number">2.0</span>, <span class="number">3.0</span>],</span><br><span class="line">    <span class="string">&#x27;c&#x27;</span>: [<span class="string">&#x27;2021-01-01&#x27;</span>, <span class="string">&#x27;2021-01-02&#x27;</span>, <span class="string">&#x27;2021-01-03&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 类型转换</span></span><br><span class="line">df[<span class="string">&#x27;a&#x27;</span>] = df[<span class="string">&#x27;a&#x27;</span>].astype(<span class="built_in">int</span>)</span><br><span class="line">df[<span class="string">&#x27;b&#x27;</span>] = df[<span class="string">&#x27;b&#x27;</span>].astype(<span class="built_in">str</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日期转换</span></span><br><span class="line">df[<span class="string">&#x27;c&#x27;</span>] = pd.to_datetime(df[<span class="string">&#x27;c&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分类类型（节省内存）</span></span><br><span class="line">df[<span class="string">&#x27;category&#x27;</span>] = df[<span class="string">&#x27;a&#x27;</span>].astype(<span class="string">&#x27;category&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数值转换（处理非数值）</span></span><br><span class="line">df[<span class="string">&#x27;a&#x27;</span>] = pd.to_numeric(df[<span class="string">&#x27;a&#x27;</span>], errors=<span class="string">&#x27;coerce&#x27;</span>)  <span class="comment"># 无法转换的变为 NaN</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - category 类型适合取值有限的列（如性别、状态）</span></span><br><span class="line"><span class="comment"># - 可以显著减少内存占用</span></span><br></pre></td></tr></table></figure>

<h3 id="4-4-字符串处理"><a href="#4-4-字符串处理" class="headerlink" title="4.4 字符串处理"></a>4.4 字符串处理</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df = pd.DataFrame(&#123;<span class="string">&#x27;name&#x27;</span>: [<span class="string">&#x27;  Zhang San &#x27;</span>, <span class="string">&#x27;li si&#x27;</span>, <span class="string">&#x27;WANG wu&#x27;</span>]&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 去除空格</span></span><br><span class="line">df[<span class="string">&#x27;name&#x27;</span>] = df[<span class="string">&#x27;name&#x27;</span>].<span class="built_in">str</span>.strip()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 大小写</span></span><br><span class="line">df[<span class="string">&#x27;name&#x27;</span>] = df[<span class="string">&#x27;name&#x27;</span>].<span class="built_in">str</span>.lower()</span><br><span class="line">df[<span class="string">&#x27;name&#x27;</span>] = df[<span class="string">&#x27;name&#x27;</span>].<span class="built_in">str</span>.upper()</span><br><span class="line">df[<span class="string">&#x27;name&#x27;</span>] = df[<span class="string">&#x27;name&#x27;</span>].<span class="built_in">str</span>.title()  <span class="comment"># 首字母大写</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 分割</span></span><br><span class="line">df = pd.DataFrame(&#123;<span class="string">&#x27;full_name&#x27;</span>: [<span class="string">&#x27;Zhang San&#x27;</span>, <span class="string">&#x27;Li Si&#x27;</span>]&#125;)</span><br><span class="line">df[[<span class="string">&#x27;first&#x27;</span>, <span class="string">&#x27;last&#x27;</span>]] = df[<span class="string">&#x27;full_name&#x27;</span>].<span class="built_in">str</span>.split(<span class="string">&#x27; &#x27;</span>, expand=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 替换</span></span><br><span class="line">df[<span class="string">&#x27;name&#x27;</span>] = df[<span class="string">&#x27;name&#x27;</span>].<span class="built_in">str</span>.replace(<span class="string">&#x27;Zhang&#x27;</span>, <span class="string">&#x27;张&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取（正则）</span></span><br><span class="line">df = pd.DataFrame(&#123;<span class="string">&#x27;phone&#x27;</span>: [<span class="string">&#x27;138-0000-0000&#x27;</span>, <span class="string">&#x27;139-1111-1111&#x27;</span>]&#125;)</span><br><span class="line">df[<span class="string">&#x27;area&#x27;</span>] = df[<span class="string">&#x27;phone&#x27;</span>].<span class="built_in">str</span>.extract(<span class="string">r&#x27;(\d&#123;3&#125;)-&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - str 访问器提供所有字符串方法</span></span><br><span class="line"><span class="comment"># - expand=True 返回 DataFrame</span></span><br></pre></td></tr></table></figure>

<h2 id="五、数据转换"><a href="#五、数据转换" class="headerlink" title="五、数据转换"></a>五、数据转换</h2><h3 id="5-1-添加-删除列"><a href="#5-1-添加-删除列" class="headerlink" title="5.1 添加&#x2F;删除列"></a>5.1 添加&#x2F;删除列</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df = pd.DataFrame(&#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: [<span class="string">&#x27;张三&#x27;</span>, <span class="string">&#x27;李四&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;age&#x27;</span>: [<span class="number">25</span>, <span class="number">30</span>],</span><br><span class="line">    <span class="string">&#x27;salary&#x27;</span>: [<span class="number">10000</span>, <span class="number">15000</span>]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加列</span></span><br><span class="line">df[<span class="string">&#x27;bonus&#x27;</span>] = df[<span class="string">&#x27;salary&#x27;</span>] * <span class="number">0.1</span></span><br><span class="line">df[<span class="string">&#x27;total&#x27;</span>] = df[<span class="string">&#x27;salary&#x27;</span>] + df[<span class="string">&#x27;bonus&#x27;</span>]</span><br><span class="line">df[<span class="string">&#x27;city&#x27;</span>] = <span class="string">&#x27;北京&#x27;</span>  <span class="comment"># 常量列</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 assign（链式调用）</span></span><br><span class="line">df = df.assign(</span><br><span class="line">    tax=df[<span class="string">&#x27;salary&#x27;</span>] * <span class="number">0.1</span>,</span><br><span class="line">    net_salary=<span class="keyword">lambda</span> x: x[<span class="string">&#x27;salary&#x27;</span>] - x[<span class="string">&#x27;tax&#x27;</span>]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除列</span></span><br><span class="line">df = df.drop(<span class="string">&#x27;bonus&#x27;</span>, axis=<span class="number">1</span>)</span><br><span class="line">df.drop([<span class="string">&#x27;city&#x27;</span>, <span class="string">&#x27;total&#x27;</span>], axis=<span class="number">1</span>, inplace=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重命名列</span></span><br><span class="line">df = df.rename(columns=&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;姓名&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="string">&#x27;年龄&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="5-2-apply-和-map"><a href="#5-2-apply-和-map" class="headerlink" title="5.2 apply 和 map"></a>5.2 apply 和 map</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df = pd.DataFrame(&#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: [<span class="string">&#x27;张三&#x27;</span>, <span class="string">&#x27;李四&#x27;</span>, <span class="string">&#x27;王五&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;score&#x27;</span>: [<span class="number">85</span>, <span class="number">92</span>, <span class="number">78</span>]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># apply 应用函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">grade</span>(<span class="params">score</span>):</span><br><span class="line">    <span class="keyword">if</span> score &gt;= <span class="number">90</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;A&#x27;</span></span><br><span class="line">    <span class="keyword">elif</span> score &gt;= <span class="number">80</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;B&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;C&#x27;</span></span><br><span class="line"></span><br><span class="line">df[<span class="string">&#x27;grade&#x27;</span>] = df[<span class="string">&#x27;score&#x27;</span>].apply(grade)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 lambda</span></span><br><span class="line">df[<span class="string">&#x27;score_doubled&#x27;</span>] = df[<span class="string">&#x27;score&#x27;</span>].apply(<span class="keyword">lambda</span> x: x * <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按行应用</span></span><br><span class="line">df[<span class="string">&#x27;info&#x27;</span>] = df.apply(<span class="keyword">lambda</span> row: <span class="string">f&quot;<span class="subst">&#123;row[<span class="string">&#x27;name&#x27;</span>]&#125;</span> - <span class="subst">&#123;row[<span class="string">&#x27;score&#x27;</span>]&#125;</span>&quot;</span>, axis=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># map 映射（Series）</span></span><br><span class="line">mapping = &#123;<span class="string">&#x27;张三&#x27;</span>: <span class="string">&#x27;Male&#x27;</span>, <span class="string">&#x27;李四&#x27;</span>: <span class="string">&#x27;Female&#x27;</span>, <span class="string">&#x27;王五&#x27;</span>: <span class="string">&#x27;Male&#x27;</span>&#125;</span><br><span class="line">df[<span class="string">&#x27;gender&#x27;</span>] = df[<span class="string">&#x27;name&#x27;</span>].<span class="built_in">map</span>(mapping)</span><br><span class="line"></span><br><span class="line"><span class="comment"># replace 替换</span></span><br><span class="line">df[<span class="string">&#x27;grade&#x27;</span>] = df[<span class="string">&#x27;grade&#x27;</span>].replace(&#123;<span class="string">&#x27;A&#x27;</span>: <span class="string">&#x27;优秀&#x27;</span>, <span class="string">&#x27;B&#x27;</span>: <span class="string">&#x27;良好&#x27;</span>, <span class="string">&#x27;C&#x27;</span>: <span class="string">&#x27;及格&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - apply 可用于 Series 和 DataFrame</span></span><br><span class="line"><span class="comment"># - map 只用于 Series</span></span><br><span class="line"><span class="comment"># - 向量化操作比 apply 快，优先使用向量化</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-排序"><a href="#5-3-排序" class="headerlink" title="5.3 排序"></a>5.3 排序</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df = pd.DataFrame(&#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;score&#x27;</span>: [<span class="number">85</span>, <span class="number">92</span>, <span class="number">78</span>],</span><br><span class="line">    <span class="string">&#x27;age&#x27;</span>: [<span class="number">25</span>, <span class="number">30</span>, <span class="number">22</span>]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按值排序</span></span><br><span class="line">df_sorted = df.sort_values(<span class="string">&#x27;score&#x27;</span>)           <span class="comment"># 升序</span></span><br><span class="line">df_sorted = df.sort_values(<span class="string">&#x27;score&#x27;</span>, ascending=<span class="literal">False</span>)  <span class="comment"># 降序</span></span><br><span class="line">df_sorted = df.sort_values([<span class="string">&#x27;age&#x27;</span>, <span class="string">&#x27;score&#x27;</span>])  <span class="comment"># 多列排序</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 按索引排序</span></span><br><span class="line">df_sorted = df.sort_index()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 排名</span></span><br><span class="line">df[<span class="string">&#x27;rank&#x27;</span>] = df[<span class="string">&#x27;score&#x27;</span>].rank(ascending=<span class="literal">False</span>)  <span class="comment"># 排名</span></span><br></pre></td></tr></table></figure>

<h2 id="六、数据聚合"><a href="#六、数据聚合" class="headerlink" title="六、数据聚合"></a>六、数据聚合</h2><h3 id="6-1-基础统计"><a href="#6-1-基础统计" class="headerlink" title="6.1 基础统计"></a>6.1 基础统计</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df = pd.DataFrame(&#123;</span><br><span class="line">    <span class="string">&#x27;A&#x27;</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>],</span><br><span class="line">    <span class="string">&#x27;B&#x27;</span>: [<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>, <span class="number">50</span>]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 常用统计</span></span><br><span class="line"><span class="built_in">print</span>(df.<span class="built_in">sum</span>())        <span class="comment"># 求和</span></span><br><span class="line"><span class="built_in">print</span>(df.mean())       <span class="comment"># 均值</span></span><br><span class="line"><span class="built_in">print</span>(df.median())     <span class="comment"># 中位数</span></span><br><span class="line"><span class="built_in">print</span>(df.std())        <span class="comment"># 标准差</span></span><br><span class="line"><span class="built_in">print</span>(df.var())        <span class="comment"># 方差</span></span><br><span class="line"><span class="built_in">print</span>(df.<span class="built_in">min</span>())        <span class="comment"># 最小值</span></span><br><span class="line"><span class="built_in">print</span>(df.<span class="built_in">max</span>())        <span class="comment"># 最大值</span></span><br><span class="line"><span class="built_in">print</span>(df.count())      <span class="comment"># 计数</span></span><br><span class="line"><span class="built_in">print</span>(df.quantile(<span class="number">0.25</span>))  <span class="comment"># 25% 分位数</span></span><br><span class="line"><span class="built_in">print</span>(df.describe())   <span class="comment"># 完整统计摘要</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 相关系数</span></span><br><span class="line"><span class="built_in">print</span>(df.corr())</span><br></pre></td></tr></table></figure>

<h3 id="6-2-groupby-分组聚合"><a href="#6-2-groupby-分组聚合" class="headerlink" title="6.2 groupby 分组聚合"></a>6.2 groupby 分组聚合</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df = pd.DataFrame(&#123;</span><br><span class="line">    <span class="string">&#x27;department&#x27;</span>: [<span class="string">&#x27;HR&#x27;</span>, <span class="string">&#x27;IT&#x27;</span>, <span class="string">&#x27;HR&#x27;</span>, <span class="string">&#x27;IT&#x27;</span>, <span class="string">&#x27;Sales&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;E&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;salary&#x27;</span>: [<span class="number">5000</span>, <span class="number">10000</span>, <span class="number">6000</span>, <span class="number">12000</span>, <span class="number">8000</span>],</span><br><span class="line">    <span class="string">&#x27;age&#x27;</span>: [<span class="number">25</span>, <span class="number">30</span>, <span class="number">28</span>, <span class="number">35</span>, <span class="number">27</span>]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 单列分组</span></span><br><span class="line">grouped = df.groupby(<span class="string">&#x27;department&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(grouped[<span class="string">&#x27;salary&#x27;</span>].mean())  <span class="comment"># 各部门平均工资</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 多列分组</span></span><br><span class="line"><span class="built_in">print</span>(df.groupby([<span class="string">&#x27;department&#x27;</span>, <span class="string">&#x27;age&#x27;</span>])[<span class="string">&#x27;salary&#x27;</span>].<span class="built_in">sum</span>())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 多个聚合函数</span></span><br><span class="line"><span class="built_in">print</span>(df.groupby(<span class="string">&#x27;department&#x27;</span>)[<span class="string">&#x27;salary&#x27;</span>].agg([<span class="string">&#x27;mean&#x27;</span>, <span class="string">&#x27;sum&#x27;</span>, <span class="string">&#x27;count&#x27;</span>]))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不同列不同聚合</span></span><br><span class="line"><span class="built_in">print</span>(df.groupby(<span class="string">&#x27;department&#x27;</span>).agg(&#123;</span><br><span class="line">    <span class="string">&#x27;salary&#x27;</span>: [<span class="string">&#x27;mean&#x27;</span>, <span class="string">&#x27;sum&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;age&#x27;</span>: [<span class="string">&#x27;min&#x27;</span>, <span class="string">&#x27;max&#x27;</span>]</span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义聚合</span></span><br><span class="line"><span class="built_in">print</span>(df.groupby(<span class="string">&#x27;department&#x27;</span>)[<span class="string">&#x27;salary&#x27;</span>].agg(<span class="keyword">lambda</span> x: x.<span class="built_in">max</span>() - x.<span class="built_in">min</span>()))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重置索引</span></span><br><span class="line">result = df.groupby(<span class="string">&#x27;department&#x27;</span>)[<span class="string">&#x27;salary&#x27;</span>].mean().reset_index()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - groupby 是数据分析的核心操作</span></span><br><span class="line"><span class="comment"># - agg 可以应用多个聚合函数</span></span><br></pre></td></tr></table></figure>

<h3 id="6-3-pivot-table-透视表"><a href="#6-3-pivot-table-透视表" class="headerlink" title="6.3 pivot_table 透视表"></a>6.3 pivot_table 透视表</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df = pd.DataFrame(&#123;</span><br><span class="line">    <span class="string">&#x27;date&#x27;</span>: [<span class="string">&#x27;2024-01&#x27;</span>, <span class="string">&#x27;2024-01&#x27;</span>, <span class="string">&#x27;2024-02&#x27;</span>, <span class="string">&#x27;2024-02&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;region&#x27;</span>: [<span class="string">&#x27;North&#x27;</span>, <span class="string">&#x27;South&#x27;</span>, <span class="string">&#x27;North&#x27;</span>, <span class="string">&#x27;South&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;sales&#x27;</span>: [<span class="number">100</span>, <span class="number">150</span>, <span class="number">120</span>, <span class="number">180</span>],</span><br><span class="line">    <span class="string">&#x27;profit&#x27;</span>: [<span class="number">20</span>, <span class="number">30</span>, <span class="number">25</span>, <span class="number">35</span>]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 基础透视表</span></span><br><span class="line">pivot = pd.pivot_table(</span><br><span class="line">    df,</span><br><span class="line">    values=<span class="string">&#x27;sales&#x27;</span>,</span><br><span class="line">    index=<span class="string">&#x27;region&#x27;</span>,</span><br><span class="line">    columns=<span class="string">&#x27;date&#x27;</span>,</span><br><span class="line">    aggfunc=<span class="string">&#x27;sum&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 多值多聚合</span></span><br><span class="line">pivot = pd.pivot_table(</span><br><span class="line">    df,</span><br><span class="line">    values=[<span class="string">&#x27;sales&#x27;</span>, <span class="string">&#x27;profit&#x27;</span>],</span><br><span class="line">    index=<span class="string">&#x27;region&#x27;</span>,</span><br><span class="line">    aggfunc=&#123;<span class="string">&#x27;sales&#x27;</span>: <span class="string">&#x27;sum&#x27;</span>, <span class="string">&#x27;profit&#x27;</span>: <span class="string">&#x27;mean&#x27;</span>&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 填充缺失值</span></span><br><span class="line">pivot = pd.pivot_table(</span><br><span class="line">    df,</span><br><span class="line">    values=<span class="string">&#x27;sales&#x27;</span>,</span><br><span class="line">    index=<span class="string">&#x27;region&#x27;</span>,</span><br><span class="line">    columns=<span class="string">&#x27;date&#x27;</span>,</span><br><span class="line">    fill_value=<span class="number">0</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="七、数据合并"><a href="#七、数据合并" class="headerlink" title="七、数据合并"></a>七、数据合并</h2><h3 id="7-1-concat-连接"><a href="#7-1-concat-连接" class="headerlink" title="7.1 concat 连接"></a>7.1 concat 连接</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df1 = pd.DataFrame(&#123;<span class="string">&#x27;A&#x27;</span>: [<span class="number">1</span>, <span class="number">2</span>], <span class="string">&#x27;B&#x27;</span>: [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>]&#125;)</span><br><span class="line">df2 = pd.DataFrame(&#123;<span class="string">&#x27;A&#x27;</span>: [<span class="number">3</span>, <span class="number">4</span>], <span class="string">&#x27;B&#x27;</span>: [<span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>]&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 垂直连接</span></span><br><span class="line">result = pd.concat([df1, df2], axis=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 水平连接</span></span><br><span class="line">result = pd.concat([df1, df2], axis=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 忽略索引</span></span><br><span class="line">result = pd.concat([df1, df2], ignore_index=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加键</span></span><br><span class="line">result = pd.concat([df1, df2], keys=[<span class="string">&#x27;first&#x27;</span>, <span class="string">&#x27;second&#x27;</span>])</span><br></pre></td></tr></table></figure>

<h3 id="7-2-merge-合并"><a href="#7-2-merge-合并" class="headerlink" title="7.2 merge 合并"></a>7.2 merge 合并</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df1 = pd.DataFrame(&#123;</span><br><span class="line">    <span class="string">&#x27;id&#x27;</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">df2 = pd.DataFrame(&#123;</span><br><span class="line">    <span class="string">&#x27;id&#x27;</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>],</span><br><span class="line">    <span class="string">&#x27;score&#x27;</span>: [<span class="number">85</span>, <span class="number">92</span>, <span class="number">78</span>]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 内连接（默认）</span></span><br><span class="line">merged = pd.merge(df1, df2, on=<span class="string">&#x27;id&#x27;</span>)  <span class="comment"># 只有 id 1, 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 左连接</span></span><br><span class="line">merged = pd.merge(df1, df2, on=<span class="string">&#x27;id&#x27;</span>, how=<span class="string">&#x27;left&#x27;</span>)  <span class="comment"># 保留 df1 所有行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 右连接</span></span><br><span class="line">merged = pd.merge(df1, df2, on=<span class="string">&#x27;id&#x27;</span>, how=<span class="string">&#x27;right&#x27;</span>)  <span class="comment"># 保留 df2 所有行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 外连接</span></span><br><span class="line">merged = pd.merge(df1, df2, on=<span class="string">&#x27;id&#x27;</span>, how=<span class="string">&#x27;outer&#x27;</span>)  <span class="comment"># 保留所有行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 不同列名合并</span></span><br><span class="line">merged = pd.merge(df1, df2, left_on=<span class="string">&#x27;id1&#x27;</span>, right_on=<span class="string">&#x27;id2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 多列合并</span></span><br><span class="line">merged = pd.merge(df1, df2, on=[<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;date&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提醒自己：</span></span><br><span class="line"><span class="comment"># - merge 类似 SQL 的 JOIN</span></span><br><span class="line"><span class="comment"># - how 参数决定连接类型</span></span><br></pre></td></tr></table></figure>

<h2 id="八、文件读写"><a href="#八、文件读写" class="headerlink" title="八、文件读写"></a>八、文件读写</h2><h3 id="8-1-CSV-文件"><a href="#8-1-CSV-文件" class="headerlink" title="8.1 CSV 文件"></a>8.1 CSV 文件</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 读取</span></span><br><span class="line">df = pd.read_csv(<span class="string">&#x27;data.csv&#x27;</span>)</span><br><span class="line">df = pd.read_csv(<span class="string">&#x27;data.csv&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">df = pd.read_csv(<span class="string">&#x27;data.csv&#x27;</span>, sep=<span class="string">&#x27;\t&#x27;</span>)  <span class="comment"># TSV</span></span><br><span class="line">df = pd.read_csv(<span class="string">&#x27;data.csv&#x27;</span>, header=<span class="number">0</span>)  <span class="comment"># 第一行为表头</span></span><br><span class="line">df = pd.read_csv(<span class="string">&#x27;data.csv&#x27;</span>, names=[<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>])  <span class="comment"># 指定列名</span></span><br><span class="line">df = pd.read_csv(<span class="string">&#x27;data.csv&#x27;</span>, usecols=[<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>])  <span class="comment"># 只读取部分列</span></span><br><span class="line">df = pd.read_csv(<span class="string">&#x27;data.csv&#x27;</span>, nrows=<span class="number">100</span>)  <span class="comment"># 只读前 100 行</span></span><br><span class="line">df = pd.read_csv(<span class="string">&#x27;data.csv&#x27;</span>, dtype=&#123;<span class="string">&#x27;A&#x27;</span>: <span class="built_in">str</span>&#125;)  <span class="comment"># 指定类型</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入</span></span><br><span class="line">df.to_csv(<span class="string">&#x27;output.csv&#x27;</span>, index=<span class="literal">False</span>)  <span class="comment"># 不保存索引</span></span><br><span class="line">df.to_csv(<span class="string">&#x27;output.csv&#x27;</span>, encoding=<span class="string">&#x27;utf-8-sig&#x27;</span>)  <span class="comment"># Excel 兼容</span></span><br></pre></td></tr></table></figure>

<h3 id="8-2-Excel-文件"><a href="#8-2-Excel-文件" class="headerlink" title="8.2 Excel 文件"></a>8.2 Excel 文件</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 读取</span></span><br><span class="line">df = pd.read_excel(<span class="string">&#x27;data.xlsx&#x27;</span>)</span><br><span class="line">df = pd.read_excel(<span class="string">&#x27;data.xlsx&#x27;</span>, sheet_name=<span class="string">&#x27;Sheet1&#x27;</span>)</span><br><span class="line">df = pd.read_excel(<span class="string">&#x27;data.xlsx&#x27;</span>, sheet_name=[<span class="string">&#x27;Sheet1&#x27;</span>, <span class="string">&#x27;Sheet2&#x27;</span>])  <span class="comment"># 多个 sheet</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入</span></span><br><span class="line">df.to_excel(<span class="string">&#x27;output.xlsx&#x27;</span>, index=<span class="literal">False</span>)</span><br><span class="line">df.to_excel(<span class="string">&#x27;output.xlsx&#x27;</span>, sheet_name=<span class="string">&#x27;数据&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 多个 DataFrame 写入不同 sheet</span></span><br><span class="line"><span class="keyword">with</span> pd.ExcelWriter(<span class="string">&#x27;output.xlsx&#x27;</span>) <span class="keyword">as</span> writer:</span><br><span class="line">    df1.to_excel(writer, sheet_name=<span class="string">&#x27;Sheet1&#x27;</span>, index=<span class="literal">False</span>)</span><br><span class="line">    df2.to_excel(writer, sheet_name=<span class="string">&#x27;Sheet2&#x27;</span>, index=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<h3 id="8-3-其他格式"><a href="#8-3-其他格式" class="headerlink" title="8.3 其他格式"></a>8.3 其他格式</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># JSON</span></span><br><span class="line">df = pd.read_json(<span class="string">&#x27;data.json&#x27;</span>)</span><br><span class="line">df.to_json(<span class="string">&#x27;output.json&#x27;</span>, force_ascii=<span class="literal">False</span>)  <span class="comment"># 保留中文</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SQL（需要 SQLAlchemy）</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line">engine = create_engine(<span class="string">&#x27;sqlite:///database.db&#x27;</span>)</span><br><span class="line">df = pd.read_sql(<span class="string">&#x27;SELECT * FROM table&#x27;</span>, engine)</span><br><span class="line">df.to_sql(<span class="string">&#x27;table&#x27;</span>, engine, if_exists=<span class="string">&#x27;replace&#x27;</span>, index=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Parquet（高效列式存储）</span></span><br><span class="line">df = pd.read_parquet(<span class="string">&#x27;data.parquet&#x27;</span>)</span><br><span class="line">df.to_parquet(<span class="string">&#x27;output.parquet&#x27;</span>, index=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Pickle</span></span><br><span class="line">df.to_pickle(<span class="string">&#x27;data.pkl&#x27;</span>)</span><br><span class="line">df = pd.read_pickle(<span class="string">&#x27;data.pkl&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="九、实用技巧"><a href="#九、实用技巧" class="headerlink" title="九、实用技巧"></a>九、实用技巧</h2><h3 id="9-1-时间序列处理"><a href="#9-1-时间序列处理" class="headerlink" title="9.1 时间序列处理"></a>9.1 时间序列处理</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建日期范围</span></span><br><span class="line">dates = pd.date_range(<span class="string">&#x27;2024-01-01&#x27;</span>, periods=<span class="number">365</span>, freq=<span class="string">&#x27;D&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置日期索引</span></span><br><span class="line">df[<span class="string">&#x27;date&#x27;</span>] = pd.to_datetime(df[<span class="string">&#x27;date&#x27;</span>])</span><br><span class="line">df = df.set_index(<span class="string">&#x27;date&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日期提取</span></span><br><span class="line">df[<span class="string">&#x27;year&#x27;</span>] = df.index.year</span><br><span class="line">df[<span class="string">&#x27;month&#x27;</span>] = df.index.month</span><br><span class="line">df[<span class="string">&#x27;day&#x27;</span>] = df.index.day</span><br><span class="line">df[<span class="string">&#x27;weekday&#x27;</span>] = df.index.weekday  <span class="comment"># 0=周一</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重采样（降采样）</span></span><br><span class="line">daily = df.resample(<span class="string">&#x27;D&#x27;</span>).<span class="built_in">sum</span>()  <span class="comment"># 按天</span></span><br><span class="line">monthly = df.resample(<span class="string">&#x27;M&#x27;</span>).<span class="built_in">sum</span>()  <span class="comment"># 按月</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 移动平均</span></span><br><span class="line">df[<span class="string">&#x27;MA7&#x27;</span>] = df[<span class="string">&#x27;value&#x27;</span>].rolling(window=<span class="number">7</span>).mean()</span><br></pre></td></tr></table></figure>

<h3 id="9-2-条件格式化"><a href="#9-2-条件格式化" class="headerlink" title="9.2 条件格式化"></a>9.2 条件格式化</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 样式显示</span></span><br><span class="line">df.style.<span class="built_in">format</span>(&#123;<span class="string">&#x27;salary&#x27;</span>: <span class="string">&#x27;$&#123;:,.0f&#125;&#x27;</span>&#125;)  <span class="comment"># 格式化</span></span><br><span class="line">df.style.background_gradient(cmap=<span class="string">&#x27;Blues&#x27;</span>)  <span class="comment"># 热力图</span></span><br><span class="line">df.style.highlight_max(color=<span class="string">&#x27;yellow&#x27;</span>)  <span class="comment"># 高亮最大值</span></span><br></pre></td></tr></table></figure>

<h3 id="9-3-内存优化"><a href="#9-3-内存优化" class="headerlink" title="9.3 内存优化"></a>9.3 内存优化</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看内存使用</span></span><br><span class="line"><span class="built_in">print</span>(df.memory_usage(deep=<span class="literal">True</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 优化数据类型</span></span><br><span class="line">df[<span class="string">&#x27;category&#x27;</span>] = df[<span class="string">&#x27;category&#x27;</span>].astype(<span class="string">&#x27;category&#x27;</span>)</span><br><span class="line">df[<span class="string">&#x27;int_col&#x27;</span>] = pd.to_numeric(df[<span class="string">&#x27;int_col&#x27;</span>], downcast=<span class="string">&#x27;integer&#x27;</span>)</span><br><span class="line">df[<span class="string">&#x27;float_col&#x27;</span>] = pd.to_numeric(df[<span class="string">&#x27;float_col&#x27;</span>], downcast=<span class="string">&#x27;float&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="十、实践建议"><a href="#十、实践建议" class="headerlink" title="十、实践建议"></a>十、实践建议</h2><blockquote>
<p><strong>提醒自己</strong>：</p>
<ol>
<li><strong>先了解数据</strong>：用 head()、info()、describe() 快速了解</li>
<li><strong>处理缺失值</strong>：根据业务选择合适的填充策略</li>
<li><strong>类型优化</strong>：使用 category 等节省内存</li>
<li><strong>链式调用</strong>：提高代码可读性</li>
<li><strong>保存中间结果</strong>：复杂处理时分步保存</li>
<li><strong>向量化优先</strong>：避免使用循环</li>
</ol>
</blockquote>
<h2 id="十一、练习"><a href="#十一、练习" class="headerlink" title="十一、练习"></a>十一、练习</h2><ol>
<li>读取 CSV 文件，统计每列的缺失值比例</li>
<li>对数据进行分组聚合，计算各组的均值、总和、计数</li>
<li>使用 pivot_table 创建销售数据透视表</li>
<li>合并两个 DataFrame，比较不同连接方式的结果</li>
<li>对时间序列数据进行重采样和移动平均计算</li>
</ol>
<hr>
<p><strong>上一篇</strong>：[Python 数据科学（一）：NumPy 数值计算](&#x2F;2026&#x2F;02&#x2F;24&#x2F;Python-数据科学（一）NumPy 数值计算&#x2F;)</p>
<p><strong>下一篇</strong>：[Python 数据科学（三）：PyArrow 高性能数据操作](&#x2F;2026&#x2F;02&#x2F;24&#x2F;Python-数据科学（三）PyArrow 高性能数据操作&#x2F;)</p>
<p><strong>参考资源</strong>：</p>
<ul>
<li><a href="https://pandas.pydata.org/docs/">Pandas 官方文档</a></li>
<li><a href="https://pandas.pydata.org/docs/user_guide/10min.html">Pandas 10 分钟入门</a></li>
<li><a href="https://pandas.pydata.org/docs/user_guide/cookbook.html">Pandas 烹饪书</a></li>
</ul>
]]></content>
      <categories>
        <category>Python 数据科学</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>DataFrame</tag>
        <tag>Pandas</tag>
        <tag>数据分析</tag>
      </tags>
  </entry>
  <entry>
    <title>数据仓库核心概念详解 - 维度建模、数据分层与 SCD 处理</title>
    <url>/2026/02/24/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E8%AF%A6%E8%A7%A3%20-%20%E7%BB%B4%E5%BA%A6%E5%BB%BA%E6%A8%A1%E3%80%81%E6%95%B0%E6%8D%AE%E5%88%86%E5%B1%82%E4%B8%8E%20SCD%20%E5%A4%84%E7%90%86/</url>
    <content><![CDATA[<h1 id="数据仓库核心概念详解-维度建模、数据分层与-SCD-处理"><a href="#数据仓库核心概念详解-维度建模、数据分层与-SCD-处理" class="headerlink" title="数据仓库核心概念详解 - 维度建模、数据分层与 SCD 处理"></a>数据仓库核心概念详解 - 维度建模、数据分层与 SCD 处理</h1><p>数据仓库（Data Warehouse）是企业级数据分析的基础设施。本文将详细介绍数据仓库的核心概念，包括维度建模、数据分层架构和缓慢变化维（SCD）处理。</p>
<h2 id="一、数据仓库概述"><a href="#一、数据仓库概述" class="headerlink" title="一、数据仓库概述"></a>一、数据仓库概述</h2><h3 id="1-1-什么是数据仓库"><a href="#1-1-什么是数据仓库" class="headerlink" title="1.1 什么是数据仓库"></a>1.1 什么是数据仓库</h3><p><strong>数据仓库</strong>是一个面向主题的、集成的、相对稳定的、反映历史变化的数据集合，用于支持管理决策。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">数据仓库特点：</span><br><span class="line">├── 面向主题（Subject-Oriented）</span><br><span class="line">├── 集成性（Integrated）</span><br><span class="line">├── 稳定性（Non-Volatile）</span><br><span class="line">└── 时变性（Time-Variant）</span><br></pre></td></tr></table></figure>

<h3 id="1-2-数据仓库-vs-操作型数据库"><a href="#1-2-数据仓库-vs-操作型数据库" class="headerlink" title="1.2 数据仓库 vs 操作型数据库"></a>1.2 数据仓库 vs 操作型数据库</h3><table>
<thead>
<tr>
<th>特性</th>
<th>操作型数据库 (OLTP)</th>
<th>数据仓库 (OLAP)</th>
</tr>
</thead>
<tbody><tr>
<td>用途</td>
<td>日常业务操作</td>
<td>分析决策</td>
</tr>
<tr>
<td>数据</td>
<td>当前数据</td>
<td>历史数据</td>
</tr>
<tr>
<td>操作</td>
<td>增删改为主</td>
<td>查询为主</td>
</tr>
<tr>
<td>设计</td>
<td>范式化（3NF）</td>
<td>维度建模</td>
</tr>
<tr>
<td>性能</td>
<td>事务响应时间</td>
<td>查询吞吐量</td>
</tr>
</tbody></table>
<h3 id="1-3-数据仓库架构图"><a href="#1-3-数据仓库架构图" class="headerlink" title="1.3 数据仓库架构图"></a>1.3 数据仓库架构图</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                      数据应用层                               │</span><br><span class="line">│   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐       │</span><br><span class="line">│   │ BI 报表  │  │ 即席查询│  │ 数据大屏│  │ 机器学习│       │</span><br><span class="line">│   └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘       │</span><br><span class="line">└────────┼────────────┼────────────┼────────────┼─────────────┘</span><br><span class="line">         │            │            │            │</span><br><span class="line">┌────────▼────────────────────────────────────────────────────┐</span><br><span class="line">│                    ADS 应用数据层                              │</span><br><span class="line">│         面向应用的数据集市，按主题组织数据                       │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">                              │</span><br><span class="line">┌─────────────────────────────▼───────────────────────────────┐</span><br><span class="line">│                    DWS 汇总数据层                              │</span><br><span class="line">│         轻度汇总，构建宽表和聚合指标                           │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">                              │</span><br><span class="line">┌─────────────────────────────▼───────────────────────────────┐</span><br><span class="line">│                    DWD 明细数据层                              │</span><br><span class="line">│         清洗、标准化、维度关联，保持业务过程明细                  │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">                              │</span><br><span class="line">┌─────────────────────────────▼───────────────────────────────┐</span><br><span class="line">│                    ODS 操作数据存储层                           │</span><br><span class="line">│         原始数据，与源系统保持一致                             │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">                              │</span><br><span class="line">         ┌──────────────────┼──────────────────┐</span><br><span class="line">         ▼                  ▼                  ▼</span><br><span class="line">┌─────────────┐   ┌─────────────┐   ┌─────────────┐</span><br><span class="line">│  业务数据库  │   │   日志文件   │   │  外部数据源  │</span><br><span class="line">└─────────────┘   └─────────────┘   └─────────────┘</span><br></pre></td></tr></table></figure>

<h2 id="二、维度建模"><a href="#二、维度建模" class="headerlink" title="二、维度建模"></a>二、维度建模</h2><h3 id="2-1-什么是维度建模"><a href="#2-1-什么是维度建模" class="headerlink" title="2.1 什么是维度建模"></a>2.1 什么是维度建模</h3><p><strong>维度建模</strong>是数据仓库的一种设计方法，由 Ralph Kimball 提出，以事实表为核心，维度表为上下文。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">维度建模核心：</span><br><span class="line">├── 事实表（Fact Table）</span><br><span class="line">└── 维度表（Dimension Table）</span><br></pre></td></tr></table></figure>

<h3 id="2-2-事实表"><a href="#2-2-事实表" class="headerlink" title="2.2 事实表"></a>2.2 事实表</h3><p><strong>事实表</strong>存储业务过程的度量值（数值型），通常是可加的。</p>
<p><strong>事实表结构</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────┐</span><br><span class="line">│              事实表：fact_order                  │</span><br><span class="line">├─────────────────────────────────────────────────┤</span><br><span class="line">│  order_id (FK)     │ 订单 ID（外键）              │</span><br><span class="line">│  user_id (FK)      │ 用户 ID（外键）              │</span><br><span class="line">│  product_id (FK)   │ 商品 ID（外键）              │</span><br><span class="line">│  date_id (FK)      │ 日期 ID（外键）              │</span><br><span class="line">│  ──────────────────┼──────────────────────────  │</span><br><span class="line">│  amount            │ 订单金额（度量值）            │</span><br><span class="line">│  quantity          │ 商品数量（度量值）            │</span><br><span class="line">│  discount          │ 折扣金额（度量值）            │</span><br><span class="line">└─────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p><strong>事实表特点</strong>：</p>
<table>
<thead>
<tr>
<th>特点</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>包含外键</td>
<td>关联维度表</td>
</tr>
<tr>
<td>包含度量值</td>
<td>可加的数值</td>
</tr>
<tr>
<td>数据量大</td>
<td>通常百万到亿级</td>
</tr>
<tr>
<td>行数增长快</td>
<td>随业务增长</td>
</tr>
</tbody></table>
<p><strong>事实表类型</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 事务事实表：记录业务事件（订单、支付）</span><br><span class="line">2. 周期快照事实表：定期状态（每日库存）</span><br><span class="line">3. 累积快照事实表：流程进度（订单→发货→签收）</span><br></pre></td></tr></table></figure>

<h3 id="2-3-维度表"><a href="#2-3-维度表" class="headerlink" title="2.3 维度表"></a>2.3 维度表</h3><p><strong>维度表</strong>存储业务实体的描述性属性，用于查询过滤和分组。</p>
<p><strong>维度表结构</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────┐</span><br><span class="line">│            维度表：dim_user                       │</span><br><span class="line">├─────────────────────────────────────────────────┤</span><br><span class="line">│  user_id (PK)      │ 用户 ID（主键）             │</span><br><span class="line">│  username          │ 用户名                     │</span><br><span class="line">│  gender            │ 性别                       │</span><br><span class="line">│  age_range         │ 年龄段                     │</span><br><span class="line">│  city              │ 城市                       │</span><br><span class="line">│  province          │ 省份                       │</span><br><span class="line">│  register_date     │ 注册日期                   │</span><br><span class="line">│  user_level        │ 用户等级                   │</span><br><span class="line">└─────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p><strong>维度表特点</strong>：</p>
<table>
<thead>
<tr>
<th>特点</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>描述性属性</td>
<td>文本为主</td>
</tr>
<tr>
<td>数据量小</td>
<td>通常万级以内</td>
</tr>
<tr>
<td>行数稳定</td>
<td>变化较慢</td>
</tr>
<tr>
<td>宽表</td>
<td>字段较多</td>
</tr>
</tbody></table>
<h3 id="2-4-星型模型"><a href="#2-4-星型模型" class="headerlink" title="2.4 星型模型"></a>2.4 星型模型</h3><p><strong>星型模型</strong>是最简单的维度模型，事实表在中心，维度表围绕四周。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">                    ┌─────────────┐</span><br><span class="line">                    │ dim_date    │</span><br><span class="line">                    │ (日期维度)   │</span><br><span class="line">                    └──────┬──────┘</span><br><span class="line">                           │</span><br><span class="line">┌─────────────┐            │            ┌─────────────┐</span><br><span class="line">│ dim_product │────────────┼────────────│  dim_user   │</span><br><span class="line">│ (商品维度)   │            │            │ (用户维度)   │</span><br><span class="line">└─────────────┘            │            └─────────────┘</span><br><span class="line">                           │</span><br><span class="line">                    ┌──────▼──────┐</span><br><span class="line">                    │ fact_order  │</span><br><span class="line">                    │ (订单事实表) │</span><br><span class="line">                    └──────┬──────┘</span><br><span class="line">                           │</span><br><span class="line">                    ┌──────▼──────┐</span><br><span class="line">                    │ dim_store   │</span><br><span class="line">                    │ (门店维度)   │</span><br><span class="line">                    └─────────────┘</span><br></pre></td></tr></table></figure>

<p><strong>星型模型特点</strong>：</p>
<table>
<thead>
<tr>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td>结构简单</td>
<td>数据冗余</td>
</tr>
<tr>
<td>查询效率高</td>
<td>维护成本高</td>
</tr>
<tr>
<td>易于理解</td>
<td>维度表较大</td>
</tr>
</tbody></table>
<h3 id="2-5-雪花模型"><a href="#2-5-雪花模型" class="headerlink" title="2.5 雪花模型"></a>2.5 雪花模型</h3><p><strong>雪花模型</strong>是星型模型的扩展，维度表可以进一步规范化。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">                    ┌─────────────┐</span><br><span class="line">                    │ dim_date    │</span><br><span class="line">                    └──────┬──────┘</span><br><span class="line">                           │</span><br><span class="line">┌─────────────┐     ┌──────▼──────┐     ┌─────────────┐</span><br><span class="line">│ dim_product │────►│ fact_order  │◄────│  dim_user   │</span><br><span class="line">└──────┬──────┘     └──────┬──────┘     └──────┬──────┘</span><br><span class="line">       │                   │                   │</span><br><span class="line">       │            ┌──────▼──────┐            │</span><br><span class="line">       │            │ dim_store   │            │</span><br><span class="line">       │            └──────┬──────┘            │</span><br><span class="line">       │                   │                   │</span><br><span class="line">       ▼                   ▼                   ▼</span><br><span class="line">┌─────────────┐     ┌─────────────┐     ┌─────────────┐</span><br><span class="line">│dim_category │     │  dim_city   │     │ dim_province│</span><br><span class="line">└─────────────┘     └─────────────┘     └─────────────┘</span><br></pre></td></tr></table></figure>

<p><strong>雪花模型特点</strong>：</p>
<table>
<thead>
<tr>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td>减少冗余</td>
<td>查询复杂</td>
</tr>
<tr>
<td>易于维护</td>
<td>JOIN 较多</td>
</tr>
<tr>
<td>维度表小</td>
<td>性能较低</td>
</tr>
</tbody></table>
<h3 id="2-6-星型模型-vs-雪花模型"><a href="#2-6-星型模型-vs-雪花模型" class="headerlink" title="2.6 星型模型 vs 雪花模型"></a>2.6 星型模型 vs 雪花模型</h3><table>
<thead>
<tr>
<th>对比项</th>
<th>星型模型</th>
<th>雪花模型</th>
</tr>
</thead>
<tbody><tr>
<td>规范化</td>
<td>维度表不规范化</td>
<td>维度表规范化</td>
</tr>
<tr>
<td>数据冗余</td>
<td>高</td>
<td>低</td>
</tr>
<tr>
<td>查询复杂度</td>
<td>低</td>
<td>高</td>
</tr>
<tr>
<td>查询性能</td>
<td>高</td>
<td>低</td>
</tr>
<tr>
<td>适用场景</td>
<td>数据仓库</td>
<td>数据集市</td>
</tr>
</tbody></table>
<p><strong>推荐</strong>：数据仓库优先使用星型模型，查询性能更重要。</p>
<h2 id="三、数据分层架构"><a href="#三、数据分层架构" class="headerlink" title="三、数据分层架构"></a>三、数据分层架构</h2><h3 id="3-1-为什么需要数据分层"><a href="#3-1-为什么需要数据分层" class="headerlink" title="3.1 为什么需要数据分层"></a>3.1 为什么需要数据分层</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">问题：</span><br><span class="line">├── 避免重复计算</span><br><span class="line">├── 统一数据口径</span><br><span class="line">├── 简化复杂任务</span><br><span class="line">├── 便于问题排查</span><br><span class="line">└── 隔离系统影响</span><br></pre></td></tr></table></figure>

<h3 id="3-2-完整数据分层架构"><a href="#3-2-完整数据分层架构" class="headerlink" title="3.2 完整数据分层架构"></a>3.2 完整数据分层架构</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                     应用层                                   │</span><br><span class="line">│   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐       │</span><br><span class="line">│   │ BI 报表  │  │  画像   │  │  推荐   │  │  风控   │       │</span><br><span class="line">│   └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘       │</span><br><span class="line">└───────┼────────────┼────────────┼────────────┼─────────────┘</span><br><span class="line">        │            │            │            │</span><br><span class="line">┌───────▼────────────▼────────────▼────────────▼─────────────┐</span><br><span class="line">│              ADS 应用数据层 (Application Data Service)        │</span><br><span class="line">│   面向具体应用的数据集市，按主题组织                           │</span><br><span class="line">│   例：用户行为分析表、商品销售汇总表                           │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">                              │</span><br><span class="line">┌─────────────────────────────▼───────────────────────────────┐</span><br><span class="line">│              DWS 汇总数据层 (Data Warehouse Service)          │</span><br><span class="line">│   轻度汇总，构建宽表和聚合指标                                 │</span><br><span class="line">│   例：用户日汇总表、商品日汇总表                               │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">                              │</span><br><span class="line">┌─────────────────────────────▼───────────────────────────────┐</span><br><span class="line">│              DWD 明细数据层 (Data Warehouse Detail)           │</span><br><span class="line">│   清洗、标准化、维度关联，保持业务过程明细                       │</span><br><span class="line">│   例：订单事实表、支付事实表                                   │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">                              │</span><br><span class="line">┌─────────────────────────────▼───────────────────────────────┐</span><br><span class="line">│              ODS 操作数据存储层 (Operational Data Store)      │</span><br><span class="line">│   原始数据，与源系统保持一致，只做简单清洗                     │</span><br><span class="line">│   例：ods_order_raw（订单原始表）                             │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">                              │</span><br><span class="line">         ┌──────────────────┼──────────────────┐</span><br><span class="line">         ▼                  ▼                  ▼</span><br><span class="line">┌─────────────┐   ┌─────────────┐   ┌─────────────┐</span><br><span class="line">│  MySQL 订单  │   │  Nginx 日志  │   │  第三方 API  │</span><br><span class="line">└─────────────┘   └─────────────┘   └─────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="3-3-各层详细说明"><a href="#3-3-各层详细说明" class="headerlink" title="3.3 各层详细说明"></a>3.3 各层详细说明</h3><h4 id="ODS-层（操作数据存储）"><a href="#ODS-层（操作数据存储）" class="headerlink" title="ODS 层（操作数据存储）"></a>ODS 层（操作数据存储）</h4><p><strong>职责</strong>：</p>
<ul>
<li>存储原始数据</li>
<li>与源系统保持一致</li>
<li>简单清洗（去重、空值处理）</li>
</ul>
<p><strong>表命名规范</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ods_&#123;业务域&#125;_&#123;表名&#125;_&#123;更新策略&#125;</span><br><span class="line">例：</span><br><span class="line">- ods_order_info_di（日增量）</span><br><span class="line">- ods_user_info_df（日全量）</span><br><span class="line">- ods_product_info_df（日全量）</span><br></pre></td></tr></table></figure>

<p><strong>示例表结构</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 订单原始表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> ods_order_info_di (</span><br><span class="line">    order_id          <span class="type">BIGINT</span>,</span><br><span class="line">    user_id           <span class="type">BIGINT</span>,</span><br><span class="line">    product_id        <span class="type">BIGINT</span>,</span><br><span class="line">    order_amount      <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">    order_status      <span class="type">INT</span>,</span><br><span class="line">    create_time       DATETIME,</span><br><span class="line">    update_time       DATETIME,</span><br><span class="line">    etl_time          DATETIME,</span><br><span class="line">    dt                STRING  <span class="comment">-- 分区字段</span></span><br><span class="line">) PARTITIONED <span class="keyword">BY</span> (dt STRING);</span><br></pre></td></tr></table></figure>

<h4 id="DWD-层（明细数据层）"><a href="#DWD-层（明细数据层）" class="headerlink" title="DWD 层（明细数据层）"></a>DWD 层（明细数据层）</h4><p><strong>职责</strong>：</p>
<ul>
<li>数据清洗和标准化</li>
<li>维度退化（将维度表字段冗余到事实表）</li>
<li>事实表构建</li>
</ul>
<p><strong>表命名规范</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dwd_&#123;业务域&#125;_&#123;事实/维度&#125;_&#123;表名&#125;</span><br><span class="line">例：</span><br><span class="line">- dwd_trade_order_fact（交易域订单事实表）</span><br><span class="line">- dwd_user_info_dim（用户维度表）</span><br></pre></td></tr></table></figure>

<p><strong>示例表结构</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 订单事实表（维度退化后）</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> dwd_trade_order_fact (</span><br><span class="line">    order_id          <span class="type">BIGINT</span>,</span><br><span class="line">    user_id           <span class="type">BIGINT</span>,</span><br><span class="line">    username          STRING,   <span class="comment">-- 退化维度</span></span><br><span class="line">    user_level        STRING,   <span class="comment">-- 退化维度</span></span><br><span class="line">    product_id        <span class="type">BIGINT</span>,</span><br><span class="line">    product_name      STRING,   <span class="comment">-- 退化维度</span></span><br><span class="line">    category_id       <span class="type">BIGINT</span>,</span><br><span class="line">    city_id           <span class="type">BIGINT</span>,</span><br><span class="line">    province_id       <span class="type">BIGINT</span>,</span><br><span class="line">    order_amount      <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">    pay_amount        <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">    discount_amount   <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">    order_status      <span class="type">INT</span>,</span><br><span class="line">    create_time       DATETIME,</span><br><span class="line">    pay_time          DATETIME,</span><br><span class="line">    dt                STRING</span><br><span class="line">) PARTITIONED <span class="keyword">BY</span> (dt STRING);</span><br></pre></td></tr></table></figure>

<h4 id="DWS-层（汇总数据层）"><a href="#DWS-层（汇总数据层）" class="headerlink" title="DWS 层（汇总数据层）"></a>DWS 层（汇总数据层）</h4><p><strong>职责</strong>：</p>
<ul>
<li>轻度汇总</li>
<li>构建宽表</li>
<li>聚合指标计算</li>
</ul>
<p><strong>表命名规范</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dws_&#123;业务域&#125;_&#123;粒度&#125;_&#123;聚合范围&#125;</span><br><span class="line">例：</span><br><span class="line">- dws_user_order_1d（用户订单日汇总）</span><br><span class="line">- dws_product_sale_1d（商品销售日汇总）</span><br><span class="line">- dws_category_stat_7d（类目统计近 7 天）</span><br></pre></td></tr></table></figure>

<p><strong>示例表结构</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 用户订单日汇总宽表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> dws_user_order_1d (</span><br><span class="line">    user_id           <span class="type">BIGINT</span>,</span><br><span class="line">    username          STRING,</span><br><span class="line">    user_level        STRING,</span><br><span class="line">    city_id           <span class="type">BIGINT</span>,</span><br><span class="line">    order_count       <span class="type">BIGINT</span>,      <span class="comment">-- 下单次数</span></span><br><span class="line">    pay_order_count   <span class="type">BIGINT</span>,      <span class="comment">-- 支付订单数</span></span><br><span class="line">    total_amount      <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>), <span class="comment">-- 总金额</span></span><br><span class="line">    avg_order_value   <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>), <span class="comment">-- 客单价</span></span><br><span class="line">    dt                STRING</span><br><span class="line">) PARTITIONED <span class="keyword">BY</span> (dt STRING);</span><br></pre></td></tr></table></figure>

<h4 id="ADS-层（应用数据层）"><a href="#ADS-层（应用数据层）" class="headerlink" title="ADS 层（应用数据层）"></a>ADS 层（应用数据层）</h4><p><strong>职责</strong>：</p>
<ul>
<li>面向具体应用</li>
<li>结果数据输出</li>
<li>对接 BI 报表</li>
</ul>
<p><strong>表命名规范</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ads_&#123;应用/报表名&#125;_&#123;指标&#125;</span><br><span class="line">例：</span><br><span class="line">- ads_dashboard_gmv_daily（大屏 GMV 日数据）</span><br><span class="line">- ads_user_retention_rate（用户留存率）</span><br></pre></td></tr></table></figure>

<p><strong>示例表结构</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 大屏 GMV 日数据</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> ads_dashboard_gmv_daily (</span><br><span class="line">    stat_date         <span class="type">DATE</span>,</span><br><span class="line">    gmv               <span class="type">DECIMAL</span>(<span class="number">18</span>,<span class="number">2</span>),</span><br><span class="line">    gmv_growth_rate   <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">4</span>),</span><br><span class="line">    order_count       <span class="type">BIGINT</span>,</span><br><span class="line">    user_count        <span class="type">BIGINT</span>,</span><br><span class="line">    avg_order_value   <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">    dt                STRING</span><br><span class="line">) PARTITIONED <span class="keyword">BY</span> (dt STRING);</span><br></pre></td></tr></table></figure>

<h3 id="3-4-数据流向示意图"><a href="#3-4-数据流向示意图" class="headerlink" title="3.4 数据流向示意图"></a>3.4 数据流向示意图</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">数据流转示例：电商订单分析</span><br><span class="line"></span><br><span class="line">┌─────────────┐</span><br><span class="line">│  MySQL 订单库 │</span><br><span class="line">└──────┬──────┘</span><br><span class="line">       │ ETL 同步</span><br><span class="line">       ▼</span><br><span class="line">┌─────────────────────────────────────┐</span><br><span class="line">│ ODS: ods_order_info_di              │</span><br><span class="line">│ - 原始订单数据                        │</span><br><span class="line">│ - 与 MySQL 保持一致                   │</span><br><span class="line">└──────┬──────────────────────────────┘</span><br><span class="line">       │ 清洗 + 维度退化</span><br><span class="line">       │ JOIN dim_user, dim_product</span><br><span class="line">       ▼</span><br><span class="line">┌─────────────────────────────────────┐</span><br><span class="line">│ DWD: dwd_trade_order_fact           │</span><br><span class="line">│ - 清洗后的订单事实表                  │</span><br><span class="line">│ - 用户和商品维度已退化                 │</span><br><span class="line">└──────┬──────────────────────────────┘</span><br><span class="line">       │ 轻度汇总</span><br><span class="line">       │ GROUP BY user_id, date</span><br><span class="line">       ▼</span><br><span class="line">┌─────────────────────────────────────┐</span><br><span class="line">│ DWS: dws_user_order_1d              │</span><br><span class="line">│ - 用户订单日汇总                      │</span><br><span class="line">│ - 每个用户每天的聚合指标               │</span><br><span class="line">└──────┬──────────────────────────────┘</span><br><span class="line">       │ 应用需求</span><br><span class="line">       │ 计算 GMV、转化率等</span><br><span class="line">       ▼</span><br><span class="line">┌─────────────────────────────────────┐</span><br><span class="line">│ ADS: ads_dashboard_gmv_daily        │</span><br><span class="line">│ - 大屏展示数据                        │</span><br><span class="line">│ - 直接对接可视化系统                  │</span><br><span class="line">└─────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h2 id="四、缓慢变化维（SCD）处理"><a href="#四、缓慢变化维（SCD）处理" class="headerlink" title="四、缓慢变化维（SCD）处理"></a>四、缓慢变化维（SCD）处理</h2><h3 id="4-1-什么是缓慢变化维"><a href="#4-1-什么是缓慢变化维" class="headerlink" title="4.1 什么是缓慢变化维"></a>4.1 什么是缓慢变化维</h3><p><strong>缓慢变化维（Slowly Changing Dimension, SCD）</strong>：维度表的属性会随时间缓慢变化，需要记录历史状态。</p>
<p><strong>典型场景</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">用户信息变化：</span><br><span class="line">├── 用户等级：普通会员 → 黄金会员 → 钻石会员</span><br><span class="line">├── 所在城市：北京 → 上海</span><br><span class="line">└── 手机号码：138****1111 → 139****2222</span><br><span class="line"></span><br><span class="line">商品信息变化：</span><br><span class="line">├── 商品分类调整</span><br><span class="line">├── 价格变化</span><br><span class="line">└── 供应商变更</span><br></pre></td></tr></table></figure>

<h3 id="4-2-SCD-类型详解"><a href="#4-2-SCD-类型详解" class="headerlink" title="4.2 SCD 类型详解"></a>4.2 SCD 类型详解</h3><h4 id="类型-1：直接覆盖（SCD1）"><a href="#类型-1：直接覆盖（SCD1）" class="headerlink" title="类型 1：直接覆盖（SCD1）"></a>类型 1：直接覆盖（SCD1）</h4><p><strong>处理方式</strong>：直接更新维度表，不保留历史。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">更新前：</span><br><span class="line">┌─────────┬────────┬──────────┐</span><br><span class="line">│ user_id │ city   │ level    │</span><br><span class="line">├─────────┼────────┼──────────┤</span><br><span class="line">│  1001   │ 北京   │ 黄金会员  │</span><br><span class="line">└─────────┴────────┴──────────┘</span><br><span class="line"></span><br><span class="line">更新后（用户从北京搬到上海，等级升为钻石）：</span><br><span class="line">┌─────────┬────────┬──────────┐</span><br><span class="line">│ user_id │ city   │ level    │</span><br><span class="line">├─────────┼────────┼──────────┤</span><br><span class="line">│  1001   │ 上海   │ 钻石会员  │</span><br><span class="line">└─────────┴────────┴──────────┘</span><br><span class="line"></span><br><span class="line">北京→上海，黄金→钻石：历史被覆盖，无法追溯</span><br></pre></td></tr></table></figure>

<p><strong>SQL 实现</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 直接 UPDATE</span></span><br><span class="line"><span class="keyword">UPDATE</span> dim_user</span><br><span class="line"><span class="keyword">SET</span> city <span class="operator">=</span> <span class="string">&#x27;上海&#x27;</span>,</span><br><span class="line">    user_level <span class="operator">=</span> <span class="string">&#x27;钻石会员&#x27;</span>,</span><br><span class="line">    update_time <span class="operator">=</span> NOW()</span><br><span class="line"><span class="keyword">WHERE</span> user_id <span class="operator">=</span> <span class="number">1001</span>;</span><br></pre></td></tr></table></figure>

<p><strong>适用场景</strong>：</p>
<ul>
<li>不需要历史数据</li>
<li>数据错误修正</li>
<li>不重要的属性变化</li>
</ul>
<h4 id="类型-2：新增行（SCD2）"><a href="#类型-2：新增行（SCD2）" class="headerlink" title="类型 2：新增行（SCD2）"></a>类型 2：新增行（SCD2）</h4><p><strong>处理方式</strong>：每次变化新增一行，用时间戳区分。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">时间线：</span><br><span class="line">2024-01-01: 用户 1001 注册，城市北京，等级普通会员</span><br><span class="line">2024-03-15: 用户升级到黄金会员</span><br><span class="line">2024-08-20: 用户搬到上海</span><br><span class="line">2024-11-11: 用户升级到钻石会员</span><br><span class="line"></span><br><span class="line">维度表数据：</span><br><span class="line">┌─────────┬────────┬──────────┬────────────┬────────────┬──────────┐</span><br><span class="line">│ user_id │ city   │ level    │ start_date │ end_date   │ is_active│</span><br><span class="line">├─────────┼────────┼──────────┼────────────┼────────────┼──────────┤</span><br><span class="line">│  1001   │ 北京   │ 普通会员  │ 2024-01-01 │ 2024-03-14 │    0     │</span><br><span class="line">│  1001   │ 北京   │ 黄金会员  │ 2024-03-15 │ 2024-08-19 │    0     │</span><br><span class="line">│  1001   │ 上海   │ 黄金会员  │ 2024-08-20 │ 2024-11-10 │    0     │</span><br><span class="line">│  1001   │ 上海   │ 钻石会员  │ 2024-11-11 │ 9999-12-31 │    1     │</span><br><span class="line">└─────────┴────────┴──────────┴────────────┴────────────┴──────────┘</span><br><span class="line">                                                         ↑</span><br><span class="line">                                                  当前有效记录</span><br></pre></td></tr></table></figure>

<p><strong>SQL 实现</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 1. 失效旧记录</span></span><br><span class="line"><span class="keyword">UPDATE</span> dim_user</span><br><span class="line"><span class="keyword">SET</span> end_date <span class="operator">=</span> <span class="string">&#x27;2024-11-10&#x27;</span>,</span><br><span class="line">    is_active <span class="operator">=</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">WHERE</span> user_id <span class="operator">=</span> <span class="number">1001</span> <span class="keyword">AND</span> is_active <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 插入新记录</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> dim_user (user_id, city, user_level, start_date, end_date, is_active)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">1001</span>, <span class="string">&#x27;上海&#x27;</span>, <span class="string">&#x27;钻石会员&#x27;</span>, <span class="string">&#x27;2024-11-11&#x27;</span>, <span class="string">&#x27;9999-12-31&#x27;</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p><strong>适用场景</strong>：</p>
<ul>
<li>需要完整历史记录</li>
<li>合规要求</li>
<li>重要维度属性</li>
</ul>
<h4 id="类型-3：新增列（SCD3）"><a href="#类型-3：新增列（SCD3）" class="headerlink" title="类型 3：新增列（SCD3）"></a>类型 3：新增列（SCD3）</h4><p><strong>处理方式</strong>：增加历史列，保留有限历史。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">更新前：</span><br><span class="line">┌─────────┬──────────┬────────────┬──────────┐</span><br><span class="line">│ user_id │ city     │ prev_city  │ level    │</span><br><span class="line">├─────────┼──────────┼────────────┼──────────┤</span><br><span class="line">│  1001   │ 北京     │ NULL       │ 黄金会员  │</span><br><span class="line">└─────────┴──────────┴────────────┴──────────┘</span><br><span class="line"></span><br><span class="line">更新后（用户搬到上海）：</span><br><span class="line">┌─────────┬──────────┬────────────┬──────────┐</span><br><span class="line">│ user_id │ city     │ prev_city  │ level    │</span><br><span class="line">├─────────┼──────────┼────────────┼──────────┤</span><br><span class="line">│  1001   │ 上海     │ 北京       │ 黄金会员  │</span><br><span class="line">└─────────┴──────────┴────────────┴──────────┘</span><br><span class="line"></span><br><span class="line">保留当前值和上一个值，只能追溯一次变化</span><br></pre></td></tr></table></figure>

<p><strong>SQL 实现</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> dim_user</span><br><span class="line"><span class="keyword">SET</span> prev_city <span class="operator">=</span> city,</span><br><span class="line">    city <span class="operator">=</span> <span class="string">&#x27;上海&#x27;</span>,</span><br><span class="line">    update_time <span class="operator">=</span> NOW()</span><br><span class="line"><span class="keyword">WHERE</span> user_id <span class="operator">=</span> <span class="number">1001</span>;</span><br></pre></td></tr></table></figure>

<p><strong>适用场景</strong>：</p>
<ul>
<li>只需要保留上一次的变更</li>
<li>存储空间有限</li>
</ul>
<h3 id="4-3-SCD-类型对比"><a href="#4-3-SCD-类型对比" class="headerlink" title="4.3 SCD 类型对比"></a>4.3 SCD 类型对比</h3><table>
<thead>
<tr>
<th>类型</th>
<th>方式</th>
<th>历史</th>
<th>复杂度</th>
<th>存储</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td>SCD1</td>
<td>覆盖</td>
<td>无</td>
<td>低</td>
<td>最小</td>
<td>不重要属性</td>
</tr>
<tr>
<td>SCD2</td>
<td>新增行</td>
<td>完整</td>
<td>高</td>
<td>最大</td>
<td>重要维度</td>
</tr>
<tr>
<td>SCD3</td>
<td>新增列</td>
<td>部分</td>
<td>中</td>
<td>中等</td>
<td>有限历史</td>
</tr>
</tbody></table>
<h3 id="4-4-SCD-处理流程图"><a href="#4-4-SCD-处理流程图" class="headerlink" title="4.4 SCD 处理流程图"></a>4.4 SCD 处理流程图</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">数据更新流程（SCD2）：</span><br><span class="line"></span><br><span class="line">源系统变更 ──► 检测变化</span><br><span class="line">                    │</span><br><span class="line">                    ▼</span><br><span class="line">            ┌───────────────┐</span><br><span class="line">            │ 是否有变化？   │</span><br><span class="line">            └───────┬───────┘</span><br><span class="line">                    │</span><br><span class="line">           ┌────────┴────────┐</span><br><span class="line">           │                 │</span><br><span class="line">          是                 否</span><br><span class="line">           │                 │</span><br><span class="line">           ▼                 ▼</span><br><span class="line">    ┌─────────────┐    ┌─────────────┐</span><br><span class="line">    │ 失效旧记录   │    │   保持不变   │</span><br><span class="line">    │ end_date    │    │             │</span><br><span class="line">    │ is_active=0 │    │             │</span><br><span class="line">    └──────┬──────┘    └─────────────┘</span><br><span class="line">           │</span><br><span class="line">           ▼</span><br><span class="line">    ┌─────────────┐</span><br><span class="line">    │ 插入新记录   │</span><br><span class="line">    │ start_date  │</span><br><span class="line">    │ end_date=∞  │</span><br><span class="line">    │ is_active=1 │</span><br><span class="line">    └─────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="4-5-实战案例：用户维度-SCD2-处理"><a href="#4-5-实战案例：用户维度-SCD2-处理" class="headerlink" title="4.5 实战案例：用户维度 SCD2 处理"></a>4.5 实战案例：用户维度 SCD2 处理</h3><p><strong>建表语句</strong>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> dim_user_scd2 (</span><br><span class="line">    user_sk         <span class="type">BIGINT</span>,      <span class="comment">-- 代理键（自增）</span></span><br><span class="line">    user_id         <span class="type">BIGINT</span>,      <span class="comment">-- 业务主键</span></span><br><span class="line">    username        STRING,</span><br><span class="line">    city            STRING,</span><br><span class="line">    province        STRING,</span><br><span class="line">    user_level      STRING,</span><br><span class="line">    start_date      <span class="type">DATE</span>,</span><br><span class="line">    end_date        <span class="type">DATE</span>,</span><br><span class="line">    is_active       <span class="type">INT</span>,</span><br><span class="line">    etl_time        <span class="type">TIMESTAMP</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (user_sk)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><strong>ETL 处理逻辑（伪代码）</strong>：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">process_user_scd2</span>(<span class="params">user_data</span>):</span><br><span class="line">    <span class="comment"># 1. 获取当前有效记录</span></span><br><span class="line">    old_record = db.query(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        SELECT * FROM dim_user_scd2</span></span><br><span class="line"><span class="string">        WHERE user_id = ? AND is_active = 1</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>, user_data[<span class="string">&#x27;user_id&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 比较是否有变化</span></span><br><span class="line">    <span class="keyword">if</span> old_record[<span class="string">&#x27;city&#x27;</span>] != user_data[<span class="string">&#x27;city&#x27;</span>] <span class="keyword">or</span> \</span><br><span class="line">       old_record[<span class="string">&#x27;user_level&#x27;</span>] != user_data[<span class="string">&#x27;user_level&#x27;</span>]:</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3. 失效旧记录</span></span><br><span class="line">        db.execute(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            UPDATE dim_user_scd2</span></span><br><span class="line"><span class="string">            SET end_date = ?, is_active = 0</span></span><br><span class="line"><span class="string">            WHERE user_id = ? AND is_active = 1</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>, today, user_data[<span class="string">&#x27;user_id&#x27;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 4. 插入新记录</span></span><br><span class="line">        db.execute(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            INSERT INTO dim_user_scd2</span></span><br><span class="line"><span class="string">            (user_id, username, city, user_level,</span></span><br><span class="line"><span class="string">             start_date, end_date, is_active)</span></span><br><span class="line"><span class="string">            VALUES (?, ?, ?, ?, ?, &#x27;9999-12-31&#x27;, 1)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>, user_data[<span class="string">&#x27;user_id&#x27;</span>], user_data[<span class="string">&#x27;username&#x27;</span>],</span><br><span class="line">                   user_data[<span class="string">&#x27;city&#x27;</span>], user_data[<span class="string">&#x27;user_level&#x27;</span>], today)</span><br></pre></td></tr></table></figure>

<h2 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h2><h3 id="核心知识点速查"><a href="#核心知识点速查" class="headerlink" title="核心知识点速查"></a>核心知识点速查</h3><table>
<thead>
<tr>
<th>概念</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>事实表</td>
<td>存储度量值，可加</td>
</tr>
<tr>
<td>维度表</td>
<td>存储描述属性，用于过滤</td>
</tr>
<tr>
<td>星型模型</td>
<td>事实表居中，维度表不规范化</td>
</tr>
<tr>
<td>雪花模型</td>
<td>维度表进一步规范化</td>
</tr>
<tr>
<td>ODS</td>
<td>原始数据层</td>
</tr>
<tr>
<td>DWD</td>
<td>明细数据层</td>
</tr>
<tr>
<td>DWS</td>
<td>汇总数据层</td>
</tr>
<tr>
<td>ADS</td>
<td>应用数据层</td>
</tr>
<tr>
<td>SCD1</td>
<td>直接覆盖，无历史</td>
</tr>
<tr>
<td>SCD2</td>
<td>新增行，完整历史</td>
</tr>
<tr>
<td>SCD3</td>
<td>新增列，部分历史</td>
</tr>
</tbody></table>
<h3 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h3><ol>
<li><strong>维度建模</strong>：优先使用星型模型，性能优先</li>
<li><strong>数据分层</strong>：至少 ODS→DWD→ADS 三层</li>
<li><strong>SCD 处理</strong>：关键维度使用 SCD2</li>
<li><strong>命名规范</strong>：统一表命名，便于维护</li>
</ol>
<hr>
<p><strong>参考资料</strong>：</p>
<ul>
<li>《数据仓库工具箱：维度建模权威指南》- Ralph Kimball</li>
<li>《大数据之路：阿里巴巴大数据实践》</li>
</ul>
]]></content>
      <categories>
        <category>数据仓库</category>
      </categories>
      <tags>
        <tag>数据仓库</tag>
        <tag>维度建模</tag>
        <tag>数据分层</tag>
        <tag>SCD</tag>
        <tag>大数据</tag>
      </tags>
  </entry>
</search>
